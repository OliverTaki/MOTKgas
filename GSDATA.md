# データ読み込み仕様書 (v2.0)

## 1. 基本概念（データモデル）

- **`DataHub`シート**: プロジェクトの全データを集約した唯一のデータソース。Google Sheetsの1枚のタブ、またはそのCSV書き出しファイルに相当する。
    - **エンティティ列**: `DataHub`シート内の各**列**が、`Shots`, `Assets`, `Fields`といった独立したエンティティとして機能する。各列は、そのエンティティに必要な全ての情報（スキーマ定義、レコードデータ）を自己完結的に保持する。
    - **`Fields`列**: システム全体のスキーマ定義（メタデータリポジトリ）として機能する特別な列。各フィールドの`ID`, `名称`, `データ型`, `Core`フラグなどを定義する。
    - **二重ヘッダー構造**: 各エンティティ列（例: `Shots`列）は、以下のヘッダー情報を持つ。
        - **2行目**: そのエンティティが使用する全`field_id`を `|` (パイプ) で連結した文字列。
        - **3行目**: UI表示用の`field_name`（列の表示名）を `|` で連結した文字列。
    - **レコードデータ**: 4行目以降に、各レコードのデータが `|` で連結された文字列として格納される。

## 2. データ読み込みアルゴリズム: `RenderEntityTable(entity_name)`

エンティティテーブル（例: `Shots`テーブル）をUIに描画するための、`DataHub`シートの構造を最大限に活用した、最も効率的な読み込み手順を以下に定義する。

### フェーズ1: ヘッダーとコアデータの最速ロード（初期描画）

**目的**: `DataHub`シートへの最小限のセルアクセスで、UIの骨格と初期データを即座に表示する。

1.  **対象エンティティ列の特定**: `DataHub`シートの1行目を検索し、引数で指定された`entity_name`（例: `Shots`）を持つ列を特定する。

2.  **ヘッダー情報の取得**: 1で特定した列から、以下の2つのセルのみを読み込む。
    - **2行目**: `field_id`のリストを取得 (`|`で分割)。テーブルの内部的な列定義となる。
    - **3行目**: `field_name`のリストを取得 (`|`で分割)。テーブルの表示ヘッダーとなる。

3.  **UI骨格の生成**: 2で取得したヘッダー情報を基に、テーブルのヘッダーと空の行をUI上に一括で生成する。

4.  **コアデータロード**:
    - `DataHub`シートの**`Fields`列**を参照する。
    - `Fields`列の各セルを解析し、`Core`フラグが `TRUE` になっているフィールドを探す。
    - `Core`フラグが`TRUE`のフィールドが見つかったら、そのセルから`Core_values`（パイプで連結されたデータキャッシュ）を取得する。
    - 取得した`Core_values`を`|`で分割し、対応する列にデータを一括で描画する。
    - `Core`フラグが`FALSE`のフィールドに対応する列のセルは、空欄またはローディングインジケータを表示する。

### フェーズ2: 非コアデータの遅延ロード（ハイドレーション）

**目的**: 初期描画後、必要に応じて残りの詳細データを非同期で読み込み、UIを完全な状態にする。

1.  **実行トリガー**: 本フェーズは、ユーザーイベント（スクロール、クリック等）または初期描画後のタイマーをトリガーとして非同期に実行される。

2.  **レコードデータの取得**:
    - フェーズ1の1で特定したエンティティ列（例: `Shots`列）の**4行目以降**を、必要な範囲だけ読み込む。

3.  **データ注入（ハイドレーション）**: 読み込んだ各レコード文字列に対して以下を実行する。
    - 文字列を`|`で分割し、値の配列を生成する。
    - フェーズ1の2で取得した`field_id`の順序配列と組み合わせ、`{field_id: value}` の対応関係を特定する。
    - レコードのプライマリキーを使い、UI上の対応する行を特定し、`Core`フラグが`FALSE`だったセルのデータを注入・更新する。

---
