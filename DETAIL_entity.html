<!DOCTYPE html>
<html lang="en" class="detail-root">
<!-- ===== 0. <head> ===== -->
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="x-ua-compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shot Detail</title>

  <!-- NOTE: legacy comment removed -->
  <?!= include('COMMON_styles'); ?>

  <!-- Script URL expose -->
  <script>
    (function(){
      try{ window.scriptUrl = "<?= ScriptApp.getService().getUrl() ?>"; }
      catch(e){ window.scriptUrl = location.pathname; }
    })();
  </script>

  <!-- ===== 1. Page Styles ===== -->
  <script>
    (function(){
      function syncNavHeights(){
        if (typeof document === 'undefined') return;
        var docEl = document.documentElement;
        if (!docEl) return;
        var g = document.getElementById('gNav');
        var p = document.getElementById('pNav');
        if (g && g.getBoundingClientRect) {
          var gHeight = Math.round(g.getBoundingClientRect().height) + 'px';
          docEl.style.setProperty('--header-height', gHeight);
          docEl.style.setProperty('--gnav-height', gHeight);
        }
        if (p && p.getBoundingClientRect) {
          var pHeight = Math.round(p.getBoundingClientRect().height) + 'px';
          docEl.style.setProperty('--pnav-height', pHeight);
        }
      }
      function run(){
        syncNavHeights();
        setTimeout(syncNavHeights, 60);
      }
      if (typeof document !== 'undefined') {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', run);
        } else {
          run();
        }
        window.addEventListener('load', run);
        window.addEventListener('resize', syncNavHeights);
      }
    })();
  </script>
</head>

<!-- ===== 2. <body> ===== -->
<body class="detail-page" data-nav-page="<?= page ?>" data-nav-entity="<?= entity ?>" data-record-id="<?= id ?>">
  <!-- ===== 3. GNAVI / PNAVI ===== -->
  <nav id="gNav" class="gnavi" aria-label="Global Navigation">
    <span class="logo">MOTK</span>
    <a class="mi" data-page="Dashboard" href="<?= scriptUrl ?>?page=Dashboard">Dashboard</a>
    <a class="mi" data-page="Settings" href="<?= scriptUrl ?>?page=Settings">Settings</a>
    <span class="spacer"></span>
    <a class="mi debug" data-page="DebugPanelPage" href="<?= scriptUrl ?>?page=DebugPanelPage" target="_blank" rel="noopener" title="Debug Panel">&#x1F41E; Debug</a>
  </nav>
  <nav id="pNav" aria-label="Entity Navigation">
    <a data-page="Shots" href="<?= scriptUrl ?>?page=Shots">Shots</a>
    <a data-page="Assets" href="<?= scriptUrl ?>?page=Assets">Assets</a>
    <a data-page="Tasks" href="<?= scriptUrl ?>?page=Tasks">Tasks</a>
    <a data-page="ProjectMembers" href="<?= scriptUrl ?>?page=ProjectMembers">Members</a>
    <a data-page="Users" href="<?= scriptUrl ?>?page=Users">Users</a>
  </nav>

  <!-- NOTE: legacy comment removed -->
  <?!= include('Scripts'); ?>
  <?!= include('COMMON_renderer'); ?>

  <!-- ===== 5. Toolbar ===== -->
  <div class="toolbar" id="toolbar">
    <div class="left">
      <span id="title" class="title">Shot Detail</span>
      <button id="prev" class="btn">Prev</button>
      <button id="next" class="btn">Next</button>
    </div>

    <div class="toolbar-center"><span class="mode-badge" id="modeBadge">EDIT MODE</span></div>

    <div class="right">
      <button id="cardsBtn" class="btn" style="display:none" title="Manage Cards">Cards</button>
      <div style="position:relative">
        <button id="saveBtnAll" class="btn btn-save" style="display:none" title="Save options">Save Menu</button>
        <div id="saveMenu" class="menu">
          <div class="mi" data-cmd="save">Save</div>
          <div class="mi" data-cmd="saveas">Save As...</div>
          <div class="mi" data-cmd="revert">Revert</div>
        </div>
      </div>
      <button id="toggleLayout" class="mode-toggle" title="Toggle Layout Edit">View mode</button>
      <select id="presetSelect" class="select" title="Preset"></select>
    </div>
  </div>

  <!-- ===== 6. Spacer ===== -->
  <div class="spacer-top"></div>

  <!-- ===== 7. Content ===== -->
  <div class="wrap">
    <div id="error" class="notice" style="display:none"></div>
    <div id="gridWrap"><div id="grid" class="grid"></div></div>
  </div>

  <!-- NOTE: legacy comment removed -->
  <div id="hScroll" aria-hidden="true" style="display:none"><div id="hScrollInner" style="height:1px"></div></div>

  <!-- ===== 8. Footer ===== -->
  <div id="footerBar" class="footer-bar">
    <span id="footerMode">View mode</span>
    <span id="footerPage">Shot Detail</span>
  </div>

  <!-- NOTE: legacy comment removed -->
  <?!= include('Scripts'); ?>

  <!-- ===== 10. Save Modal ===== -->
  <div id="saveModal" class="modal" aria-hidden="true">
    <div class="panel">
      <div class="hd">Save As</div>
      <div class="bd">
        <div class="row">
          <label style="min-width:120px">Preset name</label>
          <input id="saveAsName" class="input grow" placeholder="Preset name" />
        </div>
        <div class="row">
          <label style="min-width:120px">Share</label>
          <input id="saveAsShare" type="checkbox" />
        </div>
      </div>
      <div class="ft">
        <button id="saveCancel" class="btn">Cancel</button>
        <button id="saveApply" class="btn">Apply</button>
      </div>
    </div>
  </div>

  <!-- ===== 11. Cards Modal ===== -->
  <div id="cardsModal" class="modal" aria-hidden="true">
    <div class="panel">
      <div class="hd">Cards</div>
      <div class="bd">
        <div id="cardsList"></div>
        <div class="row"><button id="addCard" class="btn">+ New Card</button></div>
      </div>
      <div class="ft"><button id="cardsClose" class="btn">Close</button></div>
    </div>
  </div>

  <!-- ===== 12. Card Settings Modal ===== -->
  <div id="fieldModal" class="modal" aria-hidden="true">
    <div class="panel">
      <div class="hd">Card Settings</div>
      <div class="bd">
        <div class="row">
          <label style="min-width:80px">Title</label>
          <input id="cardTitle" class="input grow" />
        </div>
        <div id="fieldList"></div>
      </div>
      <div class="ft">
        <button id="fieldCancel" class="btn">Cancel</button>
        <button id="fieldApply" class="btn">Apply</button>
      </div>
    </div>
  </div>

<!-- ===== 13. Page Script ===== -->
<script>
(function(){
"use strict";

/* ===== 13.1 Utils ===== */
var $ = function(sel){ return document.querySelector(sel); };
function gsr(){ return (window.google && google.script && google.script.run) || null; }
function tryCall(names, args){
  return new Promise(function(resolve,reject){
    var r=gsr(); if(!r) return reject(new Error("gsr missing"));
    (function next(i){
      if(i>=names.length) return reject(new Error("no api"));
      var fn=names[i]; if(typeof r[fn]!=="function") return next(i+1);
      r.withSuccessHandler(resolve).withFailureHandler(function(){ next(i+1); })[fn](args);
    })(0);
  });
}
function toPreviewById(id){ return id ? ("https://drive.google.com/file/d/"+id+"/preview") : ""; }
function toPreview(url){
  var s = String(url||"").trim();
  var m = s.match(/^https?:\/\/drive\.google\.com\/file\/d\/([^\/]+)\/(view|preview)/i);
  return m ? ("https://drive.google.com/file/d/"+m[1]+"/preview") : "";
}

/* ===== 13.2 Router ===== */
var Router = (window.__Router__ || {
  baseUrl: function(){ return (window.scriptUrl || window.SCRIPT_URL || (location.origin + location.pathname)); },
  pageUrl: function(p){ var u=new URL(this.baseUrl(), this.baseUrl()); u.searchParams.set("page", p||"DetailShot"); return u.toString(); },
  buildEntityUrl: function(ent,id){
    var u=new URL(this.baseUrl(), this.baseUrl());
    var cur = new URLSearchParams(location.search);
    u.searchParams.set("page", cur.get("page") || "DetailShot");
    u.searchParams.set("entity", ent||"shot");
    u.searchParams.set("id", id||"");
    u.searchParams.set("ts", Date.now().toString(36));
    return u.toString();
  }
});

/* ===== 13.3 State ===== */
var STATE = {
  entity:"shot", id:"", sheet:"Shots",
  ids:[], header:[], rows:[], idxId:0, pos:-1,
  row:{}, labels:{},
  edit:false, layout:[],
  drag:{active:false, mode:"", card:null, start:{x:0,y:0,w:0,h:0}, colW:0, rowStep:0, gridLeft:0, gridTop:0},
  presets:[], currentPreset:""
};
window.DETAIL_STATE_SNAPSHOT = function(){
  return {
    entity: STATE.entity,
    sheet: STATE.sheet,
    id: STATE.id,
    rowCount: STATE.rows.length,
    columnIds: STATE.ids.slice(0, 10),
    rowIndexField: STATE.idxId,
    currentRowId: STATE.row && STATE.row.fi_0001 ? STATE.row.fi_0001 : null
  };
};
/* ===== 13.4 Link maps ===== */
window.LINK_MAPS = window.LINK_MAPS || {assets:{}, shots:{}, tasks:{}, users:{}, members:{}};
window.KNOWN_LINK_FIELD_IDS = window.KNOWN_LINK_FIELD_IDS || {
  fi_0061:'asset', fi_0062:'task', fi_0063:'shot', fi_0064:'task', fi_0065:'asset'
};
function prefetchEntityMap(entity, pickNameFn, bucketKey){
  var r=gsr(); if(!r) return;
  if (prefetchEntityMap['#'+entity]) return; prefetchEntityMap['#'+entity]=1;
  r.withSuccessHandler(function(res){
    try{
      var ids = (res && Array.isArray(res.ids)) ? res.ids : [];
      var header= (res && Array.isArray(res.header)) ? res.header : [];
      var rows = (res && Array.isArray(res.rows)) ? res.rows : [];
      if(!rows.length && Array.isArray(res)) rows = res.slice(2);
      var map={};
      for(var i=0;i<rows.length;i++){
        var row = rows[i]||[];
        var id=String(row[0]||'').trim(); if(!id) continue;
        var name = pickNameFn(ids, header, row) || id;
        map[id]=name;
      }
      LINK_MAPS[bucketKey]=Object.assign(LINK_MAPS[bucketKey]||{}, map);
    }catch(_){}
  }).withFailureHandler(function(){}).listRowsPage({entity:entity,offset:0,limit:5000});
}
function pickAssetName(ids, header, row){ var i = header.findIndex(h=>String(h).toLowerCase().includes('asset name')); if(i<0)i=1; return String(row[i]||'').trim(); }
function pickShotCode(ids, header, row){ var i = header.findIndex(h=>/^(shot ?code|code)$/i.test(String(h))); if(i<0)i=1; return String(row[i]||'').trim(); }
function pickTaskName(ids, header, row){ var i = header.findIndex(h=>/task.*name/i.test(String(h))); if(i<0)i=1; return String(row[i]||'').trim(); }
function pickUserName(ids, header, row){ var i = header.findIndex(h=>/^(name|user name)$/i.test(String(h))); if(i<0)i=1; return String(row[i]||'').trim(); }
function pickMemberName(ids, header, row){ var i = ids.indexOf('fi_0035'); if(i<0) i = header.findIndex(h=>/^role$/i.test(String(h))); if(i<0)i=1; return String(row[i]||'').trim(); }
async function ensureLinkMaps(){
  try{
    var maps = await tryCall(["sv_getLinkMaps","getLinkMaps"], null);
    if(maps && typeof maps==="object"){
      ["assets","shots","tasks","users","members"].forEach(function(k){
        if(!window.LINK_MAPS[k]) window.LINK_MAPS[k]={};
        Object.assign(window.LINK_MAPS[k], maps[k]||{});
      });
    }
  }catch(_){}
}

/* ===== 13.5 Grid helpers ===== */
function gridMetrics(){
  var grid=$("#grid"), rect=grid.getBoundingClientRect();
  var cs = getComputedStyle(grid);
  var cols = parseInt(cs.getPropertyValue("--cols"),10);
  var rowh = parseFloat(cs.getPropertyValue("--rowh"));
  var gap = parseFloat(cs.getPropertyValue("--gap"));
  var minCol = parseFloat(cs.getPropertyValue("--min-col"));
  var colW = Math.max(minCol, (rect.width - (gap * (cols - 1))) / cols);
  var gridLeft = rect.left + window.scrollX;
  var gridTop = rect.top + window.scrollY;
  return {grid, rect, cols, rowh, gap, colW, rowStep:(rowh + gap), gridLeft, gridTop};
}
function applyXYWH(card,x,y,w,h){
  card.dataset.x=x; card.dataset.y=y; card.dataset.w=w; card.dataset.h=h;
  card.style.gridColumn = (x+1) + " / span " + w;
  card.style.gridRow = (y+1) + " / span " + h;
}
function rectOf(card){ return {x:+card.dataset.x, y:+card.dataset.y, w:+card.dataset.w, h:+card.dataset.h}; }
function collides(a,b){ return !(a.x+a.w<=b.x || b.x+b.w<=a.x || a.y+a.h<=b.y || b.y+b.h<=a.y); }
function maxOccupiedY(){
  var max = 0; $("#grid").querySelectorAll(".card").forEach(function(c){
    var y = +c.dataset.y, h = +c.dataset.h; if (y + h > max) max = y + h;
  }); return max;
}
function placeWithoutOverlap(card, x, y, w, h){
  var boxes=[], grid=$("#grid");
  grid.querySelectorAll(".card").forEach(function(el){ if(el!==card) boxes.push(rectOf(el)); });
  var pos={x:x,y:y,w:w,h:h};
  var safe=0, maxY=maxOccupiedY()+200;
  while(safe<400){
    var ok=true;
    for(var i=0;i<boxes.length;i++){ if(collides(pos, boxes[i])){ ok=false; break; } }
    if(ok) return pos;
    pos.y = Math.min(pos.y+1, maxY); safe++;
  }
  return pos;
}

/* ===== 13.6 Toolbar ===== */
function bindToolbar(){
  var tl=$("#toggleLayout"), save=$("#saveBtnAll"), cards=$("#cardsBtn");
  var badge=$("#modeBadge"), footer=$("#footerMode");
  function applyMode(){
    document.body.classList.toggle("layout-edit", !!STATE.edit);
    if (save) save.style.display = STATE.edit ? "" : "none";
    if (cards) cards.style.display = STATE.edit ? "" : "none";
    if (tl){ tl.textContent = STATE.edit ? "Edit mode" : "View mode"; tl.setAttribute("aria-pressed", STATE.edit ? "true" : "false"); }
    if (badge) badge.style.display = STATE.edit ? "inline-flex" : "none";
    if (footer) footer.textContent = STATE.edit ? "Edit mode" : "View mode";
  }
  if (tl){ tl.addEventListener("click", function(e){ e.preventDefault(); e.stopPropagation(); STATE.edit=!STATE.edit; applyMode(); }, {passive:false}); }
  applyMode();
  window.bindToolbar = bindToolbar;
}

/* ===== 13.7 Save UI / Modals ===== */
function bindSaveUI(){
  var saveBtn=$("#saveBtnAll"), menu=$("#saveMenu");
  if(!saveBtn || !menu) return;
  saveBtn.onclick = function(e){ e.stopPropagation(); menu.classList.toggle("open"); };
  document.addEventListener("click", function(){ menu.classList.remove("open"); });
  menu.querySelectorAll(".mi").forEach(function(mi){
    mi.addEventListener("click", async function(){
      var cmd = mi.getAttribute("data-cmd");
      if(cmd==="save"){ await runSaveOverwrite(); }
      if(cmd==="saveas"){ openModal("#saveModal"); }
      if(cmd==="revert"){ await loadLayoutAndApply(STATE.currentPreset || null); }
      menu.classList.remove("open");
    });
  });
  document.addEventListener("keydown", async function(e){
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="s"){ e.preventDefault(); await runSaveOverwrite(); }
  });
}
function runSaveOverwrite(){ var name = STATE.currentPreset || ""; return saveLayout(name || null, true, !!$("#saveAsShare") && !!$("#saveAsShare").checked); }
function openModal(sel){ var m=$(sel); if(!m) return; m.style.display="flex"; document.body.classList.add("modal-open"); }
function closeModal(sel){ var m=$(sel); if(!m) return; m.style.display="none"; document.body.classList.remove("modal-open"); }
function bindSaveModal(){
  var c=$("#saveCancel"), a=$("#saveApply"), d=$("#saveModal");
  if(!d) return;
  if(c) c.onclick=function(){ closeModal("#saveModal"); };
  if(a) a.onclick=async function(){
    var name=($("#saveAsName") && $("#saveAsName").value||"").trim();
    var shared = !!($("#saveAsShare") && $("#saveAsShare").checked);
    if(!name){ showError("Preset name required"); return; }
    await saveLayout(name, false, shared); await loadPresets(); STATE.currentPreset=name;
    var sel=$("#presetSelect"); if(sel) sel.value=name; closeModal("#saveModal");
  };
  d.addEventListener("click", function(e){ if(e.target===this) closeModal("#saveModal"); });
}

/* ===== 13.8 Cards / Layouts ===== */
function duplicateCard(key){
  var i = STATE.layout.findIndex(function(x){return x.key===key;});
  if(i<0) return;
  var src = STATE.layout[i];
  var dup = JSON.parse(JSON.stringify(src));
  dup.key = src.key + "_" + Math.random().toString(36).slice(2,5);
  dup.title = (src.title||"") + " Copy";
  dup.y = maxOccupiedY() + 1;
  STATE.layout.splice(i+1, 0, dup);
  var el = createCard(dup);
  $("#grid").appendChild(el);
}
function bindCardsModal(){
  var btn=$("#cardsBtn"), modal=$("#cardsModal");
  if(!btn || !modal) return;
  var panel=modal.querySelector(".panel");
  btn.onclick = function(){
    renderCardsList(); openModal("#cardsModal");
    if(panel){
      panel.style.position="fixed";
      var r = btn.getBoundingClientRect();
      panel.style.visibility="hidden"; panel.style.left="0px"; panel.style.top="0px";
      requestAnimationFrame(function(){
        var pw = panel.offsetWidth, ph = panel.offsetHeight;
        var left = Math.min(Math.max(r.right - pw, 12), window.innerWidth - pw - 12);
        var top = Math.min(r.bottom + 8, window.innerHeight - ph - 12);
        panel.style.left = left + "px"; panel.style.top = top + "px"; panel.style.margin = "0"; panel.style.visibility="visible";
      });
    }
  };
  var close=$("#cardsClose"); if(close) close.onclick=function(){ closeModal("#cardsModal"); };
  modal.addEventListener("click", function(e){ if(e.target===this) closeModal("#cardsModal"); });
  var add=$("#addCard"); if(add) add.onclick=function(){
    var key = "card_" + Math.random().toString(36).slice(2,8);
    var def = {key:key,title:"New Card",type:"table",x:0,y:maxOccupiedY()+1,w:4,h:12,fields:[], thwpx:220, __autofit__:false};
    STATE.layout.push(def);
    var el = createCard(def); $("#grid").appendChild(el);
    renderCardsList(); openCardSettings(def.key);
  };
}
function renderCardsList(){
  var box=$("#cardsList"); if(!box) return;
  box.innerHTML="";
  STATE.layout.forEach(function(def){
    var row=document.createElement("div"); row.className="list-row";
    var name=document.createElement("div"); name.textContent=def.title || def.key;
    var jump=document.createElement("span"); jump.className="xbtn"; jump.textContent="Move"; jump.title="Focus";
    jump.onclick=function(){ var el=$("#grid .card[data-key='"+def.key+"']"); if(!el) return; el.scrollIntoView({behavior:"smooth", block:"center"}); el.classList.add("dragging"); setTimeout(function(){ el.classList.remove("dragging"); }, 600); };
    var edit=document.createElement("span"); edit.className="xbtn"; edit.textContent="Edit"; edit.title="Edit"; edit.onclick=function(){ openCardSettings(def.key); };
    var del=document.createElement("span"); del.className="xbtn"; del.textContent="Delete"; del.title="Delete"; del.onclick=function(){ var i = STATE.layout.findIndex(function(x){return x.key===def.key;}); if(i>=0) STATE.layout.splice(i,1); var el=$("#grid .card[data-key='"+def.key+"']"); if(el) el.remove(); renderCardsList(); };
    row.appendChild(name); row.appendChild(jump); row.appendChild(edit); row.appendChild(del); box.appendChild(row);
  });
}
async function loadPresets(){
  var sel=$("#presetSelect"); if(!sel) return;
  sel.innerHTML="";
  var o0=document.createElement("option"); o0.value=""; o0.textContent="(Default)"; sel.appendChild(o0);
  try{
    var list = await tryCall( ["sv_listPageLayoutPresets","listPageLayoutPresets","sv_listLayoutPresets","listLayoutPresets"], {page:"DetailShot"} );
    if(Array.isArray(list)) STATE.presets=list;
  }catch(_){
    var keys=Object.keys(localStorage).filter(function(k){return /^DetailShot:preset:/.test(k);});
    STATE.presets = keys.map(function(k){return k.replace(/^DetailShot:preset:/,"");});
  }
  STATE.presets.forEach(function(name){ var o=document.createElement("option"); o.value=name; o.textContent=name; sel.appendChild(o); });
  sel.onchange = async function(){ STATE.currentPreset = this.value || ""; await loadLayoutAndApply(STATE.currentPreset || null); };
}
async function loadLayoutAndApply(presetName){
  var key = presetName ? ("preset:"+presetName) : "global";
  var layout=null;
  try{
    var cloud = await tryCall( ["sv_loadPageLayout","loadPageLayout","sv_loadLayout","loadLayout"], {page:"DetailShot", key:key} );
    if(Array.isArray(cloud)) layout=cloud;
  }catch(_){}
  if(!layout){
    try{ var raw=localStorage.getItem("DetailShot:"+key); if(raw) layout=JSON.parse(raw); }catch(_){}
  }
  if(layout && layout.length){ STATE.layout = layout; buildFromLayout(); }
  else { setDefaultLayout(); buildFromLayout(); }
}
async function saveLayout(presetName, overwrite, shared){
  var key = presetName ? ("preset:"+presetName) : "global";
  STATE.layout = exportLayoutFromDOM();
  var saved=false;
  try{
    await tryCall( ["sv_savePageLayout","savePageLayout","sv_saveLayout","saveLayout"], {page:"DetailShot", key:key, layout:STATE.layout, overwrite:!!overwrite, shared: !!shared} );
    saved=true;
  }catch(_){}
  try{ localStorage.setItem("DetailShot:"+key, JSON.stringify(STATE.layout)); }catch(_){}
  return saved;
}
function exportLayoutFromDOM(){
  var arr=[];
  $("#grid").querySelectorAll(".card").forEach(function(c){
    var key=c.dataset.key||"";
    var w=+c.dataset.w, h=+c.dataset.h, x=+c.dataset.x, y=+c.dataset.y;
    var title=(c.querySelector(".card-title")||{}).textContent||key;
    var type = c.dataset.type || (c.querySelector(".media") ? "shotview" : "table");
    var thwpx = parseInt((c.style.getPropertyValue("--thwpx")||"220px"));
    var fields=[];
    if(type==="table"){
      var table=c.querySelector(".table");
      if(table){
        table.querySelectorAll("th").forEach(function(th){
          var label=th.textContent;
          var fid = Object.keys(STATE.labels).find(function(k){ return STATE.labels[k]===label; }) || label;
          fields.push(fid);
        });
      }
    }
    arr.push({key:key,title:title,type:type,x:x,y:y,w:w,h:h,fields:fields, thwpx:thwpx});
  });
  return arr;
}

/* ===== 13.9 Layout builders ===== */
function setDefaultLayout(){
  var entity = String(STATE.entity || "shot").toLowerCase();
  if (entity === "shot") {
    STATE.layout = [
      {key:"shotview", title:"Shotview", type:"shotview", x:0, y:0, w:8, h:20, fields:[], thwpx:220},
      {key:"basic", title:"Basic", type:"table", x:0, y:21, w:4, h:12, fields:["fi_0002","fi_0003","fi_0008","fi_0066"], thwpx:220},
      {key:"timing", title:"Timing", type:"table", x:4, y:21, w:4, h:8, fields:["fi_0009"], thwpx:220},
      {key:"links", title:"Links", type:"table", x:8, y:0, w:4, h:20, fields:["fi_0010","fi_0011","fi_0012","fi_0013","fi_0061","fi_0062","fi_0063","fi_0064","fi_0065"], thwpx:220},
      {key:"notes", title:"Notes", type:"table", x:4, y:30, w:8, h:10, fields:["fi_0014","fi_0061","fi_0062"], thwpx:220}
    ];
    return;
  }

  var allFields = Array.isArray(STATE.ids) && STATE.ids.length ? STATE.ids.slice() : Object.keys(STATE.row || {});
  allFields = allFields.filter(function(fid){ return fid !== "" && fid != null; });
  if (!allFields.length && STATE.row) {
    allFields = Object.keys(STATE.row);
  }
  var cardHeight = Math.max(12, Math.ceil(allFields.length * 0.6));
  var title = entity.charAt(0).toUpperCase() + entity.slice(1) + " Details";
  STATE.layout = [
    {key: entity + "_details", title: title, type: "table", x:0, y:0, w:12, h:cardHeight, fields: allFields.slice(0, 80), thwpx:220}
  ];
}
function buildFromLayout(){
  var grid=$("#grid"); grid.innerHTML="";
  STATE.layout.forEach(function(c){ grid.appendChild(createCard(c)); });
  requestAnimationFrame(function(){
    if(window.FieldsAPI&&typeof FieldsAPI.hydrateLinks==="function"){
      FieldsAPI.hydrateLinks(grid,{entity:STATE.entity,row:STATE.row,labels:STATE.labels});
    }
  });
}

/* ===== 13.10 Card factory ===== */
(function(){
  // Default field types (server overrides allowed)
  window.FIELD_TYPES = Object.assign({
    fi_0001:"id",            // Shot ID (link disabled)
    fi_0010:"originals",     // Originals field (new tabs only)
    fi_0061:"entity_link",   // asset
    fi_0062:"entity_link",   // task
    fi_0063:"entity_link",   // shot
    fi_0064:"entity_link",   // task
    fi_0065:"entity_link"    // asset
  }, window.FIELD_TYPES||{});

  function createCard(def){
    var card=document.createElement("section");
    card.className="card";
    card.dataset.key=def.key;
    card.dataset.type = def.type || "table";
    applyXYWH(card, def.x, def.y, def.w, def.h);
    card.style.setProperty("--thwpx", (def.thwpx||220) + "px");

    var hd=document.createElement("div"); hd.className="card-header";
    var ttl=document.createElement("div"); ttl.className="card-title"; ttl.textContent=def.title||def.key;
    var act=document.createElement("div"); act.className="card-actions";
    var btnEdit=document.createElement("button"); btnEdit.className="btn"; btnEdit.textContent="Edit"; btnEdit.onclick=function(){ openCardSettings(def.key); };
    var btnDup=document.createElement("button"); btnDup.className="btn"; btnDup.textContent="Duplicate"; btnDup.onclick=function(){ duplicateCard(def.key); };
    var btnFit=document.createElement("button"); btnFit.className="btn"; btnFit.textContent="Fit"; btnFit.title="Auto-fit height"; btnFit.onclick=function(){ autoFitHeight(card, true); };
    act.appendChild(btnEdit); act.appendChild(btnDup); act.appendChild(btnFit);
    hd.appendChild(ttl); hd.appendChild(act); card.appendChild(hd);

    var body=document.createElement("div"); body.className="cbody";
    if(def.type==="shotview"){
      var media=document.createElement("div"); media.className="media aspect";
      var inner=document.createElement("div"); inner.className="inner";
      var holder=document.createElement("div"); holder.className="media";
      inner.appendChild(holder); media.appendChild(inner); body.appendChild(media);
      fillShotviewTableLike(holder);
    }else{
      var table=document.createElement("table"); table.className="table";
      (def.fields||[]).forEach(function(fid){
        var tr=document.createElement("tr");
        var th=document.createElement("th"); th.textContent=STATE.labels[fid] || (FieldsAPI.getLabel && FieldsAPI.getLabel(fid, STATE.entity)) || fid;
        var td=document.createElement("td"); td.className="v"; td.setAttribute("data-fid", fid);
        var ftype = ((window.FIELD_TYPES && window.FIELD_TYPES[fid]) || "").toLowerCase();
        td.setAttribute("data-type", ftype);
        var node = FieldsAPI.renderCellByField({ fid: fid, val: STATE.row[fid], row: STATE.row, labels: STATE.labels, type: ftype, entity: STATE.entity });
        td.appendChild(node);
        tr.appendChild(th); tr.appendChild(td); table.appendChild(tr);
      });
      body.appendChild(table);
      var split=document.createElement("div"); split.className="colsplit"; body.appendChild(split);
    }
    card.appendChild(body);

    var rs=document.createElement("div"); rs.className="resize"; card.appendChild(rs);
    enableDrag(card, hd); enableResize(card, rs);
    return card;
  }
  window.createCard = createCard;
})();

/* ===== 13.11 Drag / Resize / Fit ===== */
function enableDrag(card, header){
  header.addEventListener("mousedown", function(e){
    if(!STATE.edit) return; e.preventDefault();
    var m = gridMetrics();
    STATE.drag.active=true; STATE.drag.mode="move"; STATE.drag.card=card;
    STATE.drag.start={x:+card.dataset.x, y:+card.dataset.y, w:+card.dataset.w, h:+card.dataset.h};
    STATE.drag.colW = m.colW; STATE.drag.rowStep = m.rowStep; STATE.drag.gridLeft = m.gridLeft; STATE.drag.gridTop = m.gridTop;
    var rect = card.getBoundingClientRect();
    var offX = e.pageX - (rect.left + window.scrollX);
    var offY = e.pageY - (rect.top + window.scrollY);
    function onMove(ev){
      if(!STATE.drag.active || STATE.drag.mode!=="move") return;
      var gx = Math.max(0, (ev.pageX - STATE.drag.gridLeft) - offX);
      var gy = Math.max(0, (ev.pageY - STATE.drag.gridTop) - offY);
      var x = Math.floor( gx / (STATE.drag.colW + m.gap) );
      var y = Math.floor( gy / (STATE.drag.rowStep) );
      x = Math.max(0, Math.min(m.cols - STATE.drag.start.w, x));
      var maxY = maxOccupiedY() + 200;
      y = Math.max(0, Math.min(maxY, y));
      applyXYWH(card, x, y, STATE.drag.start.w, STATE.drag.start.h);
    }
    function onUp(){
      if(!STATE.drag.active || STATE.drag.mode!=="move") return cleanup();
      var pos = placeWithoutOverlap(card, +card.dataset.x, +card.dataset.y, +card.dataset.w, +card.dataset.h);
      applyXYWH(card, pos.x, pos.y, pos.w, pos.h); cleanup();
    }
    function cleanup(){ STATE.drag.active=false; STATE.drag.mode=""; STATE.drag.card=null; document.removeEventListener("mousemove", onMove); document.removeEventListener("mouseup", onUp); }
    document.addEventListener("mousemove", onMove); document.addEventListener("mouseup", onUp);
  });
}
function enableResize(card, handle){
  handle.addEventListener("mousedown", function(e){
    if(!STATE.edit) return; e.preventDefault();
    var m = gridMetrics();
    STATE.drag.active=true; STATE.drag.mode="resize"; STATE.drag.card=card;
    STATE.drag.start={x:+card.dataset.x, y:+card.dataset.y, w:+card.dataset.w, h:+card.dataset.h};
    STATE.drag.colW = m.colW; STATE.drag.rowStep = m.rowStep; STATE.drag.gridLeft = m.gridLeft; STATE.drag.gridTop = m.gridTop;
    function onMove(ev){
      if(!STATE.drag.active || STATE.drag.mode!=="resize") return;
      var gx = Math.max(ev.pageX - STATE.drag.gridLeft, 0);
      var gy = Math.max(ev.pageY - STATE.drag.gridTop, 0);
      var endCol = Math.floor( gx / (STATE.drag.colW + m.gap) );
      var endRow = Math.floor( gy / (STATE.drag.rowStep) );
      var w = Math.max(1, endCol - STATE.drag.start.x + 1);
      var h = Math.max(10, endRow - STATE.drag.start.y + 1);
      w = Math.min(w, m.cols - STATE.drag.start.x);
      applyXYWH(card, STATE.drag.start.x, STATE.drag.start.y, w, h);
    }
    function onUp(){
      if(!STATE.drag.active || STATE.drag.mode!=="resize") return cleanup();
      var pos = placeWithoutOverlap(card, +card.dataset.x, +card.dataset.y, +card.dataset.w, +card.dataset.h);
      applyXYWH(card, pos.x, pos.y, pos.w, pos.h); cleanup();
    }
    function cleanup(){ STATE.drag.active=false; STATE.drag.mode=""; STATE.drag.card=null; document.removeEventListener("mousemove", onMove); document.removeEventListener("mouseup", onUp); }
    document.addEventListener("mousemove", onMove); document.addEventListener("mouseup", onUp);
  });
}
function autoFitHeight(card, strict){
  var body = card.querySelector(".cbody"); var header = card.querySelector(".card-header"); if(!body || !header) return;
  var m = gridMetrics(); var content = body.firstElementChild;
  var needPx = header.offsetHeight + (content ? content.scrollHeight : body.scrollHeight) + 12;
  var rows = Math.ceil(needPx / (m.rowStep));
  rows = Math.max(10, Math.min(rows, 240));
  if(!strict){ rows = rows + 2; }
  applyXYWH(card, +card.dataset.x, +card.dataset.y, +card.dataset.w, rows);
}

/* NOTE: legacy comment removed */
const SHOT_IFR_CACHE = new Map();
function mountIframe(container, src){
  container.innerHTML="";
  var iframe=document.createElement("iframe");
  iframe.src=src;
  iframe.loading="eager";
  iframe.allow="autoplay; fullscreen";
  var finished=false;
  function fallback(){
    if(finished) return;
    finished=true;
    container.innerHTML="";
    var link=document.createElement("a");
    link.className="chip";
    link.textContent="Open Preview";
    link.href=src;
    link.target="_blank";
    link.rel="noopener";
    container.appendChild(link);
  }
  var timer=setTimeout(fallback, 1200);
  iframe.onload=function(){ if(finished) return; clearTimeout(timer); };
  iframe.onerror=fallback;
  container.appendChild(iframe);
}
function addShotVersion(container){
  var vtag = (STATE.row["fi_0013"]||"")+""; if(vtag){
    var note=document.createElement("div"); note.className="media-note"; note.textContent="version: "+vtag; container.appendChild(note);
  }
}
function fillShotviewTableLike(container){
  container.innerHTML="";
  var id = String(STATE.row["fi_0001"]||"");
  var thumb = String(STATE.row["fi_0011"]||"");
  var orig = String(STATE.row["fi_0010"]||"");
  var pv = toPreview(thumb) || toPreview(orig);
  if(pv){ SHOT_IFR_CACHE.set(id, pv); mountIframe(container, pv); addShotVersion(container); upgradeFromApis(container,id,orig); return; }
  upgradeFromApis(container,id,orig);
}
async function upgradeFromApis(container, shotId, originalsPath){
  var apiTry = [
    ["sv_getPreviewUrl", {id:shotId}],
    ["getPreviewUrl", {id:shotId}],
    ["sv_getShotviewUrls", {id:shotId}],
    ["sv_getShotProxies", {id:shotId}],
    ["sv_listEntityProxies", {id:shotId}],
  ];
  for (var i=0;i<apiTry.length;i++){
    try{
      var name = apiTry[i][0], arg = apiTry[i][1];
      var res = await tryCall([name], arg);
      var pv = "";
      if(typeof res === "string"){ pv = toPreview(res); }
      else if(Array.isArray(res) && res.length){
        var best = res[0];
        if(best && (best.id||best.fileId)) pv = toPreviewById(best.id||best.fileId);
        if(!pv && best.url) pv = toPreview(best.url);
      }
      if(pv){ SHOT_IFR_CACHE.set(shotId, pv); mountIframe(container, pv); addShotVersion(container); return; }
    }catch(_){}
  }
  try{
    var loose = await tryCall(["findProxyFilesLoose"], shotId);
    if(Array.isArray(loose) && loose.length){
      var b = loose[0];
      var pv2 = toPreviewById(b.id||b.fileId) || toPreview(b.url||"");
      if(pv2){ SHOT_IFR_CACHE.set(shotId, pv2); mountIframe(container, pv2); addShotVersion(container); return; }
    }
  }catch(_){}
  if(originalsPath){
    try{
      var byPath = await tryCall(["findProxyFromPaths","findProxyFilesFromPath","findDrivePreviewFromPath"], {path: originalsPath, id:shotId});
      if(Array.isArray(byPath) && byPath.length){
        var b2 = byPath[0];
        var pv3 = toPreviewById(b2.id||b2.fileId) || toPreview(b2.url||"");
        if(pv3){ SHOT_IFR_CACHE.set(shotId, pv3); mountIframe(container, pv3); addShotVersion(container); return; }
      }else if(typeof byPath==="string"){
        var pv4 = toPreview(byPath);
        if(pv4){ SHOT_IFR_CACHE.set(shotId, pv4); mountIframe(container, pv4); addShotVersion(container); return; }
      }
    }catch(_){}
  }
  var div=document.createElement("div"); div.className="media-note"; div.textContent="Media preview is unavailable";
  container.innerHTML=""; container.appendChild(div);
}

/* ===== 13.13 Field Modal ===== */
function bindFieldModal(){
  var c=$("#fieldCancel"), a=$("#fieldApply"), d=$("#fieldModal");
  if(!d) return;
  if(c) c.onclick=function(){ closeModal("#fieldModal"); };
  if(a) a.onclick=function(){
    var key = $("#fieldModal").getAttribute("data-key") || "";
    var title = ($("#cardTitle") && $("#cardTitle").value||"").trim() || key;
    var def = STATE.layout.find(function(x){return x.key===key;}); if(def){ def.title = title; }
    var card = $("#grid .card[data-key='"+key+"']"); if(card){ (card.querySelector(".card-title")||{}).textContent = title; }
    if(def && def.type!=="shotview"){
      var selected=[]; document.querySelectorAll("#fieldList input[type=checkbox]:checked").forEach(function(cb){ selected.push(cb.value); });
      def.fields = selected;
      if(card){
        var body=card.querySelector(".cbody");
        var table = card.querySelector(".table"); if(!table){ table=document.createElement("table"); table.className="table"; body.prepend(table); }
        table.innerHTML="";
        selected.forEach(function(fid){
          var tr=document.createElement("tr");
          var label = (STATE.labels[fid]) || (FieldsAPI.getLabel && FieldsAPI.getLabel(fid, STATE.entity)) || fid;
          var th=document.createElement("th"); th.textContent=label;
          var td=document.createElement("td"); td.className="v"; td.setAttribute("data-fid", fid);
          var node = (FieldsAPI && FieldsAPI.renderCellByField ? FieldsAPI.renderCellByField({fid:fid, val:STATE.row[fid], row:STATE.row, labels:STATE.labels, entity:STATE.entity, type:(window.FIELD_TYPES[fid]||"")}) : document.createTextNode(STATE.row[fid]==null?"":String(STATE.row[fid])));
          td.appendChild(node);
          tr.appendChild(th); tr.appendChild(td); table.appendChild(tr);
        });
        requestAnimationFrame(function(){ autoFitHeight(card, true); });
      }
    }
    closeModal("#fieldModal");
  };
  d.addEventListener("click", function(e){ if(e.target===this) closeModal("#fieldModal"); });
}
function openCardSettings(cardKey){
  if(!STATE.edit) return;
  var def = STATE.layout.find(function(x){return x.key===cardKey;}); if(!def) return;
  $("#fieldModal").setAttribute("data-key", cardKey);
  var titleEl=$("#cardTitle"); if(titleEl) titleEl.value = def.title || def.key;
  var list=$("#fieldList"); if(list){ list.innerHTML="";
    if(def.type==="shotview"){
      var p=document.createElement("div"); p.className="notice"; p.textContent="Shotview cards cannot be edited here"; list.appendChild(p);
    }else{
      var sel = new Set((def.fields||[]));
      Object.keys(STATE.labels).forEach(function(fid){
        if(!/^fi_\d{4}$/.test(fid)) return;
        var row=document.createElement("div"); row.className="field-row";
        var cb=document.createElement("input"); cb.type="checkbox"; cb.value=fid; cb.checked = sel.has(fid);
        var lab=document.createElement("label"); lab.textContent = (STATE.labels[fid]) || (FieldsAPI.getLabel && FieldsAPI.getLabel(fid, STATE.entity)) || fid;
        row.appendChild(cb); row.appendChild(lab); list.appendChild(row);
      });
    }
  }
  openModal("#fieldModal");
}

/* ===== 13.14 Prev/Next ===== */
function navigate(entity,id){
  var href = Router.buildEntityUrl(entity||"shot", id||"");
  try{ location.assign(href); }catch(_){ location.href = href; }
}
function setupPrevNext(){
  var prevBtn=$("#prev"), nextBtn=$("#next");
  var prev = (STATE.pos>0)?STATE.pos-1:-1, next=(STATE.pos<STATE.rows.length-1)?STATE.pos+1:-1;
  if(prevBtn) prevBtn.disabled=prev<0;
  if(nextBtn) nextBtn.disabled=next<0;
  if(prevBtn) prevBtn.onclick=function(){ if(prev<0)return; if(!location.search){applyIndex(prev,false);} else { navigate(STATE.entity, STATE.rows[prev][STATE.idxId]); } };
  if(nextBtn) nextBtn.onclick=function(){ if(next<0)return; if(!location.search){applyIndex(next,false);} else { navigate(STATE.entity, STATE.rows[next][STATE.idxId]); } };
}

/* ===== 13.15 Apply index ===== */
function applyIndex(index, pushUrl){
  STATE.pos=index;
  var row=STATE.rows[index], map={}, labels={};
  for(var i=0;i<STATE.ids.length;i++) map[STATE.ids[i]]=row[i];
  for(var j=0;j<STATE.ids.length;j++) labels[STATE.ids[j]]=String(STATE.header[j]||STATE.ids[j]);
  STATE.row=map; STATE.labels=labels;
  var t=$("#title"); if(t) t.textContent = STATE.row["fi_0002"] || "Shot Detail";
  var f=$("#footerPage"); if(f) f.textContent = "Shot Detail";
  setupPrevNext();
  if(!STATE.layout || !STATE.layout.length) setDefaultLayout();
  buildFromLayout();
  if(pushUrl){
    var qs=new URLSearchParams(location.search);
    qs.set("entity",STATE.entity||"shot"); qs.set("id",STATE.row["fi_0001"]||"");
    history.replaceState(null,"",location.pathname+"?"+qs.toString());
  }
}

/* ===== 13.16 Linkify (strict) ===== */
function linkifyLinksStrict(scope){
  var root = scope || document;
  var rows = root.querySelectorAll('.table tr, .field-row, .kv-row, .fields-grid');
  rows.forEach(function(row){
    var k = row.querySelector('.k') || row.querySelector('th');
    var v = row.querySelector('.v') || row.querySelector('td');
    if(!k||!v) return;

    // Skip nodes generated by FieldsAPI
    var ftype = (v.getAttribute('data-type')||"").toLowerCase();
    if (ftype === "id" || ftype === "entity_link" || ftype === "originals") return;
    if (v.querySelector('a')) return;

    var raw = (v.textContent||"").trim();
    if(/^https?:\/\//i.test(raw)){
      var a=document.createElement('a'); a.href=raw; a.target='_blank'; a.rel='noopener'; a.textContent=raw; a.className='chip';
      v.textContent=""; v.appendChild(a);
    }
  });
}
function observeAndLinkify(){
  var grid=document.getElementById('grid'); if(!grid) return;
  var raf=null, obs=new MutationObserver(function(){
    if(raf) cancelAnimationFrame(raf);
    raf=requestAnimationFrame(function(){ linkifyLinksStrict(grid); });
  });
  obs.observe(grid, {childList:true, subtree:true});
  setTimeout(function(){ linkifyLinksStrict(grid); }, 0);
  setTimeout(function(){ linkifyLinksStrict(grid); }, 250);
}

/* ===== 13.17 Init / Error ===== */
async function init(){
  await Promise.all([
    new Promise(r => prefetchEntityMap("Assets", pickAssetName, "assets")||r()),
    new Promise(r => prefetchEntityMap("Shots", pickShotCode, "shots")||r()),
    new Promise(r => prefetchEntityMap("Tasks", pickTaskName, "tasks")||r()),
    new Promise(r => prefetchEntityMap("Users", pickUserName, "users")||r()),
    new Promise(r => prefetchEntityMap("ProjectMembers", pickMemberName, "members")||r()),
    ensureLinkMaps()
  ]);  var query = new URLSearchParams(location.search || "");
  var body = document.body || {};
  var dataAttr = body.dataset || {};
  var entityKey = (query.get("entity") || dataAttr.navEntity || "shot").toLowerCase();
  STATE.entity = entityKey;
  var recordId = query.get("id") || dataAttr.recordId || "";
  STATE.id = recordId;
  var sheetByEntity = {
    shot: "Shots",
    shots: "Shots",
    asset: "Assets",
    assets: "Assets",
    task: "Tasks",
    tasks: "Tasks",
    user: "Users",
    users: "Users",
    member: "ProjectMembers",
    members: "ProjectMembers",
    projectmember: "ProjectMembers",
    projectmembers: "ProjectMembers"
  };
  STATE.sheet = sheetByEntity[entityKey] || "Shots";

  var resp = await tryCall(["listRowsPage"], {entity:STATE.sheet,offset:0,limit:5000});
  var ids = Array.isArray(resp&&resp.ids) ? resp.ids : [];
  var header = Array.isArray(resp&&resp.header) ? resp.header : [];
  var rows = Array.isArray(resp&&resp.rows) ? resp.rows : [];
  if(!ids.length||!header.length||!rows.length) throw new Error("No rows returned");
  STATE.ids=ids; STATE.header=header; STATE.rows=rows; STATE.idxId=Math.max(0, ids.indexOf("fi_0001"));
  var pos = -1;
  if (STATE.id) {
    if (STATE.idxId >= 0) {
      pos = rows.findIndex(function(row){ return String(row[STATE.idxId]) === String(STATE.id); });
    }
    if (pos < 0) {
      var targetId = String(STATE.id || "").trim().toLowerCase();
      pos = rows.findIndex(function(row){
        return row && row.some(function(cell){ return String(cell || "").trim().toLowerCase() === targetId; });
      });
    }
  }
  if (pos < 0) {
    pos = 0;
    if (rows[0]) {
      STATE.id = String((STATE.idxId >= 0 ? rows[0][STATE.idxId] : rows[0][0]) || "");
    }
  }
  applyIndex(pos, !!location.search);
  if (typeof console !== "undefined" && console.info) {
    console.info("detail-state", window.DETAIL_STATE_SNAPSHOT && window.DETAIL_STATE_SNAPSHOT());
  }

  await loadPresets();
  await loadLayoutAndApply(null);


  FieldsAPI && FieldsAPI.attachCellEditor && FieldsAPI.attachCellEditor(document.getElementById('grid'), {
    selector: '.table td.v',
    getRow: function(){ return STATE.row; },
    getLabels: function(){ return STATE.labels; },
    getContext: function(node){ return { fid: node.getAttribute('data-fid'), row: STATE.row, labels: STATE.labels }; },
    onCommit: function(fid, val, ctx){ /* server update if needed */ }
  });

  observeAndLinkify();
}
function showError(msg){
  var box=$("#error"); if(!box) return;
  box.textContent=msg; box.classList.add("error"); box.style.display="block";
}
document.addEventListener("DOMContentLoaded", function(){
  try{
    bindToolbar(); bindSaveUI(); bindSaveModal(); bindCardsModal(); bindFieldModal();
    init().catch(function(e){ showError(e.message||String(e)); });
  }catch(e){ showError(e.message||String(e)); }
},{once:true});

})();

</script>

<!-- ===== 40.saveas-modal (UI) ===== -->
<div id="pgSaveAsMask"></div>
<div id="pgSaveAs" role="dialog" aria-modal="true" aria-labelledby="pgSaveAsTitle">
  <div class="hd" id="pgSaveAsTitle">Save as Page View</div>
  <div class="bd">
    <div class="row">
      <label for="pgNewId">Page ID</label>
      <input id="pgNewId" placeholder="pg_XXXX" />
    </div>
    <div class="row">
      <label for="pgName">Page Name</label>
      <input id="pgName" placeholder="View name" />
    </div>
    <div class="row">
      <label for="pgType">Page Type</label>
      <select id="pgType">
        <option value="table">table</option>
        <option value="overview">overview</option>
        <option value="detail">detail</option>
      </select>
    </div>
    <div class="row">
      <label for="pgEntity">Entity</label>
      <select id="pgEntity">
        <option value="shot">shot</option>
        <option value="asset">asset</option>
        <option value="task">task</option>
        <option value="member">member</option>
        <option value="user">user</option>
        <option value="page">page</option>
      </select>
    </div>
    <div class="row" style="align-items:center;display:flex;gap:8px">
      <input id="pgShared" type="checkbox" /><label for="pgShared">Shared</label>
    </div>
  </div>
  <div class="ft">
    <button id="pgSaveAsCancel">Cancel</button>
    <button id="pgSaveAsOk">Save</button>
  </div>
</div>
<!-- ===== 40. End ===== -->




<!-- ===== 41.saveas-logic (JS) ===== -->
<script>
(function(){
  function qs(k){
    var m=location.search.replace(/^\?/,'').split('&'); for(var i=0;i<m.length;i++){var kv=m[i].split('='); if(kv[0]===k) return decodeURIComponent(kv[1]||'');}
    return '';
  }
  var CURRENT_ENTITY = qs('entity')||'';
  var CURRENT_ID     = qs('id')||'';

  var $mask = document.getElementById('pgSaveAsMask');
  var $dlg  = document.getElementById('pgSaveAs');
  var $id   = document.getElementById('pgNewId');
  var $name = document.getElementById('pgName');
  var $type = document.getElementById('pgType');
  var $ent  = document.getElementById('pgEntity');
  var $shr  = document.getElementById('pgShared');
  var $ok   = document.getElementById('pgSaveAsOk');
  var $ng   = document.getElementById('pgSaveAsCancel');

  function open(opts){
    opts = opts||{};
    $id.value   = opts.newId || '';
    $name.value = opts.name  || '';
    $type.value = opts.type  || 'table';
    $ent.value  = opts.entity|| (CURRENT_ENTITY||'shot');
    $shr.checked= !!opts.shared;

    $mask.style.display='block';
    $dlg.style.display='block';
    setTimeout(function(){ $id.focus(); }, 0);
  }
  function close(){
    $mask.style.display='none';
    $dlg.style.display='none';
  }

  $ng.onclick = close;
  $mask.onclick = close;

  $ok.onclick = function(){
    var srcId = CURRENT_ID;            // 現在のページID（pg_XXXX）を想定
    var newId = ($id.value||'').trim();
    if(!/^pg_\w+$/i.test(newId)){ alert('Page ID format: pg_XXXX'); return; }

    var patch = {
      "Page Name": ($name.value||'').trim(),
      "Page Type": ($type.value||'table'),
      "Entity":    ($ent.value||'shot'),
      "Shared":    $shr.checked
    };

    google.script.run
      .withSuccessHandler(function(res){
       if(!res||!res.ok){ alert('saveAs failed: '+(res&&res.error)); return; }
       // 書込完了待たずに現在選択を切替（サーバ側で __select true を扱う）
       google.script.run.dp_updateEntityRecord('page', newId, { "__select": true });
       close();
       location.assign(location.pathname + '?entity=page&id=' + encodeURIComponent(newId));
      })
      .withFailureHandler(function(err){ alert('saveAs error: '+err); })
      .dp_saveAsPage(srcId, newId, patch);
  };

  // 既存の「名前入力」トリガに自動バインド（存在すれば）
  var btn = document.getElementById('btnSaveAs');
  if(btn){ btn.onclick=function(){ open({ entity: CURRENT_ENTITY }); }; }

  // 外部公開
  window.MOTK_SaveAsPage = { open: open, close: close };
})();
</script>
<!-- ===== 41. End ===== -->


</body>
</html>



