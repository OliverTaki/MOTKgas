# Detail Page 完成仕様要件（2025‑08‑01 決定版)

## 1. 目的

Shots シート各行（Shot）をカード形式で閲覧・編集するための詳細ページを提供し、現場でフィールド値を柔軟かつ視覚的に整理・確認できるようにする。

## 2. 画面レイアウト

| 項目                 | 説明                                                                                                     |
| -------------------- | -------------------------------------------------------------------------------------------------------- |
| **ツールバー**       | 画面上部に固定。左寄せ要素と右寄せ要素を持つ。                                                           |
| **GridStack エリア** | ツールバーを除いた残り領域。`overflow‑y:auto` で常時縦スクロール、`overflow‑x:auto` で横スクロール許容。 |

## 3. ツールバー詳細

| 位置       | 要素                         | 内容・動作                                                                                                                                                                                |
| ---------- | ---------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **左寄せ** | **ショット表示名**           | `fi_0002` (SHOTCODE) の値のみ常時表示                                                                                                                                                     |
|            | **前カット / 次カット**      | `fi_0001` 昇順（Shots シート行順）でページ遷移                                                                                                                                            |
|            | **階層ドロップダウン**       | 1 つの階層メニュー。Episode ▶ Act ▶ Sequence ▶ Scene ▶ Shot のツリーを辿って選択。選択確定で Shot ページ遷移。メニュー項目ラベルは各階層値を `_` 連結。ツールチップでフル階層を表示。 |
| **右寄せ** | **閲覧⇆編集トグル**          | Google Sheets 編集権限ユーザにのみ表示。クリックで `staticGrid` 真偽を切替。                                                                                                              |
|            | **レイアウト選択プルダウン** | `Pages` シート保存済みレイアウトを切替。                                                                                                                                                  |

## 4. モード

| モード                | GridStack 設定     | 操作                                                                |
| --------------------- | ------------------ | ------------------------------------------------------------------- |
| **閲覧** (デフォルト) | `staticGrid:true`  | カード移動・リサイズ不可。                                          |
| **編集**              | `staticGrid:false` | カード追加／削除／ドラッグ／リサイズ可。`beforeunload` で自動保存。 |

## 5. 権限制御

- `Session.getEffectiveUser()` が該当スプレッドシートの **編集権限** を持つ場合のみ、編集トグルと `Pages` 書込みを許可。
- 閲覧権限ユーザは閲覧モード固定。

## 6. レイアウト保存

- Apps Script 関数: `savePageLayout(entity, layoutName, json)`
- 保存先: **Pages シート**
  - 列構成: Page ID / Page Name / Page Type / Entity / Config(JSON) / Shared / Created By / Created / Modified

## 7. PROJECTMETA での階層設定

| 列                                      | 役割                                | 入力方法                                       |
| --------------------------------------- | ----------------------------------- | ---------------------------------------------- |
| Episode / Act / Sequence / Scene / Shot | 階層有効チェックボックス            | 有効列に✅を入れる                             |
| 上記各列                                | 階層に使用する **フィールドネーム** | プルダウン選択。裏で Field ID を保持（非表示） |

- Shot は常に最下位。チェックがない列または ID 空欄列はスキップ。
- 最大 5 階層まで対応。

## 8. GridStack (船 / カード束)

| 項目              | 内容                                                                                  |
| ----------------- | ------------------------------------------------------------------------------------- |
| 表示形式          | `<table class="ship-table">` 内に `<th>`=フィールドネーム, `<td>`=値 を行単位で表示。 |
| フィールド名取得  | `Fields` シートのラベル行。ID は UI に表示しない。                                    |
| 初期カードサイズ  | `gs-w="3"` `gs-h="1"`（調整可）                                                       |
| 操作 (編集モード) | Add Ship／Delete／Bulk Remove／ドラッグ／リサイズ。配置・サイズは JSON 保存。         |

## 9. 非表示フィールド

- `HIDE` 配列に Field ID を設定するとカード生成をスキップ。

## 10. 表示名生成

- ドロップダウン項目: 各階層値を `_` 連結。
- 区切り文字は `_`（共通）。
- ツールバー表示名は ShotCode のみ。

## 11. ファイル操作（将来拡張）

- Detail ページに Upload ボタンを追加予定。
- 予定フロー: Drive `MOTK/{project}/Shots/{shotId}/` にアップロード → サムネイル取得 → カード表示。
- プロキシ生成・バージョン履歴は現段階では対象外。

## 12. 技術スタック & 非機能要件

- **ライブラリ**: GridStack.js (H5), FontAwesome (アイコン), Google Apps Script HTMLService
- **Trusted Types**: `<script>` 最上部で default policy を設定し外部スクリプト読み込みを許可。
- **ブラウザ対応**: Desktop Chrome / Edge 最新版で検証。モバイルは横スクロールで操作可能。
- **パフォーマンス**: 編集モード中も reflow を最小限に抑え、100 枚以上のカードでも 60 fps を目標とする。

---

このドキュメントは 2025‑08‑01 時点の確定仕様を完全に網羅しています。将来の拡張や修正はこのファイルを更新して履歴管理してください。
