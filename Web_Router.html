
<script>
/* ===== 1–5.core (Router, utils, nav, entity-link, init) ===== */
(function(){
  "use strict";

  /* --- 1.Router --- */
  function baseUrl(){
    return (window.scriptUrl || window.SCRIPT_URL || (location.origin + location.pathname));
  }
  function normalizeEntity(ent){ return String(ent||'').trim().toLowerCase(); }
  function pageToEntity(pid){
    var p = String(pid || '').trim().toLowerCase();
    if(p==='assets') return 'asset';
    if(p==='tasks')  return 'task';
    if(p==='users')  return 'user';
    if(p==='members'||p==='projectmembers') return 'member';
    return 'shot';
  }
  function detailPageNameForEntity(ent){
    var key = normalizeEntity(ent);
    if(key==='asset'||key==='assets') return 'DetailAsset';
    if(key==='task'||key==='tasks') return 'DetailTask';
    if(key==='user'||key==='users') return 'DetailUser';
    if(key==='member'||key==='members'||key==='projectmember'||key==='projectmembers') return 'DetailMember';
    return 'DetailShot';
  }
  function pageUrl(pg, withTs){
    var u = new URL(baseUrl(), baseUrl());
    var cur = new URLSearchParams(location.search).get('page') || '';
    var body = document.body || {};
    var dataPage = body.dataset ? (body.dataset.navPage||'') : '';
    var statePage = (window.STATE && window.STATE.pageKey) ? window.STATE.pageKey : '';
    var target = pg || cur || statePage || dataPage || '';
    if(target){
      u.searchParams.set('page', target);
      var ent = pageToEntity(target);
      if(ent) u.searchParams.set('entity', ent);
    }
    if(withTs){ u.searchParams.set('ts', Date.now().toString(36)); }
    return u.toString();
  }
  function buildEntityUrl(ent,id){
    var u = new URL(baseUrl(), baseUrl());
    var targetPage = detailPageNameForEntity(ent);
    u.searchParams.set('page', targetPage);
    u.searchParams.set('entity', ent||'shot');
    u.searchParams.set('id', id||'');
    u.searchParams.set('ts', Date.now().toString(36));
    return u.toString();
  }
  window.detailPageNameForEntity = detailPageNameForEntity;
  window.__Router__ = { baseUrl, pageUrl, buildEntityUrl };

  /* --- 2.runtime utils --- */
  window.raf = window.raf || function(fn){ return (window.requestAnimationFrame||setTimeout)(fn,16); };
  window.pumpOnce = window.pumpOnce || function(fn){
    if (typeof fn === 'function') return setTimeout(fn,0);
    return setTimeout(function(){},0); // HTMLDocument 等が渡っても無害化
  };

  /* --- 3.nav (#pNav をSPA遷移に統一) --- */
  (function(){
    function getParamPid(href){
      try{ var u=new URL(href,location.origin); return (u.searchParams.get('page')||'').trim(); }
      catch(_){ return ''; }
    }
    function currentPid(){
      try{ return (new URLSearchParams(location.search).get('page')||'').trim(); }
      catch(_){ return ''; }
    }
    function setActiveNav(){
      var cur=currentPid();
      var nav=document.getElementById('pNav'); if(!nav) return;
      var as=nav.querySelectorAll('a[href]');
      for(var i=0;i<as.length;i++){
        var a=as[i]; a.classList.remove('active');
        var pid=a.dataset.page||getParamPid(a.getAttribute('href'))||'';
        if(pid) a.dataset.page=pid;
        if(cur && pid && pid===cur) a.classList.add('active');
      }
    }
    function navigateTo(pid, entHint){
      if(!pid) return;
      var ent = entHint || pageToEntity(pid);
      var usp=new URLSearchParams(location.search); usp.set('page',pid);
      if(ent) usp.set('entity', ent);
      history.pushState({page:pid},'',location.pathname+'?'+usp.toString());
      setActiveNav();
      var handled=false;
      window.addEventListener('motk:navigate:handled', function once(){handled=true; window.removeEventListener('motk:navigate:handled', once);},{once:true});
      try{ window.dispatchEvent(new CustomEvent('motk:navigate',{detail:{page:pid, entity:ent}})); }catch(_){}
      setTimeout(function(){ if(!handled){ location.reload(); } },0);
    }
    window.enableSpaNav=function enableSpaNav(){
      var nav=document.getElementById('pNav'); if(!nav) return;
      var as=nav.querySelectorAll('a[href]');
      for(var i=0;i<as.length;i++){
        var a=as[i];
        if(a.dataset.spaBound==='1') continue;
        var pid=a.dataset.page||getParamPid(a.getAttribute('href'))||'';
        if(!pid) continue;
        a.dataset.page=pid;
        if(!a.dataset.entity){
          a.dataset.entity = a.getAttribute('data-entity') || pageToEntity(pid);
        }
        a.dataset.spaBound='1';
        a.addEventListener('click',function(e){
          var link=e.currentTarget;
          var p=link.dataset.page||''; if(!p) return;
          var entAttr = link.dataset.entity || pageToEntity(p);
          e.preventDefault(); navigateTo(p, entAttr);
        });
      }
      setActiveNav();
      if(!window.__pNavPopstateBound){
        window.addEventListener('popstate', setActiveNav);
        window.__pNavPopstateBound = true;
      }
    };
    function autoEnableNav(){
      try{ window.enableSpaNav && window.enableSpaNav(); }catch(_){}
    }
    if(document.readyState==='loading'){
      document.addEventListener('DOMContentLoaded', autoEnableNav, {once:true});
    }else{
      autoEnableNav();
    }
  })();

  /* --- 4.Entity link rewrite (安定) --- */
  document.addEventListener("click", function(ev){
    var a = ev.target && ev.target.closest ? ev.target.closest("a[href]") : null;
    if(!a) return;
    try{
      var u = new URL(a.href, location.origin);
      var ent = u.searchParams.get("entity");
      var id  = u.searchParams.get("id");
      if(!(ent && id)) return;
      ev.preventDefault();
      var href = buildEntityUrl(ent, id);
      try{ window.top.location.assign(href); }catch(_){ window.top.location.href = href; }
    }catch(_){}
  }, {capture:true});

  /* --- 5.Init --- */
  document.addEventListener("DOMContentLoaded", function(){
    pumpOnce(function(){}); // レガシー互換のダミー1tick
  }, {once:true});

})();

</script>


<!-- ===== 12.detail-popover-dom ===== -->
<script>
(function(){
  "use strict";

  // 共通レンダラ呼び出し
  function renderFieldInto(node, field, row){
    if (!node) return;
    var ctx = { el: node, field: field, row: row };
    if (typeof window.renderFieldCell === 'function'){
      try { window.renderFieldCell(ctx); return; } catch(_){}
    }
    // フォールバック
    node.textContent = row && field && (row[field.field_name] || row[field.name] || '') || '';
  }

  // detailカード生成時に shotview を含む全フィールドで共通レンダラを適用
  window.renderDetailCard = function(cardEl, fieldDef, rowData){
    if (!cardEl) return;
    var target = cardEl.querySelector('[data-slot="value"]') || cardEl;
    renderFieldInto(target, fieldDef, rowData);
  };
})();
</script>
<!-- ===== 12. End ===== -->



<!-- ===== 13.detail-edit-init ===== -->
<script>
(function(){
  "use strict";

  // push grid below toolbar by applying margin to actual grid element
  function applyTopOffset(){
    var bar = document.getElementById('detailBar');
    var h = bar && bar.getBoundingClientRect ? Math.round(bar.getBoundingClientRect().height) : 0;
    var gridEl = document.querySelector('#grid') || document.querySelector('#gridstackWrap') || document.querySelector('.grid-stack');
    if (gridEl){ gridEl.style.marginTop = h ? (h+'px') : ''; }
    var tableHost = document.getElementById('tableHost');
    if (tableHost){ tableHost.style.marginTop = h ? (h+'px') : ''; }
  }

  // debounce init to avoid thrash
  var __gs_pending = false;
  function ensureGridstack(){
    if (__gs_pending) return;
    __gs_pending = true;
    requestAnimationFrame(function(){
      __gs_pending = false;

      var el = document.querySelector('#grid') || document.querySelector('#gridstackWrap') || document.querySelector('.grid-stack');
      var GS = (window && window.GridStack) || null;
      if (!el || !GS || typeof GS.init !== 'function') return;

      // make CSS unit match GS cellHeight to remove 1-cell bounce
      var CELL = 24; // px
      var opts = { float:true, margin:0, cellHeight:CELL, disableOneColumnMode:false, minRow:1 };

      try{
        var gs = el.gridstack || GS.init(opts, el);
        if (!el.gridstack) el.gridstack = gs;

        // CSS snap alignment
        if (!document.getElementById('motk-gs-style')){
          var st=document.createElement('style'); st.id='motk-gs-style';
          st.textContent = [
            '.grid-stack{--gs-cell:'+CELL+'px;}',
            '.grid-stack-item{margin:0 !important;}',
            '.grid-stack-item-content{min-height:var(--gs-cell); height:100%;}',
            '.grid-stack-placeholder{margin:0 !important; top:0 !important; left:0 !important;}'
          ].join('');
          document.head.appendChild(st);
        }
      }catch(e){ console.error(e); }
    });
  }

  function bindToolbar(){
    var tl    = document.getElementById("toggleLayout");
    var save  = document.getElementById("saveBtnAll");
    var cards = document.getElementById("cardsBtn");
    var badge = document.getElementById("modeBadge");
    var footer= document.getElementById("footerMode");

    function applyMode(){
      var isEdit = !!(window.STATE && window.STATE.edit);
      document.body.classList.toggle("layout-edit", isEdit);
      document.body.setAttribute('data-layout-mode', isEdit ? 'edit' : 'view');

      if (save){ save.style.display = isEdit ? "" : "none"; save.disabled = !isEdit; }
      if (cards){ cards.style.display = isEdit ? "" : "none"; cards.disabled = !isEdit; }
      if (tl){
        tl.textContent = isEdit ? "Edit mode" : "View mode";
        tl.setAttribute("aria-pressed", isEdit ? "true" : "false");
        tl.classList.toggle('is-active', isEdit);
      }
      if (badge){
        badge.textContent = isEdit ? 'EDIT MODE' : 'VIEW MODE';
        badge.style.display = isEdit ? "inline-flex" : "none";
      }
      if (footer){ footer.textContent = isEdit ? 'Edit' : 'View'; }
    }

    if (tl){
      tl.addEventListener('click', function(e){
        e.preventDefault();
        if(!window.STATE) window.STATE = {};
        window.STATE.edit = !window.STATE.edit;
        applyMode();
        ensureGridstack();
      }, {passive:false});
    }

    applyMode();
    window.addEventListener('resize', function(){ applyTopOffset(); ensureGridstack(); }, {passive:true});
  }

  function isDetailPage(){
    return !!document.querySelector('#detailBar, .detail-page, #detail-root, main[data-detail-root]');
  }

  function start(){
    if (!isDetailPage()) return;
    applyTopOffset();
    bindToolbar();
    ensureGridstack();
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', start, {once:true});
  } else {
    start();
  }
})();
</script>
<!-- ===== 13. End ===== -->



<!-- ===== 14.modal-center-init ===== -->
<script>
/* Modal: cards を確実に表示。外側クリックで閉じる。Cancel類も閉じる。 */
(function(){
  "use strict";

  var BD_ID = 'motk-modal-backdrop';

  function $(s, r){ return (r||document).querySelector(s); }
  function $all(s, r){ return Array.prototype.slice.call((r||document).querySelectorAll(s)); }
  function isDetail(){ return !!document.querySelector('#detailBar, .detail-page, #detail-root, main[data-detail-root]'); }

  function ensureStyle(){
    if (document.getElementById('motk-modal-style')) return;
    var st=document.createElement('style'); st.id='motk-modal-style';
    st.textContent = [
      '.motk-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:10001;display:none;pointer-events:none;}',
      'body.motk-modal-open .motk-modal-backdrop{display:block;pointer-events:auto;}',
      '.motk-center-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10003;max-width:90vw;max-height:85vh;overflow:auto;}',
      'body.motk-modal-open{overflow:hidden;}'
    ].join('');
    document.head.appendChild(st);
  }
  function ensureBackdrop(){
    var bd = document.getElementById(BD_ID);
    if (!bd){ bd=document.createElement('div'); bd.id=BD_ID; bd.className='motk-modal-backdrop'; document.body.appendChild(bd); }
    return bd;
  }
  function guardInsideClick(m){
    if(!m || m.__motk_guarded) return;
    m.__motk_guarded = true;
    m.addEventListener('click', function(e){ e.stopPropagation(); }, true);
  }
  function hoistToBody(m){
    if (!m) return m;
    if (m.parentElement !== document.body){
      var ph = document.createComment('hoisted:'+ (m.id||m.getAttribute('data-modal')||'modal'));
      m.__motk_placeholder = ph;
      m.parentElement && m.parentElement.insertBefore(ph, m);
      document.body.appendChild(m);
    }
    return m;
  }
  function center(m){
    if(!m) return;
    m.classList.add('motk-center-modal');
    // 最低限の視認サイズ（ゼロ寸対策）
    if (!m.style.minWidth)  m.style.minWidth  = '320px';
    if (!m.style.minHeight) m.style.minHeight = '160px';
    // 面積0なら一時的に内容包む
    var r=m.getBoundingClientRect();
    if ((r.width<2 || r.height<2) && !m.__motk_wrap){
      var wrap=document.createElement('div'); wrap.style.padding='16px';
      while(m.firstChild) wrap.appendChild(m.firstChild);
      m.appendChild(wrap); m.__motk_wrap=wrap;
    }
  }
  function show(m){
    if(!m) return false;
    ensureStyle(); ensureBackdrop(); hoistToBody(m); center(m); guardInsideClick(m);
    m.setAttribute('aria-hidden','false'); m.style.display='';
    document.body.classList.add('motk-modal-open');
    return true;
  }
  function hide(m){
    if(m){ m.setAttribute('aria-hidden','true'); m.style.display='none'; }
    if (!$('.motk-center-modal[aria-hidden="false"]')) document.body.classList.remove('motk-modal-open');
  }

  // Cards候補を網羅的に探索
  function resolveCards(){
    var cands = [
      '[data-modal="cards"]','#cardsModal','.cards-modal',
      '.modal#cards','.modal.cards',
      '.modal[aria-label*="cards" i]','.modal [data-role="cards-modal"]'
    ];
    for (var i=0;i<cands.length;i++){ var n=$(cands[i]); if(n) return n; }
    // 最後の保険: ボタンの data-target / aria-controls 参照
    var b = $('#cardsBtn'); if (b){
      var sel = b.getAttribute('data-modal-target') || b.getAttribute('data-target') || b.getAttribute('aria-controls');
      if (sel){ var n = $(sel); if(n) return n; }
    }
    return null;
  }

  function wire(){
    if(!isDetail()) return;

    var bd = ensureBackdrop();
    bd.onclick = function(){
      var m = $('.motk-center-modal[aria-hidden="false"], .modal[aria-hidden="false"]');
      hide(m);
    };

    // Cards
    var btnCards = $('#cardsBtn');
    if (btnCards){
      btnCards.addEventListener('click', function(e){
        e.preventDefault();
        var m = resolveCards();
        if (!m){ document.body.classList.remove('motk-modal-open'); return; }
        var hidden = (m.getAttribute('aria-hidden')!=='false') && (getComputedStyle(m).display==='none');
        if (hidden) show(m); else hide(m);
      }, {passive:false});
    }

    // Save/その他: [data-modal-target="#sel"]
    document.addEventListener('click', function(e){
      var t = e.target.closest('[data-modal-target]');
      if (!t) return;
      e.preventDefault();
      var sel = t.getAttribute('data-modal-target'); if (!sel) return;
      var m = $(sel); if (!m){ document.body.classList.remove('motk-modal-open'); return; }
      var hidden = (m.getAttribute('aria-hidden')!=='false') && (getComputedStyle(m).display==='none');
      if (hidden) show(m); else hide(m);
    }, false);

    // Cancel/Close: 代表的シグナルをすべて閉じるに割当
    document.addEventListener('click', function(e){
      var t = e.target.closest('[data-modal-close], [data-dismiss="modal"], .modal .close, .btn-cancel, .js-cancel, button[name="cancel"]');
      if(!t) return;
      e.preventDefault();
      var m = t.closest('.motk-center-modal, .modal');
      hide(m);
    }, false);

    // 内側クリックで閉じる古いハンドラに勝つ
    $all('.modal,.motk-center-modal').forEach(guardInsideClick);

    // リサイズで再センター
    window.addEventListener('resize', function(){
      var m=$('.motk-center-modal[aria-hidden="false"]'); if(m) center(m);
    }, {passive:true});
  }

  if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', wire, {once:true}); }
  else { wire(); }
})();
</script>
<!-- ===== 14. End ===== -->




<!-- ===== 14b.backdrop-safety ===== -->
<script>
(function(){
  "use strict";
  // detail遷移直後や戻り時に残る全画面オーバーレイを定期的に無効化
  var T=null;
  function sweep(){
    try{
      var maxZ = -1, culprit=null;
      document.querySelectorAll('body > *').forEach(function(n){
        var cs = getComputedStyle(n);
        if (!cs) return;
        var z = parseInt(cs.zIndex||'0',10);
        var full = cs.position==='fixed' && cs.left==='0px' && cs.top==='0px' && cs.right==='0px' && cs.bottom==='0px';
        var opaque = parseFloat(cs.opacity||'1')>0.01 && (cs.display!=='none' && cs.visibility!=='hidden');
        if (full && opaque && z>maxZ){
          maxZ = z; culprit = n;
        }
      });
      // 既知のモーダル以外で、全画面を覆っていたら無効化
      if (culprit && !culprit.classList.contains('motk-center-modal') && !culprit.classList.contains('motk-modal-backdrop')){
        culprit.style.pointerEvents='none';
        // 透過だけして視覚崩れを避ける
        culprit.style.opacity='0';
      }
    }catch(_){}
  }
  function start(){
    if (T) return;
    T = setInterval(sweep, 500);
  }
  function stop(){
    if (!T) return;
    clearInterval(T); T=null;
  }
  document.addEventListener('visibilitychange', function(){
    if (document.visibilityState==='visible') start(); else stop();
  });
  // 初回
  start();
})();
</script>
<!-- ===== 14b. End ===== -->


<!-- ===== 41.detail-dom-normalize ===== -->
<script>
(function(){
"use strict";
function isDetail(){return !!document.querySelector("#detailBar,[data-detail-root],.detail-page");}
function killSpacers(){
  document.querySelectorAll(".spacer-top").forEach(function(n){ try{ n.parentNode.removeChild(n); }catch(_){ } });
}
function liftGrid(){
  var grid=document.querySelector("#gridstackWrap")||document.querySelector("#grid")||document.querySelector(".grid-stack");
  if(grid){
    grid.style.marginTop="0";
    grid.style.top="0";
  }
}
function hideTopBands(){
  ["#hScroll",".top-band",".grid-top-gap",".grid-overlay"].forEach(function(sel){
    var el=document.querySelector(sel); if(el){ el.style.display="none"; }
  });
}
function init(){
  if(!isDetail()) return;
  killSpacers();
  hideTopBands();
  liftGrid();
}
if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",init,{once:true});}else{init();}
window.addEventListener("resize",function(){ if(isDetail()){ liftGrid(); } },{passive:true});
})();
/* ===== 41. End ===== */
</script>
