<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <?!= include('3CL_CommonStyles'); ?>
</head>

<body>
  <div id="table-view-container">
    <!-- Toolbar -->
    <div id="toolbar">
      <select id="presetSelect" aria-label="Pages"></select>
      <span id="presetStatus" class="muted"></span>

      <!-- Save dropdown（Save / Save as… / Revert） -->
      <div class="dropdown" id="saveDD">
        <button id="saveDDBtn" class="btn">Save ▾</button>
        <div class="dd-menu" id="saveDDMenu">
          <div class="dd-item" data-act="save">Save</div>
          <div class="dd-item" data-act="saveas">Save as…</div>
          <div class="dd-item" data-act="revert">Revert</div>
        </div>
      </div>

      <button id="sortBtn" class="btn">Sort</button>
      <button id="filterBtn" class="btn">Filter</button>
      <button id="columnsBtn" class="btn">Fields</button>

      <div class="spacer"></div>
      <input id="quickSearch" type="search" placeholder="Server search (Enter)" />
    </div>

    <!-- Table -->
    <div id="tableWrap"></div>

    <!-- Footer -->
    <div id="statusBar">
      <span id="statusLeft" class="muted">loading…</span>
      <div class="spacer"></div>
      <div id="pager">
        <select id="perPage" title="Rows per page">
          <option value="50">50</option>
          <option value="100" selected>100</option>
          <option value="200">200</option>
          <option value="500">500</option>
          <option value="all">ALL</option>
        </select>
        <span class="muted">per page</span>
        <button id="prevBtn" class="btn" aria-label="Previous page">‹</button>
        <select id="pageSelect" title="Page"></select>
        <button id="nextBtn" class="btn" aria-label="Next page">›</button>
      </div>
    </div>
  </div>

  <!-- Panels -->
  <div id="colPanel" class="panel" role="dialog" aria-label="Fields menu"></div>
  <div id="sortPanel" class="panel" role="dialog" aria-label="Sort menu"></div>
  <div id="filterPanel" class="panel" role="dialog" aria-label="Filter menu"></div>

  <!-- New Page small popover -->
  <div id="npPopover"
    style="display:none;position:absolute;z-index:10001;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:12px;box-shadow:0 10px 28px rgba(0,0,0,.25);min-width:280px;">
    <h3 style="margin:0 0 8px 0;font:600 14px system-ui;">New Page</h3>
    <div class="row">
      <label style="min-width:72px;">Name</label>
      <input id="npName" type="text" maxlength="64" style="flex:1 1 auto;min-width:180px;padding:6px 8px;">
    </div>
    <div class="row">
      <label style="min-width:72px;">Shared</label>
      <label><input id="npShared" type="checkbox"> share with team</label>
    </div>
    <div class="row" style="justify-content:flex-end;gap:8px;">
      <button id="npCancel" class="btn">Cancel</button>
      <button id="npSave" class="btn">Save</button>
    </div>
  </div>

  <?!= include('3CL_CommonRenderer'); ?>
  <?!= include('3CL_Router'); ?>

  <script>
    function _toScalarText_(v) {
      if (v === null || v === undefined) return "";
      var t = typeof v;
      if (t === "string") return v;
      if (t === "number") return Number.isFinite(v) ? String(v) : "";
      if (t === "boolean") return v ? "true" : "false";
      if (v instanceof Date) return isNaN(v.getTime()) ? "" : v.toISOString();
      try { if (t === "object") return JSON.stringify(v); } catch (_) { }
      return "";
    }

    function _toIsoDate_(v) {
      if (v instanceof Date) return isNaN(v.getTime()) ? "" : v.toISOString();
      if (typeof v === "string") return v;
      return "";
    }

    window.__MOTK_BOOTSTRAP_TS__ = window.__MOTK_BOOTSTRAP_TS__ || performance.now();
    /** =========================================
     *  viewer.html (renumbered / organized)
     *  - unify addGlobalClosers/removeGlobalClosers
     *  - avoid openPanel wrapper overrides
     *  - avoid applyData override hooks (Distinct updates after fetch)
     *  - keep existing UI/behavior; refactor structure only
     * =========================================*/

    /* ===== Section Index =====
     *  1. グローバル初期化（scriptUrl / SPA ナビ導入フック）
     *  2. レイアウトオフセット（adjustNavOffset）
     *  3. 汎用ユーティリティ（uniq / raf / _canon 等）
     *  3A. copy helper
     *  4. グローバルクロージャ（addGlobalClosers / removeGlobalClosers）
     *  5. エンティティ/ステータスヘルパ
     *  6. ページング定数・ローカルストレージ
     *  7. ページング計算 & UI バインド
     *  8. URL 状態（page / perPage / sort）
     *  8A. URL ユーティリティ（getUrlParam）
     *  8C. linkmaps-cache（現在は no-op）
     *  9. Viewer STATE 定義
     *  9A. state guard
     * 10. Link マップ（LINK_MAPS） & 名前抽出
     * 11. Proxy index（ShotView/AssetView 用）
     * 12. GAS 呼び出しヘルパ（callFirst）
     * 13. データソース判定 & 正規化（normalizeRowsPayload）
     * 14. グループフィルタ payload
     * 15. 列順・列幅・visibleCols
     * 16. テーブルレンダリング本体（renderCurrentPage）
     * 16C. 列リサイズ & 並び替えハンドラ
     * 17. View 列 Lazy ロード（shotview / assetview）
     * 18. リンクレンダリングヘルパ
     * 19. カラムパネル（Fields）
     * 20. ソートパネル
     * 21. Distinct 値キャッシュ & refreshDistinctCache
     * 22. フィルタパネル V3
     * 23. パネル共通 openPanel / closePanel / closeAllPanels
     * 24. Dirty フラグ管理（setDirty）
     * 25. Save ドロップダウン UI（Save / Save as… / Revert）
     * 26. fetch + payload（buildServerPayload / fetchAndRenderPage / fetchPageOnlyFromCacheThenNetwork）
     * 27. ちょいユーティリティ（rid / labelForFieldId）
     * 28. SaveAs モーダル (UI)
     * 29. local_cache
     * 30. prefetch_pages
     * 31. link_labels
    
     * =========================*/

    ; (function () {
      "use strict";

      /* ===== 1. グローバル初期化（scriptUrl / SPA ナビ導入フック） ===== */

      try {
        try { window.__SCRIPT_URL_SERVER__ = "<?= ScriptApp.getService().getUrl() ?>"; } catch (_) { }
        window.scriptUrl = (function () {
          try { return location.origin + location.pathname; }
          catch (e) { return location.pathname; }
        })();
      } catch (e) {
        try { window.scriptUrl = location.pathname; } catch (_) { }
      }

      /* ===== 2. レイアウトオフセット（adjustNavOffset） ===== */

      function adjustNavOffset() {
        try {
          var g = document.getElementById('gNav'), p = document.getElementById('pNav');
          var h = (g ? g.offsetHeight : 0) + (p ? p.offsetHeight : 0);
          document.documentElement.style.setProperty('--nav-offset', (h || 0) + 'px');
        } catch (e) { }
      }

      /* ===== 3. 汎用ユーティリティ（uniq / raf / _canon 等） ===== */

      function uniq(a) {
        var o = {}, r = [];
        for (var i = 0; i < a.length; i++) {
          var v = a[i];
          if (v != null && v !== '' && !o[v]) { o[v] = 1; r.push(v); }
        }
        return r;
      }

      var rIC = window.requestIdleCallback
        ? function (cb) { return window.requestIdleCallback(cb); }
        : function (cb) { return setTimeout(cb, 0); };

      var raf = window.requestAnimationFrame
        ? function (cb) { return window.requestAnimationFrame(cb); }
        : function (cb) { return setTimeout(cb, 0); };

      function _canon(s) {
        return String(s || '').toLowerCase().trim().replace(/[\s_-]/g, '');
      }

      function escapeHTML(s) {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

      function deepCopy(o) {
        try { return JSON.parse(JSON.stringify(o)); }
        catch (e) { return o; }
      }

      function hasGoogle() {
        return !!(window.google && google.script && google.script.run);
      }

      /* ===== 3A. copy helper ===== */

      function copy(o) {
        var r = {};
        if (o && typeof o === 'object') {
          for (var k in o) {
            if (Object.prototype.hasOwnProperty.call(o, k)) r[k] = o[k];
          }
        }
        return r;
      }

      /* ===== 4. グローバルクロージャ（addGlobalClosers / removeGlobalClosers） ===== */

      function addGlobalClosers(popupEl, anchorEl, onClose) {
        function onDocMouseDown(ev) {
          if (!popupEl) return;
          var t = ev.target;
          var insidePopup = popupEl.contains(t);
          var insideAnchor = anchorEl && anchorEl.contains ? anchorEl.contains(t) : false;
          if (!insidePopup && !insideAnchor) {
            onClose && onClose();
          }
        }
        function onKey(ev) {
          if (ev.key === 'Escape') {
            onClose && onClose();
          }
        }
        popupEl.setAttribute('data-global-closer', '1');
        document.addEventListener('mousedown', onDocMouseDown);
        document.addEventListener('keydown', onKey);
        popupEl._closerteardown = function () {
          document.removeEventListener('mousedown', onDocMouseDown);
          document.removeEventListener('keydown', onKey);
        };
      }

      function removeGlobalClosers(popupEl) {
        try {
          if (popupEl && popupEl._closerteardown) {
            popupEl._closerteardown();
            delete popupEl._closerteardown;
          }
        } catch (e) { }
      }

      /* ===== 5. エンティティ/ステータスヘルパ ===== */

      function singularEntityLoose_(x) {
        var s = _canon(x);
        if (!s) return '';
        if (s === 'shots' || s === 'shot') return 'shot';
        if (s === 'assets' || s === 'asset') return 'asset';
        if (s === 'tasks' || s === 'task') return 'task';
        if (s === 'users' || s === 'user') return 'user';
        if (s === 'projectmembers' || s === 'projectmember' || s === 'members' || s === 'member') return 'member';
        if (s === 'scheds' || s === 'sched' || s === 'schedules' || s === 'schedule') return 'sched';
        return '';
      }

      function singularEntityFor(x) {
        var s = singularEntityLoose_(x);
        return s || 'shot';
      }

      function pluralEntityFor(x) {
        var s = singularEntityFor(x);
        if (s === 'shot') return 'Shots';
        if (s === 'asset') return 'Assets';
        if (s === 'task') return 'Tasks';
        if (s === 'user') return 'Users';
        if (s === 'member') return 'ProjectMembers';
        if (s === 'sched') return 'Scheds';
        return 'Shots';
      }

      function showStatus(msg, isError, restoreMs) {
        var s = document.getElementById('statusLeft');
        if (!s) return;

        // Stable status baseline: update only when called with exactly 1 argument.
        window.__MOTK_TABLE_STATUS_STABLE = window.__MOTK_TABLE_STATUS_STABLE || '';
        if (arguments.length === 1) {
          window.__MOTK_TABLE_STATUS_STABLE = msg || '';
        }

        s.textContent = msg || '';
        s.style.color = isError ? 'crimson' : '';

        window.__MOTK_TABLE_STATUS_TIMER = window.__MOTK_TABLE_STATUS_TIMER || null;
        if (window.__MOTK_TABLE_STATUS_TIMER) {
          clearTimeout(window.__MOTK_TABLE_STATUS_TIMER);
          window.__MOTK_TABLE_STATUS_TIMER = null;
        }

        if (restoreMs && restoreMs > 0) {
          window.__MOTK_TABLE_STATUS_TIMER = setTimeout(function () {
            var back = window.__MOTK_TABLE_STATUS_STABLE || '';
            s.textContent = back;
            s.style.color = '';
            window.__MOTK_TABLE_STATUS_TIMER = null;
          }, restoreMs);
        }
      }

      function _entityFromUrl() {
        try {
          var e = (getRouteParam_('e') || getRouteParam_('entity') || '').trim();
          return canonEntityKey_(e, '');
        } catch (_) { return ''; }
      }

      var _CANON_ENTITIES_ = ['shot', 'asset', 'task', 'member', 'user', 'sched'];

      function normalizeEntityToken_(raw) {
        var s = String(raw || '').trim();
        if (!s) return '';
        s = s.toLowerCase();
        if (s === 'projectmembers' || s === 'projectmember') s = 'member';
        var ent = singularEntityLoose_(s);
        ent = String(ent || '').toLowerCase();
        return _CANON_ENTITIES_.indexOf(ent) >= 0 ? ent : '';
      }

      function canonEntityKey_(raw, fallback) {
        var ent = normalizeEntityToken_(raw);
        if (ent) return ent;
        var loose = singularEntityLoose_(raw);
        if (loose) return loose;
        return fallback || '';
      }

      function normalizeEntityFromParams_() {
        try {
          var raw = (getRouteParam_('e') || getRouteParam_('entity') || '').trim();
          return canonEntityKey_(raw, '');
        } catch (_) { return ''; }
      }

      function isOAuthDialog_() {
        try {
          var usp = new URLSearchParams(location.search);
          var v = (usp.get('createOAuthDialog') || '').trim().toLowerCase();
          if (v !== 'true' && v !== '1') return false;
          if (usp.get('pid') || usp.get('id') || usp.get('p') || usp.get('page') || usp.get('e') || usp.get('entity')) return false;
        } catch (_) { return false; }
        try {
          if (STATE && (STATE.pageId || STATE.sheetName)) return false;
        } catch (_) { }
        try {
          var raw = (STATE && STATE.rawParams) ? STATE.rawParams : null;
          if (raw && (raw.e || raw.entity || raw.p || raw.page || raw.pid || raw.id)) return false;
        } catch (_) { }
        try {
          var ctx = window.__VIEW_CTX || {};
          if (ctx && (ctx.entity || ctx.sheetName || ctx.page || ctx.pageId || ctx.pid || ctx.id)) return false;
        } catch (_) { }
        try {
          var ds = (document.body && document.body.dataset) ? document.body.dataset : {};
          if (ds.navEntity || ds.motkEntity || ds.entity || ds.navPage || ds.motkPage || ds.page || ds.pageId || ds.pid || ds.motkPageId) return false;
        } catch (_) { }
        try {
          var stored = localStorage.getItem('MOTK.viewer.state') || localStorage.getItem('motk:viewerStateSnapshot');
          if (stored) {
            var snap = JSON.parse(stored);
            if (snap && (snap.pageId || snap.sheetName || snap.entityParam || snap.origin)) return false;
          }
        } catch (_) { }
        return true;
      }

      function normalizeCreateOAuthDialogParam_() {
        try {
          var usp = new URLSearchParams(location.search);
          var v = (usp.get('createOAuthDialog') || '').trim().toLowerCase();
          if (v !== 'true' && v !== '1') return false;
          if (isOAuthDialog_()) return false;
          usp.delete('createOAuthDialog');
          var qs = usp.toString();
          history.replaceState(null, '', location.pathname + (qs ? '?' + qs : ''));
          return true;
        } catch (_) { return false; }
      }

      function _entityFromPid() {
        try {
          return (typeof entityFromPageId === 'function')
            ? entityFromPageId(STATE && STATE.pageId)
            : '';
        } catch (_) { return ''; }
      }

      function _entityForUI() {
        var e = _entityFromUrl() || _entityFromPid() || (STATE && STATE.sheetName) || '';
        return e || 'shot';
      }

      var VIEWER_STATE_STORAGE_KEY = 'MOTK.viewer.state';
      var VIEWER_STATE_STORAGE_KEY_LEGACY = 'motk:viewerStateSnapshot';
      var _viewerStateUploadHash = '';

      function uploadViewerSnapshotToServer(snapshot) {
        try {
          if (!window || !window.google || !google.script || !google.script.run) return;
          if (typeof google.script.run.withFailureHandler !== 'function') return;
          google.script.run.withFailureHandler(function () { }).dp_storeViewerState(snapshot);
        } catch (_) { }
      }

      window.persistViewerStateSnapshot = function (extra) {
        try {
          if (isOAuthDialog_()) return;
          var rowsLen = Array.isArray(STATE && STATE.rows) ? STATE.rows.length : 0;
          if (rowsLen <= 0) return;
          var snap = {
            updatedAt: Date.now(),
            sheetName: (STATE && STATE.sheetName) || '',
            sheetNameNormalized: normalizeEntityToken_((STATE && STATE.sheetName) || ''),
            pageId: (STATE && STATE.pageId) || '',
            page: Number(STATE && STATE.page) || 1,
            perPage: (STATE && STATE.perPage) || '',
            total: Number(STATE && STATE.total) || 0,
            rowsLength: rowsLen,
            dataSource: (STATE && (STATE.dataSourceEffective || STATE.dataSource)) || '',
            dataSourceStage: (STATE && STATE.dataSourceStage) || '',
            origin: (location && location.href) || '',
            entityParam: (function () { try { var usp = new URLSearchParams(location.search); return (usp.get('e') || usp.get('entity') || '') || ''; } catch (_) { return ''; } })(),
            entityParamNormalized: normalizeEntityFromParams_(),
            inlineEditBound: !!window.__MOTK_TABLE_INLINE_EDIT_BOUND,
            fieldIds: (Array.isArray(STATE.fieldIds) ? STATE.fieldIds.slice() : []),
            colsKey: (Array.isArray(STATE.fieldIds) ? STATE.fieldIds.join('|') : ''),
            __FIXED_COLUMNS__: !!STATE.__FIXED_COLUMNS__
          };
          // Persist only schema-approved fieldIds; defer filter if schema not yet loaded.
          try {
            var filtered = filterFieldIdListForEntity_(snap.fieldIds, 'snapshot:write');
            snap.fieldIds = filtered;
            snap.colsKey = filtered.join('|');
          } catch (_) { }
          if (window.__MOTK_LAST_TABLE_PERF__) snap.perf = window.__MOTK_LAST_TABLE_PERF__;
          if (window.__lastListRowsPayloadSummary || window.__lastListRowsPayload) {
            snap.lastListRowsPayload = window.__lastListRowsPayloadSummary || window.__lastListRowsPayload;
          }
          if (window.__lastListRowsRespDiag) snap.lastListRowsRespDiag = window.__lastListRowsRespDiag;
          if (window.__lastListRowsEntityMismatch) snap.lastListRowsEntityMismatch = window.__lastListRowsEntityMismatch;
          if (Array.isArray(STATE && STATE.rows)) {
            try {
              snap.sampleIds = STATE.rows.slice(0, 5).map(function (r) { return r && r[0]; });
            } catch (_) { }
          }
          if (extra && typeof extra === 'object') {
            Object.keys(extra).forEach(function (k) {
              snap[k] = extra[k];
            });
          }
          var serializedSnap = JSON.stringify(snap);
          localStorage.setItem(VIEWER_STATE_STORAGE_KEY, serializedSnap);
          try { localStorage.setItem(VIEWER_STATE_STORAGE_KEY_LEGACY, serializedSnap); } catch (_) { }
          try {
            if (serializedSnap && serializedSnap !== _viewerStateUploadHash) {
              _viewerStateUploadHash = serializedSnap;
              uploadViewerSnapshotToServer(snap);
            }
          } catch (_) { }
        } catch (_) { }
      }

      function readStoredViewerSnapshot_() {
        try {
          var raw = localStorage.getItem(VIEWER_STATE_STORAGE_KEY) || localStorage.getItem(VIEWER_STATE_STORAGE_KEY_LEGACY);
          if (!raw) return null;
          var snap = JSON.parse(raw);
          return (snap && typeof snap === 'object') ? snap : null;
        } catch (_) { }
        return null;
      }

      function writeStoredViewerSnapshot_(snap) {
        try {
          var serialized = JSON.stringify(snap || {});
          localStorage.setItem(VIEWER_STATE_STORAGE_KEY, serialized);
          try { localStorage.setItem(VIEWER_STATE_STORAGE_KEY_LEGACY, serialized); } catch (_) { }
          return true;
        } catch (_) { }
        return false;
      }

      function reconcileStoredViewerFieldIds_(entity, reason) {
        try {
          var ent = canonEntityKey_(entity || '', '');
          var allowed = buildAllowedFieldIdSetForEntity_(ent);
          if (!allowed) return false;
          var snap = readStoredViewerSnapshot_();
          if (!snap || !Array.isArray(snap.fieldIds)) return false;

          var before = snap.fieldIds.map(function (fid) { return String(fid || '').trim(); }).filter(Boolean);
          var after = before.filter(function (fid) { return !!allowed[fid]; });
          if (after.length === before.length) return false;

          var removed = before.filter(function (fid) { return !allowed[fid]; });
          snap.fieldIds = after;
          snap.colsKey = after.join('|');
          snap._reconciledAt = Date.now();
          snap._reconciledReason = String(reason || '');
          snap._removedFieldIds = removed.slice();
          writeStoredViewerSnapshot_(snap);
          try { localStorage.removeItem('MOTK_APPDATA_CACHE_V1'); } catch (_) { }
          try {
            if (snap.pageId) {
              var mf = loadColManifest_(snap.pageId);
              if (mf && Array.isArray(mf.fieldIds)) {
                var mfAfter = mf.fieldIds.filter(function (fid2) { return !!allowed[fid2]; });
                if (mfAfter.length !== mf.fieldIds.length) {
                  saveColManifest_(snap.pageId, ent, mfAfter, 'reconcile');
                }
              }
            }
          } catch (_) { }
          try { console.warn('[Table] reconciled stored fieldIds', { entity: ent, removed: removed, reason: reason || '' }); } catch (_) { }
          try { showStatus('Removed invalid fields: ' + removed.length); } catch (_) { }
          return true;
        } catch (_) { }
        return false;
      }

      /* ===== TAKE65: Column Manifest Lock + Last BootPack ===== */
      var LAST_TABLE_BOOTPACK_KEY = 'MOTK_LAST_TABLE_BOOTPACK_V3';
      var COL_MANIFEST_PREFIX = 'MOTK_TABLE_COL_MANIFEST_V3:';

      function _lsGet_(key) { try { return localStorage.getItem(key); } catch (e) { return null; } }
      function _lsSet_(key, val) { try { localStorage.setItem(key, val); return true; } catch (e) { return false; } }
      function _ssSet_(key, val) { try { sessionStorage.setItem(key, val); return true; } catch (e) { return false; } }
      function safeJsonParse_(raw) { try { return JSON.parse(raw); } catch (e) { return null; } }

      function getColManifestKey_(pageId) {
        return COL_MANIFEST_PREFIX + String(pageId || '');
      }

      function loadColManifest_(pageId) {
        var key = getColManifestKey_(pageId);
        var raw = _lsGet_(key);
        if (!raw) return null;
        var o = safeJsonParse_(raw);
        if (!o || !Array.isArray(o.fieldIds) || !o.fieldIds.length) return null;
        return o;
      }

      function saveColManifest_(pageId, entity, fieldIds, source) {
        var key = getColManifestKey_(pageId);
        var o = {
          updatedAt: Date.now(),
          pageId: String(pageId || ''),
          entity: String(entity || ''),
          fieldIds: fieldIds.slice(),
          colsKey: fieldIds.join('|'),
          source: String(source || '')
        };
        _lsSet_(key, JSON.stringify(o));
        return o;
      }

      function getFixedColumnsEnabled_() {
        try {
          if (window.__MOTK_FIXED_COLUMNS_ENABLED__ === false) return false;
        } catch (_) { }
        return true;
      }

      function logFixedColumnsBoot_(enabled, entity, pageId, sourceTag) {
        try {
          if (window.__MOTK_FIXED_COLUMNS_LOGGED__) return;
          window.__MOTK_FIXED_COLUMNS_LOGGED__ = true;
          console.info("[TAKE223][FIXED] enabled=" + enabled + " route=table entity=" + String(entity || "") + " pageId=" + String(pageId || "") + " source=" + String(sourceTag || ""));
        } catch (_) { }
      }

      function ensureFixedColumnsManifest_(pageId, entity, fieldIds, sourceTag) {
        try {
          if (!pageId) return null;
          var mf = loadColManifest_(pageId);
          if (mf && Array.isArray(mf.fieldIds) && mf.fieldIds.length) return mf;
          var ids = Array.isArray(fieldIds) ? fieldIds.slice() : [];
          if (!ids.length && STATE && Array.isArray(STATE.fieldIds) && STATE.fieldIds.length) {
            ids = STATE.fieldIds.slice();
          }
          if (!ids.length) {
            try {
              var snap = readStoredViewerSnapshot_();
              if (snap && Array.isArray(snap.fieldIds) && snap.fieldIds.length) ids = snap.fieldIds.slice();
              else if (snap && snap.colsKey) ids = String(snap.colsKey || '').split('|').filter(Boolean);
            } catch (_) { }
          }
          if (!ids.length) return null;
          return saveColManifest_(pageId, entity, ids, sourceTag || 'init');
        } catch (_) {
          return null;
        }
      }

      function applyColManifestToNormalized_(p, sourceTag) {
        if (!p || !Array.isArray(p.ids) || !p.ids.length) return p;

        var pageId = String((STATE && STATE.pageId) || '');
        var entity = String((STATE && STATE.sheetName) || '');
        if (!pageId) return p;

        var ids = p.ids.slice();
        var minCols = 0;
        try {
          var idFid0 = resolveIdFieldId_();
          if (idFid0) minCols = 1;
        } catch (_) { }
        var isMinimal = (ids.length <= Math.max(1, minCols || 1));
        var fixedEnabled = getFixedColumnsEnabled_();
        logFixedColumnsBoot_(fixedEnabled, entity, pageId, sourceTag || 'init');
        if (fixedEnabled && STATE.__FIXED_COLUMNS__ !== true) STATE.__FIXED_COLUMNS__ = true;
        var mf = loadColManifest_(pageId);
        if (fixedEnabled) {
          var created = ensureFixedColumnsManifest_(pageId, entity, ids, sourceTag || 'init');
          if (created) mf = created;
        }
        try {
          var allowed = buildAllowedFieldIdSetForEntity_(entity);
          if (allowed && mf && Array.isArray(mf.fieldIds)) {
            var mfFiltered = mf.fieldIds.filter(function (fid) { return !!allowed[fid]; });
            if (mfFiltered.length !== mf.fieldIds.length) {
              mf = saveColManifest_(pageId, entity, mfFiltered, sourceTag || 'prune');
            }
          }
        } catch (_) { }

        // First successful payload becomes the manifest (fixed columns)
        if (!mf) {
          if (isMinimal) {
            STATE.__COLS_KEY__ = ids.join('|');
            STATE.__MINIMAL_FIELDS__ = true;
            if (p.meta) {
              p.meta.colsKey = p.meta.colsKey || STATE.__COLS_KEY__;
              p.meta.fieldIdsHash = ids.join('|');
            }
            if (fixedEnabled) STATE.__FIXED_COLUMNS__ = true;
            return p;
          }
          mf = saveColManifest_(pageId, entity, ids, sourceTag || 'init');
          STATE.__FIXED_COLUMNS__ = true;
          STATE.__COLS_KEY__ = mf.colsKey;
          STATE.__MINIMAL_FIELDS__ = false;
          return p;
        }

        var order = Array.isArray(mf.fieldIds) ? mf.fieldIds.slice() : [];
        if (!order.length) return p;

        var inPayload = {};
        for (var i = 0; i < ids.length; i++) inPayload[ids[i]] = true;

        // Keep manifest order for existing cols, append truly-new cols to the tail
        var finalIds = [];
        for (var j = 0; j < order.length; j++) {
          var id = order[j];
          if (inPayload[id]) finalIds.push(id);
        }
        for (var k = 0; k < ids.length; k++) {
          var id2 = ids[k];
          var exists = false;
          for (var m = 0; m < finalIds.length; m++) {
            if (finalIds[m] === id2) { exists = true; break; }
          }
          if (!exists) finalIds.push(id2);
        }

        // If new cols appeared, extend the manifest (order preserved)
        if (finalIds.join('|') !== order.join('|')) {
          mf = saveColManifest_(pageId, entity, finalIds, sourceTag || 'update');
        }

        // Reorder header by ids index alignment
        if (Array.isArray(p.header) && p.header.length) {
          var headerById = {};
          for (var h = 0; h < p.ids.length; h++) {
            headerById[p.ids[h]] = p.header[h];
          }
          var newHeader = [];
          for (var nh = 0; nh < finalIds.length; nh++) newHeader.push(headerById[finalIds[nh]]);
          p.header = newHeader;
        }

        // Reorder columns by id (if present)
        if (Array.isArray(p.columns) && p.columns.length) {
          var colById = {};
          for (var c = 0; c < p.columns.length; c++) {
            var col = p.columns[c];
            if (col && col.id) colById[col.id] = col;
          }
          var newCols = [];
          for (var nc = 0; nc < finalIds.length; nc++) newCols.push(colById[finalIds[nc]]);
          p.columns = newCols;
        }

        if (Array.isArray(p.rows) && p.rows.length && finalIds.join('|') !== ids.join('|')) {
          var idxById = {};
          for (var ri = 0; ri < ids.length; ri++) idxById[ids[ri]] = ri;
          var newRows = [];
          for (var r = 0; r < p.rows.length; r++) {
            var row = p.rows[r] || [];
            var nr = [];
            for (var fi = 0; fi < finalIds.length; fi++) {
              var idx = idxById[finalIds[fi]];
              nr.push(idx != null ? row[idx] : undefined);
            }
            newRows.push(nr);
          }
          p.rows = newRows;
        }

        p.ids = finalIds;
        STATE.__FIXED_COLUMNS__ = true;
        STATE.__COLS_KEY__ = (mf && mf.colsKey) ? mf.colsKey : finalIds.join('|');
        STATE.__MINIMAL_FIELDS__ = false;
        if (p.meta) {
          p.meta.colsKey = p.meta.colsKey || STATE.__COLS_KEY__;
          p.meta.fieldIdsHash = finalIds.join('|');
        }
        return p;
      }

      function recordLastTableBootPack_(sourceTag) {
        try {
          var ids2 = (STATE && Array.isArray(STATE.fieldIds)) ? STATE.fieldIds.slice() : [];
          if (!ids2.length) return;

          var bp = {
            updatedAt: Date.now(),
            pageId: String((STATE && STATE.pageId) || ''),
            entity: String((STATE && STATE.sheetName) || ''),
            fieldIds: ids2,
            colsKey: ids2.join('|'),
            source: String(sourceTag || (STATE && STATE.dataSourceEffective) || (STATE && STATE.dataSource) || '')
          };

          window.__MOTK_LAST_TABLE_BOOTPACK__ = bp;
          _ssSet_(LAST_TABLE_BOOTPACK_KEY, JSON.stringify(bp));
        } catch (e) {}
      }

      function buildBootSnapshot_(reason) {
        try {
          var st = STATE || {};
          var ent = canonEntityKey_(st.sheetName || '', '');
          var proj = getProjectId_() || 'unknown';
          var colsKey = st.__COLS_KEY__ || (Array.isArray(st.fieldIds) ? st.fieldIds.join('|') : '');
          return {
            ts: Date.now(),
            reason: String(reason || ''),
            projectId: proj,
            pageId: String(st.pageId || ''),
            entity: ent,
            sheetName: String(st.sheetName || ''),
            colsKey: String(colsKey || ''),
            navTimings: window.__MOTK_TABLE_NAV_TIMINGS__ || {},
            perfMarks: window.__MOTK_TABLE_PERF_MARKS__ || {},
            perfMeasures: window.__MOTK_TABLE_PERF_MEASURES__ || {},
            perf: window.__MOTK_LAST_TABLE_PERF__ || {}
          };
        } catch (_) {
          return null;
        }
      }

      function persistBootSnapshot_(reason) {
        try {
          var snap = buildBootSnapshot_(reason);
          if (!snap) return;
          window.__MOTK_LAST_TABLE_BOOTSTATE__ = snap;
          _ssSet_('MOTK_LAST_TABLE_BOOTSTATE_V1', JSON.stringify(snap));
          try { _lsSet_('MOTK_LAST_TABLE_BOOTSTATE_V1', JSON.stringify(snap)); } catch (_) { }
          try {
            var key = 'MOTK_LAST_TABLE_BOOTSTATE_V1:' + snap.projectId + ':' + snap.entity + ':' + snap.pageId;
            _lsSet_(key, JSON.stringify(snap));
          } catch (_) { }
        } catch (_) { }
      }

      function recordFooterLabelTrace_(label, stage) {
        try {
          if (!window.opener) return;
          var trace = window.__MOTK_FOOTER_LABEL_TRACE__ || [];
          var entry = {
            ts: Date.now(),
            label: String(label || 'pending'),
            stage: String(stage || 'pending')
          };
          var last = trace.length ? trace[trace.length - 1] : null;
          if (last && last.label === entry.label && last.stage === entry.stage) return;
          trace.push(entry);
          if (trace.length > 50) trace.splice(0, trace.length - 50);
          window.__MOTK_FOOTER_LABEL_TRACE__ = trace;
          try { sessionStorage.setItem('MOTK_FOOTER_LABEL_TRACE_V1', JSON.stringify(trace)); } catch (_) { }
          try { console.info('[MOTK][FooterLabel]', entry); } catch (_) { }
        } catch (_) { }
      }

      function setFinalStatus() {
        var el = document.getElementById('statusLeft'); if (!el) return;
        var srcLabel = getFooterSourceLabel_();
        var src = srcLabel ? (' · ' + srcLabel) : ' · pending';
        var entPlural = pluralEntityFor(_entityForUI());
        var rowsLen = Array.isArray(STATE && STATE.rows) ? STATE.rows.length : 0;
        var syncing = !!(STATE && STATE.isSyncing);

        var total = Number(STATE && STATE.total);
        if (!isFinite(total) || total < 0) total = 0;
        if (total === 0 && rowsLen > 0) total = rowsLen;

        var perAll = (STATE && STATE.perPage === 'all');
        var per = perAll ? total : Number(STATE && STATE.perPage);
        if (!isFinite(per) || per < 1) per = DEFAULT_PER_PAGE;

        var page = Number(STATE && STATE.page);
        if (!isFinite(page) || page < 1) page = 1;

        var start = 0;
        var end = 0;
        if (total > 0) {
          if (perAll) {
            start = 1;
            end = total;
          } else {
            var maxPage = Math.ceil(total / per);
            if (maxPage > 0 && page > maxPage) page = maxPage;
            start = ((page - 1) * per) + 1;
            end = Math.min(total, page * per);
          }
        }

        if (end < start && total > 0) end = start;
        var hasWindow = (total > 0 && start > 0 && end >= start);

        var summaryText = (
          hasWindow
            ? (start + '–' + end + ' of ' + total + ' ' + entPlural)
            : ('0 of 0 ' + entPlural)
        ) + src;
        el.textContent = summaryText;
        var snapExtra = {
          rowsStart: hasWindow ? start : 0,
          rowsEnd: hasWindow ? end : 0
        };
        if (!syncing) snapExtra.statusText = summaryText;
        persistViewerStateSnapshot(snapExtra);
        recordFooterLabelTrace_(srcLabel || 'pending', (STATE && STATE.dataSourceStage) || 'pending');
      }

      function logFooterState_(phase, key, reqId) {
        try {
          var el = document.getElementById('statusLeft');
          var label = el ? String(el.textContent || '') : '';
          console.info("[MOTK][SWR]", phase, {
            key: key || '',
            reqId: reqId || '',
            stage: (STATE && STATE.dataSourceStage) || '',
            syncing: !!(STATE && STATE.isSyncing),
            footer: label || getFooterSourceLabel_()
          });
        } catch (_) { }
      }

      function finalizeSync_(opts) {
        opts = opts || {};
        try {
          STATE.isSyncing = false;
          if (opts.stage) {
            STATE.dataSourceStage = opts.stage;
          } else if (STATE.dataSourceStage === 'syncing') {
            STATE.dataSourceStage = opts.cacheApplied ? 'cache' : 'network';
          }
          setFinalStatus();
          logFooterState_(opts.phase || 'sync_finalize', opts.key, opts.reqId);
        } catch (_) { }
      }

      /* ===== 6. ページング定数・ローカルストレージ ===== */

      var DEFAULT_COL_W = 140;
      var DEFAULT_PER_PAGE = 100;
      var PER_PAGE_ALLOWED = [50, DEFAULT_PER_PAGE, 200, 500];
      var PER_PAGE_ALL = 'all';
      var MAX_FETCH_LIMIT = 5000;
      var MOTK_DEBUG = !!window.MOTK_DEBUG;

      var LSC_CACHE_INDEX_KEY = 'motk:cache:index';
      var LSC_CACHE_PREFIXES = ['motk:rows:', 'motk:cfg:', 'motk:links:'];
      var LSC_CACHE_MAX_ENTRIES = 60;
      var LSC_CACHE_MAX_BYTES = 4 * 1024 * 1024;

      function LSC_readIndex_() {
        try {
          var raw = localStorage.getItem(LSC_CACHE_INDEX_KEY);
          if (!raw) return { items: {} };
          var obj = JSON.parse(raw);
          if (!obj || typeof obj !== 'object') return { items: {} };
          if (!obj.items || typeof obj.items !== 'object') obj.items = {};
          return obj;
        } catch (_) {
          return { items: {} };
        }
      }

      function setLoading(isLoading) {
        try {
          var wrap = document.getElementById('tableWrap');
          if (wrap) {
            if (isLoading) wrap.setAttribute('data-loading', '1');
            else wrap.removeAttribute('data-loading');
          }
          if (document && document.body) {
            if (isLoading) document.body.setAttribute('aria-busy', 'true');
            else document.body.setAttribute('aria-busy', 'false');
          }
          try {
            var t = _perfNow_();
            console.info('[TAKE213][TABLE][OVERLAY_STATE]', { t: t, loading: !!isLoading });
          } catch (_) { }
        } catch (_) { }
      }

      function LSC_writeIndex_(idx) {
        try {
          localStorage.setItem(LSC_CACHE_INDEX_KEY, JSON.stringify(idx));
        } catch (_) { }
      }

      function LSC_matchesPrefix_(key, prefixes) {
        if (!key) return false;
        for (var i = 0; i < prefixes.length; i++) {
          if (key.indexOf(prefixes[i]) === 0) return true;
        }
        return false;
      }

      function LSC_markAccess_(key, size) {
        try {
          if (!key || key.indexOf('motk:') !== 0) return;
          var idx = LSC_readIndex_();
          idx.items[key] = idx.items[key] || {};
          idx.items[key].at = Date.now();
          if (size != null) idx.items[key].size = size;
          LSC_writeIndex_(idx);
          LSC_pruneCache_();
        } catch (_) { }
      }

      function LSC_pruneCache_() {
        try {
          var idx = LSC_readIndex_();
          var keys = Object.keys(idx.items || {});
          var tracked = keys.filter(function (k) { return LSC_matchesPrefix_(k, LSC_CACHE_PREFIXES); });
          if (!tracked.length) return;

          var totalBytes = 0;
          tracked.forEach(function (k) {
            totalBytes += Number(idx.items[k] && idx.items[k].size || 0);
          });

          if (tracked.length <= LSC_CACHE_MAX_ENTRIES && totalBytes <= LSC_CACHE_MAX_BYTES) return;

          tracked.sort(function (a, b) {
            var ta = Number(idx.items[a] && idx.items[a].at || 0);
            var tb = Number(idx.items[b] && idx.items[b].at || 0);
            return ta - tb;
          });

          while ((tracked.length > LSC_CACHE_MAX_ENTRIES) || (totalBytes > LSC_CACHE_MAX_BYTES)) {
            var k = tracked.shift();
            if (!k) break;
            try { localStorage.removeItem(k); } catch (_) { }
            totalBytes -= Number(idx.items[k] && idx.items[k].size || 0);
            delete idx.items[k];
          }
          LSC_writeIndex_(idx);
        } catch (_) { }
      }

      function LSC_get(key, age) {
        try {
          var raw = localStorage.getItem(key); if (!raw) return null;
          var o = JSON.parse(raw); if (!o || o.t == null) return null;
          if (age != null && (Date.now() - o.t) > age) return null;
          LSC_markAccess_(key);
          return o.v;
        } catch (e) { return null; }
      }

      function LSC_set(key, v) {
        try {
          var raw = JSON.stringify({ t: Date.now(), v: v });
          localStorage.setItem(key, raw);
          LSC_markAccess_(key, raw.length);
        } catch (e) { }
      }

      function LSC_getEnvelope(key, age) {
        try {
          var raw = localStorage.getItem(key); if (!raw) return null;
          var o = JSON.parse(raw); if (!o || o.t == null) return null;
          if (age != null && (Date.now() - o.t) > age) return null;
          LSC_markAccess_(key);
          if (o.v && o.v.payload && o.v.meta) {
            return { payload: o.v.payload, meta: o.v.meta || {}, storedAt: o.t };
          }
          return { payload: o.v, meta: {}, storedAt: o.t };
        } catch (e) { return null; }
      }

      function LSC_setEnvelope(key, payload, meta) {
        try {
          var raw = JSON.stringify({ t: Date.now(), v: { payload: payload, meta: meta || {} } });
          localStorage.setItem(key, raw);
          LSC_markAccess_(key, raw.length);
        } catch (e) { }
      }
      function LSC_deleteEnvelope(key) {
        try { localStorage.removeItem(key); } catch (_) { }
      }

      function cacheLog_(level, msg, obj) {
        try {
          var fn = console[level] || console.log;
          fn.call(console, "[MOTK][Cache] " + msg, obj || {});
        } catch (_) { }
      }

      function resolveCacheColsKey_(payload) {
        try {
          if (payload && payload.colsKey) return String(payload.colsKey || '').trim();
          if (Array.isArray(payload && payload.requestedFields)) {
            var cleaned = payload.requestedFields.map(function (v) { return String(v || '').trim(); }).filter(Boolean);
            if (cleaned.length) return cleaned.join('|');
          }
          if (STATE && STATE.__COLS_KEY__) return String(STATE.__COLS_KEY__ || '');
          if (Array.isArray(STATE && STATE.fieldIds) && STATE.fieldIds.length) return STATE.fieldIds.join('|');
        } catch (_) { }
        return '';
      }

      function resolveCacheSchemaHash_(payload) {
        try {
          if (payload && payload.schemaHash) return String(payload.schemaHash || '').trim();
          if (payload && payload.meta && payload.meta.schemaHash) return String(payload.meta.schemaHash || '').trim();
          if (STATE && STATE._schemaHash) return String(STATE._schemaHash || '').trim();
          if (STATE && STATE.__TABLE_FIELDIDS_HASH__) return String(STATE.__TABLE_FIELDIDS_HASH__ || '').trim();
        } catch (_) { }
        return '';
      }

      function extractColsKeyFromCacheKey_(key) {
        try {
          var idx = String(key || '').indexOf(':CK:');
          if (idx < 0) return '';
          return String(key || '').slice(idx + 4).split(':SH:')[0] || '';
        } catch (_) { }
        return '';
      }

      function extractColsKeyFromEnv_(env) {
        try {
          if (!env) return '';
          if (env.meta && env.meta.colsKey) return String(env.meta.colsKey || '');
          if (env.payload && env.payload.meta && env.payload.meta.colsKey) return String(env.payload.meta.colsKey || '');
          if (Array.isArray(env.payload && env.payload.requestedFieldIds)) {
            var rf = env.payload.requestedFieldIds.map(function (v) { return String(v || '').trim(); }).filter(Boolean);
            if (rf.length) return rf.join('|');
          }
          if (Array.isArray(env.payload && env.payload.ids)) {
            var ids = env.payload.ids.map(function (v) { return String(v || '').trim(); }).filter(Boolean);
            if (ids.length) return ids.join('|');
          }
          if (env.cacheKey) return extractColsKeyFromCacheKey_(env.cacheKey);
        } catch (_) { }
        return '';
      }

      function isCacheEnvelopeStructurallyValid_(env) {
        try {
          if (!env || !env.payload) return false;
          var p = env.payload;
          if (!Array.isArray(p.rows)) return false;
          if (!Array.isArray(p.ids)) return false;
          return true;
        } catch (_) { return false; }
      }

      function isCacheWriteEligible_(p, payload) {
        try {
          if (!p || !Array.isArray(p.rows) || !Array.isArray(p.ids) || !p.ids.length) return false;
          var total = Number(p.total);
          if (!isFinite(total) || total < 0) total = p.rows.length;
          var rowsLen = Array.isArray(p.rows) ? p.rows.length : 0;
          var colsKey = (p.meta && p.meta.colsKey) ? String(p.meta.colsKey || '') : (Array.isArray(p.ids) ? p.ids.join('|') : '');
          if (!colsKey) return false;
          var filtersEmpty = !(payload && Array.isArray(payload.filterGroups) && payload.filterGroups.length);
          var sortEmpty = !(payload && Array.isArray(payload.sort) && payload.sort.length);
          if (filtersEmpty && sortEmpty && total === 0 && rowsLen === 0) return false;
          return true;
        } catch (_) { return false; }
      }

      /* ===== 7. ページング計算 & UI バインド ===== */

      function getTotalRows() {
        var total = Number(STATE && STATE.total);
        if (!isFinite(total) || total < 0) total = 0;
        if (total === 0) {
          var len = Array.isArray(STATE && STATE.rows) ? STATE.rows.length : 0;
          if (len > 0) total = len;
        }
        return total;
      }

      function invalidateAndRefetch_(key, reason, opts) {
        try {
          try {
            var rejectReason = String(reason || 'unknown');
            STATE.__LAST_APPLY_REJECT_REASON__ = rejectReason;
            STATE.__LAST_APPLY_REJECT_AT__ = Date.now();
          } catch (_) { }
          if (key && !(opts && opts.preserveCache)) LSC_deleteEnvelope(key);
          STATE.__REFETCH_KEYS__ = STATE.__REFETCH_KEYS__ || {};
          if (key && STATE.__REFETCH_KEYS__[key]) return;
          if (key) STATE.__REFETCH_KEYS__[key] = true;
          setTimeout(function () {
            try { fetchAndRenderPage(STATE && STATE.page ? STATE.page : 1); } catch (_) { }
          }, 0);
          try { console.warn('[Table] incompatible payload, refetch scheduled', { key: key || '(n/a)', reason: reason || '' }); } catch (_) { }
        } catch (_) { }
      }

      function resolvePageWindow() {
        if (STATE && STATE.perPage === PER_PAGE_ALL) {
          var total = getTotalRows();
          return total > 0 ? total : MAX_FETCH_LIMIT;
        }
        var num = Number(STATE && STATE.perPage);
        if (!num || num < 1) num = DEFAULT_PER_PAGE;
        return num;
      }

      function resolveFetchLimit() {
        return (STATE && STATE.perPage === PER_PAGE_ALL)
          ? MAX_FETCH_LIMIT
          : resolvePageWindow();
      }

      function computeTotalPages() {
        if (STATE && STATE.perPage === PER_PAGE_ALL) return 1;
        var per = resolvePageWindow();
        var total = getTotalRows();
        if (total <= 0) return 1;
        return Math.max(1, Math.ceil(total / per));
      }

      function normalizePerPageValue(value) {
        if (value == null) return DEFAULT_PER_PAGE;
        var str = String(value).toLowerCase();
        if (str === PER_PAGE_ALL) return PER_PAGE_ALL;
        var num = parseInt(str, 10);
        return PER_PAGE_ALLOWED.indexOf(num) >= 0 ? num : DEFAULT_PER_PAGE;
      }

      function perPageToString(value) {
        return value === PER_PAGE_ALL ? PER_PAGE_ALL : String(value || DEFAULT_PER_PAGE);
      }

      function updatePagerUI() {
        var perSel = document.getElementById('perPage');
        if (perSel) {
          var desired = perPageToString(STATE.perPage);
          if (perSel.value !== desired) perSel.value = desired;
        }

        var totalPages = computeTotalPages();
        if (STATE.perPage === PER_PAGE_ALL) STATE.page = 1;
        else if (STATE.page > totalPages) STATE.page = totalPages;

        var pageSel = document.getElementById('pageSelect');
        if (pageSel) {
          if (pageSel.options.length !== totalPages) {
            var frag = document.createDocumentFragment();
            for (var i = 1; i <= totalPages; i++) {
              var opt = document.createElement('option');
              opt.value = String(i);
              opt.textContent = 'Page ' + i;
              frag.appendChild(opt);
            }
            pageSel.innerHTML = '';
            pageSel.appendChild(frag);
          }
          pageSel.value = String(STATE.page);
          pageSel.disabled = totalPages <= 1;
        }

        var prevBtn = document.getElementById('prevBtn');
        if (prevBtn) prevBtn.disabled = (STATE.page <= 1);

        var nextBtn = document.getElementById('nextBtn');
        if (nextBtn) nextBtn.disabled =
          (STATE.perPage === PER_PAGE_ALL) ||
          (STATE.page >= totalPages);
      }

      function bindPagerControls() {
        var perSel = document.getElementById('perPage');
        if (perSel) {
          var perClone = perSel.cloneNode(true);
          perSel.parentNode.replaceChild(perClone, perSel);
          perSel = perClone;
          perSel.value = perPageToString(STATE.perPage);
          perSel.addEventListener('change', function () {
            var normalized = normalizePerPageValue(perSel.value);
            if (normalized === STATE.perPage) return;
            STATE.perPage = normalized;
            perSel.value = perPageToString(STATE.perPage);
            STATE.page = 1;
            try { console.info("[MOTK][SWR] pager", "perPage change", "target=1", "perPage=" + STATE.perPage); } catch (_) { }
            fetchAndRenderPage(1);
          });
        }

        var pageSel = document.getElementById('pageSelect');
        if (pageSel) {
          var pageClone = pageSel.cloneNode(true);
          pageSel.parentNode.replaceChild(pageClone, pageSel);
          pageSel = pageClone;
          pageSel.addEventListener('change', function () {
            var target = parseInt(pageSel.value, 10);
            if (!isFinite(target) || target < 1) target = 1;
            try { console.info("[MOTK][SWR] pager", "select", "from=" + STATE.page, "to=" + target); } catch (_) { }
            fetchAndRenderPage(target);
          });
        }

        var prevBtn = document.getElementById('prevBtn');
        if (prevBtn) {
          var prevClone = prevBtn.cloneNode(true);
          prevBtn.parentNode.replaceChild(prevClone, prevBtn);
          prevBtn = prevClone;
          prevBtn.addEventListener('click', function (ev) {
            ev.preventDefault();
            ev.stopPropagation();
            ev.stopImmediatePropagation();
            if (prevBtn.disabled) return;
            var target = Math.max(1, STATE.page - 1);
            if (target === STATE.page) return;
            try { console.info("[MOTK][SWR] pager", "prev", "from=" + STATE.page, "to=" + target); } catch (_) { }
            fetchAndRenderPage(target);
          }, true);
        }

        var nextBtn = document.getElementById('nextBtn');
        if (nextBtn) {
          var nextClone = nextBtn.cloneNode(true);
          nextBtn.parentNode.replaceChild(nextClone, nextBtn);
          nextBtn = nextClone;
          nextBtn.addEventListener('click', function (ev) {
            ev.preventDefault();
            ev.stopPropagation();
            ev.stopImmediatePropagation();
            if (nextBtn.disabled) return;
            var totalPages = computeTotalPages();
            var target = Math.min(totalPages, STATE.page + 1);
            if (target === STATE.page) return;
            try { console.info("[MOTK][SWR] pager", "next", "from=" + STATE.page, "to=" + target); } catch (_) { }
            fetchAndRenderPage(target);
          }, true);
        }
      }

      /* ===== 8. URL 状態（page / perPage / sort） ===== */

      function parseSortParam(s) {
        if (!s) return [];
        return s.split(',')
          .map(function (x) { return x.match(/^([^.]+)\.(asc|desc)$/i); })
          .filter(Boolean)
          .map(function (m) { return ({ id: m[1], dir: m[2].toLowerCase(), on: true }); });
      }

      function serializeSort(l) {
        if (!l || !l.length) return '';
        return l.map(function (it) {
          return it && it.id ? (it.id + '.' + (it.dir === 'desc' ? 'desc' : 'asc')) : '';
        }).filter(Boolean).join(',');
      }

      function readUrlState() {
        var usp = new URLSearchParams(location.search);var pg = parseInt(usp.get('pg') || '1', 10); if (pg > 0) STATE.page = pg;
        var ppParam = usp.get('pp'); if (ppParam) {
          if (String(ppParam).toLowerCase() === PER_PAGE_ALL) { STATE.perPage = PER_PAGE_ALL; }
          else {
            var pp = parseInt(ppParam, 10);
            if (PER_PAGE_ALLOWED.indexOf(pp) >= 0) STATE.perPage = pp;
          }
        }
        var s = usp.get('s') || '';
        STATE.sort = parseSortParam(s);
      }

      function writeUrlState(usp) {
        if (!usp) usp = new URLSearchParams(location.search);

        if (STATE.pageId) usp.set('pid', STATE.pageId);
        else usp.delete('pid');

        if (STATE.page > 1) usp.set('pg', String(STATE.page));
        else usp.delete('pg');

        if (STATE.perPage === PER_PAGE_ALL) usp.set('pp', PER_PAGE_ALL);
        else if (STATE.perPage !== DEFAULT_PER_PAGE) usp.set('pp', String(STATE.perPage));
        else usp.delete('pp');

        var s = serializeSort(STATE.sort.filter(function (x) { return x && x.on !== false; }));
        if (s) usp.set('s', s);
        else usp.delete('s');

        return usp;
      }

      /* ===== 8A. URL utilities (getUrlParam) ===== */

      function getRouteParam_(k) {
        var key = String(k || '').trim();
        if (!key) return '';
        var val = '';
        try {
          val = (new URLSearchParams(location.search).get(key) || '').trim();
        } catch (_) { }
        if (val) return val;
        try {
          var ctx = window.__VIEW_CTX || {};
          if (key === 'e' || key === 'entity') val = (ctx.entity || ctx.sheetName || '').trim();
          else if (key === 'p' || key === 'page') val = (ctx.page || '').trim();
          else if (key === 'pid') val = (ctx.pageId || ctx.pid || '').trim();
        } catch (_) { }
        if (val) return val;
        try {
          var ds = (document.body && document.body.dataset) ? document.body.dataset : {};
          if (key === 'e' || key === 'entity') val = (ds.navEntity || ds.motkEntity || ds.entity || '').trim();
          else if (key === 'p' || key === 'page') val = (ds.navPage || ds.motkPage || ds.page || '').trim();
          else if (key === 'pid') val = (ds.pageId || ds.pid || ds.motkPageId || '').trim();
        } catch (_) { }
        return val || '';
      }

      function getUrlParam(k) {
        try {
          var val = getRouteParam_(k);
          // [DEBUG] Log for troubleshooting
          if (MOTK_DEBUG && val) console.log('[MOTK] getUrlParam found:', k, '=', val);
          return val;
        }
        catch (_) { return ''; }
      }

      /* ===== 8C. linkmaps cache (currently no-op) ===== */

      function loadLinkMapsFromCache() { return null; }
      function saveLinkMapsToCache(_maps) { /* no-op */ }
      function clearLinkMapsCache() { /* no-op */ }
      function mergeLinkMaps(dst, src) { return src || dst || {}; }
      function countMaps(_maps) { return 0; }

      /* ===== 9. Viewer STATE 定義 ===== */

      function mergeFieldMetaFromGlobals_(entity, fid, m) {
        try {
          var ent = singularEntityFor(entity || '').toLowerCase();
          var g = window.FIELD_TYPES && window.FIELD_TYPES[ent] && window.FIELD_TYPES[ent][fid];
          if (!g) return m;

          if (!m.type && g.type) m.type = g.type;

          if (!m.label || m.label === fid) {
            if (g.label) m.label = g.label;
          }

          if (typeof m.editable !== 'boolean' && typeof g.editable === 'boolean') {
            m.editable = g.editable;
          }

          if ((!m.options || !m.options.length) && g.options && g.options.length) {
            m.options = g.options.slice();
          }

          return m;
        } catch (e) {
          return m;
        }
      }

      window.__MOTK_TABLE_CFG_CACHE__ = window.__MOTK_TABLE_CFG_CACHE__ || {};

      function _cfgFieldIdsKey_(fieldIds) {
        return Array.isArray(fieldIds) ? fieldIds.join(',') : '';
      }

      function _cfgCacheKey_(entity, pid, fieldIds, schemaHash) {
        var ent = canonEntityKey_(entity || '', '');
        var fidKey = _cfgFieldIdsKey_(fieldIds);
        var hash = schemaHash ? String(schemaHash) : '';
        return [ent, String(pid || ''), hash, fidKey].join('|');
      }

  function applyData(p) {
    p = p || {};
    var incomingVersion = Number(p.__version || 0);
    var incomingKey = String(p.__queryKey || '');
    var incomingColsKey = '';
    var incomingSchemaHash = '';
    var buildStart = _perfNow_();
    window.STATE = window.STATE || {};
    var state = window.STATE;

    if (state.__TABLE_VERSION__ && incomingVersion && incomingVersion < state.__TABLE_VERSION__) {
      try { console.warn("[MOTK][Table] drop stale payload", { incomingVersion: incomingVersion, current: state.__TABLE_VERSION__, key: incomingKey }); } catch (_) { }
      return false;
    }

    var nextFieldIds = Array.isArray(p.ids)
      ? p.ids.map(function (v) { return String(v || '').trim(); }).filter(Boolean)
      : [];
    var nextHeader = Array.isArray(p.header)
      ? p.header.map(function (v) { return String(v || '').trim(); })
      : [];
    incomingColsKey = (p.meta && p.meta.colsKey) ? String(p.meta.colsKey) : (nextFieldIds.length ? nextFieldIds.join('|') : '');
    incomingSchemaHash = (p.meta && (p.meta.schemaHash || p.meta.schemaSig || p.meta.schemaVersion)) ? String(p.meta.schemaHash || p.meta.schemaSig || p.meta.schemaVersion) : '';
    if (nextFieldIds.length && nextHeader.length && nextFieldIds.length !== nextHeader.length) {
      try { console.warn("[MOTK][Table] drop payload due to ids/header length mismatch", { ids: nextFieldIds.length, header: nextHeader.length }); } catch (_) { }
      invalidateAndRefetch_(incomingKey, 'ids-header-mismatch');
      return false;
    }

    var nextRows = Array.isArray(p.rows) ? p.rows.map(function (r) { return Array.isArray(r) ? r.slice() : []; }) : [];
    var nextColumns = Array.isArray(p.columns) ? p.columns.slice() : [];
    var schemaHash = (p && p.meta && p.meta.schemaHash) ? String(p.meta.schemaHash) : '';
    if (!schemaHash && p && p.meta && (p.meta.schemaSig || p.meta.schemaVersion)) {
      schemaHash = String(p.meta.schemaSig || p.meta.schemaVersion);
    }
    var computedFieldIdsHash = nextFieldIds.join('|');
    var payloadFieldIdsHash = '';
    var requestFieldIdsHash = '';
    var responseFieldIdsHash = '';
    try { payloadFieldIdsHash = (p && p.meta && p.meta.fieldIdsHash) ? String(p.meta.fieldIdsHash) : ''; } catch (_) { payloadFieldIdsHash = ''; }
    try { requestFieldIdsHash = String(p && p.__requestFieldIdsHash || (p.meta && p.meta.__requestFieldIdsHash) || '') || ''; } catch (_) { requestFieldIdsHash = ''; }
    try { responseFieldIdsHash = String(p && p.__responseFieldIdsHash || payloadFieldIdsHash || '') || ''; } catch (_) { responseFieldIdsHash = ''; }
      // [TAKE241] Disable strict fieldIdsHash mismatch drops; accept server payload as-is.
    if (nextFieldIds.length && nextRows.length) {
      var rowLenMismatch = nextRows.some(function (r) { return Array.isArray(r) && r.length < nextFieldIds.length; });
      if (rowLenMismatch) {
        try { console.error("[MOTK][Table] drop payload due to row/fieldIds length mismatch", { ids: nextFieldIds.length, rows: nextRows.length }); } catch (_) { }
        invalidateAndRefetch_(incomingKey, 'row-length-mismatch');
        return false;
      }
    }

        var cfgKey = _cfgCacheKey_(state.sheetName, state.pageId, nextFieldIds, schemaHash);
        var fieldIdsKey = _cfgFieldIdsKey_(nextFieldIds);
        var cachedCfg = cfgKey ? window.__MOTK_TABLE_CFG_CACHE__[cfgKey] : null;
        var nextFieldsMeta = {};
        var nextHeadersByFid = {};

        if (cachedCfg && cachedCfg.fieldIdsKey === fieldIdsKey) {
          nextFieldsMeta = deepCopy(cachedCfg.fieldsMeta || {});
          nextHeadersByFid = copy(cachedCfg.headersByFid || {});
        } else {
          if (nextColumns && nextColumns.length) {
            for (var i = 0; i < nextColumns.length; i++) {
              var c = nextColumns[i] || {};
              var fid = String(c.fid || c.id || c.field_id || c.fieldId || nextFieldIds[i] || '').trim();
              if (!fid) continue;
              var m = {};
              try { Object.assign(m, c); } catch (_) { }
              if (!m.label) m.label = (nextHeader[i] != null) ? String(nextHeader[i]) : fid;
              if (!m.name) m.name = m.label;
              if (m.id == null) m.id = fid;
              if (m.fid == null) m.fid = fid;
              m = mergeFieldMetaFromGlobals_(state.sheetName, fid, m);
              nextFieldsMeta[fid] = m;
              var fixed = mergeFieldMetaFromGlobals_(state.sheetName, fid, { label: m.label || nextHeader[i] || fid });
              nextHeadersByFid[fid] = fixed.label || fid;
            }
          }

          if (nextFieldIds && nextFieldIds.length) {
            for (var j = 0; j < nextFieldIds.length; j++) {
              var fid2 = String(nextFieldIds[j] || '').trim();
              if (!fid2) continue;
              if (!nextFieldsMeta[fid2]) {
                var m2 = { id: fid2, fid: fid2, label: (nextHeader[j] != null) ? String(nextHeader[j]) : fid2 };
                m2 = mergeFieldMetaFromGlobals_(state.sheetName, fid2, m2);
                if (!m2.name) m2.name = m2.label;
                nextFieldsMeta[fid2] = m2;
              }
              if (!nextHeadersByFid[fid2]) {
                var fixed2 = mergeFieldMetaFromGlobals_(state.sheetName, fid2, { label: (nextHeader[j] != null) ? String(nextHeader[j]) : fid2 });
                nextHeadersByFid[fid2] = fixed2.label || fid2;
              }
            }
          }

        if (cfgKey && fieldIdsKey) {
          window.__MOTK_TABLE_CFG_CACHE__[cfgKey] = {
            fieldIdsKey: fieldIdsKey,
            fieldsMeta: deepCopy(nextFieldsMeta),
            headersByFid: copy(nextHeadersByFid)
          };
        }
      }

        try { ensureFieldTypesFromFieldsMeta_(state.sheetName, nextFieldsMeta, 'applyData'); } catch (_) { }

        var idIdx = indexOf(nextFieldIds, resolveIdFieldId_());
        if (idIdx < 0 && nextFieldIds.length) idIdx = 0;
        var nextRowsById = {};
        if (idIdx >= 0 && nextRows.length) {
          for (var ri = 0; ri < nextRows.length; ri++) {
            var row = nextRows[ri];
            var rid = String(row && row[idIdx] || '').trim();
            if (!rid) continue;
            var rec = applyRowIdFields_({}, rid);
            for (var ci = 0; ci < nextFieldIds.length; ci++) {
              rec[nextFieldIds[ci]] = row[ci];
            }
            nextRowsById[rid] = rec;
          }
        }

        try {
          var ent = canonEntityKey_(state.sheetName || '', '');
          var pending = window.__MOTK_PENDING_WRITES__ || {};
          if (idIdx >= 0 && nextRows && nextRows.length) {
            var pendingByRow = {};
            Object.keys(pending).forEach(function (k) {
              var parts = String(k || '').split('|');
              if (parts.length < 3) return;
              if (parts[0] !== ent) return;
              var rid = parts[1], fid = parts[2];
              pendingByRow[rid] = pendingByRow[rid] || [];
              pendingByRow[rid].push({ fid: fid, val: pending[k].value });
            });
            for (var ri2 = 0; ri2 < nextRows.length; ri2++) {
              var row2 = nextRows[ri2];
              var rid2 = String(row2 && row2[idIdx] || '').trim();
              if (!rid2 || !pendingByRow[rid2]) continue;
              for (var pi = 0; pi < pendingByRow[rid2].length; pi++) {
                var entry = pendingByRow[rid2][pi];
                var colIdx = indexOf(nextFieldIds, entry.fid);
                if (colIdx < 0) continue;
                var meta = nextFieldsMeta[entry.fid] || getNormalizedFieldMeta_(state.sheetName, entry.fid);
                var safe = _sanitizeValueForMeta_(meta, entry.val, { rowId: rid2, fid: entry.fid, where: "pendingOverlay" });
                nextRows[ri2][colIdx] = safe;
                nextRowsById[rid2] = nextRowsById[rid2] || applyRowIdFields_({}, rid2);
                nextRowsById[rid2][entry.fid] = safe;
              }
            }
          }
        } catch (_) { }

        try {
          var entBarrier = canonEntityKey_(state.sheetName || '', '');
          var barriers = window.__MOTK_WRITE_BARRIERS__ || {};
          var barrierEntries = [];
          Object.keys(barriers).forEach(function (k) {
            var parts = String(k || '').split('|');
            if (parts.length < 3) return;
            if (parts[0] !== entBarrier) return;
            barrierEntries.push({ row: parts[1], fid: parts[2], val: barriers[k].value });
          });
          if (idIdx >= 0 && nextRows && nextRows.length && barrierEntries.length) {
            for (var ri3 = 0; ri3 < nextRows.length; ri3++) {
              var row3 = nextRows[ri3];
              var rid3 = String(row3 && row3[idIdx] || '').trim();
              if (!rid3) continue;
              for (var bi = 0; bi < barrierEntries.length; bi++) {
                var b = barrierEntries[bi];
                if (b.row !== rid3) continue;
                var colIdxB = indexOf(nextFieldIds, b.fid);
                if (colIdxB < 0) continue;
                var metaB = nextFieldsMeta[b.fid] || getNormalizedFieldMeta_(state.sheetName, b.fid);
                var incoming = nextRows[ri3][colIdxB];
                var safeIncoming = _sanitizeValueForMeta_(metaB, incoming, { rowId: rid3, fid: b.fid, where: "barrierIncoming" });
                var safeBarrier = _sanitizeValueForMeta_(metaB, b.val, { rowId: rid3, fid: b.fid, where: "barrierValue" });
                if (String(safeIncoming) !== String(safeBarrier)) {
                  nextRows[ri3][colIdxB] = safeBarrier;
                  nextRowsById[rid3] = nextRowsById[rid3] || applyRowIdFields_({}, rid3);
                  nextRowsById[rid3][b.fid] = safeBarrier;
                } else {
                  _clearWriteBarrier_(entBarrier, rid3, b.fid);
                }
              }
            }
          }
        } catch (_) { }

        _perfLog_('table_build_columns', buildStart);

        var total = Number(p.total);
        var nextTotal = (isFinite(total) && total >= 0) ? total : nextRows.length;
        var nextVersion = incomingVersion || (state.__TABLE_VERSION__ + 1);

        state.fieldIds = nextFieldIds;
        state.header = nextHeader;
        state.rows = nextRows;
  state.columns = nextColumns;
  state.fieldsMeta = nextFieldsMeta;
  state.headersByFid = nextHeadersByFid;
  state.rowsById = nextRowsById;
  state.__TABLE_FIELDIDS_HASH__ = computedFieldIdsHash;
  state.__COLS_KEY__ = incomingColsKey || computedFieldIdsHash;
  state._schemaHash = schemaHash || incomingSchemaHash || state._schemaHash || computedFieldIdsHash || '';
  state.total = nextTotal;
  state.__TABLE_VERSION__ = nextVersion;
  state.__TABLE_LAST_APPLY__ = state.__TABLE_LAST_APPLY__ || [];
        try {
          var applyEvent = {
            ts: Date.now(),
            version: state.__TABLE_VERSION__,
            queryKey: incomingKey,
            idsCount: state.fieldIds.length,
            rowsCount: state.rows.length,
            schemaHash: schemaHash || '',
            fieldIdsHash: state.__TABLE_FIELDIDS_HASH__ || '',
            source: (p && p.meta && p.meta.dataSource) || (p && p.meta && p.meta.mode) || ''
          };
          state.__TABLE_LAST_APPLY__.push(applyEvent);
          if (state.__TABLE_LAST_APPLY__.length > 10) state.__TABLE_LAST_APPLY__ = state.__TABLE_LAST_APPLY__.slice(-10);
        } catch (_) { }

  if (typeof updatePagerUI === 'function') {
    try { updatePagerUI(); } catch (_) { }
  }
  try { state.__LAST_APPLY_FAILURE__ = ''; } catch (_) { }
  return true;
}

window.applyData = applyData;

      if (window.__MOTK_PENDING_APPLYDATA__) {
        try { window.applyData(window.__MOTK_PENDING_APPLYDATA__); } catch (_) { }
        window.__MOTK_PENDING_APPLYDATA__ = null;
      }

      window.STATE = window.STATE || {};
      var STATE = window.STATE;
      STATE.sheetName = STATE.sheetName || '';
      STATE.pageType = STATE.pageType || 'table';
      STATE.fieldIds = STATE.fieldIds || [];
      STATE.header = STATE.header || [];
      STATE.rows = STATE.rows || [];
      STATE.total = STATE.total || 0;
      STATE.pageList = STATE.pageList || [];
      STATE.pageId = STATE.pageId || '';
      STATE.pageCfgRaw = STATE.pageCfgRaw || null;
      STATE.columns = STATE.columns || [];
      STATE.fieldsMeta = STATE.fieldsMeta || {};
      STATE.headersByFid = STATE.headersByFid || {};
      STATE.widths = STATE.widths || {};
      STATE.hiddenCols = STATE.hiddenCols || {};
      STATE.dirty = !!STATE.dirty;
      STATE.perPage = STATE.perPage || DEFAULT_PER_PAGE;
      STATE.page = STATE.page || 1;
      STATE.sort = STATE.sort || [];
      STATE.filterSets = STATE.filterSets || {};
      STATE.selectedGroups = STATE.selectedGroups || {};
      STATE.groupCombine = STATE.groupCombine || 'all';
      STATE.groupEnabled = (STATE.groupEnabled !== false);
      STATE.dataSource = STATE.dataSource || '';
      STATE.dataSourceEffective = STATE.dataSourceEffective || '';
      STATE.dataSourceStage = STATE.dataSourceStage || '';
      STATE._navEntity = STATE._navEntity || '';
      STATE._dataReady = !!STATE._dataReady;
      STATE._cfgReady = !!STATE._cfgReady;
      STATE._linksReady = !!STATE._linksReady;
      STATE._namesReady = !!STATE._namesReady;
      STATE._didRerenderAfterLinks = !!STATE._didRerenderAfterLinks;
      STATE.isSyncing = !!STATE.isSyncing;
      STATE.__TABLE_VERSION__ = Number(STATE.__TABLE_VERSION__) || 0;
      STATE.__TABLE_EXPECTED_VERSION__ = Number(STATE.__TABLE_EXPECTED_VERSION__) || 0;
      STATE.__TABLE_LAST_APPLY__ = STATE.__TABLE_LAST_APPLY__ || [];
      STATE.lastWriteSuccessTime = Number(STATE.lastWriteSuccessTime) || 0;

      /* ===== 9A. state guard ===== */

      if (!Array.isArray(STATE.group)) STATE.group = [];

      // ===== Take21: Quick search (fix serverSearch undefined) =====

      // Keep a copy of the user’s existing filters when quick-search is active.
      STATE._preQuickSearchFilterGroups = STATE._preQuickSearchFilterGroups || null;
      STATE._quickSearchActive = STATE._quickSearchActive || false;

      function serverSearch(rawQuery) {
        try {
          const q = String(rawQuery || "").trim();

          // First activation: snapshot current filters.
          if (!STATE._quickSearchActive && q) {
            STATE._preQuickSearchFilterGroups = deepClone_(STATE.filterGroups || []);
            STATE._quickSearchActive = true;
          }

          // If cleared: restore snapshot.
          if (!q) {
            if (STATE._quickSearchActive) {
              STATE.filterGroups = deepClone_(STATE._preQuickSearchFilterGroups || []);
              STATE._preQuickSearchFilterGroups = null;
              STATE._quickSearchActive = false;
            }
            return fetchAndRenderPage(1);
          }

          // Build an OR group across sensible fields (id + entity_name + text).
          const searchable = getQuickSearchFieldIds_();

          const rules = searchable.map(fid => ({
            id: fid,
            op: "contains",
            value: q
          }));

          // If we have nothing, fail safe: keep page usable.
          if (!rules.length) {
            return fetchAndRenderPage(1);
          }

          // Replace ONLY the quick-search group; preserve any user filters by building on the snapshot.
          const base = deepClone_(STATE._preQuickSearchFilterGroups || STATE.filterGroups || []);
          const withoutOld = base.filter(g => g && g.__quickSearch !== true);

          const qsGroup = {
            id: "qs_" + Date.now(),
            name: "Quick Search",
            mode: "any",
            rules,
            __quickSearch: true
          };

          STATE.filterGroups = withoutOld.concat([qsGroup]);
          STATE._quickSearchActive = true;

          return fetchAndRenderPage(1);
        } catch (e) {
          console.error("[Table] serverSearch failed", e);
          // Never crash the table for search.
          return fetchAndRenderPage(1);
        }
      }

      function getQuickSearchFieldIds_() {
        // Use normalized field meta (added in Take21 below) so type/label are reliable.
        const ids = [];
        const seen = {};

        (STATE.fieldIds || []).forEach(fid => {
          const m = getNormalizedFieldMeta_(STATE.sheetName || "", fid);
          const t = (m.type || "").toLowerCase();

          // Search these types by default.
          const ok = (t === "id" || t === "entity_name" || t === "text" || t === "select");
          if (!ok) return;

          if (!seen[fid]) {
            ids.push(fid);
            seen[fid] = true;
          }
        });

        // Ensure id/entity_name are included even if hidden.
        const idFid = findFieldIdByType_("id");
        const nameFid = findFieldIdByType_("entity_name");
        [idFid, nameFid].forEach(fid => {
          if (fid && !seen[fid]) {
            ids.unshift(fid);
            seen[fid] = true;
          }
        });

        return ids;
      }

      function findFieldIdByType_(wantType) {
        const wt = String(wantType || "").toLowerCase();
        const all = collectAllFieldMetaForEntity_(STATE.sheetName || "");
        const keys = Object.keys(all);
        for (let i = 0; i < keys.length; i++) {
          const fid = keys[i];
          const t = String(all[fid] && all[fid].type || "").toLowerCase();
          if (t === wt) return fid;
        }
        return null;
      }

      function resolveIdFieldId_() {
        var ent = singularEntityFor(STATE && STATE.sheetName ? STATE.sheetName : "");
        if (window.SchemaResolver && SchemaResolver.getIdFid) {
          var fid = SchemaResolver.getIdFid(ent || STATE.sheetName || "");
          if (fid) return String(fid);
        }
        var idFid = findFieldIdByType_("id");
        if (idFid) return String(idFid);
        return null;
      }

      function resolveRowIdFromRow_(row, ids) {
        if (!row) return "";
        var list = Array.isArray(ids) ? ids : (STATE && STATE.fieldIds) || [];
        var idFid = resolveIdFieldId_();
        var idx = idFid ? indexOf(list, idFid) : -1;
        if (idx < 0) idx = 0;
        var v = row && row[idx];
        return String(v == null ? "" : v).trim();
      }

      function applyRowIdFields_(obj, rowId) {
        if (!obj) obj = {};
        obj.id = rowId;
        obj.ID = rowId;
        var idFid = resolveIdFieldId_();
        if (idFid) obj[idFid] = rowId;
        return obj;
      }

      function deepClone_(obj) {
        try { return JSON.parse(JSON.stringify(obj)); } catch (_) { return obj; }
      }

      // ===== Take21: Robust FieldMeta normalization for CommonRenderer parity =====

      function getNormalizedFieldMeta_(entitySingular, fid) {
        const entityRaw = String(entitySingular || STATE.sheetName || "").trim();
        const entity = entityRaw ? singularEntityFor(entityRaw) : "";
        const fieldId = String(fid || "").trim();

        // 1) Prefer Table column meta (visible columns).
        const fromColumns = (STATE.fieldsMeta && STATE.fieldsMeta[fieldId]) ? STATE.fieldsMeta[fieldId] : null;

        // 2) Prefer global FIELD_TYPES map if present (DebugPanel shows it exists).
        const fromGlobal = (window.FIELD_TYPES && window.FIELD_TYPES[entity] && window.FIELD_TYPES[entity][fieldId])
          ? window.FIELD_TYPES[entity][fieldId]
          : null;

        // 3) Prefer FieldsAPI if it exposes a meta getter (safe-checked).
        let fromApi = null;
        if (window.FieldsAPI && typeof window.FieldsAPI.getFieldMeta === "function") {
          try { fromApi = window.FieldsAPI.getFieldMeta(entity, fieldId); } catch (_) { fromApi = null; }
        }

        const base = Object.assign({}, fromColumns || {}, fromApi || {}, fromGlobal || {});

        // Normalize key variants.
        const label = base.label || base.name || base.field_name || base.fieldName || base.header || "";
        const type = base.type || base.fieldType || base.field_type || "";

        const out = Object.assign({}, base, {
          id: fieldId,
          fid: fieldId,
          label,
          name: base.name || label,
          field_name: base.field_name || label,
          type
        });

        // If still missing label, fall back to the column header label if available.
        if (!out.label && Array.isArray(STATE.columns)) {
          const col = STATE.columns.find(c => (c && (c.fieldId === fieldId || c.id === fieldId)));
          if (col) {
            out.label = col.label || col.name || col.fieldName || out.label;
            out.name = out.name || out.label;
            out.field_name = out.field_name || out.label;
            out.type = out.type || col.type || col.fieldType || col.field_type || out.type;
          }
        }

        // If column meta exists but is incomplete, fill critical bits from global/api meta.
        const fb = fromGlobal || fromApi || null;
        if (fb) {
          try {
            if (!out.type) out.type = fb.type || fb.fieldType || fb.field_type || out.type;
            if (!out.label) out.label = fb.label || fb.name || fb.field_name || fb.fieldName || out.label;
            if (!out.name) out.name = fb.name || out.label || out.name;
            if (!out.field_name) out.field_name = fb.field_name || out.label || out.field_name;
            if ((String(out.type || "").toLowerCase() === "select") && (!out.options || !Array.isArray(out.options) || out.options.length === 0)) {
              if (Array.isArray(fb.options) && fb.options.length) out.options = fb.options.slice();
            }
          } catch (_) { }
        }

        // --- fill missing flags from fallback meta (FieldsAPI / FIELD_TYPES) ---
        function normalizeBoolClient_(v) {
          if (v === true) return true;
          if (v === false) return false;
          if (v === null || v === undefined) return false;
          var s = String(v).trim().toLowerCase();
          return (s === "true" || s === "1" || s === "yes" || s === "y" || s === "on" || s === "ok" || s === "checked" || s === "✓");
        }

        // Prefer src flags, but if missing, inherit from fb
        if (out.editable === undefined || out.editable === null || out.editable === "") {
          if (fb && fb.editable !== undefined) out.editable = fb.editable;
        }
        if (out.required === undefined || out.required === null || out.required === "") {
          if (fb && fb.required !== undefined) out.required = fb.required;
        }

        // Normalize to strict booleans
        out.editable = normalizeBoolClient_(out.editable);
        out.required = normalizeBoolClient_(out.required);

        return out;
      }

      function collectAllFieldMetaForEntity_(entitySingular) {
        const entity = String(entitySingular || STATE.sheetName || "").trim();
        const merged = {};

        // Merge: global map is usually the most complete.
        if (window.FIELD_TYPES && window.FIELD_TYPES[entity]) {
          Object.assign(merged, window.FIELD_TYPES[entity]);
        }

        // Merge visible columns meta.
        if (STATE.fieldsMeta) {
          Object.keys(STATE.fieldsMeta).forEach(fid => {
            merged[fid] = merged[fid] || STATE.fieldsMeta[fid];
          });
        }

        return merged;
      }

      function ensureFieldTypesFromFieldsMeta_(entityKey, fieldsMeta, reason) {
        try {
          var ent = canonEntityKey_(entityKey || STATE.sheetName || '', '');
          if (!ent) return false;
          var existing = window.FIELD_TYPES && window.FIELD_TYPES[ent] ? window.FIELD_TYPES[ent] : null;
          if (existing && Object.keys(existing).length) return false;
          if (!fieldsMeta || typeof fieldsMeta !== 'object') return false;
          var fids = Object.keys(fieldsMeta);
          if (!fids.length) return false;
          var map = {};
          for (var i = 0; i < fids.length; i++) {
            var fid = fids[i];
            var m = fieldsMeta[fid] || {};
            var t = String(m.type || m.field_type || '').trim().toLowerCase();
            if (!t) continue;
            map[fid] = {
              label: String(m.label || m.name || m.field_name || fid),
              field_name: String(m.field_name || m.name || m.label || ''),
              column_name: String(m.column_name || ''),
              type: t,
              editable: m.editable,
              required: m.required,
              options: m.options,
              isCore: m.isCore,
              uiSection: String(m.uiSection || ''),
              order: (m.order != null ? m.order : ''),
              isLink: m.isLink,
              entity: ent
            };
          }
          if (!Object.keys(map).length) return false;
          window.FIELD_TYPES = window.FIELD_TYPES || {};
          window.FIELD_TYPES[ent] = Object.assign({}, map, window.FIELD_TYPES[ent] || {});
          if (!window.__MOTK_FIELD_TYPES_SOURCE__) window.__MOTK_FIELD_TYPES_SOURCE__ = 'columns:fallback';
          try { console.warn('[Table] derived FIELD_TYPES from columns meta', { entity: ent, count: Object.keys(map).length, reason: reason || '' }); } catch (_) { }
          return true;
        } catch (_) {
          return false;
        }
      }

      function maybeRender() {
        try {
          var okData = !!(STATE && STATE._dataReady);
          var okCfg = !!(STATE && (STATE._cfgReady || STATE.__BOOT_CACHE_RENDERED__));
          console.info('[TAKE213][TABLE][MAYBE_RENDER]', { t: _perfNow_(), dataReady: okData, cfgReady: okCfg, pageId: (STATE && STATE.pageId) || '', fieldIdsCount: (STATE && Array.isArray(STATE.fieldIds)) ? STATE.fieldIds.length : 0 });
          if (!(okData && okCfg)) return;
        } catch (_) { return; }
        if (typeof showStatus === 'function') showStatus('applying page…');
        raf(function () {
          try {
            renderCurrentPage(true);
            console.info('[TAKE213][TABLE][RENDER_OK]', { t: _perfNow_(), rows: (STATE && Array.isArray(STATE.rows)) ? STATE.rows.length : 0 });
          } catch (e) {
            console.error('[TAKE213][TABLE][RENDER_ERR]', e && e.stack ? e.stack : e);
            try { setTableBanner_('error', 'Render error: ' + String(e && (e.message || e) || 'unknown')); } catch (_) { }
          }
        });
      }

      function ensureFilterGroupDefaults() {
        if (!Array.isArray(STATE.filterGroups) || STATE.filterGroups.length === 0) {
          STATE.filterGroups = [{
            id: rid(),
            name: 'Group 1',
            mode: 'any',
            rules: []
          }];
        }
        var first = STATE.filterGroups[0];
        if (first && (!Array.isArray(first.rules) || first.rules.length === 0)) {
          first.rules = [];
        }
      }

      function rememberLastView() {
        try {
          if (!STATE) return;
          var ent = canonEntityKey_(STATE.sheetName || '', '');
          LSC_set('motk:lastView', {
            sheet: ent,
            pid: STATE.pageId || '',
            perPage: STATE.perPage || ''
          });
          if (ent && STATE.pageId) {
            LSC_set('motk:lastPidByEntity:' + ent, { pid: STATE.pageId, ts: Date.now() });
          }
        } catch (_) { }
      }

      function defaultPidForEntity_(entity) {
        return '';
      }


      /* ===== 10. Link マップ（LINK_MAPS） & 名前抽出 ===== */

      window.LINK_MAPS = window.LINK_MAPS || { assets: {}, shots: {}, tasks: {}, users: {}, members: {} };
      function _normalizeFieldName_(name) {
        if (window.SchemaResolver && SchemaResolver.normalizeFieldName) {
          return SchemaResolver.normalizeFieldName(name);
        }
        return String(name || "").toLowerCase().replace(/\s+/g, " ").trim();
      }

      function _linkEntityFromFieldMeta_(meta, rawVal) {
        var name = _normalizeFieldName_(meta && (meta.field_name || meta.name || meta.label));
        var target = '';
        if (name && name.indexOf('link') >= 0) {
          if (name.indexOf('asset') >= 0) target = 'asset';
          else if (name.indexOf('task') >= 0) target = 'task';
          else if (name.indexOf('member') >= 0) target = 'member';
          else if (name.indexOf('user') >= 0) target = 'user';
          else if (name.indexOf('shot') >= 0) target = 'shot';
        }
        if (!target && rawVal) {
          var v = String(rawVal || '').trim();
          if (/^as[_-]/i.test(v)) target = 'asset';
          else if (/^(tk|ta)[_-]/i.test(v)) target = 'task';
          else if (/^pm[_-]/i.test(v)) target = 'member';
          else if (/^us[_-]/i.test(v)) target = 'user';
          else if (/^sh[_-]/i.test(v)) target = 'shot';
        }
        return target;
      }

      function _idxOf(a, v) {
        if (!Array.isArray(a)) return -1;
        for (var i = 0; i < a.length; i++) { if (a[i] === v) return i; }
        return -1;
      }

      function prefetchEntityMap(entity, pickNameFn, bucketKey) {
        if (!hasGoogle()) return;
        var key = 'map:' + entity; if (prefetchEntityMap[key]) return; prefetchEntityMap[key] = true;
        google.script.run.withSuccessHandler(function (res) {
          try {
            var ids = (res && Array.isArray(res.ids)) ? res.ids
              : (Array.isArray(res) && Array.isArray(res[0]) ? res[0] : []);
            var header = (res && Array.isArray(res.header)) ? res.header
              : (Array.isArray(res) && Array.isArray(res[1]) ? res[1] : []);
            var rows = (res && Array.isArray(res.rows)) ? res.rows
              : (Array.isArray(res) ? res.slice(2) : []);
            var map = {};
            for (var r = 0; r < rows.length; r++) {
              var row = rows[r] || [];
              var id = String(row[0] || '').trim(); if (!id) continue;
              var name = pickNameFn(ids, header, row) || id;
              map[id] = name;
            }
            LINK_MAPS[bucketKey] = Object.assign(LINK_MAPS[bucketKey] || {}, map);
          } catch (e) { }
        }).withFailureHandler(function () {/* ignore */ })
          .listRowsPage({ entity: entity, offset: 0, limit: 50000 });
      }

      function pickAssetName(ids, header, row) {
        var i = header.findIndex(function (h) { return String(h).toLowerCase().includes('asset name'); });
        if (i < 0) i = 1;
        return String(row[i] || '').trim();
      }

      function pickShotCode(ids, header, row) {
        var i = header.findIndex(function (h) { return /^(shot ?code|code)$/i.test(String(h)); });
        if (i < 0) i = 1;
        return String(row[i] || '').trim();
      }

      function pickTaskName(ids, header, row) {
        var i = header.findIndex(function (h) { return /task.*name/i.test(String(h)); });
        if (i < 0) i = 1;
        return String(row[i] || '').trim();
      }

      function pickUserName(ids, header, row) {
        var i = header.findIndex(function (h) { return /^(name|user name)$/i.test(String(h)); });
        if (i < 0) i = 1;
        return String(row[i] || '').trim();
      }

      function pickMemberName(ids, header, row) {
        var i = -1;
        try {
          if (window.SchemaResolver && SchemaResolver.getFidByFieldName) {
            var fid = SchemaResolver.getFidByFieldName('member', 'Role');
            i = _idxOf(ids, fid);
          }
        } catch (_) { i = -1; }
        if (i < 0) {
          i = header.findIndex(function (h) { return /^role$/i.test(String(h)); });
        }
        if (i < 0) i = 1;
        return String(row[i] || '').trim();
      }

      /* ===== 11. Proxy index（ShotView/AssetView 用） ===== */

      var PROXY_CACHE = (window.PROXY_CACHE = (window.PROXY_CACHE || {}));
      var PROXY_CACHE_BY_FIELD = (window.PROXY_CACHE_BY_FIELD = (window.PROXY_CACHE_BY_FIELD || {}));
      var PROXY_PREFETCH_KEY = '';
      var PROXY_PREFETCH_SCHEDULED = false;

      function scheduleProxyIndexPrefetch_(reason) {
        try {
          if (!hasProxyPreviewCols_()) return;
          var key = String((STATE && STATE.pageId) || '') + '|' + String(_entityForUI() || '');
          if (PROXY_PREFETCH_KEY === key && PROXY_PREFETCH_SCHEDULED) return;
          PROXY_PREFETCH_KEY = key;
          PROXY_PREFETCH_SCHEDULED = true;

          var tries = 0;
          function attempt() {
            tries++;
            if (!STATE.__TABLE_FIRST_PAINT_DONE__ && tries < 15) {
              setTimeout(attempt, 200);
              return;
            }
            if (!STATE.__TABLE_FIRST_PAINT_DONE__) {
              PROXY_PREFETCH_SCHEDULED = false;
              return;
            }
            var idle = window.requestIdleCallback;
            var run = function () {
              PROXY_PREFETCH_SCHEDULED = false;
              var ent = _entityForUI();
              var ids = collectCurrentPageRecordIds_(ent, 150);
              if (prefetchProxyIndex) prefetchProxyIndex(ent, ids);
            };
            if (typeof idle === 'function') idle(run, { timeout: 1200 });
            else setTimeout(run, 0);
          }
          setTimeout(attempt, 200);
        } catch (_) {
          PROXY_PREFETCH_SCHEDULED = false;
        }
      }

      function collectCurrentPageRecordIds_(entitySingular, maxN) {
        try {
          var idFid = resolveIdFieldId_();
          if (!idFid || !Array.isArray(STATE.fieldIds) || !Array.isArray(STATE.rows)) return [];
          var idx = indexOf(STATE.fieldIds, idFid);
          if (idx < 0) return [];
          var n = Math.min(STATE.rows.length, (maxN || 150));
          var out = [];
          for (var i = 0; i < n; i++) {
            var row = STATE.rows[i];
            var v = row ? row[idx] : null;
            if (v) out.push(String(v));
          }
          return out;
        } catch (e) {
          return [];
        }
      }

      function prefetchProxyIndex(entitySingular, recordIds) {
        if (!hasGoogle()) return;
        var ent = canonEntityKey_(entitySingular || _entityForUI(), _entityForUI());
        var t0 = _perfNow_();

        function pickLatestMap_(idx) {
          try {
            if (!idx || typeof idx !== 'object') return { name: '', map: {} };
            var keys = ['latestByShotId', 'latestById', 'latestByRecordId', 'latestByEntityId', 'latest', 'byId', 'byShotId', 'byRecordId'];
            for (var i = 0; i < keys.length; i++) {
              var k = keys[i];
              var v = idx[k];
              if (v && typeof v === 'object' && !Array.isArray(v)) return { name: k, map: v };
            }
            for (var k2 in idx) {
              if (k2 === 'items') continue;
              var v2 = idx[k2];
              if (v2 && typeof v2 === 'object' && !Array.isArray(v2)) return { name: k2, map: v2 };
            }
          } catch (_) { }
          return { name: '', map: {} };
        }

        function applyProxyIndex_(idx, modeLabel) {
          try {
            try {
              var dt = _perfNow_() - t0;
              var mode = modeLabel || (idx && idx.diag && (idx.diag.hit || idx.diag.source || idx.diag.mode)) || 'cache_miss';
              var count = (idx && Array.isArray(idx.items)) ? idx.items.length : (idx && idx.byRecord ? Object.keys(idx.byRecord).length : 'n/a');
              console.log("[MOTK][ProxyIndex] mode=" + mode, "ms=" + Math.round(dt), "count=" + count, "updatedAt=" + String(idx && idx.updatedAt || ''));
            } catch (_) { }
            try {
              var br0 = idx && idx.byRecord && typeof idx.byRecord === "object" ? idx.byRecord : null;
              var bf0 = idx && idx.byRecordField && typeof idx.byRecordField === "object" ? idx.byRecordField : null;
              if (br0 || bf0) {
                try { for (var kk1 in PROXY_CACHE) { delete PROXY_CACHE[kk1]; } } catch (_) { }
                try { for (var kk2 in PROXY_CACHE_BY_FIELD) { delete PROXY_CACHE_BY_FIELD[kk2]; } } catch (_) { }
                if (br0) {
                  for (var r0 in br0) PROXY_CACHE[String(r0).trim()] = br0[r0];
                }
                if (bf0) {
                  for (var rf0 in bf0) PROXY_CACHE_BY_FIELD[String(rf0).trim()] = bf0[rf0];
                }
              }
            } catch (_) { }

            // Prefer strict parsing from idx.items when available.
            try {
              if (idx && Array.isArray(idx.items) && typeof window.__MOTK_BUILD_PROXY_INDEX__ === "function") {
                var built = window.__MOTK_BUILD_PROXY_INDEX__(idx.items);
                if (built && typeof built === "object") {
                  try { for (var kk1 in PROXY_CACHE) { delete PROXY_CACHE[kk1]; } } catch (_) { }
                  try { for (var kk2 in PROXY_CACHE_BY_FIELD) { delete PROXY_CACHE_BY_FIELD[kk2]; } } catch (_) { }

                  var br = built.byRecord || {};
                  var bf = built.byRecordField || {};

                  for (var kbr in br) PROXY_CACHE[String(kbr).trim()] = br[kbr];
                  for (var kbf in bf) PROXY_CACHE_BY_FIELD[String(kbf).trim()] = bf[kbf];
                }
              }
            } catch (_) { }

            var picked = pickLatestMap_(idx);
            var latest = picked.map || {};
            // Fallback to legacy maps only when strict parsing produced no keys.
            if (!Object.keys(PROXY_CACHE || {}).length && !Object.keys(PROXY_CACHE_BY_FIELD || {}).length) {
            for (var k in latest) {
              var v = latest[k] || null;
              try {
                if (v && typeof v === "object") {
                  if (!v.url && v.id) v.url = "https://drive.google.com/uc?export=download&id=" + encodeURIComponent(String(v.id));
                }
              } catch (_) { }
              PROXY_CACHE[String(k).trim()] = v;
            }
            }
            try {
              if (Array.isArray(recordIds) && recordIds.length) {
                var hasMatch = false;
                for (var ri = 0; ri < recordIds.length; ri++) {
                  var rid = String(recordIds[ri] || '').trim();
                  if (!rid) continue;
                  if (PROXY_CACHE[rid]) { hasMatch = true; break; }
                  if (!hasMatch && window.PROXY_CACHE_BY_FIELD) {
                    var prefix = rid + "|";
                    for (var kf in window.PROXY_CACHE_BY_FIELD) {
                      if (kf.indexOf(prefix) === 0) { hasMatch = true; break; }
                    }
                  }
                  if (hasMatch) break;
                }
                if (!hasMatch) {
                  console.warn("[MOTK][ProxyIndex] no matches for current rows", {
                    entity: ent || _entityForUI(),
                    count: recordIds.length,
                    sampleId: recordIds[0] || ""
                  });
                }
              }
            } catch (_) { }
            var wrap = document.getElementById('tableWrap');
            if (wrap) {
              try {
                var ev = new Event('scroll'); wrap.dispatchEvent(ev);
              } catch (e) {
                var ev2 = document.createEvent('Event'); ev2.initEvent('scroll', true, true); wrap.dispatchEvent(ev2);
              }
              try { wrap.dispatchEvent(new Event('proxies:ready')); } catch (_) { }
            }
            markNavPerf_('thumbs_ready_ms', _perfNow_());
            markNavPerf_('shotview_ready_ms', _perfNow_());
            emitNavPerfSnapshot_('thumbnails_ready', false);
            try { if (typeof window.__MOTK_PROXY_PREVIEW_REFRESH__ === "function") window.__MOTK_PROXY_PREVIEW_REFRESH__(); } catch (_) { }
            try { if (window.CommonRenderer && typeof CommonRenderer.refreshPendingPreviews === "function") CommonRenderer.refreshPendingPreviews(document); } catch (_) { }
            if (window.__MOTK_DEBUG__ === true) {
              try {
                var ks = Object.keys(PROXY_CACHE || {});
                var samples = ks.slice(0, 5);
                console.log('[ProxyIndex]', 'count=' + ks.length, 'sample=' + samples.join(', '));
              } catch (_) { }
            }
          } catch (e) { }
        }

        callFirst(['sv_getProxyIndexLatest', 'sv_getProxyIndexCache_v1'], {
            entity: pluralEntityFor(ent || _entityForUI()),
            recordIds: Array.isArray(recordIds) ? recordIds : []
          },
          function (idx) {
            try {
              var hasIndex = false;
              try {
                if (idx && idx.latestByShotId && Object.keys(idx.latestByShotId).length) hasIndex = true;
                if (idx && idx.byRecord && Object.keys(idx.byRecord).length) hasIndex = true;
                if (idx && idx.byRecordField && Object.keys(idx.byRecordField).length) hasIndex = true;
                if (idx && idx.items && idx.items.length) hasIndex = true;
              } catch (_) { }
              if (!hasIndex && window.__MOTK_FORCE_PROXY_SCAN__ !== true) {
                console.warn("[MOTK][ProxyIndex] mode=cache_miss reason=no_persisted_index");
                return;
              }
              if (!hasIndex && window.__MOTK_FORCE_PROXY_SCAN__ === true) {
                callFirst(['sv_indexAllProxies'], { entity: pluralEntityFor(ent || _entityForUI()) }, function (res) {
                  applyProxyIndex_(res || {}, "manual_drive_scan");
                }, function () { });
                return;
              }
              var modeLabel = (idx && idx.diag && (idx.diag.mode || idx.diag.hit)) || "cacheService";
              applyProxyIndex_(idx || {}, modeLabel);
            } catch (e) { }
          },
          function () { }
        );
      }

      /* ===== 12. GAS 呼び出しヘルパ（callFirst） ===== */

      function callFirst(names, params, onOk, onFail, opts) {
        onOk = onOk || function () { }; onFail = onFail || function () { };
        opts = opts || {};
        var timeoutMs = (opts && isFinite(opts.timeoutMs)) ? Number(opts.timeoutMs) : 20000;
        if (!hasGoogle()) { onFail(new Error("google script unavailable")); return; }
        var trace = { startedAt: Date.now(), attempts: [] };
        var lastErr = null;
        function persistTrace_() {
          try {
            window.__MOTK_LAST_CALLFIRST_TRACE_V1 = trace;
            var raw = JSON.stringify(trace);
            try { sessionStorage.setItem('MOTK_LAST_CALLFIRST_TRACE_V1', raw); } catch (_) { }
            try {
              window.__CALL_FIRST_TRACE__ = window.__CALL_FIRST_TRACE__ || [];
              window.__CALL_FIRST_TRACE__.push(trace);
              if (window.__CALL_FIRST_TRACE__.length > 20) {
                window.__CALL_FIRST_TRACE__ = window.__CALL_FIRST_TRACE__.slice(-20);
              }
              sessionStorage.setItem('MOTK_CALLFIRST_TRACE_BUF_V1', JSON.stringify(window.__CALL_FIRST_TRACE__));
            } catch (_) { }
          } catch (_) { }
        }
        var i = 0; (function next(err) {
          if (err) lastErr = err;
          if (i >= names.length) {
            trace.ok = false;
            trace.errorMessage = String(lastErr && (lastErr.message || lastErr));
            trace.finishedAt = Date.now();
            persistTrace_();
            onFail(lastErr);
            return;
          }
          var fnName = names[i++]; if (typeof google.script.run[fnName] !== 'function') { next(); return; }
          var attempt = { fnName: fnName, tStart: _perfNow_(), timeoutMs: timeoutMs };
          trace.attempts.push(attempt);
          var timer = null;
          function finishAttempt_() {
            if (attempt.done) return false;
            attempt.done = true;
            if (timer) clearTimeout(timer);
            return true;
          }
          if (timeoutMs > 0) {
            timer = setTimeout(function () {
              if (!finishAttempt_()) return;
              attempt.ok = false;
              attempt.timeout = true;
              attempt.ms = Math.round(_perfNow_() - attempt.tStart);
              attempt.errorMessage = 'timeout';
              persistTrace_();
              next(new Error('timeout'));
            }, timeoutMs);
          }
          try {
            try { console.info('[TAKE213][RPC][CALL]', { name: fnName, t: attempt.tStart }); } catch (_) { }
            google.script.run
              .withSuccessHandler(function (res) {
                if (!finishAttempt_()) return;
                attempt.ok = true;
                attempt.ms = Math.round(_perfNow_() - attempt.tStart);
                try { console.info('[TAKE213][RPC][CB]', { name: fnName, dt: attempt.ms, ok: true }); } catch (_) { }
                trace.ok = true;
                trace.fnUsed = fnName;
                trace.finishedAt = Date.now();
                persistTrace_();
                try {
                  if (res && typeof res === "object") res.__fnUsed__ = fnName;
                } catch (e) {}
                onOk(res);
              })
              .withFailureHandler(function (err) {
                if (!finishAttempt_()) return;
                attempt.ok = false;
                attempt.ms = Math.round(_perfNow_() - attempt.tStart);
                attempt.errorMessage = String(err && (err.message || err));
                try { console.info('[TAKE213][RPC][CB]', { name: fnName, dt: attempt.ms, ok: false }); } catch (_) { }
                persistTrace_();
                next(err);
              })[fnName](params || {});
          } catch (e) {
            if (!finishAttempt_()) return;
            attempt.ok = false;
            attempt.ms = Math.round(_perfNow_() - attempt.tStart);
            attempt.errorMessage = String(e && (e.message || e));
            try { console.info('[TAKE213][RPC][CB]', { name: fnName, dt: attempt.ms, ok: false, error: attempt.errorMessage }); } catch (_) { }
            persistTrace_();
            next(e);
          }
        })();
      }

      /* ===== 13. データソース判定 & 正規化（normalizeRowsPayload） ===== */

      function normalizeRowsPayload(res, entitySingular) {
        var ent = singularEntityFor(
          entitySingular ||
          (res && (res.sheetName || res.entity || res.entityName)) ||
          (STATE && STATE.sheetName) ||
          _entityForUI() ||
          ''
        );
        var needsMetaRetry = false;
        function normalizeMeta_(src) {
          var meta = (src && src.meta && typeof src.meta === 'object') ? copy(src.meta) : {};
          if (src && src.schemaHash && !meta.schemaHash) meta.schemaHash = src.schemaHash;
          if (src && src.schemaUpdatedAt && !meta.schemaUpdatedAt) meta.schemaUpdatedAt = src.schemaUpdatedAt;
          return meta;
        }
        function getFieldTypeMeta_(fid) {
          try {
            return (window.FIELD_TYPES && window.FIELD_TYPES[ent] && window.FIELD_TYPES[ent][fid]) ? window.FIELD_TYPES[ent][fid] : null;
          } catch (_) { return null; }
        }
        function normalizeColumn_(src, fid, label) {
          var base = getFieldTypeMeta_(fid) || {};
          var type = src.type || src.fieldType || base.type || '';
          if (!type) {
            needsMetaRetry = true;
            type = 'text';
          }
          return {
            id: fid,
            fieldId: fid,
            label: label || base.label || fid,
            type: type,
            editable: (src.editable !== undefined) ? src.editable : (base.editable !== undefined ? base.editable : undefined),
            required: (src.required !== undefined) ? src.required : (base.required !== undefined ? base.required : undefined),
            options: Array.isArray(src.options) ? src.options.slice() : (Array.isArray(base.options) ? base.options.slice() : []),
            entity: ent
          };
        }
        if (res && typeof res === 'object' && !Array.isArray(res)) {
          if (Array.isArray(res.columns) && res.columns.length) {
            var ids = res.columns.map(function (c) {
              return String(c && (c.fid || c.fieldId || c.id || c.fi || c.name) || '');
            });
            var header = res.columns.map(function (c, i) {
              var fid = ids[i];
              var label = String(c && (c.label || c.title || c.name || c.fid || c.fieldId || c.id) || '');
              if (!label) {
                var base = getFieldTypeMeta_(fid);
                label = base && (base.label || base.name) ? String(base.label || base.name) : '';
              }
              return label || fid;
            });
            var rawRows = Array.isArray(res.rows) ? res.rows
              : (Array.isArray(res.data) ? res.data : []);
            var rows = rawRows.map(function (r) {
              if (Array.isArray(r)) return r;
              if (r && typeof r === 'object') {
                return ids.map(function (fid) { return r[fid]; });
              }
              return [];
            });
            var total = Number(
              (res.total != null ? res.total :
                res.count != null ? res.count :
                  res.meta && res.meta.total != null ? res.meta.total :
                    res.meta && res.meta.totalRows != null ? res.meta.totalRows :
                      rows.length)
            );
            if (!isFinite(total) || total < 0) total = rows.length;
            var cols = res.columns.map(function (c, i) {
              var fid = ids[i];
              return normalizeColumn_(c || {}, fid, header[i]);
            });
            var meta = normalizeMeta_(res);
            return { ids: ids, header: header, rows: rows, total: total, columns: cols, meta: meta, needsMetaRetry: needsMetaRetry };
          }
          var ids2 = Array.isArray(res.ids) ? res.ids : [];
          var head2 = Array.isArray(res.header) ? res.header : [];
          var rows2 = Array.isArray(res.rows) ? res.rows : [];
          var total2 = Number(
            (res.totalRows != null ? res.totalRows :
              res.total != null ? res.total :
                res.count != null ? res.count :
                  res.meta && res.meta.totalRows != null ? res.meta.totalRows :
                    res.meta && res.meta.total != null ? res.meta.total :
                      rows2.length)
          );
          if (!isFinite(total2) || total2 < 0) total2 = rows2.length;
          var cols2 = ids2.map(function (fid, i) {
            var lbl = head2[i] || '';
            return normalizeColumn_({}, fid, lbl);
          });
          var meta2 = normalizeMeta_(res);
          return { ids: ids2, header: head2, rows: rows2, total: total2, columns: cols2, meta: meta2, needsMetaRetry: needsMetaRetry };
        }

        if (Array.isArray(res)) {
          function toArrayRow(r) {
            if (Array.isArray(r)) {
              if (r.length === 1 && typeof r[0] === 'string' && r[0].indexOf('|') >= 0) return r[0].split('|');
              return r;
            }
            if (typeof r === 'string' && r.indexOf('|') >= 0) return r.split('|');
            return Array.isArray(r) ? r : [];
          }
          function isFiRow(r) {
            var a = toArrayRow(r);
            if (!a.length) return false;
            var hits = 0;
            for (var i = 0; i < a.length; i++) {
              try {
                if (window.SchemaResolver && SchemaResolver.hasFid && SchemaResolver.hasFid(String(a[i] || ''))) hits++;
              } catch (_) { }
            }
            return hits >= 3 && hits >= Math.ceil(a.length * 0.6);
          }

          var k = -1;
          for (var i2 = 0; i2 < res.length; i2++) { if (isFiRow(res[i2])) { k = i2; break; } }

          if (k >= 0) {
            var ids = toArrayRow(res[k]);
            var names = (k + 1 < res.length) ? toArrayRow(res[k + 1]) : ids.slice();
            var data = [];
            for (var r = k + 2; r < res.length; r++) { data.push(toArrayRow(res[r])); }
            var total = data.length;
            return { ids: ids, header: names, rows: data, total: total };
          }

          var ids0 = Array.isArray(res[0]) ? res[0] : [];
          var head0 = Array.isArray(res[1]) ? res[1] : [];
          var rows0 = res.slice(2).map(toArrayRow);
          var total0 = rows0.length;
          var cols0 = ids0.map(function (fid, i) {
            var lbl0 = head0[i] || '';
            return normalizeColumn_({}, fid, lbl0);
          });
          return { ids: ids0, header: head0, rows: rows0, total: total0, columns: cols0, needsMetaRetry: needsMetaRetry };
        }

        return { ids: [], header: [], rows: [], total: 0, columns: [], needsMetaRetry: needsMetaRetry };
      }

      function dumpTableRaw_(res, key) {
        window.__MOTK_LAST_TABLE_RES__ = res;
        window.__MOTK_LAST_TABLE_KEY__ = key;
        if (window.__MOTK_DUMP_TABLE_RAW__ !== true) return;
        function safeClone_(v) {
          try { return structuredClone(v); } catch (e) { return v; }
        }
        try {
          console.log('[MOTK][RAW] Table render input =', safeClone_(res));
          console.log('[MOTK][RAW] summary =', {
            total: (res && (res.total != null ? res.total : (res.meta && res.meta.total))) || undefined,
            rowsLen: res && res.rows ? res.rows.length : undefined,
            colsLen: res && (res.columns ? res.columns.length : (res.ids ? res.ids.length : undefined)),
            firstCol: res && (res.columns ? res.columns[0] : (res.ids ? res.ids[0] : undefined)),
            firstRow: res && res.rows ? res.rows[0] : undefined
          });
        } catch (_) { }
      }

      function scheduleMetaRetry_(rawRes, payload, key, normalized) {
        if (!normalized || !normalized.needsMetaRetry) return;
        if (window.__MOTK_TABLE_META_RETRY__ && window.__MOTK_TABLE_META_RETRY__.key === key) return;
        window.__MOTK_TABLE_META_RETRY__ = { key: key, attempts: 0 };
        (function retry() {
          if (!window.__MOTK_TABLE_META_RETRY__ || window.__MOTK_TABLE_META_RETRY__.key !== key) return;
          if (window.FIELD_TYPES && Object.keys(window.FIELD_TYPES).length) {
            var next = normalizeRowsPayload(rawRes, payload && payload.sheetName);
            next = applyColManifestToNormalized_(next, 'meta-retry');
            next = filterPayloadFieldIdsForEntity_(next, 'meta-retry');
            applyData(next);
            try { renderCurrentPage && renderCurrentPage(true); } catch (_) { }
            window.__MOTK_TABLE_META_RETRY__ = null;
            return;
          }
          window.__MOTK_TABLE_META_RETRY__.attempts += 1;
          if (window.__MOTK_TABLE_META_RETRY__.attempts > 20) {
            window.__MOTK_TABLE_META_RETRY__ = null;
            return;
          }
          setTimeout(retry, 300);
        })();
      }

      /* ===== 14. グループフィルタ payload ===== */

      function isValidFieldId_(fid) {
        if (!fid) return false;
        var f = String(fid).trim();
        if (!f) return false;
        var allowed = buildAllowedFieldIdSet_();
        if (allowed) return !!allowed[f];
        try { if (window.SchemaResolver && SchemaResolver.hasFid && SchemaResolver.hasFid(f)) return true; } catch (_) { }
        return Array.isArray(STATE.fieldIds) && indexOf(STATE.fieldIds, f) !== -1;
      }

      function sanitizeFilterGroups_(groups) {
        if (!Array.isArray(groups) || groups.length === 0) return [];
        var out = [];
        for (var i = 0; i < groups.length; i++) {
          var g = groups[i] || {};
          var rules = Array.isArray(g.rules) ? g.rules : [];
          var clean = [];
          for (var r = 0; r < rules.length; r++) {
            var rule = rules[r] || {};
            var fid = String(rule.id || '').trim();
            var op = String(rule.op || '').trim();
            if (!fid || !op || !isValidFieldId_(fid)) continue;
            clean.push({
              id: fid,
              op: op,
              value: rule.value || '',
              values: Array.isArray(rule.values) ? rule.values.slice() : []
            });
          }
          if (clean.length) {
            out.push({
              id: g.id,
              name: g.name,
              mode: (g.mode === 'any' ? 'any' : 'all'),
              rules: clean
            });
          }
        }
        return out;
      }

      function buildGroupFilterPayload() {
        var groups = [];
        Object.keys(STATE.filterSets || {}).forEach(function (name) {
          if (STATE.selectedGroups && STATE.selectedGroups[name]) {
            var g = STATE.filterSets[name] || {};
            var rules = Array.isArray(g.rules) ? g.rules.map(function (r) {
              var values = Array.isArray(r.values) ? r.values.slice()
                : (typeof r.value === 'string' && r.value.indexOf('||') >= 0
                  ? r.value.split('||').filter(Boolean)
                  : []);
              return { id: r.id, op: r.op, value: r.value || '', values: values };
            }) : [];
            groups.push({ name: name, mode: (g.mode === 'any' ? 'any' : 'all'), rules: rules });
          }
        });
        if (groups.length === 0) {
          var first = Object.keys(STATE.filterSets || {})[0];
          if (first) {
            var g = STATE.filterSets[first];
            var rules = Array.isArray(g.rules) ? g.rules.map(function (r) {
              var values = Array.isArray(r.values) ? r.values.slice()
                : (typeof r.value === 'string' && r.value.indexOf('||') >= 0
                  ? r.value.split('||').filter(Boolean)
                  : []);
              return { id: r.id, op: r.op, value: r.value || '', values: values };
            }) : [];
            groups.push({ name: first, mode: (g.mode === 'any' ? 'any' : 'all'), rules: rules });
          }
        }
        groups = sanitizeFilterGroups_(groups);
        return { filterGroups: groups, groupCombine: (STATE.groupCombine === 'any' ? 'any' : 'all') };
      }

      /* ===== 15. 列順・列幅・visibleCols ===== */

      function defaultWidthFor(colId, headerText) {
        var h = String(headerText || '').toLowerCase();
        if (h === 'shotview' || h === 'assetview') return 100;
        var meta = getNormalizedFieldMeta_(STATE.sheetName || '', colId) || {};
        var t = String(meta.type || '').toLowerCase().trim();
        if (t === 'entity_name' || /shot(code)?/i.test(h)) return 120;
        return DEFAULT_COL_W;
      }

      function indexOf(arr, v) {
        if (!Array.isArray(arr)) return -1;
        for (var i = 0; i < arr.length; i++) { if (arr[i] === v) return i; }
        return -1;
      }

      function buildAllowedFieldIdSetForEntity_(entityKey) {
        try {
          var ent = canonEntityKey_(entityKey || STATE.sheetName || '', '');
          var meta = ent && window.FIELD_TYPES && window.FIELD_TYPES[ent] ? window.FIELD_TYPES[ent] : null;
          if (!meta || !Object.keys(meta).length) return null;
          var set = {};
          Object.keys(meta).forEach(function (fid2) {
            var t = String(meta[fid2] && meta[fid2].type || '').trim();
            if (t) set[fid2] = true;
          });
          if (!Object.keys(set).length) return null;
          return set;
        } catch (_) {
          return null;
        }
      }

      function buildAllowedFieldIdSet_() {
        return buildAllowedFieldIdSetForEntity_(STATE.sheetName || '');
      }

      function purgeInvalidFieldTypesForEntity_(entityKey, reason) {
        try {
          var ent = canonEntityKey_(entityKey || STATE.sheetName || '', '');
          var meta = ent && window.FIELD_TYPES && window.FIELD_TYPES[ent] ? window.FIELD_TYPES[ent] : null;
          if (!meta) return [];
          var removed = [];
          Object.keys(meta).forEach(function (fid) {
            var t = String(meta[fid] && meta[fid].type || '').trim();
            if (!t) {
              removed.push(fid);
              delete meta[fid];
            }
          });
          if (removed.length) {
            try { console.warn('[Table] pruned FIELD_TYPES entries with empty type', { entity: ent, removed: removed, reason: reason || '' }); } catch (_) { }
          }
          return removed;
        } catch (_) {
          return [];
        }
      }

      function filterFieldIdListForEntity_(list, reason) {
        if (!Array.isArray(list) || !list.length) return [];
        var allowed = buildAllowedFieldIdSet_();
        if (!allowed) {
          STATE.__FIELD_ID_FILTER_DEFERRED__ = true;
          return list.map(function (fid) { return String(fid || '').trim(); }).filter(Boolean);
        }
        var out = [];
        var dropped = [];
        for (var i = 0; i < list.length; i++) {
          var fid = String(list[i] || "").trim();
          if (!fid) continue;
          if (allowed[fid]) out.push(fid);
          else dropped.push(fid);
        }
        if (dropped.length && !STATE.__FIELD_ID_FILTER_LOGGED__) {
          STATE.__FIELD_ID_FILTER_LOGGED__ = true;
          console.warn("[MOTK][Table] Dropped fieldIds not valid for entity", {
            entity: canonEntityKey_(STATE.sheetName || '', STATE.sheetName || ''),
            reason: reason || '',
            inputCount: list.length,
            outputCount: out.length,
            droppedFieldIds: dropped,
            dropped: dropped
          });
        }
        return out;
      }

      function filterPayloadFieldIdsForEntity_(p, reason, allowedOverride, entityOverride) {
        try {
          if (!p || !Array.isArray(p.ids) || !p.ids.length) return p;
          var ent = canonEntityKey_((entityOverride || p.sheetName || p.entity || (STATE && STATE.sheetName) || ''), '');
          var allowed = allowedOverride || buildAllowedFieldIdSetForEntity_(ent);
          if (!allowed) return p;

          var ids = p.ids.map(function (fid) { return String(fid || '').trim(); }).filter(Boolean);
          if (!ids.length) return p;

          var keepIdx = [];
          var outIds = [];
          var removed = [];
          for (var i = 0; i < ids.length; i++) {
            var fid = ids[i];
            if (allowed[fid]) {
              keepIdx.push(i);
              outIds.push(fid);
            } else {
              removed.push(fid);
            }
          }
          if (!removed.length) {
            p.ids = ids;
            return p;
          }

          var header = Array.isArray(p.header) ? p.header : [];
          var newHeader = [];
          for (var h = 0; h < keepIdx.length; h++) {
            var idx = keepIdx[h];
            var lbl = header[idx] != null ? String(header[idx]) : '';
            newHeader.push(lbl || outIds[h] || '');
          }

          var newColumns = [];
          if (Array.isArray(p.columns) && p.columns.length) {
            if (p.columns.length === ids.length) {
              for (var c = 0; c < keepIdx.length; c++) {
                newColumns.push(p.columns[keepIdx[c]]);
              }
            } else {
              var colById = {};
              for (var ci = 0; ci < p.columns.length; ci++) {
                var col = p.columns[ci] || {};
                var fidc = String(col.fid || col.fieldId || col.id || col.field_id || '').trim();
                if (fidc) colById[fidc] = col;
              }
              for (var cj = 0; cj < outIds.length; cj++) {
                var fid2 = outIds[cj];
                newColumns.push(colById[fid2] || { id: fid2, fieldId: fid2, label: newHeader[cj] || fid2 });
              }
            }
          }

          var rows = Array.isArray(p.rows) ? p.rows : [];
          var newRows = [];
          for (var r = 0; r < rows.length; r++) {
            var row = rows[r] || [];
            var nr = [];
            for (var k = 0; k < keepIdx.length; k++) {
              var idx2 = keepIdx[k];
              nr.push(row[idx2]);
            }
            newRows.push(nr);
          }

          p.ids = outIds;
          p.header = newHeader;
          if (newColumns.length) p.columns = newColumns;
          p.rows = newRows;
          p._removedFieldIds = removed.slice();
          p._removedFieldReason = String(reason || '');

          STATE.__LAST_PRUNED_FIELDS__ = removed.slice();
          STATE.__LAST_PRUNED_REASON__ = String(reason || '');
          try { console.warn('[Table] pruned payload fieldIds', { reason: reason || '', removed: removed, entity: ent }); } catch (_) { }
          try {
            if (STATE && STATE.pageId) saveColManifest_(STATE.pageId, ent, outIds, 'prune');
          } catch (_) { }
          return p;
        } catch (_) { }
        return p;
      }

      function pruneCachedRowsForEntity_(entityKey, allowedSet, reason) {
        try {
          var ent = canonEntityKey_(entityKey || STATE.sheetName || '', '');
          if (!ent) return 0;
          var allowed = allowedSet || buildAllowedFieldIdSetForEntity_(ent);
          if (!allowed) return 0;
          var idx = LSC_readIndex_();
          var keys = Object.keys(idx.items || {}).filter(function (k) { return k.indexOf('motk:rows:') === 0; });
          if (!keys.length) return 0;

          var totalRemoved = 0;
          var touched = [];
          for (var i = 0; i < keys.length; i++) {
            var key = keys[i];
            var env = LSC_getEnvelope(key);
            if (!env || !env.payload) continue;
            var payload = env.payload;
            var payloadEnt = canonEntityKey_((payload.sheetName || payload.entity || (payload.meta && payload.meta.entity) || ''), '');
            if (payloadEnt !== ent) continue;
            var filtered = filterPayloadFieldIdsForEntity_(payload, reason || 'cache:prune', allowed, ent);
            var removed = (filtered && filtered._removedFieldIds) ? filtered._removedFieldIds.slice() : [];
            if (!removed.length) continue;
            try { LSC_setEnvelope(key, filtered, env.meta || {}); } catch (_) { }
            totalRemoved += removed.length;
            touched.push({
              key: key,
              removed: removed,
              removedCount: removed.length,
              beforeIds: Array.isArray(payload.ids) ? payload.ids.length : 0,
              afterIds: Array.isArray(filtered.ids) ? filtered.ids.length : 0
            });
          }
          if (touched.length) {
            try { console.warn('[Table] pruned cached rows envelopes', { entity: ent, reason: reason || '', touched: touched }); } catch (_) { }
          }
          return totalRemoved;
        } catch (_) {
          return 0;
        }
      }

      function runSchemaMembershipSweep_(entityKey, reason) {
        try {
          var ent = canonEntityKey_(entityKey || STATE.sheetName || '', '');
          if (!ent) return false;
          var allowed = buildAllowedFieldIdSetForEntity_(ent);
          if (!allowed) return false;
          var changed = false;
          try { if (pruneStateFieldIdsAfterSchema_(reason || 'schema:sweep')) changed = true; } catch (_) { }
          try { if (prunePageConfigOrder_(reason || 'schema:sweep')) changed = true; } catch (_) { }
          try { if (reconcileStoredViewerFieldIds_(ent, reason || 'schema:sweep')) changed = true; } catch (_) { }
          try {
            var pruned = pruneCachedRowsForEntity_(ent, allowed, reason || 'schema:sweep');
            if (pruned > 0) changed = true;
          } catch (_) { }
          return changed;
        } catch (_) {
          return false;
        }
      }

      function scheduleSchemaSweepAfterNetworkFields_() {
        try {
          var startSource = window.__MOTK_FIELD_TYPES_SOURCE__ || '';
          if (startSource === 'network') return;
          var attempts = 0;
          var timer = setInterval(function () {
            attempts++;
            var src = window.__MOTK_FIELD_TYPES_SOURCE__ || '';
            if (src && src !== startSource && src === 'network') {
              try { runSchemaMembershipSweep_(STATE.sheetName, 'fields:network'); } catch (_) { }
              clearInterval(timer);
              return;
            }
            if (attempts > 40) {
              clearInterval(timer);
            }
          }, 250);
        } catch (_) { }
      }

      function resolveOrder() {
        var ids = Array.isArray(STATE.fieldIds) ? STATE.fieldIds.slice() : [];
        var order = (STATE.pageCfgRaw && Array.isArray(STATE.pageCfgRaw.order))
          ? STATE.pageCfgRaw.order.slice()
          : [];
        if (!order || !order.length) return ids;
        order = filterFieldIdListForEntity_(order, 'pageCfg.order');
        var allowed = buildAllowedFieldIdSet_();
        var inOrder = {}, out = [];
        var rejected = [];
        for (var i = 0; i < order.length; i++) {
          var id = order[i];
          if (!id) continue;
          if (!allowed) {
            if (!inOrder[id]) { inOrder[id] = 1; out.push(id); }
            continue;
          }
          if (allowed[id] && !inOrder[id]) {
            inOrder[id] = 1; out.push(id);
          } else if (!allowed[id]) {
            rejected.push(id);
          }
        }
        for (var j = 0; j < ids.length; j++) {
          var k = ids[j];
          if (!k || inOrder[k]) continue;
          if (!allowed || allowed[k]) out.push(k);
        }
        if (rejected.length && !STATE.__ORDER_REJECTED_LOGGED__) {
          STATE.__ORDER_REJECTED_LOGGED__ = true;
          console.warn("[MOTK][Table] Dropped non-entity fieldIds from page order:", rejected);
        }
        return out;
      }

      function visibleCols() {
        var resolved = resolveOrder();
        var out = [], seen = {};
        for (var i = 0; i < resolved.length; i++) {
          var id = resolved[i];
          if (id && !STATE.hiddenCols[id] && !seen[id]) {
            seen[id] = 1; out.push(id);
          }
        }
        return out;
      }

      function findOriginalsCols() {
        var set = {};
        for (var i = 0; i < STATE.fieldIds.length; i++) {
          var fid = STATE.fieldIds[i];
          var h = _norm(STATE.header[i]);
          var meta = getNormalizedFieldMeta_(STATE.sheetName || '', fid) || {};
          var t = String(meta.type || '').toLowerCase().trim();
          var name = _normalizeFieldName_(meta.field_name || meta.name || meta.label || h);
          if (t === 'originals' || name.indexOf('original') === 0) { set[fid] = 1; }
        }
        return set;
      }

      function toOriginalsUrl(v) {
        var s = String(v || '').trim(); if (!s) return '';
        if (/^https?:\/\//i.test(s)) return s;
        var m = s.match(/(?:drive:|gdrive:)?([A-Za-z0-9_-]{20,})/);
        if (m) return 'https://drive.google.com/drive/folders/' + m[1];
        return '';
      }

      function _isComplexFieldType_(meta) {
        var t = String(meta && meta.type || "");
        if (meta && meta.isLink) return true;
        if (/_link$/.test(t)) return true;
        if (t === "versions" || t === "json" || t === "file_list" || t === "thumbnails") return true;
        return false;
      }

      function _sanitizeValueForMeta_(meta, v, ctx) {
        if (v == null) return v;
        if (_isComplexFieldType_(meta)) return v;
        if (typeof v === "string" || typeof v === "number" || typeof v === "boolean") return v;
        if (meta && meta.type === "date") {
          try {
            if (v instanceof Date && !isNaN(v.getTime())) return v.toISOString().slice(0, 10);
            if (v && typeof v === "object") {
              var y = v.y != null ? v.y : v.year;
              var m = v.m != null ? v.m : v.month;
              var d = v.d != null ? v.d : v.day;
              if (isFinite(y) && isFinite(m) && isFinite(d)) {
                var mm = String(m).padStart(2, "0");
                var dd = String(d).padStart(2, "0");
                return String(y) + "-" + mm + "-" + dd;
              }
              if (Object.prototype.hasOwnProperty.call(v, "raw")) return _sanitizeValueForMeta_(meta, v.raw, ctx);
              if (Object.prototype.hasOwnProperty.call(v, "value")) return _sanitizeValueForMeta_(meta, v.value, ctx);
              if (Object.prototype.hasOwnProperty.call(v, "text")) return _sanitizeValueForMeta_(meta, v.text, ctx);
              if (Object.prototype.hasOwnProperty.call(v, "v")) return _sanitizeValueForMeta_(meta, v.v, ctx);
            }
          } catch (_) { }
        }
        if (v instanceof Date && !isNaN(v.getTime())) return v.toISOString().slice(0, 10);
        if (Array.isArray(v)) {
          var out = [];
          for (var i = 0; i < v.length; i++) {
            var it = v[i];
            if (it == null) continue;
            if (typeof it === "string" || typeof it === "number" || typeof it === "boolean") {
              out.push(String(it));
              continue;
            }
            var un = _sanitizeValueForMeta_(meta, it, ctx);
            if (typeof un === "string" && un) out.push(un);
          }
          return out.length ? out.join("|") : "";
        }
        if (v && typeof v === "object") {
          try {
            if (Object.prototype.hasOwnProperty.call(v, "raw")) return _sanitizeValueForMeta_(meta, v.raw, ctx);
            if (Object.prototype.hasOwnProperty.call(v, "value")) return _sanitizeValueForMeta_(meta, v.value, ctx);
            if (Object.prototype.hasOwnProperty.call(v, "text")) return _sanitizeValueForMeta_(meta, v.text, ctx);
            if (Object.prototype.hasOwnProperty.call(v, "v")) return _sanitizeValueForMeta_(meta, v.v, ctx);
          } catch (_) { }
        }
        try {
          var where = ctx && ctx.where ? String(ctx.where) : "";
          var rowId = ctx && ctx.rowId ? String(ctx.rowId) : "";
          var fid = ctx && ctx.fid ? String(ctx.fid) : "";
          console.warn("[Table] non-scalar value sanitized", { where: where, rowId: rowId, fid: fid, type: meta && meta.type, valueType: typeof v });
        } catch (_) { }
        return "";
      }

      function _toScalarText_(v, ctx) {
        var base = (typeof _sanitizeValueForMeta_ === "function") ? _sanitizeValueForMeta_(null, v, ctx) : v;
        if (base === null || base === undefined) return "";
        var t = typeof base;
        if (t === "string") return base;
        if (t === "number") return Number.isFinite(base) ? String(base) : "";
        if (t === "boolean") return base ? "true" : "false";
        if (base instanceof Date) return isNaN(base.getTime()) ? "" : base.toISOString();
        try { if (t === "object") return JSON.stringify(base); } catch (_) { }
        return "";
      }

      window.__MOTK_TABLE_WRITE_LWW__ = window.__MOTK_TABLE_WRITE_LWW__ || Object.create(null);
      window.__MOTK_PENDING_WRITES__ = window.__MOTK_PENDING_WRITES__ || Object.create(null);

      function _tableWriteKey_(entity, rowId, fid) {
        if (arguments.length === 2) {
          fid = rowId;
          rowId = entity;
          try { entity = singularEntityFor(_entityForUI()); } catch (_) { entity = (STATE && STATE.sheetName) || ''; }
        }
        return String(entity || '') + '|' + String(rowId || '') + '|' + String(fid || '');
      }

      function _newWriteToken_() {
        return Date.now().toString(36) + ':' + Math.random().toString(36).slice(2);
      }

      function _markPendingWrite_(entity, rowId, fid, token, value) {
        try {
          var key = _tableWriteKey_(entity, rowId, fid);
          window.__MOTK_PENDING_WRITES__[key] = { token: token, value: value };
        } catch (_) { }
      }

      function _clearPendingWrite_(entity, rowId, fid, token) {
        try {
          var key = _tableWriteKey_(entity, rowId, fid);
          var cur = window.__MOTK_PENDING_WRITES__[key];
          if (!cur || (token && cur.token && cur.token !== token)) return;
          delete window.__MOTK_PENDING_WRITES__[key];
        } catch (_) { }
      }

      window.__MOTK_WRITE_BARRIERS__ = window.__MOTK_WRITE_BARRIERS__ || {};
      function _setWriteBarrier_(entity, rowId, fid, value) {
        try {
          var key = _tableWriteKey_(entity, rowId, fid);
          window.__MOTK_WRITE_BARRIERS__[key] = { ts: Date.now(), value: value };
        } catch (_) { }
      }
      function _clearWriteBarrier_(entity, rowId, fid) {
        try {
          var key = _tableWriteKey_(entity, rowId, fid);
          delete window.__MOTK_WRITE_BARRIERS__[key];
        } catch (_) { }
      }
      function _writeBarrierValue_(entity, rowId, fid) {
        try {
          var key = _tableWriteKey_(entity, rowId, fid);
          return window.__MOTK_WRITE_BARRIERS__[key];
        } catch (_) { return null; }
      }

      function _applyUpdatedFieldsFromResponse_(resp, rowId) {
        try {
          if (!resp || typeof resp !== 'object' || !resp.updated || typeof resp.updated !== 'object') return;
          var ent = singularEntityFor(_entityForUI());
          Object.keys(resp.updated).forEach(function (fid) {
            var colIdx = indexOf(STATE.fieldIds, fid);
            if (colIdx < 0) return;
            var meta = getNormalizedFieldMeta_(STATE.sheetName, fid);
            var raw = resp.updated[fid];
            var safe = _sanitizeValueForMeta_(meta, raw, { rowId: rowId, fid: fid, where: "inlineEditUpdated" });
            _setRowValueByIdFid_(rowId, fid, safe);
            setCellDomAll_(rowId, fid, meta, safe);
            _clearPendingWrite_(ent, rowId, fid, null);
          });
        } catch (_) { }
      }

      function _extractFieldValue_(v, fid, fallback) {
        function rawOf_(raw) {
          // Unwrap common wrapper objects returned by server responses.
          // Supports:
          // - { raw: ... }, { value: ... }, { text: ... }
          // - ViewToken: { v: ..., label?: ..., t?: ..., c?: ... }
          //   (including nested view tokens)
          if (raw && typeof raw === "object") {
            if (Object.prototype.hasOwnProperty.call(raw, "raw")) return rawOf_(raw.raw);
            if (Object.prototype.hasOwnProperty.call(raw, "value")) return rawOf_(raw.value);
            if (Object.prototype.hasOwnProperty.call(raw, "text")) return rawOf_(raw.text);
            if (Object.prototype.hasOwnProperty.call(raw, "v")) return rawOf_(raw.v);
          }
          return raw;
        }

        if (arguments.length >= 2) {
          try {
            var resp = v;
            var f = String(fid || '');
            if (resp && typeof resp === 'object') {
              if (resp.updated && Object.prototype.hasOwnProperty.call(resp.updated, f)) return rawOf_(resp.updated[f]);
              if (resp.fields && Object.prototype.hasOwnProperty.call(resp.fields, f)) return rawOf_(resp.fields[f]);
              if (Object.prototype.hasOwnProperty.call(resp, 'fields') && resp.fields && Object.prototype.hasOwnProperty.call(resp.fields, f)) return rawOf_(resp.fields[f]);
              if (Object.prototype.hasOwnProperty.call(resp, f)) return rawOf_(resp[f]);
            }
          } catch (_) { }
          return fallback;
        }
        try {
          return rawOf_(v);
        } catch (_) { }
        return v;
      }

      function _renderLinkCellHtml_(value) {
        var toks = splitTokens(value).filter(function (x) { return String(x || '').trim() !== ''; });
        return toks.map(renderLinkId).join(', ');
      }

      function _updateAllLinkCellsDom_(rowId, fid, value) {
        var q = '#tableWrap tr[data-row-id="' + rowId + '"] td[data-col-id="' + fid + '"]';
        var tds = document.querySelectorAll(q);
        for (var i = 0; i < tds.length; i++) {
          var td = tds[i];
          try { td.innerHTML = _renderLinkCellHtml_(value); } catch (_) { td.textContent = String(value == null ? '' : value); }
        }
      }

      var __MOTK_TABLE_STATUS_CLEAR_TIMER__ = null;
      function _flashUpdatedStatus_() {
        try { if (typeof showStatus === 'function') showStatus('Updated!'); } catch (_) { }
        try {
          if (__MOTK_TABLE_STATUS_CLEAR_TIMER__) clearTimeout(__MOTK_TABLE_STATUS_CLEAR_TIMER__);
          __MOTK_TABLE_STATUS_CLEAR_TIMER__ = setTimeout(function () {
            try {
              var el = document.getElementById('statusLeft');
              if (el && el.textContent === 'Updated!') {
                if (typeof setFinalStatus === 'function') setFinalStatus();
                else if (typeof showStatus === 'function') showStatus('');
              }
            } catch (_) { }
          }, 1800);
        } catch (_) { }
      }

      var __MOTK_DEFER_QUEUE__ = [];
      var __MOTK_DEFER_PENDING__ = 0;
      var __MOTK_DEFER_DONE__ = 0;
      var __MOTK_DEFER_FAILED__ = 0;
      var __MOTK_DEFER_LAST_FLUSH__ = 0;
      var __MOTK_DEFER_FLUSH_SCHEDULED__ = false;

      function updateDeferDebug_() {
        window.__MOTK_DEFER = {
          pending: __MOTK_DEFER_PENDING__,
          done: __MOTK_DEFER_DONE__,
          failed: __MOTK_DEFER_FAILED__,
          lastFlushAt: __MOTK_DEFER_LAST_FLUSH__
        };
      }

      function scheduleDeferFlush_() {
        if (__MOTK_DEFER_FLUSH_SCHEDULED__) return;
        __MOTK_DEFER_FLUSH_SCHEDULED__ = true;
        var schedule = window.requestAnimationFrame || function (cb) { setTimeout(cb, 0); };
        schedule(function () {
          __MOTK_DEFER_FLUSH_SCHEDULED__ = false;
          flushDeferred_();
        });
      }

      function flushDeferred_() {
        var jobs = __MOTK_DEFER_QUEUE__.splice(0);
        for (var i = 0; i < jobs.length; i++) {
          var job = jobs[i];
          if (!job || typeof job.applyFn !== 'function') continue;
          try {
            job.applyFn(job.result, job.error);
            __MOTK_DEFER_DONE__ += 1;
          } catch (_) {
            __MOTK_DEFER_FAILED__ += 1;
          }
        }
        __MOTK_DEFER_LAST_FLUSH__ = Date.now();
        updateDeferDebug_();
        try {
          if (__MOTK_DEFER_PENDING__ === 0 && window.__MOTK_TABLE_TIMINGS__ && window.__MOTK_TABLE_TIMINGS__.postRenderStart) {
            var end = _perfNow_();
            recordPerf_('post_render_tasks_ms', end - window.__MOTK_TABLE_TIMINGS__.postRenderStart);
            if (!window.__MOTK_TABLE_TIMINGS__.__postRenderLogged) {
              window.__MOTK_TABLE_TIMINGS__.__postRenderLogged = true;
              _perfLog_('table_post_render_tasks', window.__MOTK_TABLE_TIMINGS__.postRenderStart);
            }
          }
        } catch (_) { }
        if (__MOTK_DEFER_QUEUE__.length) scheduleDeferFlush_();
      }

      function enqueueDeferred_(name, promise, applyFn) {
        __MOTK_DEFER_PENDING__ += 1;
        updateDeferDebug_();
        Promise.resolve(promise).then(function (res) {
          __MOTK_DEFER_QUEUE__.push({ name: name, result: res, applyFn: applyFn });
        }).catch(function (err) {
          __MOTK_DEFER_FAILED__ += 1;
          __MOTK_DEFER_QUEUE__.push({ name: name, error: err, applyFn: applyFn });
        }).finally(function () {
          __MOTK_DEFER_PENDING__ = Math.max(0, __MOTK_DEFER_PENDING__ - 1);
          updateDeferDebug_();
          scheduleDeferFlush_();
        });
      }

      function recordPerf_(key, ms) {
        try {
          window.__MOTK_TABLE_TIMINGS__ = window.__MOTK_TABLE_TIMINGS__ || {};
          if (window.__MOTK_TABLE_TIMINGS__[key] != null) return;
          window.__MOTK_TABLE_TIMINGS__[key] = Math.round(ms);
          window.__MOTK_LAST_TABLE_PERF__ = window.__MOTK_TABLE_TIMINGS__;
          console.info('[MOTK][PERF]', key + '=' + Math.round(ms));
        } catch (_) { }
      }

      function _navPerfStore_() {
        window.__MOTK_TABLE_NAV_TIMINGS__ = window.__MOTK_TABLE_NAV_TIMINGS__ || {};
        return window.__MOTK_TABLE_NAV_TIMINGS__;
      }

      function _navPerfFlags_() {
        window.__MOTK_TABLE_NAV_FLAGS__ = window.__MOTK_TABLE_NAV_FLAGS__ || {};
        return window.__MOTK_TABLE_NAV_FLAGS__;
      }

      function initNavPerf_() {
        window.__MOTK_TABLE_NAV_TIMINGS__ = {};
        window.__MOTK_TABLE_NAV_FLAGS__ = {
          snapshotLogged: false,
          snapshotScheduled: false,
          snapshotDelay: null,
          snapshotTimerId: null,
          expectThumbs: false,
          swrCacheHit: false,
          swrBackgroundFetch: false,
          schemaRefreshed: false,
          schemaRefreshReason: '',
          dataSource: '',
          swrRequests: 0
        };
        window.__MOTK_SWR_REQ_TRACKER__ = { byKey: {}, count: 0 };
      }

      function _bootStartMs_() {
        var nav = window.__MOTK_TABLE_NAV_TIMINGS__ || {};
        return window.__MOTK_BOOTSTRAP_TS__ || (STATE && STATE.__BOOT_START__) || nav.bootStart || (window.__MOTK_TABLE_TIMINGS__ && window.__MOTK_TABLE_TIMINGS__.bootStart) || _perfNow_();
      }

      function markNavPerf_(name, tAbs) {
        var store = _navPerfStore_();
        if (store[name] != null) return;
        var boot = _bootStartMs_();
        if (!store.bootStart) store.bootStart = boot;
        var now = (tAbs != null) ? tAbs : _perfNow_();
        var ms = Math.round((now - boot) * 1000) / 1000;
        store[name] = ms;
      }

      function markNavFlag_(key, value) {
        var flags = _navPerfFlags_();
        flags[key] = value;
      }

      function _shouldEmitNavPerfSnapshot_() {
        var flags = _navPerfFlags_();
        var store = _navPerfStore_();
        var havePaint = (store.table_painted_ms != null) || (store.render_first_paint_ms != null);
        if (!havePaint) return false;
        return true;
      }

      function emitNavPerfSnapshot_(reason, force) {
        var flags = _navPerfFlags_();
        if (flags.snapshotLogged && !force) {
          try { persistNavTimingStorage_(_navPerfStore_()); } catch (_) { }
          return;
        }
        if (!force && !_shouldEmitNavPerfSnapshot_()) return;
        flags.snapshotLogged = true;
        var store = _navPerfStore_();
        var havePaint = (store.table_painted_ms != null) || (store.render_first_paint_ms != null);
        if (reason === 'timeout' && (havePaint || (STATE && STATE.__TABLE_RENDERED__))) {
          reason = havePaint ? 'table_painted' : 'marks_missing';
        }
        try { window.__MOTK_TABLE_NAV_TIMINGS__ = store; } catch (_) { }
        var snapshot = {
          reason: reason || 'navigation',
          entity: _entityForUI(),
          pageId: (STATE && STATE.pageId) || '',
          dataSource: flags.dataSource || (STATE && (STATE.dataSourceEffective || STATE.dataSource)) || '',
          schemaRefreshed: !!flags.schemaRefreshed,
          schemaRefreshReason: flags.schemaRefreshReason || '',
          swrCacheHit: !!flags.swrCacheHit,
          swrBackgroundFetch: !!flags.swrBackgroundFetch,
          swrRequests: flags.swrRequests || 0,
          marks: {
            nav_start_ms: store.nav_start_ms,
            toolbar_mounted_ms: store.toolbar_mounted_ms,
            view_hydrated_ms: store.view_hydrated_ms,
            rows_received_ms: store.rows_received_ms,
            table_painted_ms: store.table_painted_ms != null ? store.table_painted_ms : store.render_first_paint_ms,
            table_cache_painted_ms: store.table_cache_painted_ms,
            rows_updated_ms: store.rows_updated_ms,
            thumbs_ready_ms: store.thumbs_ready_ms,
            shotview_ready_ms: store.shotview_ready_ms
          }
        };
        if (reason === 'marks_missing') snapshot.hint = 'marks missing; check performance.mark calls';
        try { console.info('[MOTK][PERF][NAV]', snapshot); } catch (_) { }
        try {
          var r0 = snapshot.marks.table_painted_ms;
          var r1 = snapshot.marks.table_cache_painted_ms;
          var r2 = snapshot.marks.rows_updated_ms;
          var r3 = snapshot.marks.shotview_ready_ms || snapshot.marks.thumbs_ready_ms;
          console.info('[MOTK][READY]', 'R0=' + (r0 != null ? r0 : 'n/a'), 'R1=' + (r1 != null ? r1 : 'n/a'), 'R2=' + (r2 != null ? r2 : 'n/a'), 'R3=' + (r3 != null ? r3 : 'n/a'));
        } catch (_) { }
        try { persistNavTimingStorage_(store); } catch (_) { }

        // Persist NAV snapshot for DebugPanel (works even when window.opener is unavailable).
        try {
          var perf = window.__MOTK_TABLE_TIMINGS__ || {};
          var timings = {};
          for (var k in store) {
            if (Object.prototype.hasOwnProperty.call(store, k) && typeof store[k] === 'number') timings[k] = store[k];
          }
          for (var pk in perf) {
            if (Object.prototype.hasOwnProperty.call(perf, pk) && typeof perf[pk] === 'number') timings[pk] = perf[pk];
          }
          var navPayload = {
            ts: Date.now(),
            entity: snapshot.entity || '',
            pageId: snapshot.pageId || '',
            dataSource: snapshot.dataSource || '',
            reason: snapshot.reason || '',
            timings: timings,
            marks: snapshot.marks || null
          };
          window.__MOTK_LAST_TABLE_NAV_V1__ = navPayload;
          try { persistBootSnapshot_('nav_snapshot'); } catch (_) { }
        } catch (e3) { }
      }

      function persistNavTimingStorage_(store) {
        var t = store || window.__MOTK_TABLE_NAV_TIMINGS__ || {};
        try { sessionStorage.setItem("MOTK_LAST_TABLE_NAV_V1", JSON.stringify(t)); } catch (e1) {}
        try { localStorage.setItem("MOTK_LAST_TABLE_NAV_LS_V1", JSON.stringify(t)); } catch (e2) {}

        var diag = {
          updatedAt: Date.now(),
          entity: (STATE && STATE.sheetName) || "",
          pageId: (STATE && STATE.pageId) || "",
          dataSource: (STATE && (STATE.dataSourceEffective || STATE.dataSource)) || "",
          colsKey: (STATE && (STATE.__COLS_KEY__ || (Array.isArray(STATE.fieldIds) ? STATE.fieldIds.join('|') : ''))) || "",
          perf: window.__MOTK_LAST_TABLE_PERF__ || {},
          nav: t
        };
        try { sessionStorage.setItem("MOTK_LAST_TABLE_DIAG_V1", JSON.stringify(diag)); } catch (e3) {}
        try { localStorage.setItem("MOTK_LAST_TABLE_DIAG_LS_V1", JSON.stringify(diag)); } catch (e4) {}
        try { persistBootSnapshot_('nav_storage'); } catch (_) { }
      }
      function scheduleNavPerfSnapshot_(delayMs, reason) {
        var flags = _navPerfFlags_();
        if (flags.snapshotLogged) return;
        var delay = Math.max(0, delayMs || 0);
        if (flags.snapshotScheduled && typeof flags.snapshotDelay === 'number') {
          if (delay >= flags.snapshotDelay) return;
          try { clearTimeout(flags.snapshotTimerId); } catch (_) { }
        }
        flags.snapshotScheduled = true;
        flags.snapshotDelay = delay;
        flags.snapshotTimerId = setTimeout(function () {
          flags.snapshotScheduled = false;
          flags.snapshotDelay = null;
          flags.snapshotTimerId = null;
          emitNavPerfSnapshot_(reason || 'timeout', true);
        }, delay);
      }

      function _perfNow_() {
        return (window.performance && typeof performance.now === 'function') ? performance.now() : Date.now();
      }

      function perfMark_(name) {
        try {
          if (!window.performance || typeof performance.mark !== 'function') return;
          performance.mark(name);
          window.__MOTK_TABLE_PERF_MARKS__ = window.__MOTK_TABLE_PERF_MARKS__ || {};
          window.__MOTK_TABLE_PERF_MARKS__[name] = {
            ts: Date.now(),
            t: _perfNow_()
          };
        } catch (_) { }
      }

      function computePerfMeasures_() {
        try {
          var marks = window.__MOTK_TABLE_PERF_MARKS__ || {};
          if (!marks.boot_start || !marks.table_painted) return null;
          var out = {};
          Object.keys(marks).forEach(function (k) {
            if (k === 'boot_start') return;
            var m = marks[k];
            if (!m || typeof m.t !== 'number') return;
            out[k + '_ms'] = Math.round((m.t - marks.boot_start.t) * 1000) / 1000;
          });
          window.__MOTK_TABLE_PERF_MEASURES__ = out;
          return out;
        } catch (_) {
          return null;
        }
      }

      function _perfLog_(name, t0) {
        var ms = Math.round((_perfNow_() - t0) * 1000) / 1000;
        console.log('[MOTK][PERF] ' + name + '_ms=' + ms);
        return ms;
      }

      function _afterNextFrame_() {
        return new Promise(function (resolve) {
          var raf = window.requestAnimationFrame || function (cb) { setTimeout(cb, 0); };
          raf(function () { resolve(); });
        });
      }

      function renderCellIntoTd_(td, rowId, fid, raw) {
        try {
          if (!(window.CommonRenderer && typeof CommonRenderer.renderCellByField === 'function')) {
            td.textContent = _toScalarText_(raw, { rowId: rowId, fid: fid, where: "renderCellIntoTd" });
            return;
          }
          function nodeHasAnchor_(node) {
            try {
              if (!node) return false;
              if ((node.nodeType === 1 || node.nodeType === 11) && node.tagName && String(node.tagName).toLowerCase() === 'a') return true;
              return !!(node && node.querySelector && node.querySelector('a'));
            } catch (_) {
              return false;
            }
          }
          function retargetNodeAnchors_(node, href, target) {
            try {
              if (!node || !href || (node.nodeType !== 1 && node.nodeType !== 11)) return;
              if (node.nodeType === 1 && String(node.tagName || '').toLowerCase() === 'a') {
                node.href = href;
                if (target) {
                  node.target = target;
                  node.rel = 'noopener';
                  node.setAttribute('data-sched-open-newtab', '1');
                }
              }
              if (node.querySelectorAll) {
                var anchors = node.querySelectorAll('a');
                for (var ai = 0; ai < anchors.length; ai++) {
                  anchors[ai].href = href;
                  if (target) {
                    anchors[ai].target = target;
                    anchors[ai].rel = 'noopener';
                    anchors[ai].setAttribute('data-sched-open-newtab', '1');
                  }
                }
              }
            } catch (_) { }
          }
          function ensureNodeLink_(node, href, target, isSched) {
            if (!node || !href) return node;
            if (nodeHasAnchor_(node)) {
              retargetNodeAnchors_(node, href, target);
              return node;
            }
            var a = document.createElement('a');
            a.href = href;
            if (target) {
              a.target = target;
              a.rel = 'noopener';
            }
            if (isSched) a.setAttribute('data-sched-open-newtab', '1');
            a.appendChild(node);
            return a;
          }

          var entitySing = singularEntityFor(_entityForUI());
          var canon = _canon(STATE && STATE.sheetName);
          var meta = getNormalizedFieldMeta_(STATE.sheetName, fid);
          var fidIdx = indexOf((STATE && STATE.fieldIds) || [], fid);
          var headTxt = '';
          if (fidIdx >= 0 && STATE && Array.isArray(STATE.header)) headTxt = STATE.header[fidIdx] || '';
          if (!headTxt) headTxt = (meta && (meta.label || meta.name || meta.field_name)) || fid;
          var rowObj = null;
          try { if (STATE && STATE.rowsById && STATE.rowsById[rowId]) rowObj = STATE.rowsById[rowId]; } catch (_) { }
          if (!rowObj) {
            var idFid = resolveIdFieldId_();
            rowObj = applyRowIdFields_({}, rowId);
            rowObj[idFid] = rowId;
          }
          var m = Object.assign({}, meta || {}, { __rowId: rowId, rowId: rowId, recordId: rowId, id: rowId, fieldId: fid, __row: rowObj });
          td.innerHTML = '';
          var shouldLinkShot =
            entitySing === 'shot' &&
            rowId &&
            (function () {
              if (String(m.type || '').toLowerCase() === 'entity_name') return true;
              try {
                if (window.SchemaResolver && SchemaResolver.getEntityNameFid) {
                  var shotNameFid = SchemaResolver.getEntityNameFid('shot');
                  if (shotNameFid && fid === shotNameFid) return true;
                }
              } catch (_) { }
              var name = _normalizeFieldName_(m.field_name || m.name || m.label || '');
              return name === 'shotcode' || name === 'shot code';
            })();
          if (shouldLinkShot && window.__Router__ && typeof Router.buildEntityUrl === 'function') {
            var href = Router.buildEntityUrl('shot', rowId);
            var a = document.createElement('a');
            a.href = href;
            a.textContent = _toScalarText_(raw || rowId, { rowId: rowId, fid: fid, where: "renderShotLink" }) || rowId;
            a.setAttribute('data-link-kind', 'shotcode');
            td.appendChild(a);
            if (!STATE.__SHOTCODE_ANCHOR_LOGGED__) {
              STATE.__SHOTCODE_ANCHOR_LOGGED__ = true;
              try { console.info('[MOTK][Table] render: ShotCode uses href=true'); } catch (_) { }
            }
          } else {
            var node = CommonRenderer.renderCellByField(entitySing, fid, raw, m);
            if (!(node && node.nodeType)) {
              node = document.createTextNode(_toScalarText_(node, { rowId: rowId, fid: fid, where: "renderCellIntoTdNodeFallback" }));
            }
            if (shouldNameCellLinkToDetail(canon, headTxt, rowId) && window.__Router__) {
              var ent = singularEntityFor(canon);
              var isSchedLike = (ent === 'sched' || ent === 'schedule' || ent === 'scheds' || ent === 'schedules');
              if (isSchedLike && typeof Router.buildScheduleUrl === 'function') {
                node = ensureNodeLink_(node, Router.buildScheduleUrl(rowId), '_blank', true);
              } else if (!nodeHasAnchor_(node) && typeof Router.buildEntityUrl === 'function') {
                node = ensureNodeLink_(node, Router.buildEntityUrl(ent, rowId), '', false);
              }
            } else if (/shotcode/i.test(String(headTxt || '')) && isRowIdLike(rowId) && window.__Router__ && typeof Router.buildEntityUrl === 'function') {
              node = ensureNodeLink_(node, Router.buildEntityUrl('shot', rowId), '', false);
            }
            td.appendChild(node);
          }
        } catch (_) {
          td.textContent = _toScalarText_(raw, { rowId: rowId, fid: fid, where: "renderCellIntoTdCatch" });
        }
      }

      function debugProxyUrl_(rowId, fid) {
        try {
          var key = String(rowId || '') + "|" + String(fid || '');
          var byField = window.PROXY_CACHE_BY_FIELD && window.PROXY_CACHE_BY_FIELD[key];
          var byRecord = window.PROXY_CACHE && window.PROXY_CACHE[rowId];
          var entry = byField || byRecord || null;
          if (!entry) return { url: '', found: '' };
          if (typeof entry === 'string') return { url: entry, found: (byField ? 'byField' : 'byRecord') };
          if (entry && typeof entry === 'object') {
            if (entry.url) return { url: String(entry.url), found: (byField ? 'byField' : 'byRecord') };
            if (entry.previewUrl) return { url: String(entry.previewUrl), found: (byField ? 'byField' : 'byRecord') };
            if (entry.id) {
              return {
                url: 'https://drive.google.com/uc?export=download&id=' + encodeURIComponent(String(entry.id)),
                found: (byField ? 'byField' : 'byRecord')
              };
            }
          }
        } catch (_) { }
        return { url: '', found: '' };
      }

      function refreshLinkCells_() {
        try {
          var wrap = document.getElementById('tableWrap');
          if (!wrap) return;
          var linkFids = [];
          if (STATE && STATE.fieldsMeta) {
            Object.keys(STATE.fieldsMeta).forEach(function (fid) {
              var t = String(STATE.fieldsMeta[fid] && STATE.fieldsMeta[fid].type || '').toLowerCase();
              if (t === 'entity_link' || /_link$/.test(t)) linkFids.push(fid);
            });
          }
          if (!linkFids.length) return;
          linkFids.forEach(function (fid) {
            var tds = wrap.querySelectorAll('td[data-col-id="' + fid + '"]');
            for (var i = 0; i < tds.length; i++) {
              var td = tds[i];
              var tr = td.closest && td.closest('tr[data-row-id]');
              var rowId = tr ? String(tr.getAttribute('data-row-id') || '') : '';
              var raw = _rowValueByIdFid_(rowId, fid);
              renderCellIntoTd_(td, rowId, fid, raw);
            }
          });
        } catch (_) { }
      }

      function enqueuePostRenderJobs_() {
        enqueueDeferred_('linkMaps', (typeof ensureLinkMaps === 'function') ? ensureLinkMaps() : Promise.resolve(null), function () {
          refreshLinkCells_();
        });
        enqueueDeferred_('proxyPreview', Promise.resolve().then(function () {
          if (typeof window.__MOTK_PROXY_PREVIEW_REFRESH__ === 'function') {
            window.__MOTK_PROXY_PREVIEW_REFRESH__();
          }
        }), function () {});
      }

      function bindLinkPickerInlineEdit() {
        // Keep the signature object stable for DebugPanel checks
        window.__MOTK_TABLE_INLINE_EDIT_IMPL__ = {
          linkPicker: "dblclick",
          primitive: "dblclick",
          checkbox: "click",
        };

        if (!window.STATE || !STATE.sheetName) {
          try { console.warn("[Table] Inline edit: STATE not ready"); } catch (_) {}
          return;
        }

        var tableWrap = document.getElementById("tableWrap");
        if (!tableWrap) {
          try { console.warn("[Table] Inline edit: #tableWrap not found"); } catch (_) {}
          return;
        }

        // If already bound, do nothing
        window.__MOTK_INLINE_EDIT_BOUND__ = window.__MOTK_INLINE_EDIT_BOUND__ || false;
        if (window.__MOTK_INLINE_EDIT_BOUND__ || window.__MOTK_TABLE_INLINE_EDIT_BOUND) return;
        window.__MOTK_INLINE_EDIT_BOUND__ = true;

        // Mark bound ONLY when we are actually binding handlers
        window.__MOTK_TABLE_INLINE_EDIT_BOUND = true;
        try {
          if (typeof persistViewerStateSnapshot === 'function') {
            persistViewerStateSnapshot({ inlineEditBound: true, inlineEditBoundAt: Date.now() });
          }
        } catch (_) { }

        // Expose minimal debug hooks (do NOT change __MOTK_TABLE_INLINE_EDIT_IMPL__ shape)
        window.__MOTK_TABLE_DEBUG__ = window.__MOTK_TABLE_DEBUG__ || {};
        window.__MOTK_TABLE_DEBUG__.getNormalizedFieldMeta = function(fid) {
          return getNormalizedFieldMeta_(STATE.sheetName, fid);
        };
        window.__MOTK_TABLE_DEBUG__.isInlineEditBound = function() {
          return !!window.__MOTK_TABLE_INLINE_EDIT_BOUND;
        };

        // Enforce new-tab open for schedule index links even if browser/frame rewrites target handling.
        tableWrap.addEventListener("click", function(ev) {
          try {
            var a = ev.target && ev.target.closest ? ev.target.closest('a[href]') : null;
            if (!a) return;
            var flagged = a.getAttribute && a.getAttribute('data-sched-open-newtab') === '1';
            if (!flagged && !isScheduleEditorHref_(a.href)) return;
            if (ev.defaultPrevented) return;
            if (ev.button !== 0) return;
            if (ev.metaKey || ev.ctrlKey || ev.shiftKey || ev.altKey) return;
            ev.preventDefault();
            window.open(a.href, '_blank', 'noopener');
          } catch (_) { }
        }, true);

        function logInlineEditSkip_(reason, detail) {
          var bucket = window.__MOTK_INLINE_EDIT_LOG__ = window.__MOTK_INLINE_EDIT_LOG__ || {};
          var now = Date.now();
          var key = String(reason || 'unknown');
          if (bucket[key] && (now - bucket[key]) < 2000) return;
          bucket[key] = now;
          try { console.info("[Table] Inline edit blocked:", reason, detail || {}); } catch (_) { }
          var msg = '';
          if (reason === 'missing_fid') msg = 'Inline edit unavailable (missing field id)';
          else if (reason === 'missing_meta') msg = 'Inline edit unavailable (field meta missing)';
          else if (reason === 'not_editable') msg = 'Inline edit disabled for this field';
          if (msg) showStatus(msg, true, 2000);
        }

        function isInteractiveTarget_(el) {
          if (!el) return false;
          return !!el.closest("a, button, input, select, textarea, label, .motk-inline-editor");
        }

        function getTdFromEvent_(ev) {
          var t = ev && ev.target;
          if (!t) return null;
          return t.closest && t.closest('td[data-col-id]');
        }

        function getRowIdFromTd_(td) {
          if (!td) return "";
          if (td.dataset && td.dataset.rowid) return String(td.dataset.rowid || "");
          var tr = td.closest && td.closest("tr[data-row-id]");
          return tr ? String(tr.getAttribute("data-row-id") || "") : "";
        }

        tableWrap.addEventListener("dblclick", function(ev) {
          if (isInteractiveTarget_(ev.target)) return;
          if (STATE && STATE.isSyncing) {
            logInlineEditSkip_('syncing');
            return;
          }
          var td = getTdFromEvent_(ev);
          if (!td) return;

          var fid = String(td.getAttribute("data-col-id") || "");
          if (!fid) {
            logInlineEditSkip_('missing_fid');
            return;
          }

          var meta = getNormalizedFieldMeta_(STATE.sheetName, fid);
          if (!meta) {
            logInlineEditSkip_('missing_meta', { fid: fid });
            return;
          }
          if (meta.editable !== true) {
            logInlineEditSkip_('not_editable', { fid: fid, editable: meta.editable });
            return;
          }

          // Avoid dblclick opening checkbox editor (checkbox uses click)
          if (meta.type === "checkbox") return;

          var rowId = getRowIdFromTd_(td);
          if (!rowId) return;

          if (isLinkType_(String(meta.type || ""))) {
            openLinkPicker_(td, rowId, fid, meta);
            return;
          }
          openPrimitiveEditor_(td, rowId, fid, meta);
        }, true);

        tableWrap.addEventListener("click", function(ev) {
          if (isInteractiveTarget_(ev.target)) return;
          if (STATE && STATE.isSyncing) {
            logInlineEditSkip_('syncing');
            return;
          }
          var td = getTdFromEvent_(ev);
          if (!td) return;

          var fid = String(td.getAttribute("data-col-id") || "");
          if (!fid) {
            logInlineEditSkip_('missing_fid');
            return;
          }

          var meta = getNormalizedFieldMeta_(STATE.sheetName, fid);
          if (!meta) {
            logInlineEditSkip_('missing_meta', { fid: fid });
            return;
          }
          if (meta.editable !== true) {
            logInlineEditSkip_('not_editable', { fid: fid, editable: meta.editable });
            return;
          }

          // Only checkbox uses click-to-edit/toggle
          if (meta.type !== "checkbox") return;

          var rowId = getRowIdFromTd_(td);
          if (!rowId) return;

          // Toggle
          ev.preventDefault();
          ev.stopPropagation();

          var prevValue = _rowValueByIdFid_(rowId, fid);
          var nextValue = !isTruthyCheckbox_(prevValue);

          commitCellWrite_(rowId, fid, meta, nextValue, prevValue);
        }, true);

        try { console.info("[Table] Inline edit bound (delegated)."); } catch (_) {}

        // ---------- helpers ----------
        function closestEl_(t, sel) {
          try {
            var el = (t && t.nodeType === 1) ? t : (t && t.parentElement ? t.parentElement : null);
            return el && el.closest ? el.closest(sel) : null;
          } catch (_) { return null; }
        }

        function setCellDom_(td, rowId, fid, meta, v) {
          try {
            td.innerHTML = '';
            var entitySing = singularEntityFor(_entityForUI());
            var m = meta || {};
            if (!m || !m.type) {
              m = getNormalizedFieldMeta_(STATE.sheetName, fid);
            }
            var safeVal = _sanitizeValueForMeta_(m, v, { rowId: rowId, fid: fid, where: "setCellDom" });
            v = safeVal;
            try { 
              var idFid = resolveIdFieldId_();
              var tr = null;
              try { tr = td && td.parentElement ? td.parentElement : null; } catch (_) { tr = null; }

              var rowObj = null;
              try {
                if (STATE && STATE.rowsById && STATE.rowsById[rowId]) rowObj = STATE.rowsById[rowId];
                else if (tr && tr.__row) rowObj = tr.__row;
              } catch (_) { rowObj = null; }

              if (!rowObj) {
                rowObj = applyRowIdFields_({}, rowId);
                rowObj[idFid] = rowId;
              }

              try { rowObj[fid] = v; } catch (_) { }
              try { if (STATE) { STATE.rowsById = STATE.rowsById || {}; STATE.rowsById[rowId] = rowObj; } } catch (_) { }

              m = Object.assign({}, m, { __rowId: rowId, rowId: rowId, recordId: rowId, id: rowId, fieldId: fid, __row: rowObj });
            } catch (_) { }
            if (window.CommonRenderer && typeof CommonRenderer.renderCellByField === 'function') {
              td.appendChild(CommonRenderer.renderCellByField(entitySing, fid, v, m));
            } else {
              td.appendChild(document.createTextNode(_toScalarText_(v, { rowId: rowId, fid: fid, where: "setCellDomText" })));
            }
          } catch (_) {
            try { td.textContent = _toScalarText_(v, { rowId: rowId, fid: fid, where: "setCellDomCatch" }); } catch (__) { }
          }
        }

        function setCellDomAll_(rowId, fid, meta, v) {
          var q = '#tableWrap tr[data-row-id="' + rowId + '"] td[data-col-id="' + fid + '"]';
          var tds = document.querySelectorAll(q);
          var count = 0;
          for (var i = 0; i < tds.length; i++) {
            setCellDom_(tds[i], rowId, fid, meta, v);
            count += 1;
          }
          return count;
        }

        function isLinkType_(t) {
          t = String(t || "");
          return /_link$/.test(t);
        }

        function isTruthyCheckbox_(v) {
          return v === true || v === 1 || v === "1" || v === "TRUE" || v === "true";
        }

        function normalizeCheckboxOut_(v) {
          return !!isTruthyCheckbox_(v);
        }

        function showInlineEditError_(msg) {
          var text = msg || 'Inline edit failed';
          try { showStatus(text, true, 3500); } catch (_) { }
          try {
            var token = Date.now();
            window.__MOTK_INLINE_EDIT_BANNER_TOKEN__ = token;
            setTableBanner_('error', text);
            setTimeout(function () {
              if (window.__MOTK_INLINE_EDIT_BANNER_TOKEN__ === token) {
                setTableBanner_('error', '');
              }
            }, 6000);
          } catch (_) { }
        }

        function logWriteRejection_(reason, ctx) {
          try {
            var info = Object.assign({
              reason: reason || 'UNKNOWN',
              ts: Date.now()
            }, ctx || {});
            console.warn("[TableInlineEdit] write rejected", info);
          } catch (_) { }
        }

      function commitCellWrite_(rowId, fid, meta, nextValue, prevValue) {
        var entitySing = singularEntityFor(_entityForUI());
        var wKey = _tableWriteKey_(rowId, fid);
        var token = _newWriteToken_();
        var fieldType = String(meta && meta.type || "").toLowerCase();

          window.__MOTK_TABLE_WRITE_LWW__ = window.__MOTK_TABLE_WRITE_LWW__ || {};
          window.__MOTK_TABLE_WRITE_LWW__[wKey] = token;
          function normalizeValueForSend_(m, v) {
            var t = (m && String(m.type || "").toLowerCase()) || "";
            if (t === "checkbox") {
              if (v === true || v === false) return { ok: true, value: v };
              var sv = String(v == null ? "" : v).trim().toLowerCase();
              if (!sv) return { ok: true, value: false };
              if (sv === "true" || sv === "1" || sv === "yes" || sv === "y" || sv === "on" || sv === "checked") return { ok: true, value: true };
              if (sv === "false" || sv === "0" || sv === "no" || sv === "n" || sv === "off" || sv === "unchecked") return { ok: true, value: false };
              return { ok: false, errorCode: "INVALID_CHECKBOX_VALUE", message: "Unsupported checkbox value" };
            }
            if (t === "date") {
              if (v instanceof Date && !isNaN(v.getTime())) return { ok: true, value: v.toISOString().slice(0, 10) };
              var s = String(v == null ? "" : v).trim();
              var mIso = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
              if (mIso) return { ok: true, value: mIso[1] + "-" + mIso[2] + "-" + mIso[3] };
              return { ok: false, errorCode: "INVALID_DATE", message: "Invalid date format" };
            }
            if (t === "select") {
              if (v && typeof v === "object") {
                if (Object.prototype.hasOwnProperty.call(v, "value")) v = v.value;
              }
              var sv = String(v == null ? "" : v).trim();
              var opts = Array.isArray(m && m.options) ? m.options.map(function (o) { return String(o || "").trim(); }) : [];
              if (opts.length && opts.indexOf(sv) < 0) {
                return { ok: false, errorCode: "INVALID_SELECT_OPTION", message: "Unsupported option" };
              }
              return { ok: true, value: sv };
            }
            if (v === null || v === undefined) return { ok: true, value: "" };
            var vt = typeof v;
            if (vt === "string" || vt === "number" || vt === "boolean") return { ok: true, value: v };
            return { ok: false, errorCode: "INVALID_VALUE_TYPE", message: "Value must be scalar" };
          }

          var norm = normalizeValueForSend_(meta, nextValue);
          if (!norm.ok) {
            logWriteRejection_("CLIENT_VALIDATION_FAIL", {
              entity: entitySing,
              recordId: rowId,
              fid: fid,
              fieldType: fieldType,
              oldValue_raw: prevValue,
              oldValue_normalized: _sanitizeValueForMeta_(meta, prevValue, { rowId: rowId, fid: fid, where: "inlineEditPrev" }),
              newValue_raw: nextValue,
              newValue_normalized: norm.value || null,
              errorCode: norm.errorCode || '',
              message: norm.message || ''
            });
            showInlineEditError_('Inline edit failed: ' + (norm.errorCode || 'invalid value'));
            return Promise.resolve({ ok: false, blocked: true });
          }

          var normalizedPrev = _sanitizeValueForMeta_(meta, prevValue, { rowId: rowId, fid: fid, where: "inlineEditPrev" });

          // Optimistic update
          var safeNext = _sanitizeValueForMeta_(meta, norm.value, { rowId: rowId, fid: fid, where: "inlineEditOptimistic" });
          _markPendingWrite_(entitySing, rowId, fid, token, safeNext);
          _setRowValueByIdFid_(rowId, fid, safeNext);
          var optimisticCount = setCellDomAll_(rowId, fid, meta, safeNext);
          if (!optimisticCount) {
            try { console.warn("[TableInlineEdit] cell not found for optimistic update", { rowId: rowId, fid: fid }); } catch (_) { }
          }
          showStatus("Updating...", false, 0);

          return new Promise(function(resolve) {
            google.script.run
              .withSuccessHandler(function(resp) {
                try {
                  if (window.__MOTK_TABLE_WRITE_LWW__[wKey] !== token) {
                    logWriteRejection_("CONCURRENCY_GUARD", { entity: entitySing, recordId: rowId, fid: fid, fieldType: fieldType });
                    return resolve({ ok: true, ignored: true });
                  }
                  var payloadObj = (function () { var o = {}; o[fid] = norm.value; return o; })();
                  var respObj = resp || {};
                  var ok = (respObj && respObj.ok === true);
                  var applied = (respObj && respObj.applied !== false);
                  var match = (respObj && respObj.match === true);
                  var allowed = (respObj && Array.isArray(respObj.allowed)) ? respObj.allowed : [];

                  if (!ok || !applied || !match) {
                    try {
                      console.warn("[TableInlineEdit] write rejected", {
                        entity: entitySing,
                        fid: fid,
                        rowId: rowId,
                        payload: payloadObj,
                        response: respObj,
                        serialized: (function () { try { return JSON.stringify(respObj || {}); } catch (_) { return String(respObj || ''); } })()
                      });
                    } catch (_) { }
                    if (window.__MOTK_TABLE_WRITE_LWW__[wKey] !== token) return resolve({ ok: false, ignored: true });
                    var safePrev = _sanitizeValueForMeta_(meta, prevValue, { rowId: rowId, fid: fid, where: "inlineEditRevert" });
                    _setRowValueByIdFid_(rowId, fid, safePrev);
                    setCellDomAll_(rowId, fid, meta, safePrev);
                    var errMsg = "Inline edit failed";
                    var errCode = (respObj && (respObj.errorCode || respObj.error)) || "";
                    if (errCode) errMsg += ": " + errCode;
                    else if (respObj && respObj.message) errMsg += ": " + respObj.message;
                    if (allowed.length) errMsg += " allowed=[" + allowed.join(", ") + "]";
                    logWriteRejection_("SERVER_ERROR", {
                      entity: entitySing,
                      recordId: rowId,
                      fid: fid,
                      fieldType: fieldType,
                      oldValue_raw: prevValue,
                      oldValue_normalized: normalizedPrev,
                      newValue_raw: nextValue,
                      newValue_normalized: norm.value,
                      serverResponse: respObj,
                      reason: match ? (applied ? "ok-false" : "applied-false") : "match-false"
                    });
                    showInlineEditError_(errMsg);
                    _clearPendingWrite_(entitySing, rowId, fid, token);
                    return resolve({ ok: false, reverted: true, response: respObj });
                  }

                  try {
                    console.info("[TableInlineEdit] write ok", {
                      entity: entitySing,
                      fid: fid,
                      rowId: rowId,
                      payload: payloadObj,
                      response: respObj,
                      serialized: JSON.stringify(respObj || {})
                    });
                  } catch (_) { }

                  var finalValue = (respObj && Object.prototype.hasOwnProperty.call(respObj, 'readbackValue'))
                    ? respObj.readbackValue
                    : _extractFieldValue_(respObj, fid, norm.value);
                  var safeFinal = _sanitizeValueForMeta_(meta, finalValue, { rowId: rowId, fid: fid, where: "inlineEditReturn" });
                  _setRowValueByIdFid_(rowId, fid, safeFinal);
                  var finalCount = setCellDomAll_(rowId, fid, meta, safeFinal);
                  if (!finalCount) {
                    try { console.warn("[TableInlineEdit] cell not found for return update", { rowId: rowId, fid: fid }); } catch (_) { }
                  }
                  showStatus("Updated!", false, 1200);
                  try { STATE.lastWriteSuccessTime = Date.now(); } catch (_) { }
                  try { _setWriteBarrier_(entitySing, rowId, fid, safeFinal); } catch (_) { }
                  try { invalidateCurrentRowsCache_("inlineEdit:success"); } catch (_) { }
                  _clearPendingWrite_(entitySing, rowId, fid, token);
                  try { _applyUpdatedFieldsFromResponse_(respObj, rowId); } catch (_) { }
                  resolve({ ok: true, value: safeFinal });
                } catch (e) {
                  console.error("[TableInlineEdit] success handler error", e);
                  resolve({ ok: true, value: nextValue });
                }
              })
              .withFailureHandler(function(err) {
                try {
                  console.error("[TableInlineEdit] dp_updateEntityRecord failed", err);
                  console.warn("[TableInlineEdit] write failed", {
                    entity: entitySing,
                    fid: fid,
                    rowId: rowId,
                    payload: (function () { var o = {}; o[fid] = norm.value; return o; })(),
                    error: err,
                    serializedError: (function () { try { return JSON.stringify(err || {}); } catch (_) { return String(err || ''); } })()
                  });
                } catch (_) { }
                if (window.__MOTK_TABLE_WRITE_LWW__[wKey] !== token) return resolve({ ok: false, ignored: true });
                // Revert only if still the latest write for this cell
                var safePrev = _sanitizeValueForMeta_(meta, prevValue, { rowId: rowId, fid: fid, where: "inlineEditRevert" });
                _setRowValueByIdFid_(rowId, fid, safePrev);
                setCellDomAll_(rowId, fid, meta, safePrev);
                var msg = "Inline edit failed: " + String(err && (err.message || err.error) ? (err.message || err.error) : err || "no response");
                logWriteRejection_("SERVER_ERROR", {
                  entity: entitySing,
                  recordId: rowId,
                  fid: fid,
                  fieldType: fieldType,
                  oldValue_raw: prevValue,
                  oldValue_normalized: normalizedPrev,
                  newValue_raw: nextValue,
                  newValue_normalized: norm.value,
                  error: err
                });
                showInlineEditError_(msg);
                _clearPendingWrite_(entitySing, rowId, fid, token);
                resolve({ ok: false, reverted: true });
              })
              .sv_setRecord_v2(entitySing, rowId, (function() {
                var o = {};
                o[fid] = norm.value;
                return o;
              })());
          });
        }

        function invalidateCurrentRowsCache_(reason) {
          try {
            var payloadNow = buildServerPayload((STATE.page - 1) * resolvePageWindow(), resolveFetchLimit());
            var cacheKey = buildRowsCacheKey_(payloadNow);
            if (cacheKey) localStorage.removeItem(cacheKey);
            try { console.warn("[TableInlineEdit] rows cache invalidated", { reason: reason || '', cacheKey: cacheKey }); } catch (_) { }
            try { fetchAndRenderPage && fetchAndRenderPage(STATE.page || 1); } catch (_) { }
          } catch (_) { }
        }

        function tryShowPicker_(inputEl) {
          try {
            if (inputEl && typeof inputEl.showPicker === "function") {
              inputEl.showPicker();
            }
          } catch (e) {}
        }

        function openPrimitiveEditor_(td, rowId, fid, meta) {
          if (!meta || !meta.editable) return;

          var t = String(meta.type || "");
          if (t === "id") return;
          if (t === "originals" || t === "versions" || t === "thumbnails" || t === "file_list" || t === "json") return;

          try {
            console.info("[Table] Inline edit open", {
              entity: singularEntityFor(_entityForUI()),
              recordId: rowId,
              fid: fid,
              type: t
            });
          } catch (_) { }

          // Prevent multiple editors at once
          if (window.__MOTK_TABLE_CELL_EDIT_ACTIVE__) return;
          window.__MOTK_TABLE_CELL_EDIT_ACTIVE__ = true;

          var prevValue = _rowValueByIdFid_(rowId, fid);
          var startValue = prevValue;

          var originalHTML = td.innerHTML;
          td.classList.add("cell-editing");

          function cleanup_(restoreHTML) {
            td.classList.remove("cell-editing");
            window.__MOTK_TABLE_CELL_EDIT_ACTIVE__ = false;
            if (restoreHTML) td.innerHTML = originalHTML;
          }

          function commitAndClose_(nextValue) {
            // normalize types
            var outValue = nextValue;

            if (t === "checkbox") outValue = normalizeCheckboxOut_(nextValue);
            if (t !== "checkbox" && outValue === null) outValue = "";

            // no-op
            if (String(outValue) === String(startValue)) {
              logWriteRejection_("NO_CHANGE_NORMALIZED", {
                entity: singularEntityFor(_entityForUI()),
                recordId: rowId,
                fid: fid,
                fieldType: t,
                oldValue_raw: startValue,
                oldValue_normalized: _sanitizeValueForMeta_(meta, startValue, { rowId: rowId, fid: fid, where: "noopPrev" }),
                newValue_raw: outValue,
                newValue_normalized: _sanitizeValueForMeta_(meta, outValue, { rowId: rowId, fid: fid, where: "noopNext" })
              });
              setCellDom_(td, rowId, fid, meta, startValue);
              cleanup_(false);
              return;
            }
            cleanup_(false);
            commitCellWrite_(rowId, fid, meta, outValue, prevValue);
          }

          function cancel_() {
            cleanup_(true);
          }

          // Build editor UI
          var el;
          if (t === "select") {
            el = document.createElement("select");
            el.className = "motk-inline-editor";

            var originalValue = (startValue === null || startValue === undefined) ? "" : String(startValue).trim();
            var committed = false;
            var opts = [];
            try {
              opts = (meta && meta.options) ? meta.options : [];
              if ((!opts || !opts.length) && window.FieldsAPI && typeof FieldsAPI.getFieldOptions === "function") {
                opts = FieldsAPI.getFieldOptions(fid, meta) || [];
              }
            } catch (_) { opts = []; }

            if (!Array.isArray(opts)) opts = String(opts || "").split(/[\n\r|,]+/);
            opts = opts.map(function (x) { return String(x == null ? "" : x).trim(); }).filter(Boolean);

            // If options are missing/empty, do not allow an accidental blank write.
            if (!opts.length) {
              showStatus("Select options missing", true, 2500);
              cancel_();
              return;
            }

            if (!meta || meta.required !== true) {
              opts.unshift("");
            }
            if (originalValue && opts.indexOf(originalValue) === -1) opts.unshift(originalValue);

            opts.forEach(function (v) {
              var op = document.createElement("option");
              op.value = v;
              op.textContent = v;
              el.appendChild(op);
            });
            el.value = originalValue;

            td.innerHTML = "";
            td.appendChild(el);
            el.focus();

            var didChange = false;
            el.addEventListener("change", function() {
              didChange = true;
              if (committed) return;
              committed = true;
              commitAndClose_(el.value);
            });
            el.addEventListener("blur", function() {
              if (!didChange) { cancel_(); return; }
              if (committed) return;
              committed = true;
              commitAndClose_(el.value);
            });
            el.addEventListener("keydown", function(ev) {
              if (ev.key === "Escape") {
                ev.preventDefault();
                cancel_();
              }
            });

          } else if (t === "date") {
            el = document.createElement("input");
            el.type = "date";
            el.className = "motk-inline-editor";
            el.value = (startValue === null || startValue === undefined)
              ? ""
              : ((window.FieldsAPI && typeof FieldsAPI.normalizeDateValue === "function")
                ? FieldsAPI.normalizeDateValue(startValue)
                : String(startValue));

            td.innerHTML = "";
            td.appendChild(el);
            el.focus();
            tryShowPicker_(el);

            el.addEventListener("mousedown", function (e) { e.stopPropagation(); });
            el.addEventListener("click", function (e) { e.stopPropagation(); });

            el.addEventListener("keydown", function(ev) {
              if (ev.key === "Enter") {
                ev.preventDefault();
                commitAndClose_(el.value);
              }
              if (ev.key === "Escape") {
                ev.preventDefault();
                cancel_();
              }
            });
            el.addEventListener("blur", function() {
              commitAndClose_(el.value);
            });

          } else if (t === "text" || t === "entity_name") {
            // Use input for now (fast + stable). Multi-line can be added later if needed.
            el = document.createElement("input");
            el.type = "text";
            el.className = "motk-inline-editor";
            el.value = (startValue === null || startValue === undefined) ? "" : String(startValue);

            td.innerHTML = "";
            td.appendChild(el);
            el.focus();
            el.select();

            el.addEventListener("keydown", function(ev) {
              if (ev.key === "Enter") {
                ev.preventDefault();
                commitAndClose_(el.value);
              }
              if (ev.key === "Escape") {
                ev.preventDefault();
                cancel_();
              }
            });
            el.addEventListener("blur", function() {
              commitAndClose_(el.value);
            });

          } else if (t === "checkbox") {
            // For checkbox, we do not open an editor; toggle is handled by click handler.
            cleanup_(true);

          } else {
            // unsupported type for now
            cleanup_(true);
          }
        }

        function openLinkPicker_(td, rowId, fid, meta) {
          var type = String(meta.type || "");
          var current = _rowValueByIdFid_(rowId, fid) || "";

          if (!(window.FieldsAPI && typeof FieldsAPI.openLinkPicker === "function")) return;

          try {
            console.info("[Table] Inline edit open", {
              entity: singularEntityFor(_entityForUI()),
              recordId: rowId,
              fid: fid,
              type: type
            });
          } catch (_) { }

          FieldsAPI.openLinkPicker({
            fid: fid,
            type: type,
            value: current,
            label: (meta.label || meta.name || fid),
            commit: function (out) {
              var nextValue = (out && out.value != null) ? out.value : "";
              var prevValue = _rowValueByIdFid_(rowId, fid);
              commitCellWrite_(rowId, fid, meta, nextValue, prevValue);
              return Promise.resolve(true);
            }
          }).catch(function (err) {
            try { showStatus("Link picker error: " + String(err && err.message ? err.message : err), true, 2500); } catch (_) { }
          });
        }

        // ---------- Events ----------
        // (Delegated handlers attached above)
      }

        function _rowValueByIdFid_(rowId, fid) {
          try {
            var idFid = resolveIdFieldId_();
            var idIdx = indexOf(STATE.fieldIds, idFid);
            if (idIdx < 0) idIdx = 0;
            var colIdx = indexOf(STATE.fieldIds, fid);
            if (colIdx < 0) {
              if (STATE && STATE.rowsById && STATE.rowsById[rowId]) {
                var v = STATE.rowsById[rowId][fid];
                return v == null ? '' : v;
              }
              return '';
            }
            for (var i = 0; i < (STATE.rows || []).length; i++) {
              var r = STATE.rows[i];
            if (String(r && r[idIdx] || '').trim() === String(rowId)) {
              return r && colIdx < r.length ? r[colIdx] : '';
            }
          }
        } catch (_) { }
        return '';
      }

        function _setRowValueByIdFid_(rowId, fid, value) {
          try {
            var meta = null;
            try { meta = getNormalizedFieldMeta_(STATE.sheetName, fid); } catch (_) { meta = null; }
            var safeVal = _sanitizeValueForMeta_(meta, value, { rowId: rowId, fid: fid, where: "setRowValue" });
            var idFid = resolveIdFieldId_();
            var idIdx = indexOf(STATE.fieldIds, idFid);
            if (idIdx < 0) idIdx = 0;
            var colIdx = indexOf(STATE.fieldIds, fid);
            if (colIdx < 0) {
              STATE.rowsById = STATE.rowsById || {};
              STATE.rowsById[rowId] = STATE.rowsById[rowId] || applyRowIdFields_({}, rowId);
              STATE.rowsById[rowId][fid] = safeVal;
              return;
            }
            for (var i = 0; i < (STATE.rows || []).length; i++) {
              var r = STATE.rows[i];
            if (String(r && r[idIdx] || '').trim() === String(rowId)) {
              if (!Array.isArray(r)) return;
              r[colIdx] = safeVal;
              return;
            }
          }
        } catch (_) { }
      }

      /* ===== 16. テーブルレンダリング本体（renderCurrentPage） ===== */

      function triggerLazyFillForPage_() {
        try {
          if (!STATE || !Array.isArray(STATE.rows) || STATE.rows.length === 0) return;
          var displayFids = visibleCols();
          if (!displayFids.length) return;
          var missingFids = displayFids.filter(function (fid) {
            return indexOf(STATE.fieldIds, fid) < 0;
          });
          if (!missingFids.length) return;

          var idFid = resolveIdFieldId_();
          var idIdx = indexOf(STATE.fieldIds, idFid);
          if (idIdx < 0) idIdx = 0;

          var ids = [];
          for (var i = 0; i < STATE.rows.length; i++) {
            var v = STATE.rows[i] && STATE.rows[i][idIdx];
            if (v != null && String(v).trim()) ids.push(String(v).trim());
          }
          if (!ids.length) return;

          var ent = singularEntityFor(_entityForUI() || STATE.sheetName || '');
          var key = ent + '|' + STATE.page + '|' + perPageToString(STATE.perPage) + '|' + ids.join(',') + '|' + missingFids.join(',');
          if (STATE.__LAZY_FILL_KEY__ === key) return;
          if (STATE.__LAZY_FILL_INFLIGHT__) return;
          STATE.__LAZY_FILL_KEY__ = key;
          STATE.__LAZY_FILL_INFLIGHT__ = true;

          callFirst(['sv_getFieldValuesBatch_v1'], { entity: ent, ids: ids, fieldIds: missingFids },
            function (res) {
              STATE.__LAZY_FILL_INFLIGHT__ = false;
              if (!res || res.ok === false || !res.valuesById) return;
              STATE.rowsById = STATE.rowsById || {};
              Object.keys(res.valuesById).forEach(function (rid) {
                var rowObj = STATE.rowsById[rid] || applyRowIdFields_({}, rid);
                var vals = res.valuesById[rid] || {};
                Object.keys(vals).forEach(function (fid) {
                  rowObj[fid] = vals[fid];
                });
                STATE.rowsById[rid] = rowObj;
              });

              if (isTableDirtyForSWR_()) {
                STATE.__LAZY_FILL_DEFERRED__ = key;
                try { showStatus && showStatus("New fields loaded - Reload"); } catch (_) { }
                return;
              }
              try { renderCurrentPage(true); } catch (_) { }
            },
            function () {
              STATE.__LAZY_FILL_INFLIGHT__ = false;
            }
          );
        } catch (_) { }
      }

      function renderCurrentPage() {
        var startTime = (window.performance && typeof performance.now === 'function') ? performance.now() : Date.now();
        window.__MOTK_TABLE_TIMINGS__ = {};
        if (!window.__MOTK_TABLE_TIMINGS__.renderStart) window.__MOTK_TABLE_TIMINGS__.renderStart = startTime;
        var wrap = document.getElementById('tableWrap'); if (!wrap) return;

        // keep current table visible until the next table has the first chunk painted
        var prevScrollTop = wrap.scrollTop;
        groupHeaderHTML._last = null;

        var cols = visibleCols();
        var colIdx = [];
        for (var i = 0; i < cols.length; i++) {
          colIdx[i] = indexOf(STATE.fieldIds, cols[i]);
        }
        var colW = [];
        var headerLabels = [];
        for (var j = 0; j < cols.length; j++) {
          var fidH = cols[j];
          var idxH = colIdx[j];
          var metaH = getNormalizedFieldMeta_(STATE.sheetName, fidH);
          var mapLabel = (STATE.headersByFid && STATE.headersByFid[fidH]) ? STATE.headersByFid[fidH] : '';
          var labelH = mapLabel || ((metaH && (metaH.label || metaH.name)) ? (metaH.label || metaH.name) : fidH);
          headerLabels[j] = (idxH >= 0 ? (STATE.header[idxH] || labelH) : labelH);
          colW[j] = STATE.widths[fidH] || defaultWidthFor(fidH, headerLabels[j]);
        }

        var table = document.createElement('table');
        table.className = 'motk-table';
        var thead = document.createElement('thead');
        var tbody = document.createElement('tbody');
        table.appendChild(thead);
        table.appendChild(tbody);

        var hr = document.createElement('tr');
        for (var i2 = 0; i2 < cols.length; i2++) {
          var colId = cols[i2];
          var th = document.createElement('th');
          th.textContent = headerLabels[i2] || colId;
          th.setAttribute('data-col-id', colId);
          th.className = 'draggable';
          th.style.width = (colW[i2]) + 'px';

          var h = document.createElement('span');
          h.className = 'resize-h';
          hr.appendChild(th);
          th.appendChild(h);

          th.setAttribute('draggable', 'true');
          th.addEventListener('dragstart', onDragStart);
          th.addEventListener('dragover', function (e) {
            e.preventDefault(); e.dataTransfer.dropEffect = 'move';
          });
          th.addEventListener('drop', onDropHeader);

          h.addEventListener('mousedown', startResize(th, colId), { passive: false });
          h.addEventListener('touchstart', startResize(th, colId), { passive: false });
        }
        thead.appendChild(hr);

        var rowsSlice = STATE.rows.slice();
        var canon = _canon(STATE.sheetName);
        var vCol = findViewColId(['shotview', 'assetview', 'memberview', 'userview', 'taskview']);
        var oriCols = findOriginalsCols();

        var prevRowForGroup = STATE._prevRowForGroup || null;
        var useGrouping = !!STATE.group && STATE.group.length > 0 && !!STATE.groupEnabled;

        function isNodeWithAnchor_(n) {
          try {
            if (!n) return false;
            if (n.nodeType === 1 || n.nodeType === 11) {
              if (n.tagName && String(n.tagName).toLowerCase() === 'a') return true;
              return !!(n.querySelector && n.querySelector('a'));
            }
          } catch (_) { }
          return false;
        }

        function retargetNodeAnchors_(n, href, target) {
          try {
            if (!n || !href) return;
            if (n.nodeType !== 1 && n.nodeType !== 11) return;
            if (n.nodeType === 1) {
              var tag = (n.tagName || '').toLowerCase();
              if (tag === 'a') {
                n.href = href;
                if (target) {
                  n.target = target;
                  n.rel = 'noopener';
                  n.setAttribute('data-sched-open-newtab', '1');
                }
              }
            }
            if (n.querySelectorAll) {
              var anchors = n.querySelectorAll('a');
              for (var ai = 0; ai < anchors.length; ai++) {
                anchors[ai].href = href;
                if (target) {
                  anchors[ai].target = target;
                  anchors[ai].rel = 'noopener';
                  anchors[ai].setAttribute('data-sched-open-newtab', '1');
                }
              }
            }
          } catch (_) { }
        }

        function renderCellNode_(entitySing, fid, raw, meta, rowId, rowObj) {
          try {
            if (!(window.CommonRenderer && typeof CommonRenderer.renderCellByField === 'function')) {
              return document.createTextNode(raw == null ? '' : String(raw));
            }
            var m = meta || {};
            if (!m || !m.type) {
              m = getNormalizedFieldMeta_(STATE.sheetName, fid);
            }
            if (rowId) {
              try { 
                var idFid = resolveIdFieldId_();
                var ro = rowObj || null;
                try {
                  if (!ro && STATE && STATE.rowsById && STATE.rowsById[rowId]) ro = STATE.rowsById[rowId];
                } catch (_) { }
                if (!ro) {
                  ro = applyRowIdFields_({}, rowId);
                  ro[idFid] = rowId;
                  try { ro[fid] = raw; } catch (_) { }
                }
                try { if (STATE) { STATE.rowsById = STATE.rowsById || {}; STATE.rowsById[rowId] = ro; } } catch (_) { }
                m = Object.assign({}, m, { __rowId: rowId, rowId: rowId, recordId: rowId, id: rowId, fieldId: fid, __row: ro });
              } catch (_) { }
            }
            var safeRaw = _sanitizeValueForMeta_(m, raw, { rowId: rowId, fid: fid, where: "renderCellNode" });
            raw = safeRaw;
            if (window.__MOTK_DEBUG__ === true) {
              var dbgName = _normalizeFieldName_(m.field_name || m.name || m.label || '');
              var dbgType = String(m.type || '').toLowerCase().trim();
              var isViewField = (dbgType === 'shotview' || dbgType === 'assetview' || /view$/.test(dbgName));
              if (!isViewField) { /* skip */ }
              else {
              try {
                var key = rowId + "|" + fid;
                var byField = window.PROXY_CACHE_BY_FIELD && window.PROXY_CACHE_BY_FIELD[key];
                var byRecord = window.PROXY_CACHE && window.PROXY_CACHE[rowId];
                var dbg = debugProxyUrl_(rowId, fid);
                console.log("[MOTK][ShotView] render", {
                  entity: entitySing,
                  rowId: rowId,
                  fid: fid,
                  type: m && m.type,
                  hasByField: !!byField,
                  hasByRecord: !!byRecord,
                  proxySource: dbg.found || 'none',
                  mediaUrl: dbg.url || 'none',
                  rawLen: raw == null ? 0 : String(raw).length
                });
              } catch (_) { }
              }
            }
            var rendered = CommonRenderer.renderCellByField(entitySing, fid, raw, m);
            if (rendered && rendered.nodeType) return rendered;
            if (rendered == null) return document.createTextNode('');
            return document.createTextNode(_toScalarText_(rendered, { rowId: rowId, fid: fid, where: "renderCellNodeNonNode" }));
          } catch (_) {
            return document.createTextNode(_toScalarText_(raw, { rowId: rowId, fid: fid, where: "renderCellNodeCatch" }));
          }
        }

        function appendGroupHeaderRows_(frag, keys) {
          try {
            var tmp = document.createElement('tbody');
            tmp.innerHTML = groupHeaderHTML(keys);
            while (tmp.firstChild) frag.appendChild(tmp.firstChild);
          } catch (_) { }
        }

        function buildRowsFrag(from, to) {
          var frag = document.createDocumentFragment();
          var prevGrpKeys = null;
          var entitySing = singularEntityFor(_entityForUI());
          var idFid = resolveIdFieldId_();
          var metaByFid = {};
          try {
            for (var mi = 0; mi < STATE.fieldIds.length; mi++) {
              var mfid = STATE.fieldIds[mi];
              metaByFid[mfid] = getNormalizedFieldMeta_(STATE.sheetName, mfid);
            }
          } catch (_) { }

          for (var r = from; r < to; r++) {
            var row = rowsSlice[r];
            var rowId = resolveRowIdFromRow_(row, STATE.fieldIds);
            var rowObj = null;
            try {
              rowObj = applyRowIdFields_({}, rowId);
              rowObj[idFid] = rowId;
              for (var jj = 0; jj < STATE.fieldIds.length; jj++) {
                var fid = STATE.fieldIds[jj];
                var meta = metaByFid[fid] || null;
                var safeVal = _sanitizeValueForMeta_(meta, row[jj], { rowId: rowId, fid: fid, where: "buildRowsFrag" });
                row[jj] = safeVal;
                rowObj[fid] = safeVal;
              }
              STATE.rowsById = STATE.rowsById || {};
              STATE.rowsById[rowId] = rowObj;
            } catch (_) { rowObj = null; }

            if (useGrouping) {
              var curKeys = [];
              for (var g = 0; g < STATE.group.length; g++) {
                var gid = STATE.group[g];
                var gidx = indexOf(STATE.fieldIds, gid);
                curKeys.push(row[gidx]);
              }
              if (!prevGrpKeys) {
                var same = false;
                if (r === from && prevRowForGroup) {
                  var prevKeys = [];
                  for (var gg = 0; gg < STATE.group.length; gg++) {
                    var gid2 = STATE.group[gg];
                    var pidx = indexOf(STATE.fieldIds, gid2);
                    prevKeys.push(prevRowForGroup[pidx]);
                  }
                  same = _sameKeyArray(curKeys, prevKeys);
                }
                if (!same) appendGroupHeaderRows_(frag, curKeys);
              } else {
                for (var lv = 0; lv < curKeys.length; lv++) {
                  if (curKeys[lv] !== prevGrpKeys[lv]) {
                    appendGroupHeaderRows_(frag, curKeys.slice(0, lv + 1));
                    break;
                  }
                }
              }
              prevGrpKeys = curKeys;
            }

            var tr = document.createElement('tr');
            tr.setAttribute('data-row-id', rowId);
            try { if (rowObj) tr.__row = rowObj; } catch (_) { }

            for (var c = 0; c < cols.length; c++) {
              var fid = cols[c];
              var idx = colIdx[c];
              var raw = (idx >= 0) ? row[idx] : _rowValueByIdFid_(rowId, fid);
              var headTxt = headerLabels[c] || fid;

              var td = document.createElement('td');
              td.setAttribute('data-col-id', fid);
              td.style.width = colW[c] + 'px';
              td.style.maxWidth = colW[c] + 'px';

              var meta = getNormalizedFieldMeta_(STATE.sheetName, fid);
              if (meta && meta.editable === true) {
                if (meta.type === "checkbox") td.classList.add("motk-checkbox-cell");
                else td.classList.add("motk-cell-editable");
              }

              if (fid === vCol) {
                td.setAttribute('data-viewcell', '1');
                td.setAttribute('data-rowid', rowId);
              }

              var meta = getNormalizedFieldMeta_(STATE.sheetName, fid);
              var node = renderCellNode_(entitySing, fid, raw, meta, rowId, rowObj);
 
              var memberNameFid = null;
              try { if (window.SchemaResolver && SchemaResolver.getEntityNameFid) memberNameFid = SchemaResolver.getEntityNameFid('member'); } catch (_) { memberNameFid = null; }
              var metaName = _normalizeFieldName_(meta && (meta.field_name || meta.name || meta.label));
              if (
                (canon === 'projectmembers' || canon === 'projectmember' || canon === 'member' || canon === 'members') &&
                ((memberNameFid && fid === memberNameFid) || metaName === 'role') && isRowIdLike(rowId) &&
                !isNodeWithAnchor_(node)
              ) {
                var aPM = document.createElement('a');
                aPM.href = Router.buildEntityUrl('member', rowId);
                aPM.appendChild(node);
                node = aPM;
              } else if (shouldNameCellLinkToDetail(canon, headTxt, rowId)) {
                var ent = singularEntityFor(canon);
                var schedLike = (ent === 'sched' || ent === 'schedule' || ent === 'scheds' || ent === 'schedules');
                if (schedLike && Router && typeof Router.buildScheduleUrl === 'function') {
                  var schedHref = Router.buildScheduleUrl(rowId);
                  if (isNodeWithAnchor_(node)) {
                    retargetNodeAnchors_(node, schedHref, '_blank');
                  } else {
                    var a2s = document.createElement('a');
                    a2s.href = schedHref;
                    a2s.target = '_blank';
                    a2s.rel = 'noopener';
                    a2s.setAttribute('data-sched-open-newtab', '1');
                    a2s.appendChild(node);
                    node = a2s;
                  }
                } else if (!isNodeWithAnchor_(node)) {
                  var a2 = document.createElement('a');
                  a2.href = Router.buildEntityUrl(ent, rowId);
                  a2.appendChild(node);
                  node = a2;
                }
              } else if (/shotcode/i.test(headTxt) && isRowIdLike(rowId) && !isNodeWithAnchor_(node)) {
                var a3 = document.createElement('a');
                a3.href = Router.buildEntityUrl('shot', rowId);
                a3.appendChild(node);
                node = a3;
              }
 
              td.appendChild(node);

              tr.appendChild(td);
            }
            frag.appendChild(tr);
          }

          return frag;
        }

        function groupHeaderHTML(keys) {
          var out = ''; var lastKeys = groupHeaderHTML._last || [];
          for (var lv = 0; lv < keys.length; lv++) {
            var v = keys[lv];
            if (lastKeys[lv] === v) continue;
            var cls = (lv === 0) ? 'grp1' : 'grp2';
            var label = (v == null || v === '') ? '(empty)' : _toScalarText_(v, { where: "groupHeader", fid: '', rowId: '' });
            out += '<tr class="' + cls + '"><td colspan="' + cols.length + '"><span class="grpLabel">' + escapeHTML(label) + '</span></td></tr>';
          }
          groupHeaderHTML._last = keys.slice();
          return out;
        }

        var CHUNK_TARGET_CELLS = 1500;
        var initRows = clamp(Math.floor(CHUNK_TARGET_CELLS / Math.max(1, cols.length)), 20, 80);
        var FIRST_CHUNK = Math.min(rowsSlice.length, initRows);

        function paintFirstChunk_() {
          var frag = null;
          try { frag = buildRowsFrag(0, FIRST_CHUNK); }
          catch (e) { console.error(e); return false; }
          try { tbody.appendChild(frag); }
          catch (e2) { console.error(e2); return false; }
          try {
            var firstPaintAt = (window.performance && typeof performance.now === 'function') ? performance.now() : Date.now();
            recordPerf_('render_first_paint_ms', firstPaintAt - window.__MOTK_TABLE_TIMINGS__.renderStart);
            recordPerf_('table_first_paint_ms', firstPaintAt - window.__MOTK_TABLE_TIMINGS__.renderStart);
            markNavPerf_('table_painted_ms', firstPaintAt);
            perfMark_('table_painted');
            computePerfMeasures_();
            scheduleNavPerfSnapshot_(1200, 'table_painted');
            emitNavPerfSnapshot_('table_painted', false);
            STATE.__TABLE_FIRST_PAINT_DONE__ = true;
            try { scheduleProxyIndexPrefetch_('first_paint'); } catch (_) { }
          } catch (_) { }
          return true;
        }

        var firstChunkOk = paintFirstChunk_();
        if (!firstChunkOk) {
          try { showStatus('render failed'); } catch (_) { }
          return;
        }

        // atomic swap (no whiteout gap)
        if (wrap.replaceChildren) {
          wrap.replaceChildren(table);
        } else {
          wrap.innerHTML = '';
          wrap.appendChild(table);
        }
        wrap.scrollTop = prevScrollTop;
        recordLastTableBootPack_('firstPaint');

        if (rowsSlice.length > FIRST_CHUNK) {
          var pos = FIRST_CHUNK;
          (function addChunk() {
            if (pos >= rowsSlice.length) { finalize(); return; }
            var next = Math.min(rowsSlice.length, pos + initRows * 3);
            try { tbody.appendChild(buildRowsFrag(pos, next)); } catch (e) { console.error(e); }
            pos = next; rIC(addChunk);
          })();
        } else {
          finalize();
        }

        function finalize() {
          if (typeof updatePager === 'function') updatePager();
          setFinalStatus();
          try { window.__MOTK_TABLE_LAST_RENDER_MS__ = performance.now() - startTime; } catch (_) { }
          try {
            window.__MOTK_TABLE_TIMINGS__ = window.__MOTK_TABLE_TIMINGS__ || {};
            window.__MOTK_TABLE_TIMINGS__.postRenderStart = (window.performance && typeof performance.now === 'function') ? performance.now() : Date.now();
            if (window.__MOTK_TABLE_TIMINGS__.bootStart) {
              var now = window.__MOTK_TABLE_TIMINGS__.postRenderStart;
              recordPerf_('table_boot_ms', now - window.__MOTK_TABLE_TIMINGS__.bootStart);
            }
          } catch (_) { }
          try {
            STATE.__TABLE_RENDERED__ = true;
            captureRenderState_();
          } catch (_) { }
          triggerLazyFillForPage_();
          enqueuePostRenderJobs_();
        }
      }

      function rowHash_(row) {
        try {
          if (!Array.isArray(row)) return "";
          var out = [];
          for (var i = 0; i < row.length; i++) {
            out.push(String(row[i] == null ? "" : row[i]));
          }
          return out.join("|");
        } catch (_) {
          return "";
        }
      }

      function calcRowsSignature_(ids, rows, total) {
        try {
          var len = Array.isArray(rows) ? rows.length : 0;
          var first = "";
          var last = "";
          if (len) {
            first = resolveRowIdFromRow_(rows[0], ids || STATE.fieldIds);
            last = resolveRowIdFromRow_(rows[len - 1], ids || STATE.fieldIds);
          }
          var sig = [
            String(total == null ? "" : total),
            String(len),
            String(first || ""),
            String(last || ""),
            String(Array.isArray(ids) ? ids.length : 0)
          ].join("|");
          return sig;
        } catch (_) {
          return "";
        }
      }

      function captureRenderState_() {
        try {
          var sig = calcRowsSignature_(STATE.fieldIds, STATE.rows, STATE.total);
          STATE.__TABLE_RENDER_SIG__ = sig;
          STATE.__TABLE_COLS_KEY__ = visibleCols().join(',');
          var rows = Array.isArray(STATE.rows) ? STATE.rows : [];
          var map = {};
          for (var i = 0; i < rows.length; i++) {
            var row = rows[i];
            var rowId = resolveRowIdFromRow_(row, STATE.fieldIds);
            if (!rowId) continue;
            map[rowId] = rowHash_(row);
          }
          STATE.__ROW_HASH_BY_ID__ = map;
        } catch (_) { }
      }

      function buildRowObjFromArray_(rowId, row, ids) {
        var obj = applyRowIdFields_({}, rowId);
        var idFid = resolveIdFieldId_();
        if (idFid) obj[idFid] = rowId;
        for (var i = 0; i < ids.length; i++) {
          obj[ids[i]] = row[i];
        }
        return obj;
      }

      function updateRowCellsInPlace_(tr, row, rowId, cols, colIdx) {
        if (!tr) return;
        for (var c = 0; c < cols.length; c++) {
          var fid = cols[c];
          var idx = colIdx[c];
          var raw = (idx >= 0) ? row[idx] : _rowValueByIdFid_(rowId, fid);
          var td = tr.querySelector('td[data-col-id="' + fid + '"]');
          if (!td) continue;
          renderCellIntoTd_(td, rowId, fid, raw);
        }
      }

      function updateTableRowsInPlace_(normalized, opts) {
        opts = opts || {};
        try {
          if (!STATE.__TABLE_RENDERED__) return false;
          if (!normalized || !Array.isArray(normalized.rows)) return false;
          if (STATE.groupEnabled && STATE.group && STATE.group.length) return false;

          var wrap = document.getElementById('tableWrap');
          var table = wrap && wrap.querySelector('table');
          var tbody = table && table.tBodies && table.tBodies[0];
          if (!wrap || !table || !tbody) return false;

          var cols = visibleCols();
          if (!cols.length) return false;
          var colsKey = cols.join(',');
          if (STATE.__TABLE_COLS_KEY__ && STATE.__TABLE_COLS_KEY__ !== colsKey) return false;

          var headCount = table.tHead && table.tHead.rows[0] ? table.tHead.rows[0].cells.length : 0;
          if (headCount && headCount !== cols.length) return false;

          var sig = calcRowsSignature_(STATE.fieldIds, STATE.rows, STATE.total);
          var scrollTop = wrap.scrollTop;
          var scrollLeft = wrap.scrollLeft;

          var colIdx = [];
          var headerLabels = [];
          var colW = [];
          for (var i = 0; i < cols.length; i++) {
            var fid = cols[i];
            var idx = indexOf(STATE.fieldIds, fid);
            colIdx[i] = idx;
            var metaH = getNormalizedFieldMeta_(STATE.sheetName, fid);
            var mapLabel = (STATE.headersByFid && STATE.headersByFid[fid]) ? STATE.headersByFid[fid] : '';
            var labelH = mapLabel || ((metaH && (metaH.label || metaH.name)) ? (metaH.label || metaH.name) : fid);
            headerLabels[i] = (idx >= 0 ? (STATE.header[idx] || labelH) : labelH);
            colW[i] = STATE.widths[fid] || defaultWidthFor(fid, headerLabels[i]);
          }

          var existingOrder = [];
          var existingRows = {};
          for (var r = 0; r < tbody.rows.length; r++) {
            var tr0 = tbody.rows[r];
            var rid0 = tr0.getAttribute('data-row-id') || '';
            existingOrder.push(rid0);
            if (rid0) existingRows[rid0] = tr0;
          }

          var rows = Array.isArray(STATE.rows) ? STATE.rows : [];
          var newOrder = [];
          var newHashes = {};
          var prevHashes = STATE.__ROW_HASH_BY_ID__ || {};
          var newRowsById = {};
          var needRebuild = false;
          var hasDiff = false;
          var entitySing = singularEntityFor(_entityForUI());
          var vCol = findViewColId(['shotview', 'assetview', 'memberview', 'userview', 'taskview']);

          for (var i2 = 0; i2 < rows.length; i2++) {
            var row = rows[i2];
            var rowId = resolveRowIdFromRow_(row, STATE.fieldIds);
            if (!rowId) continue;
            newOrder.push(rowId);

            var rowHash = rowHash_(row);
            newHashes[rowId] = rowHash;

            var rowObj = buildRowObjFromArray_(rowId, row, STATE.fieldIds);
            STATE.rowsById = STATE.rowsById || {};
            STATE.rowsById[rowId] = rowObj;

            var tr = existingRows[rowId];
            if (!tr) {
              tr = document.createElement('tr');
              tr.setAttribute('data-row-id', rowId);
              try { tr.__row = rowObj; } catch (_) { }
              for (var c = 0; c < cols.length; c++) {
                var fid2 = cols[c];
                var idx2 = colIdx[c];
                var raw2 = (idx2 >= 0) ? row[idx2] : _rowValueByIdFid_(rowId, fid2);
                var td2 = document.createElement('td');
                td2.setAttribute('data-col-id', fid2);
                td2.style.width = colW[c] + 'px';
                td2.style.maxWidth = colW[c] + 'px';
                var meta2 = getNormalizedFieldMeta_(STATE.sheetName, fid2);
                if (meta2 && meta2.editable === true) {
                  if (meta2.type === "checkbox") td2.classList.add("motk-checkbox-cell");
                  else td2.classList.add("motk-cell-editable");
                }
                if (fid2 === vCol) {
                  td2.setAttribute('data-viewcell', '1');
                  td2.setAttribute('data-rowid', rowId);
                }
                renderCellIntoTd_(td2, rowId, fid2, raw2);
                tr.appendChild(td2);
              }
              newRowsById[rowId] = tr;
              needRebuild = true;
            } else {
              try { tr.__row = rowObj; } catch (_) { }
              if (prevHashes[rowId] !== rowHash) {
                hasDiff = true;
                updateRowCellsInPlace_(tr, row, rowId, cols, colIdx);
              }
            }
          }

          if (existingOrder.length !== newOrder.length || !_sameKeyArray(existingOrder, newOrder)) {
            needRebuild = true;
          }

          if (!needRebuild && !hasDiff) {
            STATE.__ROW_HASH_BY_ID__ = newHashes;
            STATE.__TABLE_RENDER_SIG__ = sig;
            STATE.__TABLE_COLS_KEY__ = colsKey;
            return true;
          }

          if (needRebuild) {
            var frag = document.createDocumentFragment();
            for (var j = 0; j < newOrder.length; j++) {
              var rid = newOrder[j];
              var tr2 = existingRows[rid] || newRowsById[rid];
              if (tr2) frag.appendChild(tr2);
            }
            tbody.innerHTML = '';
            tbody.appendChild(frag);
          }

          STATE.__ROW_HASH_BY_ID__ = newHashes;
          STATE.__TABLE_RENDER_SIG__ = sig;
          STATE.__TABLE_COLS_KEY__ = colsKey;

          try {
            wrap.scrollTop = scrollTop;
            wrap.scrollLeft = scrollLeft;
          } catch (_) { }

          try {
            if (hasProxyPreviewCols_()) {
              if (typeof window.__MOTK_PROXY_PREVIEW_REFRESH__ === "function") {
                window.__MOTK_PROXY_PREVIEW_REFRESH__();
              }
              if (window.CommonRenderer && typeof CommonRenderer.refreshPendingPreviews === "function") {
                CommonRenderer.refreshPendingPreviews(wrap);
              }
            }
          } catch (_) { }

          if (window.__MOTK_DEBUG__ === true) {
            try { console.log('[MOTK][SWR] in-place update applied', { rows: rows.length, rebuild: needRebuild }); } catch (_) { }
          }
          return true;
        } catch (_) {
          return false;
        }
      }

      function _sameKeyArray(a, b) {
        if (!a || !b) return false;
        if (a.length !== b.length) return false;
        for (var i = 0; i < a.length; i++) {
          if (a[i] !== b[i]) return false;
        }
        return true;
      }

      /* ===== 16C. 列リサイズ & 並び替えハンドラ ===== */

      (function () {
        var MIN_W = 56, MAX_W = 720;

        function applyColumnWidth(colId, px) {
          px = Math.max(MIN_W, Math.min(MAX_W, Math.round(px || 0)));
          STATE.widths[colId] = px;
          var table = document.querySelector('#tableWrap table');
          if (!table) return;
          var th = table.querySelector('thead th[data-col-id="' + colId + '"]');
          if (th) th.style.width = px + 'px';
          var tds = table.querySelectorAll('tbody td[data-col-id="' + colId + '"]');
          for (var i = 0; i < tds.length; i++) {
            tds[i].style.width = px + 'px';
            tds[i].style.maxWidth = px + 'px';
          }
          setDirty(true);
        }

        window.startResize = function (th, colId) {
          return function onDown(ev) {
            ev.preventDefault();
            ev.stopPropagation();
            var startX = (ev.touches && ev.touches[0] ? ev.touches[0].clientX : ev.clientX) || 0;
            var startW = (STATE.widths[colId] | 0) || Math.round(th.getBoundingClientRect().width);
            var moving = true;
            var wasDraggable = th.getAttribute('draggable');
            th.setAttribute('draggable', 'false');
            function onMove(e) {
              if (!moving) return;
              var x = (e.touches && e.touches[0] ? e.touches[0].clientX : e.clientX) || startX;
              var dx = x - startX;
              var w = Math.max(MIN_W, Math.min(MAX_W, startW + dx));
              applyColumnWidth(colId, w);
              if (typeof window.updateFooterPad === 'function') window.updateFooterPad();
            }
            function onUp() {
              moving = false;
              if (wasDraggable != null) th.setAttribute('draggable', wasDraggable);
              else th.removeAttribute('draggable');
              document.removeEventListener('mousemove', onMove, { passive: false });
              document.removeEventListener('mouseup', onUp, { passive: false });
              document.removeEventListener('touchmove', onMove, { passive: false });
              document.removeEventListener('touchend', onUp, { passive: false });
            }
            document.addEventListener('mousemove', onMove, { passive: false });
            document.addEventListener('mouseup', onUp, { passive: false });
            document.addEventListener('touchmove', onMove, { passive: false });
            document.addEventListener('touchend', onUp, { passive: false });
          };
        };

        window.onDragStart = function (ev) {
          try {
            var th = ev.target.closest('th[data-col-id]');
            if (!th) return;
            var colId = th.getAttribute('data-col-id');
            ev.dataTransfer.effectAllowed = 'move';
            ev.dataTransfer.setData('text/plain', colId);
            th.classList.add('dragging');
          } catch (_) { }
        };

        window.onDropHeader = function (ev) {
          ev.preventDefault();
          try {
            var srcId = ev.dataTransfer.getData('text/plain') || '';
            var thTo = ev.currentTarget || (ev.target && ev.target.closest && ev.target.closest('th[data-col-id]'));
            if (!srcId || !thTo) return;
            var dstId = thTo.getAttribute('data-col-id');
            if (!dstId || srcId === dstId) return;
            var order = (STATE.pageCfgRaw && Array.isArray(STATE.pageCfgRaw.order) && STATE.pageCfgRaw.order.length)
              ? STATE.pageCfgRaw.order.slice()
              : resolveOrder().slice();
            var vis = resolveOrder().slice();
            var sIdx = vis.indexOf(srcId);
            var dIdx = vis.indexOf(dstId);
            if (sIdx < 0 || dIdx < 0) return;
            vis.splice(dIdx, 0, vis.splice(sIdx, 1)[0]);
            var setVis = new Set(vis);
            var tail = order.filter(function (id) { return !setVis.has(id); });
            var newOrder = vis.concat(tail);
            if (!STATE.pageCfgRaw) STATE.pageCfgRaw = {};
            STATE.pageCfgRaw.order = newOrder;
            setDirty(true);
            showStatus('applying page…');
            requestAnimationFrame(function () { renderCurrentPage(false); });
          } catch (_) { }
          finally {
            var dragging = document.querySelector('thead th.dragging');
            if (dragging) dragging.classList.remove('dragging');
          }
        };

        document.addEventListener('dragover', function (ev) {
          var th = ev.target && ev.target.closest && ev.target.closest('th[data-col-id]');
          if (!th) return;
          ev.preventDefault();
          ev.dataTransfer.dropEffect = 'move';
        }, { passive: false });

        window.updateFooterPad = function () {
          try {
            var bar = document.getElementById('statusBar');
            var wrap = document.getElementById('tableWrap');
            if (!bar || !wrap) return;
            var h = Math.ceil(bar.getBoundingClientRect().height || 0);
            var sb = (wrap.scrollWidth > wrap.clientWidth) ? 12 : 0;
            var buffer = 72;
            var pad = Math.max(48, h + sb + buffer);
            document.documentElement.style.setProperty('--footer-pad', pad + 'px');
          } catch (e) { }
        };
        window.addEventListener('resize', window.updateFooterPad, { passive: true });
        window.addEventListener('orientationchange', window.updateFooterPad);
        requestAnimationFrame(window.updateFooterPad);
        setTimeout(window.updateFooterPad, 120);
        setTimeout(window.updateFooterPad, 360);
      })();

      /* ===== 17. View 列 Lazy ロード（shotview / assetview） ===== */

      function _norm(h) {
        return String(h || '').toLowerCase().replace(/[\s_-]/g, '');
      }

      function findViewColId(cands) {
        var ids = visibleCols();
        for (var i = 0; i < ids.length; i++) {
          var id = ids[i], idx = indexOf(STATE.fieldIds, id), h = _norm(STATE.header[idx]);
          for (var j = 0; j < cands.length; j++) { if (h === cands[j]) return id; }
        }
        return null;
      }

      function hasProxyPreviewCols_() {
        try {
          var ids = visibleCols();
          for (var i = 0; i < ids.length; i++) {
            var fid = ids[i];
            var idx = indexOf(STATE.fieldIds, fid);
            var meta = getNormalizedFieldMeta_(STATE.sheetName, fid);
            var t = String(meta && meta.type ? meta.type : "").trim().toLowerCase();
            if (t === "versions") return true;
            if (t === "shotview") return true;

            var cand1 = _norm(fid);
            if (/view$/.test(cand1)) return true;

            var cand2 = _norm((meta && (meta.fid || meta.field_id || meta.fieldId || meta.id)) || "");
            if (cand2 && /view$/.test(cand2)) return true;

            var cand3 = _norm((meta && (meta.name || meta.label)) || "");
            if (cand3 && /view$/.test(cand3)) return true;

            var cand4 = _norm((STATE.header && STATE.header[idx]) || "");
            if (cand4 && /view$/.test(cand4)) return true;
          }
        } catch (_) { }
        return false;
      }

      function prepareViewLazy(tableElem) {
        var vCol = findViewColId(['shotview', 'assetview', 'memberview', 'userview', 'taskview']); if (!vCol) return;
        var tbody = tableElem.tBodies[0]; if (!tbody) return;
        var wrap = document.getElementById('tableWrap'); if (!wrap) return;

        var cells = [];
        for (var i = 0; i < tbody.rows.length; i++) {
          var tr = tbody.rows[i]; var td = tr.querySelector('td[data-col-id="' + vCol + '"]'); if (!td) continue;
          td.setAttribute('data-viewcell', '1');
          if (!td.getAttribute('data-rowid')) td.setAttribute('data-rowid', tr.getAttribute('data-row-id') || '');
          td.removeAttribute('data-vdone');
          cells.push(td);
        }
        if (!cells.length) return;

        function renderIfInView(td) {
          if (!td) return;
          if (td.getAttribute('data-vdone') === '1') return;

          var vr = wrap.getBoundingClientRect();
          var rect = td.getBoundingClientRect();
          var inView = (rect.bottom >= vr.top - 200 && rect.top <= vr.bottom + 300);
          if (!inView) return;

          var sid = td.getAttribute('data-rowid') || '';
          var file = null;
          try {
            if (window.PROXY_CACHE_BY_FIELD && vCol) {
              file = window.PROXY_CACHE_BY_FIELD[sid + "|" + vCol] || null;
            }
          } catch (_) { }
          if (!file) file = PROXY_CACHE[sid] || null;
          if (!file) {
            if (td.getAttribute('data-vmiss') !== '1') {
              td.textContent = '—';
              td.setAttribute('data-vmiss', '1');
              try {
                window.__MOTK_PROXY_MISS_LOG__ = window.__MOTK_PROXY_MISS_LOG__ || {};
                var key = sid + "|" + vCol;
                if (!window.__MOTK_PROXY_MISS_LOG__[key]) {
                  window.__MOTK_PROXY_MISS_LOG__[key] = 1;
                  console.warn("[MOTK][ProxyIndex] missing preview for view cell", {
                    rowId: sid,
                    fieldId: vCol,
                    entity: _entityForUI()
                  });
                }
              } catch (_) { }
            }
            return;
          }

          renderViewCell(td, file);
          try { td.removeAttribute('data-vmiss'); } catch (_) { }
          td.setAttribute('data-vdone', '1');
        }

        function paint() {
          for (var i = 0; i < cells.length; i++) renderIfInView(cells[i]);
        }

        wrap.addEventListener('scroll', function () { requestAnimationFrame(paint); }, { passive: true });
        wrap.addEventListener('proxies:ready', function () { requestAnimationFrame(paint); });
        requestAnimationFrame(paint);
        setTimeout(paint, 250);
      }

      function renderViewCell(td, file) {
        td.innerHTML = '';
        if (!file) { return; }
        var preview = '';
        var thumb = '';
        try {
          if (typeof file === 'string') {
            preview = String(file);
          } else if (file && typeof file === 'object') {
            if (file.url) preview = String(file.url);
            else if (file.id) preview = 'https://drive.google.com/uc?export=download&id=' + encodeURIComponent(file.id);
          }
          var m = (String(preview).match(/[-\\w]{25,}/) || [])[0] || '';
          thumb = m ? ('https://drive.google.com/thumbnail?id=' + encodeURIComponent(m) + '&sz=w320') : preview;
        } catch (_) { preview = ''; thumb = ''; }
        if (!preview) { return; }
        var img = document.createElement('img');
        img.loading = 'lazy';
        img.src = thumb;
        img.title = ((file && typeof file === 'object' && file.name) ? file.name : 'open');
        img.setAttribute('data-motk-media-trigger', '1');
        img.setAttribute('data-motk-media-src', (file && typeof file === 'object' && file.url) ? String(file.url) : String(preview || ''));
        img.setAttribute('data-motk-media-title', (file && typeof file === 'object' && file.name) ? String(file.name) : '');
        img.setAttribute('data-motk-media-mime', (file && typeof file === 'object' && file.mimeType) ? String(file.mimeType) : '');
        img.style.width = '100%';
        img.style.aspectRatio = '16/9';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '6px';
        img.style.cursor = 'pointer';
        img.referrerPolicy = 'no-referrer';
        img.onerror = function () { td.textContent = ''; };
        td.appendChild(img);
      }

      /* ===== 18. リンクレンダリングヘルパ ===== */

      // Router（なければ素朴なフォールバック）
      var Router = (window.__Router__ || {
        buildEntityUrl: function (ent, id) {
          try {
            var u = new URL(location.href);
            u.searchParams.set("entity", ent);
            u.searchParams.set("id", id);
            return u.toString();
          } catch (_) {
            return (window.scriptUrl || "") + "?entity=" + encodeURIComponent(ent) + "&id=" + encodeURIComponent(id);
          }
        }
      });

      function splitTokens(s) {
        return String(s || '').split(/[,\s;|、／]+/).filter(Boolean);
      }

      function tokenExistsInAnyMap(s) {
        var parts = splitTokens(s); if (parts.length === 0) return false;
        for (var i = 0; i < parts.length; i++) {
          var t = parts[i];
          if (LINK_MAPS.assets[t] || LINK_MAPS.shots[t] || LINK_MAPS.tasks[t] || LINK_MAPS.users[t] || LINK_MAPS.members[t]) return true;
        }
        return false;
      }

      function isRowIdLike(id) { return /^[a-z]{2}_[0-9]+$/i.test(String(id || '')); }

      function isScheduleEditorHref_(href) {
        try {
          if (!href) return false;
          var u = new URL(String(href), location.href);
          var p = String(u.searchParams.get('p') || u.searchParams.get('page') || '').toLowerCase();
          if (p !== 'schedule') return false;
          var sid = String(u.searchParams.get('schedId') || u.searchParams.get('sid') || '').trim();
          return !!sid;
        } catch (_) {
          return false;
        }
      }

      function isLinkColumn(header) { return /link/i.test(String(header || '')); }

      function isLinkish(fieldId, header) {
        try {
          var meta = getNormalizedFieldMeta_(STATE.sheetName || '', fieldId) || {};
          var t = String(meta.type || "").toLowerCase().trim();
          if (t === 'entity_link' || /_link$/.test(t)) return true;
          var name = _normalizeFieldName_(meta.field_name || meta.name || meta.label || header);
          if (name.indexOf('link') >= 0) return true;
        } catch (_) { }
        return isLinkColumn(header);
      }

      function idColName() { return resolveIdFieldId_() || (STATE.fieldIds[0] || ''); }

      function isIdColumn(header, fid) {
        var h = String(header || '');
        if (/\bID\b/i.test(h)) return true;
        if (fid && fid === idColName()) return true;
        return false;
      }

      function shouldNameCellLinkToDetail(canon, header, rowId) {
        if (!rowId) return false;
        var h = _norm(header);
        if (canon === 'projectmembers' || canon === 'projectmember' || canon === 'member' || canon === 'members') {
          if (h === 'role') return true;
        }
        return /name$/.test(h);
      }

      function renderLinkId(pid) {
        var label = pid, ent = '';
        if (LINK_MAPS.assets[pid]) { label = LINK_MAPS.assets[pid]; ent = 'asset'; }
        else if (LINK_MAPS.shots[pid]) { label = LINK_MAPS.shots[pid]; ent = 'shot'; }
        else if (LINK_MAPS.tasks[pid]) { label = LINK_MAPS.tasks[pid]; ent = 'task'; }
        else if (LINK_MAPS.users[pid]) { label = LINK_MAPS.users[pid]; ent = 'user'; }
        else if (LINK_MAPS.members[pid]) { label = LINK_MAPS.members[pid]; ent = 'member'; }

        if (!ent) { ent = guessEntityFromId(pid); }

        // Use Router URL builders; sched should open in a new tab.
        var url = Router.buildEntityUrl(ent, pid);
        var target = (ent === 'sched' || ent === 'schedule' || ent === 'scheds' || ent === 'schedules')
          ? ' target="_blank" rel="noopener" data-sched-open-newtab="1"'
          : '';
        return '<a href="' + escapeHTML(url) + '"' + target + ' title="' + escapeHTML(pid) + '">' + escapeHTML(label) + '</a>';
      }

      function guessEntityFromId(id) {
        if (/^as_/i.test(id)) return 'asset';
        if (/^sh_/i.test(id)) return 'shot';
        if (/^tk_/i.test(id)) return 'task';
        if (/^u_/i.test(id)) return 'user';
        if (/^(pm|mem)_/i.test(id)) return 'member';
        if (/^sched_/i.test(id)) return 'sched';
        return 'item';
      }

      /* ===== 19. カラムパネル（Fields） ===== */

      document.getElementById('columnsBtn').addEventListener('click', function () {
        openPanel('colPanel', this, buildColsPanel);
      });

      function buildColsPanel(panel) {
        panel.style.minWidth = '240px';
        panel.style.maxWidth = '480px';
        panel.innerHTML = '';
        var actions = document.createElement('div'); actions.className = 'row';
        var addBtn = document.createElement('button'); addBtn.className = 'btn'; addBtn.textContent = 'Add New';
        addBtn.onclick = function () {
          if (window.closeAllPanels) window.closeAllPanels();
          openFieldWizardAdd_();
        };
        actions.appendChild(addBtn);
        panel.appendChild(actions);
        var ids = STATE.fieldIds.slice();
        for (var i = 0; i < ids.length; i++) {
          var colId = ids[i]; if (!colId) continue;
          var idx = indexOf(STATE.fieldIds, colId);
          var label = STATE.header[idx] || colId;
          var row = document.createElement('div'); row.className = 'row';
          var cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = !STATE.hiddenCols[colId];
          cb.onchange = (function (colIdRef) {
            return function () {
              STATE.hiddenCols[colIdRef] = !this.checked; setDirty(true);
              showStatus('applying page…'); requestAnimationFrame(function () { renderCurrentPage(false); });
            };
          })(colId);
          var span = document.createElement('span'); span.textContent = label;
          row.appendChild(cb); row.appendChild(span); panel.appendChild(row);
        }
      }

      function refreshFieldTypesAfterChange_(reason) {
        try { localStorage.removeItem('MOTK_APPDATA_CACHE_V1'); } catch (_) { }
        try { window.FIELD_TYPES = {}; } catch (_) { }
        try { window.__MOTK_APPDATA_PROMISE__ = null; } catch (_) { }
        if (window.FieldsAPI && typeof FieldsAPI.ensureAppDataLoaded === 'function') {
          return FieldsAPI.ensureAppDataLoaded(reason || 'fields:update');
        }
        return Promise.resolve(null);
      }

      function prunePageConfigOrder_(reason) {
        try {
          var ent = (STATE && STATE.sheetName) ? STATE.sheetName : '';
          if (!ent || !STATE || !STATE.pageCfgRaw || !Array.isArray(STATE.pageCfgRaw.order)) return false;
          var allowed = buildAllowedFieldIdSetForEntity_(ent);
          if (!allowed) return false;
          var src = STATE.pageCfgRaw.order;
          var out = [];
          var removed = [];
          for (var i = 0; i < src.length; i++) {
            var fid = src[i];
            if (fid && allowed[fid]) out.push(fid);
            else if (fid) removed.push(fid);
          }
          if (out.length === src.length) return false;
          STATE.pageCfgRaw.order = out;
          STATE.__LAST_PRUNED_FIELDS__ = removed.slice();
          STATE.__LAST_PRUNED_REASON__ = String(reason || '');
          try { console.warn('[Table] pruned page config order', { reason: reason || '', before: src.length, after: out.length, entity: ent, pageId: STATE.pageId }); } catch (_) { }
          try {
            if (typeof saveCurrentPageConfig === 'function') {
              saveCurrentPageConfig();
            }
          } catch (_) { }
          return true;
        } catch (_) { }
        return false;
      }

      function pruneStateFieldIdsAfterSchema_(reason) {
        try {
          if (STATE.__PRUNE_STATE_FIELDS__) return false;
          STATE.__PRUNE_STATE_FIELDS__ = true;
          var ent = (STATE && STATE.sheetName) ? STATE.sheetName : '';
          try { purgeInvalidFieldTypesForEntity_(ent, reason || 'schema:prune'); } catch (_) { }
          var allowed = buildAllowedFieldIdSetForEntity_(ent);
          if (!allowed || !Array.isArray(STATE.fieldIds) || !STATE.fieldIds.length) {
            STATE.__PRUNE_STATE_FIELDS__ = false;
            return false;
          }
          var before = STATE.fieldIds.map(function (fid) { return String(fid || '').trim(); }).filter(Boolean);
          var keepIdx = [];
          var after = [];
          var removed = [];
          for (var i = 0; i < before.length; i++) {
            var fid = before[i];
            if (allowed[fid]) {
              keepIdx.push(i);
              after.push(fid);
            } else {
              removed.push(fid);
            }
          }
          if (!removed.length) {
            STATE.__PRUNE_STATE_FIELDS__ = false;
            return false;
          }
          try {
            if (STATE.hiddenCols) {
              removed.forEach(function (fid0) { delete STATE.hiddenCols[fid0]; });
            }
            if (STATE.widths) {
              removed.forEach(function (fid1) { delete STATE.widths[fid1]; });
            }
          } catch (_) { }
          var header = Array.isArray(STATE.header) ? STATE.header : [];
          var newHeader = [];
          for (var h = 0; h < keepIdx.length; h++) {
            var idx = keepIdx[h];
            var lbl = header[idx] != null ? String(header[idx]) : '';
            newHeader.push(lbl || after[h] || '');
          }
          var newColumns = [];
          if (Array.isArray(STATE.columns) && STATE.columns.length) {
            if (STATE.columns.length === before.length) {
              for (var c = 0; c < keepIdx.length; c++) newColumns.push(STATE.columns[keepIdx[c]]);
            } else {
              var colById = {};
              for (var ci = 0; ci < STATE.columns.length; ci++) {
                var col = STATE.columns[ci] || {};
                var fidc = String(col.fid || col.fieldId || col.id || col.field_id || '').trim();
                if (fidc) colById[fidc] = col;
              }
              for (var cj = 0; cj < after.length; cj++) {
                var fid2 = after[cj];
                newColumns.push(colById[fid2] || { id: fid2, fieldId: fid2, label: newHeader[cj] || fid2 });
              }
            }
          }
          var rows = Array.isArray(STATE.rows) ? STATE.rows : [];
          var newRows = [];
          for (var r = 0; r < rows.length; r++) {
            var row = rows[r] || [];
            var nr = [];
            for (var k = 0; k < keepIdx.length; k++) nr.push(row[keepIdx[k]]);
            newRows.push(nr);
          }

          STATE.fieldIds = after;
          STATE.header = newHeader;
          if (newColumns.length) STATE.columns = newColumns;
          STATE.rows = newRows;
          STATE.__COLS_KEY__ = after.join('|');
          try { STATE.rowsById = {}; } catch (_) { }
          try {
            if (STATE.fieldsMeta) {
              removed.forEach(function (fid3) { delete STATE.fieldsMeta[fid3]; });
            }
            if (STATE.headersByFid) {
              removed.forEach(function (fid4) { delete STATE.headersByFid[fid4]; });
            }
          } catch (_) { }
          try { prunePageConfigOrder_(reason || 'schema:prune'); } catch (_) { }
          try { reconcileStoredViewerFieldIds_(ent, reason || 'schema:prune'); } catch (_) { }
          try { saveColManifest_(STATE.pageId, ent, after, 'schema:prune'); } catch (_) { }
          try {
            var snap = readStoredViewerSnapshot_();
            if (snap && Array.isArray(snap.fieldIds)) {
              snap.fieldIds = after.slice();
              snap.colsKey = after.join('|');
              snap._reconciledAt = Date.now();
              snap._reconciledReason = String(reason || '');
              snap._removedFieldIds = removed.slice();
              writeStoredViewerSnapshot_(snap);
            }
          } catch (_) { }
          try { console.warn('[Table] pruned state fieldIds', { entity: ent, removed: removed, reason: reason || '' }); } catch (_) { }
          try { showStatus('Removed invalid fields: ' + removed.length); } catch (_) { }
          try { renderCurrentPage && renderCurrentPage(true); } catch (_) { }
          STATE.__PRUNE_STATE_FIELDS__ = false;
          return true;
        } catch (_) {
          STATE.__PRUNE_STATE_FIELDS__ = false;
        }
        return false;
      }

      function removeFieldIdFromPageOrder_(fid, reason) {
        try {
          if (!fid || !STATE || !STATE.pageCfgRaw || !Array.isArray(STATE.pageCfgRaw.order)) return false;
          var idx = STATE.pageCfgRaw.order.indexOf(fid);
          if (idx < 0) return false;
          STATE.pageCfgRaw.order = STATE.pageCfgRaw.order.filter(function (x) { return x !== fid; });
          STATE.__LAST_PRUNED_FIELDS__ = [fid];
          STATE.__LAST_PRUNED_REASON__ = String(reason || 'removeFieldId');
          try { console.warn('[Table] removed fieldId from page order', { fid: fid, reason: reason || '' }); } catch (_) { }
          try {
            if (typeof saveCurrentPageConfig === 'function') {
              saveCurrentPageConfig();
            }
          } catch (_) { }
          return true;
        } catch (_) { }
        return false;
      }

      var FIELD_WIZARD_ALLOWED_TYPES = [
        'text', 'checkbox', 'select', 'date', 'id', 'entity_name', 'json',
        'thumbnails', 'file_list', 'originals', 'versions',
        'shot_link', 'asset_link', 'task_link', 'member_link', 'user_link'
      ];

      function closeAllDialogs_() {
        try {
          var dialogs = document.querySelectorAll('[role="dialog"][aria-modal="true"]');
          for (var i = 0; i < dialogs.length; i++) {
            dialogs[i].classList.remove('show');
          }
        } catch (_) { }
        try {
          var masks = document.querySelectorAll('#pgSaveAsMask,#fieldWizardMask');
          for (var j = 0; j < masks.length; j++) {
            masks[j].classList.remove('show');
          }
        } catch (_) { }
      }

      function openFieldWizardAdd_() {
        try {
          if (window.__MOTK_FIELD_WIZARD_BUSY__) return;
          if (window.closeAllPanels) window.closeAllPanels();
          if (window.closePanelById) window.closePanelById('colPanel');
          closeAllDialogs_();
          initFieldWizardModal_();
          var ent = (STATE && STATE.sheetName) ? STATE.sheetName : '';
          var fieldId = document.getElementById('fwFieldId');
          var entity = document.getElementById('fwEntity');
          var label = document.getElementById('fwLabel');
          var type = document.getElementById('fwType');
          var editable = document.getElementById('fwEditable');
          var required = document.getElementById('fwRequired');
          var options = document.getElementById('fwOptions');
          var core = document.getElementById('fwCore');
          if (fieldId) fieldId.value = 'auto';
          if (entity) entity.value = ent;
          if (label) label.value = '';
          if (type) type.value = 'text';
          if (editable) editable.checked = true;
          if (required) required.checked = false;
          if (options) options.value = '';
          if (core) core.checked = false;
          updateFieldWizardOptionsState_();
          showFieldWizard_();
        } catch (e) {
          window.__MOTK_FIELD_WIZARD_BUSY__ = false;
        }
      }

      function initFieldWizardModal_() {
        if (initFieldWizardModal_._done) return;
        initFieldWizardModal_._done = true;
        var mask = document.getElementById('fieldWizardMask');
        var dialog = document.getElementById('fieldWizard');
        var cancel = document.getElementById('fwCancel');
        var save = document.getElementById('fwSave');
        var type = document.getElementById('fwType');
        if (mask) mask.addEventListener('click', hideFieldWizard_);
        if (cancel) cancel.addEventListener('click', hideFieldWizard_);
        if (save) save.addEventListener('click', submitFieldWizard_);
        if (type) {
          type.addEventListener('change', function () {
            updateFieldWizardOptionsState_();
          });
        }
        if (dialog) {
          dialog.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') hideFieldWizard_();
          });
        }
      }

      function updateFieldWizardOptionsState_() {
        try {
          var typeEl = document.getElementById('fwType');
          var optionsEl = document.getElementById('fwOptions');
          if (!typeEl || !optionsEl) return;
          var t = String(typeEl.value || '').trim().toLowerCase();
          var allow = (t === 'select');
          optionsEl.disabled = !allow;
          if (!allow) optionsEl.value = '';
        } catch (_) { }
      }

      function showFieldWizard_() {
        var mask = document.getElementById('fieldWizardMask');
        var dialog = document.getElementById('fieldWizard');
        try { if (window.closeAllPanels) window.closeAllPanels(); } catch (_) { }
        closeAllDialogs_();
        if (mask) mask.classList.add('show');
        if (dialog) dialog.classList.add('show');
      }

      function hideFieldWizard_() {
        var mask = document.getElementById('fieldWizardMask');
        var dialog = document.getElementById('fieldWizard');
        if (mask) mask.classList.remove('show');
        if (dialog) dialog.classList.remove('show');
      }

      function submitFieldWizard_() {
        try {
          if (window.__MOTK_FIELD_WIZARD_BUSY__) return;
          var ent = (STATE && STATE.sheetName) ? STATE.sheetName : '';
          var labelEl = document.getElementById('fwLabel');
          var typeEl = document.getElementById('fwType');
          var editableEl = document.getElementById('fwEditable');
          var requiredEl = document.getElementById('fwRequired');
          var optionsEl = document.getElementById('fwOptions');
          var coreEl = document.getElementById('fwCore');
          var label = labelEl ? String(labelEl.value || '').trim() : '';
          var type = typeEl ? String(typeEl.value || '').trim() : '';
          var rawOptions = optionsEl ? String(optionsEl.value || '').trim() : '';
          var editable = !!(editableEl && editableEl.checked);
          var required = !!(requiredEl && requiredEl.checked);
          var isCore = !!(coreEl && coreEl.checked);
          if (!label) {
            showStatus('field name is required');
            return;
          }
          if (!type) type = 'text';
          type = type.toLowerCase();
          if (FIELD_WIZARD_ALLOWED_TYPES.indexOf(type) < 0) {
            showStatus('invalid field type');
            return;
          }
          var options = [];
          if (type === 'select' && rawOptions) {
            options = rawOptions.split(/[\n,]/).map(function (s) { return String(s || '').trim(); }).filter(Boolean);
          }
          var payload = {
            entity: ent,
            label: label,
            type: type,
            editable: editable,
            required: required,
            isCore: isCore,
            options: options,
            uiSection: ''
          };
          try { console.info('[MOTK][FieldWizard] add start', { payload: payload }); } catch (_) { }
          window.__MOTK_FIELD_WIZARD_BUSY__ = true;
          showStatus('adding field...');
          hideFieldWizard_();
          callFirst(['sv_fieldsAdd_v1'], payload, function (res) {
            if (!res || res.ok === false) {
              window.__MOTK_FIELD_WIZARD_BUSY__ = false;
              var err = res && (res.error || res.message || res.reason) ? String(res.error || res.message || res.reason) : '';
              var code = res && res.errorCode ? String(res.errorCode) : '';
              if (res && Array.isArray(res.missing) && res.missing.length) {
                err = err + (err ? " " : "") + "missing=" + res.missing.join(",");
              }
              var msg = 'add failed' + (code ? (' [' + code + ']') : '') + (err ? (': ' + err) : '');
              showStatus(msg);
              try { if (res && res.fieldId) removeFieldIdFromPageOrder_(String(res.fieldId), 'fields:add:fail'); } catch (_) { }
              try { reconcileStoredViewerFieldIds_(ent, 'fields:add:fail'); } catch (_) { }
              try { pruneStateFieldIdsAfterSchema_('fields:add:fail'); } catch (_) { }
              try { console.warn('[MOTK][FieldWizard] add failed', { payload: payload, response: res, serialized: JSON.stringify(res || {}) }); } catch (_) { }
              return;
            }
            var fid = res.fieldId ? String(res.fieldId) : '';
            if (!fid) {
              window.__MOTK_FIELD_WIZARD_BUSY__ = false;
              showStatus('add failed: missing field id');
              try { reconcileStoredViewerFieldIds_(ent, 'fields:add:missingId'); } catch (_) { }
              try { pruneStateFieldIdsAfterSchema_('fields:add:missingId'); } catch (_) { }
              try { console.warn('[MOTK][FieldWizard] add failed: missing fieldId', { payload: payload, response: res }); } catch (_) { }
              return;
            }
            try {
              console.info('[MOTK][FieldWizard] add ok', {
                fieldId: fid,
                fieldsRowIndex: res.fieldsRowIndex,
                entityHeaderCol: res.entityHeaderCol,
                fieldsSheetName: res.fieldsSheetName,
                entitySheetName: res.entitySheetName,
                schemaSig: res.schemaSig,
                schemaRefreshed: res.schemaRefreshed
              });
            } catch (_) { }
            var metaFromRes = (res && res.fieldMeta && typeof res.fieldMeta === 'object') ? res.fieldMeta : null;
            var returnedFieldIds = Array.isArray(res && res.fieldIds) ? res.fieldIds.map(function (x) { return String(x || '').trim(); }).filter(Boolean) : [];
            var ensureMetaFromResponse = function () {
              try {
                if (!metaFromRes) return;
                var entKey = canonEntityKey_(ent || '', ent || '');
                window.FIELD_TYPES = window.FIELD_TYPES || {};
                if (!window.FIELD_TYPES[entKey]) window.FIELD_TYPES[entKey] = {};
                var existing = window.FIELD_TYPES[entKey][fid] || {};
                window.FIELD_TYPES[entKey][fid] = Object.assign({}, existing, metaFromRes);
                try {
                  if (STATE) {
                    STATE.fieldsMeta = STATE.fieldsMeta || {};
                    STATE.fieldsMeta[fid] = metaFromRes;
                  }
                } catch (_) { }
                if (!window.__MOTK_FIELD_TYPES_SOURCE__) window.__MOTK_FIELD_TYPES_SOURCE__ = 'fields:add:response';
              } catch (_) { }
            };
            var afterRefresh = function () {
              ensureMetaFromResponse();
              var hasMeta = false;
              var metaLabel = '';
              var metaType = '';
              try {
                hasMeta = !!(window.FIELD_TYPES && window.FIELD_TYPES[ent] && window.FIELD_TYPES[ent][fid]);
                if (hasMeta) {
                  metaLabel = String(window.FIELD_TYPES[ent][fid].label || '').trim();
                  metaType = String(window.FIELD_TYPES[ent][fid].type || '').trim().toLowerCase();
                }
              } catch (_) { }
              var allowed = null;
              try { allowed = buildAllowedFieldIdSetForEntity_(ent); } catch (_) { }
              if (returnedFieldIds.length && returnedFieldIds.indexOf(fid) < 0) {
                window.__MOTK_FIELD_WIZARD_BUSY__ = false;
                showStatus('add failed: field id missing from server list');
                try { removeFieldIdFromPageOrder_(fid, 'fields:add:missingFromResponse'); } catch (_) { }
                try { reconcileStoredViewerFieldIds_(ent, 'fields:add:missingFromResponse'); } catch (_) { }
                try { pruneStateFieldIdsAfterSchema_('fields:add:missingFromResponse'); } catch (_) { }
                try { console.warn('[MOTK][FieldWizard] add failed: fid not in returned fieldIds', { fid: fid, returnedFieldIds: returnedFieldIds }); } catch (_) { }
                return;
              }
              var inSchema = !!(allowed && allowed[fid]);
              if (!hasMeta || !metaLabel || !metaType || !inSchema) {
                window.__MOTK_FIELD_WIZARD_BUSY__ = false;
                showStatus('add failed: field meta not found');
                try { removeFieldIdFromPageOrder_(fid, 'fields:add:missingMeta'); } catch (_) { }
                try { reconcileStoredViewerFieldIds_(ent, 'fields:add:missingMeta'); } catch (_) { }
                try { pruneStateFieldIdsAfterSchema_('fields:add:missingMeta'); } catch (_) { }
                try { console.warn('[MOTK][FieldWizard] add failed: meta not found', { fieldId: fid, entity: ent, payload: payload, inSchema: inSchema }); } catch (_) { }
                return;
              }
              if (STATE && STATE.pageCfgRaw && Array.isArray(STATE.pageCfgRaw.order)) {
                if (STATE.pageCfgRaw.order.indexOf(fid) < 0) {
                  STATE.pageCfgRaw.order.push(fid);
                }
              }
              try { runSchemaMembershipSweep_(ent, 'fields:add'); } catch (_) { }
              try {
                if (typeof saveCurrentPageConfig === 'function') {
                  saveCurrentPageConfig();
                } else {
                  renderCurrentPage && renderCurrentPage(true);
                }
              } catch (_) { }
              try {
                var payloadNow = buildServerPayload((STATE.page - 1) * resolvePageWindow(), resolveFetchLimit());
                var cacheKey = buildRowsCacheKey_(payloadNow);
                if (cacheKey) localStorage.removeItem(cacheKey);
              } catch (_) { }
              try { fetchAndRenderPage && fetchAndRenderPage(STATE.page || 1); } catch (_) { }
              hideFieldWizard_();
              showStatus('field added: ' + fid);
              window.__MOTK_FIELD_WIZARD_BUSY__ = false;
            };
            var p = refreshFieldTypesAfterChange_('fields:add');
            if (p && typeof p.then === 'function') {
              p.then(afterRefresh).catch(afterRefresh);
            } else {
              afterRefresh();
            }
          }, function (err) {
            window.__MOTK_FIELD_WIZARD_BUSY__ = false;
            var errMsg = '';
            try {
              if (err && typeof err === 'object') errMsg = JSON.stringify(err);
              else errMsg = String(err || '').trim();
            } catch (_) {
              errMsg = String(err || '').trim();
            }
            showStatus('add failed' + (errMsg ? (': ' + errMsg) : ''));
            try { console.warn('[MOTK][FieldWizard] add failed', { payload: payload, error: errMsg, rawError: err }); } catch (_) { }
          });
        } catch (_) {
          window.__MOTK_FIELD_WIZARD_BUSY__ = false;
        }
      }

      /* ===== 20. ソートパネル ===== */

      document.getElementById('sortBtn').addEventListener('click', function () {
        openPanel('sortPanel', this, buildSortPanel);
      });

      function buildSortPanel(panel) {
        panel.style.minWidth = '320px';
        panel.style.maxWidth = '640px';
        panel.innerHTML = '';

        var localSort = [];
        var src = Array.isArray(STATE.sort) ? STATE.sort : [];
        for (var i = 0; i < src.length; i++) {
          var it = src[i] || {};
          localSort.push({ id: (it.id || ''), dir: (it.dir === 'desc' ? 'desc' : 'asc'), on: (it.on !== false), group: false });
        }

        var gset = {};
        if (Array.isArray(STATE.group)) {
          for (var gi = 0; gi < STATE.group.length; gi++) {
            gset[String(STATE.group[gi] || '')] = 1;
          }
        }
        for (var k = 0; k < localSort.length; k++) {
          if (localSort[k].id && gset[localSort[k].id]) localSort[k].group = true;
        }

        var wrap = document.createElement('div'); panel.appendChild(wrap);

        function body() {
          wrap.innerHTML = '';

          var rulesBox = document.createElement('div'); wrap.appendChild(rulesBox);
          for (var r = 0; r < localSort.length; r++) {
            (function (idx) {
              var it = localSort[idx];
              var row = document.createElement('div'); row.className = 'row';

              var eg = document.createElement('div');
              eg.style.display = 'flex'; eg.style.alignItems = 'center'; eg.style.gap = '10px';

              var enLab = document.createElement('label');
              var en = document.createElement('input'); en.type = 'checkbox'; en.checked = (it.on !== false);
              en.onchange = function () { it.on = this.checked; };
              enLab.appendChild(en); enLab.appendChild(document.createTextNode('Enable'));

              var gpLab = document.createElement('label'); gpLab.style.marginLeft = '6px';
              var gp = document.createElement('input'); gp.type = 'checkbox'; gp.checked = !!it.group;
              gp.onchange = function () { it.group = this.checked; };
              gpLab.appendChild(gp); gpLab.appendChild(document.createTextNode('Group'));

              eg.appendChild(enLab); eg.appendChild(gpLab);

              var sel = document.createElement('select');
              var cols = STATE.fieldIds.slice();
              for (var c = 0; c < cols.length; c++) {
                var fid = cols[c]; if (!fid) continue;
                var idxx = indexOf(STATE.fieldIds, fid);
                var opt = document.createElement('option'); opt.value = fid; opt.textContent = STATE.header[idxx] || fid;
                sel.appendChild(opt);
              }
              sel.value = it.id || ''; sel.onchange = function () { it.id = this.value; };

              var dirBtn = document.createElement('button'); dirBtn.className = 'btn';
              function paintDir() { dirBtn.textContent = (it.dir === 'desc' ? '↓' : '↑'); }
              paintDir();
              dirBtn.onclick = function () { it.dir = (it.dir === 'desc' ? 'asc' : 'desc'); paintDir(); };

              var del = document.createElement('button'); del.className = 'btn'; del.textContent = '×';
              del.onclick = function () { localSort.splice(idx, 1); body(); };

              row.appendChild(eg);
              row.appendChild(sel);
              row.appendChild(dirBtn);
              row.appendChild(del);
              rulesBox.appendChild(row);
            })(r);
          }

          var bar = document.createElement('div'); bar.className = 'row'; bar.style.marginTop = '6px';
          var add = document.createElement('button'); add.className = 'btn'; add.textContent = '+ add';
          add.onclick = function () { localSort.push({ id: '', dir: 'asc', on: true, group: false }); body(); };

          var apply = document.createElement('button'); apply.className = 'btn'; apply.textContent = 'Apply';
          apply.onclick = function () {
            var newGroup = [], newSort = [];
            for (var i2 = 0; i2 < localSort.length; i2++) {
              var it2 = localSort[i2];
              newSort.push({ id: it2.id, dir: it2.dir, on: (it2.on !== false) });
              if (it2.group && it2.id) newGroup.push(it2.id);
            }
            STATE.sort = newSort;
            STATE.group = newGroup;
            fetchAndRenderPage(1);
          };

          var reset = document.createElement('button'); reset.className = 'btn'; reset.textContent = 'Reset';
          reset.onclick = function () {
            STATE.sort = [];
            STATE.group = [];
            fetchAndRenderPage(1);
            localSort = [];
            body();
          };

          bar.appendChild(add);
          var spacer = document.createElement('span'); spacer.className = 'spacer'; bar.appendChild(spacer);
          bar.appendChild(apply);
          bar.appendChild(reset);
          wrap.appendChild(bar);
        }
        body();
      }

      /* ===== 21. Distinct 値キャッシュ & refreshDistinctCache ===== */

      var DISTINCT_CACHE = {};

      function addDistinctSamples(fieldId, rows) {
        try {
          var key = (STATE && STATE.sheetName ? STATE.sheetName : '') + '|' + fieldId;
          var set = DISTINCT_CACHE[key] || (DISTINCT_CACHE[key] = Object.create(null));
          var idx = indexOf(STATE && STATE.fieldIds, fieldId); if (idx < 0) return;
          var lim = Math.min(Array.isArray(rows) ? rows.length : 0, 1000);
          for (var r = 0; r < lim; r++) {
            var v = rows[r][idx];
            if (v == null || v === '') continue;
            String(v).split(/[,\s;|、／]+/).filter(Boolean).forEach(function (x) { set[x] = 1; });
          }
        } catch (_) { }
      }

      function distinctValuesAll(fieldId, limit) {
        var key = (STATE && STATE.sheetName ? STATE.sheetName : '') + '|' + fieldId;
        var arr = Object.keys(DISTINCT_CACHE[key] || {});
        arr.sort();
        if (limit && arr.length > limit) arr = arr.slice(0, limit);
        return arr;
      }

      function refreshDistinctCache() {
        try {
          var fids = (STATE && Array.isArray(STATE.fieldIds)) ? STATE.fieldIds : [];
          var rows = (STATE && Array.isArray(STATE.rows)) ? STATE.rows.slice(0, 1000) : [];
          for (var i = 0; i < fids.length; i++) { addDistinctSamples(fids[i], rows); }
        } catch (_) { }
      }

      /* ===== 22. フィルタパネル V3 ===== */

      document.getElementById('filterBtn').addEventListener('click', function () {
        openPanel('filterPanel', this, buildFilterPanelV3);
      });

      function buildFilterPanelV3(panel) {
        panel.style.minWidth = '320px';
        panel.style.maxWidth = '640px';
        panel.innerHTML = '';
        function defaultEmptyRule() { return { id: '', op: 'isempty', value: '', values: [] }; }
        function defaultGroup() { return { id: rid(), name: 'Group 1', mode: 'any', rules: [defaultEmptyRule()] }; }

        var localFG = [];
        if (Array.isArray(STATE.filterGroups) && STATE.filterGroups.length) {
          for (var i = 0; i < STATE.filterGroups.length; i++) {
            var g = deepCopy(STATE.filterGroups[i] || {});
            if (!Array.isArray(g.rules) || g.rules.length === 0) g.rules = [defaultEmptyRule()];
            localFG.push(g);
          }
        } else {
          localFG = [defaultGroup()];
        }
        var localCombine = (STATE.groupCombine === 'any') ? 'any' : 'all';

        var wrap = document.createElement('div'); panel.appendChild(wrap);

        function buildRuleRow(r, onRemove) {
          var row = document.createElement('div'); row.className = 'row'; row.style.alignItems = 'flex-start';

          var sel = document.createElement('select');
          var cols = STATE.fieldIds.slice();
          for (var k = 0; k < cols.length; k++) {
            var id = cols[k]; if (!id) continue;
            var idx = indexOf(STATE.fieldIds, id);
            var opt = document.createElement('option'); opt.value = id; opt.textContent = STATE.header[idx] || id;
            sel.appendChild(opt);
          }
          sel.value = r.id || ''; sel.onchange = function () { r.id = this.value; };

          var op = document.createElement('select');
          function setOpsForType(opSel, t) {
            var ops;
            if (t === 'date') {
              ops = [
                { v: 'is', t: 'is' },
                { v: 'isnot', t: 'is not' },
                { v: 'after', t: 'is after' },
                { v: 'before', t: 'is before' },
                { v: 'range', t: 'in range' },
                { v: 'isempty', t: 'is empty' },
                { v: 'isnotempty', t: 'is not empty' }
              ];
            } else {
              ops = [
                { v: 'contains', t: 'contains' },
                { v: 'is', t: 'is' },
                { v: 'isnot', t: 'is not' },
                { v: 'isempty', t: 'is empty' },
                { v: 'isnotempty', t: 'is not empty' }
              ];
            }
            opSel.innerHTML = '';
            for (var i = 0; i < ops.length; i++) {
              var o = document.createElement('option'); o.value = ops[i].v; o.textContent = ops[i].t;
              opSel.appendChild(o);
            }
          }
          function guessType(colId) {
            var idxx = indexOf(STATE.fieldIds, colId); if (idxx < 0) return 'text';
            var limit = Math.min(STATE.rows.length, 100);
            for (var rrr = 0; rrr < limit; rrr++) {
              var v = STATE.rows[rrr][idxx];
              if (v == null || v === '') continue;
              if (typeof v === 'number') return 'number';
              if (/^\d{4}-\d{2}-\d{2}/.test(String(v))) return 'date';
            }
            return 'text';
          }

          var valWrap = document.createElement('span');
          function rebuildValueUI() {
            var t = guessType(sel.value);
            setOpsForType(op, t);
            op.value = r.op || 'isempty';
            valWrap.innerHTML = '';

            if (t === 'date') {
              if (op.value === 'range') {
                var a = document.createElement('input'); a.type = 'date';
                var b = document.createElement('input'); b.type = 'date';
                var parts = String(r.value || '').split('..');
                a.value = parts[0] || ''; b.value = parts[1] || '';
                a.onchange = b.onchange = function () { r.value = (a.value || '') + '..' + (b.value || ''); };
                valWrap.appendChild(a);
                valWrap.appendChild(document.createTextNode(' .. '));
                valWrap.appendChild(b);
              } else if (op.value === 'isempty' || op.value === 'isnotempty') {
              } else {
                var d = document.createElement('input'); d.type = 'date'; d.value = (r.value || '');
                d.onchange = function () { r.value = this.value; };
                valWrap.appendChild(d);
              }
            } else {
              if (op.value === 'contains') {
                var inp = document.createElement('input'); inp.type = 'text'; inp.placeholder = 'text or a,b,c'; inp.value = (r.value || '');
                inp.oninput = function () {
                  r.value = this.value;
                  var arr = String(this.value || '').split(',');
                  var cleaned = [];
                  for (var q = 0; q < arr.length; q++) {
                    var s = String(arr[q] || '').trim(); if (s) cleaned.push(s);
                  }
                  r.values = cleaned;
                };
                valWrap.appendChild(inp);
              } else if (op.value === 'is' || op.value === 'isnot') {
                var opts = distinctValuesAll(sel.value, 400);
                var box = document.createElement('div');
                box.style.display = 'grid';
                box.style.gridTemplateColumns = 'repeat(3, minmax(120px,1fr))';
                box.style.gap = '4px 8px';
                var cur = Array.isArray(r.values) ? r.values.slice()
                  : String(r.value || '').split(',').map(function (s) { return String(s || '').trim(); });
                for (var p = 0; p < opts.length; p++) {
                  var v2 = opts[p];
                  var lb = document.createElement('label');
                  lb.style.whiteSpace = 'nowrap';
                  lb.style.overflow = 'hidden';
                  lb.style.textOverflow = 'ellipsis';
                  var c = document.createElement('input'); c.type = 'checkbox'; c.checked = (cur.indexOf(v2) >= 0);
                  c.onchange = (function (vvv) {
                    return function () {
                      var pos = cur.indexOf(vvv);
                      if (this.checked && pos < 0) cur.push(vvv);
                      if (!this.checked && pos >= 0) cur.splice(pos, 1);
                      r.values = cur.slice();
                      r.value = cur.join(',');
                    };
                  })(v2);
                  lb.appendChild(c);
                  lb.appendChild(document.createTextNode(' ' + v2));
                  box.appendChild(lb);
                }
                valWrap.appendChild(box);
              } else if (op.value === 'isempty' || op.value === 'isnotempty') {
              } else {
                var inp2 = document.createElement('input'); inp2.type = 'text'; inp2.placeholder = 'value'; inp2.value = (r.value || '');
                inp2.onchange = function () { r.value = this.value; };
                valWrap.appendChild(inp2);
              }
            }
          }
          rebuildValueUI();
          op.onchange = function () { r.op = this.value; rebuildValueUI(); };

          var del = document.createElement('button'); del.className = 'btn'; del.textContent = '×';
          del.onclick = function () { if (typeof onRemove === 'function') onRemove(); };

          row.appendChild(sel);
          row.appendChild(op);
          row.appendChild(valWrap);
          row.appendChild(del);
          return row;
        }

        function body() {
          wrap.innerHTML = '';

          for (var gi = 0; gi < localFG.length; gi++) {
            (function (gi2) {
              var g = localFG[gi2] || defaultGroup();
              localFG[gi2] = g;
              var box = document.createElement('div'); box.className = 'fg-item';

              var hd = document.createElement('div'); hd.className = 'fg-head';
              var titleInput = document.createElement('input');
              titleInput.type = 'text'; titleInput.placeholder = 'Group name';
              titleInput.value = g.name || ('Group ' + (gi2 + 1));
              titleInput.oninput = function () { g.name = this.value; };

              var modeSel = document.createElement('select');
              var o1 = document.createElement('option'); o1.value = 'all'; o1.textContent = 'ALL';
              var o2 = document.createElement('option'); o2.value = 'any'; o2.textContent = 'ANY';
              modeSel.appendChild(o1); modeSel.appendChild(o2);
              modeSel.value = (g.mode === 'any' ? 'any' : 'all');
              modeSel.onchange = function () { g.mode = this.value; };

              var del = document.createElement('button'); del.className = 'btn'; del.textContent = '×';
              del.onclick = function () {
                localFG.splice(gi2, 1);
                if (localFG.length === 0) localFG = [defaultGroup()];
                body();
              };

              hd.appendChild(titleInput); hd.appendChild(modeSel);
              var sp = document.createElement('span'); sp.className = 'spacer'; hd.appendChild(sp);
              hd.appendChild(del);
              box.appendChild(hd);

              var bodyEl = document.createElement('div'); bodyEl.className = 'fg-body'; box.appendChild(bodyEl);
              var rWrap = document.createElement('div'); bodyEl.appendChild(rWrap);

              function renderRules() {
                rWrap.innerHTML = '';
                if (!Array.isArray(g.rules) || g.rules.length === 0) g.rules = [defaultEmptyRule()];
                for (var j = 0; j < g.rules.length; j++) {
                  (function (ri) {
                    var rit = g.rules[ri] || defaultEmptyRule();
                    g.rules[ri] = rit;
                    var rowEl = buildRuleRow(rit, function () { g.rules.splice(ri, 1); renderRules(); });
                    rWrap.appendChild(rowEl);
                  })(j);
                }
                var bar = document.createElement('div'); bar.className = 'row';
                var add = document.createElement('button'); add.className = 'btn'; add.textContent = '+ add rule';
                add.onclick = function () {
                  if (!Array.isArray(g.rules)) g.rules = [];
                  g.rules.push(defaultEmptyRule());
                  renderRules();
                };
                bar.appendChild(add);
                rWrap.appendChild(bar);
              }
              renderRules();
              wrap.appendChild(box);
            })(gi);
          }

          var bottom = document.createElement('div'); bottom.className = 'row'; bottom.style.marginTop = '8px';
          var addg = document.createElement('button'); addg.className = 'btn'; addg.textContent = '+ add group';
          addg.onclick = function () { localFG.push(defaultGroup()); body(); };

          function pill(active) {
            return 'padding:3px 8px;border:1px solid var(--border);border-radius:12px;background:' +
              (active ? 'var(--surface)' : 'transparent') +
              ';cursor:pointer;font-size:12px;';
          }
          var allBtn = document.createElement('button'); var anyBtn = document.createElement('button');
          function paintGC() {
            allBtn.style.cssText = pill(localCombine !== 'any'); allBtn.textContent = 'ALL';
            anyBtn.style.cssText = pill(localCombine === 'any'); anyBtn.textContent = 'ANY';
          }
          allBtn.onclick = function () { localCombine = 'all'; paintGC(); };
          anyBtn.onclick = function () { localCombine = 'any'; paintGC(); };
          paintGC();

          var apply = document.createElement('button'); apply.className = 'btn'; apply.textContent = 'Apply';
          apply.onclick = function () {
            STATE.filterGroups = deepCopy(localFG);
            STATE.groupCombine = (localCombine === 'any' ? 'any' : 'all');
            fetchAndRenderPage(1);
          };
          var reset = document.createElement('button'); reset.className = 'btn'; reset.textContent = 'Reset';
          reset.onclick = function () {
            STATE.filterGroups = [];
            STATE.groupCombine = 'all';
            fetchAndRenderPage(1);
            localFG = [defaultGroup()];
            localCombine = 'all';
            body();
          };

          bottom.appendChild(addg);
          var sp2 = document.createElement('span'); sp2.className = 'spacer'; bottom.appendChild(sp2);
          bottom.appendChild(allBtn);
          bottom.appendChild(anyBtn);
          bottom.appendChild(apply);
          bottom.appendChild(reset);
          wrap.appendChild(bottom);
        }
        body();
      }

      /* ===== 23. パネル共通 openPanel / closePanel / closeAllPanels ===== */

      (function () {
        var MARGIN = 6;
        var EDGE_PAD = 8;
        var Z_BASE = 10000;

        function closePanel(panel) {
          if (!panel) return;
          try {
            if (panel._closerCleanup) { panel._closerCleanup(); panel._closerCleanup = null; }
            removeGlobalClosers(panel);
            panel.style.display = 'none';
            panel.removeAttribute('data-open');
          } catch (_) { }
        }

        function closeAllPanels(except) {
          var list = document.querySelectorAll('.panel');
          for (var i = 0; i < list.length; i++) {
            var p = list[i];
            if (p === except) continue;
            closePanel(p);
          }
        }

        function positionPanel(panel, anchorEl) {
          if (!panel || !anchorEl) return;
          panel.style.visibility = 'hidden';
          panel.style.display = 'block';
          panel.style.position = 'absolute';
          panel.style.zIndex = String(Z_BASE);
          var a = anchorEl.getBoundingClientRect();
          var vpW = document.documentElement.clientWidth || window.innerWidth || 0;
          var vpH = document.documentElement.clientHeight || window.innerHeight || 0;
          var pw = Math.ceil(panel.getBoundingClientRect().width);
          var ph = Math.ceil(panel.getBoundingClientRect().height);
          var left = a.left;
          if (left + pw > vpW - EDGE_PAD) {
            left = Math.max(EDGE_PAD, a.right - pw);
          }
          left = Math.min(Math.max(EDGE_PAD, left), Math.max(EDGE_PAD, vpW - EDGE_PAD - pw));
          var topBelow = a.bottom + MARGIN;
          var topAbove = a.top - ph - MARGIN;
          var top;
          if (topBelow + ph <= vpH - EDGE_PAD) {
            top = topBelow;
          } else if (topAbove >= EDGE_PAD) {
            top = topAbove;
          } else {
            top = Math.min(Math.max(EDGE_PAD, topBelow), Math.max(EDGE_PAD, vpH - EDGE_PAD - ph));
          }
          var scrollX = window.pageXOffset || document.documentElement.scrollLeft || 0;
          var scrollY = window.pageYOffset || document.documentElement.scrollTop || 0;
          panel.style.left = Math.round(left + scrollX) + 'px';
          panel.style.top = Math.round(top + scrollY) + 'px';
          panel.style.visibility = 'visible';
        }

        window.openPanel = function (id, anchorEl, builder) {
          var panel = document.getElementById(id);
          if (!panel || !anchorEl || typeof builder !== 'function') return;

          closeAllPanels(panel);
          panel.innerHTML = '';
          try { builder(panel); } catch (_) { panel.innerHTML = ''; }

          if (!panel.style.minWidth) panel.style.minWidth = '320px';
          if (!panel.style.maxWidth) panel.style.maxWidth = '640px';

          positionPanel(panel, anchorEl);
          panel.setAttribute('data-open', '1');

          if (panel._closerCleanup) { panel._closerCleanup(); panel._closerCleanup = null; }
          addGlobalClosers(panel, anchorEl, function () { closePanel(panel); });

          function onRelayout() { if (panel.getAttribute('data-open') === '1') { positionPanel(panel, anchorEl); } }
          function onKeyDown(e) { if (e.key === 'Escape') { closePanel(panel); } }

          window.addEventListener('resize', onRelayout, { passive: true });
          window.addEventListener('scroll', onRelayout, { passive: true });
          document.addEventListener('keydown', onKeyDown);

          panel._closerCleanup = function () {
            try {
              window.removeEventListener('resize', onRelayout, { passive: true });
              window.removeEventListener('scroll', onRelayout, { passive: true });
              document.removeEventListener('keydown', onKeyDown);
              removeGlobalClosers(panel);
            } catch (_) { }
          };
          return panel;
        };

        window.closeAllPanels = closeAllPanels;
        window.closePanelById = function (id) {
          var p = document.getElementById(id);
          if (p) closePanel(p);
        };
      })();

      /* ===== 24. Dirty フラグ管理（setDirty） ===== */

      function setDirty(flag) {
        STATE.dirty = !!flag;

        var saveBtn = document.getElementById('saveCfgBtn');
        var ddBtn = document.getElementById('saveDDBtn');

        // 単体の「Save」ボタンが存在する場合のみ dirty 連動させる
        // （現状 saveCfgBtn が無ければ何もしない）
        if (saveBtn) {
          saveBtn.disabled = !STATE.dirty;
        }

        // 「Save ▾」ドロップダウンは常に有効化しておく
        if (ddBtn) {
          ddBtn.disabled = false;
        }
      }

      /* ===== 25. Save ドロップダウン UI（Save / Save as… / Revert） ===== */

      (function () {
        function ready(fn) {
          if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once: true });
          else fn();
        }
        ready(function () {
          var ddBtn = document.getElementById('saveDDBtn');
          var ddMenu = document.getElementById('saveDDMenu');
          var popover = document.getElementById('npPopover');
          var npName = document.getElementById('npName');
          var npCancel = document.getElementById('npCancel');
          var npSave = document.getElementById('npSave');
          if (!ddBtn || !ddMenu) return;

          // 念のため、ここでも常に有効化しておく
          ddBtn.disabled = false;

          function closeMenu() {
            ddMenu.classList.remove('open');
            removeGlobalClosers(ddMenu);
          }
          function openMenu() {
            ddMenu.classList.add('open');
            addGlobalClosers(ddMenu, ddBtn, closeMenu);
          }
          ddBtn.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (ddMenu.classList.contains('open')) closeMenu();
            else openMenu();
          });
          ddMenu.addEventListener('click', function (e) {
            var item = e.target.closest('.dd-item');
            if (!item) return;
            var act = item.getAttribute('data-act') || '';
            closeMenu();
            if (act === 'save') saveCurrentPageConfig && saveCurrentPageConfig();
            else if (act === 'saveas') openNewPagePopover();
            else if (act === 'revert') revertCurrentPageConfig && revertCurrentPageConfig();
          });

          function openNewPagePopover() {
            if (!popover) return;
            var r = ddBtn.getBoundingClientRect();
            popover.style.left = (r.left + window.scrollX) + 'px';
            popover.style.top = (r.bottom + window.scrollY + 8) + 'px';
            popover.style.display = 'block';
            if (npName) npName.value = '';
            addGlobalClosers(popover, ddBtn, closeNewPagePopover);
          }
          function closeNewPagePopover() {
            if (!popover) return;
            popover.style.display = 'none';
            removeGlobalClosers(popover);
          }
          if (npCancel) npCancel.addEventListener('click', closeNewPagePopover);
          if (npSave) npSave.addEventListener('click', function () {
            var name = (npName && npName.value || '').trim();
            if (!name) { npName && npName.focus(); return; }
            if (window.saveAsPage) saveAsPage(name, undefined, closeNewPagePopover);
            else closeNewPagePopover();
          });
          window.initSaveDropdown = function () { };
        });
      })();

      function snapshotCurrentPageConfig() {
        var order = (STATE.pageCfgRaw && Array.isArray(STATE.pageCfgRaw.order) && STATE.pageCfgRaw.order.length)
          ? STATE.pageCfgRaw.order.slice()
          : resolveOrder().slice();
        return {
          order: order,
          widths: copy(STATE.widths || {}),
          hidden: copy(STATE.hiddenCols || {}),
          sort: Array.isArray(STATE.sort) ? STATE.sort.slice() : [],
          group: Array.isArray(STATE.group) ? STATE.group.slice() : [],
          filterGroups: Array.isArray(STATE.filterGroups) ? deepCopy(STATE.filterGroups) : [],
          groupCombine: (STATE.groupCombine === 'any' ? 'any' : 'all')
        };
      }

      function entityLabelForSave() {
        var ent = (typeof resolveEntityStrict === 'function')
          ? resolveEntityStrict()
          : (STATE && STATE.sheetName) || 'shot';
        return pluralEntityFor(ent);
      }

      function refreshPresetsAfterSave() {
        return fetchPagesForEntity(STATE.sheetName || resolveEntityStrict() || 'shot')
          .then(function () {
            try { wirePresetSelectAfterLoad && wirePresetSelectAfterLoad(); } catch (_) { }
            var sel = document.getElementById('presetSelect');
            if (sel && STATE.pageId) sel.value = STATE.pageId;
          }).catch(function () { });
      }

      window.saveCurrentPageConfig = function () {
        var pid = STATE && STATE.pageId ? STATE.pageId : '';
        if (!pid) {
          if (typeof showStatus === 'function') showStatus('save error: missing pageId');
          if (typeof setTableBanner_ === 'function') {
            setTableBanner_('error', 'Missing pageId (pid). Configure a table page and select it before saving.');
          }
          return;
        }
        var cfg;
        try {
          cfg = snapshotCurrentPageConfig();
        } catch (e) {
          var msg = 'save error: ' + String(e && e.message ? e.message : e);
          if (typeof showStatus === 'function') showStatus(msg);
          try { console.error('saveCurrentPageConfig snapshot error', e && e.stack ? e.stack : e); } catch (_) { }
          try {
            var trace = { stage: 'snapshot', error: String(e && (e.message || e)), stack: String(e && e.stack || ''), ts: Date.now() };
            sessionStorage.setItem('MOTK_LAST_CALLFIRST_TRACE_V1', JSON.stringify(trace, null, 2));
          } catch (_) { }
          return;
        }
        var payload = {
          pageId: pid,
          entity: entityLabelForSave(),
          pageType: STATE && STATE.pageType ? STATE.pageType : 'table',
          config: cfg
        };
        debugPageCfg_('save attempt', { key: pageConfigCacheKey(pid), pageId: pid, pageName: debugPageName_(pid), entity: STATE.sheetName || '', columns: (cfg && cfg.order || []).length });
        if (typeof showStatus === 'function') showStatus('saving…');
        callFirst(['sv_savePageConfig', 'gsSavePageConfig', 'savePageLayout', 'dp_savePageConfig'],
          payload,
          function (res) {
            if (!res || (res.ok === false)) {
              if (typeof showStatus === 'function') {
                var fail = 'save failed';
                if (res && res.error) fail += ': ' + res.error;
                showStatus(fail);
              }
              return;
            }
            applyLoadedConfig({ config: cfg });
            cachePageConfigSnapshot(pid);
            setDirty(false);
            rememberLastView();
            refreshPresetsAfterSave();
            if (typeof showStatus === 'function') showStatus('saved');
          },
          function (err) {
            var msg = 'save error';
            if (err) msg += ': ' + String(err && (err.message || err));
            if (typeof showStatus === 'function') showStatus(msg);
          },
          { timeoutMs: 20000 }
        );
      };

      function needsQuoteForName(s) {
        var val = String(s || '').trim();
        if (!val) return false;
        if (/^0\d+$/.test(val)) return true;
        if (/^[+-]?\d+(\.\d+)?$/.test(val)) return true;
        if (val.length >= 12 && /^\d+$/.test(val)) return true;
        return false;
      }

      window.saveAsPage = function (name, shared, done) {
        var nmEl = document.getElementById('npName') || document.getElementById('pgName');
        var shEl = document.getElementById('npShared') || document.getElementById('pgShared');
        if (typeof name === 'undefined') name = nmEl ? String(nmEl.value || '').trim() : '';
        if (typeof shared === 'undefined') shared = shEl ? !!shEl.checked : false;
        done = typeof done === 'function' ? done : function () { };
        if (!name) {
          if (nmEl) { nmEl.focus(); }
          done();
          return;
        }
        var safeName = needsQuoteForName(name) ? ("'" + name) : name;
        var cfg = snapshotCurrentPageConfig();
        var payload = {
          pageId: 'pg_new',
          pageName: safeName,
          shared: !!shared,
          entity: entityLabelForSave(),
          pageType: STATE && STATE.pageType ? STATE.pageType : 'table',
          config: cfg
        };
        if (typeof showStatus === 'function') showStatus('saving…');
        callFirst(['sv_savePageConfig', 'gsSavePageConfig', 'savePageLayout', 'dp_savePageConfig'],
          payload,
          function (res) {
            if (!res || (res.ok === false)) {
              if (typeof showStatus === 'function') {
                var fail = 'save as failed';
                if (res && res.error) fail += ': ' + res.error;
                showStatus(fail);
              }
              done();
              return;
            }
            var newId = res && (res.pageId || res.id || res.pid) || '';
            if (newId) {
              STATE.pageId = newId;
              applyLoadedConfig({ config: cfg });
              cachePageConfigSnapshot(newId);
              rememberLastView();
            }
            setDirty(false);
            refreshPresetsAfterSave();
            if (typeof showStatus === 'function') showStatus('saved');
            done();
          },
          function () {
            if (typeof showStatus === 'function') showStatus('save failed');
            done();
          }
        );
      };

      window.revertCurrentPageConfig = function () {
        if (!STATE || !STATE.pageId) return;
        if (typeof showStatus === 'function') showStatus('reverting…');
        loadPageConfigFromCacheThenNetwork(STATE.pageId, function () {
          setDirty(false);
          try { renderCurrentPage && renderCurrentPage(true); } catch (_) { }
          if (typeof showStatus === 'function') showStatus('reverted');
        }, { forceNetwork: true });
      };

      /* ===== 26. fetch + payload（buildServerPayload / fetchAndRenderPage / fetchPageOnlyFromCacheThenNetwork） ===== */

      function applySheetNameFromPayload(payload, meta) {
        try {
          var fromMeta = meta && meta.sheet ? meta.sheet : (meta && meta.entity ? meta.entity : '');
          var fromPayload = payload && (payload.sheetName || payload.entity || payload.sheet || payload.entityPlural) || '';
          var candidate = fromMeta || fromPayload || '';
          if (candidate) {
            var ent = canonEntityKey_(candidate, '');
            if (ent) STATE.sheetName = ent;
          }
        } catch (_) { }
      }

      function buildServerPayload(offset, limit) {
        var activeSort = Array.isArray(STATE.sort)
          ? STATE.sort.filter(function (s) { return s && s.on !== false && s.id && isValidFieldId_(s.id); })
          : [];
        var entStrict = (typeof resolveEntityStrict === 'function')
          ? resolveEntityStrict()
          : (STATE.sheetName || 'shot');
        var entSing = canonEntityKey_(entStrict, 'shot');
        var entLabel = pluralEntityFor(entSing);
        var sanitizedGroups = sanitizeFilterGroups_(Array.isArray(STATE.filterGroups) ? STATE.filterGroups : []);
        var idFidForEntity_ = function (ent) {
          var e = canonEntityKey_(ent || '', '');
          if (window.SchemaResolver && SchemaResolver.getIdFid) {
            return SchemaResolver.getIdFid(e || ent || '');
          }
          throw new Error('SchemaResolver missing for id fid: ' + e);
        };
        // Build the requestedFields list from the canonical column order (STATE.fieldIds / colsKey),
        // without filtering away valid columns. Filtering here caused the server to return fewer fields
        // than the table renders, resulting in column/value shifts.
        var requestedFields = [];
        var cfgOrder = (STATE.pageCfgRaw && Array.isArray(STATE.pageCfgRaw.order)) ? STATE.pageCfgRaw.order.slice() : [];
        var stateOrder = Array.isArray(STATE.fieldIds) ? STATE.fieldIds.slice() : [];
        if ((!stateOrder.length) && STATE.colsKey) {
          try { stateOrder = String(STATE.colsKey || '').split('|').filter(Boolean); } catch (_) { }
        }
        var appendUniqueFids = function (list, seen, out) {
          for (var i = 0; i < list.length; i++) {
            var fid = list[i];
            if (!fid || seen[fid]) continue;
            seen[fid] = true;
            out.push(fid);
          }
        };
        var seenFids = Object.create(null);
        var idFid = idFidForEntity_(entSing);
        if (idFid && !seenFids[idFid]) {
          seenFids[idFid] = true;
          requestedFields.push(idFid);
        }
        if (stateOrder.length) appendUniqueFids(stateOrder, seenFids, requestedFields);
        if (cfgOrder.length) appendUniqueFids(cfgOrder, seenFids, requestedFields);
        requestedFields = requestedFields.filter(function (fid) {
          return fid && isValidFieldId_(fid);
        });
        if (!requestedFields.length) {
          var metaMap = (window.FIELD_TYPES && window.FIELD_TYPES[entSing]) ? window.FIELD_TYPES[entSing] : null;
          if (metaMap && typeof metaMap === 'object') {
            requestedFields = Object.keys(metaMap).filter(function (fid) {
              return fid && isValidFieldId_(fid);
            });
          }
        }
        // Ensure ID fid stays at the front even if filtering removed it.
        if (idFid && requestedFields[0] !== idFid) {
          requestedFields = [idFid].concat(requestedFields.filter(function (f) { return f !== idFid; }));
        }
        // Persist colsKey/schemaHash for SWR key stability.
        var colsKey = requestedFields.length ? requestedFields.join('|') : (Array.isArray(STATE.fieldIds) ? STATE.fieldIds.join('|') : '');
        STATE.__COLS_KEY__ = colsKey;
        if (!STATE._schemaHash) {
          try { STATE._schemaHash = STATE.__TABLE_FIELDIDS_HASH__ || colsKey || 'no-schema-hash'; } catch (_) { STATE._schemaHash = colsKey || 'no-schema-hash'; }
        }

        var payload = {
          entity: entLabel,
          sheet: entLabel,
          entityPlural: entLabel,
          sheetName: entSing,
          pageId: (STATE && STATE.pageId) ? String(STATE.pageId) : '',
          pageType: String(STATE.pageType || 'table'),
          offset: Math.max(0, offset | 0),
          limit: Math.max(1, Number(limit) || 100),
          sort: activeSort,
          filterGroups: sanitizedGroups,
          groupCombine: (STATE.groupCombine === 'any' ? 'any' : 'all'),
          requestedFields: requestedFields,
          colsKey: colsKey,
          schemaHash: STATE._schemaHash || ''
        };
        return payload;
      }

      function stableStringify_(val) {
        if (val === null || val === undefined) return 'null';
        if (typeof val !== 'object') return JSON.stringify(val);
        if (Array.isArray(val)) {
          return '[' + val.map(stableStringify_).join(',') + ']';
        }
        var keys = Object.keys(val).sort();
        return '{' + keys.map(function (k) {
          return JSON.stringify(k) + ':' + stableStringify_(val[k]);
        }).join(',') + '}';
      }

      function buildRowsCacheKey_(payload) {
        var sortList = Array.isArray(payload && payload.sort) ? payload.sort : [];
        var filterGroups = sanitizeFilterGroups_(Array.isArray(payload && payload.filterGroups) ? payload.filterGroups : []);
        var combine = payload && payload.groupCombine ? payload.groupCombine : 'all';
        var pageId = (STATE && STATE.pageId) ? String(STATE.pageId) : '';
        var entKey = canonEntityKey_(payload && (payload.sheetName || payload.entity || payload.entityPlural) || '', canonEntityKey_(STATE.sheetName || '', ''));
        var pageType = _canon(payload && payload.pageType || STATE.pageType || 'table');
        var colsKey = resolveCacheColsKey_(payload);
        if (payload && !payload.colsKey && colsKey) payload.colsKey = colsKey;
        STATE.__COLS_KEY__ = colsKey || STATE.__COLS_KEY__ || '';
        var schemaHash = resolveCacheSchemaHash_(payload);
        if (payload && !payload.schemaHash && schemaHash) payload.schemaHash = schemaHash;
        if (!schemaHash && STATE && STATE._schemaHash) schemaHash = String(STATE._schemaHash || '');
        var ckForKey = colsKey || '(pending-cols)';
        var shForKey = schemaHash || '(pending-schema)';

        return 'motk:rows:' + [
          entKey,
          pageType,
          _canon(pageId),
          payload && payload.limit || 0,
          payload && payload.offset || 0,
          serializeSort(sortList),
          'FG:' + stableStringify_(filterGroups),
          'GC:' + combine,
          'CK:' + ckForKey,
          'SH:' + shForKey
        ].join(':');
      }

      function nextSWRRequestId_() {
        return 'swr_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 6);
      }

      function registerSWRRequest_(key, reqId) {
        var tracker = window.__MOTK_SWR_REQ_TRACKER__ || { byKey: {}, count: 0, recent: [], lastBurstWarnTs: 0 };
        window.__MOTK_SWR_REQ_TRACKER__ = tracker;
        var now = Date.now();
        var prev = tracker.byKey[key];
        if (prev && (now - prev.ts) < 2000) {
          try {
            console.warn('[MOTK][SWR] duplicate request', {
              key: key,
              prevId: prev.id,
              reqId: reqId,
              deltaMs: now - prev.ts
            });
          } catch (_) { }
        }
        tracker.byKey[key] = { id: reqId, ts: now };
        tracker.count = (tracker.count || 0) + 1;
        tracker.recent = Array.isArray(tracker.recent) ? tracker.recent : [];
        tracker.recent.push(now);
        while (tracker.recent.length && (now - tracker.recent[0]) > 5000) tracker.recent.shift();
        if (tracker.recent.length > 10) {
          var sinceLastWarn = now - Number(tracker.lastBurstWarnTs || 0);
          if (!tracker.lastBurstWarnTs || sinceLastWarn > 5000) {
            var st = window.STATE || {};
            var lastReason = String(st.__LAST_APPLY_REJECT_REASON__ || st.__LAST_APPLY_FAILURE__ || 'unknown');
            try {
              console.warn('[MOTK][SWR] high request rate', {
                key: key || '(n/a)',
                reqId: reqId || '',
                count5s: tracker.recent.length,
                windowMs: 5000,
                lastRejectReason: lastReason
              });
            } catch (_) { }
            tracker.lastBurstWarnTs = now;
          }
        }
        markNavFlag_('swrRequests', tracker.count);
      }

      function registerSWRRequestContext_(key, reqId, payload) {
        try {
          var ctxStore = window.__MOTK_SWR_REQ_CTX__ || {};
          var reqFields = [];
          if (payload && Array.isArray(payload.requestedFields)) reqFields = payload.requestedFields.slice();
          if (!reqFields.length && payload && payload.colsKey) {
            reqFields = String(payload.colsKey || '').split('|').filter(Boolean);
          }
          var hash = reqFields.length ? reqFields.join('|') : '';
          var schemaHash = resolveCacheSchemaHash_(payload);
          ctxStore[reqId] = {
            key: key,
            fieldIds: reqFields,
            fieldIdsHash: hash,
            schemaHash: schemaHash,
            entity: String(payload && (payload.sheetName || payload.entity) || ''),
            pageId: String(payload && (payload.pageId || payload.pid) || '')
          };
          window.__MOTK_SWR_REQ_CTX__ = ctxStore;
          try {
            console.info("[MOTK][SWR] request_contract", {
              reqId: reqId,
              entity: ctxStore[reqId].entity || '',
              pageId: ctxStore[reqId].pageId || '',
              ck: hash || '',
              sh: schemaHash || '',
              fields: reqFields.length
            });
          } catch (_) { }
        } catch (_) { }
      }

      function isTableDirtyForSWR_() {
        if (STATE && STATE.dirty) return true;
        if (window.__MOTK_TABLE_CELL_EDIT_ACTIVE__) return true;
        try {
          return !!document.querySelector('.motk-inline-editor');
        } catch (_) {
          return false;
        }
      }

      function isValidCachedRowsPayload_(rawPayload, normalized) {
        if (!rawPayload || !normalized) return false;
        var total = Number(normalized.total);
        if (!isFinite(total) || total <= 0) return false;
        var ids = Array.isArray(normalized.ids) ? normalized.ids : [];
        if (!ids.length) return false;
        var idFid = resolveIdFieldId_();
        if (!idFid) return false;
        var hasId = false;
        for (var i = 0; i < ids.length; i++) {
          var fid = String(ids[i] || "");
          if (fid === idFid) { hasId = true; break; }
        }
        if (!hasId) return false;
        var rows = Array.isArray(normalized.rows) ? normalized.rows : [];
        if (!rows.length) return false;
        return true;
      }

      function expectedIdPrefixes_(entity) {
        var ent = normalizeEntityToken_(entity);
        switch (ent) {
          case 'shot': return ['sh_'];
          case 'asset': return ['as_'];
          case 'task': return ['tk_', 'ta_'];
          case 'member': return ['me_', 'pm_', 'mb_', 'mem_'];
          case 'user': return ['us_'];
        }
        return [];
      }

      function entityFromIdPrefix_(prefix) {
        var p = String(prefix || '').toLowerCase();
        if (p === 'sh_') return 'shot';
        if (p === 'as_') return 'asset';
        if (p === 'tk_' || p === 'ta_') return 'task';
        if (p === 'me_' || p === 'pm_' || p === 'mb_' || p === 'mem_') return 'member';
        if (p === 'us_') return 'user';
        return '';
      }

      function detectFirstRowId_(rows, ids) {
        if (!Array.isArray(rows) || !rows.length) return '';
        var idFid = resolveIdFieldId_();
        var idIdx = idFid && Array.isArray(ids) ? indexOf(ids, idFid) : -1;
        if (idIdx < 0) idIdx = 0;
        for (var i = 0; i < rows.length; i++) {
          var row = rows[i] || [];
          var v = row[idIdx];
          if (v != null && String(v).trim()) return String(v).trim();
        }
        for (var j = 0; j < rows.length; j++) {
          var r = rows[j] || [];
          for (var k = 0; k < r.length; k++) {
            var v2 = r[k];
            if (v2 != null && /^[a-z]{2,4}_[0-9]+/i.test(String(v2))) return String(v2).trim();
          }
        }
        return '';
      }

      function getIdPrefix_(id) {
        var m = String(id || '').trim().toLowerCase().match(/^([a-z]{2,4}_)/);
        return m ? m[1] : '';
      }

      function getBannerHost_() {
        var wrap = document.getElementById('tableWrap');
        if (!wrap || !wrap.parentNode) return null;
        var host = document.getElementById('tableBannerHost');
        if (!host) {
          host = document.createElement('div');
          host.id = 'tableBannerHost';
          wrap.parentNode.insertBefore(host, wrap);
        }
        return host;
      }

      function setTableBanner_(kind, message) {
        var host = getBannerHost_();
        if (!host) return;
        var id = 'tableBanner-' + kind;
        var el = document.getElementById(id);
        if (!message) {
          if (el && el.parentNode) el.parentNode.removeChild(el);
          return;
        }
        if (!el) {
          el = document.createElement('div');
          el.id = id;
          el.style.padding = '8px 10px';
          el.style.margin = '6px 0';
          el.style.borderRadius = '6px';
          el.style.fontSize = '12px';
          el.style.lineHeight = '1.4';
          el.style.border = '1px solid transparent';
          host.appendChild(el);
        }
        if (kind === 'error') {
          el.style.background = '#ffe9e9';
          el.style.borderColor = '#e18a8a';
          el.style.color = '#7d1d1d';
        } else {
          el.style.background = '#fff7e6';
          el.style.borderColor = '#e3c98c';
          el.style.color = '#6a4a00';
        }
        el.textContent = message;
      }

      function logPageConfigDiag_(payload, diag) {
        try {
          var pid = (payload && (payload.pageId || payload.pid)) ? String(payload.pageId || payload.pid) : (STATE && STATE.pageId) || '';
          var cols = resolveOrder();
          var key = pid + '|' + cols.join(',');
          if (STATE.__PAGECFG_DIAG_LOGGED_KEY__ === key) return;
          STATE.__PAGECFG_DIAG_LOGGED_KEY__ = key;

          var pageName = getPageNameById_(pid, STATE && STATE.pageList ? STATE.pageList : []);
          var hasShotView = cols.some(function(fid) {
            var meta = getNormalizedFieldMeta_(STATE.sheetName || '', fid) || {};
            var t = String(meta.type || '').toLowerCase().trim();
            var name = _normalizeFieldName_(meta.field_name || meta.name || meta.label || '');
            return t === 'shotview' || name.indexOf('shotview') >= 0;
          });
          var ds = (diag && (diag.dataSourceUsed || diag.source)) || (payload && payload.dataSourceUsed) || (STATE && (STATE.dataSourceEffective || STATE.dataSource)) || '';

          console.log('[MOTK][PageConfig]', {
            pageId: pid,
            pageName: pageName,
            columns: cols,
            hasShotView: hasShotView,
            dataSource: ds || 'n/a'
          });
        } catch (_) { }
      }

      function normalizeDataSourceLabel_(ds) {
        var s = String(ds || "").trim();
        if (!s) return "";
        var lc = s.toLowerCase();
        if (lc === "hub" || lc.indexOf("hub") === 0) return "hub";
        return s;
      }

      function inferDataSourceFromContract_(res) {
        try {
          var diag = res && (res.diag || (res.meta && res.meta.diag)) ? (res.diag || res.meta.diag) : null;
          var contract = (diag && diag.contract) || (res && res.contract) || null;
          if (!contract) return '';
          if (typeof contract === 'string') {
            var text = contract.trim();
            if (!text) return '';
            if (/^datacore/i.test(text)) return 'datacore';
            return 'datacore';
          }
          if (typeof contract === 'object') {
            if (Object.keys(contract).length > 0) return 'datacore';
          }
        } catch (_) { }
        return '';
      }

      function setEffectiveDataSource_(ds, stage) {
        var label = normalizeDataSourceLabel_(ds);
        if (!label) {
          if (stage) STATE.dataSourceStage = stage;
          return;
        }
        STATE.dataSourceEffective = label;
        STATE.dataSource = label;
        if (stage) STATE.dataSourceStage = stage;
      }

      function getFooterSourceLabel_() {
        var ds = String((STATE && STATE.dataSourceEffective) || '').trim();
        var stage = String((STATE && STATE.dataSourceStage) || '').trim();
        var syncing = !!(STATE && STATE.isSyncing);
        if (!ds) return 'pending';
        if (stage === 'cache' && syncing) return ds + ' (cache, syncing)';
        if (stage === 'cache') return ds + ' (cache)';
        if (syncing) return ds + ' (syncing)';
        return ds;
      }

      function buildListRowsCacheMeta_(res) {
        var diag = res && (res.diag || (res.meta && res.meta.diag)) ? (res.diag || res.meta.diag) : null;
        var mode = (res && (res.mode || res.source)) || (diag && (diag.mode || diag.source)) || "";
        var reason = (res && res.modeReason) || (diag && diag.modeReason) || "";
        var dataSource = pickDataSourceUsed_(res || {}, "");
        if (!dataSource && String(mode).toLowerCase() === "legacy") dataSource = "legacy";
        var fn = (res && (res.__fnUsed__ || res.listRowsFn)) || (diag && diag.listRowsFn) || "";
        return {
          dataSource: dataSource || "",
          mode: mode || "",
          reason: reason || "",
          fn: fn || "",
          fetchedAt: new Date().toISOString()
        };
      }

      function pickDataSourceUsed_(res, fallback) {
        try {
          var diag = res && (res.diag || (res.meta && res.meta.diag)) ? (res.diag || res.meta.diag) : null;
          var ds =
            (diag && (diag.dataSourceUsed || diag.source)) ||
            (res && (res.dataSourceUsed || res.source)) ||
            inferDataSourceFromContract_(res) ||
            "";
        ds = normalizeDataSourceLabel_(ds);
          if (!ds && fallback) ds = normalizeDataSourceLabel_(fallback);
          return ds || "";
        } catch (_) { }
        return normalizeDataSourceLabel_(fallback || "");
      }

      function recordBootPackDiag_(payload, res) {
        try {
          var diag = res && (res.diag || (res.meta && res.meta.diag)) ? (res.diag || res.meta.diag) : null;
          var flags = _navPerfFlags_();
          var timing = {};
          var nav = _navPerfStore_();
          Object.keys(nav || {}).forEach(function (k) {
            var v = Number(nav[k]);
            if (isFinite(v)) timing[k] = v;
          });
          var perf = window.__MOTK_TABLE_TIMINGS__ || {};
          Object.keys(perf || {}).forEach(function (k2) {
            var v2 = Number(perf[k2]);
            if (isFinite(v2)) timing[k2] = v2;
          });
          var cacheTier =
            (diag && (diag.dataSourceUsed || diag.source)) ||
            (res && (res.dataSourceUsed || res.source)) ||
            (flags && flags.dataSource) ||
            (STATE && (STATE.dataSourceEffective || STATE.dataSource)) ||
            '';
          var bootDiag = {
            cache: {
              tier: cacheTier || 'n/a',
              cacheServiceHit: !!(flags && flags.swrCacheHit),
              sheetHit: false,
              attempted: true
            },
            timing: timing,
            fallback: { attempted: false, used: false, blocked: false },
            entity: (STATE && STATE.sheetName) || '',
            pageId: (STATE && STATE.pageId) || '',
            ts: Date.now()
          };
          window.__MOTK_BOOTPACK_DIAG__ = bootDiag;
          try {
            var key = 'MOTK_LAST_TABLE_BOOTPACK_DIAG_V3';
            var v = JSON.stringify(bootDiag);
            sessionStorage.setItem(key, v);
            try { localStorage.setItem(key, v); } catch (e) { }
            if (bootDiag && bootDiag.pageId) {
              try { localStorage.setItem(key + ':' + bootDiag.pageId, v); } catch (e2) { }
            }
          } catch (_) { }
        } catch (_) { }
      }

      function applyListRowsDiagnostics_(payload, normalized, res, stage) {
        try {
          var summary = payload ? {
            entity: payload.entity || '',
            sheetName: payload.sheetName || '',
            pageId: payload.pageId || payload.pid || '',
            pageType: payload.pageType || '',
            offset: payload.offset,
            limit: payload.limit,
            requestedFieldsCount: Array.isArray(payload.requestedFields) ? payload.requestedFields.length : 0
          } : null;
          window.__lastListRowsPayload = payload || null;
          window.__lastListRowsPayloadSummary = summary || null;
          var diag = res && (res.diag || (res.meta && res.meta.diag)) ? (res.diag || res.meta.diag) : null;
          var meta = res && res.meta ? res.meta : null;
          if (!diag && meta && (meta.dataSource || meta.dataSourceUsed || meta.mode || meta.reason || meta.fn)) {
            diag = {
              dataSourceUsed: meta.dataSource || meta.dataSourceUsed || '',
              mode: meta.mode || '',
              modeReason: meta.reason || meta.modeReason || '',
              listRowsFn: meta.fn || meta.listRowsFn || '',
              fetchedAt: meta.fetchedAt || ''
            };
          }
          window.__lastListRowsRespDiag = diag || null;
          try {
            if (typeof persistViewerStateSnapshot === 'function') {
              persistViewerStateSnapshot({ lastListRowsRespDiag: diag || null });
            }
          } catch (_) { }
          try {
            var diagPayload = { ts: Date.now(), payload: summary || null, diag: diag || null };
            var diagKey = 'MOTK_LAST_LISTROWS_DIAG_V1';
            var raw = JSON.stringify(diagPayload);
            sessionStorage.setItem(diagKey, raw);
            try { localStorage.setItem(diagKey, raw); } catch (e2) { }
          } catch (_) { }

          try {
            var dsUsed = pickDataSourceUsed_(res || {}, '');
            if (!dsUsed && meta && (meta.dataSource || meta.dataSourceUsed)) {
              dsUsed = normalizeDataSourceLabel_(meta.dataSource || meta.dataSourceUsed);
            }
            if (dsUsed) {
              setEffectiveDataSource_(dsUsed, stage || 'network');
              markNavFlag_('dataSource', dsUsed);
            } else if (stage) {
              STATE.dataSourceStage = stage;
            }
            if (typeof setFinalStatus === 'function') setFinalStatus();
          } catch (_) { }

          var ent = normalizeEntityToken_((payload && (payload.sheetName || payload.entity || payload.sheet || payload.entityPlural)) || (STATE && STATE.sheetName) || '');
          var expected = expectedIdPrefixes_(ent);
          var firstId = detectFirstRowId_(normalized && normalized.rows, normalized && normalized.ids);
          var actualPrefix = getIdPrefix_(firstId);
          var actualEntity = entityFromIdPrefix_(actualPrefix);
          var pageId = payload && (payload.pageId || payload.pid) ? String(payload.pageId || payload.pid) : (STATE && STATE.pageId) || '';

          var mismatch = false;
          if (actualPrefix && expected.length && expected.indexOf(actualPrefix) < 0) mismatch = true;

          window.__lastListRowsEntityMismatch = mismatch ? {
            expectedEntity: ent,
            expectedPrefixes: expected,
            actualPrefix: actualPrefix,
            actualEntity: actualEntity,
            firstId: firstId,
            pageId: pageId
          } : null;

          if (mismatch) {
            var msg = 'Entity mismatch: expected ' + ent + ' (' + expected.join('/') + ') but rows look like ' +
              (actualEntity || actualPrefix || 'unknown') + ' (firstId=' + (firstId || 'n/a') + ') for pageId=' + pageId;
            setTableBanner_('error', msg);
            if (window.__MOTK_LAST_ENTITY_MISMATCH_KEY__ !== msg) {
              window.__MOTK_LAST_ENTITY_MISMATCH_KEY__ = msg;
              console.error('[MOTK][TableEntityMismatch]', {
                expectedEntity: ent,
                expectedPrefixes: expected,
                actualPrefix: actualPrefix,
                actualEntity: actualEntity,
                firstId: firstId,
                pageId: pageId,
                payload: payload || {}
              });
            }
          } else {
            setTableBanner_('error', '');
          }

          setTableBanner_('warn', '');

          var rowsLen = normalized && Array.isArray(normalized.rows) ? normalized.rows.length : 0;
          if (!mismatch && rowsLen === 0) {
            var reason = '';
            if (!ent) reason = 'missing entity context';
            else if (res && res.error) reason = 'server error: ' + String(res.error);
            else if (diag && diag.missingCount > 0) reason = 'missing fields in data source';
            else if (res && (res.total === 0 || (res.meta && res.meta.total === 0))) reason = 'server returned 0 rows';
            else if (res && (!res.rows || res.rows.length === 0)) reason = 'empty rows from server';
            else reason = 'unknown';
            setTableBanner_('error', 'Table is empty: ' + reason + ' (pageId=' + pageId + ')');
          }

          logPageConfigDiag_(payload, diag);
          try { recordBootPackDiag_(payload, res); } catch (e) { console.warn('[MOTK][Table] recordBootPackDiag_ failed', e); }
        } catch (e) { console.warn('[MOTK][Table] pageConfig diag logging failed', e); }
      }

      function ensureRowsAfterFetch() {
        try {
          var totalRows = Number(STATE && STATE.total);
          var rowCount = Array.isArray(STATE && STATE.rows) ? STATE.rows.length : 0;
          if (totalRows > 0 && rowCount === 0 && typeof fetchAndRenderPage === 'function') {
            fetchAndRenderPage(1);
          }
        } catch (_) { }
      }

      function fetchPageOnlyFromCacheThenNetwork(page, cb) {
        STATE.page = Math.max(1, page | 0 || 1);
        if (STATE.perPage === PER_PAGE_ALL) STATE.page = 1;
        STATE.isSyncing = false;

        var pageWindow = resolvePageWindow();
        var limit = resolveFetchLimit();
        var offset = (STATE.page - 1) * pageWindow;

        var payload = buildServerPayload(offset, limit);
        if (!payload || !(payload.pageId || payload.pid)) {
          if (!STATE.__ALLOW_PIDLESS__) {
            setTableBanner_('error', 'Missing pageId (pid). Configure a table page and select it before loading rows.');
            return;
          }
        }
        var colsKeyForCache = resolveCacheColsKey_(payload);
        var schemaHashForCache = resolveCacheSchemaHash_(payload);
        if (payload && colsKeyForCache && !payload.colsKey) payload.colsKey = colsKeyForCache;
        if (payload && schemaHashForCache && !payload.schemaHash) payload.schemaHash = schemaHashForCache;
        var cacheable = !!colsKeyForCache;
        var key = buildRowsCacheKey_(payload);
        var reqId = nextSWRRequestId_();
        registerSWRRequest_(key, reqId);
        registerSWRRequestContext_(key, reqId, payload);
        var bootStart = (STATE && STATE.__BOOT_START__) || (window.__MOTK_TABLE_TIMINGS__ && window.__MOTK_TABLE_TIMINGS__.bootStart) || _perfNow_();
        var cacheApplied = false;
        var reqVersion = (STATE.__TABLE_EXPECTED_VERSION__ = (Number(STATE.__TABLE_EXPECTED_VERSION__) || 0) + 1);
        try {
          var sortEmpty = !(payload.sort && payload.sort.length);
          console.info(
            "[MOTK][SWR] request",
            "entity=" + (payload.sheetName || ''),
            "pid=" + (STATE.pageId || ''),
            "page=" + STATE.page,
            "offset=" + payload.offset,
            "limit=" + payload.limit,
            "filtersEmpty=" + ((payload.filterGroups && payload.filterGroups.length) ? "no" : "yes"),
            "sortEmpty=" + (sortEmpty ? "yes" : "no"),
            "reqId=" + reqId
          );
        } catch (e) {}

        var cachedEnv = null;
        if (!cacheable) {
          cacheLog_('warn', 'cache read skipped (colsKey pending)', { key: key, colsKey: colsKeyForCache || '', pageId: STATE.pageId || '' });
        } else {
          cachedEnv = LSC_getEnvelope(key);
          cacheLog_(cachedEnv ? 'info' : 'info', cachedEnv ? 'cache envelope hit' : 'cache miss', {
            key: key,
            colsKey: colsKeyForCache || '',
            schemaHash: schemaHashForCache || '',
            storedAt: cachedEnv && cachedEnv.storedAt || null
          });
        }
        if (cachedEnv && !isCacheEnvelopeStructurallyValid_(cachedEnv)) {
          cacheLog_('warn', 'drop cache: invalid envelope shape', { key: key });
          LSC_deleteEnvelope(key);
          cachedEnv = null;
        }
        var cachedColsKey = cachedEnv ? extractColsKeyFromEnv_(cachedEnv) || extractColsKeyFromCacheKey_(cachedEnv.cacheKey || key) : '';
        var liveColsKey = colsKeyForCache || '';
        if (cachedEnv && cacheable) {
          if (!cachedColsKey) {
            cacheLog_('warn', 'drop cache: missing colsKey', { key: key, liveColsKey: liveColsKey });
            LSC_deleteEnvelope(key);
            cachedEnv = null;
          } else if (liveColsKey && cachedColsKey !== liveColsKey) {
            cacheLog_('warn', 'drop cache: colsKey mismatch', { key: key, cachedColsKey: cachedColsKey, liveColsKey: liveColsKey });
            LSC_deleteEnvelope(key);
            cachedEnv = null;
          }
        }
        if (cachedEnv && cachedEnv.payload) {
          dumpTableRaw_(cachedEnv.payload, key);
          var p = normalizeRowsPayload(cachedEnv.payload, payload && payload.sheetName);
          p = applyColManifestToNormalized_(p, 'cache');
          p = filterPayloadFieldIdsForEntity_(p, 'cache');
          p.__version = reqVersion;
          p.__queryKey = key;
          if (isValidCachedRowsPayload_(cachedEnv.payload, p)) {
            scheduleMetaRetry_(cachedEnv.payload, payload, key, p);
            applySheetNameFromPayload(payload, p && p.meta);
            var dsCache = pickDataSourceUsed_(cachedEnv.payload, '');
            var metaCache = cachedEnv.meta || (cachedEnv.payload && cachedEnv.payload.meta) || {};
            if (!dsCache && metaCache && (metaCache.dataSource || metaCache.dataSourceUsed)) {
              dsCache = normalizeDataSourceLabel_(metaCache.dataSource || metaCache.dataSourceUsed);
            }
            if (dsCache) {
              setEffectiveDataSource_(dsCache, 'cache');
              markNavFlag_('dataSource', dsCache);
            } else {
              STATE.dataSourceStage = 'pending';
            }
            var appliedCache = applyData(p);
            if (appliedCache && p && Array.isArray(p._removedFieldIds) && p._removedFieldIds.length) {
              try { prunePageConfigOrder_('payload:cache'); } catch (_) { }
              try { reconcileStoredViewerFieldIds_(STATE.sheetName, 'payload:cache'); } catch (_) { }
              try {
                var metaRestore = cachedEnv && cachedEnv.meta ? cachedEnv.meta : {};
                LSC_setEnvelope(key, p, metaRestore);
              } catch (_) { }
            } else if (!appliedCache) {
              cacheLog_('warn', 'cache apply failed; envelope deleted', { key: key });
              LSC_deleteEnvelope(key);
              invalidateAndRefetch_(key, 'cache-apply-failed');
            }
            if (appliedCache) {
              cacheLog_('info', 'cache applied', { key: key, colsKey: (p.meta && p.meta.colsKey) || cachedColsKey || liveColsKey, total: p.total, rows: Array.isArray(p.rows) ? p.rows.length : 0 });
            }
            recordLastTableBootPack_('cache');
            applyListRowsDiagnostics_(payload, p, cachedEnv.payload, 'cache');
            if (appliedCache) logFooterState_('cache_applied', key, reqId);
            markNavPerf_('view_hydrated_ms');
            perfMark_('view_hydrated');
            markNavFlag_('swrCacheHit', true);
            try {
              var cachedSource = pickDataSourceUsed_(cachedEnv.payload, '');
              if (cachedSource) markNavFlag_('dataSource', cachedSource);
              markNavFlag_('expectThumbs', hasProxyPreviewCols_());
            } catch (_) { }
            cacheApplied = appliedCache;
            if (!STATE.__BOOT_CACHE_RENDERED__ && appliedCache) {
              STATE.__BOOT_CACHE_RENDERED__ = true;
              _perfLog_('table_render_from_cache', bootStart);
              markNavPerf_('table_cache_painted_ms', _perfNow_());
            }
            if (appliedCache) {
              try {
                if (!window.__MOTK_UI_VISIBLE__) {
                  window.__MOTK_UI_VISIBLE__ = true;
                  console.info("[TAKE222][UI] visible=true reason=table_cache_applied t=" + Date.now());
                }
              } catch (_) { }
              setLoading(false);
              if (typeof updatePagerUI === 'function') updatePagerUI();
              if (typeof showStatus === 'function') showStatus('');
              rIC(function () {
                try { refreshDistinctCache(); } catch (_) { }
                try { ensureRowsAfterFetch(); } catch (_) { }
              });
              try { console.info("[MOTK][SWR] cache hit applied", key, "ts=" + new Date(cachedEnv.storedAt).toISOString()); } catch (e) {}
              if (cb) cb();
            }
          } else {
            cacheLog_('warn', 'cache skip: invalid payload', { key: key });
            LSC_deleteEnvelope(key);
          }
        }

        function startBackgroundFetch_() {
          window.setTimeout(function () {
          STATE.isSyncing = true;
          STATE.dataSourceStage = STATE.dataSourceStage || 'cache';
          if (STATE.dataSourceEffective) STATE.dataSourceStage = 'syncing';
          setFinalStatus();
          logFooterState_('sync_start', key, reqId);
          var livePayload = buildServerPayload(offset, limit);
          var liveKey = buildRowsCacheKey_(livePayload);
          var sameFields =
            stableStringify_(payload && payload.requestedFields || []) ===
            stableStringify_(livePayload && livePayload.requestedFields || []);
          if (!sameFields || liveKey !== key) {
            try { console.warn("[MOTK][SWR] payload/key refreshed before fetch", { prevKey: key, nextKey: liveKey, prevFields: payload && payload.requestedFields, nextFields: livePayload && livePayload.requestedFields }); } catch (_) {}
            payload = livePayload;
            key = liveKey;
            colsKeyForCache = resolveCacheColsKey_(payload);
            schemaHashForCache = resolveCacheSchemaHash_(payload);
            cacheable = !!colsKeyForCache;
            registerSWRRequest_(key, reqId);
            registerSWRRequestContext_(key, reqId, payload);
          }
          var fetchStart = (window.performance && typeof performance.now === 'function') ? performance.now() : Date.now();
          var reqStartTs = Date.now();
          window.__MOTK_TABLE_TIMINGS__ = window.__MOTK_TABLE_TIMINGS__ || {};
          window.__MOTK_TABLE_TIMINGS__.fetchStart = fetchStart;
          perfMark_('fetch_start');
          window.__lastListRowsPayload = payload || null;
          window.__lastListRowsPayloadSummary = {
            entity: payload.entity || '',
            sheetName: payload.sheetName || '',
            pageId: payload.pageId || payload.pid || '',
            pageType: payload.pageType || '',
            offset: payload.offset,
            limit: payload.limit,
            requestedFieldsCount: Array.isArray(payload.requestedFields) ? payload.requestedFields.length : 0
          };
          markNavFlag_('swrBackgroundFetch', true);
          try { console.info("[MOTK][SWR] background fetch started", key, "reqId=" + reqId); } catch (e) {}
          callFirst(['sv_listRowsPage', 'listRowsPage', 'gsListRowsPage', 'dp_listRowsPage'],
            payload,
            function (res) {
              if (res && res.ok === false) {
                var msg = res.message || res.error || 'Server error';
                setTableBanner_('error', msg);
                if (cb) cb();
                finalizeSync_({ phase: 'sync_apply_error', key: key, reqId: reqId, stage: cacheApplied ? 'cache' : 'network', cacheApplied: cacheApplied });
                return;
              }
              logFooterState_('sync_apply_start', key, reqId);
              var lastWriteTs = Number(STATE && STATE.lastWriteSuccessTime || 0);
              if (lastWriteTs && reqStartTs < lastWriteTs) {
                try { console.warn("[MOTK][SWR] drop response older than last write", { key: key, reqId: reqId, reqStart: reqStartTs, lastWrite: lastWriteTs }); } catch (_) { }
                if (cb) cb();
                finalizeSync_({ phase: 'sync_apply_skip:stale', key: key, reqId: reqId, stage: cacheApplied ? 'cache' : 'network', cacheApplied: cacheApplied });
                return;
              }
              markNavPerf_('rows_received_ms', _perfNow_());
              perfMark_('rows_received');
              var parseStart = (window.performance && typeof performance.now === 'function') ? performance.now() : Date.now();
              dumpTableRaw_(res, key);
              var p = normalizeRowsPayload(res, payload && payload.sheetName);
              var responseHash = '';
              try { responseHash = (p && p.meta && p.meta.fieldIdsHash) ? String(p.meta.fieldIdsHash) : ''; } catch (_) { responseHash = ''; }
              if (!responseHash && p && Array.isArray(p.ids) && p.ids.length) responseHash = p.ids.join('|');
              p = applyColManifestToNormalized_(p, 'network');
              p = filterPayloadFieldIdsForEntity_(p, 'network');
              p.__version = reqVersion;
              p.__queryKey = key;
              try {
                var ctx = window.__MOTK_SWR_REQ_CTX__ && window.__MOTK_SWR_REQ_CTX__[reqId] ? window.__MOTK_SWR_REQ_CTX__[reqId] : null;
                if (ctx && ctx.fieldIdsHash) {
                  p.__requestFieldIdsHash = ctx.fieldIdsHash;
                  p.meta = p.meta || {};
                  p.meta.__requestFieldIdsHash = ctx.fieldIdsHash;
                }
                if (p && p._removedFieldIds && p._removedFieldIds.length) {
                  p.__requestFieldIdsHash = p.ids.join('|');
                  if (p.meta) p.meta.__requestFieldIdsHash = p.__requestFieldIdsHash;
                }
                p.__responseFieldIdsHash = responseHash || '';
              } catch (_) { }
              try {
                console.info("[MOTK][SWR] response_contract", {
                  reqId: reqId,
                  responseHash: responseHash || '',
                  requestHash: (p && p.__requestFieldIdsHash) || '',
                  rows: Array.isArray(p.rows) ? p.rows.length : 0
                });
              } catch (_) { }
              var parseEnd = (window.performance && typeof performance.now === 'function') ? performance.now() : Date.now();
              recordPerf_('parse_ms', parseEnd - parseStart);
              recordPerf_('fetch_rows_ms', parseEnd - fetchStart);
              scheduleMetaRetry_(res, payload, key, p);
              var currentPayload = buildServerPayload((STATE.page - 1) * resolvePageWindow(), resolveFetchLimit());
              var currentKey = buildRowsCacheKey_(currentPayload);

              applySheetNameFromPayload(payload, p && p.meta);
              var cacheMeta = buildListRowsCacheMeta_(res || {});
              try {
                p.meta = p.meta || {};
                p.meta.dataSource = cacheMeta.dataSource || p.meta.dataSource || "";
                p.meta.mode = cacheMeta.mode || p.meta.mode || "";
                p.meta.modeReason = cacheMeta.reason || p.meta.modeReason || "";
                p.meta.fn = cacheMeta.fn || p.meta.fn || "";
                p.meta.fetchedAt = cacheMeta.fetchedAt || p.meta.fetchedAt || "";
                if (!p.meta.diag) p.meta.diag = {};
                if (res && res.diag) {
                  try { p.meta.diag = Object.assign({}, res.diag); } catch (_) { }
                }
                p.meta.diag.dataSourceUsed = p.meta.diag.dataSourceUsed || cacheMeta.dataSource || "";
                p.meta.diag.mode = p.meta.diag.mode || cacheMeta.mode || "";
                p.meta.diag.modeReason = p.meta.diag.modeReason || cacheMeta.reason || "";
                p.meta.diag.listRowsFn = p.meta.diag.listRowsFn || cacheMeta.fn || "";
                p.meta.diag.fetchedAt = p.meta.diag.fetchedAt || cacheMeta.fetchedAt || "";
              } catch (_) { }
              var appliedOk = applyData(p);
              if (appliedOk) {
                var writeEligible = cacheable && isCacheWriteEligible_(p, payload);
                if (writeEligible) {
                  var colsKeyToPersist = (p && p.meta && p.meta.colsKey) || colsKeyForCache || resolveCacheColsKey_(p) || (p && p.ids ? p.ids.join('|') : '');
                  var schemaHashToPersist = (p && p.meta && (p.meta.schemaHash || p.meta.schemaSig || p.meta.schemaVersion)) || schemaHashForCache || resolveCacheSchemaHash_(p) || '';
                  cacheLog_('info', 'cache write (network)', {
                    key: key,
                    colsKey: colsKeyToPersist || '',
                    schemaHash: schemaHashToPersist || '',
                    rows: Array.isArray(p.rows) ? p.rows.length : 0,
                    total: p.total
                  });
                  LSC_setEnvelope(key, p, {
                    storedAt: Date.now(),
                    cacheKey: key,
                    dataSource: cacheMeta.dataSource || "",
                    mode: cacheMeta.mode || "",
                    reason: cacheMeta.reason || "",
                    fn: cacheMeta.fn || "",
                    fetchedAt: cacheMeta.fetchedAt || "",
                    colsKey: colsKeyToPersist || '',
                    schemaHash: schemaHashToPersist || ''
                  });
                } else {
                  cacheLog_('warn', 'cache write skipped (ineligible)', {
                    key: key,
                    colsKey: colsKeyForCache || '',
                    rows: Array.isArray(p.rows) ? p.rows.length : 0,
                    total: p.total
                  });
                  if (cacheable) LSC_deleteEnvelope(key);
                }
              } else {
                cacheLog_('warn', 'network payload dropped (applyData failed)', { key: key });
                LSC_deleteEnvelope(key);
                invalidateAndRefetch_(key, 'applyData-failed');
              }
              if (appliedOk && p && Array.isArray(p._removedFieldIds) && p._removedFieldIds.length) {
                try { prunePageConfigOrder_('payload:network'); } catch (_) { }
                try { reconcileStoredViewerFieldIds_(STATE.sheetName, 'payload:network'); } catch (_) { }
              }
              try {
                var mode = (res && (res.mode || res.source || (res.diag && res.diag.mode) || res.dataSourceUsed)) || "";
                if (!mode) mode = "legacy";
                var modeReason = (res && (res.modeReason || (res.diag && res.diag.modeReason))) || "";
                if (!modeReason && mode === "legacy") modeReason = "legacy-wrapper";
                var dataSourceUsed = (res && (res.dataSourceUsed || (res.diag && res.diag.dataSourceUsed) || res.source)) || "";
                dataSourceUsed = normalizeDataSourceLabel_(dataSourceUsed);
                if (!dataSourceUsed && mode === "legacy") dataSourceUsed = "legacy";
                if (res && !res.diag) {
                  res.diag = {
                    mode: mode,
                    modeReason: modeReason,
                    dataSourceUsed: dataSourceUsed,
                    listRowsFn: (res && res.listRowsFn) || "legacy-wrapper"
                  };
                }
                window.__MOTK_LAST_LIST_ROWS_DIAG_V1 = {
                  ts: Date.now(),
                  mode: mode,
                  modeReason: modeReason,
                  dataSourceUsed: dataSourceUsed,
                  listRowsFn: (res && res.listRowsFn) || (res.diag && res.diag.listRowsFn) || "legacy-wrapper",
                  missingFieldIds: (res && res.diag && res.diag.missingFieldIds) || []
                };
                var serverDiag = (res && res.diag && res.diag.listRows) ? res.diag.listRows : (res && res.diag) ? res.diag : null;
                var timing = serverDiag && (serverDiag.timings || serverDiag.timing) ? (serverDiag.timings || serverDiag.timing) : null;
                var serverTotal = serverDiag && (serverDiag.server_total_ms || (timing && timing.total_ms)) ? (serverDiag.server_total_ms || timing.total_ms) : null;
                var clientFetchMs = (window.__MOTK_TABLE_TIMINGS__ && window.__MOTK_TABLE_TIMINGS__.fetch_rows_ms != null)
                  ? window.__MOTK_TABLE_TIMINGS__.fetch_rows_ms
                  : null;
                var clientOverheadMs = (clientFetchMs != null && serverTotal != null)
                  ? Math.round(clientFetchMs - serverTotal)
                  : null;
                var timingSummary = '';
                if (timing) {
                  var keys = ['readDataHub_ms', 'readEntitySheet_ms', 'buildRows_ms', 'applyFilters_ms', 'applySort_ms', 'buildLinkMaps_ms', 'stringify_ms'];
                  var parts = [];
                  for (var ti = 0; ti < keys.length; ti++) {
                    var tk = keys[ti];
                    if (timing[tk] != null) parts.push(tk + '=' + timing[tk]);
                  }
                  timingSummary = parts.join(' ');
                }
                var fg = Array.isArray(payload && payload.filterGroups) ? payload.filterGroups : [];
                var fgCount = fg.length;
                var ruleCount = 0;
                var nonEmptyRules = 0;
                for (var gi = 0; gi < fg.length; gi++) {
                  var rules = Array.isArray(fg[gi] && fg[gi].rules) ? fg[gi].rules : [];
                  ruleCount += rules.length;
                  for (var ri = 0; ri < rules.length; ri++) {
                    var r = rules[ri] || {};
                    if (r.op === "isempty" || r.op === "isnotempty") { nonEmptyRules++; continue; }
                    if (Array.isArray(r.values) && r.values.length) { nonEmptyRules++; continue; }
                    if (Object.prototype.hasOwnProperty.call(r, "value") && r.value !== null && r.value !== undefined && String(r.value).trim().length) nonEmptyRules++;
                  }
                }
                var hasQuery = !!(payload && payload.query && String(payload.query).trim());
                var hasOrder = !!(payload && payload.orderBy && String(payload.orderBy).trim());
                var sortCount = Array.isArray(payload && payload.sort) ? payload.sort.length : 0;
                if (modeReason === "filters-or-sort" && !hasOrder && !hasQuery && nonEmptyRules === 0 && sortCount === 0) {
                  modeReason = "legacy-wrapper";
                }
                try {
                  if (res && typeof res === 'object') {
                    res.diag = res.diag || {};
                    if (clientFetchMs != null) res.diag.client_fetch_ms = clientFetchMs;
                    if (serverTotal != null) res.diag.server_total_ms = serverTotal;
                    if (clientOverheadMs != null) res.diag.client_overhead_ms = clientOverheadMs;
                  }
                } catch (_) { }
                console.info(
                  "[MOTK][SWR] response",
                  "mode=" + mode,
                  "reason=" + (modeReason || "n/a"),
                  "dataSource=" + (dataSourceUsed || "n/a"),
                  "fn=" + ((res && res.__fnUsed__) || (res && res.diag && res.diag.listRowsFn) || "n/a"),
                  "server_total_ms=" + (serverTotal != null ? serverTotal : "n/a"),
                  "client_fetch_ms=" + (clientFetchMs != null ? clientFetchMs : "n/a"),
                  "client_overhead_ms=" + (clientOverheadMs != null ? clientOverheadMs : "n/a"),
                  "timing=" + (timingSummary || "n/a"),
                  "payload=query:" + (hasQuery ? "yes" : "no") + " filters=" + fgCount + "/" + ruleCount + " nonEmpty=" + nonEmptyRules + " sort=" + (hasOrder ? "yes" : "no") + " sortFields=" + sortCount,
                  "key=" + key,
                  "reqId=" + reqId
                );
              } catch (e) {}

              try {
                var ds = pickDataSourceUsed_(res || {}, '');
                if (ds) markNavFlag_('dataSource', ds);
                var sr = res && (res.schemaRefreshed || (res.diag && res.diag.schemaRefreshed));
                if (sr) markNavFlag_('schemaRefreshed', true);
                var srReason = res && (res.schemaRefreshReason || (res.diag && res.diag.schemaRefreshReason)) || '';
                if (srReason) markNavFlag_('schemaRefreshReason', srReason);
                markNavFlag_('expectThumbs', hasProxyPreviewCols_());
              } catch (_) { }

              var reqEnt = canonEntityKey_(payload && (payload.sheetName || payload.entity || payload.sheet || payload.entityPlural) || '', '');
              var respEnt = canonEntityKey_((res && (res.entityNormalized || res.entity || res.sheetName || res.sheet)) || '', '');
              if (reqEnt && respEnt && reqEnt !== respEnt) {
                var msg = 'Entity mismatch: requested ' + reqEnt + ' but server returned ' + respEnt + ' for pageId=' + (payload.pageId || '');
                setTableBanner_('error', msg);
                console.error('[MOTK][TableEntityMismatch]', { requested: reqEnt, returned: respEnt, payload: payload || {}, resp: res || {} });
                finalizeSync_({ phase: 'sync_apply_skip:entity_mismatch', key: key, reqId: reqId, stage: cacheApplied ? 'cache' : 'network', cacheApplied: cacheApplied });
                if (cb) cb();
                return;
              }

              if (currentKey !== key) {
                finalizeSync_({ phase: 'sync_apply_skip:key_mismatch', key: key, reqId: reqId, stage: cacheApplied ? 'cache' : 'network', cacheApplied: cacheApplied });
                if (cb) cb();
                return;
              }

              if (isTableDirtyForSWR_()) {
                STATE.__SWR_DEFERRED_KEY__ = key;
                finalizeSync_({ phase: 'sync_apply_deferred:dirty', key: key, reqId: reqId, stage: cacheApplied ? 'cache' : 'network', cacheApplied: cacheApplied });
                try { showStatus && showStatus("New data available - Reload"); } catch (_) { }
                try { console.info("[MOTK][SWR] background fetch deferred (dirty)", key); } catch (e) {}
                if (cb) cb();
                return;
              }

              if (!STATE.__BOOT_BG_APPLIED__) {
                STATE.__BOOT_BG_APPLIED__ = true;
                _perfLog_('table_apply_background_response', bootStart);
              }
              var appliedNet = applyData(p);
              if (appliedNet) {
                var dsNet = pickDataSourceUsed_(res || {}, '');
                if (dsNet) setEffectiveDataSource_(dsNet, 'network');
                if (p && Array.isArray(p._removedFieldIds) && p._removedFieldIds.length) {
                  try { prunePageConfigOrder_('payload:network'); } catch (_) { }
                  try { reconcileStoredViewerFieldIds_(STATE.sheetName, 'payload:network'); } catch (_) { }
                }
                recordLastTableBootPack_('network');
                applyListRowsDiagnostics_(payload, p, res, 'network');
                markNavPerf_('rows_updated_ms', _perfNow_());
                markNavPerf_('view_hydrated_ms');
                perfMark_('rows_updated');
                perfMark_('view_hydrated');
                try { markNavFlag_('expectThumbs', hasProxyPreviewCols_()); } catch (_) { }
                if (typeof updatePagerUI === 'function') updatePagerUI();
                refreshDistinctCache();
                try { console.info("[MOTK][SWR] background fetch applied", key, "ts=" + new Date().toISOString()); } catch (e) {}
                var appliedInPlace = false;
                if (cacheApplied) {
                  appliedInPlace = updateTableRowsInPlace_(p, { source: "swr" });
                }
                if (appliedInPlace) {
                  // Footer finalization handled by finalizeSync_.
                }
                if (!cacheApplied) {
                  if (cb) cb();
                } else if (!appliedInPlace) {
                  try { console.warn("[MOTK][SWR] in-place update skipped; keeping cache-rendered table", key); } catch (_) { }
                }
                finalizeSync_({ phase: 'sync_apply_done', key: key, reqId: reqId, stage: 'network', cacheApplied: cacheApplied });
              } else {
                var lastFail = '';
                try { lastFail = String(STATE.__LAST_APPLY_FAILURE__ || ''); } catch (_) { lastFail = ''; }
                if (lastFail === 'fieldIdsHash-mismatch') {
                  cacheLog_('warn', 'network apply failed; cache preserved', { key: key, reason: lastFail });
                } else {
                  cacheLog_('warn', 'network apply failed; cache cleared', { key: key });
                  try { LSC_deleteEnvelope(key); } catch (_) { }
                  invalidateAndRefetch_(key, 'network-apply-failed');
                }
                try {
                  var rowsLen = Array.isArray(STATE && STATE.rows) ? STATE.rows.length : 0;
                  if (!cacheApplied && rowsLen === 0) {
                    STATE.dataSourceEffective = '';
                    STATE.dataSource = '';
                    STATE.dataSourceStage = 'pending';
                  }
                } catch (_) { }
                if (cb) cb();
                finalizeSync_({ phase: 'sync_apply_failed', key: key, reqId: reqId, stage: cacheApplied ? 'cache' : 'pending', cacheApplied: cacheApplied });
              }
            },
            function () {
              if (cb) cb();
              try {
                var rowsLen = Array.isArray(STATE && STATE.rows) ? STATE.rows.length : 0;
                if (!cacheApplied && rowsLen === 0) {
                  STATE.dataSourceEffective = '';
                  STATE.dataSource = '';
                  STATE.dataSourceStage = 'pending';
                }
              } catch (_) { }
              finalizeSync_({ phase: 'sync_apply_error', key: key, reqId: reqId, stage: cacheApplied ? 'cache' : 'pending', cacheApplied: cacheApplied });
            }
          );
        }, 0);
        }

        function shouldStartSWR_() {
          try {
            var pageWindowNow = resolvePageWindow();
            var limitNow = resolveFetchLimit();
            var offsetNow = (STATE.page - 1) * pageWindowNow;
            var currentPayload = buildServerPayload(offsetNow, limitNow);
            var currentKey = buildRowsCacheKey_(currentPayload);
            if (currentKey !== key) {
              try { console.info("[MOTK][SWR] background fetch key refreshed", key, "->", currentKey); } catch (e) {}
              payload = currentPayload;
              key = currentKey;
              colsKeyForCache = resolveCacheColsKey_(payload);
              schemaHashForCache = resolveCacheSchemaHash_(payload);
              cacheable = !!colsKeyForCache;
              registerSWRRequest_(key, reqId);
              window.__lastListRowsPayload = payload || null;
              window.__lastListRowsPayloadSummary = {
                entity: payload.entity || '',
                sheetName: payload.sheetName || '',
                pageId: payload.pageId || payload.pid || '',
                pageType: payload.pageType || '',
                offset: payload.offset,
                limit: payload.limit,
                requestedFieldsCount: Array.isArray(payload.requestedFields) ? payload.requestedFields.length : 0
              };
            }
            return true;
          } catch (_) { return false; }
        }

        if (cacheApplied) {
          _afterNextFrame_().then(function () {
            var cacheAgeMs = (cachedEnv && cachedEnv.storedAt) ? (Date.now() - cachedEnv.storedAt) : null;
            var cacheFresh = (cacheAgeMs != null && cacheAgeMs < 30000);
            if (cacheFresh) {
              try { console.info("[MOTK][SWR] background fetch skipped (fresh cache)", Math.round(cacheAgeMs) + "ms"); } catch (e) {}
              return;
            }
            _perfLog_('table_schedule_background_fetch', bootStart);
            setTimeout(function () {
              if (!shouldStartSWR_()) return;
              var idle = window.requestIdleCallback;
              if (typeof idle === 'function') {
                idle(function () {
                  if (!shouldStartSWR_()) return;
                  startBackgroundFetch_();
                }, { timeout: 1000 });
                return;
              }
              startBackgroundFetch_();
            }, 1500);
          });
        } else {
          _perfLog_('table_schedule_background_fetch', bootStart);
          if (shouldStartSWR_()) startBackgroundFetch_();
        }
      }

      function fetchAndRenderPage(page) {
        if (!STATE || (!STATE.pageId && !STATE.__ALLOW_PIDLESS__)) {
          if (typeof setTableBanner_ === 'function') {
            setTableBanner_('error', 'Missing pageId (pid). Configure a table page and select it before loading.');
          }
          return;
        }
        STATE.page = Math.max(1, page | 0 || 1);
        if (STATE.perPage === 'all') STATE.page = 1;

        var pageWindow = resolvePageWindow();
        var limit = resolveFetchLimit ? resolveFetchLimit() : pageWindow;
        var offset = (STATE.page - 1) * pageWindow;

        var usp = writeUrlState ? writeUrlState() : new URLSearchParams(location.search);
        if (typeof resolveEntityStrict === 'function') usp.set('entity', resolveEntityStrict());
        history.replaceState(null, '', location.pathname + '?' + usp.toString());

        var payload = buildServerPayload(offset, limit);
        if (typeof showStatus === 'function') showStatus('loading ' + pluralEntityFor(payload.entity) + '…');

        fetchPageOnlyFromCacheThenNetwork(STATE.page, function () {
          STATE._prevRowForGroup = null;
          if (typeof renderCurrentPage === 'function') renderCurrentPage(true);
          try {
            var idFid = resolveIdFieldId_();
            var idIdx = idFid && Array.isArray(STATE.fieldIds) ? indexOf(STATE.fieldIds || [], idFid) : -1;
            if (idIdx < 0) idIdx = 0;
            var first = (STATE.rows && STATE.rows[0]) ? STATE.rows[0][idIdx] : '';
            console.info("[MOTK][SWR] page applied", "page=" + STATE.page, "firstId=" + (first == null ? '' : String(first)));
          } catch (_) { }
        });
      }

      /* ===== 27. ちょいユーティリティ（rid / labelForFieldId） ===== */

      function rid() { return 'g' + Math.random().toString(36).slice(2, 8); }

      function labelForFieldId(fid) {
        var idx = indexOf(STATE.fieldIds, fid);
        return idx >= 0 ? (STATE.header[idx] || fid) : fid;
      }

      /* ===== start() ブートシーケンス & DOM Ready ===== */

      function resolveEntityStrict() {
        var fromUrl = normalizeEntityFromParams_();
        if (fromUrl) return fromUrl;
        if (STATE && STATE.sheetName) {
          return canonEntityKey_(STATE.sheetName, 'shot');
        }
        try {
          var qent = normalizeEntityFromParams_();
          if (qent) return qent;
          var qpid = (getRouteParam_('pid') || '').trim();
          var fromPid = qpid ? entityFromPageId(qpid) : '';
          if (fromPid) return fromPid;
        } catch (_) { }
        if (STATE && STATE.pageId) {
          var e2 = entityFromPageId(STATE.pageId);
          if (e2) return e2;
        }
        return 'shot';
      }

      function pageFid_(fieldName) {
        try { if (window.SchemaResolver && SchemaResolver.getFidByFieldName) return SchemaResolver.getFidByFieldName('page', fieldName); } catch (_) { }
        return '';
      }
      function getPageId(x) {
        var fid = pageFid_('Page ID');
        return ((x && (x.pageId || x.id || (fid && x[fid]) || x['Page ID'])) || '') + '';
      }
      function getPageEnt(x) {
        var fid = pageFid_('Entity');
        return ((x && (x.entity || x.Entity || (fid && x[fid]) || x['Entity'])) || '') + '';
      }
      function getPageType(x) {
        var fid = pageFid_('Page Type');
        return ((x && (x.pageType || x['Page Type'] || x.type || (fid && x[fid]))) || '') + '';
      }

      function resolvePageIdFromName_(name, list) {
        var needle = _canon(name || '');
        if (!needle) return '';
        if (!Array.isArray(list)) return '';
        for (var i = 0; i < list.length; i++) {
          var x = list[i] || {};
          var fid = pageFid_('Page Name');
          var nm = (x.pageName || x.name || (fid && x[fid]) || x['Page Name'] || '');
          if (_canon(nm) === needle) return getPageId(x);
        }
        return '';
      }

      function getPageNameById_(pid, list) {
        if (!pid || !Array.isArray(list)) return '';
        for (var i = 0; i < list.length; i++) {
          var x = list[i] || {};
          if (getPageId(x) !== pid) continue;
          var fid = pageFid_('Page Name');
          return String(x.pageName || x.name || (fid && x[fid]) || x['Page Name'] || '');
        }
        return '';
      }

      function entityFromPageId(pid) {
        try {
          var list = Array.isArray(STATE && STATE.pageList) ? STATE.pageList : [];
          for (var i = 0; i < list.length; i++) {
            var x = list[i];
            if (getPageId(x) === pid) {
              var ent = getPageEnt(x);
              if (ent) return canonEntityKey_(ent, '');
            }
          }
          try {
            var ent2 = normalizeEntityFromParams_();
            if (ent2) return ent2;
          } catch (_) { }
          if (STATE && STATE.sheetName) return canonEntityKey_(STATE.sheetName, '');
          if (typeof detectEntityStrict === 'function') return detectEntityStrict();
        } catch (_) { }
        return '';
      }

      function detectEntityStrict() {
        try {
          var ent = normalizeEntityFromParams_();
          if (ent) return ent;

          var pid = (STATE && STATE.pageId) || '';
          if (pid && Array.isArray(STATE && STATE.pageList)) {
            for (var i = 0; i < STATE.pageList.length; i++) {
              var x = STATE.pageList[i];
              if (getPageId(x) === pid) {
                var ent2 = (getPageEnt(x) || '').toLowerCase();
                if (ent2) return canonEntityKey_(ent2, '');
              }
            }
          }
          if (STATE && STATE.sheetName) return canonEntityKey_(STATE.sheetName, '');
        } catch (_) { }
        return '';
      }

      function wirePresetSelectAfterLoad() {
        var sel = document.getElementById('presetSelect'); if (!sel) return;
        var list = (Array.isArray(STATE.pageList) ? STATE.pageList : []);
        var cur = sel.value; sel.innerHTML = '';
        if (!STATE.pageId) {
          var ph = document.createElement('option');
          ph.value = '';
          ph.textContent = 'Select a page…';
          ph.disabled = true;
          ph.selected = true;
          sel.appendChild(ph);
        }
        for (var i = 0; i < list.length; i++) {
          var x = list[i];
          var fid = pageFid_('Page Name');
          var id = getPageId(x);
          var nm = (x.pageName || x.name || (fid && x[fid]) || x['Page Name'] || '(no name)');
          if (!id) continue;
          var opt = document.createElement('option');
          opt.value = id; opt.textContent = nm;
          sel.appendChild(opt);
        }
        var hasPageId = STATE.pageId && list.some(function (x) { return getPageId(x) === STATE.pageId; });
        if (hasPageId) sel.value = STATE.pageId;
        if (!sel.value && cur) sel.value = cur;

        sel.removeEventListener('change', onPresetChange);
        sel.addEventListener('change', onPresetChange);
        bindPresetAutoRefresh(sel);
      }

      function onPresetChange(ev) {
        try {
          var sel = ev && ev.target;
          var pid = sel && sel.value ? String(sel.value).trim() : '';
          if (!pid || STATE.pageId === pid) return;

          STATE.pageId = pid;
          var ent = entityFromPageId(pid) || resolveEntityStrict();
          STATE.sheetName = ent;
          rememberLastView();

          try {
            var usp0 = writeUrlState ? writeUrlState() : new URLSearchParams(location.search);
            if (STATE.pageId) usp0.set('pid', STATE.pageId);
            if (STATE.sheetName) {
              usp0.set('e', STATE.sheetName);
              usp0.delete('entity');
            }
            history.replaceState(null, '', location.pathname + '?' + usp0.toString());
          } catch (_) {}

          if (typeof loadPageConfigFromCacheThenNetwork === 'function') {
            loadPageConfigFromCacheThenNetwork(pid, function () {
              if (typeof fetchAndRenderPage === 'function') fetchAndRenderPage(1);
              if (typeof setDirty === 'function') setDirty(false);
            });
          } else if (typeof fetchAndRenderPage === 'function') {
            fetchAndRenderPage(1);
          }
        } catch (_) { }
      }

      function filterPagesForEntity(list, entity) {
        var entSing = canonEntityKey_(entity || STATE.sheetName || '', 'shot');
        var ptCanon = _canon(STATE.pageType || 'table');
        return list.filter(function (x) {
          var xt = _canon(getPageType(x));
          var rawEnt = String(getPageEnt(x) || '').trim();
          if (!rawEnt) return false;
          var pageEnt = canonEntityKey_(rawEnt, '');
          var entOk = pageEnt && pageEnt === entSing;
          var typeOk = !xt || xt === ptCanon;
          return entOk && typeOk;
        });
      }

      function bindPresetAutoRefresh(sel) {
        if (!sel || sel._motkRefreshBound) return;
        sel._motkRefreshBound = true;
        var kick = function () {
          if (!STATE || !STATE.sheetName) return;
          var badge = document.getElementById('presetStatus');
          if (badge) badge.textContent = 'syncing…';
          fetchPagesForEntity(STATE.sheetName, { forceNetwork: true }).then(function () {
            var b = document.getElementById('presetStatus');
            if (b) b.textContent = 'synced';
          }).catch(function () {
            var b = document.getElementById('presetStatus');
            if (b) b.textContent = 'sync failed';
          });
        };
        sel.addEventListener('mousedown', kick);
        sel.addEventListener('focus', kick);
      }

      function fetchPagesForEntity(entity, opts) {
        opts = opts || {};
        return new Promise(function (resolve) {
          STATE._pagesFetchDone = false;
          var entSing = canonEntityKey_(entity || STATE.sheetName || '', 'shot');
          var resolved = false;
          function finishResolve_() {
            if (resolved) return;
            resolved = true;
            resolve();
          }
          var payload = {
            entity: _canon(entSing),
            pageType: 'table'
          };
          var cacheKey = 'motk:pages:' + entSing + ':' + _canon(payload.pageType || 'table');
          var cachedApplied = false;
          if (!opts.forceNetwork) {
            var cachedEnv = LSC_getEnvelope(cacheKey, 24 * 60 * 60 * 1000);
            if (cachedEnv && cachedEnv.payload) {
              var cached = Array.isArray(cachedEnv.payload) ? cachedEnv.payload : [];
              var cachedFiltered = Array.isArray(cached) ? filterPagesForEntity(cached, entSing) : [];
              STATE.pageList = cachedFiltered;
              STATE._pagesFetchDone = true;
              STATE.__PAGES_CACHE_HIT__ = true;
              try { wirePresetSelectAfterLoad && wirePresetSelectAfterLoad(); } catch (_) { }
              cachedApplied = true;
              finishResolve_();
            }
          }
          if (opts.forceNetwork) payload.nocache = true;
          callFirst(['sv_listPages', 'gsListPagePresets'],
            payload,
            function (list) {
              var arr = Array.isArray(list) ? list
                : (list && Array.isArray(list.items) ? list.items : []);
              if (list && list.error) {
                STATE.pageList = [];
                STATE._pagesFetchDone = true;
                setTableBanner_('error', 'PageConfig load failed: ' + String(list.error || 'unknown'));
                finishResolve_();
                return;
              }
              var filtered = Array.isArray(arr) ? filterPagesForEntity(arr, entSing) : [];
              STATE.pageList = filtered;
              STATE._pagesFetchDone = true;
              try { LSC_setEnvelope(cacheKey, filtered, { storedAt: Date.now(), cacheKey: cacheKey }); } catch (_) { }
              try { wirePresetSelectAfterLoad && wirePresetSelectAfterLoad(); } catch (_) { }
              finishResolve_();
            },
            function () {
              if (!cachedApplied) {
                STATE.pageList = [];
                STATE._pagesFetchDone = true;
                setTableBanner_('error', 'PageConfig load failed: network error');
                try { wirePresetSelectAfterLoad && wirePresetSelectAfterLoad(); } catch (_) { }
              }
              finishResolve_();
            }
          );
        });
      }

      function pageConfigCacheKey(pid) {
        var keys = pageConfigCacheKeyCandidates_(pid);
        return keys.length ? keys[0] : '';
      }

      function pageConfigCacheKeyCandidates_(pid) {
        var pageId = String(pid || '').trim();
        if (!pageId) return [];
        var ent = canonEntityKey_((STATE && STATE.sheetName) || '', '');
        var proj = getProjectId_() || 'unknown';
        var keys = ['motk:pagecfg:v2:' + proj + ':' + ent + ':' + pageId];
        if (proj !== 'unknown') {
          keys.push('motk:pagecfg:v2:unknown:' + ent + ':' + pageId);
        }
        return uniq(keys);
      }

      function pageConfigLegacyKeys_(pid) {
        var pageId = String(pid || '').trim();
        if (!pageId) return [];
        return ['motk:cfg:' + pageId];
      }

      function getProjectId_() {
        try {
          if (window.__MOTK_PROJECT_ID__) return String(window.__MOTK_PROJECT_ID__ || '').trim();
        } catch (_) { }
        try {
          if (window.__MOTK_PROJECT_META__ && window.__MOTK_PROJECT_META__.project_id) {
            return String(window.__MOTK_PROJECT_META__.project_id || '').trim();
          }
        } catch (_) { }
        try {
          var raw = localStorage.getItem('MOTK_PROJECT_ID_V1');
          if (raw) return String(raw || '').trim();
        } catch (_) { }
        return '';
      }

      function debugPageCfg_(msg, obj) {
        try {
          if (window.__MOTK_DEBUG_PAGECFG__ === true) {
            console.info('[PageCfg]', msg, obj || {});
          }
        } catch (_) { }
      }

      function debugPageName_(pid) {
        try {
          if (typeof getPageNameById_ === 'function') {
            return getPageNameById_(pid, STATE.pageList || []) || '';
          }
        } catch (_) { }
        return '';
      }

      function applyLoadedConfig(cfg) {
        var c = (cfg && cfg.config && typeof cfg.config === 'object') ? cfg.config : (cfg || {});
        STATE.pageCfgRaw = {
          order: (c && Array.isArray(c.order)) ? uniq(c.order) : null,
          widths: (c && c.widths && typeof c.widths === 'object') ? copy(c.widths) : {},
          hidden: (c && c.hidden && typeof c.hidden === 'object') ? copy(c.hidden) : {},
          group: (c && Array.isArray(c.group)) ? c.group.slice() : [],
          filterGroups: (c && Array.isArray(c.filterGroups)) ? deepCopy(c.filterGroups) : [],
          sort: (c && Array.isArray(c.sort)) ? c.sort.slice() : []
        };
        STATE.widths = copy(STATE.pageCfgRaw.widths);
        STATE.hiddenCols = copy(STATE.pageCfgRaw.hidden);
        STATE.group = Array.isArray(STATE.pageCfgRaw.group) ? STATE.pageCfgRaw.group.slice() : [];
        STATE.filterGroups = Array.isArray(STATE.pageCfgRaw.filterGroups) ? deepCopy(STATE.pageCfgRaw.filterGroups) : [];
        STATE.groupCombine = (c && c.groupCombine === 'any') ? 'any' : 'all';
        STATE.sort = Array.isArray(STATE.pageCfgRaw.sort) ? STATE.pageCfgRaw.sort.slice() : [];
        ensureFilterGroupDefaults();
        try { runSchemaMembershipSweep_(STATE.sheetName, 'pageCfg:load'); } catch (_) { }
      }

      function cachePageConfigSnapshot(pid) {
        if (!pid || !STATE || !STATE.pageCfgRaw) return;
        var key = pageConfigCacheKey(pid);
        if (!key) return;
        LSC_set(key, {
          order: STATE.pageCfgRaw.order,
          widths: STATE.pageCfgRaw.widths,
          hidden: STATE.pageCfgRaw.hidden,
          group: STATE.pageCfgRaw.group,
          filterGroups: STATE.pageCfgRaw.filterGroups,
          groupCombine: STATE.groupCombine,
          sort: Array.isArray(STATE.sort) ? STATE.sort.slice() : []
        });
        debugPageCfg_('cache save', { key: key, pageId: pid, pageName: debugPageName_(pid), entity: STATE.sheetName || '' });
      }

      function loadPageConfigFromCacheThenNetwork(pid, done, opts) {
        opts = opts || {};
        STATE.__PAGE_CFG_CACHE_HIT__ = false;
        STATE.__PAGE_CFG_SOURCE__ = "";
        var doneCalled = false;
        var finish = function () {
          if (doneCalled) return;
          doneCalled = true;
          if (typeof done === 'function') done();
        };
        if (!pid) {
          STATE.pageCfgRaw = null;
          STATE.widths = {};
          STATE.hiddenCols = {};
          STATE.group = [];
          STATE.filterGroups = [];
          STATE.groupCombine = 'all';
          STATE.sort = [];
          ensureFilterGroupDefaults();
          setDirty(false);
          finish();
          return;
        }
        var key = pageConfigCacheKey(pid);
        if (opts.forceNetwork) {
          try { localStorage.removeItem(key); } catch (_) { }
        } else {
          var cached = LSC_get(key, 24 * 60 * 60 * 1000);
          if (!cached) {
            var candidates = pageConfigCacheKeyCandidates_(pid).slice(1);
            var legacyKeys = pageConfigLegacyKeys_(pid);
            var altKeys = candidates.concat(legacyKeys);
            for (var i = 0; i < altKeys.length; i++) {
              var altKey = altKeys[i];
              var altVal = LSC_get(altKey, 24 * 60 * 60 * 1000);
              if (altVal) {
                cached = altVal;
                try { LSC_set(key, altVal); } catch (_) { }
                try { localStorage.removeItem(altKey); } catch (_) { }
                STATE.__PAGE_CFG_SOURCE__ = 'cache:migrated';
                debugPageCfg_('cache migrate', { from: altKey, to: key, pageId: pid, pageName: debugPageName_(pid), entity: STATE.sheetName || '' });
                break;
              }
            }
          }
          if (cached) {
            STATE.__PAGE_CFG_CACHE_HIT__ = true;
            if (!STATE.__PAGE_CFG_SOURCE__) STATE.__PAGE_CFG_SOURCE__ = "cache";
            applyLoadedConfig(cached);
            setDirty(false);
            debugPageCfg_('cache apply', { key: key, pageId: pid, pageName: debugPageName_(pid), entity: STATE.sheetName || '', columns: (cached.order || []).length });
            finish();
          }
        }
        var payload = { pageId: pid };
        if (opts.forceNetwork) payload.nocache = true;
        callFirst(['sv_loadPageConfig', 'gsLoadPageConfig', 'getPageLayout', 'dp_loadPageConfig'],
          payload,
          function (cfg) {
            applyLoadedConfig(cfg || {});
            setDirty(false);
            cachePageConfigSnapshot(pid);
            STATE.__PAGE_CFG_SOURCE__ = "network";
            debugPageCfg_('network apply', { key: key, pageId: pid, pageName: debugPageName_(pid), entity: STATE.sheetName || '', columns: (STATE.pageCfgRaw && STATE.pageCfgRaw.order || []).length });
            if (typeof rememberLastView === 'function') rememberLastView();
            finish();
          },
          function () {
            finish();
          }
        );
      }

      function pageIdInList_(pid, list) {
        if (!pid || !Array.isArray(list) || !list.length) return false;
        for (var i = 0; i < list.length; i++) {
          if (getPageId(list[i]) === pid) return true;
        }
        return false;
      }

      function buildFallbackPageConfigForEntity_(entity) {
        var ent = canonEntityKey_(entity || '', '');
        if (!ent) return null;
        var meta = null;
        if (window.FIELD_TYPES && window.FIELD_TYPES[ent]) meta = window.FIELD_TYPES[ent];
        var order = [];
        function add(fid) {
          if (!fid) return;
          if (order.indexOf(fid) >= 0) return;
          order.push(fid);
        }
        try {
          if (meta) {
            Object.keys(meta).forEach(function (fid) {
              var m = meta[fid] || {};
              var t = String(m.type || '').toLowerCase().trim();
              var label = String(m.label || m.field_name || m.name || '').toLowerCase();
              if (t === 'id') add(fid);
              else if (t === 'entity_name') add(fid);
              else if (t === 'status') add(fid);
            });
            ['episode', 'act', 'sequence', 'scene', 'shot'].forEach(function (k) {
              var found = null;
              Object.keys(meta).some(function (fid) {
                var m = meta[fid] || {};
                var label = String(m.label || m.field_name || m.name || '').toLowerCase();
                if (label.indexOf(k) >= 0) { found = fid; return true; }
                return false;
              });
              if (found) add(found);
            });
          }
        } catch (_) { }
        if (!order.length) {
          try {
            if (window.SchemaResolver && SchemaResolver.getIdFid) add(SchemaResolver.getIdFid(ent));
            if (window.SchemaResolver && SchemaResolver.getEntityNameFid) add(SchemaResolver.getEntityNameFid(ent));
            if (window.SchemaResolver && SchemaResolver.getFidsByType) {
              var st = SchemaResolver.getFidsByType(ent, 'status');
              if (st && st.length) add(st[0]);
            }
          } catch (_) { }
        }
        if (!order.length) return null;
        return {
          order: order.slice(),
          widths: {},
          hidden: {},
          group: [],
          filterGroups: [],
          sort: []
        };
      }

      function ensureFallbackPagesForEntity_(entity) {
        var ent = canonEntityKey_(entity || STATE.sheetName || '', '');
        if (!ent) return false;
        var list = Array.isArray(STATE.pageList) ? STATE.pageList : [];
        if (list.length) return false;
        var cfg = buildFallbackPageConfigForEntity_(ent);
        if (!cfg || !cfg.order || !cfg.order.length) return false;
        var pid = 'pg_default_' + ent;
        var page = {
          pageId: pid,
          pageName: ent.charAt(0).toUpperCase() + ent.slice(1) + ' (Default)',
          pageType: 'table',
          entity: ent,
          synthetic: true
        };
        STATE.pageList = [page];
        STATE.__FALLBACK_PAGE_CFGS__ = STATE.__FALLBACK_PAGE_CFGS__ || {};
        STATE.__FALLBACK_PAGE_CFGS__[pid] = cfg;
        STATE.__FALLBACK_PAGE_IDS__ = STATE.__FALLBACK_PAGE_IDS__ || {};
        STATE.__FALLBACK_PAGE_IDS__[pid] = true;
        return true;
      }

      function refreshFallbackPageConfig_() {
        try {
          var pid = STATE && STATE.pageId ? String(STATE.pageId) : '';
          if (!pid) return;
          if (!STATE.__FALLBACK_PAGE_CFGS__ || !STATE.__FALLBACK_PAGE_CFGS__[pid]) return;
          var ent = canonEntityKey_(STATE.sheetName || '', '');
          if (!ent) return;
          var next = buildFallbackPageConfigForEntity_(ent);
          if (!next || !next.order || !next.order.length) return;
          var cur = STATE.__FALLBACK_PAGE_CFGS__[pid] || {};
          if (cur.order && cur.order.length) return;
          STATE.__FALLBACK_PAGE_CFGS__[pid] = next;
          applyLoadedConfig({ config: next });
          try { renderCurrentPage && renderCurrentPage(true); } catch (_) { }
        } catch (_) { }
      }

      function resolveEntityFromContext() {
        // [FIX] Robust Entity Resolution (URL > Body/Server > Fallback)
        var raw = '';
        var source = '';

        // 1. URL Parameters (Highest Priority)
        raw = (getRouteParam_('e') || getRouteParam_('entity') || '').trim();
        if (raw) source = 'url';

        // 2. URL Page Parameter (if it matches an entity)
        if (!raw) {
          var p = (getRouteParam_('p') || getRouteParam_('page') || '').trim();
          if (p && normalizeEntityToken_(p)) { raw = p; source = 'url_page'; }
        }

        // 3. Global PAGE variable (Server-side fallback)
        if (!raw && typeof window.PAGE !== 'undefined') {
          var gp = String(window.PAGE).trim();
          if (gp && normalizeEntityToken_(gp)) { raw = gp; source = 'page_var'; }
        }

        // 4. Existing STATE.sheetName (Last Resort)
        if (!raw) raw = STATE.sheetName || '';
        if (!source && raw) source = 'state';

        // 6. Normalize and Set
        var s = canonEntityKey_(raw, canonEntityKey_(STATE.sheetName, 'shot'));
        STATE.sheetName = s || 'shot';

        window.__MOTK_ENTITY_SOURCE__ = source || window.__MOTK_ENTITY_SOURCE__ || '';
        console.log('[MOTK] resolveEntityFromContext determined:', s, '(raw:', raw, ')');
        return s;
      }

      function resetStateForEntityChange_(prevEntity, nextEntity) {
        try {
          STATE.fieldIds = [];
          STATE.header = [];
          STATE.rows = [];
          STATE.columns = [];
          STATE.fieldsMeta = {};
          STATE.headersByFid = {};
          STATE.pageList = [];
          STATE.pageCfgRaw = null;
          STATE.widths = {};
          STATE.hiddenCols = {};
          STATE.group = [];
          STATE.filterGroups = [];
          STATE.groupCombine = 'all';
          STATE.sort = [];
          STATE.pageId = '';
          STATE.__FALLBACK_PAGE_CFGS__ = {};
          STATE.__FALLBACK_PAGE_IDS__ = {};
          STATE._dataReady = false;
          STATE._cfgReady = false;
          STATE.__TABLE_RENDERED__ = false;
          STATE.__TABLE_RENDER_SIG__ = '';
          STATE.__TABLE_COLS_KEY__ = '';
          STATE.__ROW_HASH_BY_ID__ = {};
          STATE.__FIELD_ID_FILTER_LOGGED__ = false;
          STATE.__FIELD_ID_FILTER_DEFERRED__ = false;
          STATE.__ORDER_REJECTED_LOGGED__ = false;
          STATE.__TABLE_FIRST_PAINT_DONE__ = false;
          PROXY_PREFETCH_KEY = '';
          PROXY_PREFETCH_SCHEDULED = false;
          if (typeof setDirty === 'function') setDirty(false);
          console.warn('[MOTK] entity change reset', { from: prevEntity, to: nextEntity });
        } catch (_) { }
      }

      function onDom() {
        try { adjustNavOffset && adjustNavOffset(); } catch (_) { }
        try {
          var routeP = String(getRouteParam_('p') || getRouteParam_('page') || '').toLowerCase();
          if (routeP === 'schedule') {
            var cont = document.getElementById('table-view-container');
            if (cont) cont.style.display = 'none';
            return;
          }
        } catch (_) { }
        window.addEventListener('resize', function () {
          try { adjustNavOffset && adjustNavOffset(); } catch (_) { }
        }, { passive: true });
        try {
          var obs = new MutationObserver(function () {
            try { adjustNavOffset && adjustNavOffset(); } catch (_) { }
          });
          if (document.body) {
            obs.observe(document.body, {
              childList: true,
              subtree: true,
              attributes: true,
              attributeFilter: ['style', 'class']
            });
          }
        } catch (_) { }

        // 左クリックの SPA ルーティングは使用しない（通常のページ遷移）
        try { readUrlState && readUrlState(); } catch (_) { }
        Promise.resolve(start()).then(function () {
          bindLinkPickerInlineEdit();
        });

        var qs = document.getElementById('quickSearch');
        if (qs) {
          qs.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              var q = qs.value.trim();
              if (q) { serverSearch(q); } else { fetchAndRenderPage(1); }
            }
          });
        }

        // Expose for DebugPanel / console diagnostics
        window.serverSearch = serverSearch;
      }

      async function start() {
        STATE.pageType = 'table';

        var rawParams = {
          e: getRouteParam_('e'),
          entity: getRouteParam_('entity'),
          pid: getRouteParam_('pid'),
          p: getRouteParam_('p'),
          page: getRouteParam_('page')
        };
        STATE.rawParams = rawParams;
        normalizeCreateOAuthDialogParam_();

        initNavPerf_();
        var bootStart = _perfNow_();
        window.__MOTK_TABLE_TIMINGS__ = window.__MOTK_TABLE_TIMINGS__ || {};
        window.__MOTK_TABLE_TIMINGS__.bootStart = bootStart;
        window.__MOTK_TABLE_TIMINGS__.__postRenderLogged = false;
        STATE.__BOOT_START__ = bootStart;
        STATE.__BOOT_CACHE_RENDERED__ = false;
        STATE.__BOOT_BG_APPLIED__ = false;
        perfMark_('boot_start');
        markNavPerf_('nav_start_ms', bootStart);
        scheduleNavPerfSnapshot_(12000, 'timeout');
        persistBootSnapshot_('boot_start');

        try { markNavPerf_('toolbar_mounted_ms'); } catch (_) { }

        // [DEBUG] Temporary log for navigation debugging
        console.log('[MOTK] start() entity', {
          // navEntity: STATE._navEntity, // No longer used
          url_e: getUrlParam('e'),
          url_entity: getUrlParam('entity'),
          url_p: getUrlParam('p'),
          url_page: getUrlParam('page'),
          sheetBefore: STATE.sheetName
        });

        resolveEntityFromContext();
        STATE.sheetName = canonEntityKey_(STATE.sheetName, 'shot');
        if (STATE.__LAST_ENTITY__ && STATE.__LAST_ENTITY__ !== STATE.sheetName) {
          resetStateForEntityChange_(STATE.__LAST_ENTITY__, STATE.sheetName);
        }
        STATE.__LAST_ENTITY__ = STATE.sheetName;

        var normalized = canonEntityKey_(normalizeEntityFromParams_() || rawParams.p || rawParams.page || STATE.sheetName || '', '');
        var source = window.__MOTK_ENTITY_SOURCE__ || (normalized ? 'url' : 'state');
        var oauth = isOAuthDialog_();
        console.log('[MOTK][BOOT]', JSON.stringify({
          rawParams: rawParams,
          normalizedEntity: normalized,
          source: source,
          createOAuthDialog: oauth
        }));

        if (oauth && !normalized && !rawParams.pid) {
          console.warn('[MOTK][BOOT] OAuth dialog missing routing params; applying fallback context');
        }

        try { bindPagerControls && bindPagerControls(); } catch (_) { }
        try { updatePagerUI && updatePagerUI(); } catch (_) { }

        var fetchPromise = null;
        var fastRowsKey = '';
        function afterFetch_(done) {
          STATE._dataReady = true;
          try {
            var summary = window.__lastListRowsPayloadSummary || {};
            console.info('[TAKE213][TABLE][DATA_READY]', {
              t: _perfNow_(),
              pageId: (STATE && STATE.pageId) || '',
              rows: (STATE && Array.isArray(STATE.rows)) ? STATE.rows.length : 0,
              requestedFieldsCount: summary.requestedFieldsCount || 0
            });
          } catch (_) { }
          Promise.resolve().then(function () {
            if (typeof ensureNamesForCurrentPage === 'function') {
              return ensureNamesForCurrentPage();
            }
          }).catch(function () { }).then(function () {
            try { maybeRender && maybeRender(); }
            catch (_) {
              try { renderCurrentPage && renderCurrentPage(true); } catch (__) { }
            }
          }).finally(function () {
            if (done) done();
          });
        }

        function runFetchOnce_(tag) {
          if (fetchPromise) return fetchPromise;
          if (typeof fetchPageOnlyFromCacheThenNetwork !== 'function') {
            STATE._dataReady = true;
            try {
              console.info('[TAKE213][TABLE][DATA_READY]', { t: _perfNow_(), pageId: (STATE && STATE.pageId) || '', rows: 0, requestedFieldsCount: 0, source: 'no-fetch' });
            } catch (_) { }
            fetchPromise = Promise.resolve();
            return fetchPromise;
          }
          if (tag === 'fast') {
            try {
              var pageNum = STATE.page || 1;
              var fastPayload = buildServerPayload((pageNum - 1) * resolvePageWindow(), resolveFetchLimit());
              fastRowsKey = buildRowsCacheKey_(fastPayload);
              STATE.__FAST_ROWS_KEY__ = fastRowsKey;
            } catch (_) { }
          }
          fetchPromise = new Promise(function (resolve) {
            fetchPageOnlyFromCacheThenNetwork(1, function () {
              afterFetch_(resolve);
            });
          });
          return fetchPromise;
        }

        function startFastFetch_() {
          if (!STATE.pageId && !STATE.__ALLOW_PIDLESS__) return;
          runFetchOnce_('fast');
        }

        function refetchAfterConfig_() {
          if (typeof fetchPageOnlyFromCacheThenNetwork !== 'function') return;
          if (!fastRowsKey) return;
          try {
            var pageNum = STATE.page || 1;
            var finalPayload = buildServerPayload((pageNum - 1) * resolvePageWindow(), resolveFetchLimit());
            var finalKey = buildRowsCacheKey_(finalPayload);
            if (!finalKey || finalKey === fastRowsKey) return;
            fastRowsKey = finalKey;
            STATE.__FAST_ROWS_KEY__ = finalKey;
          } catch (_) { return; }
          fetchPageOnlyFromCacheThenNetwork(1, function () {
            afterFetch_();
          });
        }

        var tMeta = _perfNow_();
        var metaPromise = Promise.resolve();
        try {
          if (window.FieldsAPI && typeof window.FieldsAPI.ensureAppDataLoaded === 'function') {
            metaPromise = window.FieldsAPI.ensureAppDataLoaded('table:start');
          }
        } catch (e) {
          console.warn('[Table] ensureAppDataLoaded failed', e);
        }
        var metaReady = metaPromise.then(function (res) {
          _perfLog_('table_load_fields_api_or_meta', tMeta);
          try {
            var src = (res && res.source) ? res.source : (window.__MOTK_FIELD_TYPES_SOURCE__ || '');
            if (src) markNavFlag_('fieldTypesSource', src);
          } catch (_) { }
          try { runSchemaMembershipSweep_(STATE.sheetName, 'fields:loaded'); } catch (_) { }
          try { scheduleSchemaSweepAfterNetworkFields_(); } catch (_) { }
          if (STATE.__FIELD_ID_FILTER_DEFERRED__) {
            STATE.__FIELD_ID_FILTER_DEFERRED__ = false;
            try { renderCurrentPage && renderCurrentPage(true); } catch (_) { }
          }
          return res || null;
        }).catch(function () {
          _perfLog_('table_load_fields_api_or_meta', tMeta);
          return null;
        });

        // Delay initial fetch until page config is resolved to avoid double cache paint.

        var tPages = _perfNow_();
        var pagesPromise = fetchPagesForEntity(STATE.sheetName).then(function () {
          _perfLog_('table_pages_fetch', tPages);
        }).catch(function () {
          _perfLog_('table_pages_fetch', tPages);
        });
        await pagesPromise;
        var pageList = Array.isArray(STATE.pageList) ? STATE.pageList : [];

        // pid from URL has highest priority; if present but invalid, drop it
        var entKey = canonEntityKey_((STATE && STATE.sheetName) || '', '');
        var cachedPid = '';
        try {
          var cached = LSC_get('motk:lastPidByEntity:' + entKey);
          if (cached && cached.pid) cachedPid = String(cached.pid || '').trim();
        } catch (_) { }

        var qpid = (rawParams.pid || '').trim();
        if (qpid && !pageIdInList_(qpid, pageList)) {
          console.warn('[MOTK][BOOT] pid not found in page list; dropping pid', { pid: qpid, entity: STATE.sheetName });
          qpid = '';
        }

        var lastPid = STATE.pageId || '';
        if (lastPid && !pageIdInList_(lastPid, pageList)) {
          console.warn('[MOTK][BOOT] lastPid entity mismatch; dropping lastPid', { pid: lastPid, entity: STATE.sheetName });
          lastPid = '';
        }
        if (cachedPid && !pageIdInList_(cachedPid, pageList)) cachedPid = '';

        var pidFromName = resolvePageIdFromName_(rawParams.p || rawParams.page, pageList);
        var autoPid = '';
        if (!qpid && !pidFromName && !lastPid && !cachedPid && pageList.length) {
          autoPid = String(getPageId(pageList[0]) || '').trim();
        }

        STATE.pageId = qpid || pidFromName || lastPid || cachedPid || autoPid;
        STATE.__ALLOW_PIDLESS__ = false;
        if (!STATE.pageId) {
          if (!pageList.length) {
            setTableBanner_('error', 'No table pages configured for entity ' + (STATE.sheetName || 'unknown'));
            STATE.__ALLOW_PIDLESS__ = true;
          } else {
            setTableBanner_('warn', 'Please select a page.');
          }
        }
        if (STATE.pageId) rememberLastView();

        try {
          var usp = writeUrlState ? writeUrlState() : new URLSearchParams(location.search);
          if (STATE.pageId) usp.set('pid', STATE.pageId);

          // Maintain 'e' param preference if present, otherwise standardize on 'e'
          var originalE = getUrlParam('e');
          if (STATE.sheetName) {
            usp.set('e', STATE.sheetName);
            usp.delete('entity');
          }
          if (originalE && usp.has('entity')) usp.delete('entity');
          history.replaceState(null, '', location.pathname + '?' + usp.toString());
        } catch (_) { }

        var tLinks = _perfNow_();
        var linksP = (typeof ensureLinkMaps === 'function'
          ? ensureLinkMaps()
          : Promise.resolve(window.LINK_MAPS || {}))
          .catch(function () { })
          .then(function () {
            STATE._linksReady = true;
            _perfLog_('table_link_maps', tLinks);
          });

        if (!STATE.pageId && !STATE.__ALLOW_PIDLESS__) {
          return;
        }

        var tCfg = _perfNow_();
        var cfgP = new Promise(function (res) {
          if (typeof loadPageConfigFromCacheThenNetwork !== 'function') {
            STATE._cfgReady = true;
            _perfLog_('table_resolve_config', tCfg);
            res();
            return;
          }
          loadPageConfigFromCacheThenNetwork(STATE.pageId, function () {
            STATE._cfgReady = true;
            try {
              var cfgCount = (STATE && STATE.pageCfgRaw && Array.isArray(STATE.pageCfgRaw.order)) ? STATE.pageCfgRaw.order.length : 0;
              console.info('[TAKE213][TABLE][CFG_READY]', { t: _perfNow_(), pageId: (STATE && STATE.pageId) || '', cfgFieldsCount: cfgCount });
              if (STATE && STATE.__MINIMAL_FIELDS__ && cfgCount > 1) {
                STATE.__NEEDS_REFETCH_AFTER_CFG__ = true;
              }
            } catch (_) { }
            _perfLog_('table_resolve_config', tCfg);
            try {
              var src = STATE.__PAGE_CFG_SOURCE__ || (STATE.__PAGE_CFG_CACHE_HIT__ ? 'cache' : '');
              if (src) markNavFlag_('pageCfgSource', src);
            } catch (_) { }
            res();
          });
        });

        var cfgReady = cfgP.catch(function () { });
        await metaReady;
        await cfgReady;
        if (!fetchPromise) runFetchOnce_('cfg');
        await (fetchPromise || Promise.resolve());
        if (STATE.__NEEDS_REFETCH_AFTER_CFG__) {
          STATE.__NEEDS_REFETCH_AFTER_CFG__ = false;
          refetchAfterConfig_();
        }

        try {
          if (hasProxyPreviewCols_()) {
            scheduleProxyIndexPrefetch_('boot');
          }
        } catch (_) { }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', onDom, { once: true });
      } else {
        onDom();
      }


      // [FIX] handleNavigate removed. Full reload strategy only.
      // (removed) legacy navigate hook placeholder

    })();
  </script>

  <!-- ===== 27.saveas-modal (UI: Shared付き) ===== -->
  <div id="pgSaveAsMask"></div>
  <div id="pgSaveAs" role="dialog" aria-modal="true" aria-labelledby="pgSaveAsTitle">
    <div class="hd" id="pgSaveAsTitle">Save as Page View</div>
    <div class="bd">
      <div class="row"><label for="pgNewId">Page ID</label><input id="pgNewId" placeholder="pg_XXXX" /></div>
      <div class="row"><label for="pgName">Page Name</label><input id="pgName" placeholder="View name" /></div>
      <div class="row"><label for="pgType">Page Type</label>
        <select id="pgType">
          <option value="table">table</option>
          <option value="overview">overview</option>
          <option value="detail">detail</option>
        </select>
      </div>
      <div class="row"><label for="pgEntity">Entity</label>
        <select id="pgEntity">
          <option value="shot">shot</option>
          <option value="asset">asset</option>
          <option value="task">task</option>
          <option value="member">member</option>
          <option value="user">user</option>
        </select>
      </div>
      <div class="row" style="display:flex;align-items:center;gap:8px">
        <input id="pgShared" type="checkbox" /><label for="pgShared">Shared</label>
      </div>
    </div>
    <div class="ft">
      <button id="pgSaveAsCancel">Cancel</button>
      <button id="pgSaveAsOk">Save</button>
    </div>
  </div>

  <!-- ===== 27.field-wizard-modal ===== -->
  <div id="fieldWizardMask"></div>
  <div id="fieldWizard" role="dialog" aria-modal="true" aria-labelledby="fieldWizardTitle">
    <div class="hd" id="fieldWizardTitle">Add Field</div>
    <div class="bd">
      <div class="row"><label for="fwFieldId">field_id</label><input id="fwFieldId" disabled /></div>
      <div class="row"><label for="fwEntity">entity</label><input id="fwEntity" disabled /></div>
      <div class="row"><label for="fwLabel">field_name</label><input id="fwLabel" placeholder="Field name" /></div>
      <div class="row"><label for="fwType">type</label>
        <select id="fwType">
          <option value="text">text</option>
          <option value="checkbox">checkbox</option>
          <option value="select">select</option>
          <option value="date">date</option>
          <option value="id">id</option>
          <option value="entity_name">entity_name</option>
          <option value="json">json</option>
          <option value="thumbnails">thumbnails</option>
          <option value="file_list">file_list</option>
          <option value="originals">originals</option>
          <option value="versions">versions</option>
          <option value="shot_link">shot_link</option>
          <option value="asset_link">asset_link</option>
          <option value="task_link">task_link</option>
          <option value="member_link">member_link</option>
          <option value="user_link">user_link</option>
        </select>
      </div>
      <div class="row"><label for="fwEditable">editable</label><input id="fwEditable" type="checkbox" /></div>
      <div class="row"><label for="fwRequired">required</label><input id="fwRequired" type="checkbox" /></div>
      <div class="row"><label for="fwOptions">options</label><input id="fwOptions" placeholder="pipe-separated (optional)" /></div>
      <div class="row"><label for="fwCore">core</label><input id="fwCore" type="checkbox" /></div>
    </div>
    <div class="ft">
      <button id="fwCancel">Cancel</button>
      <button id="fwSave">Add</button>
    </div>
  </div>

  <script>
    /* ===== 28.local_cache (Config/Labels TTLキャッシュ) ===== */
    (function () {
      var TTL_MS = 15000;
      function k(ns, id) { return "MOTK." + ns + "." + id; }
      function now() { return Date.now(); }
      window.MOTKCache = {
        get: function (ns, id) {
          try {
            var raw = localStorage.getItem(k(ns, id)); if (!raw) return null;
            var obj = JSON.parse(raw);
            if (!obj || !obj.t || now() - obj.t > TTL_MS) return null;
            return obj.v;
          } catch (e) { return null; }
        },
        set: function (ns, id, val) {
          try { localStorage.setItem(k(ns, id), JSON.stringify({ t: now(), v: val })); } catch (e) { }
        }
      };
    })();

    /* ===== 29.prefetch_pages ===== */
    (function () {
      var TTL_MS = 15000;
      function k(ns, id) { return "MOTK." + ns + "." + id; }
      function now() { return Date.now(); }
      function cacheGet(ns, id) {
        try {
          var raw = localStorage.getItem(k(ns, id)); if (!raw) return null;
          var obj = JSON.parse(raw); if (!obj || !obj.t || now() - obj.t > TTL_MS) return null;
          return obj.v;
        } catch (e) { return null; }
      }
      function cacheSet(ns, id, val) {
        try { localStorage.setItem(k(ns, id), JSON.stringify({ t: now(), v: val })); } catch (e) { }
      }
      window.prefetchPagesForEntity = function (entity, pageType) {
        entity = entity || 'shot';
        pageType = pageType || 'table';
        google.script.run.withSuccessHandler(function (list) {
          if (!Array.isArray(list) || !list.length) return;
          var ids = list.map(function (x) { return x.id; });
          list.forEach(function (p) { cacheSet('page.meta', p.id, p); });
          google.script.run.withSuccessHandler(function (map) {
            map = map || {};
            Object.keys(map).forEach(function (pid) { cacheSet('page.cfg', pid, map[pid]); });
          }).gsLoadPageConfigsBulk(ids);
        }).gsListPagePresets({ entity: entity, pageType: pageType });
      };
      window.getPageConfigCached = function (pageId, onReady) {
        var cfg = cacheGet('page.cfg', pageId);
        if (cfg) { if (onReady) onReady(cfg); return; }
        google.script.run.withSuccessHandler(function (c) {
          cacheSet('page.cfg', pageId, c || {});
          if (onReady) onReady(c || {});
        }).gsLoadPageConfig({ pageId: pageId });
      };
    })();

    /* ===== 30.link_labels (安定ラベル置換: 一括API + キャッシュ) ===== */
    (function () {
      function uniq(arr) {
        var s = {}, o = [];
        for (var i = 0; i < arr.length; i++) {
          var v = String(arr[i] || ''); if (!v) continue;
          if (s[v]) continue; s[v] = 1; o.push(v);
        }
        return o;
      }
      function isIdLike(s) { return /^((sh|as|ta|us|mb|pg)_\w+)/i.test(s); }

      async function resolveLabels(ids) {
        var out = {}, miss = [];
        for (var i = 0; i < ids.length; i++) {
          var id = ids[i], c = window.MOTKCache && MOTKCache.get('label', id);
          if (c != null) { out[id] = c; } else { miss.push(id); }
        }
        if (miss.length) {
          await new Promise(function (done) {
            google.script.run.withSuccessHandler(function (map) {
              map = map || {};
              Object.keys(map).forEach(function (k) {
                MOTKCache && MOTKCache.set('label', k, map[k]);
                out[k] = map[k];
              });
              done();
            }).withFailureHandler(function () { done(); })
              .dp_resolveLabelsBulk(miss);
          });
        }
        return out;
      }

      window.applyEntityLinkLabels = async function (container) {
        var root = (typeof container === 'string') ? document.querySelector(container) : container;
        if (!root) return;
        var texts = Array.prototype.map.call(root.querySelectorAll('[data-cell]'), function (n) { return n.textContent.trim(); });
        var ids = uniq(texts.filter(isIdLike));
        if (!ids.length) return;

        var map = await resolveLabels(ids);
        Array.prototype.forEach.call(root.querySelectorAll('[data-cell]'), function (n) {
          var t = n.textContent.trim();
          if (map[t]) n.textContent = map[t];
        });
      };
    })();
  </script>

</body>

</html>
