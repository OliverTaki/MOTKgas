<!doctype html>
<html>

<head>
  <base target="_top" />
  <meta charset="utf-8" />
  <title>MOTKsheets G-Viewer</title>
  <?!= include('3CL_CommonStyles'); ?>
</head>

<body data-nav-page="<?= page ?>" data-nav-entity="<?= entity ?>">
  <!-- ===== 1.gnav ===== -->
  <nav id="gNav" class="gnavi" aria-label="Global Navigation">
    <span class="logo">MOTK</span>
    <a class="mi" data-page="Dashboard" href="<?= scriptUrl ?>?page=Dashboard">Dashboard</a>
    <a class="mi" data-page="Settings" href="<?= scriptUrl ?>?page=Settings" target="_blank" rel="noopener">Settings</a>
    <span class="spacer"></span>
    <a class="mi debug" data-page="DebugPanelPage" href="<?= scriptUrl ?>?page=DebugPanelPage" target="_blank"
      title="Debug Panel">
      &#x1F41E; Debug
    </a>
  </nav>
  <!-- ===== 1.End ===== -->

  <!-- ===== 2.pnav ===== -->
  <? var __PNAVI_ITEMS__ = (function () {
    var base = String(scriptUrl || '').trim();
    function makeHref(path) {
      if (!path) return '';
      var p = String(path);
      if (/^https?:\/\//i.test(p)) return p;
      if (p.charAt(0) === '?') return base + p;
      if (p.indexOf('p=') >= 0 || p.indexOf('page=') >= 0) return base + '?' + p;
      return base + '?p=' + encodeURIComponent(p);
    }
    function normalizeItem(it) {
      if (!it) return null;
      var id = String(it.id || '').trim();
      if (!id) return null;
      var label = String(it.label || id);
      var enabled = (it.enabled === false) ? false : true;
      var href = String(it.href || it.url || '').trim();
      var page = String(it.page || '').trim();
      var entity = String(it.entity || '').trim();
      var target = String(it.target || '').trim();
      if (!href) {
        if (id === 'shots') { href = base + '?p=table&e=shots'; page = page || 'Shots'; entity = entity || 'shot'; }
        else if (id === 'assets') { href = base + '?p=table&e=assets'; page = page || 'Assets'; entity = entity || 'asset'; }
        else if (id === 'tasks') { href = base + '?p=table&e=tasks'; page = page || 'Tasks'; entity = entity || 'task'; }
        else if (id === 'members') { href = base + '?p=table&e=members'; page = page || 'ProjectMembers'; entity = entity || 'member'; }
        else if (id === 'users') { href = base + '?p=table&e=users'; page = page || 'Users'; entity = entity || 'user'; }
        else if (id === 'schedule') { href = base + '?p=schedule'; page = page || 'Schedule'; target = '_blank'; }
        else { href = makeHref(id); }
      } else {
        href = makeHref(href);
      }
      if (id === 'schedule') target = '_blank';
      return { id: id, label: label, href: href, enabled: enabled, page: page, entity: entity, target: target };
    }
    var defaults = [
      { id: 'shots', label: 'Shots', href: base + '?p=table&e=shots', page: 'Shots', entity: 'shot', enabled: true },
      { id: 'assets', label: 'Assets', href: base + '?p=table&e=assets', page: 'Assets', entity: 'asset', enabled: true },
      { id: 'tasks', label: 'Tasks', href: base + '?p=table&e=tasks', page: 'Tasks', entity: 'task', enabled: true },
      { id: 'members', label: 'Members', href: base + '?p=table&e=members', page: 'ProjectMembers', entity: 'member', enabled: true },
      { id: 'users', label: 'Users', href: base + '?p=table&e=users', page: 'Users', entity: 'user', enabled: true },
      { id: 'schedule', label: 'Schedule', href: base + '?p=schedule', page: 'Schedule', enabled: true, target: '_blank' }
    ];
    try {
      var ss = SpreadsheetApp.getActiveSpreadsheet();
      var sh = ss ? ss.getSheetByName('project_meta') : null;
      if (sh && typeof _sv_readProjectMeta_ === 'function') {
        var meta = _sv_readProjectMeta_(sh) || {};
        var raw = meta['pnavi.config.json'] || meta['pnavi.config'] || '';
        if (raw) {
          var cfg = JSON.parse(String(raw));
          if (cfg && Array.isArray(cfg.items)) {
            var out = [];
            for (var i = 0; i < cfg.items.length; i++) {
              var item = normalizeItem(cfg.items[i]);
              if (item) out.push(item);
            }
            if (out.length) return out;
          }
        }
      }
    } catch (_) { }
    return defaults;
  })(); ?>
  <nav id="pNav" aria-label="Entity Navigation">
    <? for (var i = 0; i < __PNAVI_ITEMS__.length; i++) {
      var it = __PNAVI_ITEMS__[i];
      if (it.enabled === false) continue; ?>
      <a data-page="<?= it.page || '' ?>"<? if (it.entity) { ?> data-entity="<?= it.entity ?>"<? } ?> href="<?= it.href ?>"<? if (it.target) { ?> target="<?= it.target ?>" rel="noopener"<? } ?>><?= it.label ?></a>
    <? } ?>
  </nav>
  <!-- ===== 2.End ===== -->
  <?!= include('3CL_Router'); ?>

  <main id="main-content">
    <div class="loader">Loading...</div>
  </main>

  <script>
    // Console tap: persist app logs for DebugPanel export (session-scoped).
    (function installMotkConsoleTap() {
      if (window.__MOTK_CONSOLE_TAP_INSTALLED__) return;
      window.__MOTK_CONSOLE_TAP_INSTALLED__ = true;

      var KEY = "motk:console:buffer:v1";
      var MAX = 2000;
      var warned = false;

      function safeToText(x) {
        try {
          if (typeof x === "string") return x;
          if (x instanceof Error) return x.name + ": " + x.message + (x.stack ? ("\n" + x.stack) : "");
          return JSON.stringify(x);
        } catch (e) {
          try { return String(x); } catch (_) { return "[unstringifiable]"; }
        }
      }

      function load() {
        try {
          var raw = sessionStorage.getItem(KEY);
          if (!raw) return [];
          var parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch (_) {
          return [];
        }
      }

      var buf = load();
      var saveTimer = 0;

      function scheduleSave() {
        if (saveTimer) return;
        saveTimer = window.setTimeout(function () {
          saveTimer = 0;
          try {
            sessionStorage.setItem(KEY, JSON.stringify(buf));
          } catch (e) {
            if (!warned) {
              warned = true;
              try { console.warn("[MOTK][ConsoleTap] storage write failed", e); } catch (_) { }
            }
          }
        }, 250);
      }

      function push(level, args) {
        var ts = Date.now();
        var msg = Array.prototype.slice.call(args).map(safeToText).join(" ");
        buf.push({ ts: ts, level: level, msg: msg });
        if (buf.length > MAX) buf.splice(0, buf.length - MAX);
        scheduleSave();
      }

      var orig = {
        log: console.log.bind(console),
        info: console.info.bind(console),
        warn: console.warn.bind(console),
        error: console.error.bind(console)
      };

      console.log = function () { push("log", arguments); orig.log.apply(console, arguments); };
      console.info = function () { push("info", arguments); orig.info.apply(console, arguments); };
      console.warn = function () { push("warn", arguments); orig.warn.apply(console, arguments); };
      console.error = function () { push("error", arguments); orig.error.apply(console, arguments); };

      window.__MOTK_CONSOLE_EXPORT__ = function exportMotkConsole() {
        return buf.slice();
      };
    })();
  </script>

  <!-- ===== 4. Data bootstrapping ===== -->
  <script>
    const PAGE = "<?= page ?>";

    // Bridge scriptUrl to all Router/Renderer consumers
    (function () {
      // Primary value from server (ScriptApp.getService().getUrl())
      var url = "<?= scriptUrl ?>";

      // Safety fallback in case scriptUrl is empty for some reason
      if (!url) {
        url = window.__SCRIPT_URL__ || window.SCRIPT_URL || (location.origin + location.pathname);
      }

      // Normalize to a single source of truth
      window.__SCRIPT_URL__ = url;
      window.SCRIPT_URL = url;
      window.scriptUrl = url;

      console.log("[MOTK][Shell] SCRIPT URL bridge set:", url);
      try {
        if (window.__MOTK_BOOT__ && typeof window.__MOTK_BOOT__.updateContext === 'function') {
          window.__MOTK_BOOT__.updateContext({
            scriptUrlBridge: url,
            pageHint: (typeof PAGE !== 'undefined') ? PAGE : '',
            entityHint: (document.body && document.body.dataset && (document.body.dataset.navEntity || document.body.dataset.entity)) || ''
          });
        }
      } catch (_) { }
    })();

    const raw = JSON.parse(<?= dataJson ?>);
    window.__VIEW_CTX = (raw && raw.viewCtx) ? raw.viewCtx : {};
    window.__ALL_DATA = (raw && raw.data) ? raw.data : {};
    window.__SERVER_CONFIG = (raw && raw.config) ? raw.config : {};

    console.log("[MOTK][Shell] Bootstrapped view context:", window.__VIEW_CTX);
  </script>


  <script src="<?= scriptUrl ?>?action=app-bundle"></script>

  <?!= include('3CL_Table'); ?>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const loader = document.querySelector('.loader');
      if (loader) loader.style.display = 'none';
    });
  </script>
</body>

</html>
