<!DOCTYPE html>
<html lang="en" class="detail-root">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="x-ua-compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detail</title>

  <!-- Common Styles -->
  <?!= include('3CL_CommonStyles'); ?>

  <!-- Script URL expose -->
  <script>
    (function () {
      var url;
      try { url = "<?= ScriptApp.getService().getUrl() ?>"; } 
      catch (e) { url = window.__SCRIPT_URL__ || window.SCRIPT_URL || (location.origin + location.pathname); }
      window.__SCRIPT_URL__ = url; window.SCRIPT_URL = url; window.scriptUrl = url;
    })();
  </script>
</head>

<body class="detail-page" data-nav-page="<?= page ?>" data-nav-entity="<?= entity ?>" data-record-id="<?= id ?>">
  
  <div id="v2-loading-overlay">
    <div class="spinner">Loading View...</div>
  </div>

  <nav id="gNav" class="gnavi" aria-label="Global Navigation">
    <span class="logo">MOTK</span>
    <a class="mi" data-page="Dashboard" href="<?= scriptUrl ?>?page=Dashboard">Dashboard</a>
    <a class="mi" data-page="Settings" href="<?= scriptUrl ?>?page=Settings">Settings</a>
    <span class="spacer"></span>
    <a class="mi debug" data-page="DebugPanelPage" href="<?= scriptUrl ?>?page=DebugPanelPage" target="_blank" title="Debug Panel">&#x1F41E; Debug</a>
  </nav>

  <nav id="pNav" aria-label="Entity Navigation">
    <a data-page="Shots" data-entity="shot" href="<?= scriptUrl ?>?p=table&e=shots">Shots</a>
    <a data-page="Assets" data-entity="asset" href="<?= scriptUrl ?>?p=table&e=assets">Assets</a>
    <a data-page="Tasks" data-entity="task" href="<?= scriptUrl ?>?p=table&e=tasks">Tasks</a>
    <a data-page="ProjectMembers" data-entity="member" href="<?= scriptUrl ?>?p=table&e=members">Members</a>
    <a data-page="Users" data-entity="user" href="<?= scriptUrl ?>?p=table&e=users">Users</a>
  </nav>

  <?!= include('3CL_Router'); ?>
  <?!= include('3CL_CommonRenderer'); ?>

  <div class="toolbar" id="toolbar">
    <div class="left">
      <span id="title" class="title">Detail</span>
      <button id="prev" class="btn">Prev</button>
      <button id="next" class="btn">Next</button>
    </div>
    <div class="toolbar-center"><span class="mode-badge" id="modeBadge">EDIT MODE</span></div>
    <div class="right">
      <button id="cardsBtn" class="btn" style="display:none" title="Manage Cards">Cards</button>
      <div style="position:relative">
        <button id="saveBtnAll" class="btn btn-save" style="display:none" title="Save options">Save Menu</button>
        <div id="saveMenu" class="menu">
          <div class="mi" data-cmd="save">Save</div>
          <div class="mi" data-cmd="saveas">Save As...</div>
          <div class="mi" data-cmd="revert">Revert</div>
        </div>
      </div>
      <button id="toggleLayout" class="mode-toggle" title="Toggle Layout Edit">View mode</button>
      <select id="presetSelect" class="select" title="Preset"></select>
    </div>
  </div>

  <div class="wrap">
    <div id="error" class="notice" style="display:none"></div>
    <div id="gridWrap">
      <div id="grid" class="grid"></div>
    </div>
  </div>

  <div id="hScroll" aria-hidden="true" style="display:none"><div id="hScrollInner" style="height:1px"></div></div>

  <div id="footerBar" class="footer-bar">
    <span id="footerMode">View mode</span>
    <span id="footerPage">Detail</span>
  </div>

  <!-- Modals -->
  <div id="v2-save-modal" class="v2-modal-overlay" aria-hidden="true" style="display:none;">
    <div class="v2-modal-panel">
      <div class="hd">Save As</div>
      <div class="bd">
        <div class="row">
          <label>Preset Name</label>
          <input id="saveAsName" class="input grow" placeholder="Preset name" />
        </div>
        <div class="row">
          <label>Permission</label>
          <label><input id="saveAsEdit" type="checkbox" checked /> Allow overwrite (Edit)</label>
        </div>
      </div>
      <div class="ft">
        <button id="saveCancel" class="btn">Cancel</button>
        <button id="saveApply" class="btn">Apply</button>
      </div>
    </div>
  </div>

  <div id="v2-cards-modal" class="v2-modal-overlay" aria-hidden="true" style="display:none;">
    <div class="v2-modal-panel">
      <div class="hd">Cards</div>
      <div class="bd">
        <div id="cardsList"></div>
        <div class="row" style="margin-top:15px;"><button id="addCard" class="btn" style="width:100%">+ New Card</button></div>
      </div>
      <div class="ft"><button id="cardsClose" class="btn">Close</button></div>
    </div>
  </div>

  <div id="v2-field-modal" class="v2-modal-overlay" aria-hidden="true" style="display:none;">
    <div class="v2-modal-panel">
      <div class="hd">Card Settings</div>
      <div class="bd">
        <div class="row"><label style="min-width:80px">Title</label><input id="cardTitle" class="input grow" /></div>
        <div id="fieldList"></div>
      </div>
      <div class="ft">
        <button id="fieldCancel" class="btn">Cancel</button>
        <button id="fieldApply" class="btn">Apply</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      "use strict";

      /* ===== 13.1 Utils ===== */
      var $ = function (sel) { return document.querySelector(sel); };
      function gsr() { return (window.google && google.script && google.script.run) || null; }
      
      function tryCall(names, args) {
        return new Promise(function (resolve, reject) {
          var r = gsr(); if (!r) return reject(new Error("gsr missing"));
          (function next(i) {
            if (i >= names.length) return reject(new Error("no api"));
            var fn = names[i]; if (typeof r[fn] !== "function") return next(i + 1);
            r.withSuccessHandler(resolve).withFailureHandler(function () { next(i + 1); })[fn](args);
          })(0);
        });
      }
      
      function setLoading(show) {
        var el = document.getElementById("v2-loading-overlay");
        if(el) {
            if(show) el.classList.add("active");
            else el.classList.remove("active");
        }
      }

      function showStatus(msg, isError) {
        var el = document.getElementById("footerPage");
        if (el) {
          el.textContent = msg;
          el.style.color = isError ? "#ff5555" : "inherit";
          if (!isError) setTimeout(function(){ if(el.textContent === msg) el.textContent = "Detail"; }, 4000);
        }
      }

      /* ===== Helper Functions ===== */
      function capitalize(s) {
        if (!s) return '';
        return s.charAt(0).toUpperCase() + s.slice(1);
      }

      function singularEntityFor(x) {
        var s = String(x||'').toLowerCase().trim().replace(/[\s_-]/g, '');
        if (s === 'shots' || s === 'shot') return 'shot';
        if (s === 'assets' || s === 'asset') return 'asset';
        if (s === 'tasks' || s === 'task') return 'task';
        if (s === 'users' || s === 'user') return 'user';
        if (s === 'projectmembers' || s === 'members' || s === 'projectmember') return 'member';
        return s || 'shot';
      }
      function pluralEntityFor(x) {
        var s = singularEntityFor(x);
        if (s === 'shot') return 'Shots';
        if (s === 'asset') return 'Assets';
        if (s === 'task') return 'Tasks';
        if (s === 'user') return 'Users';
        if (s === 'member') return 'ProjectMembers';
        return 'Shots';
      }

      function normalizeRowsPayload(res) {
        if (!res) return { ids:[], header:[], rows:[], total:0 };
        if (res.columns && Array.isArray(res.columns)) {
            var ids = res.columns.map(function(c){ return String(c.id||c.field_id||""); });
            var header = res.columns.map(function(c){ return String(c.name||c.label||c.title||""); });
            var rows = Array.isArray(res.rows) ? res.rows : [];
            return { ids:ids, header:header, rows:rows, total:res.total||rows.length, columns:res.columns };
        }
        if (Array.isArray(res.ids) && Array.isArray(res.rows)) {
            return { ids:res.ids, header:res.header||[], rows:res.rows, total:res.total||0, columns:[] };
        }
        return { ids:[], header:[], rows:[], total:0 };
      }

      /* ===== 13.2 Router ===== */
      var Router = (window.__Router__ || {
        baseUrl: function () { return (window.scriptUrl || window.SCRIPT_URL || (location.origin + location.pathname)); },
        buildEntityUrl: function (ent, id) {
          var u = new URL(this.baseUrl(), this.baseUrl());
          u.searchParams.set("page", "DetailShot");
          u.searchParams.set("entity", ent || "shot");
          u.searchParams.set("id", id || "");
          return u.toString();
        }
      });

      /* ===== 13.3 State ===== */
      var STATE = {
        entity: "shot", id: "", sheet: "Shots", pageKey: "",
        ids: [], header: [], rows: [], columns: [], idxId: 0, pos: -1,
        row: {}, labels: {}, fieldsMeta: {},
        edit: false, layout: [],
        drag: { active: false, mode: "", card: null, start: { x: 0, y: 0, w: 0, h: 0 }, colW: 0, rowStep: 0, gridLeft: 0, gridTop: 0 },
        presets: [], currentPreset: ""
      };

      /* ===== 13.4 Link maps & Proxy ===== */
      window.LINK_MAPS = window.LINK_MAPS || { assets: {}, shots: {}, tasks: {}, users: {}, members: {} };
      var PROXY_CACHE = {};

      function prefetchProxyIndex() {
        if (!gsr()) return;
        tryCall(['sv_indexAllProxies'], {}).then(function (idx) {
            try {
              var latest = (idx && idx.latestByShotId) ? idx.latestByShotId : {};
              for (var k in latest) { PROXY_CACHE[String(k)] = latest[k] || null; }
              var grid = document.getElementById("grid");
              if(grid) {
                  var svCards = grid.querySelectorAll('.card[data-type="shotview"]');
                  svCards.forEach(function(c){
                      var inner = c.querySelector('.inner');
                      if(inner) renderShotViewContent(inner);
                  });
              }
            } catch (e) { }
        });
      }

      function defaultDetailTitle() {
        var ent = STATE.entity;
        return ent.charAt(0).toUpperCase() + ent.slice(1) + " Detail";
      }
      function deriveRecordTitle() {
        var row = STATE.row || {};
        var ids = Array.isArray(STATE.ids) ? STATE.ids : [];
        for (var i = 0; i < ids.length; i++) {
          var fid = ids[i];
          var meta = (STATE.fieldsMeta && STATE.fieldsMeta[fid]) ? STATE.fieldsMeta[fid] : null;
          var t = meta && meta.type ? String(meta.type).trim().toLowerCase() : "";
          if (t === "entity_name" || t === "name") {
            var v = row[fid];
            if (v != null && String(v).trim()) return String(v);
          }
        }
        if (row["fi_0002"] != null && String(row["fi_0002"]).trim()) return String(row["fi_0002"]);
        if (STATE.id) return String(STATE.id);
        return "";
      }

      function entityFromPageKey(pg) {
        var key = String(pg || '').toLowerCase();
        if (!key) return '';
        if (key === 'detailasset') return 'asset';
        if (key === 'detailtask') return 'task';
        if (key === 'detailuser') return 'user';
        if (key === 'detailmember') return 'member';
        return 'shot';
      }
      function queryStringPage() {
        try { return String((new URLSearchParams(location.search || '')).get('page') || '').toLowerCase(); } catch (_) { return ''; }
      }
      function pageKeyFromEntity(ent) {
        var canon = String(ent || '').toLowerCase();
        var key = '';
        if (typeof detailPageNameForEntity === 'function') {
          try { key = detailPageNameForEntity(canon); } catch (_) { key = ''; }
        }
        if (key) return key;
        if (canon === 'asset' || canon === 'assets') return 'DetailAsset';
        if (canon === 'task' || canon === 'tasks') return 'DetailTask';
        if (canon === 'user' || canon === 'users') return 'DetailUser';
        if (canon === 'member' || canon === 'members' || canon === 'projectmember' || canon === 'projectmembers') return 'DetailMember';
        return 'DetailShot';
      }

      function ensurePageKey(force) {
        if (!window.STATE) return 'DetailShot';
        var ent = String((STATE && STATE.entity) || '').toLowerCase();
        if (!ent) {
          var body = (typeof document !== 'undefined' && document.body) ? document.body : null;
          if (body && body.dataset) {
            var hinted = String(body.dataset.navEntity || '').toLowerCase();
            if (!hinted) { hinted = entityFromPageKey(body.dataset.navPage); }
            if (!hinted) { hinted = entityFromPageKey(queryStringPage()); }
            if (hinted) { ent = hinted; if (STATE) STATE.entity = hinted; }
          }
        }
        var desired = pageKeyFromEntity(ent);
        if (force || !STATE.pageKey || STATE.pageKey.toLowerCase() !== desired.toLowerCase()) {
          STATE.pageKey = desired;
        }
        if (typeof document !== 'undefined' && document.body && document.body.dataset) {
          document.body.dataset.navPage = STATE.pageKey;
          if (STATE.entity) document.body.dataset.navEntity = STATE.entity;
        }
        return STATE.pageKey;
      }

      function currentPageKey() {
        if (STATE && STATE.pageKey) return STATE.pageKey;
        return ensurePageKey();
      }
      function storageKey(prefix) {
        return currentPageKey() + ':' + prefix;
      }

      /* ===== 13.5 Grid helpers ===== */
      function gridMetrics() {
        var grid = $("#grid"), rect = grid.getBoundingClientRect();
        var cs = getComputedStyle(grid);
        var cols = parseInt(cs.getPropertyValue("--cols"), 10);
        if (isNaN(cols) || cols < 24) cols = 24;

        var rowh = parseFloat(cs.getPropertyValue("--rowh"));
        var gap = parseFloat(cs.getPropertyValue("--gap"));
        if(isNaN(gap)) gap = 4;
        
        var colW = 100;
        var fixedW = cs.getPropertyValue("--col-width");
        if(fixedW) colW = parseInt(fixedW, 10) || 100;

        var totalWidthNeeded = (cols * colW) + ((cols - 1) * gap);
        grid.style.width = totalWidthNeeded + "px";
        grid.style.gridTemplateColumns = "repeat(" + cols + ", " + colW + "px)";

        var gridLeft = rect.left + window.scrollX;
        var gridTop = rect.top + window.scrollY;
        
        return { grid, rect, cols, rowh, gap, colW, rowStep: (rowh + gap), gridLeft, gridTop };
      }
      
      function applyXYWH(card, x, y, w, h) {
        card.dataset.x = x; card.dataset.y = y; card.dataset.w = w; card.dataset.h = h;
        card.style.gridColumn = (x + 1) + " / span " + w;
        card.style.gridRow = (y + 1) + " / span " + h;
      }
      function rectOf(card) { return { x: +card.dataset.x, y: +card.dataset.y, w: +card.dataset.w, h: +card.dataset.h }; }
      function collides(a, b) { return !(a.x + a.w <= b.x || b.x + b.w <= a.x || a.y + a.h <= b.y || b.y + b.h <= a.y); }
      function maxOccupiedY() {
        var max = 0; $("#grid").querySelectorAll(".card").forEach(function (c) {
          var y = +c.dataset.y, h = +c.dataset.h; if (y + h > max) max = y + h;
        }); return max;
      }
      function placeWithoutOverlap(card, x, y, w, h) {
        var boxes = [], grid = $("#grid");
        grid.querySelectorAll(".card").forEach(function (el) { if (el !== card) boxes.push(rectOf(el)); });
        var pos = { x: x, y: y, w: w, h: h };
        var safe = 0;
        while (safe < 400) {
          var ok = true;
          for (var i = 0; i < boxes.length; i++) { if (collides(pos, boxes[i])) { ok = false; break; } }
          if (ok) return pos;
          pos.y++;
          safe++;
        }
        return pos;
      }

      /* horizontal scroll + bottom padding fix */
      var HSCROLL = { init: false, wrap: null, bar: null, inner: null, skipWrap: false, skipBar: false };
      function setupHorizontalScroll() {
        if (HSCROLL.init) return;
        var wrap = document.getElementById('gridWrap');
        var bar = document.getElementById('hScroll');
        var inner = document.getElementById('hScrollInner');
        if (!wrap || !bar || !inner) return;
        HSCROLL.wrap = wrap; HSCROLL.bar = bar; HSCROLL.inner = inner; HSCROLL.init = true;

        wrap.style.overflow = 'auto';
        wrap.style.willChange = 'scroll-position';

        wrap.addEventListener('scroll', function () {
          if (HSCROLL.skipWrap) { HSCROLL.skipWrap = false; return; }
          HSCROLL.skipBar = true;
          bar.scrollLeft = wrap.scrollLeft;
          requestAnimationFrame(function () { HSCROLL.skipBar = false; });
        }, { passive: true });
        bar.addEventListener('scroll', function () {
          if (HSCROLL.skipBar) { HSCROLL.skipBar = false; return; }
          HSCROLL.skipWrap = true;
          wrap.scrollLeft = bar.scrollLeft;
          requestAnimationFrame(function () { HSCROLL.skipWrap = false; });
        }, { passive: true });
      }
      function refreshHorizontalScroll() {
        setupHorizontalScroll();
        if (!HSCROLL.init) return;
        var wrap = HSCROLL.wrap, bar = HSCROLL.bar, inner = HSCROLL.inner;
        if (!wrap || !bar || !inner) return;

        var footerH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--footer-h') || '22', 10) || 22;
        var padBottom = footerH + 12 + bar.offsetHeight;
        bar.style.bottom = 'var(--footer-h,22px)';
        bar.style.top = 'auto';

        var width = wrap.scrollWidth || 0;
        var viewport = wrap.clientWidth || 0;
        if (width > viewport + 1) {
          inner.style.width = width + 'px';
          bar.style.display = 'block';
          if (!HSCROLL.skipBar) {
            HSCROLL.skipBar = true;
            bar.scrollLeft = wrap.scrollLeft;
            requestAnimationFrame(function () { HSCROLL.skipBar = false; });
          }
        } else {
          bar.style.display = 'none';
        }
      }
      if (typeof window !== 'undefined') {
        window.addEventListener('resize', function () {
          requestAnimationFrame(function () {
            ensureToolbarVisible();
            refreshHorizontalScroll();
          });
        });
      }

      /* ===== 13.6 Toolbar ===== */
      function ensureToolbarVisible() {
        var tb = document.getElementById("toolbar"); if (!tb) return;
        try {
          tb.style.display = "grid";
          tb.style.visibility = "visible";
          tb.style.opacity = "1";
          tb.style.position = "fixed";
          tb.style.left = "0"; tb.style.right = "0";
          tb.style.zIndex = "1200";

          var g = document.getElementById("gNav"), p = document.getElementById("pNav");
          var gHeight = g && g.getBoundingClientRect ? Math.round(g.getBoundingClientRect().height) : 0;
          var pHeight = p && p.getBoundingClientRect ? Math.round(p.getBoundingClientRect().height) : 0;
          var FIXED_TOOLBAR_PX = 32;
          tb.style.height = FIXED_TOOLBAR_PX + "px";
          tb.style.minHeight = FIXED_TOOLBAR_PX + "px";
          tb.style.maxHeight = FIXED_TOOLBAR_PX + "px";

          var topForToolbar = gHeight + pHeight;
          tb.style.top = topForToolbar + "px";

          var root = document.documentElement;
          if (root) {
            root.style.setProperty('--gnav-height', gHeight + 'px');
            root.style.setProperty('--pnav-height', pHeight + 'px');
          }

          var tbHeight = tb.getBoundingClientRect ? Math.round(tb.getBoundingClientRect().height) : FIXED_TOOLBAR_PX;
          var topOffsetFull = gHeight + pHeight + tbHeight;

          if (root) {
            root.style.setProperty('--top-offset', topOffsetFull + 'px');
          }
          var wrap = document.getElementById("gridWrap");
          if (wrap) {
            wrap.style.top = topOffsetFull + "px";
          }

          document.querySelectorAll(".spacer-top").forEach(function (n) { try { n.parentNode.removeChild(n); } catch (_) { } });

          var grid = document.querySelector("#gridstackWrap") || document.querySelector("#grid") || document.querySelector(".grid-stack");
          if (grid) { grid.style.marginTop = "0"; grid.style.top = "0"; }
          
          gridMetrics();

          var bandSel = ["#hScroll", ".top-band", ".grid-top-gap", ".grid-overlay"];
          bandSel.forEach(function (sel) { var el = document.querySelector(sel); if (el) { el.style.display = "none"; } });
        } catch (_) { }
      }

      function lockCardHeaderHeights() {
        var TARGET = 24;
        document.querySelectorAll("#grid .card .card-header").forEach(function (hd) {
          hd.style.minHeight = TARGET + "px";
          hd.style.height = TARGET + "px";
          hd.style.paddingTop = "2px";
          hd.style.paddingBottom = "2px";
        });
      }

      function bindToolbar() {
        var tl = $("#toggleLayout");
        var badge = $("#modeBadge");
        var footer = $("#footerMode");
        
        function applyMode() {
          var isEdit = !!STATE.edit;
          var body = document.body;
          if (body) {
            body.classList.toggle("layout-edit", isEdit);
            body.setAttribute("data-layout-mode", isEdit ? "edit" : "view");
          }
          
          var save = document.getElementById("saveBtnAll");
          var cards = document.getElementById("cardsBtn");
          
          if (save) { save.style.display = isEdit ? "" : "none"; save.disabled = !isEdit; }
          if (cards) { cards.style.display = isEdit ? "" : "none"; cards.disabled = !isEdit; }
          
          if (tl) { 
            tl.textContent = isEdit ? "Edit mode" : "View mode";
            tl.setAttribute("aria-pressed", isEdit ? "true" : "false");
            tl.classList.toggle("is-active", isEdit);
          }
          if (badge) { badge.textContent = isEdit ? "EDIT MODE" : "VIEW MODE"; badge.style.display = isEdit ? "inline-flex" : "none"; }
          if (footer) { footer.textContent = isEdit ? "Edit mode" : "View mode"; }

          var tb = document.getElementById("toolbar");
          if (tb) { tb.classList.toggle("is-edit", isEdit); tb.setAttribute("data-mode", isEdit ? "edit" : "view"); }

          var removes = document.querySelectorAll(".card-remove");
          removes.forEach(function(el){ 
             el.style.setProperty('display', isEdit ? 'flex' : 'none', 'important');
          });

          requestAnimationFrame(lockCardHeaderHeights);
        }
        
        if (tl) { 
          tl.addEventListener("click", function (e) { 
            e.preventDefault(); 
            e.stopPropagation(); 
            STATE.edit = !STATE.edit; 
            applyMode(); 
            ensureToolbarVisible(); 
          }, { passive: false }); 
        }
        applyMode();
        window.bindToolbar = bindToolbar;

        window.addEventListener("resize", function () { requestAnimationFrame(function () { ensureToolbarVisible(); lockCardHeaderHeights(); }); }, { passive: true });
      }

      /* ===== 13.7 Save UI / Modals ===== */
      function initModalHandlers() {
          document.addEventListener('click', function(e) {
              var target = e.target;
              var closeBtn = target.closest('#cardsClose, #saveCancel, #fieldCancel, .btn-close, .close');
              if (closeBtn) {
                  var modal = closeBtn.closest('.v2-modal-overlay');
                  if (modal) {
                      e.preventDefault(); e.stopPropagation();
                      closeModal(modal);
                      return;
                  }
              }
              if (target.classList.contains('v2-modal-overlay')) {
                  if (target.classList.contains('is-visible')) {
                      e.preventDefault(); e.stopPropagation();
                      closeModal(target);
                      return;
                  }
              }
          }, false);
      }

      function bindSaveUI() {
        var saveBtn = $("#saveBtnAll"), menu = $("#saveMenu");
        if (!saveBtn || !menu) return;
        
        var btn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(btn, saveBtn);
        
        btn.onclick = function (e) { 
            e.preventDefault(); 
            e.stopPropagation(); 
            menu.classList.toggle("open"); 
        };
        
        document.addEventListener("click", function (e) {
              if (!menu.contains(e.target) && e.target !== btn) {
                  menu.classList.remove("open"); 
              }
        });
        
        menu.querySelectorAll(".mi").forEach(function (mi) {
          mi.onmousedown = function(e) { e.stopPropagation(); };
          mi.onclick = async function (e) {
            e.preventDefault(); e.stopPropagation();
            var cmd = mi.getAttribute("data-cmd");
            if (cmd === "save") { await runSaveOverwrite(); }
            if (cmd === "saveas") { openModal("#v2-save-modal"); }
            if (cmd === "revert") { await loadLayoutAndApply(STATE.currentPreset || null); }
            menu.classList.remove("open");
          };
        });
        document.addEventListener("keydown", async function (e) {
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") { e.preventDefault(); await runSaveOverwrite(); }
        });
      }

      function runSaveOverwrite() {
        return saveLayout(null, true, true);
      }

      function openModal(sel) {
        var allModals = document.querySelectorAll('.v2-modal-overlay');
        allModals.forEach(function(m) {
            m.classList.remove('is-visible');
            m.style.display = "none";
        });
        document.body.classList.remove('modal-open');

        var m = (typeof sel === 'string' ? document.querySelector(sel) : sel);
        if (!m) return;
        
        m.style.display = "flex";
        m.classList.add('motk-modal-backdrop');
        m.classList.add("is-visible");
        document.body.classList.add("modal-open");
        
        var input = m.querySelector("input");
        if(input) setTimeout(function(){ input.focus(); }, 50);
      }

      function closeModal(sel) {
        var m = (typeof sel === 'string') ? document.querySelector(sel) : sel;
        if (!m) return;
        m.classList.remove("is-visible");
        m.style.display = "none";
        document.body.classList.remove("modal-open");
      }

      function bindSaveModal() {
        var a = $("#saveApply");
        if (a) {
            a.onclick = async function (e) {
              e.preventDefault(); e.stopPropagation();
              
              var btn = e.target;
              var originalText = btn.textContent;
              btn.textContent = "Saving...";
              btn.disabled = true;
              
              try {
                var name = ($("#saveAsName") && $("#saveAsName").value || "").trim();
                var editBox = document.getElementById("saveAsEdit");
                var edit = editBox ? !!editBox.checked : true;
                
                if (!name) { 
                    showStatus("Preset name required", true); 
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return; 
                }
                
                await saveLayout(name, false, edit);
                await loadPresets(); 
                var sel = $("#presetSelect"); 
                if (sel && STATE.currentPreset) {
                   sel.value = STATE.currentPreset;
                }
              } catch(err) {
                console.error(err);
              } finally {
                btn.textContent = originalText;
                btn.disabled = false;
                closeModal("#v2-save-modal");
              }
            };
            a.onmousedown = function(e) { e.stopPropagation(); };
        }
      }

      (function ensureModalContract() {
        var modals = document.querySelectorAll(".v2-modal-overlay");
        modals.forEach(function (m) {
          m.classList.remove("is-visible");
          m.style.display = "none";
        });
      })();

      /* ===== 13.8 Cards / Layouts ===== */
      function duplicateCard(key) {
        var i = STATE.layout.findIndex(function (x) { return x.key === key; });
        if (i < 0) return;
        var src = STATE.layout[i];
        var dup = JSON.parse(JSON.stringify(src));
        dup.key = src.key + "_" + Math.random().toString(36).slice(2, 5);
        dup.title = (src.title || "") + " Copy";
        dup.y = maxOccupiedY() + 1;
        STATE.layout.splice(i + 1, 0, dup);
        var el = createCard(dup);
        $("#grid").appendChild(el);
      }
      function removeCard(key) {
        var i = STATE.layout.findIndex(function (x) { return x.key === key; });
        if (i < 0) return;
        STATE.layout.splice(i, 1);
        var selector = "#grid .card[data-key='" + key + "']";
        var el = document.querySelector(selector); if (el) el.remove();
        renderCardsList();
      }
      function bindCardsModal() {
        var oldBtn = $("#cardsBtn");
        if (!oldBtn) return;
        
        var btn = oldBtn.cloneNode(true);
        if (oldBtn.parentNode) {
          oldBtn.parentNode.replaceChild(btn, oldBtn);
        }
        
        btn.onmousedown = function(e) { e.stopPropagation(); };
        btn.onclick = function (e) {
          e.preventDefault();
          e.stopPropagation();
          renderCardsList();
          openModal("#v2-cards-modal");
        };
        
        var add = $("#addCard"); 
        if (add) {
            add.onclick = function (e) {
              e.preventDefault(); e.stopPropagation();
              if (!Array.isArray(STATE.layout)) STATE.layout = [];
              var key = "card_" + Math.random().toString(36).slice(2, 8);
              var def = { key: key, title: "New Card", type: "table", x: 0, y: maxOccupiedY() + 1, w: 4, h: 12, fields: [], thwpx: 100, __autofit__: false };
              STATE.layout.push(def);
              var el = createCard(def); $("#grid").appendChild(el);
              renderCardsList();
              setTimeout(function() {
                  closeModal("#v2-cards-modal");
                  openCardSettings(def.key);
              }, 200);
            };
        }
      }
      function renderCardsList() {
        var box = $("#cardsList"); if (!box) return;
        box.innerHTML = "";
        if (!Array.isArray(STATE.layout)) STATE.layout = [];
        STATE.layout.forEach(function (def) {
          var row = document.createElement("div"); row.className = "list-row";
          var name = document.createElement("div"); name.textContent = def.title || def.key;
          var jump = document.createElement("span"); jump.className = "xbtn"; jump.textContent = "Move"; jump.title = "Focus";
          jump.onclick = function () { var el = $("#grid .card[data-key='" + def.key + "']"); if (!el) return; el.scrollIntoView({ behavior: "smooth", block: "center" }); el.classList.add("dragging"); setTimeout(function () { el.classList.remove("dragging"); }, 600); };
          var edit = document.createElement("span"); edit.className = "xbtn"; edit.textContent = "Edit"; edit.title = "Edit"; edit.onclick = function (e) { 
              e.preventDefault(); e.stopPropagation();
              closeModal("#v2-cards-modal");
              openCardSettings(def.key); 
          };
          var del = document.createElement("span"); del.className = "xbtn"; del.textContent = "Delete"; del.title = "Delete"; del.onclick = function (e) { 
            e.preventDefault(); e.stopPropagation();
            removeCard(def.key); 
          };
          row.appendChild(name); row.appendChild(jump); row.appendChild(edit); row.appendChild(del); box.appendChild(row);
        });
      }
      function bindPresetAutoRefresh(sel) {
        if (!sel || sel._motkRefreshBound) return;
        sel._motkRefreshBound = true;
        var kick = function () {
          var hasLoading = Array.from(sel.options).some(o => o.text === "Loading...");
          if (!hasLoading) {
             var opt = document.createElement("option");
             opt.text = "Loading...";
             opt.disabled = true;
             sel.appendChild(opt);
          }
          loadPresets().then(function(){
          });
        };
        sel.addEventListener('mousedown', kick);
      }

      async function loadPresets() {
        var sel = $("#presetSelect"); if (!sel) return;
        if (!sel._motkRefreshBound) bindPresetAutoRefresh(sel);
        var curVal = sel.value;
        
        try {
          var payload = { entity: "", pageType: 'detail' };
          var list = await tryCall(["gsListPagePresets", "sv_listPageLayoutPresets"], payload);
          if (Array.isArray(list)) {
            sel.innerHTML = "";
            var currentEnt = singularEntityFor(STATE.entity);
            var filtered = list.filter(function(p) {
               var e = singularEntityFor(p.entity);
               return (!e || e === currentEnt);
            });
            STATE.presets = filtered;
            filtered.forEach(function (p) {
              var o = document.createElement("option");
              o.value = p.id;
              o.textContent = p.name || p.id;
              sel.appendChild(o);
            });
          }
        } catch (e) { console.warn("[DetailV2] Failed to sync presets", e); }
        
        if (STATE.currentPreset && Array.from(sel.options).some(function(o){ return o.value===STATE.currentPreset; })) {
           sel.value = STATE.currentPreset;
        } else if (curVal && Array.from(sel.options).some(function(o){ return o.value===curVal; })) {
           sel.value = curVal;
        }
        
        sel.onchange = async function () { 
          STATE.currentPreset = this.value || ""; 
          await loadLayoutAndApply(STATE.currentPreset || null); 
        };
      }
      
      async function loadLayoutAndApply(presetNameOrId) {
        setLoading(true);
        showStatus("Loading layout...");
        try {
            var layout = null;
            var isId = presetNameOrId && /^pg_/.test(presetNameOrId);
            
            if (isId) {
               try {
                 var res = await tryCall(["gsLoadPageConfig", "sv_loadPageConfig"], { pageId: presetNameOrId });
                 if (res && res.layout) {
                   layout = res.layout; 
                 } else if (res && res.config && res.config.layout) {
                   layout = res.config.layout;
                 } else if (Array.isArray(res)) {
                   layout = res;
                 }
               } catch(_) {}
            } else {
               var key = presetNameOrId ? ('preset:' + presetNameOrId) : 'global';
               try { var raw = localStorage.getItem(storageKey(key)); if (raw) layout = JSON.parse(raw); } catch (_) { }
            }

            if (layout && Array.isArray(layout) && layout.length) {
              STATE.layout = layout;
              buildFromLayout();
              showStatus("Layout loaded");
              if (isId) {
                  updateUrlState(presetNameOrId);
                  STATE.currentPreset = presetNameOrId;
                  var sel = $("#presetSelect"); if (sel) sel.value = presetNameOrId;
              }
            } else {
              console.warn("[DetailV2] No layout found for:", presetNameOrId);
              document.getElementById("grid").innerHTML = "";
              showStatus("No layout loaded");
            }
        } catch(err) {
            console.error(err);
            showStatus("Load Error", true);
        } finally {
            setLoading(false);
        }
      }
      
      async function saveLayout(presetName, overwrite, editAllowed) {
        showStatus("Saving...");
        STATE.layout = exportLayoutFromDOM();
        var saved = false;
        var pid = (overwrite && STATE.currentPreset && /^pg_/.test(STATE.currentPreset)) 
                ? STATE.currentPreset 
                : "pg_new";

        var payload = {
          pageId: pid,
          pageType: "detail",
          entity: STATE.entity,
          shared: !!editAllowed, 
          config: { layout: STATE.layout }
        };

        if (presetName) {
          payload.pageName = presetName;
        } else if (!overwrite) {
          payload.pageName = "Detail View";
        }
        
        try {
          var res = await tryCall(["sv_savePageConfig", "gsSavePageConfig"], payload);
          if (res && res.ok) {
             saved = true;
             if (res.pageId) {
               STATE.currentPreset = res.pageId;
               updateUrlState(res.pageId);
               /* FIX: reload presets after save */
               await loadPresets(); 
               var sel = $("#presetSelect"); if (sel) sel.value = res.pageId;
             }
             showStatus("Saved!");
          } else {
            showStatus("Save Failed: " + ((res && res.error) ? res.error : "Unknown"), true);
          }
        } catch (e) { 
          console.error(e);
          showStatus("Save Error", true);
        }
        return saved;
      }

      function updateUrlState(pageId) {
        if (!pageId) return;
        var u = new URL(window.location.href);
        u.searchParams.set("pid", pageId);
        history.replaceState(null, "", u.toString());
      }
      
      function exportLayoutFromDOM() {
        var arr = [];
        $("#grid").querySelectorAll(".card").forEach(function (c) {
          var key = c.dataset.key || "";
          var w = +c.dataset.w, h = +c.dataset.h, x = +c.dataset.x, y = +c.dataset.y;
          var title = (c.querySelector(".card-title") || {}).textContent || key;
          var type = c.dataset.type || (c.querySelector(".media") ? "shotview" : "table");
          var thwpx = parseInt((c.style.getPropertyValue("--thwpx") || "100px"), 10) || 100;
          var fields = [];
          if (type === "table") {
            var table = c.querySelector(".table");
            if (table) {
              table.querySelectorAll("th").forEach(function (th) {
                var label = th.textContent;
                var fid = th.getAttribute("data-fid") || Object.keys(STATE.labels).find(function (k) { return STATE.labels[k] === label; }) || label;
                if (fid) fields.push(fid);
              });
            }
          }
          arr.push({ key: key, title: title, type: type, x: x, y: y, w: w, h: h, fields: fields, thwpx: thwpx });
        });
        return arr;
      }

      /* ===== 13.9 Layout builders ===== */
      function setDefaultLayout() {
        STATE.layout = [];
      }
      function buildFromLayout() {
        var grid = $("#grid"); grid.innerHTML = "";
        if (!Array.isArray(STATE.layout) || !STATE.layout.length) return;
        STATE.layout.forEach(function (c) {
          try {
            grid.appendChild(createCard(c));
          } catch (e) { console.error("[DetailV2] createCard failed for", c, e); }
        });
        requestAnimationFrame(function () {
          if (window.FieldsAPI && typeof FieldsAPI.hydrateLinks === "function") {
            FieldsAPI.hydrateLinks(grid, { entity: STATE.entity, row: STATE.row, labels: STATE.labels });
          }
          refreshHorizontalScroll();
          lockCardHeaderHeights();
          requestAnimationFrame(lockCardHeaderHeights);
        });
      }

      /* ===== 13.10 Card factory ===== */
      (function () {
        function renderShotViewContent(container) {
            container.innerHTML = "";
            var link = null, thumb = null, id = "";
            
            var thumbCols = ["fi_0011", "fi_0021"];
            for(var i=0; i<thumbCols.length; i++) {
                var t = STATE.row && STATE.row[thumbCols[i]];
                if (t && typeof t === "string" && (t.indexOf("http") === 0 || t.indexOf("data:image") === 0)) {
                    thumb = t;
                    break;
                }
            }

            var originalsCols = ["fi_0010", "fi_0020", "fi_0032"];
            for(var i=0; i<originalsCols.length; i++) {
                var val = STATE.row && STATE.row[originalsCols[i]];
                if (val && typeof val === "string") {
                    if (val.indexOf("drive.google.com") !== -1 || val.indexOf("gdrive:") !== -1) {
                        link = val;
                        break;
                    }
                }
            }
            
            var rowId = STATE.row && (STATE.row["fi_0001"] || STATE.row["fi_0015"]);
            if (rowId && PROXY_CACHE[rowId]) {
                var f = PROXY_CACHE[rowId];
                if (f && f.id) {
                    thumb = "https://drive.google.com/thumbnail?id=" + f.id + "&sz=w800";
                    link = "https://drive.google.com/file/d/" + f.id + "/view";
                }
            }

            if (STATE.row) {
               if (STATE.row["fi_0001"]) id = STATE.row["fi_0001"];
               else if (STATE.row["fi_0015"]) id = STATE.row["fi_0015"];
            }
            
            if (thumb) {
               var img = document.createElement("img");
               img.src = thumb;
               img.onload = function() { 
                   var card = container.closest('.card');
                   if(card) autoFitHeight(card, true);
               };
               img.style.width = "100%";
               img.style.height = "100%";
               img.style.objectFit = "contain";
               
               if (link) {
                   /* FIX: wrap img in <a> to avoid 403 (noreferrer) */
                   var a = document.createElement("a");
                   a.href = link;
                   a.target = "_blank";
                   a.rel = "noopener noreferrer";
                   a.style.display = "block"; a.style.width = "100%"; a.style.height = "100%";
                   img.style.cursor = "pointer";
                   a.appendChild(img);
                   container.appendChild(a);
               } else {
                   container.appendChild(img);
               }
               return;
            }
            
            var driveId = null;
            if (link) {
                var m = link.match(/[-\w]{25,}/);
                if (m) driveId = m[0];
            }
            if (driveId) {
                var img2 = document.createElement("img");
                img2.style.cursor = "pointer";
                img2.src = "https://drive.google.com/thumbnail?id=" + driveId + "&sz=w800";
                img2.onload = function() { 
                   var card2 = container.closest('.card');
                   if(card2) autoFitHeight(card2, true);
                };
                
                /* FIX: wrap in <a> to avoid 403 (noreferrer) */
                var aImg = document.createElement("a");
                aImg.href = link;
                aImg.target = "_blank";
                aImg.rel = "noopener noreferrer";
                aImg.style.display = "block"; aImg.style.width = "100%"; aImg.style.height = "100%";
                aImg.appendChild(img2);
                container.appendChild(aImg);

                img2.onerror = function() {
                    container.innerHTML = "";
                    var a = document.createElement("a");
                    var safeLink = link; 
                    a.href = safeLink;
                    a.target = "_blank"; 
                    /* FIX: add noreferrer to avoid 403 */
                    a.rel = "noopener noreferrer";
                    a.className = "btn"; a.textContent = "Open Originals";
                    container.style.display = "flex"; container.style.alignItems = "center"; container.style.justifyContent = "center";
                    
                    var wrapper = document.createElement("div");
                    wrapper.style.textAlign = "center";
                    wrapper.appendChild(a);
                    
                    var note = document.createElement("div");
                    note.className = "media-note"; 
                    note.textContent = "If 403 error occurs, check your Google account login.";
                    note.style.marginTop = "8px";
                    note.style.fontSize = "11px";
                    note.style.opacity = "0.7";
                    wrapper.appendChild(note);

                    container.appendChild(wrapper);
                };
                
                img2.style.width = "100%";
                img2.style.height = "100%";
                img2.style.objectFit = "contain";
                return;
            }
            
            if (window.FieldsAPI && typeof FieldsAPI.renderCellByField === "function") {
               try {
                 var node = FieldsAPI.renderCellByField({
                   fid: "shotview", type: "shotview", val: "", value: "",
                   row: STATE.row || {}, labels: STATE.labels || {}, entity: STATE.entity
                 });
                 if (node) {
                   container.style.display = "flex"; container.style.alignItems = "center"; container.style.justifyContent = "center";
                   container.appendChild(node);
                   return;
                 }
               } catch(e) {}
            }

            container.textContent = (id || "No Preview");
            container.style.display = "flex";
            container.style.alignItems = "center";
            container.style.justifyContent = "center";
            container.style.color = "#666";
        }

        function createCard(def) {
          var card = document.createElement("section");
          card.className = "card";
          card.dataset.key = def.key;
          var type = String(def.type || "table");
          card.dataset.type = type;

          applyXYWH(card, def.x, def.y, def.w, def.h);
          /* FIX: set initial width to 100px */
          card.style.setProperty("--thwpx", (def.thwpx || 100) + "px");

          var hd = document.createElement("div");
          hd.className = "card-header";

          var ttl = document.createElement("div");
          ttl.className = "card-title";
          ttl.textContent = def.title || def.key;

          var act = document.createElement("div");
          act.className = "card-actions";

          var btnEdit = document.createElement("button");
          btnEdit.className = "btn";
          btnEdit.type = "button";
          btnEdit.textContent = "Edit";
          btnEdit.title = "Edit card";
          btnEdit.onmousedown = function(e) { e.stopPropagation(); };
          btnEdit.addEventListener("click", function (e) {
            e.preventDefault(); e.stopPropagation();
            openCardSettings(def.key);
          });

          var btnDup = document.createElement("button");
          btnDup.className = "btn";
          btnDup.type = "button";
          btnDup.textContent = "Duplicate";
          btnDup.title = "Duplicate card";
          btnDup.onmousedown = function(e) { e.stopPropagation(); };
          btnDup.addEventListener("click", function (e) {
            e.preventDefault(); e.stopPropagation();
            duplicateCard(def.key);
          });

          var btnFit = document.createElement("button");
          btnFit.className = "btn";
          btnFit.type = "button";
          btnFit.textContent = "Auto height";
          btnFit.title = "Auto fit height";
          btnFit.onmousedown = function(e) { e.stopPropagation(); };
          btnFit.addEventListener("click", function (e) {
            e.preventDefault(); e.stopPropagation();
            autoFitHeight(card, true);
          });

          act.appendChild(btnEdit); act.appendChild(btnDup); act.appendChild(btnFit);

          /* FIX: explicitly add card-remove class */
          var delBtn = document.createElement("button");
          delBtn.className = "btn btn-del card-remove";
          delBtn.type = "button";
          delBtn.title = "Delete card";
          delBtn.textContent = String.fromCharCode(215);
          delBtn.onmousedown = function(e) { e.stopPropagation(); };
          delBtn.addEventListener("click", function (e) {
            e.preventDefault(); e.stopPropagation();
            removeCard(def.key);
          });

          hd.appendChild(delBtn); hd.appendChild(ttl); hd.appendChild(act);
          card.appendChild(hd);

          var body = document.createElement("div");
          body.className = "cbody";

          if (type === "shotview") {
            var media = document.createElement("div");
            media.className = "media aspect";
            
            var inner = document.createElement("div");
            inner.className = "inner";
            inner.style.width = "100%";
            inner.style.height = "100%";
            
            renderShotViewContent(inner);
            
            media.appendChild(inner);
            body.appendChild(media);
          } else {
            var fields = Array.isArray(def.fields) ? def.fields.slice() : [];
            if (!fields.length && STATE && Array.isArray(STATE.ids) && STATE.ids.length) {
              fields = STATE.ids.slice(0, 40);
            }
            var table = document.createElement("table");
            table.className = "table";
            fields.forEach(function (fid) {
              if (!fid) return;
              var tr = document.createElement("tr");
              var label = (STATE && STATE.labels && STATE.labels[fid]) || (window.FieldsAPI && FieldsAPI.getLabel && FieldsAPI.getLabel(fid, STATE.entity)) || fid;
              var th = document.createElement("th"); 
              th.textContent = label;
              th.setAttribute("data-fid", fid);
              var resizer = document.createElement("div");
              resizer.className = "th-resizer";
              resizer.title = "Drag to resize column";
              resizer.addEventListener("mousedown", function(e) {
                  e.preventDefault(); e.stopPropagation();
                  var startX = e.pageX;
                  var startW = th.getBoundingClientRect().width;
                  function onMove(ev) {
                      var diff = ev.pageX - startX;
                      var newW = Math.max(50, startW + diff);
                      card.style.setProperty("--thwpx", newW + "px");
                  }
                  function onUp() {
                      window.removeEventListener("mousemove", onMove);
                      window.removeEventListener("mouseup", onUp);
                  }
                  window.addEventListener("mousemove", onMove);
                  window.addEventListener("mouseup", onUp);
              });
              th.appendChild(resizer);

              var td = document.createElement("td");
              td.className = "v";
              td.setAttribute("data-fid", fid);
              var meta = (STATE.fieldsMeta && STATE.fieldsMeta[fid]) ? STATE.fieldsMeta[fid] : null;
              var ftype = meta && meta.type ? String(meta.type).trim().toLowerCase() : "";
              if (!ftype) {
                console.warn("[DetailV2] Missing Fields meta for fid=" + fid + " (type undefined).");
              }
              if (ftype) td.setAttribute("data-type", ftype);
              
              var val = "";
              if (STATE.row && typeof STATE.row[fid] !== 'undefined') {
                  val = STATE.row[fid];
              }
              
              var node = null;
              if (window.FieldsAPI && typeof FieldsAPI.renderCellByField === "function") {
                try {
                  node = FieldsAPI.renderCellByField({
                    fid: fid,
                    val: val,
                    value: val,
                     row: STATE.row || {},
                     labels: STATE.labels || {},
                     entity: STATE.entity,
                     type: ftype,
                     field: meta || null,
                     editable: !!(meta && meta.editable === true)
                   });
                 } catch (err) {
                  console.error("[DetailV2] renderCellByField error", err);
                  node = null;
                }
              }
              if (!node) {
                node = document.createTextNode(val == null ? "" : String(val));
              }
              td.appendChild(node);
              tr.appendChild(th); tr.appendChild(td);
              table.appendChild(tr);
            });
            body.appendChild(table);
          }
          card.appendChild(body);
          var rs = document.createElement("div"); rs.className = "resize"; card.appendChild(rs);
          enableDrag(card, hd); enableResize(card, rs);
          return card;
        }
        window.createCard = createCard;
      })();

      /* ===== 13.11 Drag / Resize / Fit ===== */
      function enableDrag(card, header) {
        header.addEventListener("mousedown", function (e) {
          if (!STATE.edit) return; e.preventDefault();
          var m = gridMetrics();
          STATE.drag.active = true; STATE.drag.mode = "move"; STATE.drag.card = card;
          STATE.drag.start = { x: +card.dataset.x, y: +card.dataset.y, w: +card.dataset.w, h: +card.dataset.h };
          STATE.drag.colW = m.colW; STATE.drag.rowStep = m.rowStep; STATE.drag.gridLeft = m.gridLeft; STATE.drag.gridTop = m.gridTop;
          var rect = card.getBoundingClientRect();
          var offX = e.pageX - (rect.left + window.scrollX);
          var offY = e.pageY - (rect.top + window.scrollY);
          
          function onMove(ev) {
            if (!STATE.drag.active || STATE.drag.mode !== "move") return;
            var gx = Math.max(0, (ev.pageX - STATE.drag.gridLeft) - offX);
            
            /* FIX: add -5px Y offset to avoid top sanctuary edge */
            var gy = Math.max(0, (ev.pageY - STATE.drag.gridTop) - offY - 5);
            
            var x = Math.round(gx / (STATE.drag.colW + m.gap));
            var y = Math.round(gy / STATE.drag.rowStep);
            
            x = Math.max(0, Math.min(m.cols - STATE.drag.start.w, x));
            var maxY = maxOccupiedY() + 200;
            y = Math.max(0, Math.min(maxY, y));
            applyXYWH(card, x, y, STATE.drag.start.w, STATE.drag.start.h);
          }
          
          function onUp() {
            if (!STATE.drag.active || STATE.drag.mode !== "move") return cleanup();
            
            /* FIX: recompute from dataset on commit and floor for stability */
            var finalX = Math.round(+card.dataset.x); 
            var finalY = Math.round(+card.dataset.y); 
            
            var pos = placeWithoutOverlap(card, finalX, finalY, +card.dataset.w, +card.dataset.h);
            applyXYWH(card, pos.x, pos.y, pos.w, pos.h); cleanup();
            lockCardHeaderHeights();
          }
          function cleanup() { STATE.drag.active = false; STATE.drag.mode = ""; STATE.drag.card = null; document.removeEventListener("mousemove", onMove); document.removeEventListener("mouseup", onUp); }
          document.addEventListener("mousemove", onMove); document.addEventListener("mouseup", onUp);
        });
      }
      function enableResize(card, handle) {
        handle.addEventListener("mousedown", function (e) {
          if (!STATE.edit) return; e.preventDefault();
          var m = gridMetrics();
          STATE.drag.active = true; STATE.drag.mode = "resize"; STATE.drag.card = card;
          STATE.drag.start = { x: +card.dataset.x, y: +card.dataset.y, w: +card.dataset.w, h: +card.dataset.h };
          STATE.drag.colW = m.colW; STATE.drag.rowStep = m.rowStep; STATE.drag.gridLeft = m.gridLeft; STATE.drag.gridTop = m.gridTop;
          function onMove(ev) {
            if (!STATE.drag.active || STATE.drag.mode !== "resize") return;
            var gx = Math.max(ev.pageX - STATE.drag.gridLeft, 0);
            var gy = Math.max(ev.pageY - STATE.drag.gridTop, 0);
            var endCol = Math.floor(gx / (STATE.drag.colW + m.gap));
            var endRow = Math.floor(gy / (STATE.drag.rowStep));
            var w = Math.max(1, endCol - STATE.drag.start.x + 1);
            var h = Math.max(10, endRow - STATE.drag.start.y + 1);
            w = Math.min(w, m.cols - STATE.drag.start.x);
            applyXYWH(card, STATE.drag.start.x, STATE.drag.start.y, w, h);
          }
          function onUp() {
            if (!STATE.drag.active || STATE.drag.mode !== "resize") return cleanup();
            var pos = placeWithoutOverlap(card, +card.dataset.x, +card.dataset.y, +card.dataset.w, +card.dataset.h);
            applyXYWH(card, pos.x, pos.y, pos.w, pos.h); cleanup();
            lockCardHeaderHeights();
          }
          function cleanup() { STATE.drag.active = false; STATE.drag.mode = ""; STATE.drag.card = null; document.removeEventListener("mousemove", onMove); document.removeEventListener("mouseup", onUp); }
          document.addEventListener("mousemove", onMove); document.addEventListener("mouseup", onUp);
        });
      }
      function autoFitHeight(card, strict) {
        var m = gridMetrics();
        
        if (card.dataset.type === "shotview") {
            var img = card.querySelector("img");
            var targetH = 0;
            
            if (img && img.naturalHeight) {
                var currentW = img.width || card.getBoundingClientRect().width;
                targetH = currentW * (img.naturalHeight / img.naturalWidth);
            }
            
            if (!targetH) {
                var widthPx = card.getBoundingClientRect().width;
                targetH = (widthPx * 9) / 16;
            }
            
            targetH += 28; 
            /* FIX: reduce padding calculation from +20px to +4px */
            var rows = Math.ceil( (targetH + m.gap + 4) / m.rowStep );
            rows = Math.max(4, rows);
            
            applyXYWH(card, +card.dataset.x, +card.dataset.y, +card.dataset.w, rows);
            lockCardHeaderHeights();
            return;
        }

        var body = card.querySelector(".cbody"); var header = card.querySelector(".card-header"); if (!body || !header) return;
        var content = body.firstElementChild;
        var csBody = getComputedStyle(body);
        var padBody = parseFloat(csBody.paddingTop || 0) + parseFloat(csBody.paddingBottom || 0);
        var csCard = getComputedStyle(card);
        var padCard = parseFloat(csCard.paddingTop || 0) + parseFloat(csCard.paddingBottom || 0);
        var extra = padBody + padCard;
        var contentHeight = 0;
        if (content) { contentHeight = Math.max(content.scrollHeight, content.offsetHeight); } else { contentHeight = body.scrollHeight; }
        /* FIX: reduce padding calculation from +20px to +4px */
        var needPx = (header.offsetHeight || 0) + contentHeight + extra + 4;
        
        var rows2 = Math.ceil( (needPx + m.gap) / m.rowStep );
        
        rows2 = Math.max(6, Math.min(rows2, 300));
        applyXYWH(card, +card.dataset.x, +card.dataset.y, +card.dataset.w, rows2);
        lockCardHeaderHeights();
      }

      /* ===== 13.13 Field Modal ===== */
      function bindFieldModal() {
        var c = $("#fieldCancel"), a = $("#fieldApply"), d = $("#v2-field-modal");
        if (!d) return;
        if (c) {
          var cNew = c.cloneNode(true); c.parentNode.replaceChild(cNew, c);
          cNew.onmousedown = function(e) { e.stopPropagation(); };
          cNew.onclick = function (e) { e.preventDefault(); e.stopPropagation(); closeModal("#v2-field-modal"); };
        }
        if (a) {
          var aNew = a.cloneNode(true); a.parentNode.replaceChild(aNew, a);
          aNew.onmousedown = function(e) { e.stopPropagation(); };
          aNew.onclick = function (e) {
             e.preventDefault(); e.stopPropagation();
             var key = $("#v2-field-modal").getAttribute("data-key") || "";
             var title = ($("#cardTitle") && $("#cardTitle").value || "").trim() || key;
             
             var def = STATE.layout.find(function (x) { return x.key === key; }); 
             if (def) { 
                 def.title = title; 
             }
             var card = $("#grid .card[data-key='" + key + "']"); 
             if (card) { 
                 var tDiv = card.querySelector(".card-title"); if(tDiv) tDiv.textContent = title;
             }
             if (def && def.type !== "shotview") {
                var selected = []; 
                document.querySelectorAll("#fieldList input[type=checkbox]:checked").forEach(function (cb) { selected.push(cb.value); });
                def.fields = selected;
                if (card) {
                  var body = card.querySelector(".cbody");
                  var oldTable = body.querySelector(".table"); if(oldTable) oldTable.remove();
                  var table = document.createElement("table"); table.className = "table"; body.prepend(table);
                  selected.forEach(function (fid) {
                    var tr = document.createElement("tr");
                    var label = (STATE.labels[fid]) || (window.FieldsAPI && FieldsAPI.getLabel && FieldsAPI.getLabel(fid, STATE.entity)) || fid;
                    var th = document.createElement("th"); th.textContent = label; th.setAttribute("data-fid", fid);

                    var resizer = document.createElement("div");
                    resizer.className = "th-resizer";
                    resizer.title = "Drag to resize column";
                    resizer.addEventListener("mousedown", function(e2) {
                        e2.preventDefault(); e2.stopPropagation();
                        var startX = e2.pageX;
                        var startW = th.offsetWidth;
                        function onMove(ev) {
                            var diff = ev.pageX - startX;
                            var newW = Math.max(50, startW + diff);
                            card.style.setProperty("--thwpx", newW + "px");
                        }
                        function onUp() {
                            window.removeEventListener("mousemove", onMove);
                            window.removeEventListener("mouseup", onUp);
                        }
                        window.addEventListener("mousemove", onMove);
                        window.addEventListener("mouseup", onUp);
                    });
                    th.appendChild(resizer);

                    var td = document.createElement("td"); td.className = "v"; td.setAttribute("data-fid", fid);
                    var meta = (STATE.fieldsMeta && STATE.fieldsMeta[fid]) ? STATE.fieldsMeta[fid] : null;
                    var ftype = meta && meta.type ? String(meta.type).trim().toLowerCase() : "";
                    if (!ftype) {
                      console.warn("[DetailV2] Missing Fields meta for fid=" + fid + " (type undefined).");
                    }
                    if (ftype) td.setAttribute("data-type", ftype);
                    var val = (STATE.row && STATE.row[fid]) ? STATE.row[fid] : "";
                    var node = null;
                    if (window.FieldsAPI && typeof FieldsAPI.renderCellByField === "function") {
                         try {
                           node = FieldsAPI.renderCellByField({
                             fid: fid,
                             val: val,
                             value: val,
                              row: STATE.row || {},
                              labels: STATE.labels || {},
                              entity: STATE.entity,
                              type: ftype,
                              field: meta || null,
                              editable: !!(meta && meta.editable === true)
                            });
                          } catch (err) {
                           console.error("[DetailV2] renderCellByField error", err);
                           node = null;
                         }
                    }
                    if (!node) {
                         node = document.createTextNode(val == null ? "" : String(val));
                    }
                    td.appendChild(node); tr.appendChild(th); tr.appendChild(td); table.appendChild(tr);
                  });
                  requestAnimationFrame(function () { autoFitHeight(card, true); });
                }
             }
             closeModal("#v2-field-modal");
          };
        }
      }
      function openCardSettings(cardKey) {
        if (!STATE.edit) return;
        var def = STATE.layout.find(function (x) { return x.key === cardKey; }); if (!def) return;
        $("#v2-field-modal").setAttribute("data-key", cardKey);
        var titleEl = $("#cardTitle"); if (titleEl) titleEl.value = def.title || def.key;
        
        var list = $("#fieldList"); if (list) {
          list.innerHTML = "";
          if (def.type === "shotview") {
            var p = document.createElement("div"); p.className = "notice"; p.textContent = "Shotview cards cannot be edited here"; list.appendChild(p);
          } else {
            var sel = new Set((def.fields || []));
            (STATE.ids || Object.keys(STATE.labels)).forEach(function (fid) {
              if (!/^fi_\d{4}$/.test(fid)) return;
              var row = document.createElement("div"); row.className = "field-row";
              var cb = document.createElement("input"); cb.type = "checkbox"; cb.value = fid; cb.checked = sel.has(fid);
              var lab = document.createElement("label"); lab.textContent = (STATE.labels[fid]) || (window.FieldsAPI && FieldsAPI.getLabel && FieldsAPI.getLabel(fid, STATE.entity)) || fid;
              row.appendChild(cb); row.appendChild(lab); list.appendChild(row);
            });
          }
        }
        openModal("#v2-field-modal");
      }

      /* ===== 13.14 Prev/Next ===== */
      function safeIdAt(i) {
        if (!Array.isArray(STATE.rows) || i < 0 || i >= STATE.rows.length) return "";
        var idx = STATE.idxId >= 0 ? STATE.idxId : 0;
        var v = STATE.rows[i] && STATE.rows[i][idx];
        return v == null ? "" : String(v);
      }
      function navigate(entity, id) {
        if (!id) return;
        var href = Router.buildEntityUrl(entity || "shot", id);
        try { (window.top || window).location.assign(href); }
        catch (_) { (window.top || window).location.href = href; }
      }
      function setupPrevNext() {
        var prevBtn = $("#prev"), nextBtn = $("#next");
        var total = Array.isArray(STATE.rows) ? STATE.rows.length : 0;
        var pos = Math.min(Math.max(STATE.pos | 0, 0), Math.max(total - 1, 0));
        var prev = (pos > 0) ? pos - 1 : -1, next = (pos < total - 1) ? pos + 1 : -1;
        if (prevBtn) { prevBtn.disabled = prev < 0; prevBtn.onclick = function () { var id = safeIdAt(prev); if (id) navigate(STATE.entity, id); }; }
        if (nextBtn) { nextBtn.disabled = next < 0; nextBtn.onclick = function () { var id = safeIdAt(next); if (id) navigate(STATE.entity, id); }; }
      }

      /* ===== 13.15 Apply index ===== */
      function applyIndex(index, pushUrl) {
        STATE.pos = index;
        var row = STATE.rows[index], map = {}, labels = {};
        if (row && Array.isArray(STATE.ids)) {
          for (var i = 0; i < STATE.ids.length; i++) map[STATE.ids[i]] = row[i];
          for (var j = 0; j < STATE.ids.length; j++) labels[STATE.ids[j]] = String(STATE.header[j] || STATE.ids[j]);
        }
        STATE.row = map; STATE.labels = labels;
        ensurePageKey();
        var recordTitle = deriveRecordTitle() || defaultDetailTitle();
        var detailTitle = defaultDetailTitle();
        var t = $("#title"); if (t) t.textContent = recordTitle;
        var f = $("#footerPage"); if (f) f.textContent = detailTitle;
        /* FIX: include entity name in page title */
        if (typeof document !== 'undefined' && document.title) { 
            var entLabel = capitalize(STATE.entity || "Detail");
            document.title = entLabel + ' | ' + recordTitle; 
        }
        setupPrevNext();
        if (!STATE.layout || !STATE.layout.length) setDefaultLayout();
        buildFromLayout();
        ensureToolbarVisible();
        refreshHorizontalScroll();
        if (pushUrl) {
          var qs = new URLSearchParams(location.search);
          qs.set('page', currentPageKey());
          qs.set('entity', STATE.entity || 'shot');
          var recordId = '';
          if (STATE.row) {
            if (STATE.row['fi_0001']) recordId = STATE.row['fi_0001'];
            else if (STATE.idxId >= 0 && Array.isArray(STATE.ids) && STATE.ids[STATE.idxId]) {
               var idxKey = STATE.ids[STATE.idxId];
               if (idxKey && STATE.row[idxKey] != null) recordId = STATE.row[idxKey];
            }
          }
          if (recordId) qs.set('id', recordId); else qs.delete('id');
          history.replaceState(null, '', location.pathname + "?" + qs.toString());
        }
        prefetchProxyIndex();
      }

      /* ===== 13.16 Linkify (strict) ===== */
      function linkifyLinksStrict(scope) {
        var root = scope || document;
        var rows = root.querySelectorAll('.table tr, .field-row, .kv-row, .fields-grid');
        rows.forEach(function (row) {
          var k = row.querySelector('.k') || row.querySelector('th');
          var v = row.querySelector('.v') || row.querySelector('td');
          if (!k || !v) return;
          var ftype = (v.getAttribute('data-type') || "").toLowerCase();
          if (ftype === "id" || ftype === "entity_link" || ftype === "originals") return;
          if (v.querySelector('a')) return;
          var raw = (v.textContent || "").trim();
          if (/^https?:\/\//i.test(raw)) {
            var a = document.createElement('a'); a.href = raw; a.target = '_blank'; a.rel = 'noopener'; a.textContent = raw; a.className = 'chip';
            v.textContent = ""; v.appendChild(a);
          }
        });
        var originalsCells = root.querySelectorAll('td[data-type="originals"]');
        originalsCells.forEach(function (cell) {
          var link = cell.querySelector('a');
          if (link && link.href && !link.target) {
            link.target = '_blank'; link.rel = 'noopener';
            var originalText = link.textContent;
            link.textContent = 'Loading Originals...';
            setTimeout(function () { if (link.textContent === 'Loading Originals...') { link.textContent = originalText || 'Open Originals'; } }, 1000);
          }
        });
      }
      
      /* ===== 13.17 Init / Error ===== */
      function showError(msg) {
        console.error("[DetailV2] " + msg);
        var box = document.getElementById("error");
        if (!box) return;
        box.textContent = msg; box.style.display = "block";
      }

      async function init() {
        initModalHandlers();
        setLoading(true);
        
        var viewCtx = window.__VIEW_CTX__ || window.viewCtx || {}; window.__VIEW_CTX__ = viewCtx;
        var root = document.querySelector(".detail-page"); if (!root) return;
        var query = new URLSearchParams(window.location.search || "");
        var entityKey = query.get("entity") || root.getAttribute("data-nav-entity") || (viewCtx && viewCtx.entity) || "shot";
        entityKey = String(entityKey || "shot").toLowerCase();
        var pageHint = query.get("page") || root.getAttribute("data-nav-page") || "DetailShot";
        STATE.entity = entityKey; STATE.pageKey = pageHint;
        var recordId = query.get("id") || root.getAttribute("data-record-id") || root.getAttribute("data-id") || "";
        if (recordId) { STATE.id = recordId; }
        
        var entStrict = singularEntityFor(entityKey);
        var entLabel = pluralEntityFor(entStrict);
        STATE.sheet = entLabel;

        var payload = { entity: entLabel, sheet: entLabel, entityPlural: entLabel, sheetName: entStrict, pageType: "detail", offset: 0, limit: 2000, sort: [], filterGroups: [], groupCombine: "all" };
        var resp;
        try { resp = await tryCall(["sv_listRowsPage", "listRowsPage"], payload); } catch (err) { showError("Failed to load rows: " + err); }

        var norm = normalizeRowsPayload(resp);
        STATE.ids = norm.ids;
        STATE.header = norm.header;
        STATE.rows = norm.rows;
        STATE.columns = norm.columns || [];
        
        STATE.fieldsMeta = {};
        if (STATE.columns && STATE.columns.length) {
            STATE.columns.forEach(function(c) {
                var fid = c.id || c.field_id;
                if(fid) STATE.fieldsMeta[fid] = c;
            });
        }
        
        STATE.idxId = Math.max(0, (STATE.ids || []).indexOf("fi_0001"));
        var pos = 0; var targetId = STATE.id;
        if (targetId && STATE.rows.length) {
          pos = STATE.rows.findIndex(function (r) { if (!r) return false; var v = r[STATE.idxId]; return v === targetId; });
          if (pos < 0) { pos = STATE.rows.findIndex(function (r) { if (!r || !r.indexOf) return false; return r.indexOf(targetId) !== -1; }); }
        }
        if (pos < 0) pos = 0;
        if (!targetId && STATE.rows[0] && STATE.idxId >= 0) {
          var firstId = STATE.rows[0][STATE.idxId];
          if (firstId != null) { STATE.id = String(firstId); }
        }

        applyIndex(pos, !!window.location.search);

        window.setTimeout(function () {
          (async function () {
            try {
              await loadPresets();
              var pid = query.get("pid") || null;
              if (pid) {
                  await loadLayoutAndApply(pid);
              } else {
                  if (STATE.presets && STATE.presets.length > 0) {
                      await loadLayoutAndApply(STATE.presets[0].id);
                  } else {
                      document.getElementById("grid").innerHTML = "";
                      showStatus("No layout found");
                  }
              }
              
              var grid = document.getElementById("grid");
              var cardCount = grid ? grid.querySelectorAll(".card").length : 0;
              if (!grid || cardCount === 0) {
              }
            } catch (err) {}
            setLoading(false);
          })();
        }, 0);
      }

      /* ===== 13.18 Inline Edit Feature ===== */
      (function() {
        var grid = document.getElementById("grid"); if (!grid) return;
        grid.addEventListener("dblclick", function(e) {
          var target = e.target;
          var cell = target.closest("td.v"); if (!cell) return;
          
          // Inline edit entrypoint.
          // Inline editing (Fields-sheet-driven).
          
          // Guard: do not start a second editor instance.
          if (cell.querySelector("input, select, textarea")) return;
          var fid = cell.getAttribute("data-fid");
          if (!fid) return;

          var meta = (STATE.fieldsMeta && STATE.fieldsMeta[fid]) ? STATE.fieldsMeta[fid] : null;
          var ftype = meta && meta.type ? String(meta.type).trim().toLowerCase() : "";
          if (!ftype) {
            showStatus("Missing Fields meta for fid=" + fid + " (type undefined).", true);
            return;
          }

          var editable = !!(meta && meta.editable === true);
          if (ftype === "id" || ftype === "originals") editable = false;
          if (!editable) {
            showStatus("Read only", true);
            return;
          }

          makeEditable(cell, fid, ftype, meta);
        });

        function makeEditable(cell, fid, ftype, meta) {
          var originalRaw = (STATE.row && STATE.row[fid] != null) ? STATE.row[fid] : cell.textContent.trim();
          var originalValue = (originalRaw == null) ? "" : String(originalRaw).trim();
          var originalHtml = cell.innerHTML;
          var t = String(ftype || "").trim().toLowerCase();

          // Link fields are edited via picker modal (no direct id typing).
          if (t === "entity_link" || /_link$/.test(t)) {
            if (!(window.FieldsAPI && typeof FieldsAPI.openLinkPicker === "function")) {
              showStatus("Link picker unavailable", true);
              return;
            }

            var entity = singularEntityFor(STATE.entity) || STATE.entity || "shot";
            var id = STATE.id || (STATE.row && STATE.row["fi_0001"]) || "";
            if (!id) { showStatus("Error: No ID found", true); return; }

            FieldsAPI.openLinkPicker({ fid: fid, type: t, value: originalRaw }).then(function (out) {
              if (!out || out.cancelled) return;
              showStatus("Updating...");

              var patch = {}; patch[fid] = out.value;
              if (!(window.google && google.script && google.script.run)) {
                showStatus("Update Failed: google.script.run unavailable", true);
                return;
              }

              google.script.run
                .withSuccessHandler(function (res) {
                  if (res && res.ok) {
                    if (STATE.row) STATE.row[fid] = out.value;
                    cell.innerHTML = "";
                    var node = FieldsAPI.renderCellByField({
                      fid: fid,
                      val: out.value,
                      row: STATE.row || {},
                      labels: STATE.labels || {},
                      entity: STATE.entity,
                      type: t,
                      linkEntity: out.targetEntity || null,
                      field: meta || null,
                      editable: false
                    });
                    cell.appendChild(node);
                    showStatus("Updated!", false);
                  } else {
                    showStatus("Update Failed: " + ((res && res.error) ? res.error : "Unknown"), true);
                    cell.innerHTML = originalHtml;
                  }
                })
                .withFailureHandler(function (err) {
                  showStatus("Update Failed: " + String(err && err.message ? err.message : err), true);
                  cell.innerHTML = originalHtml;
                })
                .dp_updateEntityRecord(entity, id, patch);
            });
            return;
          }
          var input;

          if (t === "select") {
            input = document.createElement("select");
            var opts = (meta && meta.options) ? meta.options : [];
            if (!Array.isArray(opts)) opts = String(opts || "").split(/[\n\r|,]+/);
            opts = opts.map(function (x) { return String(x == null ? "" : x).trim(); }).filter(Boolean);
            if (opts.indexOf(originalValue) === -1 && originalValue) opts.unshift(originalValue);
            opts.forEach(function (v) {
              var o = document.createElement("option");
              o.value = v; o.textContent = v;
              input.appendChild(o);
            });
            input.value = originalValue;
          } else if (t === "date") {
            input = document.createElement("input");
            input.type = "date";
            var dt = new Date(originalValue);
            if (!isNaN(dt.getTime())) {
              var yyyy = String(dt.getFullYear());
              var mm = ("0" + (dt.getMonth() + 1)).slice(-2);
              var dd = ("0" + dt.getDate()).slice(-2);
              input.value = yyyy + "-" + mm + "-" + dd;
            } else {
              input.value = "";
            }
          } else if (t === "checkbox") {
            input = document.createElement("input");
            input.type = "checkbox";
            input.checked = (originalRaw === true) || (/^(true|yes|on|1)$/i.test(String(originalValue || "")));
          } else if (t === "json") {
            input = document.createElement("textarea");
            input.value = originalValue;
            input.style.minHeight = "140px";
          } else {
            input = document.createElement("input");
            input.type = "text"; input.value = originalValue;
          }

          if (t !== "checkbox") {
            input.style.width = "100%"; input.style.boxSizing = "border-box";
          }
          input.style.background = "#222"; input.style.color = "#fff"; input.style.border = "1px solid #555";
          cell.innerHTML = ""; cell.appendChild(input); try { input.focus(); } catch (_) {}

          function save() {
            var newValue;
            if (t === "checkbox") {
              newValue = !!input.checked;
              var origBool = (originalRaw === true) || (/^(true|yes|on|1)$/i.test(String(originalValue || "")));
              if (newValue === origBool) { cell.innerHTML = originalHtml; return; }
              cell.textContent = newValue ? "TRUE" : "FALSE";
              if (STATE.row) STATE.row[fid] = newValue;
            } else {
              newValue = String(input.value == null ? "" : input.value).trim();
              if (newValue === originalValue) { cell.innerHTML = originalHtml; return; }
              cell.textContent = newValue;
              if (STATE.row) STATE.row[fid] = newValue;
            }
            showStatus("Updating...");
            
            /* FIX: send entity using the plural sheet key */
            var entity = singularEntityFor(STATE.entity) || STATE.entity || "shot";
            
            // STATE.id  row  fi_0001 (ShotID) 
            var id = STATE.id;
            if (!id && STATE.row && STATE.row['fi_0001']) {
                id = STATE.row['fi_0001'];
            }
            if (!id) {
                showStatus("Error: No ID found", true);
                cell.innerHTML = originalHtml;
                return;
            }

            var colName = "";
            if (STATE.header && STATE.ids) {
                var idx = STATE.ids.indexOf(fid);
                if (idx >= 0) colName = STATE.header[idx];
            }
            if (!colName) colName = fid;
            
            /* FIX: use actual column key (colName) for patch */
            var patch = {}; 
            patch[fid] = newValue; 

            if (window.google && google.script && google.script.run) {
                google.script.run
                  .withSuccessHandler(function(res) {
                      if (res && res.ok) showStatus("Updated!", false);
                      else { showStatus("Update Failed: " + ((res && res.error) ? res.error : "Unknown"), true); cell.innerHTML = originalHtml; }
                  })
                  .withFailureHandler(function() { showStatus("Network Error", true); cell.innerHTML = originalHtml; })
                  .dp_updateEntityRecord(entity, id, patch);
            } else {
                console.warn("No google script env");
            }
          }
          input.addEventListener("blur", save);
          input.addEventListener("keydown", function(e) {
            if (e.key === "Enter" && t !== "json") { input.blur(); }
            else if (e.key === "Escape") { cell.innerHTML = originalHtml; if (STATE.row) STATE.row[fid] = originalRaw; }
          });
        }
      })();

      document.addEventListener("DOMContentLoaded", function () {
        try {
          bindToolbar(); bindSaveUI(); bindSaveModal(); bindCardsModal(); bindFieldModal();
          ensureToolbarVisible(); refreshHorizontalScroll();
        } catch (e) { console.error("[DetailV2] toolbar / UI binding error", e); }
        init().catch(function (err) { showError(err && err.message ? err.message : String(err)); });
      });

    })();
  </script>
</body>
</html>
