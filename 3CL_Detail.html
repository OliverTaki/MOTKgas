<!DOCTYPE html>
<html lang="en" class="detail-root">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="x-ua-compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detail</title>

  <!-- Common Styles -->
  <?!= include('3CL_CommonStyles'); ?>

  <!-- Script URL expose -->
  <script>
    (function () {
      var url;
      try { url = "<?= ScriptApp.getService().getUrl() ?>"; } 
      catch (e) { url = window.__SCRIPT_URL__ || window.SCRIPT_URL || (location.origin + location.pathname); }
      window.__SCRIPT_URL__ = url; window.SCRIPT_URL = url; window.scriptUrl = url;
    })();
  </script>
</head>

<body class="detail-page" data-nav-page="<?= page ?>" data-nav-entity="<?= entity ?>" data-record-id="<?= id ?>">
  
  <div id="v2-loading-overlay">
    <div class="spinner">Loading View...</div>
  </div>

  <nav id="gNav" class="gnavi" aria-label="Global Navigation">
    <span class="logo">MOTK</span>
    <a class="mi" data-page="Dashboard" href="<?= scriptUrl ?>?page=Dashboard">Dashboard</a>
    <a class="mi" data-page="Settings" href="<?= scriptUrl ?>?page=Settings" target="_blank" rel="noopener">Settings</a>
    <span class="spacer"></span>
    <a class="mi debug" data-page="DebugPanelPage" href="<?= scriptUrl ?>?page=DebugPanelPage" target="_blank" title="Debug Panel">&#x1F41E; Debug</a>
  </nav>

  <? var __PNAVI_ITEMS__ = (function () {
    var base = String(scriptUrl || '').trim();
    function makeHref(path) {
      if (!path) return '';
      var p = String(path);
      if (/^https?:\/\//i.test(p)) return p;
      if (p.charAt(0) === '?') return base + p;
      if (p.indexOf('p=') >= 0 || p.indexOf('page=') >= 0) return base + '?' + p;
      return base + '?p=' + encodeURIComponent(p);
    }
    function normalizeItem(it) {
      if (!it) return null;
      var id = String(it.id || '').trim();
      if (!id) return null;
      var label = String(it.label || id);
      var enabled = (it.enabled === false) ? false : true;
      var href = String(it.href || it.url || '').trim();
      var page = String(it.page || '').trim();
      var entity = String(it.entity || '').trim();
      var target = String(it.target || '').trim();
      if (!href) {
        if (id === 'shots') { href = base + '?p=table&e=shots'; page = page || 'Shots'; entity = entity || 'shot'; }
        else if (id === 'assets') { href = base + '?p=table&e=assets'; page = page || 'Assets'; entity = entity || 'asset'; }
        else if (id === 'tasks') { href = base + '?p=table&e=tasks'; page = page || 'Tasks'; entity = entity || 'task'; }
        else if (id === 'members') { href = base + '?p=table&e=members'; page = page || 'ProjectMembers'; entity = entity || 'member'; }
        else if (id === 'users') { href = base + '?p=table&e=users'; page = page || 'Users'; entity = entity || 'user'; }
        else if (id === 'schedule') { href = base + '?p=schedule&viewMode=lite'; page = page || 'Schedule'; target = '_blank'; }
        else { href = makeHref(id); }
      } else {
        href = makeHref(href);
      }
      if (id === 'schedule') {
        href = base + '?p=schedule&viewMode=lite';
        target = '_blank';
      }
      return { id: id, label: label, href: href, enabled: enabled, page: page, entity: entity, target: target };
    }
    var defaults = [
      { id: 'shots', label: 'Shots', href: base + '?p=table&e=shots', page: 'Shots', entity: 'shot', enabled: true },
      { id: 'assets', label: 'Assets', href: base + '?p=table&e=assets', page: 'Assets', entity: 'asset', enabled: true },
      { id: 'tasks', label: 'Tasks', href: base + '?p=table&e=tasks', page: 'Tasks', entity: 'task', enabled: true },
      { id: 'members', label: 'Members', href: base + '?p=table&e=members', page: 'ProjectMembers', entity: 'member', enabled: true },
      { id: 'users', label: 'Users', href: base + '?p=table&e=users', page: 'Users', entity: 'user', enabled: true },
      { id: 'schedule', label: 'Schedule', href: base + '?p=schedule&viewMode=lite', page: 'Schedule', enabled: true, target: '_blank' }
    ];
    try {
      var ss = SpreadsheetApp.getActiveSpreadsheet();
      var sh = ss ? ss.getSheetByName('project_meta') : null;
      if (sh && typeof _sv_readProjectMeta_ === 'function') {
        var meta = _sv_readProjectMeta_(sh) || {};
        var raw = meta['pnavi.config.json'] || meta['pnavi.config'] || '';
        if (raw) {
          var cfg = JSON.parse(String(raw));
          if (cfg && Array.isArray(cfg.items)) {
            var out = [];
            for (var i = 0; i < cfg.items.length; i++) {
              var item = normalizeItem(cfg.items[i]);
              if (item) out.push(item);
            }
            if (out.length) return out;
          }
        }
      }
    } catch (_) { }
    return defaults;
  })(); ?>
  <nav id="pNav" aria-label="Entity Navigation">
    <? for (var i = 0; i < __PNAVI_ITEMS__.length; i++) {
      var it = __PNAVI_ITEMS__[i];
      if (it.enabled === false) continue; ?>
      <a data-page="<?= it.page || '' ?>"<? if (it.entity) { ?> data-entity="<?= it.entity ?>"<? } ?> href="<?= it.href ?>"<? if (it.target) { ?> target="<?= it.target ?>" rel="noopener"<? } ?>><?= it.label ?></a>
    <? } ?>
  </nav>

  <?!= include('3CL_Router'); ?>
  <?!= include('3CL_CommonRenderer'); ?>

  <div class="toolbar" id="toolbar">
    <div class="left">
      <span id="title" class="title">Detail</span>
      <button id="prev" class="btn">Prev</button>
      <button id="next" class="btn">Next</button>
    </div>
    <div class="toolbar-center"><span class="mode-badge" id="modeBadge">EDIT MODE</span></div>
    <div class="right">
      <button id="cardsBtn" class="btn" style="display:none" title="Manage Cards">Cards</button>
      <div style="position:relative">
        <button id="saveBtnAll" class="btn btn-save" style="display:none" title="Save options">Save Menu</button>
        <div id="saveMenu" class="menu">
          <div class="mi" data-cmd="save">Save</div>
          <div class="mi" data-cmd="saveas">Save As...</div>
          <div class="mi" data-cmd="revert">Revert</div>
        </div>
      </div>
      <button id="toggleLayout" class="mode-toggle" title="Toggle Layout Edit">View mode</button>
      <select id="presetSelect" class="select" title="Preset"></select>
    </div>
  </div>

  <div class="wrap">
    <div id="error" class="notice" style="display:none"></div>
    <div id="gridWrap">
      <div id="grid" class="grid"></div>
    </div>
  </div>

  <div id="hScroll" aria-hidden="true" style="display:none"><div id="hScrollInner" style="height:1px"></div></div>

  <div id="footerBar" class="footer-bar">
    <span id="footerMode">View mode</span>
    <span id="footerPage">Detail</span>
  </div>

  <!-- Modals -->
  <div id="v2-save-modal" class="v2-modal-overlay" aria-hidden="true" style="display:none;">
    <div class="v2-modal-panel">
      <div class="hd">Save As</div>
      <div class="bd">
        <div class="row">
          <label>Preset Name</label>
          <input id="saveAsName" class="input grow" placeholder="Preset name" />
        </div>
        <div class="row">
          <label>Permission</label>
          <label><input id="saveAsEdit" type="checkbox" checked /> Allow overwrite (Edit)</label>
        </div>
      </div>
      <div class="ft">
        <button id="saveCancel" class="btn">Cancel</button>
        <button id="saveApply" class="btn">Apply</button>
      </div>
    </div>
  </div>

  <div id="v2-cards-modal" class="v2-modal-overlay" aria-hidden="true" style="display:none;">
    <div class="v2-modal-panel">
      <div class="hd">Cards</div>
      <div class="bd">
        <div id="cardsList"></div>
        <div class="row" style="margin-top:15px;"><button id="addCard" class="btn" style="width:100%">+ New Card</button></div>
      </div>
      <div class="ft"><button id="cardsClose" class="btn">Close</button></div>
    </div>
  </div>

  <div id="v2-field-modal" class="v2-modal-overlay" aria-hidden="true" style="display:none;">
    <div class="v2-modal-panel">
      <div class="hd">Card Settings</div>
      <div class="bd">
        <div class="row"><label style="min-width:80px">Title</label><input id="cardTitle" class="input grow" /></div>
        <div id="fieldList"></div>
      </div>
      <div class="ft">
        <button id="fieldCancel" class="btn">Cancel</button>
        <button id="fieldApply" class="btn">Apply</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      "use strict";

      /* ===== 13.1 Utils ===== */
      var $ = function (sel) { return document.querySelector(sel); };
      function gsr() { return (window.google && google.script && google.script.run) || null; }
      function bootDiagUpdateContext_(patch) {
        try {
          if (window.__MOTK_BOOT__ && typeof window.__MOTK_BOOT__.updateContext === "function") {
            window.__MOTK_BOOT__.updateContext(patch || {});
          }
        } catch (_) { }
      }
      function bootDiagUpdateDiag_(patch) {
        try {
          if (window.__MOTK_BOOT__ && typeof window.__MOTK_BOOT__.updateDiag === "function") {
            window.__MOTK_BOOT__.updateDiag(patch || {});
          }
        } catch (_) { }
      }
      function bootDiagUpdateTiming_(key, ms) {
        try {
          if (window.__MOTK_BOOT__ && typeof window.__MOTK_BOOT__.updateTiming === "function") {
            window.__MOTK_BOOT__.updateTiming(key, ms);
          }
        } catch (_) { }
      }
      function bootDiagSetFallback_(patch) {
        try {
          if (window.__MOTK_BOOT__ && typeof window.__MOTK_BOOT__.setFallback === "function") {
            window.__MOTK_BOOT__.setFallback(patch || {});
          }
        } catch (_) { }
      }
      var detailBootStart = 0;
      function markDetailTiming_(key) {
        if (!key) return;
        var now = (window.performance && typeof performance.now === "function") ? performance.now() : Date.now();
        if (!detailBootStart) detailBootStart = now;
        var ms = Math.round((now - detailBootStart) * 1000) / 1000;
        bootDiagUpdateTiming_(key, ms);
      }
      
      function tryCall(names, args) {
        return new Promise(function (resolve, reject) {
          var r = gsr(); if (!r) return reject(new Error("gsr missing"));
          (function next(i) {
            if (i >= names.length) return reject(new Error("no api"));
            var fn = names[i]; if (typeof r[fn] !== "function") return next(i + 1);
            r.withSuccessHandler(resolve).withFailureHandler(function () { next(i + 1); })[fn](args);
          })(0);
        });
      }
      
      function setLoading(show) {
        var el = document.getElementById("v2-loading-overlay");
        if(el) {
            if(show) el.classList.add("active");
            else el.classList.remove("active");
        }
      }

      function showStatus(msg, isError) {
        var el = document.getElementById("footerPage");
        if (el) {
          el.textContent = msg;
          el.style.color = isError ? "#ff5555" : "inherit";
          if (!isError) setTimeout(function(){ if(el.textContent === msg) el.textContent = "Detail"; }, 4000);
        }
      }

      /* ===== Helper Functions ===== */
      function capitalize(s) {
        if (!s) return '';
        return s.charAt(0).toUpperCase() + s.slice(1);
      }

      function singularEntityFor(x) {
        var s = String(x||'').toLowerCase().trim().replace(/[\s_-]/g, '');
        if (s === 'shots' || s === 'shot') return 'shot';
        if (s === 'assets' || s === 'asset') return 'asset';
        if (s === 'tasks' || s === 'task') return 'task';
        if (s === 'users' || s === 'user') return 'user';
        if (s === 'projectmembers' || s === 'members' || s === 'projectmember') return 'member';
        return s || 'shot';
      }
      function pluralEntityFor(x) {
        var s = singularEntityFor(x);
        if (s === 'shot') return 'Shots';
        if (s === 'asset') return 'Assets';
        if (s === 'task') return 'Tasks';
        if (s === 'user') return 'Users';
        if (s === 'member') return 'ProjectMembers';
        return 'Shots';
      }

      function normalizeRowsPayload(res) {
        if (!res) return { ids:[], header:[], rows:[], total:0 };
        if (res.columns && Array.isArray(res.columns)) {
            var ids = res.columns.map(function(c){ return String(c.id||c.field_id||""); });
            var header = res.columns.map(function(c){ return String(c.name||c.label||c.title||""); });
            var rows = Array.isArray(res.rows) ? res.rows : [];
            return { ids:ids, header:header, rows:rows, total:res.total||rows.length, columns:res.columns };
        }
        if (Array.isArray(res.ids) && Array.isArray(res.rows)) {
            return { ids:res.ids, header:res.header||[], rows:res.rows, total:res.total||0, columns:[] };
        }
        return { ids:[], header:[], rows:[], total:0 };
      }

      function _inferFieldType_(fid, label) {
        var f = String(fid || "").toLowerCase();
        var l = String(label || "").toLowerCase();
        if (window.KNOWN_LINK_FIELD_IDS && window.KNOWN_LINK_FIELD_IDS[f]) return "entity_link";
        if (/_link$/.test(f) || l.indexOf("link") >= 0) return "entity_link";
        if (/\bname\b/.test(l) && l.indexOf("id") < 0) return "entity_name";
        if (l.indexOf("original") >= 0) return "originals";
        if (l.indexOf("thumbnail") >= 0 || l.indexOf("thumb") >= 0) return "thumbnails";
        if (l.indexOf("file list") >= 0 || l.indexOf("file") >= 0) return "file_list";
        if (l.indexOf("version") >= 0) return "versions";
        if (l.indexOf("date") >= 0 || l.indexOf("due") >= 0) return "date";
        return "";
      }

      function _resolveFieldMetaWithFallback_(fid) {
        if (!fid) return null;
        var meta = (STATE.fieldsMeta && STATE.fieldsMeta[fid]) ? Object.assign({}, STATE.fieldsMeta[fid]) : null;
        if (meta && meta.type) return meta;

        var ent = String(STATE.entity || "").toLowerCase();
        var ft = window.FIELD_TYPES || {};
        if (ft[ent] && ft[ent][fid]) meta = Object.assign({}, ft[ent][fid], meta || {});
        if (!meta) {
          for (var k in ft) {
            if (ft[k] && ft[k][fid]) { meta = Object.assign({}, ft[k][fid]); break; }
          }
        }

        var label = (STATE.labels && STATE.labels[fid]) || (meta && (meta.label || meta.name)) || fid;
        var inferred = _inferFieldType_(fid, label);
        if (!meta) meta = { label: label };
        if (!meta.label) meta.label = label;
        if (!meta.name) meta.name = meta.label || label;
        if (!meta.field_name) meta.field_name = meta.label || label;
        if (!meta.type) meta.type = inferred || "text";
        return meta;
      }

      /* ===== 13.2 Router ===== */
      var Router = (window.__Router__ || {
        baseUrl: function () { return (window.scriptUrl || window.SCRIPT_URL || (location.origin + location.pathname)); },
        buildEntityUrl: function (ent, id) {
          var u = new URL(this.baseUrl(), this.baseUrl());
          u.searchParams.set("page", "DetailShot");
          u.searchParams.set("entity", ent || "shot");
          u.searchParams.set("id", id || "");
          return u.toString();
        }
      });

      /* ===== 13.3 State ===== */
      var STATE = {
        entity: "shot", id: "", sheet: "Shots", pageKey: "",
        ids: [], header: [], rows: [], columns: [], idxId: 0, pos: -1,
        row: {}, labels: {}, fieldsMeta: {},
        edit: false, layout: [],
        drag: { active: false, mode: "", card: null, start: { x: 0, y: 0, w: 0, h: 0 }, colW: 0, rowStep: 0, gridLeft: 0, gridTop: 0 },
        presets: [], currentPreset: ""
      };

      // ===== Detail field write coordinator (last-write-wins, coalesced) =====
      window.__MOTK_DETAIL_FIELD_WRITES = window.__MOTK_DETAIL_FIELD_WRITES || {};

      function _dwKey(entity, id, fid) {
        return String(entity || '') + '|' + String(id || '') + '|' + String(fid || '');
      }

      function _dwGetSlot(entity, id, fid) {
        var k = _dwKey(entity, id, fid);
        var slot = window.__MOTK_DETAIL_FIELD_WRITES[k];
        if (!slot) {
          slot = window.__MOTK_DETAIL_FIELD_WRITES[k] = {
            inFlight: false,
            pending: null,
            confirmed: undefined
          };
        }
        if (slot.confirmed === undefined && typeof STATE === 'object' && STATE && STATE.row && fid in STATE.row) {
          slot.confirmed = STATE.row[fid];
        }
        return slot;
      }

      /**
       * Coalesced field write:
       * - Always keep only the latest desired value while a write is in-flight.
       * - Do not apply intermediate server responses to DOM if a newer pending value exists.
       *
       * onFinalConfirm(confirmedVal, res)
       * onRollback(rollbackVal, err)
       */
      function dv2_queueFieldWrite(entity, id, fid, desiredVal, onFinalConfirm, onRollback) {
        var slot = _dwGetSlot(entity, id, fid);

        // Always coalesce to the latest desired value
        slot.pending = { value: desiredVal, onFinalConfirm: onFinalConfirm, onRollback: onRollback };

        if (slot.inFlight) return;

        (function flush() {
          if (slot.inFlight) return;
          if (!slot.pending) return;

          var job = slot.pending;
          slot.pending = null;
          slot.inFlight = true;

          var patch = {};
          patch[fid] = job.value;

          try { if (typeof showStatus === 'function') showStatus('Updating...'); } catch (_e) {}

          google.script.run
            .withSuccessHandler(function (res) {
              slot.inFlight = false;

              var confirmedVal = job.value;
              try {
                if (res && res.ok && res.fields && Object.prototype.hasOwnProperty.call(res.fields, fid)) {
                  confirmedVal = res.fields[fid];
                }
              } catch (_e) {}

              // Track last confirmed server value
              slot.confirmed = confirmedVal;

              // Do NOT stomp newer optimistic UI/state
              try {
                if (typeof STATE === 'object' && STATE && STATE.row) {
                  if (STATE.row[fid] === job.value) {
                    STATE.row[fid] = confirmedVal;
                  }
                }
              } catch (_e) {}

              // If a newer desired value exists, continue flushing WITHOUT finalizing UI to this intermediate state
              if (slot.pending) {
                flush();
                return;
              }

              try {
                if (typeof job.onFinalConfirm === 'function') job.onFinalConfirm(confirmedVal, res);
              } catch (_e) {}

            })
            .withFailureHandler(function (err) {
              slot.inFlight = false;

              // On failure, drop any newer pending value (server state is unknown; keep UI consistent with last confirmed)
              slot.pending = null;

              var rollbackVal = slot.confirmed;

              try {
                if (typeof job.onRollback === 'function') job.onRollback(rollbackVal, err);
              } catch (_e) {}
            })
            .dp_updateEntityRecord(entity, id, patch);
        })();
      }

      /* ===== 13.4 Link maps & Proxy ===== */
      window.LINK_MAPS = window.LINK_MAPS || { assets: {}, shots: {}, tasks: {}, users: {}, members: {} };
      var PROXY_CACHE = (window.PROXY_CACHE = (window.PROXY_CACHE || {}));
      var PROXY_CACHE_BY_FIELD = (window.PROXY_CACHE_BY_FIELD = (window.PROXY_CACHE_BY_FIELD || {}));

      function prefetchProxyIndex() {
        if (!gsr()) return;

        function pickLatestMap_(idx) {
          try {
            if (!idx || typeof idx !== "object") return { name: "", map: {} };
            var keys = ["latestByShotId", "latestById", "latestByRecordId", "latestByEntityId", "latest", "byId", "byShotId", "byRecordId"];
            for (var i = 0; i < keys.length; i++) {
              var k = keys[i];
              var v = idx[k];
              if (v && typeof v === "object" && !Array.isArray(v)) return { name: k, map: v };
            }
            for (var k2 in idx) {
              if (k2 === "items") continue;
              var v2 = idx[k2];
              if (v2 && typeof v2 === "object" && !Array.isArray(v2)) return { name: k2, map: v2 };
            }
          } catch (_) { }
          return { name: "", map: {} };
        }

        tryCall(['sv_indexAllProxies'], pluralEntityFor(STATE.entity)).then(function (idx) {
            try {
              // Prefer strict parsing from idx.items when available.
              try {
                if (idx && Array.isArray(idx.items) && typeof window.__MOTK_BUILD_PROXY_INDEX__ === "function") {
                  var built = window.__MOTK_BUILD_PROXY_INDEX__(idx.items);
                  if (built && typeof built === "object") {
                    try { for (var kk1 in PROXY_CACHE) { delete PROXY_CACHE[kk1]; } } catch (_) { }
                    try { for (var kk2 in PROXY_CACHE_BY_FIELD) { delete PROXY_CACHE_BY_FIELD[kk2]; } } catch (_) { }

                    var br = built.byRecord || {};
                    var bf = built.byRecordField || {};

                    for (var kbr in br) PROXY_CACHE[String(kbr).trim()] = br[kbr];
                    for (var kbf in bf) PROXY_CACHE_BY_FIELD[String(kbf).trim()] = bf[kbf];
                  }
                }
              } catch (_) { }

              var picked = pickLatestMap_(idx);
              var latest = picked.map || {};
              // Fallback to legacy maps only when strict parsing produced no keys.
              if (!Object.keys(PROXY_CACHE || {}).length && !Object.keys(PROXY_CACHE_BY_FIELD || {}).length) {
                for (var k in latest) {
                  var v = latest[k] || null;
                  try {
                    if (v && typeof v === "object") {
                      if (!v.url && v.id) v.url = "https://drive.google.com/uc?export=download&id=" + encodeURIComponent(String(v.id));
                    }
                  } catch (_) { }
                  PROXY_CACHE[String(k).trim()] = v;
                }
              }
              try { if (typeof window.__MOTK_PROXY_PREVIEW_REFRESH__ === "function") window.__MOTK_PROXY_PREVIEW_REFRESH__(); } catch (_) { }
              try { if (window.CommonRenderer && typeof CommonRenderer.refreshPendingPreviews === "function") CommonRenderer.refreshPendingPreviews(document); } catch (_) { }
              var grid = document.getElementById("grid");
              if(grid) {
                  var svCards = grid.querySelectorAll('.card[data-type="shotview"]');
                  svCards.forEach(function(c){
                      var inner = c.querySelector('.inner');
                      if(inner) renderShotViewContent(inner);
                  });
              }
            } catch (e) { }
        });
      }

      function defaultDetailTitle() {
        var ent = STATE.entity;
        return ent.charAt(0).toUpperCase() + ent.slice(1) + " Detail";
      }
      function resolveIdFid_() {
        try {
          if (window.SchemaResolver && SchemaResolver.getIdFid) {
            return SchemaResolver.getIdFid(singularEntityFor(STATE.entity || '') || STATE.entity || '');
          }
        } catch (_) { }
        return '';
      }
      function resolveEntityNameFid_() {
        try {
          if (window.SchemaResolver && SchemaResolver.getEntityNameFid) {
            return SchemaResolver.getEntityNameFid(singularEntityFor(STATE.entity || '') || STATE.entity || '');
          }
        } catch (_) { }
        return '';
      }
      function resolveRecordIdFromRow_(row) {
        if (!row) return '';
        var fid = resolveIdFid_();
        if (fid && row[fid] != null) return String(row[fid]);
        if (row.id != null) return String(row.id);
        if (row.ID != null) return String(row.ID);
        return '';
      }
      function _isFidLike_(v) {
        try {
          if (window.SchemaResolver && SchemaResolver.hasFid) return SchemaResolver.hasFid(v);
        } catch (_) { }
        var s = String(v == null ? '' : v).trim().toLowerCase();
        if (!s || s.indexOf('fi_') !== 0) return false;
        var rest = s.slice(3);
        if (!rest) return false;
        for (var i = 0; i < rest.length; i++) {
          var ch = rest.charCodeAt(i);
          if (ch < 48 || ch > 57) return false;
        }
        return true;
      }
      function deriveRecordTitle() {
        var row = STATE.row || {};
        var ids = Array.isArray(STATE.ids) ? STATE.ids : [];
        for (var i = 0; i < ids.length; i++) {
          var fid = ids[i];
          var meta = _resolveFieldMetaWithFallback_(fid);
          var t = meta && meta.type ? String(meta.type).trim().toLowerCase() : "";
          var lbl = (STATE.labels && STATE.labels[fid]) || (meta && (meta.label || meta.name)) || "";
          var hasName = /\bname\b/i.test(String(lbl || ""));
          if (t === "entity_name" || t === "name" || hasName) {
            var v = row[fid];
            if (v != null && String(v).trim()) return String(v);
          }
        }
        var nameFid = resolveEntityNameFid_();
        if (nameFid && row[nameFid] != null && String(row[nameFid]).trim()) return String(row[nameFid]);
        if (STATE.id) return String(STATE.id);
        return "";
      }

      function entityFromPageKey(pg) {
        var key = String(pg || '').toLowerCase();
        if (!key) return '';
        if (key === 'detailasset') return 'asset';
        if (key === 'detailtask') return 'task';
        if (key === 'detailuser') return 'user';
        if (key === 'detailmember') return 'member';
        return 'shot';
      }
      function queryStringPage() {
        try { return String((new URLSearchParams(location.search || '')).get('page') || '').toLowerCase(); } catch (_) { return ''; }
      }
      function pageKeyFromEntity(ent) {
        var canon = String(ent || '').toLowerCase();
        var key = '';
        if (typeof detailPageNameForEntity === 'function') {
          try { key = detailPageNameForEntity(canon); } catch (_) { key = ''; }
        }
        if (key) return key;
        if (canon === 'asset' || canon === 'assets') return 'DetailAsset';
        if (canon === 'task' || canon === 'tasks') return 'DetailTask';
        if (canon === 'user' || canon === 'users') return 'DetailUser';
        if (canon === 'member' || canon === 'members' || canon === 'projectmember' || canon === 'projectmembers') return 'DetailMember';
        return 'DetailShot';
      }

      function ensurePageKey(force) {
        if (!window.STATE) return 'DetailShot';
        var ent = String((STATE && STATE.entity) || '').toLowerCase();
        if (!ent) {
          var body = (typeof document !== 'undefined' && document.body) ? document.body : null;
          if (body && body.dataset) {
            var hinted = String(body.dataset.navEntity || '').toLowerCase();
            if (!hinted) { hinted = entityFromPageKey(body.dataset.navPage); }
            if (!hinted) { hinted = entityFromPageKey(queryStringPage()); }
            if (hinted) { ent = hinted; if (STATE) STATE.entity = hinted; }
          }
        }
        var desired = pageKeyFromEntity(ent);
        if (force || !STATE.pageKey || STATE.pageKey.toLowerCase() !== desired.toLowerCase()) {
          STATE.pageKey = desired;
        }
        if (typeof document !== 'undefined' && document.body && document.body.dataset) {
          document.body.dataset.navPage = STATE.pageKey;
          if (STATE.entity) document.body.dataset.navEntity = STATE.entity;
        }
        return STATE.pageKey;
      }

      function currentPageKey() {
        if (STATE && STATE.pageKey) return STATE.pageKey;
        return ensurePageKey();
      }
      function storageKey(prefix) {
        return currentPageKey() + ':' + prefix;
      }

      /* ===== 13.5 Grid helpers ===== */
      function gridMetrics() {
        var grid = $("#grid"), rect = grid.getBoundingClientRect();
        var cs = getComputedStyle(grid);
        var cols = parseInt(cs.getPropertyValue("--cols"), 10);
        if (isNaN(cols) || cols < 24) cols = 24;

        var rowh = parseFloat(cs.getPropertyValue("--rowh"));
        var gap = parseFloat(cs.getPropertyValue("--gap"));
        if(isNaN(gap)) gap = 4;
        
        var colW = 100;
        var fixedW = cs.getPropertyValue("--col-width");
        if(fixedW) colW = parseInt(fixedW, 10) || 100;

        var totalWidthNeeded = (cols * colW) + ((cols - 1) * gap);
        grid.style.width = totalWidthNeeded + "px";
        grid.style.gridTemplateColumns = "repeat(" + cols + ", " + colW + "px)";

        var gridLeft = rect.left + window.scrollX;
        var gridTop = rect.top + window.scrollY;
        
        return { grid, rect, cols, rowh, gap, colW, rowStep: (rowh + gap), gridLeft, gridTop };
      }
      
      function applyXYWH(card, x, y, w, h) {
        card.dataset.x = x; card.dataset.y = y; card.dataset.w = w; card.dataset.h = h;
        card.style.gridColumn = (x + 1) + " / span " + w;
        card.style.gridRow = (y + 1) + " / span " + h;
      }
      function rectOf(card) { return { x: +card.dataset.x, y: +card.dataset.y, w: +card.dataset.w, h: +card.dataset.h }; }
      function collides(a, b) { return !(a.x + a.w <= b.x || b.x + b.w <= a.x || a.y + a.h <= b.y || b.y + b.h <= a.y); }
      function maxOccupiedY() {
        var max = 0; $("#grid").querySelectorAll(".card").forEach(function (c) {
          var y = +c.dataset.y, h = +c.dataset.h; if (y + h > max) max = y + h;
        }); return max;
      }
      function placeWithoutOverlap(card, x, y, w, h) {
        var boxes = [], grid = $("#grid");
        grid.querySelectorAll(".card").forEach(function (el) { if (el !== card) boxes.push(rectOf(el)); });
        var pos = { x: x, y: y, w: w, h: h };
        var safe = 0;
        while (safe < 400) {
          var ok = true;
          for (var i = 0; i < boxes.length; i++) { if (collides(pos, boxes[i])) { ok = false; break; } }
          if (ok) return pos;
          pos.y++;
          safe++;
        }
        return pos;
      }

      /* horizontal scroll + bottom padding fix */
      var HSCROLL = { init: false, wrap: null, bar: null, inner: null, skipWrap: false, skipBar: false };
      function setupHorizontalScroll() {
        if (HSCROLL.init) return;
        var wrap = document.getElementById('gridWrap');
        var bar = document.getElementById('hScroll');
        var inner = document.getElementById('hScrollInner');
        if (!wrap || !bar || !inner) return;
        HSCROLL.wrap = wrap; HSCROLL.bar = bar; HSCROLL.inner = inner; HSCROLL.init = true;

        wrap.style.overflow = 'auto';
        wrap.style.willChange = 'scroll-position';

        wrap.addEventListener('scroll', function () {
          if (HSCROLL.skipWrap) { HSCROLL.skipWrap = false; return; }
          HSCROLL.skipBar = true;
          bar.scrollLeft = wrap.scrollLeft;
          requestAnimationFrame(function () { HSCROLL.skipBar = false; });
        }, { passive: true });
        bar.addEventListener('scroll', function () {
          if (HSCROLL.skipBar) { HSCROLL.skipBar = false; return; }
          HSCROLL.skipWrap = true;
          wrap.scrollLeft = bar.scrollLeft;
          requestAnimationFrame(function () { HSCROLL.skipWrap = false; });
        }, { passive: true });
      }
      function refreshHorizontalScroll() {
        setupHorizontalScroll();
        if (!HSCROLL.init) return;
        var wrap = HSCROLL.wrap, bar = HSCROLL.bar, inner = HSCROLL.inner;
        if (!wrap || !bar || !inner) return;

        var footerH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--footer-h') || '22', 10) || 22;
        var padBottom = footerH + 12 + bar.offsetHeight;
        bar.style.bottom = 'var(--footer-h,22px)';
        bar.style.top = 'auto';

        var width = wrap.scrollWidth || 0;
        var viewport = wrap.clientWidth || 0;
        if (width > viewport + 1) {
          inner.style.width = width + 'px';
          bar.style.display = 'block';
          if (!HSCROLL.skipBar) {
            HSCROLL.skipBar = true;
            bar.scrollLeft = wrap.scrollLeft;
            requestAnimationFrame(function () { HSCROLL.skipBar = false; });
          }
        } else {
          bar.style.display = 'none';
        }
      }
      if (typeof window !== 'undefined') {
        window.addEventListener('resize', function () {
          requestAnimationFrame(function () {
            ensureToolbarVisible();
            refreshHorizontalScroll();
          });
        });
      }

      /* ===== 13.6 Toolbar ===== */
      function ensureToolbarVisible() {
        var tb = document.getElementById("toolbar"); if (!tb) return;
        try {
          tb.style.display = "grid";
          tb.style.visibility = "visible";
          tb.style.opacity = "1";
          tb.style.position = "fixed";
          tb.style.left = "0"; tb.style.right = "0";
          tb.style.zIndex = "1200";

          var g = document.getElementById("gNav"), p = document.getElementById("pNav");
          var gHeight = g && g.getBoundingClientRect ? Math.round(g.getBoundingClientRect().height) : 0;
          var pHeight = p && p.getBoundingClientRect ? Math.round(p.getBoundingClientRect().height) : 0;
          var FIXED_TOOLBAR_PX = 32;
          tb.style.height = FIXED_TOOLBAR_PX + "px";
          tb.style.minHeight = FIXED_TOOLBAR_PX + "px";
          tb.style.maxHeight = FIXED_TOOLBAR_PX + "px";

          var topForToolbar = gHeight + pHeight;
          tb.style.top = topForToolbar + "px";

          var root = document.documentElement;
          if (root) {
            root.style.setProperty('--gnav-height', gHeight + 'px');
            root.style.setProperty('--pnav-height', pHeight + 'px');
          }

          var tbHeight = tb.getBoundingClientRect ? Math.round(tb.getBoundingClientRect().height) : FIXED_TOOLBAR_PX;
          var topOffsetFull = gHeight + pHeight + tbHeight;

          if (root) {
            root.style.setProperty('--top-offset', topOffsetFull + 'px');
          }
          var wrap = document.getElementById("gridWrap");
          if (wrap) {
            wrap.style.top = topOffsetFull + "px";
          }

          document.querySelectorAll(".spacer-top").forEach(function (n) { try { n.parentNode.removeChild(n); } catch (_) { } });

          var grid = document.querySelector("#gridstackWrap") || document.querySelector("#grid") || document.querySelector(".grid-stack");
          if (grid) { grid.style.marginTop = "0"; grid.style.top = "0"; }
          
          gridMetrics();

          var bandSel = ["#hScroll", ".top-band", ".grid-top-gap", ".grid-overlay"];
          bandSel.forEach(function (sel) { var el = document.querySelector(sel); if (el) { el.style.display = "none"; } });
        } catch (_) { }
      }

      function lockCardHeaderHeights() {
        var TARGET = 24;
        document.querySelectorAll("#grid .card .card-header").forEach(function (hd) {
          hd.style.minHeight = TARGET + "px";
          hd.style.height = TARGET + "px";
          hd.style.paddingTop = "2px";
          hd.style.paddingBottom = "2px";
        });
      }

      function bindToolbar() {
        var tl = $("#toggleLayout");
        var badge = $("#modeBadge");
        var footer = $("#footerMode");
        
        function applyMode() {
          var isEdit = !!STATE.edit;
          var body = document.body;
          if (body) {
            body.classList.toggle("layout-edit", isEdit);
            body.setAttribute("data-layout-mode", isEdit ? "edit" : "view");
          }
          
          var save = document.getElementById("saveBtnAll");
          var cards = document.getElementById("cardsBtn");
          
          if (save) { save.style.display = isEdit ? "" : "none"; save.disabled = !isEdit; }
          if (cards) { cards.style.display = isEdit ? "" : "none"; cards.disabled = !isEdit; }
          
          if (tl) { 
            tl.textContent = isEdit ? "Edit mode" : "View mode";
            tl.setAttribute("aria-pressed", isEdit ? "true" : "false");
            tl.classList.toggle("is-active", isEdit);
          }
          if (badge) { badge.textContent = isEdit ? "EDIT MODE" : "VIEW MODE"; badge.style.display = isEdit ? "inline-flex" : "none"; }
          if (footer) { footer.textContent = isEdit ? "Edit mode" : "View mode"; }

          var tb = document.getElementById("toolbar");
          if (tb) { tb.classList.toggle("is-edit", isEdit); tb.setAttribute("data-mode", isEdit ? "edit" : "view"); }

          var removes = document.querySelectorAll(".card-remove");
          removes.forEach(function(el){ 
             el.style.setProperty('display', isEdit ? 'flex' : 'none', 'important');
          });

          requestAnimationFrame(lockCardHeaderHeights);
        }
        
        if (tl) { 
          tl.addEventListener("click", function (e) { 
            e.preventDefault(); 
            e.stopPropagation(); 
            STATE.edit = !STATE.edit; 
            applyMode(); 
            ensureToolbarVisible(); 
          }, { passive: false }); 
        }
        applyMode();
        window.bindToolbar = bindToolbar;

        window.addEventListener("resize", function () { requestAnimationFrame(function () { ensureToolbarVisible(); lockCardHeaderHeights(); }); }, { passive: true });
      }

      /* ===== 13.7 Save UI / Modals ===== */
      function initModalHandlers() {
          document.addEventListener('click', function(e) {
              var target = e.target;
              var closeBtn = target.closest('#cardsClose, #saveCancel, #fieldCancel, .btn-close, .close');
              if (closeBtn) {
                  var modal = closeBtn.closest('.v2-modal-overlay');
                  if (modal) {
                      e.preventDefault(); e.stopPropagation();
                      closeModal(modal);
                      return;
                  }
              }
              if (target.classList.contains('v2-modal-overlay')) {
                  if (target.classList.contains('is-visible')) {
                      e.preventDefault(); e.stopPropagation();
                      closeModal(target);
                      return;
                  }
              }
          }, false);
      }

      function installHardNavForInternalLinks() {
        if (window.__MOTK_HARDNAV_INSTALLED__) return;
        window.__MOTK_HARDNAV_INSTALLED__ = true;

        document.addEventListener("click", function (e) {
          try {
            try {
              var t0 = e && e.target;
              if (t0 && t0.closest && t0.closest('[data-motk-media-trigger="1"]')) return;
            } catch (_) { }
            if (!e || e.defaultPrevented) return;
            if (e.button !== 0) return;
            if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;

            var t = e.target;
            var a = (t && t.closest) ? t.closest("a") : null;
            if (!a) return;

            if (a.closest && (a.closest("#motk-modal-root") || a.closest("#motkLinkPicker") || a.closest(".motk-link-picker") || a.closest(".v2-modal-overlay"))) {
              return;
            }

            var hrefAttr = a.getAttribute("href") || "";
            if (!hrefAttr || hrefAttr.charAt(0) === "#") return;

            var target = String(a.getAttribute("target") || "").toLowerCase();
            if (target === "_blank") return;

            var href = a.href || hrefAttr;
            if (!href) return;

            var isInternal = false;
            if (hrefAttr.charAt(0) === "?") isInternal = true;
            if (href.indexOf("script.google") >= 0) isInternal = true;
            if (href.indexOf("googleusercontent") >= 0) isInternal = true;
            if (!isInternal) return;

            e.preventDefault();
            e.stopPropagation();
            (window.top || window).location.href = href;
          } catch (_) { }
        }, true);
      }

      function bindSaveUI() {
        var saveBtn = $("#saveBtnAll"), menu = $("#saveMenu");
        if (!saveBtn || !menu) return;
        
        var btn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(btn, saveBtn);
        
        btn.onclick = function (e) { 
            e.preventDefault(); 
            e.stopPropagation(); 
            menu.classList.toggle("open"); 
        };
        
        document.addEventListener("click", function (e) {
              if (!menu.contains(e.target) && e.target !== btn) {
                  menu.classList.remove("open"); 
              }
        });
        
        menu.querySelectorAll(".mi").forEach(function (mi) {
          mi.onmousedown = function(e) { e.stopPropagation(); };
          mi.onclick = async function (e) {
            e.preventDefault(); e.stopPropagation();
            var cmd = mi.getAttribute("data-cmd");
            if (cmd === "save") { await runSaveOverwrite(); }
            if (cmd === "saveas") { openModal("#v2-save-modal"); }
            if (cmd === "revert") { await loadLayoutAndApply(STATE.currentPreset || null); }
            menu.classList.remove("open");
          };
        });
        document.addEventListener("keydown", async function (e) {
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") { e.preventDefault(); await runSaveOverwrite(); }
        });
      }

      function runSaveOverwrite() {
        return saveLayout(null, true, true);
      }

      function openModal(sel) {
        var allModals = document.querySelectorAll('.v2-modal-overlay');
        allModals.forEach(function(m) {
            m.classList.remove('is-visible');
            m.style.display = "none";
        });
        document.body.classList.remove('modal-open');

        var m = (typeof sel === 'string' ? document.querySelector(sel) : sel);
        if (!m) return;
        
        m.style.display = "flex";
        m.classList.add('motk-modal-backdrop');
        m.classList.add("is-visible");
        document.body.classList.add("modal-open");
        
        var input = m.querySelector("input");
        if(input) setTimeout(function(){ input.focus(); }, 50);
      }

      function closeModal(sel) {
        var m = (typeof sel === 'string') ? document.querySelector(sel) : sel;
        if (!m) return;
        m.classList.remove("is-visible");
        m.style.display = "none";
        document.body.classList.remove("modal-open");
      }

      function bindSaveModal() {
        var a = $("#saveApply");
        if (a) {
            a.onclick = async function (e) {
              e.preventDefault(); e.stopPropagation();
              
              var btn = e.target;
              var originalText = btn.textContent;
              btn.textContent = "Saving...";
              btn.disabled = true;
              
              try {
                var name = ($("#saveAsName") && $("#saveAsName").value || "").trim();
                var editBox = document.getElementById("saveAsEdit");
                var edit = editBox ? !!editBox.checked : true;
                
                if (!name) { 
                    showStatus("Preset name required", true); 
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return; 
                }
                
                await saveLayout(name, false, edit);
                await loadPresets(); 
                var sel = $("#presetSelect"); 
                if (sel && STATE.currentPreset) {
                   sel.value = STATE.currentPreset;
                }
              } catch(err) {
                console.error(err);
              } finally {
                btn.textContent = originalText;
                btn.disabled = false;
                closeModal("#v2-save-modal");
              }
            };
            a.onmousedown = function(e) { e.stopPropagation(); };
        }
      }

      (function ensureModalContract() {
        var modals = document.querySelectorAll(".v2-modal-overlay");
        modals.forEach(function (m) {
          m.classList.remove("is-visible");
          m.style.display = "none";
        });
      })();

      /* ===== 13.8 Cards / Layouts ===== */
      function duplicateCard(key) {
        var i = STATE.layout.findIndex(function (x) { return x.key === key; });
        if (i < 0) return;
        var src = STATE.layout[i];
        var dup = JSON.parse(JSON.stringify(src));
        dup.key = src.key + "_" + Math.random().toString(36).slice(2, 5);
        dup.title = (src.title || "") + " Copy";
        dup.y = maxOccupiedY() + 1;
        STATE.layout.splice(i + 1, 0, dup);
        var el = createCard(dup);
        $("#grid").appendChild(el);
      }
      function removeCard(key) {
        var i = STATE.layout.findIndex(function (x) { return x.key === key; });
        if (i < 0) return;
        STATE.layout.splice(i, 1);
        var selector = "#grid .card[data-key='" + key + "']";
        var el = document.querySelector(selector); if (el) el.remove();
        renderCardsList();
      }
      function bindCardsModal() {
        var oldBtn = $("#cardsBtn");
        if (!oldBtn) return;
        
        var btn = oldBtn.cloneNode(true);
        if (oldBtn.parentNode) {
          oldBtn.parentNode.replaceChild(btn, oldBtn);
        }
        
        btn.onmousedown = function(e) { e.stopPropagation(); };
        btn.onclick = function (e) {
          e.preventDefault();
          e.stopPropagation();
          renderCardsList();
          openModal("#v2-cards-modal");
        };
        
        var add = $("#addCard"); 
        if (add) {
            add.onclick = function (e) {
              e.preventDefault(); e.stopPropagation();
              if (!Array.isArray(STATE.layout)) STATE.layout = [];
              var key = "card_" + Math.random().toString(36).slice(2, 8);
              var def = { key: key, title: "New Card", type: "table", x: 0, y: maxOccupiedY() + 1, w: 4, h: 12, fields: [], thwpx: 100, __autofit__: false };
              STATE.layout.push(def);
              var el = createCard(def); $("#grid").appendChild(el);
              renderCardsList();
              setTimeout(function() {
                  closeModal("#v2-cards-modal");
                  openCardSettings(def.key);
              }, 200);
            };
        }
      }
      function renderCardsList() {
        var box = $("#cardsList"); if (!box) return;
        box.innerHTML = "";
        if (!Array.isArray(STATE.layout)) STATE.layout = [];
        STATE.layout.forEach(function (def) {
          var row = document.createElement("div"); row.className = "list-row";
          var name = document.createElement("div"); name.textContent = def.title || def.key;
          var jump = document.createElement("span"); jump.className = "xbtn"; jump.textContent = "Move"; jump.title = "Focus";
          jump.onclick = function () { var el = $("#grid .card[data-key='" + def.key + "']"); if (!el) return; el.scrollIntoView({ behavior: "smooth", block: "center" }); el.classList.add("dragging"); setTimeout(function () { el.classList.remove("dragging"); }, 600); };
          var edit = document.createElement("span"); edit.className = "xbtn"; edit.textContent = "Edit"; edit.title = "Edit"; edit.onclick = function (e) { 
              e.preventDefault(); e.stopPropagation();
              closeModal("#v2-cards-modal");
              openCardSettings(def.key); 
          };
          var del = document.createElement("span"); del.className = "xbtn"; del.textContent = "Delete"; del.title = "Delete"; del.onclick = function (e) { 
            e.preventDefault(); e.stopPropagation();
            removeCard(def.key); 
          };
          row.appendChild(name); row.appendChild(jump); row.appendChild(edit); row.appendChild(del); box.appendChild(row);
        });
      }
      function bindPresetAutoRefresh(sel) {
        if (!sel || sel._motkRefreshBound) return;
        sel._motkRefreshBound = true;
        var kick = function () {
          var hasLoading = Array.from(sel.options).some(o => o.text === "Loading...");
          if (!hasLoading) {
             var opt = document.createElement("option");
             opt.text = "Loading...";
             opt.disabled = true;
             sel.appendChild(opt);
          }
          loadPresets().then(function(){
          });
        };
        sel.addEventListener('mousedown', kick);
      }

      async function loadPresets() {
        var sel = $("#presetSelect"); if (!sel) return;
        if (!sel._motkRefreshBound) bindPresetAutoRefresh(sel);
        var curVal = sel.value;
        
        try {
          var payload = { entity: "", pageType: 'detail' };
          var list = await tryCall(["gsListPagePresets", "sv_listPageLayoutPresets"], payload);
          if (Array.isArray(list)) {
            sel.innerHTML = "";
            var currentEnt = singularEntityFor(STATE.entity);
            var filtered = list.filter(function(p) {
               var e = singularEntityFor(p.entity);
               return (!e || e === currentEnt);
            });
            STATE.presets = filtered;
            filtered.forEach(function (p) {
              var pid = String(p.pageId || p.id || p.page_id || p.pid || "").trim();
              var label = String(p.pageName || p.name || p.title || pid || "").trim();
              if (!pid) return;
              if (!label) label = pid;
              var o = document.createElement("option");
              o.value = pid;
              o.textContent = label;
              o.dataset.pageId = pid;
              o.dataset.pageName = label;
              if (p.pageType) o.dataset.pageType = String(p.pageType);
              if (p.entity) o.dataset.entity = String(p.entity);
              sel.appendChild(o);
            });
            if (!sel.options.length) {
              var opt = document.createElement("option");
              opt.textContent = "No presets";
              opt.disabled = true;
              sel.appendChild(opt);
            }
          }
        } catch (e) { console.warn("[Detail] Failed to sync presets", e); }
        
        if (STATE.currentPreset && Array.from(sel.options).some(function(o){ return o.value===STATE.currentPreset; })) {
           sel.value = STATE.currentPreset;
        } else if (curVal && Array.from(sel.options).some(function(o){ return o.value===curVal; })) {
           sel.value = curVal;
        }
        
        sel.onchange = async function () { 
          STATE.currentPreset = this.value || ""; 
          await loadLayoutAndApply(STATE.currentPreset || null); 
        };
      }
      
      async function loadLayoutAndApply(presetNameOrId) {
        var layouts = [];
        try {
          var raw = localStorage.getItem("MOTK_DETAIL_LAYOUTS_V2");
          if (raw) layouts = JSON.parse(raw);
        } catch (e) { console.warn("Layout storage parse error", e); }

        var preset = null;
        if (presetNameOrId) {
          preset = layouts.find(function (l) { return l.name === presetNameOrId || l.id === presetNameOrId; });
        }
        if (!preset && Array.isArray(STATE.presets)) {
          preset = STATE.presets.find(function (p) {
            return (p && (p.id === presetNameOrId || p.pageId === presetNameOrId || p.name === presetNameOrId || p.pageName === presetNameOrId));
          });
          if (!preset && presetNameOrId == null && STATE.presets.length) preset = STATE.presets[0];
        }

        var layout = null;
        if (preset && Array.isArray(preset.layout)) layout = preset.layout;
        else if (preset && preset.config && Array.isArray(preset.config.layout)) layout = preset.config.layout;
        else if (preset && preset.config && typeof preset.config.layout === "string") {
          try { layout = JSON.parse(preset.config.layout); } catch (_) { layout = null; }
        }

        if (layout && Array.isArray(layout)) {
          STATE.layout = JSON.parse(JSON.stringify(layout));
          var presetId = (preset && (preset.pageId || preset.id)) ? String(preset.pageId || preset.id) : "";
          var presetLabel = (preset && (preset.pageName || preset.name || preset.pageId || preset.id)) ? String(preset.pageName || preset.name || preset.pageId || preset.id) : "";
          STATE.currentPreset = presetId || presetLabel || "";
          showStatus("Loaded: " + (presetLabel || STATE.currentPreset || "preset"));
          try { buildFromLayout(); } catch (e) { console.error("[Detail] Build from preset failed:", e); showError("Layout build failed."); }
        } else {
          console.warn("[Detail] No layout found for:", presetNameOrId);
          showError("No layout found for: " + String(presetNameOrId || ""));
        }
      }
      
      async function saveLayout(presetName, overwrite, editAllowed) {
        showStatus("Saving...");
        STATE.layout = exportLayoutFromDOM();
        var saved = false;
        var pid = (overwrite && STATE.currentPreset && /^pg_/.test(STATE.currentPreset)) 
                ? STATE.currentPreset 
                : "pg_new";

        var payload = {
          pageId: pid,
          pageType: "detail",
          entity: STATE.entity,
          shared: !!editAllowed, 
          config: { layout: STATE.layout }
        };

        if (presetName) {
          payload.pageName = presetName;
        } else if (!overwrite) {
          payload.pageName = "Detail View";
        }
        
        try {
          var res = await tryCall(["sv_savePageConfig", "gsSavePageConfig"], payload);
          if (res && res.ok) {
             saved = true;
             if (res.pageId) {
               STATE.currentPreset = res.pageId;
               updateUrlState(res.pageId);
               /* FIX: reload presets after save */
               await loadPresets(); 
               var sel = $("#presetSelect"); if (sel) sel.value = res.pageId;
             }
             showStatus("Saved!");
          } else {
            showStatus("Save Failed: " + ((res && res.error) ? res.error : "Unknown"), true);
          }
        } catch (e) { 
          console.error(e);
          showStatus("Save Error", true);
        }
        return saved;
      }

      function updateUrlState(_pageId) {
        // Canonical URL policy: do not expose internal preset IDs (`pid`) in the browser URL.
        try {
          var u = new URL(window.location.href);
          if (u.searchParams.has("pid")) {
            u.searchParams.delete("pid");
            history.replaceState(null, "", u.toString());
          }
        } catch (e) {}
      }

function exportLayoutFromDOM() {
        var arr = [];
        $("#grid").querySelectorAll(".card").forEach(function (c) {
          var key = c.dataset.key || "";
          var w = +c.dataset.w, h = +c.dataset.h, x = +c.dataset.x, y = +c.dataset.y;
          var title = (c.querySelector(".card-title") || {}).textContent || key;
          var type = c.dataset.type || (c.querySelector(".media") ? "shotview" : "table");
          var thwpx = parseInt((c.style.getPropertyValue("--thwpx") || "100px"), 10) || 100;
          var fields = [];
          if (type === "table") {
            var table = c.querySelector(".table");
            if (table) {
              table.querySelectorAll("th").forEach(function (th) {
                var label = th.textContent;
                var fid = th.getAttribute("data-fid") || Object.keys(STATE.labels).find(function (k) { return STATE.labels[k] === label; }) || label;
                if (fid) fields.push(fid);
              });
            }
          }
          arr.push({ key: key, title: title, type: type, x: x, y: y, w: w, h: h, fields: fields, thwpx: thwpx });
        });
        return arr;
      }

      /* ===== 13.9 Layout builders ===== */
      function setDefaultLayout() {
        console.log("[Detail] Generating default layout...");
        var hasView = false;
        try {
          if (STATE.fieldsMeta) {
            var keys = Object.keys(STATE.fieldsMeta);
            for (var i = 0; i < keys.length; i++) {
              var m = STATE.fieldsMeta[keys[i]] || {};
              if (String(m.type || "").toLowerCase() === "versions") { hasView = true; break; }
            }
          }
        } catch (_) { }
        var viewType = hasView ? "shotview" : "table";
        STATE.layout = [
          { key: "def_view", title: "View", type: viewType, x: 0, y: 0, w: 5, h: 8, fields: [], thwpx: 100 },
          { key: "def_info", title: "Basic Info", type: "table", x: 5, y: 0, w: 7, h: 12, fields: [], thwpx: 100 }
        ];
      }
      function buildFromLayout() {
        var grid = $("#grid"); grid.innerHTML = "";
        if (!Array.isArray(STATE.layout) || !STATE.layout.length) return;
        STATE.layout.forEach(function (c) {
          try {
            grid.appendChild(createCard(c));
          } catch (e) { console.error("[Detail] createCard failed for", c, e); }
        });
        requestAnimationFrame(function () {
          if (window.FieldsAPI && typeof FieldsAPI.hydrateLinks === "function") {
            FieldsAPI.hydrateLinks(grid, { entity: STATE.entity, row: STATE.row, labels: STATE.labels });
          }
          refreshHorizontalScroll();
          lockCardHeaderHeights();
          requestAnimationFrame(lockCardHeaderHeights);
        });
      }

      /* ===== 13.10 Card factory ===== */
      (function () {
        function resolveFieldMeta_(fid) {
          return _resolveFieldMetaWithFallback_(fid);
        }

        function resolveShotViewFid_() {
          try {
            var meta = STATE.fieldsMeta || {};
            var fids = Object.keys(meta);
            var entKey = String(STATE.entity || "").toLowerCase();
            for (var i = 0; i < fids.length; i++) {
              var fid = fids[i];
              var m = meta[fid] || resolveFieldMeta_(fid) || {};
              var t = String(m.type || "").toLowerCase();
              var e = String(m.entity || m.entityName || m.entity_key || m.entityKey || "").toLowerCase();
              if (t === "versions" && (!e || e === entKey)) return fid;
            }
          } catch (_) { }
          try {
            if (window.SchemaResolver && SchemaResolver.getFidsByType) {
              var list = SchemaResolver.getFidsByType(STATE.entity, 'versions');
              if (list && list.length) return list[0];
            }
          } catch (_) { }
          try { showError("Missing versions field in Fields meta."); } catch (_) { }
          return "";
        }

        function renderShotViewContent(container) {
          try {
            container.innerHTML = "";
            if (!(window.FieldsAPI && typeof FieldsAPI.renderCellByField === "function")) {
              container.appendChild(document.createTextNode(""));
              return;
            }

            var fid = STATE.shotviewFid || (STATE.shotviewFid = resolveShotViewFid_());
            var meta = resolveFieldMeta_(fid);
            var type = (meta && meta.type) ? String(meta.type).trim().toLowerCase() : "versions";
            var val = (STATE.row && STATE.row[fid] != null) ? STATE.row[fid] : "";
            if ((val == null || val === "") && STATE.row) {
              var labelKey = (STATE.labels && STATE.labels[fid]) ? String(STATE.labels[fid]) : "";
              if (!labelKey && meta) { labelKey = String(meta.name || meta.label || meta.field_name || ""); }
              if (labelKey && STATE.row[labelKey] != null) val = STATE.row[labelKey];
              if ((val == null || val === "") && labelKey) {
                var lowerKey = labelKey.toLowerCase();
                if (STATE.row[lowerKey] != null) val = STATE.row[lowerKey];
              }
            }

            var node = FieldsAPI.renderCellByField({
              fid: fid,
              fieldId: fid,
              type: type,
              val: val,
              value: val,
              row: STATE.row || {},
              labels: STATE.labels || {},
              entity: STATE.entity,
              recordId: STATE.id,
              rowId: STATE.id,
              id: STATE.id,
              field: meta || null,
              editable: false
            });

            if (node) container.appendChild(node);
            else container.appendChild(document.createTextNode(""));
          } catch (_) {
            try { container.textContent = ""; } catch (__) { }
          }
        }

        function createCard(def) {
          var card = document.createElement("section");
          card.className = "card";
          card.dataset.key = def.key;
          var type = String(def.type || "table");
          card.dataset.type = type;

          applyXYWH(card, def.x, def.y, def.w, def.h);
          /* FIX: set initial width to 100px */
          card.style.setProperty("--thwpx", (def.thwpx || 100) + "px");

          var hd = document.createElement("div");
          hd.className = "card-header";

          var ttl = document.createElement("div");
          ttl.className = "card-title";
          ttl.textContent = def.title || def.key;

          var act = document.createElement("div");
          act.className = "card-actions";

          var btnEdit = document.createElement("button");
          btnEdit.className = "btn edit-only";
          btnEdit.type = "button";
          btnEdit.textContent = "Edit";
          btnEdit.title = "Edit card";
          btnEdit.onmousedown = function(e) { e.stopPropagation(); };
          btnEdit.addEventListener("click", function (e) {
            e.preventDefault(); e.stopPropagation();
            openCardSettings(def.key);
          });

          var btnDup = document.createElement("button");
          btnDup.className = "btn edit-only";
          btnDup.type = "button";
          btnDup.textContent = "Duplicate";
          btnDup.title = "Duplicate card";
          btnDup.onmousedown = function(e) { e.stopPropagation(); };
          btnDup.addEventListener("click", function (e) {
            e.preventDefault(); e.stopPropagation();
            duplicateCard(def.key);
          });

          var btnFit = document.createElement("button");
          btnFit.className = "btn edit-only";
          btnFit.type = "button";
          btnFit.textContent = "Auto height";
          btnFit.title = "Auto fit height";
          btnFit.onmousedown = function(e) { e.stopPropagation(); };
          btnFit.addEventListener("click", function (e) {
            e.preventDefault(); e.stopPropagation();
            autoFitHeight(card, true);
          });

          var btnReload = document.createElement("button");
          btnReload.className = "btn btn-icon btn-reload";
          btnReload.type = "button";
          btnReload.setAttribute("aria-label", "Reload");
          btnReload.title = "Reload";
          btnReload.innerHTML =
            '<svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" focusable="false">' +
              '<path fill="currentColor" d="M17.65 6.35A7.95 7.95 0 0 0 12 4a8 8 0 1 0 7.75 10h-2.1A6 6 0 1 1 12 6c1.66 0 3.14.69 4.22 1.78L14 10h6V4l-2.35 2.35Z"/>' +
            '</svg>';
          btnReload.onmousedown = function(e) { e.stopPropagation(); };
          btnReload.addEventListener("click", function (e) {
            e.preventDefault(); e.stopPropagation();
            try {
              var cardType = String(card.dataset.type || "");
              if (cardType === "shotview") {
                var inner = card.querySelector(".media .inner");
                if (inner) renderShotViewContent(inner);
                return;
              }

              var tds = card.querySelectorAll('td.v[data-fid]');
              tds.forEach(function(td) {
                var fid = td.getAttribute("data-fid");
                if (!fid) return;

                var meta = resolveFieldMeta_(fid);
                var ftype = (meta && meta.type) ? String(meta.type).trim().toLowerCase() : "";
                var val = (STATE.row && STATE.row[fid] != null) ? STATE.row[fid] : "";

                td.innerHTML = "";
                var node = null;
                if (window.FieldsAPI && typeof FieldsAPI.renderCellByField === "function") {
                  node = FieldsAPI.renderCellByField({
                    fid: fid,
                    fieldId: fid,
                    val: val,
                    value: val,
                    row: STATE.row || {},
                    labels: STATE.labels || {},
                    entity: STATE.entity,
                    recordId: STATE.id,
                    rowId: STATE.id,
                    id: STATE.id,
                    type: ftype,
                    field: meta || null,
                    editable: !!(meta && meta.editable === true)
                  });
                }
                if (!node) node = document.createTextNode(val == null ? "" : String(val));
                td.appendChild(node);
              });

              if (window.FieldsAPI && typeof FieldsAPI.hydrateLinks === "function") {
                FieldsAPI.hydrateLinks(card, { entity: STATE.entity, row: STATE.row, labels: STATE.labels });
              }
            } catch (err) {
              console.error("[Detail] Card reload failed", err);
            }
          });

          act.appendChild(btnEdit); act.appendChild(btnDup); act.appendChild(btnFit); act.appendChild(btnReload);

          /* FIX: explicitly add card-remove class */
          var delBtn = document.createElement("button");
          delBtn.className = "btn btn-del card-remove";
          delBtn.type = "button";
          delBtn.title = "Delete card";
          delBtn.textContent = String.fromCharCode(215);
          delBtn.onmousedown = function(e) { e.stopPropagation(); };
          delBtn.addEventListener("click", function (e) {
            e.preventDefault(); e.stopPropagation();
            removeCard(def.key);
          });

          hd.appendChild(delBtn); hd.appendChild(ttl); hd.appendChild(act);
          card.appendChild(hd);

          var body = document.createElement("div");
          body.className = "cbody";

          if (type === "shotview") {
            var media = document.createElement("div");
            media.className = "media aspect";
            
            var inner = document.createElement("div");
            inner.className = "inner";
            inner.style.width = "100%";
            inner.style.height = "100%";
            
            renderShotViewContent(inner);
            
            media.appendChild(inner);
            body.appendChild(media);
          } else {
            var fields = Array.isArray(def.fields) ? def.fields.slice() : [];
            if (!fields.length && STATE && Array.isArray(STATE.ids) && STATE.ids.length) {
              fields = STATE.ids.slice(0, 40);
            }
            var table = document.createElement("table");
            table.className = "table";
            fields.forEach(function (fid) {
              if (!fid) return;
              var tr = document.createElement("tr");
              var label = (STATE && STATE.labels && STATE.labels[fid] && !_isFidLike_(STATE.labels[fid]))
                ? STATE.labels[fid]
                : ((resolveFieldMeta_(fid) && (resolveFieldMeta_(fid).label || resolveFieldMeta_(fid).name)) || (window.FieldsAPI && FieldsAPI.getLabel && FieldsAPI.getLabel(fid, STATE.entity)) || fid);
              var th = document.createElement("th"); 
              th.textContent = label;
              th.setAttribute("data-fid", fid);
              var resizer = document.createElement("div");
              resizer.className = "th-resizer";
              resizer.title = "Drag to resize column";
              resizer.addEventListener("mousedown", function(e) {
                  e.preventDefault(); e.stopPropagation();
                  var startX = e.pageX;
                  var startW = th.getBoundingClientRect().width;
                  function onMove(ev) {
                      var diff = ev.pageX - startX;
                      var newW = Math.max(50, startW + diff);
                      card.style.setProperty("--thwpx", newW + "px");
                  }
                  function onUp() {
                      window.removeEventListener("mousemove", onMove);
                      window.removeEventListener("mouseup", onUp);
                  }
                  window.addEventListener("mousemove", onMove);
                  window.addEventListener("mouseup", onUp);
              });
              th.appendChild(resizer);

              var td = document.createElement("td");
              td.className = "v";
              td.setAttribute("data-fid", fid);
              var meta = resolveFieldMeta_(fid);
              var ftype = meta && meta.type ? String(meta.type).trim().toLowerCase() : "";
              if (!ftype) {
                console.warn("[Detail] Missing Fields meta for fid=" + fid + " (type undefined).");
              }
              if (ftype) td.setAttribute("data-type", ftype);
              
              var val = "";
              if (STATE.row && typeof STATE.row[fid] !== 'undefined') {
                  val = STATE.row[fid];
              }
              
              var node = null;
              if (window.FieldsAPI && typeof FieldsAPI.renderCellByField === "function") {
                try {
                  node = FieldsAPI.renderCellByField({
                    fid: fid,
                    fieldId: fid,
                    val: val,
                    value: val,
                     row: STATE.row || {},
                     labels: STATE.labels || {},
                     entity: STATE.entity,
                     recordId: STATE.id,
                     rowId: STATE.id,
                     id: STATE.id,
                     type: ftype,
                     field: meta || null,
                     editable: !!(meta && meta.editable === true)
                   });
                 } catch (err) {
                  console.error("[Detail] renderCellByField error", err);
                  node = null;
                }
              }
              if (!node) {
                node = document.createTextNode(val == null ? "" : String(val));
              }
              td.appendChild(node);
              tr.appendChild(th); tr.appendChild(td);
              table.appendChild(tr);
            });
            body.appendChild(table);
          }
          card.appendChild(body);
          var rs = document.createElement("div"); rs.className = "resize"; card.appendChild(rs);
          enableDrag(card, hd); enableResize(card, rs);
          return card;
        }
        window.createCard = createCard;
      })();

      /* ===== 13.11 Drag / Resize / Fit ===== */
      function enableDrag(card, header) {
        header.addEventListener("mousedown", function (e) {
          if (!STATE.edit) return; e.preventDefault();
          var m = gridMetrics();
          STATE.drag.active = true; STATE.drag.mode = "move"; STATE.drag.card = card;
          STATE.drag.start = { x: +card.dataset.x, y: +card.dataset.y, w: +card.dataset.w, h: +card.dataset.h };
          STATE.drag.colW = m.colW; STATE.drag.rowStep = m.rowStep; STATE.drag.gridLeft = m.gridLeft; STATE.drag.gridTop = m.gridTop;
          var rect = card.getBoundingClientRect();
          var offX = e.pageX - (rect.left + window.scrollX);
          var offY = e.pageY - (rect.top + window.scrollY);
          
          function onMove(ev) {
            if (!STATE.drag.active || STATE.drag.mode !== "move") return;
            var gx = Math.max(0, (ev.pageX - STATE.drag.gridLeft) - offX);
            
            /* FIX: add -5px Y offset to avoid top sanctuary edge */
            var gy = Math.max(0, (ev.pageY - STATE.drag.gridTop) - offY - 5);
            
            var x = Math.round(gx / (STATE.drag.colW + m.gap));
            var y = Math.round(gy / STATE.drag.rowStep);
            
            x = Math.max(0, Math.min(m.cols - STATE.drag.start.w, x));
            var maxY = maxOccupiedY() + 200;
            y = Math.max(0, Math.min(maxY, y));
            applyXYWH(card, x, y, STATE.drag.start.w, STATE.drag.start.h);
          }
          
          function onUp() {
            if (!STATE.drag.active || STATE.drag.mode !== "move") return cleanup();
            
            /* FIX: recompute from dataset on commit and floor for stability */
            var finalX = Math.round(+card.dataset.x); 
            var finalY = Math.round(+card.dataset.y); 
            
            var pos = placeWithoutOverlap(card, finalX, finalY, +card.dataset.w, +card.dataset.h);
            applyXYWH(card, pos.x, pos.y, pos.w, pos.h); cleanup();
            lockCardHeaderHeights();
          }
          function cleanup() { STATE.drag.active = false; STATE.drag.mode = ""; STATE.drag.card = null; document.removeEventListener("mousemove", onMove); document.removeEventListener("mouseup", onUp); }
          document.addEventListener("mousemove", onMove); document.addEventListener("mouseup", onUp);
        });
      }
      function enableResize(card, handle) {
        handle.addEventListener("mousedown", function (e) {
          if (!STATE.edit) return; e.preventDefault();
          var m = gridMetrics();
          STATE.drag.active = true; STATE.drag.mode = "resize"; STATE.drag.card = card;
          STATE.drag.start = { x: +card.dataset.x, y: +card.dataset.y, w: +card.dataset.w, h: +card.dataset.h };
          STATE.drag.colW = m.colW; STATE.drag.rowStep = m.rowStep; STATE.drag.gridLeft = m.gridLeft; STATE.drag.gridTop = m.gridTop;
          function onMove(ev) {
            if (!STATE.drag.active || STATE.drag.mode !== "resize") return;
            var gx = Math.max(ev.pageX - STATE.drag.gridLeft, 0);
            var gy = Math.max(ev.pageY - STATE.drag.gridTop, 0);
            var endCol = Math.floor(gx / (STATE.drag.colW + m.gap));
            var endRow = Math.floor(gy / (STATE.drag.rowStep));
            var w = Math.max(1, endCol - STATE.drag.start.x + 1);
            var h = Math.max(10, endRow - STATE.drag.start.y + 1);
            w = Math.min(w, m.cols - STATE.drag.start.x);
            applyXYWH(card, STATE.drag.start.x, STATE.drag.start.y, w, h);
          }
          function onUp() {
            if (!STATE.drag.active || STATE.drag.mode !== "resize") return cleanup();
            var pos = placeWithoutOverlap(card, +card.dataset.x, +card.dataset.y, +card.dataset.w, +card.dataset.h);
            applyXYWH(card, pos.x, pos.y, pos.w, pos.h); cleanup();
            lockCardHeaderHeights();
          }
          function cleanup() { STATE.drag.active = false; STATE.drag.mode = ""; STATE.drag.card = null; document.removeEventListener("mousemove", onMove); document.removeEventListener("mouseup", onUp); }
          document.addEventListener("mousemove", onMove); document.addEventListener("mouseup", onUp);
        });
      }
      function autoFitHeight(card, strict) {
        var m = gridMetrics();
        
        if (card.dataset.type === "shotview") {
            var img = card.querySelector("img");
            var targetH = 0;
            
            if (img && img.naturalHeight) {
                var currentW = img.width || card.getBoundingClientRect().width;
                targetH = currentW * (img.naturalHeight / img.naturalWidth);
            }
            
            if (!targetH) {
                var widthPx = card.getBoundingClientRect().width;
                targetH = (widthPx * 9) / 16;
            }
            
            targetH += 28; 
            /* FIX: reduce padding calculation from +20px to +4px */
            var rows = Math.ceil( (targetH + m.gap + 4) / m.rowStep );
            rows = Math.max(4, rows);
            rows += 1;
            
            applyXYWH(card, +card.dataset.x, +card.dataset.y, +card.dataset.w, rows);
            lockCardHeaderHeights();
            return;
        }

        var body = card.querySelector(".cbody"); var header = card.querySelector(".card-header"); if (!body || !header) return;
        var content = body.firstElementChild;
        var csBody = getComputedStyle(body);
        var padBody = parseFloat(csBody.paddingTop || 0) + parseFloat(csBody.paddingBottom || 0);
        var csCard = getComputedStyle(card);
        var padCard = parseFloat(csCard.paddingTop || 0) + parseFloat(csCard.paddingBottom || 0);
        var extra = padBody + padCard;
        var contentHeight = 0;
        if (content) { contentHeight = Math.max(content.scrollHeight, content.offsetHeight); } else { contentHeight = body.scrollHeight; }
        /* FIX: reduce padding calculation from +20px to +4px */
        var needPx = (header.offsetHeight || 0) + contentHeight + extra + 4;
        
        var rows2 = Math.ceil( (needPx + m.gap) / m.rowStep );
        
        rows2 = Math.max(6, Math.min(rows2, 300));
        rows2 = Math.min(300, rows2 + 1);
        applyXYWH(card, +card.dataset.x, +card.dataset.y, +card.dataset.w, rows2);
        lockCardHeaderHeights();
      }

      /* ===== 13.13 Field Modal ===== */
      function bindFieldModal() {
        var c = $("#fieldCancel"), a = $("#fieldApply"), d = $("#v2-field-modal");
        if (!d) return;
        if (c) {
          var cNew = c.cloneNode(true); c.parentNode.replaceChild(cNew, c);
          cNew.onmousedown = function(e) { e.stopPropagation(); };
          cNew.onclick = function (e) { e.preventDefault(); e.stopPropagation(); closeModal("#v2-field-modal"); };
        }
        if (a) {
          var aNew = a.cloneNode(true); a.parentNode.replaceChild(aNew, a);
          aNew.onmousedown = function(e) { e.stopPropagation(); };
          aNew.onclick = function (e) {
             e.preventDefault(); e.stopPropagation();
             var key = $("#v2-field-modal").getAttribute("data-key") || "";
             var title = ($("#cardTitle") && $("#cardTitle").value || "").trim() || key;
             
             var def = STATE.layout.find(function (x) { return x.key === key; }); 
             if (def) { 
                 def.title = title; 
             }
             var card = $("#grid .card[data-key='" + key + "']"); 
             if (card) { 
                 var tDiv = card.querySelector(".card-title"); if(tDiv) tDiv.textContent = title;
             }
             if (def && def.type !== "shotview") {
                var selected = []; 
                document.querySelectorAll("#fieldList input[type=checkbox]:checked").forEach(function (cb) { selected.push(cb.value); });
                def.fields = selected;
                if (card) {
                  var body = card.querySelector(".cbody");
                  var oldTable = body.querySelector(".table"); if(oldTable) oldTable.remove();
                  var table = document.createElement("table"); table.className = "table"; body.prepend(table);
                  selected.forEach(function (fid) {
                    var tr = document.createElement("tr");
                    var label = (STATE.labels[fid]) || (window.FieldsAPI && FieldsAPI.getLabel && FieldsAPI.getLabel(fid, STATE.entity)) || fid;
                    var th = document.createElement("th"); th.textContent = label; th.setAttribute("data-fid", fid);

                    var resizer = document.createElement("div");
                    resizer.className = "th-resizer";
                    resizer.title = "Drag to resize column";
                    resizer.addEventListener("mousedown", function(e2) {
                        e2.preventDefault(); e2.stopPropagation();
                        var startX = e2.pageX;
                        var startW = th.offsetWidth;
                        function onMove(ev) {
                            var diff = ev.pageX - startX;
                            var newW = Math.max(50, startW + diff);
                            card.style.setProperty("--thwpx", newW + "px");
                        }
                        function onUp() {
                            window.removeEventListener("mousemove", onMove);
                            window.removeEventListener("mouseup", onUp);
                        }
                        window.addEventListener("mousemove", onMove);
                        window.addEventListener("mouseup", onUp);
                    });
                    th.appendChild(resizer);

                    var td = document.createElement("td"); td.className = "v"; td.setAttribute("data-fid", fid);
                    var meta = _resolveFieldMetaWithFallback_(fid);
                    var ftype = meta && meta.type ? String(meta.type).trim().toLowerCase() : "";
                    if (!ftype) {
                      console.warn("[Detail] Missing Fields meta for fid=" + fid + " (type undefined).");
                    }
                    if (ftype) td.setAttribute("data-type", ftype);
                    var val = (STATE.row && STATE.row[fid]) ? STATE.row[fid] : "";
                    var node = null;
                    if (window.FieldsAPI && typeof FieldsAPI.renderCellByField === "function") {
                         try {
                           node = FieldsAPI.renderCellByField({
                             fid: fid,
                             fieldId: fid,
                             val: val,
                             value: val,
                              row: STATE.row || {},
                              labels: STATE.labels || {},
                              entity: STATE.entity,
                              recordId: STATE.id,
                              rowId: STATE.id,
                              id: STATE.id,
                              type: ftype,
                              field: meta || null,
                              editable: !!(meta && meta.editable === true)
                            });
                          } catch (err) {
                           console.error("[Detail] renderCellByField error", err);
                           node = null;
                         }
                    }
                    if (!node) {
                         node = document.createTextNode(val == null ? "" : String(val));
                    }
                    td.appendChild(node); tr.appendChild(th); tr.appendChild(td); table.appendChild(tr);
                  });
                  requestAnimationFrame(function () { autoFitHeight(card, true); });
                }
             }
             closeModal("#v2-field-modal");
          };
        }
      }
      function openCardSettings(cardKey) {
        if (!STATE.edit) return;
        var def = STATE.layout.find(function (x) { return x.key === cardKey; }); if (!def) return;
        $("#v2-field-modal").setAttribute("data-key", cardKey);
        var titleEl = $("#cardTitle"); if (titleEl) titleEl.value = def.title || def.key;
        
        var list = $("#fieldList"); if (list) {
          list.innerHTML = "";
          if (def.type === "shotview") {
            var p = document.createElement("div"); p.className = "notice"; p.textContent = "Shotview cards cannot be edited here"; list.appendChild(p);
          } else {
            var sel = new Set((def.fields || []));
            (STATE.ids || Object.keys(STATE.labels)).forEach(function (fid) {
              if (!_isFidLike_(fid)) return;
              var row = document.createElement("div"); row.className = "field-row";
              var cb = document.createElement("input"); cb.type = "checkbox"; cb.value = fid; cb.checked = sel.has(fid);
              var lab = document.createElement("label"); lab.textContent = (STATE.labels[fid]) || (window.FieldsAPI && FieldsAPI.getLabel && FieldsAPI.getLabel(fid, STATE.entity)) || fid;
              row.appendChild(cb); row.appendChild(lab); list.appendChild(row);
            });
          }
        }
        openModal("#v2-field-modal");
      }

      /* ===== 13.14 Prev/Next ===== */
      function safeIdAt(i) {
        if (!Array.isArray(STATE.rows) || i < 0 || i >= STATE.rows.length) return "";
        var idx = STATE.idxId >= 0 ? STATE.idxId : 0;
        var v = STATE.rows[i] && STATE.rows[i][idx];
        return v == null ? "" : String(v);
      }
      function navigate(entity, id) {
        if (!id) return;
        var href = Router.buildEntityUrl(entity || "shot", id);
        try { (window.top || window).location.assign(href); }
        catch (_) { (window.top || window).location.href = href; }
      }
      function setupPrevNext() {
        var prevBtn = $("#prev"), nextBtn = $("#next");
        var total = Array.isArray(STATE.rows) ? STATE.rows.length : 0;
        var pos = Math.min(Math.max(STATE.pos | 0, 0), Math.max(total - 1, 0));
        var prev = (pos > 0) ? pos - 1 : -1, next = (pos < total - 1) ? pos + 1 : -1;
        if (prevBtn) { prevBtn.disabled = prev < 0; prevBtn.onclick = function () { var id = safeIdAt(prev); if (id) navigate(STATE.entity, id); }; }
        if (nextBtn) { nextBtn.disabled = next < 0; nextBtn.onclick = function () { var id = safeIdAt(next); if (id) navigate(STATE.entity, id); }; }
      }

      /* ===== 13.15 Apply index ===== */
      function applyIndex(index, pushUrl) {
        STATE.pos = index;
        var row = STATE.rows[index], map = {}, labels = {};
        if (row && Array.isArray(STATE.ids)) {
          for (var i = 0; i < STATE.ids.length; i++) map[STATE.ids[i]] = row[i];
          for (var j = 0; j < STATE.ids.length; j++) {
            var fid = STATE.ids[j];
            var label = String(STATE.header[j] || fid || "");
            labels[fid] = label;
            if (label) {
              if (map[label] == null) map[label] = row[j];
              var lower = label.toLowerCase();
              if (lower && map[lower] == null) map[lower] = row[j];
            }
          }
        }
        STATE.row = map; STATE.labels = labels;
        ensurePageKey();
        var recordTitle = deriveRecordTitle() || defaultDetailTitle();
        var detailTitle = defaultDetailTitle();
        var t = $("#title"); if (t) t.textContent = recordTitle;
        var f = $("#footerPage"); if (f) f.textContent = detailTitle;
        /* FIX: include entity name in page title */
        if (typeof document !== 'undefined' && document.title) { 
            var entLabel = capitalize(STATE.entity || "Detail");
            document.title = entLabel + ' | ' + recordTitle; 
        }
        setupPrevNext();
        if (STATE.layout && STATE.layout.length) buildFromLayout();
        ensureToolbarVisible();
        refreshHorizontalScroll();
        if (pushUrl) {
          var qs = new URLSearchParams(location.search);
          qs.set('page', currentPageKey());
          qs.set('entity', STATE.entity || 'shot');
          var recordId = '';
          if (STATE.row) {
            var rid = resolveRecordIdFromRow_(STATE.row);
            if (rid) recordId = rid;
            else if (STATE.idxId >= 0 && Array.isArray(STATE.ids) && STATE.ids[STATE.idxId]) {
               var idxKey = STATE.ids[STATE.idxId];
               if (idxKey && STATE.row[idxKey] != null) recordId = STATE.row[idxKey];
            }
          }
          if (recordId) qs.set('id', recordId); else qs.delete('id');
          history.replaceState(null, '', location.pathname + "?" + qs.toString());
        }
        prefetchProxyIndex();
      }

      /* ===== 13.16 Linkify (strict) ===== */
      function linkifyLinksStrict(scope) {
        var root = scope || document;
        var rows = root.querySelectorAll('.table tr, .field-row, .kv-row, .fields-grid');
        rows.forEach(function (row) {
          var k = row.querySelector('.k') || row.querySelector('th');
          var v = row.querySelector('.v') || row.querySelector('td');
          if (!k || !v) return;
          var ftype = (v.getAttribute('data-type') || "").toLowerCase();
          if (ftype === "id" || ftype === "entity_link" || ftype === "originals") return;
          if (v.querySelector('a')) return;
          var raw = (v.textContent || "").trim();
          if (/^https?:\/\//i.test(raw)) {
            var a = document.createElement('a'); a.href = raw; a.target = '_blank'; a.rel = 'noopener'; a.textContent = raw; a.className = 'chip';
            v.textContent = ""; v.appendChild(a);
          }
        });
        var originalsCells = root.querySelectorAll('td[data-type="originals"]');
        originalsCells.forEach(function (cell) {
          var link = cell.querySelector('a');
          if (link && link.href && !link.target) {
            link.target = '_blank'; link.rel = 'noopener';
            var originalText = link.textContent;
            link.textContent = 'Loading Originals...';
            setTimeout(function () { if (link.textContent === 'Loading Originals...') { link.textContent = originalText || 'Open Originals'; } }, 1000);
          }
        });
      }
      
      /* ===== 13.17 Init / Error ===== */
      function showError(msg) {
        console.error("[Detail] " + msg);
        var box = document.getElementById("error");
        if (!box) return;
        box.textContent = msg; box.style.display = "block";
      }

      async function init() {
        initModalHandlers();
        installHardNavForInternalLinks();
        setLoading(true);
        detailBootStart = (window.performance && typeof performance.now === "function") ? performance.now() : Date.now();
        bootDiagSetFallback_({ attempted: false, used: false, blocked: false, reason: "" });
        markDetailTiming_("detail_boot_start_ms");
        
        var viewCtx = window.__VIEW_CTX__ || window.viewCtx || {}; window.__VIEW_CTX__ = viewCtx;
        var root = document.querySelector(".detail-page"); if (!root) return;
        var query = new URLSearchParams(window.location.search || "");
        var entityKey = query.get("entity") || root.getAttribute("data-nav-entity") || (viewCtx && viewCtx.entity) || "shot";
        entityKey = String(entityKey || "shot").toLowerCase();
        var pageHint = query.get("page") || root.getAttribute("data-nav-page") || "DetailShot";
        STATE.entity = entityKey; STATE.pageKey = pageHint;
        var recordId = query.get("id") || root.getAttribute("data-record-id") || root.getAttribute("data-id") || "";
        if (recordId) { STATE.id = recordId; }
        bootDiagUpdateContext_({
          view: "detail",
          normalizedEntity: entityKey,
          pageKey: pageHint,
          recordId: recordId
        });
        markDetailTiming_("detail_context_resolved_ms");
        
        var entStrict = singularEntityFor(entityKey);
        var entLabel = pluralEntityFor(entStrict);
        STATE.sheet = entLabel;
        bootDiagUpdateContext_({ normalizedEntity: entStrict });

        var payload = { entity: entLabel, sheet: entLabel, entityPlural: entLabel, sheetName: entStrict, pageType: "detail", offset: 0, limit: 2000, sort: [], filterGroups: [], groupCombine: "all", allowHubFilters: true };
        var resp;
        markDetailTiming_("detail_rows_request_ms");
        // Prefer legacy listRowsPage (entity sheet) so link fields stay populated.
        try { resp = await tryCall(["sv_listRowsPage", "sv_listRowsPage_v3", "listRowsPage"], payload); } catch (err) { showError("Failed to load rows: " + err); }
        markDetailTiming_("detail_rows_received_ms");

        var norm = normalizeRowsPayload(resp);
        STATE.ids = norm.ids;
        STATE.header = norm.header;
        STATE.rows = norm.rows;
        STATE.columns = norm.columns || [];
        
        STATE.fieldsMeta = {};
        if (STATE.columns && STATE.columns.length) {
            STATE.columns.forEach(function(c) {
                var fid = c.id || c.field_id;
                if(fid) STATE.fieldsMeta[fid] = c;
            });
        }
        try {
          if (window.FieldsAPI && typeof FieldsAPI.ensureAppDataLoaded === "function") {
            await FieldsAPI.ensureAppDataLoaded("detail:start");
          }
        } catch (_) {}
        markDetailTiming_("detail_fields_meta_ready_ms");
        
        var idFid = resolveIdFid_();
        STATE.idxId = Math.max(0, (STATE.ids || []).indexOf(idFid));
        var pos = 0; var targetId = STATE.id;
        if (targetId && STATE.rows.length) {
          pos = STATE.rows.findIndex(function (r) { if (!r) return false; var v = r[STATE.idxId]; return v === targetId; });
          if (pos < 0) { pos = STATE.rows.findIndex(function (r) { if (!r || !r.indexOf) return false; return r.indexOf(targetId) !== -1; }); }
        }
        if (pos < 0) pos = 0;
        if (!targetId && STATE.rows[0] && STATE.idxId >= 0) {
          var firstId = STATE.rows[0][STATE.idxId];
          if (firstId != null) { STATE.id = String(firstId); }
        }

        applyIndex(pos, !!window.location.search);

        window.setTimeout(function () {
          (async function () {
            try {
              await loadPresets();
              // Canonical URL policy: ignore any `pid` query param and load the default preset only.
              if (STATE.presets && STATE.presets.length > 0) {
                  await loadLayoutAndApply(STATE.presets[0].id);
              } else {
                  showError("No detail layouts found for entity=" + String(STATE.entity || ""));
              }

              // Canonicalize URL: remove `pid` if present.
              try {
                var u = new URL(window.location.href);
                if (u.searchParams.has("pid")) {
                  u.searchParams.delete("pid");
                  history.replaceState(null, "", u.toString());
                }
              } catch (e) {}
              var grid = document.getElementById("grid");
              var cardCount = grid ? grid.querySelectorAll(".card").length : 0;
              if (!grid || cardCount === 0) {
              }
            } catch (err) {}
            markDetailTiming_("detail_render_ms");
            setLoading(false);
          })();
        }, 0);
      }

      /* ===== 13.18 Inline Edit Feature ===== */
      (function() {
        var grid = document.getElementById("grid"); if (!grid) return;
        grid.addEventListener("dblclick", function(e) {
          var target = e.target;
          var cell = target.closest("td.v"); if (!cell) return;
          
          // Inline edit entrypoint.
          // Inline editing (Fields-sheet-driven).
          
          // Guard: do not start a second editor instance.
          if (cell.querySelector("input, select, textarea")) return;
          var fid = cell.getAttribute("data-fid");
          if (!fid) return;
          var idFid = resolveIdFid_();
          if (idFid && fid === idFid) { showStatus("Read only", true); return; }

          var meta = _resolveFieldMetaWithFallback_(fid);
          var ftype = meta && meta.type ? String(meta.type).trim().toLowerCase() : "";
          if (!ftype) {
            showStatus("Missing Fields meta for fid=" + fid + " (type undefined).", true);
            return;
          }

          var editable = !!(meta && meta.editable === true);
          if (ftype === "id" || ftype === "originals") editable = false;
          if (!editable) {
            showStatus("Read only", true);
            return;
          }

          makeEditable(cell, fid, ftype, meta);
        });

        function renderAllDetailCellsForFid(fid, meta, value, linkEntity) {
          if (!(window.FieldsAPI && typeof FieldsAPI.renderCellByField === "function")) return;
          var f = String(fid || "");
          if (!f) return;
          var nodes = document.querySelectorAll('td.v[data-fid="' + f + '"]');
          for (var i = 0; i < nodes.length; i++) {
            var td = nodes[i];
            try {
              td.innerHTML = "";
              td.appendChild(FieldsAPI.renderCellByField({
                fid: f,
                fieldId: f,
                val: value,
                row: STATE.row || {},
                labels: STATE.labels || {},
                entity: STATE.entity,
                recordId: STATE.id,
                rowId: STATE.id,
                id: STATE.id,
                type: (meta && meta.type) ? String(meta.type).trim().toLowerCase() : "",
                linkEntity: linkEntity || null,
                field: meta || null,
                editable: false
              }));
            } catch (_) { }
          }
        }

        function makeEditable(cell, fid, ftype, meta) {
          var originalRaw = (STATE.row && STATE.row[fid] != null) ? STATE.row[fid] : cell.textContent.trim();
          var originalValue = (originalRaw == null) ? "" : String(originalRaw).trim();
          var originalHtml = cell.innerHTML;
          var t = String(ftype || "").trim().toLowerCase();
          var didChange = false;

          // Link fields are edited via picker modal (no direct id typing).
          if (t === "entity_link" || /_link$/.test(t)) {
            if (!(window.FieldsAPI && typeof FieldsAPI.openLinkPicker === "function")) {
              showStatus("Link picker unavailable", true);
              return;
            }

            var entity = singularEntityFor(STATE.entity) || STATE.entity || "shot";
            var id = STATE.id || resolveRecordIdFromRow_(STATE.row) || "";
            if (!id) { showStatus("Error: No ID found", true); return; }

            FieldsAPI.openLinkPicker({ fid: fid, type: t, value: originalRaw }).then(function (out) {
              if (!out || out.cancelled) return;

              var prev = (STATE.row && STATE.row[fid] != null) ? STATE.row[fid] : "";
              var prevVal = prev;
              var nextVal = out.value;
              var linkEnt = out.targetEntity || null;

              if (STATE.row) STATE.row[fid] = nextVal;
              renderAllDetailCellsForFid(fid, meta, nextVal, linkEnt);
              showStatus("Saving...");

              dv2_queueFieldWrite(entity, id, fid, nextVal,
                function (confirmedVal, _res) {
                  try {
                    if (typeof STATE === 'object' && STATE && STATE.row) STATE.row[fid] = confirmedVal;
                  } catch (_e) {}
                  try {
                    renderAllDetailCellsForFid(fid, meta, confirmedVal, linkEnt);
                  } catch (_e) {}
                  try { if (typeof showStatus === 'function') showStatus('Updated!'); } catch (_e) {}
                },
                function (rollbackVal, err) {
                  var msg = (err && (err.message || err)) ? String(err.message || err) : 'unknown error';
                  try { if (typeof showError === 'function') showError('Update Failed: ' + msg); } catch (_e) {}

                  // Revert to last confirmed value when available, else keep previous value
                  var v = (rollbackVal !== undefined) ? rollbackVal : prevVal;
                  try {
                    if (typeof STATE === 'object' && STATE && STATE.row) STATE.row[fid] = v;
                  } catch (_e) {}
                  try {
                    renderAllDetailCellsForFid(fid, meta, v, linkEnt);
                  } catch (_e) {}
                  try { if (typeof showStatus === 'function') showStatus('Update Failed'); } catch (_e) {}
                }
              );
            });
            return;
          }
          var input;

          if (t === "select") {
            input = document.createElement("select");
            input.className = "motk-inline-editor";
            var opts = (meta && meta.options) ? meta.options : [];
            if (!Array.isArray(opts)) opts = String(opts || "").split(/[\n\r|,]+/);
            opts = opts.map(function (x) { return String(x == null ? "" : x).trim(); }).filter(Boolean);
            if (!opts.length) {
              showStatus("Select options missing", true);
              cell.innerHTML = originalHtml;
              return;
            }
            if (!meta || meta.required !== true) opts.unshift("");
            if (opts.indexOf(originalValue) === -1 && originalValue) opts.unshift(originalValue);
            opts.forEach(function (v) {
              var o = document.createElement("option");
              o.value = v; o.textContent = v;
              input.appendChild(o);
            });
            input.value = originalValue;
            input.addEventListener("change", function () { didChange = true; });
          } else if (t === "date") {
            input = document.createElement("input");
            input.type = "date";
            input.className = "motk-inline-editor";
            input.value = (window.FieldsAPI && typeof FieldsAPI.normalizeDateValue === "function")
              ? FieldsAPI.normalizeDateValue(originalValue)
              : (function () {
                var dt = new Date(originalValue);
                if (isNaN(dt.getTime())) return "";
                var yyyy = String(dt.getFullYear());
                var mm = ("0" + (dt.getMonth() + 1)).slice(-2);
                var dd = ("0" + dt.getDate()).slice(-2);
                return yyyy + "-" + mm + "-" + dd;
              })();
          } else if (t === "checkbox") {
            input = document.createElement("input");
            input.type = "checkbox";
            input.checked = (originalRaw === true) || (/^(true|yes|on|1)$/i.test(String(originalValue || "")));
          } else if (t === "json") {
            input = document.createElement("textarea");
            input.className = "motk-inline-editor motk-inline-textarea";
            input.value = originalValue;
          } else {
            input = document.createElement("input");
            input.className = "motk-inline-editor";
            input.type = "text"; input.value = originalValue;
          }

          cell.innerHTML = ""; cell.appendChild(input); try { input.focus(); } catch (_) {}

          function save() {
            if (t === "select" && !didChange) { cell.innerHTML = originalHtml; return; }
            var newValue;
            if (t === "checkbox") {
              newValue = !!input.checked;
              var origBool = (originalRaw === true) || (/^(true|yes|on|1)$/i.test(String(originalValue || "")));
              if (newValue === origBool) { cell.innerHTML = originalHtml; return; }
              cell.textContent = newValue ? "TRUE" : "FALSE";
              if (STATE.row) STATE.row[fid] = newValue;
            } else {
              newValue = String(input.value == null ? "" : input.value).trim();
              if (newValue === originalValue) { cell.innerHTML = originalHtml; return; }
              cell.textContent = newValue;
              if (STATE.row) STATE.row[fid] = newValue;
            }
            showStatus("Updating...");

            var entity = singularEntityFor(STATE.entity) || STATE.entity || "shot";

            var id = STATE.id || resolveRecordIdFromRow_(STATE.row);
            if (!id) {
                showStatus("Error: No ID found", true);
                cell.innerHTML = originalHtml;
                if (STATE.row) STATE.row[fid] = originalRaw;
                return;
            }

            var patch = {};
            patch[fid] = newValue;

            if (!(window.google && google.script && google.script.run)) {
              showStatus("Update Failed: google.script.run unavailable", true);
              cell.innerHTML = originalHtml;
              if (STATE.row) STATE.row[fid] = originalRaw;
              return;
            }

            var nextVal = newValue;
            dv2_queueFieldWrite(entity, id, fid, nextVal,
              function (confirmedVal, _res) {
                try { if (STATE && STATE.row) STATE.row[fid] = confirmedVal; } catch (_e) {}
                try { renderAllDetailCellsForFid(fid, meta, confirmedVal, null); } catch (_e) {}
                try { if (typeof showStatus === 'function') showStatus('Updated!'); } catch (_e) {}
              },
              function (rollbackVal, err) {
                var msg = (err && (err.message || err)) ? String(err.message || err) : 'unknown error';
                try { if (typeof showError === 'function') showError('Update Failed: ' + msg); } catch (_e) {}

                var v = (rollbackVal !== undefined) ? rollbackVal : originalRaw;
                try { if (STATE && STATE.row) STATE.row[fid] = v; } catch (_e) {}
                try { renderAllDetailCellsForFid(fid, meta, v, null); } catch (_e) {}
                try { if (typeof showStatus === 'function') showStatus('Update Failed'); } catch (_e) {}
              }
            );
          }
          input.addEventListener("blur", save);
          input.addEventListener("keydown", function(e) {
            if (e.key === "Enter" && t !== "json") { input.blur(); }
            else if (e.key === "Escape") { cell.innerHTML = originalHtml; if (STATE.row) STATE.row[fid] = originalRaw; }
          });
        }
      })();

      document.addEventListener("DOMContentLoaded", function () {
        try {
          bindToolbar(); bindSaveUI(); bindSaveModal(); bindCardsModal(); bindFieldModal();
          ensureToolbarVisible(); refreshHorizontalScroll();
        } catch (e) { console.error("[Detail] toolbar / UI binding error", e); }
        init().catch(function (err) { showError(err && err.message ? err.message : String(err)); });
      });

    })();
  </script>
</body>
</html>
