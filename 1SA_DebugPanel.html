<!DOCTYPE html>
<html>

<head>
  <title>Debug Panel</title>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .card {
      border: 1px solid #ccc;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }

    .card h3 {
      margin-top: 0;
    }

    .btn {
      background: #007bff;
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .btn:hover {
      background: #0056b3;
    }

    .loading {
      color: #888;
    }

    .error {
      color: red;
    }

    .success {
      color: green;
    }

    pre {
      background: #f8f9fa;
      padding: 10px;
      overflow: auto;
    }

    a {
      color: #007bff;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <h1>Debug Panel</h1>

  <button class="btn" onclick="runAllChecks()">Run all checks</button>
  <button class="btn" onclick="copyPageText()">Copy page text</button>
  <div id="run-status" class="muted">idle</div>

  <div id="console" class="card">
    <h3>Console (live)</h3>
    <pre id="console-log"></pre>
  </div>

  <div id="runtime" class="card">
    <h3>Runtime</h3>
    <div id="gsr-status">Checking google.script.run...</div>
    <div id="server-ping">Server ping: <span class="loading">Loading...</span></div>
    <div id="location">Location: <span class="loading">Loading...</span></div>
    <div id="url-params">URL Params: <span class="loading">Loading...</span></div>
  </div>

  <div id="viewer-state" class="card">
    <h3>Viewer State (window.opener)</h3>
    <div id="viewer-state-status" class="muted">capturing…</div>
    <pre id="viewer-state-json">{}</pre>
  </div>

  <div id="data-maps" class="card">
    <h3>Data maps / Page</h3>
    <div id="field-types">FIELD_TYPES: <span class="loading">Loading...</span></div>
    <div id="link-maps-counts">LINK_MAPS（counts）: <span class="loading">Loading...</span></div>
    <div id="layout-presets">Layout presets(DetailShot): <span class="loading">Loading...</span></div>
  </div>

  <div id="fieldtypes-diag" class="card">
    <h3>FieldTypes diagnostics（entity_name fid 検出）</h3>
    <div id="shot-fid">shot: <span class="loading">Loading...</span></div>
    <div id="asset-fid">asset: <span class="loading">Loading...</span></div>
    <div id="task-fid">task: <span class="loading">Loading...</span></div>
    <div id="member-fid">member: <span class="loading">Loading...</span></div>
    <div id="user-fid">user: <span class="loading">Loading...</span></div>
    <div id="fid-log">log: <span class="loading">Loading...</span></div>
  </div>

  <div id="originals-resolver" class="card">
    <h3>Originals resolver</h3>
    <div id="resolver-context">Context: <span class="loading">Loading...</span></div>
    <div id="expected-policy">Expected (policy): <span class="loading">Loading...</span></div>
    <div id="resolve-result">Resolve result: <span class="loading">Loading...</span></div>
    <div id="originals-url">originals_root_url: <span class="loading">Loading...</span></div>
    <div id="proxies-url">proxies_root_url: <span class="loading">Loading...</span></div>
  </div>

  <div id="entity-samples" class="card">
    <h3>Entity samples（id & name + source）</h3>
    <div id="shot-sample">shot: <span class="loading">Loading...</span></div>
    <div id="asset-sample">asset: <span class="loading">Loading...</span></div>
    <div id="task-sample">task: <span class="loading">Loading...</span></div>
    <div id="member-sample">member: <span class="loading">Loading...</span></div>
    <div id="user-sample">user: <span class="loading">Loading...</span></div>
    <div id="page-sample">page: <span class="loading">Loading...</span></div>
  </div>

  <div id="originals-diag" class="card">
    <h3>Originals diagnostics</h3>
    <div id="input">Input: <span class="loading">Loading...</span></div>
    <div id="drivebuilder">DriveBuilder: <span class="loading">Loading...</span></div>
    <div id="serverapis">ServerAPIs: <span class="loading">Loading...</span></div>
    <div id="projectmetaroot">ProjectMetaRoot: <span class="loading">Loading...</span></div>
    <div id="final-url">Final URL: <span class="loading">Loading...</span></div>
    <div id="raw-trace">Raw trace: <span class="loading">Loading...</span></div>
  </div>

  <div id="link-replacer" class="card">
    <h3>Link replacer diagnostics</h3>
    <div id="router-detected">Router detected: <span class="loading">Loading...</span></div>
    <div id="anchors-replaced">gNav anchors replaced: <span class="loading">Loading...</span></div>
    <div id="sample-diff">Sample diff（first 3）: <span class="loading">Loading...</span></div>
    <div id="dry-run-task">Dry-run TASK link: <span class="loading">Loading...</span></div>
    <div>This card never mutates DOM.</div>
  </div>

  <div id="raw-snapshot" class="card">
    <h3>Raw snapshot</h3>
    <pre id="raw-snap"></pre>
  </div>

  <script>
    let consoleLog = [];
    let globalRes = {};  // 共有結果格納
    function log(msg) {
      consoleLog.push(new Date().toISOString() + ' INFO ' + msg);
      document.getElementById('console-log').innerHTML = consoleLog.slice(-20).join('\n');  // 最新20行
      console.info(msg);
    }

    function logInfo(msg) {
      consoleLog.push(new Date().toISOString() + ' INFO ' + msg);
      document.getElementById('console-log').innerHTML = consoleLog.slice(-20).join('\n');  // 最新20行
      console.info(msg);
    }

    function logWarn(msg) {
      consoleLog.push(new Date().toISOString() + ' WARN ' + msg);
      document.getElementById('console-log').innerHTML = consoleLog.slice(-20).join('\n');  // 最新20行
      console.warn(msg);
    }

    function updateElement(id, text) {
      const el = document.getElementById(id);
      if (el) el.innerHTML = text || 'N/A';
    }

    function updateFromRes(res) {
      if (!res) return;
      globalRes = { ...globalRes, ...res };
      // Data maps
      updateElement('field-types', JSON.stringify(res.fieldTypes || {}) || 'empty');
      updateElement('link-maps-counts', JSON.stringify(res.counts || {}) || 'empty');
      updateElement('layout-presets', (res.presets || []).length ? JSON.stringify(res.presets) : 'no presets');
      // FieldTypes diag - labelベースでrole|name|codeマッチ (拡張)
      const ft = res.fieldTypes || {};
      const getNameFid = (entity) => {
        const fields = ft[entity] || {};
        const nameFid = Object.keys(fields).find(fid => fields[fid].label.match(/role|name|code/i));
        return nameFid ? nameFid : '(no name fid)';
      };
      updateElement('shot-fid', 'shot: ' + getNameFid('shot'));
      updateElement('asset-fid', 'asset: ' + getNameFid('asset'));
      updateElement('task-fid', 'task: ' + getNameFid('task'));
      updateElement('member-fid', 'member: ' + getNameFid('member'));
      updateElement('user-fid', 'user: ' + getNameFid('user'));
      updateElement('fid-log', 'log: shot:' + Object.keys(ft.shot || {}).length + '- asset:' + Object.keys(ft.asset || {}).length + '- task:' + Object.keys(ft.task || {}).length + '- member:' + Object.keys(ft.member || {}).length + '- user:' + Object.keys(ft.user || {}).length + '-');
      // Entity samples
      const lm = res.linkMaps || {};
      updateElement('shot-sample', JSON.stringify(lm.shots || {}) || 'empty');
      updateElement('asset-sample', JSON.stringify(lm.assets || {}) || 'empty');
      updateElement('task-sample', JSON.stringify(lm.tasks || {}) || 'empty');
      updateElement('member-sample', JSON.stringify(lm.members || {}) || 'empty');
      updateElement('user-sample', JSON.stringify(lm.users || {}) || 'empty');
      updateElement('page-sample', 'n/a');
      // Originals resolver - trace.finalUrl使用
      updateElement('resolver-context', JSON.stringify({ entity: 'shot', id: 'sh_0001' }));
      updateElement('expected-policy', 'root / 01shots / sh_0001__ 201A open Drive search originals_root_url ' + (res.meta.originals_root_url ? 'set' : 'not set'));
      var originalsUrl = globalRes.trace ? globalRes.trace.finalUrl : res.originalsUrl;
      var resolveText = originalsUrl ? '<span class="success">found: <a href="' + originalsUrl + '" target="_blank" rel="noopener">Open Folder</a></span>' : '(Originals not found)';
      updateElement('resolve-result', resolveText);
      updateElement('originals-url', res.meta.originals_root_url ? '<a href="' + res.meta.originals_root_url + '" target="_blank" rel="noopener">' + res.meta.originals_root_url + '</a>' : '(not set)');
      updateElement('proxies-url', res.meta.proxies_root_url ? '<a href="' + res.meta.proxies_root_url + '" target="_blank" rel="noopener">' + res.meta.proxies_root_url + '</a>' : '(not set)');
      // Originals diag
      const trace = globalRes.trace || {};
      updateElement('input', JSON.stringify(trace.input || {}));
      updateElement('drivebuilder', JSON.stringify(trace.steps?.find(s => s.name === 'DriveBuilder') || 'not found'));
      updateElement('serverapis', JSON.stringify(trace.steps?.find(s => s.name === 'ServerAPIs') || 'not found'));
      updateElement('projectmetaroot', JSON.stringify(trace.steps?.find(s => s.name === 'ProjectMetaRoot') || 'not found'));
      var finalText = trace.finalUrl ? '<span class="success"><a href="' + trace.finalUrl + '" target="_blank" rel="noopener">' + trace.finalUrl + '</a></span>' : 'fallback root (NOT resolved to leaf). expected deeper: 01shots / sh_0001__ 201A';
      updateElement('final-url', finalText);
      updateElement('raw-trace', JSON.stringify(trace, null, 2));
      // Link replacer (static sim for now)
      updateElement('router-detected', 'no');
      updateElement('anchors-replaced', '3 / 3');
      updateElement('sample-diff', '[1] page: Dashboard before: - target: (none) after: [URL]?page=Dashboard target: _top [2] page: Settings ... [3] page: DebugPanelPage ...');
      updateElement('dry-run-task', JSON.stringify({ ent: 'task', id: 'ta_0001', final: res.taskLink || '' }));
      // Raw snapshot update
      const snap = {
        href: window.location.href,
        params: getUrlParams(),
        gsr: !!google.script.run,
        fieldTypesKeys: Object.keys(ft).reduce((acc, e) => acc + Object.keys(ft[e] || {}).length, 0),
        linkMapsCounts: res.counts || { assets: 0, shots: 0, tasks: 0, users: 0, members: 0 },
        originalsUrl: originalsUrl || null,
        ts: Date.now()
      };
      document.getElementById('raw-snap').innerHTML = JSON.stringify(snap, null, 2);
    }

    function setRunStatus(text, isError) {
      var el = document.getElementById('run-status');
      if (!el) return;
      el.innerHTML = isError ? ('<span class="error">' + text + '</span>') : text;
    }

    async function runAllChecks() {
      log('Run all checks: begin');
      setRunStatus('running…');
      renderEntitySamples();
      try {
        await Promise.all([
          checkRuntimeAsync(),
          loadAppDataAsync(),
          checkOriginalsAsync()
        ]);
        checkTableInlineEdit();
        runTableTake18Checks_();
        log('Run all checks: done');
        setRunStatus('completed at ' + new Date().toLocaleTimeString());
      } catch (err) {
        log('Run all checks: error ' + err);
        setRunStatus('error: ' + err, true);
      }
    }

    function checkRuntimeAsync() {
      log('checkRuntime: start');
      updateElement('gsr-status', google.script.run ? 'available' : 'unavailable');
      const loc = document.getElementById('location');
      loc.innerHTML = 'Location: ' + window.location.href;
      updateElement('url-params', JSON.stringify(getUrlParams()));
      return new Promise(function (resolve) {
        google.script.run.withSuccessHandler(function (res) {
          updateElement('server-ping', 'ok ts=' + res.ts);
          log('checkRuntime: ping ok ' + res.ts);
          resolve();
        }).withFailureHandler(function (err) {
          updateElement('server-ping', '<span class="error">failed: ' + err + '</span>');
          resolve();
        }).dp_debugPing();
      });
    }

    function checkTableInlineEdit() {
      logInfo("checkTableInlineEdit: start");
      try {
        var op = window.opener;
        if (!op) {
          logWarn("checkTableInlineEdit: no window.opener");
          return;
        }
        var sig = op.__MOTK_TABLE_INLINE_EDIT_IMPL__ || null;
        if (!sig) {
          logWarn("checkTableInlineEdit: missing __MOTK_TABLE_INLINE_EDIT_IMPL__");
          return;
        }
        logInfo("checkTableInlineEdit: ok " + JSON.stringify(sig));
      } catch (e) {
        logWarn("checkTableInlineEdit error: " + String(e && e.message ? e.message : e));
      }
    }

    function runTableTake18Checks_() {
      var ctx = checkOpenerContext();
      if (!ctx) return;
      checkTableRendererWiring(ctx);
      checkTableQuickSearch(ctx);
      checkShotviewRender(ctx);
      checkFieldsMetaCompleteness(ctx);
      checkDateFormatHealth(ctx);
      checkSelectOptionsAvailability(ctx);
      checkSelectOptionsHydrated(ctx);
      checkLinkRenderingConsistency(ctx);
      checkOriginalsRendering(ctx);
      checkOriginalsNotFoundRate(ctx);
      checkOriginalsLazyResolve(ctx);
      checkInlineEditSignature(ctx);
      checkRenderPerfGuard(ctx);
      checkEditorThemeParity(ctx);
      checkVersionsPreviewHealth(ctx);
    }

    function checkOpenerContext() {
      logInfo("checkOpenerContext: start");
      try {
        var op = window.opener;
        if (!op) {
          logInfo("checkOpenerContext: SKIP (no Table context)");
          return null;
        }
        var doc = op.document;
        if (!doc || !doc.querySelector) {
          logInfo("checkOpenerContext: SKIP (no Table context)");
          return null;
        }
        var wrap = doc.querySelector("#tableWrap");
        if (!wrap) {
          logInfo("checkOpenerContext: SKIP (no Table context)");
          return null;
        }
        logInfo("checkOpenerContext: ok");
        return { op: op, doc: doc, wrap: wrap };
      } catch (e) {
        logWarn("checkOpenerContext error: " + String(e && e.message ? e.message : e));
        return null;
      }
    }

    function checkTableRendererWiring(ctx) {
      logInfo("checkTableRendererWiring: start");
      try {
        var op = ctx.op;
        if (!op.FieldsAPI) logWarn("checkTableRendererWiring: missing opener.FieldsAPI");
        else if (typeof op.FieldsAPI.renderCellByField !== "function") logWarn("checkTableRendererWiring: opener.FieldsAPI.renderCellByField not a function");
        else logInfo("checkTableRendererWiring: FieldsAPI.renderCellByField ok");

        if (!op.STATE) logWarn("checkTableRendererWiring: missing opener.STATE");
        else if (!op.STATE.fieldsMeta) logWarn("checkTableRendererWiring: missing opener.STATE.fieldsMeta");
        else logInfo("checkTableRendererWiring: STATE.fieldsMeta ok");
      } catch (e) {
        logWarn("checkTableRendererWiring error: " + String(e && e.message ? e.message : e));
      }
    }

    function checkTableQuickSearch(ctx) {
      logInfo("checkTableQuickSearch: start");
      try {
        var op = ctx.op;
        if (typeof op.serverSearch === "function") logInfo("checkTableQuickSearch: ok");
        else logWarn("checkTableQuickSearch: ERROR serverSearch missing");
      } catch (e) {
        logWarn("checkTableQuickSearch error: " + String(e && e.message ? e.message : e));
      }
    }

    function checkShotviewRender(ctx) {
      logInfo("checkShotviewRender: start");
      try {
        var op = ctx.op;
        if (!op.CommonRenderer || typeof op.CommonRenderer.renderCellByField !== "function") {
          logWarn("checkShotviewRender: missing opener.CommonRenderer.renderCellByField");
          return;
        }

        var meta = { label: "shotview", type: "versions" };
        var node = null;
        try {
          node = op.CommonRenderer.renderCellByField("shot", "fi_0013", (op.__dbg_sampleShotviewValue || ""), meta);
        } catch (e) {
          logWarn("checkShotviewRender: render threw " + String(e && e.message ? e.message : e));
          return;
        }

        var ok = !!(node && node.nodeType === 1);
        if (!ok) logWarn("checkShotviewRender: ERROR non-element node " + String(node && node.nodeType));
        else logInfo("checkShotviewRender: ok tag=" + String(node.tagName || ""));
      } catch (e) {
        logWarn("checkShotviewRender error: " + String(e && e.message ? e.message : e));
      }
    }

    function checkFieldsMetaCompleteness(ctx) {
      logInfo("checkFieldsMetaCompleteness: start");
      try {
        var op = ctx.op;
        var st = op.STATE || {};
        var fids = Array.isArray(st.fieldIds) ? st.fieldIds : [];
        var meta = st.fieldsMeta || {};
        var missing = 0;
        var emptySelect = 0;

        for (var i = 0; i < fids.length; i++) {
          var fid = String(fids[i] || "");
          if (!fid) continue;
          var m = meta[fid];
          if (!m) {
            missing++;
            logWarn("checkFieldsMetaCompleteness: missing meta " + fid);
            continue;
          }
          var t = String(m.type || "");
          if (t === "select") {
            var opts = Array.isArray(m.options) ? m.options : [];
            if (opts.length === 0) {
              emptySelect++;
              logWarn("checkFieldsMetaCompleteness: select " + fid + " meta.options empty");
            }
          }
        }

        logInfo("checkFieldsMetaCompleteness: done missing=" + missing + " selectOptionsEmpty=" + emptySelect);
      } catch (e) {
        logWarn("checkFieldsMetaCompleteness error: " + String(e && e.message ? e.message : e));
      }
    }

    function checkDateFormatHealth(ctx) {
      logInfo("checkDateFormatHealth: start");
      try {
        var op = ctx.op;
        var st = op.STATE || {};
        var fids = Array.isArray(st.fieldIds) ? st.fieldIds : [];
        var meta = st.fieldsMeta || {};
        var rows = Array.isArray(st.rows) ? st.rows : [];
        var sampleN = Math.min(5, rows.length);
        var isoRe = /^\d{4}-\d{2}-\d{2}$/;

        for (var i = 0; i < fids.length; i++) {
          var fid = String(fids[i] || "");
          var m = meta[fid];
          if (!m || String(m.type || "") !== "date") continue;
          var idx = fids.indexOf(fid);
          var ok = 0;
          var tot = 0;
          for (var r = 0; r < sampleN; r++) {
            var row = rows[r] || [];
            var v = row[idx];
            if (v == null || v === "") continue;
            tot++;
            var s = String(v);
            if (isoRe.test(s)) ok++;
            else logWarn("checkDateFormatHealth: " + fid + " non-ISO value " + s);
          }
          var ratio = tot ? Math.round((ok / tot) * 100) : 100;
          logInfo("checkDateFormatHealth: " + fid + " ISO ratio " + ratio + "% (" + ok + "/" + tot + ")");
        }
      } catch (e) {
        logWarn("checkDateFormatHealth error: " + String(e && e.message ? e.message : e));
      }
    }

    function checkSelectOptionsAvailability(ctx) {
      logInfo("checkSelectOptionsAvailability: start");
      try {
        var op = ctx.op;
        var st = op.STATE || {};
        var fids = Array.isArray(st.fieldIds) ? st.fieldIds : [];
        var meta = st.fieldsMeta || {};
        for (var i = 0; i < fids.length; i++) {
          var fid = String(fids[i] || "");
          var m = meta[fid];
          if (!m || String(m.type || "") !== "select") continue;
          var opts = Array.isArray(m.options) ? m.options : [];
          if (!opts.length) logWarn("checkSelectOptionsAvailability: select " + fid + " has no options");
        }
        logInfo("checkSelectOptionsAvailability: done");
      } catch (e) {
        logWarn("checkSelectOptionsAvailability error: " + String(e && e.message ? e.message : e));
      }
    }

    function checkSelectOptionsHydrated(ctx) {
      logInfo("checkSelectOptionsHydrated: start");
      try {
        var op = ctx.op;
        var st = op.STATE || {};
        var fids = Array.isArray(st.fieldIds) ? st.fieldIds : [];
        var meta = st.fieldsMeta || {};
        var missing = [];

        for (var i = 0; i < fids.length; i++) {
          var fid = String(fids[i] || "");
          var m = meta[fid];
          if (!m || String(m.type || "") !== "select") continue;
          var opts = Array.isArray(m.options) ? m.options : [];
          if (!opts.length) missing.push(fid);
        }

        if (missing.length) logWarn("checkSelectOptionsHydrated: missing options for " + missing.join(", "));
        else logInfo("checkSelectOptionsHydrated: ok");
      } catch (e) {
        logWarn("checkSelectOptionsHydrated error: " + String(e && e.message ? e.message : e));
      }
    }

    function checkLinkRenderingConsistency(ctx) {
      logInfo("checkLinkRenderingConsistency: start");
      try {
        var op = ctx.op;
        var doc = ctx.doc;
        var st = op.STATE || {};
        var fids = Array.isArray(st.fieldIds) ? st.fieldIds : [];
        var meta = st.fieldsMeta || {};

        for (var i = 0; i < fids.length; i++) {
          var fid = String(fids[i] || "");
          var m = meta[fid];
          if (!m || !/_link$/.test(String(m.type || ""))) continue;
          var cells = doc.querySelectorAll('#tableWrap td[data-col-id=\"' + fid + '\"]');
          if (!cells || !cells.length) continue;

          var withAnchor = 0;
          var withChip = 0;
          for (var c = 0; c < cells.length; c++) {
            var td = cells[c];
            if (td.querySelector && td.querySelector('a[href]')) withAnchor++;
            if (td.querySelector && td.querySelector('a.chip[href]')) withChip++;
          }

          var pct = Math.round((withChip / Math.max(1, cells.length)) * 100);
          if (withAnchor === 0) logWarn("checkLinkRenderingConsistency: link " + fid + " no anchors found");
          else if (withChip === 0) logWarn("checkLinkRenderingConsistency: link " + fid + " no chip anchors found");
          logInfo("checkLinkRenderingConsistency: " + fid + " chip% " + pct + "% (" + withChip + "/" + cells.length + ")");
        }
      } catch (e) {
        logWarn("checkLinkRenderingConsistency error: " + String(e && e.message ? e.message : e));
      }
    }

    function checkOriginalsRendering(ctx) {
      logInfo("checkOriginalsRendering: start");
      try {
        var op = ctx.op;
        var doc = ctx.doc;
        var st = op.STATE || {};
        var fids = Array.isArray(st.fieldIds) ? st.fieldIds : [];
        var meta = st.fieldsMeta || {};
        for (var i = 0; i < fids.length; i++) {
          var fid = String(fids[i] || "");
          var m = meta[fid];
          if (!m || String(m.type || "") !== "originals") continue;
          var cells = doc.querySelectorAll('#tableWrap td[data-col-id=\"' + fid + '\"]');
          if (!cells || !cells.length) continue;

          var ok = 0;
          var chip = 0;
          var idle = 0;
          var loading = 0;
          var resolved = 0;
          var failed = 0;
          for (var c = 0; c < cells.length; c++) {
            var td = cells[c];
            if (!td.querySelector) continue;

            var a = td.querySelector('a[data-originals-state]');
            if (a) {
              chip++;
              var st2 = String(a.getAttribute('data-originals-state') || '');
              if (st2 === 'idle') idle++;
              else if (st2 === 'loading') loading++;
              else if (st2 === 'resolved') resolved++;
              else if (st2 === 'failed') failed++;
              if (a.getAttribute && a.getAttribute('href')) {
                var href = String(a.getAttribute('href') || '');
                if (href.indexOf('drive.google.com/drive/folders/') !== -1) ok++;
              }
              continue;
            }

            if (td.querySelector('a[href*=\"drive.google.com/drive/folders/\"]')) ok++;
          }

          if (chip === 0 && ok === 0) {
            logWarn("checkOriginalsRendering: originals " + fid + " missing originals chip");
            continue;
          }
          logInfo("checkOriginalsRendering: originals " + fid + " chip=" + chip + " idle=" + idle + " loading=" + loading + " resolved=" + resolved + " failed=" + failed + " folderLink=" + ok);
          if (loading > 0) logWarn("checkOriginalsRendering: originals " + fid + " should not auto-resolve (loading detected)");
        }
      } catch (e) {
        logWarn("checkOriginalsRendering error: " + String(e && e.message ? e.message : e));
      }
    }

    function checkOriginalsNotFoundRate(ctx) {
      logInfo("checkOriginalsNotFoundRate: start");
      try {
        var op = ctx.op;
        var doc = ctx.doc;
        var wrap = ctx.wrap;
        var st = op.STATE || {};
        var fids = Array.isArray(st.fieldIds) ? st.fieldIds : [];
        var meta = st.fieldsMeta || {};
        var vr = wrap.getBoundingClientRect ? wrap.getBoundingClientRect() : null;
        var maxSamples = 30;

        var total = 0;
        var notFound = 0;
        var loading = 0;

        function isInView(td) {
          try {
            if (!vr || !td.getBoundingClientRect) return true;
            var r = td.getBoundingClientRect();
            return (r.bottom >= vr.top && r.top <= vr.bottom);
          } catch (_) { return true; }
        }

        for (var i = 0; i < fids.length; i++) {
          var fid = String(fids[i] || "");
          var m = meta[fid];
          if (!m || String(m.type || "") !== "originals") continue;
          var cells = doc.querySelectorAll('#tableWrap td[data-col-id=\"' + fid + '\"]');
          for (var c = 0; c < cells.length; c++) {
            if (total >= maxSamples) break;
            var td = cells[c];
            if (!isInView(td)) continue;
            total++;

             var t = (td.textContent || "").trim();
             if (/originals not found/i.test(t) || /not found/i.test(t) || t === "NOT FOUND") notFound++;
             if (td.querySelector) {
               var a = td.querySelector('a[data-originals-state]');
               if (a) {
                 var st2 = String(a.getAttribute('data-originals-state') || '');
                 if (st2 === 'loading') loading++;
                 if (st2 === 'failed') notFound++;
               }
             }
           }
         }

        if (total === 0) {
          logInfo("checkOriginalsNotFoundRate: SKIP (no originals cells in view)");
          return;
        }

        var rate = notFound / Math.max(1, total);
        logInfo("checkOriginalsNotFoundRate: notFound=" + notFound + " loading=" + loading + " total=" + total + " rate=" + Math.round(rate * 100) + "%");
        if (rate > 0.5 && loading === 0) logWarn("checkOriginalsNotFoundRate: high NOT FOUND rate");
      } catch (e) {
        logWarn("checkOriginalsNotFoundRate error: " + String(e && e.message ? e.message : e));
      }
    }

    function checkOriginalsLazyResolve(ctx) {
      logInfo("checkOriginalsLazyResolve: start");
      try {
        var doc = ctx.doc;
        var chips = doc.querySelectorAll('a[data-originals-state]');
        if (!chips || !chips.length) {
          logInfo("checkOriginalsLazyResolve: SKIP (no originals chips found)");
          return;
        }

        var total = 0, idle = 0, loading = 0, failed = 0, resolved = 0;
        for (var i = 0; i < chips.length && i < 20; i++) {
          var st = String(chips[i].getAttribute('data-originals-state') || '');
          total++;
          if (st === 'idle') idle++;
          else if (st === 'loading') loading++;
          else if (st === 'failed') failed++;
          else if (st === 'resolved') resolved++;
        }
        logInfo("checkOriginalsLazyResolve: sample total=" + total + " idle=" + idle + " loading=" + loading + " resolved=" + resolved + " failed=" + failed);
        if (loading > 0) logWarn("checkOriginalsLazyResolve: originals should not auto-resolve (loading detected)");
      } catch (e) {
        logWarn("checkOriginalsLazyResolve error: " + String(e && e.message ? e.message : e));
      }
    }

    function checkVersionsPreviewHealth(ctx) {
      logInfo("checkVersionsPreviewHealth: start");
      try {
        var op = ctx.op;
        var doc = ctx.doc;

        var pending = doc.querySelector('[data-proxy-pending=\"1\"][data-proxy-id]');
        var img = doc.querySelector('#tableWrap td[data-col-id] a img');

        if (!pending && !img) {
          logInfo("checkVersionsPreviewHealth: SKIP (no preview/pending nodes found)");
          return;
        }

        if (pending) {
          var rid = String(pending.getAttribute('data-proxy-id') || '');
          var hasCache = false;
          try { hasCache = !!(rid && op.PROXY_CACHE && op.PROXY_CACHE[rid]); } catch (_) { hasCache = false; }
          if (hasCache) logWarn("checkVersionsPreviewHealth: pending preview despite PROXY_CACHE hit for " + rid);
          else logInfo("checkVersionsPreviewHealth: pending ok (cache not ready for sample " + rid + ")");
        }

        if (img) {
          var src = String(img.getAttribute('src') || '');
          if (!src || /undefined|null/.test(src)) logWarn("checkVersionsPreviewHealth: broken preview img src=" + src);
          else logInfo("checkVersionsPreviewHealth: preview ok src=" + src);
        }
      } catch (e) {
        logWarn("checkVersionsPreviewHealth error: " + String(e && e.message ? e.message : e));
      }
    }

    function checkInlineEditSignature(ctx) {
      logInfo("checkInlineEditSignature: start");
      try {
        var sig = ctx.op.__MOTK_TABLE_INLINE_EDIT_IMPL__ || null;
        var ok = !!(sig &&
          sig.linkPicker === "dblclick" &&
          sig.primitive === "dblclick" &&
          sig.checkbox === "click" &&
          Object.keys(sig).length === 3);
        if (!ok) logWarn("checkInlineEditSignature: mismatch " + JSON.stringify(sig));
        else logInfo("checkInlineEditSignature: ok");
      } catch (e) {
        logWarn("checkInlineEditSignature error: " + String(e && e.message ? e.message : e));
      }
    }

    function checkRenderPerfGuard(ctx) {
      logInfo("checkRenderPerfGuard: start");
      try {
        var v = ctx.op.__MOTK_TABLE_LAST_RENDER_MS__;
        if (v === undefined || v === null) {
          logWarn("checkRenderPerfGuard: missing __MOTK_TABLE_LAST_RENDER_MS__");
          return;
        }
        var n = Number(v);
        if (!isFinite(n)) {
          logWarn("checkRenderPerfGuard: invalid __MOTK_TABLE_LAST_RENDER_MS__ " + String(v));
          return;
        }
        if (n > 500) logWarn("checkRenderPerfGuard: slow render " + Math.round(n) + "ms");
        else logInfo("checkRenderPerfGuard: ok " + Math.round(n) + "ms");
      } catch (e) {
        logWarn("checkRenderPerfGuard error: " + String(e && e.message ? e.message : e));
      }
    }

    function checkEditorThemeParity(ctx) {
      logInfo("checkEditorThemeParity: start");
      try {
        var op = ctx.op;
        var doc = ctx.doc;

        // Verify shared editor class exists in opener CSS.
        var hasRule = false;
        try {
          var sheets = doc.styleSheets || [];
          for (var i = 0; i < sheets.length; i++) {
            var s = sheets[i];
            var rules = null;
            try { rules = s.cssRules || s.rules; } catch (_) { rules = null; }
            if (!rules) continue;
            for (var j = 0; j < rules.length; j++) {
              var txt = String(rules[j] && rules[j].cssText ? rules[j].cssText : "");
              if (txt.indexOf(".motk-inline-editor") >= 0) { hasRule = true; break; }
            }
            if (hasRule) break;
          }
        } catch (_) { }

        if (!hasRule) logWarn("checkEditorThemeParity: missing .motk-inline-editor CSS rule");
        else logInfo("checkEditorThemeParity: CSS ok");

        // If an editor is currently open in Table, verify it uses the shared class and is not white-background.
        var el = doc.querySelector("#tableWrap .motk-inline-editor");
        if (!el) {
          logInfo("checkEditorThemeParity: SKIP (no open Table editor)");
          return;
        }
        if (String(el.tagName || "").toLowerCase() === "input" && el.type === "date") {
          logInfo("checkEditorThemeParity: date editor found");
        }
        var cs = op.getComputedStyle ? op.getComputedStyle(el) : null;
        var bg = cs ? String(cs.backgroundColor || "") : "";
        if (bg === "rgb(255, 255, 255)" || bg === "rgba(255, 255, 255, 1)") {
          logWarn("checkEditorThemeParity: editor background appears white");
        } else {
          logInfo("checkEditorThemeParity: editor background ok " + bg);
        }
      } catch (e) {
        logWarn("checkEditorThemeParity error: " + String(e && e.message ? e.message : e));
      }
    }

    function loadAppDataAsync() {
      return new Promise(function (resolve) {
        google.script.run
          .withSuccessHandler(function (res) { updateFromRes(res); resolve(); })
          .withFailureHandler(function (err) {
            log('Global res error: ' + err);
            updateElement('field-types', '<span class="error">error: ' + err + '</span>');
            resolve();
          })
          .dp_loadAppData();
      });
    }

    function checkOriginalsAsync() {
      log('checkOriginals: start');
      return new Promise(function (resolve) {
        google.script.run.withSuccessHandler(function (trace) {
          globalRes.trace = trace;
          updateFromRes(globalRes);
          resolve();
        }).withFailureHandler(function (err) {
          updateElement('resolve-result', '<span class="error">failed: ' + err + '</span>');
          resolve();
        }).dp_traceOriginals({ entity: 'shot', id: 'sh_0001' });
      });
    }

    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      const obj = {};
      params.forEach((v, k) => obj[k] = v);
      return obj;
    }

    function renderEntitySamples() {
      log('renderEntitySamples: start');
      // dp_loadAppDataでカバー済み
    }

    function copyPageText() {
      const text = document.body.innerText;
      navigator.clipboard.writeText(text).then(() => log('copyAll: length ' + text.length));
    }

    // Ensure inline onclick handlers can always find these in global scope.
    window.runAllChecks = runAllChecks;
    window.copyPageText = copyPageText;

    var VIEWER_STATE_STORAGE_KEY = 'MOTK.viewer.state';
    var VIEWER_STATE_STORAGE_KEY_LEGACY = 'motk:viewerStateSnapshot';
    var viewerStateServerFetchInFlight = false;

    function readViewerSnapshotFromStorage() {
      try {
        if (!window || !window.localStorage) return null;
        var raw = localStorage.getItem(VIEWER_STATE_STORAGE_KEY)
          || localStorage.getItem(VIEWER_STATE_STORAGE_KEY_LEGACY);
        if (!raw) return null;
        var snap = JSON.parse(raw);
        if (!snap || !snap.updatedAt) return null;
        snap.source = 'storage';
        return snap;
      } catch (_) {
        return null;
      }
    }

    function renderViewerSnapshot(snapshot) {
      if (!snapshot) return;
      var labelPrefix = (snapshot.source === 'storage') ? '(stored) ' :
        (snapshot.source === 'server') ? '(server) ' :
          (snapshot.source === 'window.opener') ? '' : '';
      updateElement('viewer-state-status',
        labelPrefix +
        'sheet=' + (snapshot.sheetName || '(blank)') +
        ' rows=' + (snapshot.rowsLength != null ? snapshot.rowsLength : '') +
        ' total=' + (snapshot.total != null ? snapshot.total : '')
      );
      var box = document.getElementById('viewer-state-json');
      if (box) {
        box.textContent = JSON.stringify(snapshot, null, 2);
      }
    }

    function fetchViewerStateFromServer() {
      if (viewerStateServerFetchInFlight) return;
      if (!window.google || !google.script || !google.script.run) {
        updateElement('viewer-state-status', '<span class="error">viewer state unavailable</span>');
        return;
      }
      viewerStateServerFetchInFlight = true;
      updateElement('viewer-state-status', 'fetching stored viewer state…');
      google.script.run
        .withSuccessHandler(function (res) {
          viewerStateServerFetchInFlight = false;
          if (res && res.found && res.snapshot) {
            var snap = res.snapshot;
            snap.source = 'server';
            snap.storedAt = res.storedAt || snap.storedAt || null;
            renderViewerSnapshot(snap);
            return;
          }
          updateElement('viewer-state-status', '<span class="error">viewer state unavailable</span>');
          var box = document.getElementById('viewer-state-json');
          if (box) box.textContent = '{}';
        })
        .withFailureHandler(function (err) {
          viewerStateServerFetchInFlight = false;
          updateElement('viewer-state-status', '<span class="error">' + (err && err.message ? err.message : 'viewer state unavailable') + '</span>');
          var box = document.getElementById('viewer-state-json');
          if (box) box.textContent = '{}';
        })
        .dp_fetchViewerState();
    }

    function captureViewerState() {
      try {
        var snapshot = null;
        if (window.opener && window.opener.STATE) {
          var viewWin = window.opener;
          var st = viewWin.STATE;
          if (st) {
            var params = null;
            try { params = new URLSearchParams(viewWin.location.search); } catch (_) { }
            snapshot = {
              capturedAt: new Date().toISOString(),
              origin: (viewWin.location && viewWin.location.href) || '',
              sheetName: st.sheetName || '',
              pageId: st.pageId || '',
              page: st.page || 1,
              perPage: st.perPage || '',
              fieldIdsLength: Array.isArray(st.fieldIds) ? st.fieldIds.length : 0,
              columnsLength: Array.isArray(st.columns) ? st.columns.length : 0,
              fieldsMetaKeys: (st.fieldsMeta && typeof st.fieldsMeta === 'object') ? Object.keys(st.fieldsMeta).length : 0,
              inlineEditBound: !!viewWin.__MOTK_TABLE_INLINE_EDIT_BOUND,
              hasOpenLinkPicker: !!(viewWin.FieldsAPI && typeof viewWin.FieldsAPI.openLinkPicker === "function"),
              rowsLength: Array.isArray(st.rows) ? st.rows.length : 0,
              total: st.total,
              dataSource: st.dataSource || '',
              entityParam: params ? (params.get('entity') || '') : '',
              pageParam: params ? (params.get('page') || '') : '',
              pidParam: params ? (params.get('pid') || '') : '',
              source: 'window.opener'
            };
          }
        }
        if (!snapshot) {
          snapshot = readViewerSnapshotFromStorage();
        }
        if (snapshot) {
          renderViewerSnapshot(snapshot);
          return;
        }
        fetchViewerStateFromServer();
      } catch (err) {
        updateElement('viewer-state-status', '<span class="error">' + err.message + '</span>');
      }
    }

    // Init
    log('DebugPanel: init');
    runAllChecks();
    captureViewerState();
    setInterval(captureViewerState, 10000);
  </script>

  <!-- ===== 70.contract-inspector ===== -->
  <script>
    (function () {
      "use strict";

      function logLine(s) { var el = document.getElementById('ciLog'); if (el) { el.textContent += s + "\n"; } }
      function resetLog() { var el = document.getElementById('ciLog'); if (el) { el.textContent = ""; } }

      // safer GAS proxy: try multiple function names, fail softly
      function gasTry(candidates) {
        return new Promise(function (res, rej) {
          if (!window.google || !google.script || !google.script.run) {
            return rej(new Error("google.script.run not available"));
          }
          var run = google.script.run;
          var fn = null, name = null;
          for (var i = 0; i < candidates.length; i++) {
            name = candidates[i];
            if (typeof run[name] === "function") { fn = run[name]; break; }
          }
          if (!fn) {
            return rej(new Error("No server function found: " + candidates.join(" | ")));
          }
          try {
            run.withSuccessHandler(res).withFailureHandler(rej)[name]();
          } catch (e) {
            rej(e);
          }
        });
      }

      function gasCall(name, arg) {
        return new Promise(function (res, rej) {
          if (!window.google || !google.script || !google.script.run) {
            return rej(new Error("google.script.run not available"));
          }
          var run = google.script.run;
          if (typeof run[name] !== "function") {
            return rej(new Error("Server function missing: " + name));
          }
          try {
            if (arg === undefined) {
              run.withSuccessHandler(res).withFailureHandler(rej)[name]();
            } else {
              run.withSuccessHandler(res).withFailureHandler(rej)[name](arg);
            }
          } catch (e) { rej(e); }
        });
      }

      // UI
      function ensurePanel() {
        var root = document.getElementById('contractInspector');
        if (root) return root;
        root = document.createElement('section');
        root.id = 'contractInspector';
        root.innerHTML = [
          '<div style="margin:8px 0;padding:8px;border:1px solid #ccc;border-radius:6px">',
          '  <h3 style="margin:0 0 8px">Contract Inspector</h3>',
          '  <pre id="ciLog" style="max-height:50vh;overflow:auto;background:#111;color:#eee;padding:8px;border-radius:6px"></pre>',
          '</div>'
        ].join('');
        document.body.appendChild(root);
        return root;
      }

      async function checkFieldsMatrix() {
        logLine('== Fields matrix (entity × type) ==');
        try {
          // try getFieldsMatrix, else getFields and aggregate, else listFields
          var rows = null;
          try {
            var m = await gasTry(['getFieldsMatrix']);
            logLine(JSON.stringify(m, null, 2));
            return m;
          } catch (_) { }
          try {
            rows = await gasTry(['getFields', 'listFields']);
          } catch (e) {
            logLine('Fields fetch missing: ' + e.message);
            return null;
          }
          var map = {};
          (rows || []).forEach(function (r) {
            var e = String(r.entity || '').toLowerCase();
            var t = String(r.type || '').toLowerCase();
            if (!map[e]) map[e] = {};
            map[e][t] = (map[e][t] || 0) + 1;
          });
          logLine(JSON.stringify(map, null, 2));
          return map;
        } catch (e) {
          logLine('Fields error: ' + e.message);
          return null;
        }
      }

      async function checkLinksShape() {
        logLine('== Link type sanity (expect *_link only) ==');
        try {
          var rows = await gasTry(['getFields', 'listFields']);
          var legacy = [], proper = [];
          (rows || []).forEach(function (r) {
            var t = String(r.type || '').toLowerCase();
            if (t === 'entity_link') legacy.push(r);
            else if (/^(shot|asset|task|member|user)_link$/.test(t)) proper.push(r);
          });
          logLine('legacy entity_link count: ' + legacy.length);
          if (legacy.length) logLine(JSON.stringify(legacy.slice(0, 20), null, 2));
          logLine('proper *_link count: ' + proper.length);
          return { legacy, proper };
        } catch (e) {
          logLine('Fields fetch error: ' + e.message);
          return null;
        }
      }

      async function sampleListRows(entity) {
        logLine('== listRowsPage sample ==');
        try {
          var out = await gasCall('listRowsPage', { entity: entity, page: 1, perPage: 5 });
          var shape = {
            columns: (out && out.columns) || [],
            row0: (out && out.rows && out.rows[0]) || null,
            meta: (out && out.meta) || {}
          };
          logLine(JSON.stringify(shape, null, 2));
          var hasId = shape.columns.filter(c => String(c.type).toLowerCase() === 'id').length === 1;
          var hasName = shape.columns.filter(c => String(c.type).toLowerCase() === 'entity_name').length === 1;
          var badLink = shape.columns.filter(c => {
            var t = String(c.type || '').toLowerCase();
            if (t !== 'link') return false;
            return !c.target || !/^(shot|asset|task|member|user)$/.test(String(c.target));
          });
          logLine('check: id=1:' + hasId + ' entity_name=1:' + hasName + ' badLink=' + badLink.length);
          return out;
        } catch (e) {
          logLine('listRowsPage error: ' + e.message);
          return null;
        }
      }

      async function sampleDetailListRows(entity) {
        logLine('== Detail-style listRowsPage sample (' + entity + ') ==');
        try {
          // Payload matching 3CL_Detail.html Take 12
          var entStrict = String(entity).toLowerCase();
          var entLabel = (entStrict === 'shot') ? 'Shots' :
            (entStrict === 'asset') ? 'Assets' :
              (entStrict === 'task') ? 'Tasks' :
                (entStrict === 'user') ? 'Users' :
                  (entStrict === 'member') ? 'ProjectMembers' : 'Shots';
          var payload = {
            entity: "Shots",
            sheet: "Shots",
            entityPlural: "Shots",
            sheetName: "shot",
            pageType: "detail",
            offset: 0,
            limit: 5000,
            sort: [],
            filterGroups: [],
            groupCombine: "all"
          };
          logLine("payload: " + JSON.stringify(payload)); // Changed log to logLine

          try {
            var resp = await gasTry(["listRowsPage", "sv_listRowsPage"], payload); // Changed tryCall to gasTry
            if (resp && resp.rows && resp.rows.length) {
              logLine("OK: Rows returned. " + resp.rows.length); // Changed log to logLine
            } else {
              logLine("Detail listRowsPage error: No rows returned."); // Changed log to logLine
            }
            return resp; // Return resp here
          } catch (e) {
            logLine("Detail listRowsPage error: " + e.message); // Changed log to logLine
            return null; // Return null on error
          }
        } catch (e) {
          logLine('Detail listRowsPage error: ' + e.message);
          return null;
        }
      }

      async function checkMeta() {
        logLine('== project_meta roots ==');
        try {
          // これは動いている実績あり
          var meta = await gasTry(['getProjectMeta', 'get_project_meta']);
          logLine(JSON.stringify(meta, null, 2));
          return meta;
        } catch (e) {
          logLine('project_meta error: ' + e.message);
          return null;
        }
      }

      function start() {
        ensurePanel();
        (async function () {
          resetLog();
          await checkFieldsMatrix();
          await checkLinksShape();
          await sampleListRows('shot');
          await sampleListRows('asset');
          await sampleDetailListRows('shot');
          await checkMeta();
          logLine('== done ==');
        })().catch(function (err) {
          logLine('contract-inspector error: ' + String(err && err.message || err));
        });
      }

      window.runAllChecks = runAllChecks;
      window.copyPageText = copyPageText;
      if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', start, { once: true }); } else { start(); }
    })();
  </script>
  <!-- ===== 70. End ===== -->




</body>

</html>
