<script>
/* ===== 1.Router ===== */

(function(){
  "use strict";
/* ===== 1.End ===== */

  /* ===== 2.URL builders ===== */
  function baseUrl(){
    return (window.scriptUrl || window.SCRIPT_URL || (location.origin + location.pathname));
  }
  function normalizeEntity(ent){ return String(ent||'').trim().toLowerCase(); }
  function detailPageNameForEntity(ent){
    var key = normalizeEntity(ent);
    if(key === 'asset' || key === 'assets') return 'DetailAsset';
    if(key === 'task' || key === 'tasks') return 'DetailTask';
    if(key === 'user' || key === 'users') return 'DetailUser';
    if(key === 'member' || key === 'members' || key === 'projectmember' || key === 'projectmembers') return 'DetailMember';
    return 'DetailShot';
  }
  function pageUrl(pg, withTs){
    var u = new URL(baseUrl(), baseUrl());
    var body = document.body || {};
    var dataPage = body.dataset ? body.dataset.navPage : '';
    var statePage = (window.STATE && window.STATE.pageKey) ? window.STATE.pageKey : null;
    var target = pg || statePage || dataPage || 'DetailShot';
    u.searchParams.set('page', target);
    if(withTs){ u.searchParams.set('ts', Date.now().toString(36)); }
    return u.toString();
  }
  function buildEntityUrl(ent,id){
    var u = new URL(baseUrl(), baseUrl());
    var targetPage = detailPageNameForEntity(ent);
    u.searchParams.set('page', targetPage);
    u.searchParams.set('entity', ent||'shot');
    u.searchParams.set('id', id||'');
    u.searchParams.set('ts', Date.now().toString(36));
    return u.toString();
  }
  window.detailPageNameForEntity = detailPageNameForEntity;
  window.__Router__ = { baseUrl, pageUrl, buildEntityUrl };

/* ===== 3.GNAVI href===== */
function pumpOnce(scope){
  if(!scope) return;
  scope.querySelectorAll("a[href],a[data-page]").forEach(function(a){
    try{
      var pg = a.dataset.page
        || (a.href.match(/[?&]page=([^&]+)/)||[])[1]
        || (a.textContent||"").trim();
      if(pg) a.href = pageUrl(pg, false);
            if(a.hasAttribute("data-target")) a.target = a.getAttribute("data-target");
      else if(!a.hasAttribute("target")) a.target = "_top";
      if(!a.hasAttribute("rel")) a.rel = "noopener";
    }catch(_){}
  });
}

  /* ===== 4.Entity ===== */
  document.addEventListener("click", function(ev){
    var a = ev.target && ev.target.closest ? ev.target.closest("a[href]") : null;
    if(!a) return;
    try{
      var u = new URL(a.href, location.origin);
      var ent = u.searchParams.get("entity");
      var id  = u.searchParams.get("id");
      if(!(ent && id)) return;
      ev.preventDefault();
      var href = buildEntityUrl(ent, id);
      try{ window.top.location.assign(href); }catch(_){ window.top.location.href = href; }
    }catch(_){}
  }, {capture:true});

  /* ===== 5.Init ===== */
  document.addEventListener("DOMContentLoaded", function(){
    pumpOnce(document);           
  }, {once:true});

})();
</script>


<script>
(async function bootstrap() {
  // 1. Navigation highlighting and href normalisation.
    (function manageNavigation() {
    var scriptUrl = "<?= scriptUrl ?>";
    if (!scriptUrl) {
      console.error('SCRIPT_URL not found in template.');
      return;
    }

    function syncNavHeights(){
      var docEl = document.documentElement;
      if (!docEl) return;
      var g = document.getElementById('gNav');
      var p = document.getElementById('pNav');
      if (g && g.getBoundingClientRect) {
        var gHeight = String(Math.round(g.getBoundingClientRect().height)) + 'px';
        docEl.style.setProperty('--header-height', gHeight);
        docEl.style.setProperty('--gnav-height', gHeight);
      }
      if (p && p.getBoundingClientRect) {
        var pHeight = String(Math.round(p.getBoundingClientRect().height)) + 'px';
        docEl.style.setProperty('--pnav-height', pHeight);
      }
    }

    var entityToPage = {
      shot: 'Shots',
      asset: 'Assets',
      task: 'Tasks',
      member: 'ProjectMembers',
      user: 'Users'
    };

    function updateNavLinks() {
      var anchors = document.querySelectorAll('#gNav a, #pNav a');
      for (var i = 0; i < anchors.length; i++) {
        var anchor = anchors[i];
        var match = anchor.href && anchor.href.match(/[?&]page=([^&]+)/);
        var pageAttr = anchor.getAttribute('data-page');
        var page = pageAttr || (match ? match[1] : '');
        anchor.href = page ? scriptUrl + '?page=' + page : scriptUrl;
      }
    }

    function resolveCurrentPage() {
      var body = document.body;
      var dataPage = body && body.dataset ? body.dataset.navPage : '';
      if (dataPage) return dataPage;

      var searchParams = new URLSearchParams(window.location.search || '');
      var qsPage = searchParams.get('page');
      if (qsPage) return qsPage;

      if (window.PAGE) return String(window.PAGE);

      var entity = body && body.dataset ? body.dataset.navEntity : '';
      if (!entity && window.STATE && window.STATE.entity) {
        entity = window.STATE.entity;
      }
      var key = String(entity || '').toLowerCase();
      return entityToPage[key] || '';
    }

    function highlightActiveNav() {
      var current = resolveCurrentPage().toLowerCase();
      var anchors = document.querySelectorAll('#pNav a');
      for (var i = 0; i < anchors.length; i++) {
        var anchor = anchors[i];
        var target = (anchor.getAttribute('data-page') || '').toLowerCase();
        var isActive = current && target === current;
        if (isActive) {
          anchor.classList.add('active');
          anchor.setAttribute('aria-current', 'page');
        } else {
          anchor.classList.remove('active');
          anchor.removeAttribute('aria-current');
        }
      }
    }

    function initNav() {
      updateNavLinks();
      highlightActiveNav();
      syncNavHeights();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function(){
        initNav();
        syncNavHeights();
      }, { once: true });
    } else {
      initNav();
      syncNavHeights();
    }
    window.addEventListener('resize', syncNavHeights);
  })();

  // 2. Detail page helpers.
  var detailBar = document.getElementById('detailBar');
  if (detailBar) {
    var dataObj = window.data || {};
    var recordKeys = Object.keys(dataObj);
    var recordId = recordKeys.length ? dataObj[recordKeys[0]] : '';
    var shotCodeEl = document.getElementById('shotCode');
    var codeLabel = dataObj.fi_0002 || dataObj.fi_0016 || dataObj.fi_0026 || '';
    if (shotCodeEl && codeLabel) {
      shotCodeEl.textContent = codeLabel;
    }

    initPathMenu(dataObj);
    initLayoutSelector(dataObj);
    initModeToggle();
  }

  function gas(cmd) {
    var args = Array.prototype.slice.call(arguments, 1);
    return new Promise(function (resolve, reject) {
      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        reject(new Error('google.script.run not available'));
        return;
      }
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)[cmd].apply(null, args);
    });
  }

  function escapeHTML(str) {
    if (typeof str !== 'string') return str;
    return str.replace(/[&<>\'"]/g, function (tag) {
      switch (tag) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        default: return '&#39;';
      }
    });
  }

  var prevBtn = document.getElementById('prevBtn');
  if (prevBtn) {
    prevBtn.addEventListener('click', function () {
      nav(-1);
    });
  }
  var nextBtn = document.getElementById('nextBtn');
  if (nextBtn) {
    nextBtn.addEventListener('click', function () {
      nav(1);
    });
  }

  async function nav(offset) {
    try {
      var scriptUrl = window.SCRIPT_URL || "<?= scriptUrl ?>";
      var rows = await gas('listRows', 'Shots');
      var dataObj = window.data || {};
      var recordId = dataObj.fi_0001;
      if (!recordId) return;
      var idx = -1;
      for (var i = 0; i < rows.length; i++) {
        if (String(rows[i][0]) === String(recordId)) {
          idx = i;
          break;
        }
      }
      if (idx > -1 && rows[idx + offset]) {
        location.href = scriptUrl + '?entity=shot&id=' + rows[idx + offset][0];
      }
    } catch (err) {
      console.error('Navigation failed:', err);
    }
  }

  // 3. Fallback detail view rendering.
  var listBox = document.getElementById('fallbackList');
  if (listBox && window.data) {
    listBox.classList.remove('hidden');
    var parts = [];
    var keys = Object.keys(window.data);
    for (var i = 0; i < keys.length; i++) {
      var key = keys[i];
      parts.push('<div style="margin:4px 0;"><b>' + key + '</b>: ' + escapeHTML(String(window.data[key])) + '</div>');
    }
    listBox.innerHTML = parts.join('');
    var gridNode = document.getElementById('grid');
    if (gridNode) {
      gridNode.classList.add('hidden');
    }
  }
})();
</script>

<!-- ===== 12.detail-popover-dom ===== -->
<script>
(function(){
  "use strict";

  // 共通レンダラ呼び出し
  function renderFieldInto(node, field, row){
    if (!node) return;
    var ctx = { el: node, field: field, row: row };
    if (typeof window.renderFieldCell === 'function'){
      try { window.renderFieldCell(ctx); return; } catch(_){}
    }
    // フォールバック
    node.textContent = row && field && (row[field.field_name] || row[field.name] || '') || '';
  }

  // detailカード生成時に shotview を含む全フィールドで共通レンダラを適用
  window.renderDetailCard = function(cardEl, fieldDef, rowData){
    if (!cardEl) return;
    var target = cardEl.querySelector('[data-slot="value"]') || cardEl;
    renderFieldInto(target, fieldDef, rowData);
  };
})();
</script>
<!-- ===== 12. End ===== -->



<!-- ===== 13.detail-edit-init ===== -->
<script>
(function(){
  "use strict";

  function applyEditSaturation(on){
    try{ document.body.style.filter = on ? 'saturate(0.5)' : ''; }catch(_){}
  }

  // GridStack を「存在確認後」にのみ参照する安全版
  function ensureGridstack(){
    var el = document.querySelector('#grid') ||
             document.querySelector('#gridstackWrap') ||
             document.querySelector('.grid-stack');
    var GS = (window && window.GridStack) || null;

    // ライブラリ未読込 or 対象要素なし → 触れない
    if (!el || !GS || typeof GS.init !== 'function') return;

    var opts = {
      float: true,
      margin: 0,
      cellHeight: 8,
      disableOneColumnMode: false,
      minRow: 1
    };

    // 既存インスタンス再利用
    var gs = el.gridstack || GS.init(opts, el);
    if (!el.gridstack) el.gridstack = gs;

    // プレースホルダのはみ出し防止
    try{
      var ph = el.querySelector('.grid-stack-placeholder');
      if (ph){ ph.style.margin = '0'; ph.style.top = '0'; ph.style.left = '0'; }
    }catch(_){}
  }

  function bindToolbar(){
    var tl    = document.getElementById("toggleLayout");
    var save  = document.getElementById("saveBtnAll");
    var cards = document.getElementById("cardsBtn");
    var badge = document.getElementById("modeBadge");
    var footer= document.getElementById("footerMode");

    function applyMode(){
      var isEdit = !!(window.STATE && window.STATE.edit);
      document.body.classList.toggle("layout-edit", isEdit);
      document.body.setAttribute('data-layout-mode', isEdit ? 'edit' : 'view');

      if (save){ save.style.display = isEdit ? "" : "none"; save.disabled = !isEdit; }
      if (cards){ cards.style.display = isEdit ? "" : "none"; cards.disabled = !isEdit; }
      if (tl){
        tl.textContent = isEdit ? "Edit mode" : "View mode";
        tl.setAttribute("aria-pressed", isEdit ? "true" : "false");
        tl.classList.toggle('is-active', isEdit);
      }
      if (badge){
        badge.textContent = isEdit ? 'EDIT MODE' : 'VIEW MODE';
        badge.style.display = isEdit ? "inline-flex" : "none";
      }
      if (footer){ footer.textContent = isEdit ? 'Edit' : 'View'; }

      applyEditSaturation(isEdit);
    }

    if (tl){
      tl.addEventListener('click', function(e){
        e.preventDefault();
        if(!window.STATE) window.STATE = {};
        window.STATE.edit = !window.STATE.edit;
        applyMode();
        // GridStack は存在時のみ初期化
        ensureGridstack();
      }, {passive:false});
    }

    applyMode();
    window.bindToolbar = bindToolbar;

    // リサイズ時も「存在確認→初期化」
    window.addEventListener('resize', function(){
      requestAnimationFrame(ensureGridstack);
    }, {passive:true});
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      bindToolbar();
      ensureGridstack();
    }, {once:true});
  } else {
    bindToolbar();
    ensureGridstack();
  }
})();
</script>
<!-- ===== 13. End =====02 -->

<!-- ===== 14.modal-center-init ===== -->
<script>
/* center any existing "Cards" modal in viewport without changing its structure */
(function(){
  "use strict";

  // heuristics to find the Cards modal element
  function findCardsModal(){
    return document.getElementById('cardsModal')
        || document.querySelector('.cards-modal')
        || document.querySelector('[data-modal="cards"]')
        || null;
  }

  function ensureBackdrop(modal){
    if (!modal) return null;
    var id = 'motk-cards-backdrop';
    var bd = document.getElementById(id);
    if (!bd){
      bd = document.createElement('div');
      bd.id = id;
      bd.className = 'motk-modal-backdrop';
      bd.addEventListener('click', function(){ hideModal(modal, bd); }, {passive:true});
      document.body.appendChild(bd);
    }
    return bd;
  }

  function centerModal(modal){
    if (!modal) return;
    modal.classList.add('motk-center-modal');
  }

  function showModal(modal, bd){
    if (!modal) return;
    centerModal(modal);
    if (bd) bd.style.display = '';
    modal.style.display = '';
    modal.removeAttribute('aria-hidden');
  }

  function hideModal(modal, bd){
    if (!modal) return;
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
    if (bd) bd.style.display = 'none';
  }

  function wireCardsButton(){
    var btn = document.getElementById('cardsBtn');
    var modal = findCardsModal();
    var bd = ensureBackdrop(modal);

    if (modal){
      // keep centered on resize
      window.addEventListener('resize', function(){
        window.requestAnimationFrame(function(){ centerModal(modal); });
      }, {passive:true});

      // if modal visibility changes elsewhere, keep class
      var mo = new MutationObserver(function(){ centerModal(modal); });
      mo.observe(modal, {attributes:true, attributeFilter:['style','class','aria-hidden']});
    }

    if (btn){
      btn.addEventListener('click', function(e){
        e.preventDefault();
        modal = modal || findCardsModal();
        bd = bd || ensureBackdrop(modal);
        if (!modal) return;
        // toggle
        var hidden = modal.style.display === 'none' || modal.getAttribute('aria-hidden') === 'true';
        if (hidden) showModal(modal, bd); else hideModal(modal, bd);
      }, {passive:false});
    }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', wireCardsButton, {once:true});
  } else {
    wireCardsButton();
  }
})();
</script>
<!-- ===== 14. End ===== -->

<!-- ===== 41.detail-dom-normalize ===== -->
<script>
(function(){
"use strict";
function isDetail(){return !!document.querySelector("#detailBar,[data-detail-root],.detail-page");}
function killSpacers(){
  document.querySelectorAll(".spacer-top").forEach(function(n){ try{ n.parentNode.removeChild(n); }catch(_){ } });
}
function liftGrid(){
  var grid=document.querySelector("#gridstackWrap")||document.querySelector("#grid")||document.querySelector(".grid-stack");
  if(grid){
    grid.style.marginTop="0";
    grid.style.top="0";
  }
}
function hideTopBands(){
  ["#hScroll",".top-band",".grid-top-gap",".grid-overlay"].forEach(function(sel){
    var el=document.querySelector(sel); if(el){ el.style.display="none"; }
  });
}
function init(){
  if(!isDetail()) return;
  killSpacers();
  hideTopBands();
  liftGrid();
}
if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",init,{once:true});}else{init();}
window.addEventListener("resize",function(){ if(isDetail()){ liftGrid(); } },{passive:true});
})();
/* ===== 41. End ===== */
</script>

