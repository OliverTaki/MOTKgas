<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('CoreStyles'); ?>          <!-- CoreStyles 等を Theme に統合している前提 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/5.1.1/gridstack.min.css">
</head>
<body>
  <?!= include('BarGnavi'); ?>
  <?!= include('BarPnavi'); ?>
  <?!= include('Scripts'); ?>

  <div id="main-content">
    <div class="grid-stack" id="grid" gs-column="12"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/5.1.1/gridstack-h5.min.js"></script>
  <script>
    /* ----- URL パラメータと共通変数 ----- */
const entity   = 'shot';
const recordId = '<?= id ?>';

if (!recordId) {const p = new URLSearchParams(location.search);window.recordId = p.get('id') || '';}


    /* ----- Grid 初期化 ----- */
    const grid = GridStack.init({
      float: true,
      cellHeight: 90,
      resizable: { handles: 'e, se, s, w' },
    });

    /* ----- データ取得 → カード描画 ----- */
    google.script.run
      .withSuccessHandler(drawCards)
      .getEntity(entity, recordId);

    function drawCards(dataObj) {
      if (!dataObj){ alert('Record not found'); return; }
        document.getElementById('shotCode').textContent =
        dataObj['fi_0001'] || recordId || '(no code)';

      Object.entries(dataObj).forEach(([key, val]) => {
        const elm = document.createElement('div');
        elm.className = 'grid-stack-item';
        elm.setAttribute('gs-w', '3');
        elm.setAttribute('gs-h', '1');
        elm.innerHTML = `
          <div class="grid-stack-item-content" style="background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;padding:6px;box-sizing:border-box;">
            <h4 style="margin:0 0 4px;font-size:13px;">${key}</h4>
            <p style="margin:0;font-size:14px;" contenteditable data-field="${key}">${val ?? ''}</p>
          </div>`;
        grid.addWidget(elm);
      });
      restoreLayout();
    }




    /* ----- レイアウト復元／保存 ----- */
    function restoreLayout(){
      google.script.run
        .withSuccessHandler(layout=>{
          if (!layout) return;
          grid.engine.nodes.forEach(n=>{
            const fid = n.el.querySelector('[data-field]').dataset.field;
            const saved = layout.find(l=>l.id===fid);
            if (saved) grid.update(n.el, {x:saved.x,y:saved.y,w:saved.w,h:saved.h});
          });
        })
        .getPageLayout(entity);
    }

    window.addEventListener('beforeunload',()=>{
      const layout = grid.save(false).map(o=>{
        const id = o.el.querySelector('[data-field]').dataset.field;
        return {id, x:o.x, y:o.y, w:o.w, h:o.h};
      });
      google.script.run.savePageLayout(entity, JSON.stringify(layout));
    });

    /* ----- インライン編集保存 ----- */
    document.addEventListener('focusout', e=>{
      if (e.target.matches('[contenteditable]')){
        const field = e.target.dataset.field;
        const value = e.target.innerText;
        google.script.run.updateField(entity, recordId, field, value);
      }
    });
  </script>
</body>
</html>
