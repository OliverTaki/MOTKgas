<!-- ===== FieldsAPI (strict, type-driven, full file) ===== -->
<script>
  (function () {
    "use strict";

    /* ========= 0. helpers ========= */
    function gsr() { return (window.google && google.script && google.script.run) || null; }
    function tryCall(names, args) {
      return new Promise(function (resolve, reject) {
        var r = gsr(); if (!r) return reject(new Error("gsr missing"));
        (function next(i) {
          if (i >= names.length) return reject(new Error("no api"));
          var fn = names[i]; if (typeof r[fn] !== "function") return next(i + 1);
          r.withSuccessHandler(resolve).withFailureHandler(function () { next(i + 1); })[fn](args);
        })(0);
      });
    }
    function el(tag, cls, text) {
      var n = document.createElement(tag);
      if (cls) n.className = cls;
      if (text != null) n.textContent = String(text);
      return n;
    }
    function chip(href, label, newTab) {
      var a = el("a", "chip", label || href || "");
      if (href) a.href = href;
      /* FIX: when newTab=true, always open in a new tab with noopener+noreferrer */
      if (newTab) { 
          a.target = "_blank"; 
          a.rel = "noopener noreferrer"; 
      }
      return a;
    }
    function parseList(val) {
      if (Array.isArray(val)) return val;
      var s = (val == null ? "" : String(val));
      return s.split(/[,;\s/|]+/).map(function (t) { return t.trim(); }).filter(Boolean);
    }
    function driveUrlFromId(id, kind) {
      if (!id) return "";
      if (kind === "file") return "https://drive.google.com/file/d/" + id + "/view";
      return "https://drive.google.com/drive/folders/" + id;
    }
    function extractDriveId(s) {
      if (!s) return "";
      var m = String(s).match(/[a-zA-Z0-9_-]{25,}/);
      return m ? m[0] : "";
    }
    function isoDateOnly(s) {
      if (!s) return "";
      var d = (s instanceof Date) ? s : new Date(s);
      if (isNaN(d.getTime())) return String(s);
      var y = d.getFullYear(), m = ("0" + (d.getMonth() + 1)).slice(0 - 2), da = ("0" + d.getDate()).slice(0 - 2);
      return y + "-" + m + "-" + da;
    }
    function bucketOf(entity) {
      return entity === "asset" ? "assets" :
        entity === "task" ? "tasks" :
          entity === "user" ? "users" :
            entity === "member" ? "members" : "shots";
    }
    function fidToEntity(fid, fallbackId) {
      if (window.KNOWN_LINK_FIELD_IDS && window.KNOWN_LINK_FIELD_IDS[fid]) return window.KNOWN_LINK_FIELD_IDS[fid];
      if (/asset/i.test(fid)) return "asset";
      if (/task/i.test(fid)) return "task";
      if (/user/i.test(fid)) return "user";
      if (/member/i.test(fid)) return "member";
      if (/shot/i.test(fid)) return "shot";
      
      /* FIX: id prefix mapping (tk_, pm_) */
      var val = String(fallbackId || "").trim();
      if (/^as[_-]/i.test(val)) return "asset";
      if (/^tk[_-]/i.test(val)) return "task";   // Normalize legacy id prefix (ta -> tk).
      if (/^us[_-]/i.test(val)) return "user";
      if (/^pm[_-]/i.test(val)) return "member"; // Normalize legacy id prefix (mb -> pm).
      if (/^sh[_-]/i.test(val)) return "shot";
      
      return "shot";
    }

    window.KNOWN_LINK_FIELD_IDS = Object.assign({
      fi_0061: "asset", fi_0062: "task", fi_0063: "shot", fi_0064: "task", fi_0065: "asset"
    }, window.KNOWN_LINK_FIELD_IDS || {});

    window.LINK_MAPS = Object.assign({ assets: {}, shots: {}, tasks: {}, users: {}, members: {} }, window.LINK_MAPS || {});

    var SCRIPT_URL = (function () {
      try { return null; } catch (e) { return null; }
    })() || (window.__SCRIPT_URL__ || (location.origin + location.pathname));

    var Router = window.__Router__ || {};

    Router.baseUrl = function () { return SCRIPT_URL; };

    Router.pageUrl = function (params) {
      var url = new URL(SCRIPT_URL);
      Object.keys(params || {}).forEach(function (k) {
        if (params[k] != null && params[k] !== "") {
          url.searchParams.set(k, params[k]);
        }
      });
      return url.toString();
    };

    Router.entityPageName = function (entity) {
      /* FIX: page name mapping for all entities */
      var e = String(entity || "").toLowerCase().trim();
      if (!e) return "Dashboard";
      if (e === "shot" || e === "shots") return "Shots";
      if (e === "asset" || e === "assets") return "Assets";
      if (e === "task" || e === "tasks") return "Tasks";
      if (e === "user" || e === "users") return "Users";
      if (e === "member" || e === "members" || e === "projectmember" || e === "projectmembers") return "ProjectMembers";
      return "Dashboard";
    };

    Router.detailPageNameForEntity = function (entity) {
      /* FIX: route all entities to the correct Detail page */
      var e = String(entity || "").toLowerCase().trim();
      if (!e) return "Dashboard";
      if (e === "shot" || e === "shots") return "DetailShot";
      if (e === "asset" || e === "assets") return "DetailAsset";
      if (e === "task" || e === "tasks") return "DetailTask";
      if (e === "user" || e === "users") return "DetailUser";
      if (e === "member" || e === "members" || e === "projectmember" || e === "projectmembers") return "DetailMember";
      
      // Default fallback.
      return "DetailShot";
    };

    // Detail entity URL builder
    // NOTE: v2 omits ts and uses only page/entity/id.
    Router.buildEntityUrl = function (entity, id, opts) {
      if (!entity || !id) return SCRIPT_URL;
      var params = Object.assign(
        {
          page: Router.detailPageNameForEntity(entity),
          entity: entity,
          id: id
        },
        opts || {}
      );
      return Router.pageUrl(params);
    };

    Router.current = function () {
      try {
        var url = new URL(location.href);
        var q = Object.fromEntries(url.searchParams.entries());
        return {
          page: q.page || "",
          entity: q.entity || "",
          id: q.id || ""
        };
      } catch (e) {
        return { page: "", entity: "", id: "" };
      }
    };

    Router.navTo = function (params) {
      location.href = Router.pageUrl(params);
    };

    window.__Router__ = Router;

    async function ensureLinkMaps() {
      var need = ["assets", "shots", "tasks", "users", "members"].some(function (k) {
        return !window.LINK_MAPS[k] || !Object.keys(window.LINK_MAPS[k]).length;
      });
      if (!need) return window.LINK_MAPS;
      try {
        var maps = await tryCall(["sv_getLinkMaps", "getLinkMaps"], null);
        if (maps && typeof maps === "object") {
          ["assets", "shots", "tasks", "users", "members"].forEach(function (k) {
            if (!window.LINK_MAPS[k]) window.LINK_MAPS[k] = {};
            Object.assign(window.LINK_MAPS[k], maps[k] || {});
          });
        }
      } catch (_) { }
      return window.LINK_MAPS;
    }

    /* ========= 2. Originals resolver ========= */
    async function resolveOriginalsUrl(ctx) {
      var apis = [
        "sv_getOriginalsFolderUrl", "getOriginalsFolderUrl",
        "sv_getOriginalsUrl", "getOriginalsUrl",
        "sv_findOriginalsFolder", "findOriginalsFolder",
        "sv_resolveOriginals", "resolveOriginals"
      ];
      for (var i = 0; i < apis.length; i++) {
        try {
          var res = await tryCall([apis[i]], { entity: ctx.entity, id: ctx.id, fid: ctx.fid, value: ctx.val, row: ctx.row });
          if (typeof res === "string" && /^https?:\/\//i.test(res)) return res;
          if (res && typeof res === "object") {
            if (res.url) return res.url;
            var folderId = res.folderId || res.driveId || res.id;
            var fileId = res.fileId;
            if (folderId) return driveUrlFromId(folderId, "folder");
            if (fileId) return driveUrlFromId(fileId, "file");
          }
        } catch (_) { }
      }
      var id = extractDriveId(ctx.val);
      return id ? driveUrlFromId(id, "folder") : "";
    }

    /* ========= 3. renderers ========= */
    function R_id(o) {
      var s = el("span", null, o.val == null ? "" : String(o.val));
      s.setAttribute("data-raw", o.val == null ? "" : String(o.val));
      return s;
    }
    function R_text(o) { return document.createTextNode(o.val == null ? "" : String(o.val)); }
    function R_date(o) { return document.createTextNode(isoDateOnly(o.val)); }
    function R_checkbox(o) {
      var input = el("input"); input.type = "checkbox";
      var v = o.val;
      var checked = (v === true) || (typeof v === "number" && v !== 0) ||
        (/^(true|yes|on|1)$/i.test(String(v || "")));
      input.checked = !!checked;
      input.disabled = !o.editable;
      return input;
    }
    function R_select(o) {
      return document.createTextNode(o.val == null ? "" : String(o.val));
    }
    function R_json(o) {
      var pre = el("pre", "json");
      try { pre.textContent = JSON.stringify(typeof o.val === "string" ? JSON.parse(o.val) : o.val, null, 2); }
      catch (_) { pre.textContent = String(o.val == null ? "" : o.val); }
      return pre;
    }
    function R_entity_name(o) {
      var entity = fidToEntity(o.fid, String(o.val || ""));
      var bucket = bucketOf(entity);
      var key = String(o.val || "");
      var name = (window.LINK_MAPS[bucket] || {})[key] || key;
      return el("span", null, name);
    }
    function R_entity_link(o) {
      var entity = o.linkEntity ? String(o.linkEntity) : fidToEntity(o.fid, String(o.val || ""));
      var ids = parseList(o.val);
      var box = el("span");
      if (!ids.length) { box.appendChild(document.createTextNode("")); return box; }
      var map = window.LINK_MAPS[bucketOf(entity)] || {};
      ids.forEach(function (id, i) {
        var label = map[id] || id;
        box.appendChild(chip(Router.buildEntityUrl(entity, id), label, false));
        if (i < ids.length - 1) box.appendChild(document.createTextNode(" "));
      });
      return box;
    }
    function R_originals(o) {
      window.__MOTK_ORIGINALS_CACHE = window.__MOTK_ORIGINALS_CACHE || {};

      var a = chip("#", "Open", true);
      var token = (Date.now().toString(36) + ":" + Math.random().toString(36).slice(2));
      a.setAttribute("data-orig-token", token);
      var ctx = {
        entity: o.entity || "shot",
        id: (o.row && (o.row.fi_0001 || o.row.id || o.row.ID)) || "",
        fid: o.fid, val: o.val, row: o.row || {}
      };

      a.setAttribute("data-originals-entity", String(ctx.entity || ""));
      a.setAttribute("data-originals-id", String(ctx.id || ""));
      a.setAttribute("data-originals-state", "idle"); // idle|loading|resolved|failed

      function isCurrent() {
        try {
          if (a.getAttribute("data-orig-token") !== token) return false;
          if (!document.body || !document.body.contains(a)) return false;
        } catch (_) { return false; }
        return true;
      }

      function cacheKey() {
        return String(ctx.entity || "") + ":" + String(ctx.id || "");
      }

      function setState(next, text, href) {
        if (!isCurrent()) return;
        try {
          a.setAttribute("data-originals-state", next);
          if (typeof text === "string") a.textContent = text;
          if (href) a.href = href;
          else a.setAttribute("href", "#");
        } catch (_) { }
      }

      a.addEventListener("click", function (e) {
        try { if (e && e.preventDefault) e.preventDefault(); } catch (_) { }
        try { if (e && e.stopPropagation) e.stopPropagation(); } catch (_) { }

        if (!isCurrent()) return;

        var state = "";
        try { state = a.getAttribute("data-originals-state") || ""; } catch (_) { }
        if (state === "loading") return;

        // Take21: click-first UX (new tab immediately, then resolve and redirect)
        // Take22: avoid document.write (can trigger "Invalid regular expression flags" in some runtimes)
        var win = null;
        try {
          win = window.open("about:blank", "_blank");
          if (win) {
            try { win.document.title = "Resolving Originals…"; } catch (_) { }
            try {
              var doc = win.document;
              var body = doc && doc.body ? doc.body : null;
              if (body) {
                body.innerHTML = "<h3>Resolving Originals…</h3><p>Please wait.</p>";
                try { body.style.fontFamily = "system-ui"; body.style.margin = "24px"; } catch (_) { }
              }
            } catch (_) { }
          }
        } catch (_) { win = null; }

        var key = cacheKey();
        var cached = "";
        try { cached = key && window.__MOTK_ORIGINALS_CACHE[key] ? String(window.__MOTK_ORIGINALS_CACHE[key]) : ""; } catch (_) { cached = ""; }
        if (cached) {
          setState("resolved", "Open", cached);
          try { if (win) win.location.href = cached; } catch (_) { }
          return;
        }

        if (!ctx.id) {
          setState("failed", "Originals not found", "");
          try { if (typeof showError === "function") showError("Originals not found (missing id)"); } catch (_) { }
          if (win) {
            try { win.document.body.innerHTML = "<h3>Originals not found</h3><p>Missing record id.</p>"; } catch (_) { }
          }
          return;
        }

        setState("loading", "Loading Originals...", "");

        resolveOriginalsUrl(ctx).then(function (url) {
          if (!isCurrent()) return;
          url = (typeof url === "string") ? url : "";
          if (url && /^https?:\/\//i.test(url)) {
            try { window.__MOTK_ORIGINALS_CACHE[key] = url; } catch (_) { }
            setState("resolved", "Open", url);
            try { a.target = "_blank"; } catch (_) { }
            try { a.dataset.url = url; } catch (_) { }
            try { a.setAttribute("title", url); } catch (_) { }
            try { if (win) win.location.href = url; } catch (_) { }
          } else {
            setState("failed", "Originals not found", "");
            try { if (typeof showError === "function") showError("Originals not found"); } catch (_) { }
            if (win) {
              try { win.document.body.innerHTML = "<h3>Originals not found</h3><p>No URL was returned.</p>"; } catch (_) { }
            }
          }
        }).catch(function (err) {
          if (!isCurrent()) return;
          setState("failed", "Originals not found", "");
          try {
            if (typeof showError === "function") showError("Originals resolve failed: " + String(err && err.message ? err.message : err));
          } catch (_) { }
          if (win) {
            try { win.document.body.innerHTML = "<h3>Originals resolve failed</h3><pre>" + String(err) + "</pre>"; } catch (_) { }
          }
        });
      }, true);
      return a;
    }
    function R_file_list(o) {
      var items = [];
      try {
        if (typeof o.val === "string" && /^\s*\[/.test(o.val)) items = JSON.parse(o.val) || [];
        else if (Array.isArray(o.val)) items = o.val;
        else items = parseList(o.val);
      } catch (_) { items = parseList(o.val); }
      var box = el("span");
      if (!items.length) { box.appendChild(document.createTextNode("")); return box; }
      items.forEach(function (it, i) {
        var href = "", label = "", kind = "";
        if (typeof it === "string") {
          if (/^https?:\/\//i.test(it)) { href = it; label = it; }
          else { href = driveUrlFromId(extractDriveId(it), "file"); label = it; }
        } else if (it && typeof it === "object") {
          label = it.name || it.url || it.id || "";
          if (it.url) href = it.url;
          else if (it.id) href = driveUrlFromId(it.id, it.kind === "folder" ? "folder" : "file");
          else if (it.fileId) href = driveUrlFromId(it.fileId, "file");
          else if (it.folderId || it.driveId) href = driveUrlFromId(it.folderId || it.driveId, "folder");
        }
        box.appendChild(href ? chip(href, label, true) : el("span", null, label));
        if (i < items.length - 1) box.appendChild(document.createTextNode(" "));
      });
      return box;
    }
    function R_thumbnails(o) {
      var list = parseList(o.val);
      var box = el("div", "thumbs");
      list.forEach(function (tok) {
        var url = /^https?:\/\//i.test(tok) ? tok : ("https://drive.google.com/thumbnail?sz=w256&id=" + extractDriveId(tok));
        var img = el("img", "thumb"); img.loading = "lazy"; img.decoding = "async"; img.src = url;
        /* FIX: wrap thumbnails in a link (new tab, noopener+noreferrer) */
        var a = el("a"); a.href = url; a.target = "_blank"; a.rel = "noopener noreferrer"; a.appendChild(img);
        box.appendChild(a);
      });
      return box;
    }

    function _previewRecordId_(o) {
      try {
        var rid0 = (o && (o.recordId || o.rowId || o.id)) ? (o.recordId || o.rowId || o.id) : "";
        if (rid0) return String(rid0 || "");
        var row = (o && o.row) ? o.row : null;
        var rid = row && (row.fi_0001 || row.id || row.ID) ? (row.fi_0001 || row.id || row.ID) : "";
        return String(rid || "");
      } catch (_) { }
      return "";
    }

    function _proxyUrlFromCache_(recordId) {
      recordId = String(recordId || "");
      if (!recordId) return "";
      try {
        var cache = window.PROXY_CACHE || null;
        if (!cache) return "";
        var v = cache[recordId];
        if (!v) return "";
        if (typeof v === "string") return v;
        if (v && typeof v === "object") {
          if (v.url) return String(v.url);
          if (v.previewUrl) return String(v.previewUrl);
          if (v.id) return "https://drive.google.com/file/d/" + encodeURIComponent(String(v.id)) + "/view";
        }
      } catch (_) { }
      return "";
    }

    function _thumbFromProxyUrl_(url) {
      try {
        url = String(url || "");
        var idm = (url.match(/[-\\w]{25,}/) || [])[0] || "";
        if (idm) return "https://drive.google.com/thumbnail?id=" + encodeURIComponent(idm) + "&sz=w320";
      } catch (_) { }
      return String(url || "");
    }

    function _renderVersionsFallback_(o) {
      var list = parseList(o.val);
      var box = el("span");
      list.forEach(function (v, i) {
        var t = chip("", String(v), false); t.classList.add("tag");
        t.removeAttribute("href"); t.removeAttribute("target"); t.removeAttribute("rel");
        box.appendChild(t);
        if (i < list.length - 1) box.appendChild(document.createTextNode(" "));
      });
      if (!list.length) box.appendChild(document.createTextNode("—"));
      return box;
    }

    function _driveIdFromAny_(url) {
      try {
        url = String(url || "");
        return (url.match(/[-\\w]{25,}/) || [])[0] || "";
      } catch (_) { }
      return "";
    }

    function _driveThumbUrl_(id) {
      if (!id) return "";
      return "https://drive.google.com/thumbnail?id=" + encodeURIComponent(id) + "&sz=w320";
    }

    function _driveMediaUrl_(id, mime, name) {
      if (!id) return "";
      mime = String(mime || "").toLowerCase();
      name = String(name || "").toLowerCase();

      if (mime.indexOf("image/") === 0 || /\.(png|jpg|jpeg|webp|gif)$/.test(name)) {
        return "https://drive.google.com/uc?export=view&id=" + encodeURIComponent(id);
      }
      return "https://drive.google.com/uc?export=download&id=" + encodeURIComponent(id);
    }

    function _proxyEntryFromCache_(recordId) {
      try { return (window.PROXY_CACHE && window.PROXY_CACHE[recordId]) || null; } catch (_) { }
      return null;
    }

    function _fillPreviewSingle_(host, recordId, url) {
      host.innerHTML = "";

      var entry = _proxyEntryFromCache_(recordId);
      var driveId =
        (entry && entry.id) ? String(entry.id) :
        _driveIdFromAny_(url);

      var name =
        (entry && (entry.name || entry.fileName || entry.filename)) ? String(entry.name || entry.fileName || entry.filename) : "";

      var mime =
        (entry && (entry.mimeType || entry.mime)) ? String(entry.mimeType || entry.mime) : "";

      var thumb =
        (entry && entry.thumb) ? String(entry.thumb) :
        (driveId ? _driveThumbUrl_(driveId) : _thumbFromProxyUrl_(url));

      var media =
        (entry && (entry.mediaUrl || entry.media || entry.directUrl)) ? String(entry.mediaUrl || entry.media || entry.directUrl) :
        (driveId ? _driveMediaUrl_(driveId, mime, name) : String(url || ""));

      var span = document.createElement("span");
      span.className = "proxy-thumb";
      span.setAttribute("data-motk-proxy-thumb", "1");
      span.setAttribute("data-proxy-record-id", String(recordId || ""));
      if (driveId) span.setAttribute("data-proxy-drive-id", driveId);
      span.setAttribute("data-proxy-media", media);
      if (mime) span.setAttribute("data-proxy-mime", mime);
      if (name) span.setAttribute("data-proxy-name", name);

      var img = document.createElement("img");
      img.loading = "lazy";
      img.decoding = "async";
      img.src = thumb;
      img.alt = name || "preview";

      span.appendChild(img);
      host.appendChild(span);
    }

    function R_preview_single(o) {
      var rid = _previewRecordId_(o);
      var url = _proxyUrlFromCache_(rid);

      var box = document.createElement("span");

      if (url) {
        _fillPreviewSingle_(box, rid, url);
        return box;
      }

      // Pending: allow Table/Detail to refresh once PROXY_CACHE is populated.
      box.setAttribute("data-proxy-pending", "1");
      box.setAttribute("data-proxy-id", String(rid || ""));
      if (String(o.type || "").trim().toLowerCase() === "versions") {
        box.appendChild(_renderVersionsFallback_(o));
      } else {
        box.appendChild(document.createTextNode("—"));
      }
      return box;
    }

    window.__MOTK_PROXY_PREVIEW_REFRESH__ = function () {
      try {
        var nodes = document.querySelectorAll('[data-proxy-pending="1"][data-proxy-id]');
        if (!nodes || !nodes.length) return;
        for (var i = 0; i < nodes.length; i++) {
          var host = nodes[i];
          if (!host || !host.getAttribute) continue;
          if (!document.body || !document.body.contains(host)) continue;
          var rid = host.getAttribute("data-proxy-id") || "";
          var url = _proxyUrlFromCache_(rid);
          if (!url) continue;
          _fillPreviewSingle_(host, rid, url);
          host.removeAttribute("data-proxy-pending");
        }
      } catch (_) { }
    };

    function R_versions(o) {
      return R_preview_single(o);
    }

    /* ========= 4. entry ========= */
    var _missingTypeWarned = {};
    function renderCellByField(o) {
      o = o || {};
      var fid = o.fid != null ? String(o.fid) : "";
      var t = String(o.type || "").trim().toLowerCase();
      if (!t) {
        if (fid && !_missingTypeWarned[fid]) {
          _missingTypeWarned[fid] = 1;
          console.warn("[FieldsAPI] Missing Fields meta for fid=" + fid + " (type undefined).", o);
        }
        t = "text";
        o.editable = false;
      }
      var fname = String(o.name || o.field_name || "").toLowerCase();

      // Preview (single thumb) parity: any *view column + any versions column.
      if (t === "versions" || t === "shotview" || /view$/.test(fname)) {
        return R_preview_single(o);
      }


      // Normalize *_link types to entity_link for rendering.
      if (t && t !== "entity_link" && /_link$/i.test(t)) { t = "entity_link"; }
      switch (t) {
        case "id": return R_id(o);
        case "text": return R_text(o);
        case "date": return R_date(o);
        case "checkbox": return R_checkbox(o);
        case "select": return R_select(o);
        case "json": return R_json(o);
        case "entity_name": return R_entity_name(o);
        case "entity_link": return R_entity_link(o);
        case "originals": return R_originals(o);
        case "file_list": return R_file_list(o);
        case "thumbnails": return R_thumbnails(o);
        case "versions": return R_versions(o);
        default: return R_text(o);
      }
    }

    /* ========= 4. entry ========= */

    /* ===== 4B.applyData shim (ADD) ===== */
    // Define a minimal applyData early.
    // Prevent crashes when listRowsPage calls applyData before Table loads.
    window.applyData = window.applyData || function (p) {
      try {
        if (!window.STATE) window.STATE = {};
        var STATE = window.STATE;

        if (!p || typeof p !== 'object') return;

        var rawIds = Array.isArray(p.ids) ? p.ids.slice() : [];
        var rawHeader = Array.isArray(p.header) ? p.header.slice() : [];
        var rawRows = Array.isArray(p.rows) ? p.rows.slice() : [];
        var rawTotal = (typeof p.total === 'number') ? p.total : (parseInt(p.total, 10) || 0);
        var rawColumns = Array.isArray(p.columns) ? p.columns.slice() : null;

        function cleanColumns(ids, header, rows, columns) {
          var n = Math.max(ids.length, header.length);
          var keep = new Array(n);
          for (var i = 0; i < n; i++) {
            var fid = (i < ids.length) ? ids[i] : null;
            keep[i] = !!fid && String(fid).trim() !== '';
          }

          var outIds = [];
          var outHeader = [];
          var outCols = columns ? [] : null;

          for (var j = 0; j < n; j++) {
            if (!keep[j]) continue;
            outIds.push((j < ids.length) ? ids[j] : null);
            outHeader.push((j < header.length && header[j] != null) ? header[j] : '');
            if (outCols) outCols.push((j < columns.length) ? columns[j] : null);
          }

          var outRows = (rows || []).map(function (r) {
            var rr = [];
            for (var k = 0; k < n; k++) {
              if (!keep[k]) continue;
              rr.push((r && Array.isArray(r) && k < r.length) ? r[k] : '');
            }
            return rr;
          });

          return { ids: outIds, header: outHeader, rows: outRows, columns: outCols };
        }

        var sanitized = cleanColumns(rawIds, rawHeader, rawRows, rawColumns);

        STATE.fieldIds = sanitized.ids;
        STATE.header = sanitized.header;
        STATE.rows = sanitized.rows;
        STATE.total = rawTotal;

        // Critical for Table: columns + fieldsMeta must be available.
        STATE.columns = Array.isArray(sanitized.columns) ? sanitized.columns : (Array.isArray(p.columns) ? p.columns : []);
        STATE.fieldsMeta = {};

        function parseOptionsAny(val) {
          if (Array.isArray(val)) return val.slice();
          if (val == null) return [];
          var s = String(val);
          return s.split(/[\n\r|,]+/).map(function (x) { return String(x == null ? "" : x).trim(); }).filter(Boolean);
        }

        if (Array.isArray(STATE.columns) && STATE.columns.length) {
          for (var c = 0; c < STATE.columns.length; c++) {
            var col = STATE.columns[c];
            if (!col || typeof col !== 'object') continue;

            var fid2 = col.fid || col.field_id || col.fieldId || col.id || sanitized.ids[c];
            if (!fid2) continue;

            var m = {};
            try { Object.assign(m, col); } catch (_) { }
            m.fid = String(fid2);
            if (m.id == null) m.id = String(fid2);
            if (m.field_id == null) m.field_id = String(fid2);

            if (m.name == null || m.name === '') {
              m.name = (sanitized.header[c] != null) ? String(sanitized.header[c]) : String(fid2);
            }
            if (m.label == null || m.label === '') m.label = String(m.name);
            if (m.type == null || String(m.type).trim() === '') m.type = 'text';

            m.editable = (col.editable === true);
            m.required = (col.required === true);

            if (m.options != null && !Array.isArray(m.options)) m.options = parseOptionsAny(m.options);
            if (m.options == null) m.options = [];

            STATE.fieldsMeta[fid2] = m;
          }
        } else {
          // Fallback meta (should be rare if server returns columns)
          for (var x = 0; x < sanitized.ids.length; x++) {
            var fid3 = sanitized.ids[x];
            if (!fid3) continue;
            var isId = String(fid3) === 'fi_0001';
            STATE.fieldsMeta[fid3] = {
              fid: String(fid3),
              name: (sanitized.header[x] != null) ? String(sanitized.header[x]) : String(fid3),
              type: isId ? 'id' : 'text',
              editable: !isId
            };
          }
        }

        if (typeof window.updatePagerUI === 'function') window.updatePagerUI();
        if (typeof window.persistViewerStateSnapshot === 'function') window.persistViewerStateSnapshot();
      } catch (e) {
        try { console.warn('[CommonRenderer] applyData shim failed', e); } catch (_) { }
      }
    };
    /* ========= 5. misc ========= */
    function getLabel(fid) { return (window.PAGE_LABELS && PAGE_LABELS[fid]) || (fid || ""); }
    function attachCellEditor() { return null; }
    function hydrateLinks() { /* NOTE: legacy comment removed */ }

    /* ========= 5B. Link Picker Modal ========= */
    function _ensureLinkPickerUI_() {
      if (document.getElementById("motkLinkPicker")) return;

      var backdrop = document.createElement("div");
      backdrop.id = "motkLinkPickerBackdrop";
      backdrop.className = "motk-modal-backdrop";
      backdrop.style.display = "none";

      var panel = document.createElement("div");
      panel.id = "motkLinkPicker";
      panel.className = "motk-center-modal motk-link-picker";
      panel.setAttribute("role", "dialog");
      panel.setAttribute("aria-modal", "true");
      panel.setAttribute("aria-hidden", "true");
      panel.style.display = "none";
      panel.innerHTML = [
        '<div class="hd">Select Links</div>',
        '<div class="bd">',
        '  <input class="q" type="search" placeholder="Search by name or id" />',
        '  <div class="msg" aria-live="polite"></div>',
        '  <div class="list" role="listbox" aria-multiselectable="true"></div>',
        '</div>',
        '<div class="ft">',
        '  <button type="button" class="btn cancel">Cancel</button>',
        '  <button type="button" class="btn apply">Apply</button>',
        '</div>'
      ].join("");

      document.body.appendChild(backdrop);
      document.body.appendChild(panel);
    }

    function _delimiterFor_(raw) {
      var s = String(raw == null ? "" : raw);
      if (s.indexOf("|") >= 0) return "|";
      if (s.indexOf(",") >= 0) return ",";
      if (s.indexOf(";") >= 0) return ";";
      return " ";
    }

    function _bucketForEntity_(entity) {
      var e = String(entity || "").toLowerCase().trim();
      if (e === "asset" || e === "assets") return "assets";
      if (e === "task" || e === "tasks") return "tasks";
      if (e === "user" || e === "users") return "users";
      if (e === "member" || e === "members" || e === "projectmembers" || e === "projectmember") return "members";
      return "shots";
    }

    function _targetEntityFromType_(type, fid, currentIds) {
      var t = String(type || "").toLowerCase().trim();
      if (t && t !== "entity_link" && /_link$/.test(t)) {
        var base = t.replace(/_link$/, "");
        if (base === "shot" || base === "asset" || base === "task" || base === "user" || base === "member") return base;
      }
      var first = (currentIds && currentIds.length) ? String(currentIds[0]) : "";
      return fidToEntity(String(fid || ""), first);
    }

    function openLinkPicker(opts) {
      opts = opts || {};
      var fid = String(opts.fid || "");
      var type = String(opts.type || "");
      var raw = String(opts.value == null ? "" : opts.value);
      var current = parseList(raw);
      var delimiter = _delimiterFor_(raw);

      return ensureLinkMaps().then(function () {
        _ensureLinkPickerUI_();

        var panel = document.getElementById("motkLinkPicker");
        var backdrop = document.getElementById("motkLinkPickerBackdrop");
        var q = panel.querySelector("input.q");
        var list = panel.querySelector(".list");
        var btnCancel = panel.querySelector("button.cancel");
        var btnApply = panel.querySelector("button.apply");

        var targetEntity = _targetEntityFromType_(type, fid, current);
        var bucket = _bucketForEntity_(targetEntity);
        var map = (window.LINK_MAPS && window.LINK_MAPS[bucket]) ? window.LINK_MAPS[bucket] : {};

        function _isValidRecordIdForEntity(entity, id) {
          id = String(id || "");
          var e = String(entity || "");

          // entity-specific prefixes (do NOT allow header labels)
          if (e === "shot")   return /^sh_[0-9]{4,}$/.test(id);
          if (e === "asset")  return /^as_[0-9]{4,}$/.test(id);
          if (e === "task")   return /^tk_[0-9]{4,}$/.test(id);
          if (e === "user")   return /^us_[0-9]{4,}$/.test(id);
          if (e === "page")   return /^pg_[0-9]{4,}$/.test(id);

          // member has legacy alias mb_ but normalized to pm_ elsewhere
          if (e === "member") return /^(pm|mb)_[0-9]{4,}$/.test(id);

          // fallback (still exclude field IDs)
          if (/^fi_[0-9]{4,}$/.test(id)) return false;
          return /^[a-z]{2}_[0-9]{4,}$/.test(id);
        }

        var ids = Object.keys(map || {}).filter(function (id) {
          return _isValidRecordIdForEntity(targetEntity, id);
        });

        var items = ids.map(function (id) {
          return { id: String(id), name: String(map[id] == null ? id : map[id]) };
        });
        items.sort(function (a, b) { return a.name.localeCompare(b.name); });

        var selected = {};
        current.forEach(function (id) { selected[String(id)] = 1; });

        function render(query) {
          query = String(query || "").trim().toLowerCase();
          list.innerHTML = "";
          var max = 500;
          var n = 0;
          for (var i = 0; i < items.length; i++) {
            var it = items[i];
            if (query) {
              if (it.id.toLowerCase().indexOf(query) === -1 && it.name.toLowerCase().indexOf(query) === -1) continue;
            }
            var row = document.createElement("label");
            row.className = "row";

            var cb = document.createElement("input");
            cb.type = "checkbox";
            cb.checked = !!selected[it.id];
            cb.addEventListener("change", function (id) {
              return function (e) {
                if (e.target.checked) selected[id] = 1;
                else delete selected[id];
              };
            }(it.id));

            var text = document.createElement("span");
            text.className = "txt";
            text.textContent = it.name + " (" + it.id + ")";

            row.appendChild(cb);
            row.appendChild(text);
            list.appendChild(row);

            n++;
            if (n >= max) break;
          }
        }

        function close() {
          document.body.classList.remove("motk-modal-open");
          panel.setAttribute("aria-hidden", "true");
          panel.style.display = "none";
          backdrop.style.display = "none";
        }

        function open() {
          document.body.classList.add("motk-modal-open");
          panel.setAttribute("aria-hidden", "false");
          panel.style.display = "block";
          backdrop.style.display = "block";
          q.value = "";
          render("");
          try { q.focus(); } catch (_) { }
        }

        return new Promise(function (resolve) {
          var msg = panel.querySelector(".msg");
          if (msg) msg.textContent = "";

          function setBusy(isBusy, message) {
            try {
              btnCancel.disabled = !!isBusy;
              btnApply.disabled = !!isBusy;
              if (msg) msg.textContent = message ? String(message) : "";
            } catch (_) { }
          }

          setBusy(false, "");

          function onCancel() {
            setBusy(false, "");
            cleanup();
            close();
            resolve({ cancelled: true, ids: current.slice(), value: raw });
          }
          function onApply() {
            var ids = Object.keys(selected);
            ids.sort();
            var val = ids.join(delimiter);
            var out = { cancelled: false, ids: ids, value: val, delimiter: delimiter, targetEntity: targetEntity };

            if (typeof opts.commit === "function") {
              setBusy(true, "Saving...");
              Promise.resolve()
                .then(function () { return opts.commit(out); })
                .then(function () {
                  cleanup();
                  close();
                  resolve(out);
                })
                .catch(function (err) {
                  var msgText = (err && err.message) ? err.message : String(err);
                  setBusy(false, "Save failed: " + msgText);
                });
              return;
            }

            cleanup();
            close();
            resolve(out);
          }
          function onBackdrop(e) {
            if (e.target === backdrop) onCancel();
          }
          function onKey(e) {
            if (e.key === "Escape") onCancel();
          }
          function cleanup() {
            setBusy(false, "");
            backdrop.removeEventListener("click", onBackdrop);
            document.removeEventListener("keydown", onKey);
            btnCancel.removeEventListener("click", onCancel);
            btnApply.removeEventListener("click", onApply);
            q.removeEventListener("input", onInput);
          }
          function onInput() { render(q.value); }

          backdrop.addEventListener("click", onBackdrop);
          document.addEventListener("keydown", onKey);
          btnCancel.addEventListener("click", onCancel);
          btnApply.addEventListener("click", onApply);
          q.addEventListener("input", onInput);

          open();
        });
      });
    }

    /* ========= 6. export ========= */
    function getFieldOptions(fid, meta) {
      try {
        if (meta && meta.options != null) return Array.isArray(meta.options) ? meta.options.slice() : String(meta.options || '').split(/[\n\r|,]+/).map(function (x) { return String(x == null ? "" : x).trim(); }).filter(Boolean);
      } catch (_) { }
      try {
        var m = (window.STATE && STATE.fieldsMeta && STATE.fieldsMeta[fid]) ? STATE.fieldsMeta[fid] : null;
        if (m && m.options != null) return Array.isArray(m.options) ? m.options.slice() : String(m.options || '').split(/[\n\r|,]+/).map(function (x) { return String(x == null ? "" : x).trim(); }).filter(Boolean);
      } catch (_) { }
      return [];
    }

    function normalizeDateValue(value) {
      try {
        if (value == null || value === '') return '';
        var s = isoDateOnly(value);
        return /^\d{4}-\d{2}-\d{2}$/.test(s) ? s : '';
      } catch (_) { }
      return '';
    }

    window.FieldsAPI = { renderCellByField, getLabel, getFieldOptions, normalizeDateValue, attachCellEditor, hydrateLinks, ensureLinkMaps, openLinkPicker };

    window.CommonRenderer = window.CommonRenderer || {};
    if (typeof window.CommonRenderer.renderCellByField !== "function") {
      window.CommonRenderer.renderCellByField = function (entity, fieldId, value, meta) {
        meta = meta || {};
        var rowId = meta.__rowId || meta.rowId || meta.recordId || meta.id || "";
        var recordId = meta.recordId || meta.rowId || meta.id || rowId || "";
        var row = meta.__row || (rowId ? { fi_0001: rowId, id: rowId, ID: rowId } : (window.STATE && STATE.row ? STATE.row : null));
        return window.FieldsAPI.renderCellByField({
          fid: String(fieldId || ""),
          fieldId: String(fieldId || ""),
          type: meta.type,
          val: value,
          editable: !!meta.editable,
          entity: entity,
          rowId: rowId,
          recordId: recordId,
          id: recordId,
          row: row || {},
          field: meta || null,
          label: meta.label,
          name: meta.name
        });
      };
    }
    if (typeof window.CommonRenderer.refreshPendingPreviews !== "function") {
      window.CommonRenderer.refreshPendingPreviews = function (_root) {
        try { if (typeof window.__MOTK_PROXY_PREVIEW_REFRESH__ === "function") window.__MOTK_PROXY_PREVIEW_REFRESH__(); } catch (_) { }
      };
    }

    (function installMotkPreviewModalOnce(){
      if (window.__MOTK_PREVIEW_MODAL_INSTALLED__) return;
      window.__MOTK_PREVIEW_MODAL_INSTALLED__ = true;

      function ensureModal_(){
        if (document.getElementById("motkPreviewModal")) return;

        var modal = document.createElement("div");
        modal.id = "motkPreviewModal";
        modal.className = "motk-preview-modal hidden";
        modal.innerHTML =
          '<div class="motk-preview-backdrop" data-motk-close="1"></div>' +
          '<div class="motk-preview-dialog" role="dialog" aria-modal="true">' +
            '<button class="motk-preview-close" type="button" data-motk-close="1">×</button>' +
            '<div class="motk-preview-body"></div>' +
          '</div>';

        document.body.appendChild(modal);

        modal.addEventListener("click", function(ev){
          var t = ev.target;
          if (t && t.getAttribute && t.getAttribute("data-motk-close") === "1") {
            closeModal_();
          }
        });
      }

      function isVideo_(mime, name){
        mime = String(mime || "").toLowerCase();
        name = String(name || "").toLowerCase();
        if (mime.indexOf("video/") === 0) return true;
        return /\.(mp4|webm|mov|m4v|avi)$/.test(name);
      }

      function openModal_(opts){
        ensureModal_();
        var modal = document.getElementById("motkPreviewModal");
        var body = modal.querySelector(".motk-preview-body");
        body.innerHTML = "";

        var src = String((opts && opts.media) || "");
        var name = String((opts && opts.name) || "");
        var mime = String((opts && opts.mime) || "");

        if (!src) {
          body.appendChild(document.createTextNode("No preview source."));
        } else if (isVideo_(mime, name)) {
          var v = document.createElement("video");
          v.controls = true;
          v.autoplay = true;
          v.playsInline = true;
          v.src = src;
          body.appendChild(v);
        } else {
          var img = document.createElement("img");
          img.src = src;
          img.alt = name || "preview";
          body.appendChild(img);
        }

        modal.classList.remove("hidden");
        document.body.classList.add("motk-modal-open");
      }

      function closeModal_(){
        var modal = document.getElementById("motkPreviewModal");
        if (!modal) return;
        var body = modal.querySelector(".motk-preview-body");
        if (body) body.innerHTML = "";
        modal.classList.add("hidden");
        document.body.classList.remove("motk-modal-open");
      }

      document.addEventListener("keydown", function(ev){
        if (ev.key === "Escape") closeModal_();
      });

      document.addEventListener("click", function(ev){
        var t = ev.target;
        var node = t && t.closest ? t.closest('[data-motk-proxy-thumb="1"]') : null;
        if (!node) return;

        ev.preventDefault();
        ev.stopPropagation();

        openModal_({
          media: node.getAttribute("data-proxy-media") || "",
          name: node.getAttribute("data-proxy-name") || "",
          mime: node.getAttribute("data-proxy-mime") || ""
        });
      });

      window.__MOTK_OPEN_PREVIEW_MODAL__ = openModal_;
      window.__MOTK_CLOSE_PREVIEW_MODAL__ = closeModal_;
    })();

    ensureLinkMaps().catch(function () { });
  })();




</script>
