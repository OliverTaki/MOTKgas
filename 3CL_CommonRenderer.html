<!-- ===== FieldsAPI (strict, type-driven, full file) ===== -->
<script>
  (function () {
    "use strict";

    /* ========= 0. helpers ========= */
    function gsr() { return (window.google && google.script && google.script.run) || null; }
    function tryCall(names, args) {
      return new Promise(function (resolve, reject) {
        var r = gsr(); if (!r) return reject(new Error("gsr missing"));
        (function next(i) {
          if (i >= names.length) return reject(new Error("no api"));
          var fn = names[i]; if (typeof r[fn] !== "function") return next(i + 1);
          r.withSuccessHandler(resolve).withFailureHandler(function () { next(i + 1); })[fn](args);
        })(0);
      });
    }
    function el(tag, cls, text) {
      var n = document.createElement(tag);
      if (cls) n.className = cls;
      if (text != null) n.textContent = String(text);
      return n;
    }
    function chip(href, label, newTab) {
      var a = el("a", "chip", label || href || "");
      if (href) a.href = href;
      /* FIX: when newTab=true, always open in a new tab with noopener+noreferrer */
      if (newTab) { 
          a.target = "_blank"; 
          a.rel = "noopener noreferrer"; 
      }
      return a;
    }
    function parseList(val) {
      if (Array.isArray(val)) return val;
      var s = (val == null ? "" : String(val));
      return s.split(/[,;\s/|]+/).map(function (t) { return t.trim(); }).filter(Boolean);
    }
    function driveUrlFromId(id, kind) {
      if (!id) return "";
      if (kind === "file") return "https://drive.google.com/file/d/" + id + "/view";
      return "https://drive.google.com/drive/folders/" + id;
    }
    function extractDriveId(s) {
      if (!s) return "";
      var m = String(s).match(/[a-zA-Z0-9_-]{25,}/);
      return m ? m[0] : "";
    }
    function isoDateOnly(s) {
      if (!s) return "";
      var d = (s instanceof Date) ? s : new Date(s);
      if (isNaN(d.getTime())) return String(s);
      var y = d.getFullYear(), m = ("0" + (d.getMonth() + 1)).slice(0 - 2), da = ("0" + d.getDate()).slice(0 - 2);
      return y + "-" + m + "-" + da;
    }
    function bucketOf(entity) {
      return entity === "asset" ? "assets" :
        entity === "task" ? "tasks" :
          entity === "user" ? "users" :
            entity === "member" ? "members" : "shots";
    }
    function fidToEntity(fid, fallbackId) {
      if (window.KNOWN_LINK_FIELD_IDS && window.KNOWN_LINK_FIELD_IDS[fid]) return window.KNOWN_LINK_FIELD_IDS[fid];
      if (/asset/i.test(fid)) return "asset";
      if (/task/i.test(fid)) return "task";
      if (/user/i.test(fid)) return "user";
      if (/member/i.test(fid)) return "member";
      if (/shot/i.test(fid)) return "shot";
      
      /* FIX: id prefix mapping (tk_, pm_) */
      var val = String(fallbackId || "").trim();
      if (/^as[_-]/i.test(val)) return "asset";
      if (/^tk[_-]/i.test(val)) return "task";   // Normalize legacy id prefix (ta -> tk).
      if (/^us[_-]/i.test(val)) return "user";
      if (/^pm[_-]/i.test(val)) return "member"; // Normalize legacy id prefix (mb -> pm).
      if (/^sh[_-]/i.test(val)) return "shot";
      
      return "shot";
    }

    window.KNOWN_LINK_FIELD_IDS = Object.assign({
      fi_0061: "asset", fi_0062: "task", fi_0063: "shot", fi_0064: "task", fi_0065: "asset"
    }, window.KNOWN_LINK_FIELD_IDS || {});

    window.LINK_MAPS = Object.assign({ assets: {}, shots: {}, tasks: {}, users: {}, members: {} }, window.LINK_MAPS || {});

    var SCRIPT_URL = (function () {
      try { return null; } catch (e) { return null; }
    })() || (window.__SCRIPT_URL__ || (location.origin + location.pathname));

    var Router = window.__Router__ || {};

    Router.baseUrl = function () { return SCRIPT_URL; };

    Router.pageUrl = function (params) {
      var url = new URL(SCRIPT_URL);
      Object.keys(params || {}).forEach(function (k) {
        if (params[k] != null && params[k] !== "") {
          url.searchParams.set(k, params[k]);
        }
      });
      return url.toString();
    };

    Router.entityPageName = function (entity) {
      /* FIX: page name mapping for all entities */
      var e = String(entity || "").toLowerCase().trim();
      if (!e) return "Dashboard";
      if (e === "shot" || e === "shots") return "Shots";
      if (e === "asset" || e === "assets") return "Assets";
      if (e === "task" || e === "tasks") return "Tasks";
      if (e === "user" || e === "users") return "Users";
      if (e === "member" || e === "members" || e === "projectmember" || e === "projectmembers") return "ProjectMembers";
      return "Dashboard";
    };

    Router.detailPageNameForEntity = function (entity) {
      /* FIX: route all entities to the correct Detail page */
      var e = String(entity || "").toLowerCase().trim();
      if (!e) return "Dashboard";
      if (e === "shot" || e === "shots") return "DetailShot";
      if (e === "asset" || e === "assets") return "DetailAsset";
      if (e === "task" || e === "tasks") return "DetailTask";
      if (e === "user" || e === "users") return "DetailUser";
      if (e === "member" || e === "members" || e === "projectmember" || e === "projectmembers") return "DetailMember";
      
      // Default fallback.
      return "DetailShot";
    };

    // Detail entity URL builder
    // NOTE: v2 omits ts and uses only page/entity/id.
    Router.buildEntityUrl = function (entity, id, opts) {
      if (!entity || !id) return SCRIPT_URL;
      var params = Object.assign(
        {
          page: Router.detailPageNameForEntity(entity),
          entity: entity,
          id: id
        },
        opts || {}
      );
      return Router.pageUrl(params);
    };

    Router.current = function () {
      try {
        var url = new URL(location.href);
        var q = Object.fromEntries(url.searchParams.entries());
        return {
          page: q.page || "",
          entity: q.entity || "",
          id: q.id || ""
        };
      } catch (e) {
        return { page: "", entity: "", id: "" };
      }
    };

    Router.navTo = function (params) {
      location.href = Router.pageUrl(params);
    };

    window.__Router__ = Router;

    async function ensureLinkMaps() {
      var need = ["assets", "shots", "tasks", "users", "members"].some(function (k) {
        return !window.LINK_MAPS[k] || !Object.keys(window.LINK_MAPS[k]).length;
      });
      if (!need) return window.LINK_MAPS;
      try {
        var maps = await tryCall(["sv_getLinkMaps", "getLinkMaps"], null);
        if (maps && typeof maps === "object") {
          ["assets", "shots", "tasks", "users", "members"].forEach(function (k) {
            if (!window.LINK_MAPS[k]) window.LINK_MAPS[k] = {};
            Object.assign(window.LINK_MAPS[k], maps[k] || {});
          });
        }
      } catch (_) { }
      return window.LINK_MAPS;
    }

    /* ========= 2. Originals resolver ========= */
    async function resolveOriginalsUrl(ctx) {
      var apis = [
        "sv_getOriginalsFolderUrl", "getOriginalsFolderUrl",
        "sv_getOriginalsUrl", "getOriginalsUrl",
        "sv_findOriginalsFolder", "findOriginalsFolder",
        "sv_resolveOriginals", "resolveOriginals"
      ];
      for (var i = 0; i < apis.length; i++) {
        try {
          var res = await tryCall([apis[i]], { entity: ctx.entity, id: ctx.id, fid: ctx.fid, value: ctx.val, row: ctx.row });
          if (typeof res === "string" && /^https?:\/\//i.test(res)) return res;
          if (res && typeof res === "object") {
            if (res.url) return res.url;
            var folderId = res.folderId || res.driveId || res.id;
            var fileId = res.fileId;
            if (folderId) return driveUrlFromId(folderId, "folder");
            if (fileId) return driveUrlFromId(fileId, "file");
          }
        } catch (_) { }
      }
      var id = extractDriveId(ctx.val);
      return id ? driveUrlFromId(id, "folder") : "";
    }

    /* ========= 3. renderers ========= */
    function R_id(o) {
      var s = el("span", null, o.val == null ? "" : String(o.val));
      s.setAttribute("data-raw", o.val == null ? "" : String(o.val));
      return s;
    }
    function R_text(o) { return document.createTextNode(o.val == null ? "" : String(o.val)); }
    function R_date(o) { return document.createTextNode(isoDateOnly(o.val)); }
    function R_checkbox(o) {
      var input = el("input"); input.type = "checkbox";
      var v = o.val;
      var checked = (v === true) || (typeof v === "number" && v !== 0) ||
        (/^(true|yes|on|1)$/i.test(String(v || "")));
      input.checked = !!checked;
      input.disabled = !o.editable;
      return input;
    }
    function R_select(o) {
      return document.createTextNode(o.val == null ? "" : String(o.val));
    }
    function R_json(o) {
      var pre = el("pre", "json");
      try { pre.textContent = JSON.stringify(typeof o.val === "string" ? JSON.parse(o.val) : o.val, null, 2); }
      catch (_) { pre.textContent = String(o.val == null ? "" : o.val); }
      return pre;
    }
    function R_entity_name(o) {
      var entity = fidToEntity(o.fid, String(o.val || ""));
      var bucket = bucketOf(entity);
      var key = String(o.val || "");
      var name = (window.LINK_MAPS[bucket] || {})[key] || key;
      return el("span", null, name);
    }
    function R_entity_link(o) {
      var entity = o.linkEntity ? String(o.linkEntity) : fidToEntity(o.fid, String(o.val || ""));
      var ids = parseList(o.val);
      var box = el("span");
      if (!ids.length) { box.appendChild(document.createTextNode("")); return box; }
      var map = window.LINK_MAPS[bucketOf(entity)] || {};
      ids.forEach(function (id, i) {
        var label = map[id] || id;
        box.appendChild(chip(Router.buildEntityUrl(entity, id), label, false));
        if (i < ids.length - 1) box.appendChild(document.createTextNode(" "));
      });
      return box;
    }
    function R_originals(o) {
      /* FIX: originals chip opens in a new tab */
      var a = chip("", "Loading Originals...", true);
      a.setAttribute("data-pending", "1");
      var ctx = {
        entity: o.entity || "shot",
        id: (o.row && (o.row.fi_0001 || o.row.id || o.row.ID)) || "",
        fid: o.fid, val: o.val, row: o.row || {}
      };
      resolveOriginalsUrl(ctx).then(function (url) {
        if (url) { a.href = url; a.textContent = "Open Originals"; }
        else { a.textContent = "(Originals not found)"; a.removeAttribute("href"); }
        a.removeAttribute("data-pending");
      }).catch(function () {
        a.textContent = "(Originals not found)";
        a.removeAttribute("href"); a.removeAttribute("data-pending");
      });
      return a;
    }
    function R_file_list(o) {
      var items = [];
      try {
        if (typeof o.val === "string" && /^\s*\[/.test(o.val)) items = JSON.parse(o.val) || [];
        else if (Array.isArray(o.val)) items = o.val;
        else items = parseList(o.val);
      } catch (_) { items = parseList(o.val); }
      var box = el("span");
      if (!items.length) { box.appendChild(document.createTextNode("")); return box; }
      items.forEach(function (it, i) {
        var href = "", label = "", kind = "";
        if (typeof it === "string") {
          if (/^https?:\/\//i.test(it)) { href = it; label = it; }
          else { href = driveUrlFromId(extractDriveId(it), "file"); label = it; }
        } else if (it && typeof it === "object") {
          label = it.name || it.url || it.id || "";
          if (it.url) href = it.url;
          else if (it.id) href = driveUrlFromId(it.id, it.kind === "folder" ? "folder" : "file");
          else if (it.fileId) href = driveUrlFromId(it.fileId, "file");
          else if (it.folderId || it.driveId) href = driveUrlFromId(it.folderId || it.driveId, "folder");
        }
        box.appendChild(href ? chip(href, label, true) : el("span", null, label));
        if (i < items.length - 1) box.appendChild(document.createTextNode(" "));
      });
      return box;
    }
    function R_thumbnails(o) {
      var list = parseList(o.val);
      var box = el("div", "thumbs");
      list.forEach(function (tok) {
        var url = /^https?:\/\//i.test(tok) ? tok : ("https://drive.google.com/thumbnail?sz=w256&id=" + extractDriveId(tok));
        var img = el("img", "thumb"); img.loading = "lazy"; img.decoding = "async"; img.src = url;
        /* FIX: wrap thumbnails in a link (new tab, noopener+noreferrer) */
        var a = el("a"); a.href = url; a.target = "_blank"; a.rel = "noopener noreferrer"; a.appendChild(img);
        box.appendChild(a);
      });
      return box;
    }
    function R_versions(o) {
      var list = parseList(o.val);
      var box = el("span");
      list.forEach(function (v, i) {
        var t = chip("", String(v), false); t.classList.add("tag");
        t.removeAttribute("href"); t.removeAttribute("target"); t.removeAttribute("rel");
        box.appendChild(t);
        if (i < list.length - 1) box.appendChild(document.createTextNode(" "));
      });
      return box;
    }

    /* ========= 4. entry ========= */
    var _missingTypeWarned = {};
    function renderCellByField(o) {
      o = o || {};
      var fid = o.fid != null ? String(o.fid) : "";
      var t = String(o.type || "").trim().toLowerCase();
      if (!t) {
        if (fid && !_missingTypeWarned[fid]) {
          _missingTypeWarned[fid] = 1;
          console.warn("[FieldsAPI] Missing Fields meta for fid=" + fid + " (type undefined).", o);
        }
        t = "text";
        o.editable = false;
      }
      var fname = String(o.name || o.field_name || "").toLowerCase();

      // Render shotview via shared path (same policy as Table).
      if (fname === "shotview" || t === "shotview") {
        var el = document.createElement("span");
        el.textContent = "";

        var row = o.row || {};
        var sid = row["Shot ID"] || row["id"] || row["shot_id"] || row["sh_id"] || row["shid"] || "";

        // 1) Render from cache first (Table-provided).
        try {
          if (sid && window.PROXY_CACHE && window.PROXY_CACHE[sid]) {
            var urlC = window.PROXY_CACHE[sid];
            var idmC = (String(urlC).match(/[-\w]{25,}/) || [])[0] || "";
            var thumbC = idmC ? ("https://drive.google.com/thumbnail?id=" + idmC + "&sz=w320") : urlC;
            
            /* FIX: wrap image link with noreferrer */
            var a = document.createElement("a");
            a.href = urlC;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            
            var img = document.createElement("img");
            img.loading = "lazy"; img.decoding = "async";
            img.style.cssText = "width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:6px";
            img.src = thumbC;
            a.appendChild(img);
            el.appendChild(a);
            
            return el;
          }
        } catch (_) { }

        // 2) Fallback: one-off resolve via Apps Script.
        (async function () {
          function best(res) {
            try {
              if (!res) return "";
              if (typeof res === "string") return res;
              if (Array.isArray(res) && res.length) {
                var a = res[0]; if (a.url) return a.url; if (a.previewUrl) return a.previewUrl; if (a.id) return "https://drive.google.com/file/d/" + a.id + "/view";
              }
              if (res.previewUrl) return res.previewUrl;
              if (res.url) return res.url;
              if (res.items && Array.isArray(res.items) && res.items.length) {
                var b = res.items[0]; if (b.url) return b.url; if (b.id) return "https://drive.google.com/file/d/" + b.id + "/view";
              }
            } catch (_) { }
            return "";
          }
          try {
            var apis = [
              ["sv_listEntityProxies", { id: sid }],
              ["sv_getShotProxies", { id: sid }],
              ["sv_getShotviewUrls", { id: sid }],
              ["sv_getPreviewUrl", { id: sid }],
              ["getPreviewUrl", { id: sid }]
            ];
            var url = "";
            for (var i = 0; i < apis.length; i++) {
              try {
                var res = await tryCall([apis[i][0]], apis[i][1]);
                url = best(res);
                if (url) break;
              } catch (_) { }
            }
            if (url) {
              try { if (window.PROXY_CACHE) window.PROXY_CACHE[sid] = url; } catch (_) { }
              var idm = (String(url).match(/[-\w]{25,}/) || [])[0] || "";
              var thumb = idm ? ("https://drive.google.com/thumbnail?id=" + idm + "&sz=w320") : url;
              
              /* FIX: async load uses <a> with noreferrer */
              el.innerHTML = '<a href="' + url + '" target="_blank" rel="noopener noreferrer"><img loading="lazy" decoding="async" style="width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:6px" src="' + thumb + '"></a>';
            } else {
              el.textContent = "";
            }
          } catch (_) {
            el.textContent = "";
          }
        })();

        return el;
      }


      // Normalize *_link types to entity_link for rendering.
      if (t && t !== "entity_link" && /_link$/i.test(t)) { t = "entity_link"; }
      switch (t) {
        case "id": return R_id(o);
        case "text": return R_text(o);
        case "date": return R_date(o);
        case "checkbox": return R_checkbox(o);
        case "select": return R_select(o);
        case "json": return R_json(o);
        case "entity_name": return R_entity_name(o);
        case "entity_link": return R_entity_link(o);
        case "originals": return R_originals(o);
        case "file_list": return R_file_list(o);
        case "thumbnails": return R_thumbnails(o);
        case "versions": return R_versions(o);
        default: return R_text(o);
      }
    }

    /* ========= 4. entry ========= */

    /* ===== 4B.applyData shim (ADD) ===== */
    // Define a minimal applyData early.
    // Prevent crashes when listRowsPage calls applyData before Table loads.
    window.applyData = window.applyData || function (p) {
      try {
        if (!window.STATE) window.STATE = {};
        var STATE = window.STATE;

        if (!p || typeof p !== 'object') return;

        var rawIds = Array.isArray(p.ids) ? p.ids.slice() : [];
        var rawHeader = Array.isArray(p.header) ? p.header.slice() : [];
        var rawRows = Array.isArray(p.rows) ? p.rows.slice() : [];
        var rawTotal = (typeof p.total === 'number') ? p.total : (parseInt(p.total, 10) || 0);
        var rawColumns = Array.isArray(p.columns) ? p.columns.slice() : null;

        function cleanColumns(ids, header, rows, columns) {
          var n = Math.max(ids.length, header.length);
          var keep = new Array(n);
          for (var i = 0; i < n; i++) {
            var fid = (i < ids.length) ? ids[i] : null;
            keep[i] = !!fid && String(fid).trim() !== '';
          }

          var outIds = [];
          var outHeader = [];
          var outCols = columns ? [] : null;

          for (var j = 0; j < n; j++) {
            if (!keep[j]) continue;
            outIds.push((j < ids.length) ? ids[j] : null);
            outHeader.push((j < header.length && header[j] != null) ? header[j] : '');
            if (outCols) outCols.push((j < columns.length) ? columns[j] : null);
          }

          var outRows = (rows || []).map(function (r) {
            var rr = [];
            for (var k = 0; k < n; k++) {
              if (!keep[k]) continue;
              rr.push((r && Array.isArray(r) && k < r.length) ? r[k] : '');
            }
            return rr;
          });

          return { ids: outIds, header: outHeader, rows: outRows, columns: outCols };
        }

        var sanitized = cleanColumns(rawIds, rawHeader, rawRows, rawColumns);

        STATE.fieldIds = sanitized.ids;
        STATE.header = sanitized.header;
        STATE.rows = sanitized.rows;
        STATE.total = rawTotal;

        // Critical for Table: columns + fieldsMeta must be available.
        STATE.columns = Array.isArray(sanitized.columns) ? sanitized.columns : (Array.isArray(p.columns) ? p.columns : []);
        STATE.fieldsMeta = {};

        if (Array.isArray(STATE.columns) && STATE.columns.length) {
          for (var c = 0; c < STATE.columns.length; c++) {
            var col = STATE.columns[c];
            if (!col || typeof col !== 'object') continue;

            var fid2 = col.fid || col.field_id || sanitized.ids[c];
            if (!fid2) continue;

            STATE.fieldsMeta[fid2] = {
              fid: String(fid2),
              name: (col.name != null) ? String(col.name) :
                ((sanitized.header[c] != null) ? String(sanitized.header[c]) : String(fid2)),
              type: (col.type != null) ? String(col.type) : 'text',
              editable: col.editable === true,
              target: (col.target != null) ? String(col.target) : null
            };
          }
        } else {
          // Fallback meta (should be rare if server returns columns)
          for (var x = 0; x < sanitized.ids.length; x++) {
            var fid3 = sanitized.ids[x];
            if (!fid3) continue;
            var isId = String(fid3) === 'fi_0001';
            STATE.fieldsMeta[fid3] = {
              fid: String(fid3),
              name: (sanitized.header[x] != null) ? String(sanitized.header[x]) : String(fid3),
              type: isId ? 'id' : 'text',
              editable: !isId
            };
          }
        }

        if (typeof window.updatePagerUI === 'function') window.updatePagerUI();
        if (typeof window.persistViewerStateSnapshot === 'function') window.persistViewerStateSnapshot();
      } catch (e) {
        try { console.warn('[CommonRenderer] applyData shim failed', e); } catch (_) { }
      }
    };
    /* ========= 5. misc ========= */
    function getLabel(fid) { return (window.PAGE_LABELS && PAGE_LABELS[fid]) || (fid || ""); }
    function attachCellEditor() { return null; }
    function hydrateLinks() { /* NOTE: legacy comment removed */ }

    /* ========= 5B. Link Picker Modal ========= */
    function _ensureLinkPickerUI_() {
      if (document.getElementById("motkLinkPicker")) return;

      var backdrop = document.createElement("div");
      backdrop.id = "motkLinkPickerBackdrop";
      backdrop.className = "motk-modal-backdrop";
      backdrop.style.display = "none";

      var panel = document.createElement("div");
      panel.id = "motkLinkPicker";
      panel.className = "motk-center-modal motk-link-picker";
      panel.setAttribute("role", "dialog");
      panel.setAttribute("aria-modal", "true");
      panel.setAttribute("aria-hidden", "true");
      panel.style.display = "none";
      panel.innerHTML = [
        '<div class="hd">Select Links</div>',
        '<div class="bd">',
        '  <input class="q" type="search" placeholder="Search by name or id" />',
        '  <div class="msg" aria-live="polite"></div>',
        '  <div class="list" role="listbox" aria-multiselectable="true"></div>',
        '</div>',
        '<div class="ft">',
        '  <button type="button" class="btn cancel">Cancel</button>',
        '  <button type="button" class="btn apply">Apply</button>',
        '</div>'
      ].join("");

      document.body.appendChild(backdrop);
      document.body.appendChild(panel);
    }

    function _delimiterFor_(raw) {
      var s = String(raw == null ? "" : raw);
      if (s.indexOf("|") >= 0) return "|";
      if (s.indexOf(",") >= 0) return ",";
      if (s.indexOf(";") >= 0) return ";";
      return " ";
    }

    function _bucketForEntity_(entity) {
      var e = String(entity || "").toLowerCase().trim();
      if (e === "asset" || e === "assets") return "assets";
      if (e === "task" || e === "tasks") return "tasks";
      if (e === "user" || e === "users") return "users";
      if (e === "member" || e === "members" || e === "projectmembers" || e === "projectmember") return "members";
      return "shots";
    }

    function _targetEntityFromType_(type, fid, currentIds) {
      var t = String(type || "").toLowerCase().trim();
      if (t && t !== "entity_link" && /_link$/.test(t)) {
        var base = t.replace(/_link$/, "");
        if (base === "shot" || base === "asset" || base === "task" || base === "user" || base === "member") return base;
      }
      var first = (currentIds && currentIds.length) ? String(currentIds[0]) : "";
      return fidToEntity(String(fid || ""), first);
    }

    function openLinkPicker(opts) {
      opts = opts || {};
      var fid = String(opts.fid || "");
      var type = String(opts.type || "");
      var raw = String(opts.value == null ? "" : opts.value);
      var current = parseList(raw);
      var delimiter = _delimiterFor_(raw);

      return ensureLinkMaps().then(function () {
        _ensureLinkPickerUI_();

        var panel = document.getElementById("motkLinkPicker");
        var backdrop = document.getElementById("motkLinkPickerBackdrop");
        var q = panel.querySelector("input.q");
        var list = panel.querySelector(".list");
        var btnCancel = panel.querySelector("button.cancel");
        var btnApply = panel.querySelector("button.apply");

        var targetEntity = _targetEntityFromType_(type, fid, current);
        var bucket = _bucketForEntity_(targetEntity);
        var map = (window.LINK_MAPS && window.LINK_MAPS[bucket]) ? window.LINK_MAPS[bucket] : {};

        function _isValidRecordIdForEntity(entity, id) {
          id = String(id || "");
          var e = String(entity || "");

          // entity-specific prefixes (do NOT allow header labels)
          if (e === "shot")   return /^sh_[0-9]{4,}$/.test(id);
          if (e === "asset")  return /^as_[0-9]{4,}$/.test(id);
          if (e === "task")   return /^tk_[0-9]{4,}$/.test(id);
          if (e === "user")   return /^us_[0-9]{4,}$/.test(id);
          if (e === "page")   return /^pg_[0-9]{4,}$/.test(id);

          // member has legacy alias mb_ but normalized to pm_ elsewhere
          if (e === "member") return /^(pm|mb)_[0-9]{4,}$/.test(id);

          // fallback (still exclude field IDs)
          if (/^fi_[0-9]{4,}$/.test(id)) return false;
          return /^[a-z]{2}_[0-9]{4,}$/.test(id);
        }

        var ids = Object.keys(map || {}).filter(function (id) {
          return _isValidRecordIdForEntity(targetEntity, id);
        });

        var items = ids.map(function (id) {
          return { id: String(id), name: String(map[id] == null ? id : map[id]) };
        });
        items.sort(function (a, b) { return a.name.localeCompare(b.name); });

        var selected = {};
        current.forEach(function (id) { selected[String(id)] = 1; });

        function render(query) {
          query = String(query || "").trim().toLowerCase();
          list.innerHTML = "";
          var max = 500;
          var n = 0;
          for (var i = 0; i < items.length; i++) {
            var it = items[i];
            if (query) {
              if (it.id.toLowerCase().indexOf(query) === -1 && it.name.toLowerCase().indexOf(query) === -1) continue;
            }
            var row = document.createElement("label");
            row.className = "row";

            var cb = document.createElement("input");
            cb.type = "checkbox";
            cb.checked = !!selected[it.id];
            cb.addEventListener("change", function (id) {
              return function (e) {
                if (e.target.checked) selected[id] = 1;
                else delete selected[id];
              };
            }(it.id));

            var text = document.createElement("span");
            text.className = "txt";
            text.textContent = it.name + " (" + it.id + ")";

            row.appendChild(cb);
            row.appendChild(text);
            list.appendChild(row);

            n++;
            if (n >= max) break;
          }
        }

        function close() {
          document.body.classList.remove("motk-modal-open");
          panel.setAttribute("aria-hidden", "true");
          panel.style.display = "none";
          backdrop.style.display = "none";
        }

        function open() {
          document.body.classList.add("motk-modal-open");
          panel.setAttribute("aria-hidden", "false");
          panel.style.display = "block";
          backdrop.style.display = "block";
          q.value = "";
          render("");
          try { q.focus(); } catch (_) { }
        }

        return new Promise(function (resolve) {
          var msg = panel.querySelector(".msg");
          if (msg) msg.textContent = "";

          function setBusy(isBusy, message) {
            try {
              btnCancel.disabled = !!isBusy;
              btnApply.disabled = !!isBusy;
              if (msg) msg.textContent = message ? String(message) : "";
            } catch (_) { }
          }

          function onCancel() {
            cleanup();
            close();
            resolve({ cancelled: true, ids: current.slice(), value: raw });
          }
          function onApply() {
            var ids = Object.keys(selected);
            ids.sort();
            var val = ids.join(delimiter);
            var out = { cancelled: false, ids: ids, value: val, delimiter: delimiter, targetEntity: targetEntity };

            if (typeof opts.commit === "function") {
              setBusy(true, "Saving...");
              Promise.resolve()
                .then(function () { return opts.commit(out); })
                .then(function () {
                  cleanup();
                  close();
                  resolve(out);
                })
                .catch(function (err) {
                  var msgText = (err && err.message) ? err.message : String(err);
                  setBusy(false, "Save failed: " + msgText);
                });
              return;
            }

            cleanup();
            close();
            resolve(out);
          }
          function onBackdrop(e) {
            if (e.target === backdrop) onCancel();
          }
          function onKey(e) {
            if (e.key === "Escape") onCancel();
          }
          function cleanup() {
            backdrop.removeEventListener("click", onBackdrop);
            document.removeEventListener("keydown", onKey);
            btnCancel.removeEventListener("click", onCancel);
            btnApply.removeEventListener("click", onApply);
            q.removeEventListener("input", onInput);
          }
          function onInput() { render(q.value); }

          backdrop.addEventListener("click", onBackdrop);
          document.addEventListener("keydown", onKey);
          btnCancel.addEventListener("click", onCancel);
          btnApply.addEventListener("click", onApply);
          q.addEventListener("input", onInput);

          open();
        });
      });
    }

    /* ========= 6. export ========= */
    window.FieldsAPI = { renderCellByField, getLabel, attachCellEditor, hydrateLinks, ensureLinkMaps, openLinkPicker };
    ensureLinkMaps().catch(function () { });
  })();




</script>
