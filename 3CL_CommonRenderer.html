<!-- ===== FieldsAPI (strict, type-driven, full file) ===== -->
<script>
  (function () {
    "use strict";

    /* ========= 0. helpers ========= */
    function gsr() { return (window.google && google.script && google.script.run) || null; }
    function tryCall(names, args) {
      return new Promise(function (resolve, reject) {
        var r = gsr(); if (!r) return reject(new Error("gsr missing"));
        (function next(i) {
          if (i >= names.length) return reject(new Error("no api"));
          var fn = names[i]; if (typeof r[fn] !== "function") return next(i + 1);
          r.withSuccessHandler(resolve).withFailureHandler(function () { next(i + 1); })[fn](args);
        })(0);
      });
    }
    function el(tag, cls, text) {
      var n = document.createElement(tag);
      if (cls) n.className = cls;
      if (text != null) n.textContent = String(text);
      return n;
    }
    function chip(href, label, newTab) {
      var a = el("a", "chip", label || href || "");
      if (href) a.href = href;
      /* FIX: when newTab=true, always open in a new tab with noopener+noreferrer */
      if (newTab) { 
          a.target = "_blank"; 
          a.rel = "noopener noreferrer"; 
      }
      return a;
    }
    function parseList(val) {
      if (Array.isArray(val)) return val;
      var s = (val == null ? "" : String(val));
      return s.split(/[,;\s/|]+/).map(function (t) { return t.trim(); }).filter(Boolean);
    }
    function driveUrlFromId(id, kind) {
      if (!id) return "";
      if (kind === "file") return "https://drive.google.com/file/d/" + id + "/view";
      return "https://drive.google.com/drive/folders/" + id;
    }
    function extractDriveId(s) {
      if (!s) return "";
      var m = String(s).match(/[a-zA-Z0-9_-]{25,}/);
      return m ? m[0] : "";
    }
    function isoDateOnly(s) {
      if (!s) return "";
      var d = (s instanceof Date) ? s : new Date(s);
      if (isNaN(d.getTime())) return String(s);
      var y = d.getFullYear(), m = ("0" + (d.getMonth() + 1)).slice(0 - 2), da = ("0" + d.getDate()).slice(0 - 2);
      return y + "-" + m + "-" + da;
    }
    function bucketOf(entity) {
      return entity === "asset" ? "assets" :
        entity === "task" ? "tasks" :
          entity === "user" ? "users" :
            entity === "member" ? "members" : "shots";
    }
    function fidToEntity(fid, fallbackId) {
      if (window.KNOWN_LINK_FIELD_IDS && window.KNOWN_LINK_FIELD_IDS[fid]) return window.KNOWN_LINK_FIELD_IDS[fid];
      if (/asset/i.test(fid)) return "asset";
      if (/task/i.test(fid)) return "task";
      if (/user/i.test(fid)) return "user";
      if (/member/i.test(fid)) return "member";
      if (/shot/i.test(fid)) return "shot";
      
      /* FIX: id prefix mapping (tk_, pm_) */
      var val = String(fallbackId || "").trim();
      if (/^as[_-]/i.test(val)) return "asset";
      if (/^tk[_-]/i.test(val)) return "task";   // Normalize legacy id prefix (ta -> tk).
      if (/^us[_-]/i.test(val)) return "user";
      if (/^pm[_-]/i.test(val)) return "member"; // Normalize legacy id prefix (mb -> pm).
      if (/^sh[_-]/i.test(val)) return "shot";
      
      return "shot";
    }

    window.KNOWN_LINK_FIELD_IDS = Object.assign({
      fi_0061: "asset", fi_0062: "task", fi_0063: "shot", fi_0064: "task", fi_0065: "asset"
    }, window.KNOWN_LINK_FIELD_IDS || {});

    window.LINK_MAPS = Object.assign({ assets: {}, shots: {}, tasks: {}, users: {}, members: {} }, window.LINK_MAPS || {});

    var SCRIPT_URL = (function () {
      try { return null; } catch (e) { return null; }
    })() || (window.__SCRIPT_URL__ || (location.origin + location.pathname));

    var Router = window.__Router__ || {};

    Router.baseUrl = function () { return SCRIPT_URL; };

    Router.pageUrl = function (params) {
      var url = new URL(SCRIPT_URL);
      Object.keys(params || {}).forEach(function (k) {
        if (params[k] != null && params[k] !== "") {
          url.searchParams.set(k, params[k]);
        }
      });
      return url.toString();
    };

    Router.entityPageName = function (entity) {
      /* FIX: page name mapping for all entities */
      var e = String(entity || "").toLowerCase().trim();
      if (!e) return "Dashboard";
      if (e === "shot" || e === "shots") return "Shots";
      if (e === "asset" || e === "assets") return "Assets";
      if (e === "task" || e === "tasks") return "Tasks";
      if (e === "user" || e === "users") return "Users";
      if (e === "member" || e === "members" || e === "projectmember" || e === "projectmembers") return "ProjectMembers";
      return "Dashboard";
    };

    Router.detailPageNameForEntity = function (entity) {
      /* FIX: route all entities to the correct Detail page */
      var e = String(entity || "").toLowerCase().trim();
      if (!e) return "Dashboard";
      if (e === "shot" || e === "shots") return "DetailShot";
      if (e === "asset" || e === "assets") return "DetailAsset";
      if (e === "task" || e === "tasks") return "DetailTask";
      if (e === "user" || e === "users") return "DetailUser";
      if (e === "member" || e === "members" || e === "projectmember" || e === "projectmembers") return "DetailMember";
      
      // Default fallback.
      return "DetailShot";
    };

    // Detail entity URL builder
    // NOTE: v2 omits ts and uses only page/entity/id.
    Router.buildEntityUrl = function (entity, id, opts) {
      if (!entity || !id) return SCRIPT_URL;
      var params = Object.assign(
        {
          page: Router.detailPageNameForEntity(entity),
          entity: entity,
          id: id
        },
        opts || {}
      );
      return Router.pageUrl(params);
    };

    Router.current = function () {
      try {
        var url = new URL(location.href);
        var q = Object.fromEntries(url.searchParams.entries());
        return {
          page: q.page || "",
          entity: q.entity || "",
          id: q.id || ""
        };
      } catch (e) {
        return { page: "", entity: "", id: "" };
      }
    };

    Router.navTo = function (params) {
      location.href = Router.pageUrl(params);
    };

    window.__Router__ = Router;

    async function ensureLinkMaps() {
      var need = ["assets", "shots", "tasks", "users", "members"].some(function (k) {
        return !window.LINK_MAPS[k] || !Object.keys(window.LINK_MAPS[k]).length;
      });
      if (!need) return window.LINK_MAPS;
      try {
        var maps = await tryCall(["sv_getLinkMaps", "getLinkMaps"], null);
        if (maps && typeof maps === "object") {
          ["assets", "shots", "tasks", "users", "members"].forEach(function (k) {
            if (!window.LINK_MAPS[k]) window.LINK_MAPS[k] = {};
            Object.assign(window.LINK_MAPS[k], maps[k] || {});
          });
        }
      } catch (_) { }
      return window.LINK_MAPS;
    }

    /* ========= 2. Originals resolver ========= */
    async function resolveOriginalsUrl(ctx) {
      var apis = [
        "sv_getOriginalsFolderUrl", "getOriginalsFolderUrl",
        "sv_getOriginalsUrl", "getOriginalsUrl",
        "sv_findOriginalsFolder", "findOriginalsFolder",
        "sv_resolveOriginals", "resolveOriginals"
      ];
      for (var i = 0; i < apis.length; i++) {
        try {
          var res = await tryCall([apis[i]], { entity: ctx.entity, id: ctx.id, fid: ctx.fid, value: ctx.val, row: ctx.row });
          if (typeof res === "string" && /^https?:\/\//i.test(res)) return res;
          if (res && typeof res === "object") {
            if (res.url) return res.url;
            var folderId = res.folderId || res.driveId || res.id;
            var fileId = res.fileId;
            if (folderId) return driveUrlFromId(folderId, "folder");
            if (fileId) return driveUrlFromId(fileId, "file");
          }
        } catch (_) { }
      }
      var id = extractDriveId(ctx.val);
      return id ? driveUrlFromId(id, "folder") : "";
    }

    /* ========= 3. renderers ========= */
    function R_id(o) {
      var s = el("span", null, o.val == null ? "" : String(o.val));
      s.setAttribute("data-raw", o.val == null ? "" : String(o.val));
      return s;
    }
    function R_text(o) { return document.createTextNode(o.val == null ? "" : String(o.val)); }
    function R_date(o) { return document.createTextNode(isoDateOnly(o.val)); }
    function R_checkbox(o) {
      var input = el("input"); input.type = "checkbox";
      var v = o.val;
      var checked = (v === true) || (typeof v === "number" && v !== 0) ||
        (/^(true|yes|on|1)$/i.test(String(v || "")));
      input.checked = !!checked;
      input.disabled = !o.editable;
      return input;
    }
    function R_select(o) {
      return document.createTextNode(o.val == null ? "" : String(o.val));
    }
    function R_json(o) {
      var pre = el("pre", "json");
      try { pre.textContent = JSON.stringify(typeof o.val === "string" ? JSON.parse(o.val) : o.val, null, 2); }
      catch (_) { pre.textContent = String(o.val == null ? "" : o.val); }
      return pre;
    }
    function R_entity_name(o) {
      var entity = fidToEntity(o.fid, String(o.val || ""));
      var bucket = bucketOf(entity);
      var key = String(o.val || "");
      var name = (window.LINK_MAPS[bucket] || {})[key] || key;
      return el("span", null, name);
    }
    function R_entity_link(o) {
      var entity = o.linkEntity ? String(o.linkEntity) : fidToEntity(o.fid, String(o.val || ""));
      var ids = parseList(o.val);
      var box = el("span");
      if (!ids.length) { box.appendChild(document.createTextNode("")); return box; }
      var map = window.LINK_MAPS[bucketOf(entity)] || {};
      ids.forEach(function (id, i) {
        var label = map[id] || id;
        box.appendChild(chip(Router.buildEntityUrl(entity, id), label, false));
        if (i < ids.length - 1) box.appendChild(document.createTextNode(" "));
      });
      return box;
    }
    function R_originals(o) {
      window.__MOTK_ORIGINALS_CACHE = window.__MOTK_ORIGINALS_CACHE || {};

      var a = chip("#", "Open", true);
      var token = (Date.now().toString(36) + ":" + Math.random().toString(36).slice(2));
      a.setAttribute("data-orig-token", token);
      var ctx = {
        entity: o.entity || "shot",
        id: (o.row && (o.row.fi_0001 || o.row.id || o.row.ID)) || "",
        fid: o.fid, val: o.val, row: o.row || {}
      };

      a.setAttribute("data-originals-entity", String(ctx.entity || ""));
      a.setAttribute("data-originals-id", String(ctx.id || ""));
      a.setAttribute("data-originals-state", "idle"); // idle|loading|resolved|failed

      function isCurrent() {
        try {
          if (a.getAttribute("data-orig-token") !== token) return false;
          if (!document.body || !document.body.contains(a)) return false;
        } catch (_) { return false; }
        return true;
      }

      function cacheKey() {
        return String(ctx.entity || "") + ":" + String(ctx.id || "");
      }

      function setState(next, text, href) {
        if (!isCurrent()) return;
        try {
          a.setAttribute("data-originals-state", next);
          if (typeof text === "string") a.textContent = text;
          if (href) a.href = href;
          else a.setAttribute("href", "#");
        } catch (_) { }
      }

      a.addEventListener("click", function (e) {
        try { if (e && e.preventDefault) e.preventDefault(); } catch (_) { }
        try { if (e && e.stopPropagation) e.stopPropagation(); } catch (_) { }

        if (!isCurrent()) return;

        var state = "";
        try { state = a.getAttribute("data-originals-state") || ""; } catch (_) { }
        if (state === "loading") return;

        // Take21: click-first UX (new tab immediately, then resolve and redirect)
        // Take22: avoid document.write (can trigger "Invalid regular expression flags" in some runtimes)
        var win = null;
        try {
          win = window.open("about:blank", "_blank");
          if (win) {
            try { win.document.title = "Resolving Originals…"; } catch (_) { }
            try {
              var doc = win.document;
              var body = doc && doc.body ? doc.body : null;
              if (body) {
                body.innerHTML = "<h3>Resolving Originals…</h3><p>Please wait.</p>";
                try { body.style.fontFamily = "system-ui"; body.style.margin = "24px"; } catch (_) { }
              }
            } catch (_) { }
          }
        } catch (_) { win = null; }

        var key = cacheKey();
        var cached = "";
        try { cached = key && window.__MOTK_ORIGINALS_CACHE[key] ? String(window.__MOTK_ORIGINALS_CACHE[key]) : ""; } catch (_) { cached = ""; }
        if (cached) {
          setState("resolved", "Open", cached);
          try { if (win) win.location.href = cached; } catch (_) { }
          return;
        }

        if (!ctx.id) {
          setState("failed", "Originals not found", "");
          try { if (typeof showError === "function") showError("Originals not found (missing id)"); } catch (_) { }
          if (win) {
            try { win.document.body.innerHTML = "<h3>Originals not found</h3><p>Missing record id.</p>"; } catch (_) { }
          }
          return;
        }

        setState("loading", "Loading Originals...", "");

        resolveOriginalsUrl(ctx).then(function (url) {
          if (!isCurrent()) return;
          url = (typeof url === "string") ? url : "";
          if (url && /^https?:\/\//i.test(url)) {
            try { window.__MOTK_ORIGINALS_CACHE[key] = url; } catch (_) { }
            setState("resolved", "Open", url);
            try { a.target = "_blank"; } catch (_) { }
            try { a.dataset.url = url; } catch (_) { }
            try { a.setAttribute("title", url); } catch (_) { }
            try { if (win) win.location.href = url; } catch (_) { }
          } else {
            setState("failed", "Originals not found", "");
            try { if (typeof showError === "function") showError("Originals not found"); } catch (_) { }
            if (win) {
              try { win.document.body.innerHTML = "<h3>Originals not found</h3><p>No URL was returned.</p>"; } catch (_) { }
            }
          }
        }).catch(function (err) {
          if (!isCurrent()) return;
          setState("failed", "Originals not found", "");
          try {
            if (typeof showError === "function") showError("Originals resolve failed: " + String(err && err.message ? err.message : err));
          } catch (_) { }
          if (win) {
            try { win.document.body.innerHTML = "<h3>Originals resolve failed</h3><pre>" + String(err) + "</pre>"; } catch (_) { }
          }
        });
      }, true);
      return a;
    }
    function R_file_list(o) {
      var items = [];
      try {
        if (typeof o.val === "string" && /^\s*\[/.test(o.val)) items = JSON.parse(o.val) || [];
        else if (Array.isArray(o.val)) items = o.val;
        else items = parseList(o.val);
      } catch (_) { items = parseList(o.val); }
      var box = el("span");
      if (!items.length) { box.appendChild(document.createTextNode("")); return box; }
      items.forEach(function (it, i) {
        var href = "", label = "", kind = "";
        if (typeof it === "string") {
          if (/^https?:\/\//i.test(it)) { href = it; label = it; }
          else { href = driveUrlFromId(extractDriveId(it), "file"); label = it; }
        } else if (it && typeof it === "object") {
          label = it.name || it.url || it.id || "";
          if (it.url) href = it.url;
          else if (it.id) href = driveUrlFromId(it.id, it.kind === "folder" ? "folder" : "file");
          else if (it.fileId) href = driveUrlFromId(it.fileId, "file");
          else if (it.folderId || it.driveId) href = driveUrlFromId(it.folderId || it.driveId, "folder");
        }
        box.appendChild(href ? chip(href, label, true) : el("span", null, label));
        if (i < items.length - 1) box.appendChild(document.createTextNode(" "));
      });
      return box;
    }
    function R_thumbnails(o) {
      var list = parseList(o.val);
      var box = el("div", "thumbs");
      list.forEach(function (tok) {
        var id = extractDriveId(tok);
        var thumbUrl = /^https?:\/\//i.test(tok) ? tok : ("https://drive.google.com/thumbnail?sz=w256&id=" + id);
        var mediaUrl = id ? _motk_driveOpenUrl_(id) : thumbUrl;
        var img = el("img", "thumb"); img.loading = "lazy"; img.decoding = "async"; img.src = thumbUrl;
        var btn = el("button", "motk-media-trigger-btn");
        btn.type = "button";
        btn.setAttribute("data-motk-media-trigger", "1");
        btn.setAttribute("data-motk-media-src", String(mediaUrl || ""));
        btn.setAttribute("data-motk-media-title", "");
        btn.setAttribute("data-motk-media-mime", "");
        btn.appendChild(img);
        box.appendChild(btn);
      });
      return box;
    }

    function _previewRecordId_(o) {
      try {
        var rid0 = (o && (o.recordId || o.rowId || o.id)) ? (o.recordId || o.rowId || o.id) : "";
        if (rid0) return String(rid0 || "");
        var row = (o && o.row) ? o.row : null;
        var rid = row && (row.fi_0001 || row.id || row.ID) ? (row.fi_0001 || row.id || row.ID) : "";
        return String(rid || "");
      } catch (_) { }
      return "";
    }

    function _previewFieldId_(o) {
      try {
        var fid = (o && (o.fieldId || o.fid)) ? (o.fieldId || o.fid) : "";
        return String(fid || "");
      } catch (_) { }
      return "";
    }

    function _proxyEntryFromCache_(recordId, fieldId) {
      recordId = String(recordId || "").trim();
      fieldId = String(fieldId || "").trim();
      if (!recordId) return null;
      try {
        var byField = window.PROXY_CACHE_BY_FIELD || null;
        if (byField && fieldId) {
          var k = recordId + "|" + fieldId;
          if (byField[k]) return byField[k];
        }
      } catch (_) { }
      try {
        var cache = window.PROXY_CACHE || null;
        if (!cache) return null;
        return cache[recordId] || null;
      } catch (_) { }
      return null;
    }

    function _proxyUrlFromCache_(recordId, fieldId) {
      recordId = String(recordId || "");
      if (!recordId) return "";
      try {
        var v = _proxyEntryFromCache_(recordId, fieldId);
        if (!v) return "";
        if (typeof v === "string") return v;
        if (v && typeof v === "object") {
          if (v.url) return String(v.url);
          if (v.previewUrl) return String(v.previewUrl);
          if (v.id) return "https://drive.google.com/uc?export=download&id=" + encodeURIComponent(String(v.id));
        }
      } catch (_) { }
      return "";
    }

    function _thumbFromProxyUrl_(url) {
      try {
        url = String(url || "");
        var idm = (url.match(/[-\\w]{25,}/) || [])[0] || "";
        if (idm) return "https://drive.google.com/thumbnail?id=" + encodeURIComponent(idm) + "&sz=w320";
      } catch (_) { }
      return String(url || "");
    }

    function _renderVersionsFallback_(o) {
      var list = parseList(o.val);
      var box = el("span");
      list.forEach(function (v, i) {
        var t = chip("", String(v), false); t.classList.add("tag");
        t.removeAttribute("href"); t.removeAttribute("target"); t.removeAttribute("rel");
        box.appendChild(t);
        if (i < list.length - 1) box.appendChild(document.createTextNode(" "));
      });
      if (!list.length) box.appendChild(document.createTextNode("—"));
      return box;
    }

    function _motk_driveIdFromAny_(any){
      var s = String(any || "");

      // 1) id=... (uc/open links)
      var m = s.match(/[?&]id=([-\\w]{10,})/);
      if (m && m[1]) return m[1];

      // 2) /file/d/...
      m = s.match(/\\/file\\/d\\/([-\\w]{10,})/);
      if (m && m[1]) return m[1];

      // 3) fallback: first long-ish token (Drive file ids are typically 25+)
      m = s.match(/[-\\w]{25,}/);
      return (m && m[0]) ? m[0] : "";
    }

    function _motk_guessExt_(name, url, mime){
      name = String(name || "");
      url = String(url || "");
      mime = String(mime || "").toLowerCase();

      function extFrom_(s){
        try {
          var base = String(s || "").split("?")[0].split("#")[0];
          var i = base.lastIndexOf(".");
          if (i >= 0 && i < base.length - 1) return base.slice(i + 1).toLowerCase();
        } catch (_) { }
        return "";
      }

      var fromName = extFrom_(name);
      if (fromName) return fromName;

      var fromUrl = extFrom_(url);
      if (fromUrl) return fromUrl;

      if (mime.indexOf("image/") === 0) return mime.slice("image/".length);
      if (mime.indexOf("video/") === 0) return mime.slice("video/".length);
      return "";
    }

    function _motk_isImageExt_(ext){
      var e = String(ext || "").toLowerCase();
      return (["png","jpg","jpeg","gif","webp","bmp","svg"].indexOf(e) >= 0);
    }

    function _motk_isVideoExt_(ext){
      var e = String(ext || "").toLowerCase();
      return (["mp4","webm","ogg","mov","m4v"].indexOf(e) >= 0);
    }

    // Drive URL builders
    function _motk_drivePreviewUrl_(id){
      return "https://drive.google.com/file/d/" + encodeURIComponent(String(id || "")) + "/preview";
    }
    function _motk_driveOpenUrl_(id){
      return "https://drive.google.com/file/d/" + encodeURIComponent(String(id || "")) + "/view";
    }
    function _motk_driveDownloadUrl_(id){
      return "https://drive.google.com/uc?export=download&id=" + encodeURIComponent(String(id || ""));
    }
    function _motk_driveViewUrl_(id){
      return "https://drive.google.com/uc?export=view&id=" + encodeURIComponent(String(id || ""));
    }

    function _driveThumbUrl_(id) {
      if (!id) return "";
      return "https://drive.google.com/thumbnail?id=" + encodeURIComponent(id) + "&sz=w320";
    }

    // NOTE: legacy Drive normalization helpers removed (Take34)

    // Media Modal (Proxy Viewer) — Drive-safe + full-fit
    (function() {
      if (window.__MOTK_MEDIA_MODAL_INSTALLED__) return;
      window.__MOTK_MEDIA_MODAL_INSTALLED__ = true;

      function _motk_str_(v) { return (v === null || v === undefined) ? "" : String(v); }
      function _motk_lower_(v) { return _motk_str_(v).toLowerCase(); }

      function _motk_extFromTitle_(title) {
        const t = _motk_str_(title).trim();
        const i = t.lastIndexOf(".");
        if (i < 0) return "";
        return t.slice(i + 1).toLowerCase();
      }

      function _motk_extFromUrl_(url) {
        const u = _motk_str_(url);
        const m = u.match(/\.([a-zA-Z0-9]{2,5})(?:[\?#]|$)/);
        return m ? m[1].toLowerCase() : "";
      }

      function _motk_driveIdFromAny_(s) {
        const str = _motk_str_(s);

        // /file/d/{id}/...
        let m = str.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
        if (m) return m[1];

        // ?id={id}
        m = str.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (m) return m[1];

        // Loose token (Drive IDs are typically 25+ chars)
        m = str.match(/(^|[^a-zA-Z0-9_-])([a-zA-Z0-9_-]{25,})($|[^a-zA-Z0-9_-])/);
        if (m) return m[2];

        return null;
      }

      function _motk_isDriveUrl_(url) {
        const u = _motk_lower_(url);
        return u.indexOf("drive.google.com") >= 0 || u.indexOf("docs.google.com") >= 0;
      }

      function _motk_isVideo_(url, title, mime) {
        const ext = _motk_extFromTitle_(title) || _motk_extFromUrl_(url);
        const m = _motk_lower_(mime);
        if (m.indexOf("video/") === 0) return true;
        return ["mp4","mov","webm","m4v","ogv"].indexOf(ext) >= 0;
      }

      function _motk_isImage_(url, title, mime) {
        const ext = _motk_extFromTitle_(title) || _motk_extFromUrl_(url);
        const m = _motk_lower_(mime);
        if (m.indexOf("image/") === 0) return true;
        return ["png","jpg","jpeg","gif","webp","bmp","svg"].indexOf(ext) >= 0;
      }

      function _motk_drivePreviewUrl_(id) { return "https://drive.google.com/file/d/" + id + "/preview"; }
      function _motk_driveViewUrl_(id) { return "https://drive.google.com/file/d/" + id + "/view"; }
      function _motk_driveImageViewUrl_(id) { return "https://drive.google.com/uc?export=view&id=" + id; }

      const STATE = {
        mounted: false,
        ignoreBackdropUntil: 0
      };

      const DOM = {
        root: null,
        backdrop: null,
        modal: null,
        title: null,
        body: null,
        openLink: null,
        closeBtn: null
      };

      function _motk_mountMediaModalOnce_() {
        if (STATE.mounted) return;

        const root = document.createElement("div");
        root.id = "motk-media-modal-root";
        root.style.display = "none";

        const bd = document.createElement("div");
        bd.id = "motk-media-modal-backdrop";
        bd.className = "motk-media-backdrop";
        bd.style.display = "none";

        const modal = document.createElement("div");
        modal.className = "motk-media-modal";
        modal.setAttribute("role", "dialog");
        modal.setAttribute("aria-modal", "true");

        const header = document.createElement("div");
        header.className = "motk-media-modal__header";

        const titleEl = document.createElement("div");
        titleEl.className = "motk-media-modal__title";

        const actions = document.createElement("div");
        actions.className = "motk-media-modal__actions";

        const openLink = document.createElement("a");
        openLink.href = "#";
        openLink.target = "_blank";
        openLink.rel = "noopener noreferrer";
        openLink.textContent = "Open in new tab";

        const closeBtn = document.createElement("button");
        closeBtn.className = "motk-media-modal__close";
        closeBtn.type = "button";
        closeBtn.textContent = "×";

        const body = document.createElement("div");
        body.className = "motk-media-modal__body";

        actions.appendChild(openLink);
        actions.appendChild(closeBtn);

        header.appendChild(titleEl);
        header.appendChild(actions);

        modal.appendChild(header);
        modal.appendChild(body);

        bd.appendChild(modal);
        root.appendChild(bd);

        // Mount under <html>, not <body> (survive body re-render)
        document.documentElement.appendChild(root);

        bd.addEventListener("click", function(e) {
          if (Date.now() < STATE.ignoreBackdropUntil) return;
          if (e.target === bd) window.MOTK_closeMediaModal("backdrop");
        });

        closeBtn.addEventListener("click", function() {
          window.MOTK_closeMediaModal("closeBtn");
        });

        document.addEventListener("keydown", function(e) {
          if (e.key === "Escape") window.MOTK_closeMediaModal("esc");
        });

        DOM.root = root;
        DOM.backdrop = bd;
        DOM.modal = modal;
        DOM.title = titleEl;
        DOM.body = body;
        DOM.openLink = openLink;
        DOM.closeBtn = closeBtn;

        STATE.mounted = true;
      }

      function _motk_clearBody_() {
        // stop iframe/video audio if any
        const iframe = DOM.body.querySelector("iframe");
        if (iframe) iframe.src = "about:blank";

        const vid = DOM.body.querySelector("video");
        if (vid) {
          try { vid.pause(); } catch (e) {}
          try { vid.removeAttribute("src"); vid.load(); } catch (e) {}
        }

        DOM.body.innerHTML = "";
      }

      window.MOTK_openMediaModal = function(rawUrl, title, opt) {
        _motk_mountMediaModalOnce_();

        const url = _motk_str_(rawUrl);
        const ttl = _motk_str_(title);
        const mime = opt && opt.mime ? _motk_str_(opt.mime) : _motk_str_(opt);

        const driveId = _motk_driveIdFromAny_(url);
        const isDrive = !!driveId || _motk_isDriveUrl_(url);
        const isVid = _motk_isVideo_(url, ttl, mime);
        const isImg = _motk_isImage_(url, ttl, mime);

        // Header
        DOM.title.textContent = ttl || url;

        // New-tab URL should be a sane viewer URL for Drive
        if (driveId) {
          DOM.openLink.href = _motk_driveViewUrl_(driveId);
        } else {
          DOM.openLink.href = url;
        }

        _motk_clearBody_();

        let node = null;

        if (driveId) {
          // Drive-backed content:
          if (isVid) {
            const iframe = document.createElement("iframe");
            iframe.src = _motk_drivePreviewUrl_(driveId);
            iframe.setAttribute("allow", "autoplay; fullscreen");
            iframe.setAttribute("allowfullscreen", "true");
            node = iframe;
          } else if (isImg) {
            const img = document.createElement("img");
            img.src = _motk_driveImageViewUrl_(driveId);
            img.alt = ttl || "image";
            img.onerror = function() {
              // Fallback to preview iframe if image view endpoint fails
              const iframe = document.createElement("iframe");
              iframe.src = _motk_drivePreviewUrl_(driveId);
              iframe.setAttribute("allow", "fullscreen");
              iframe.setAttribute("allowfullscreen", "true");
              DOM.body.innerHTML = "";
              DOM.body.appendChild(iframe);
            };
            node = img;
          } else {
            const iframe = document.createElement("iframe");
            iframe.src = _motk_drivePreviewUrl_(driveId);
            iframe.setAttribute("allow", "fullscreen");
            iframe.setAttribute("allowfullscreen", "true");
            node = iframe;
          }
        } else {
          // Non-Drive content:
          if (isVid) {
            const video = document.createElement("video");
            video.controls = true;
            video.src = url;
            node = video;
          } else if (isImg) {
            const img = document.createElement("img");
            img.src = url;
            img.alt = ttl || "image";
            node = img;
          } else {
            const iframe = document.createElement("iframe");
            iframe.src = url;
            iframe.setAttribute("allow", "fullscreen");
            iframe.setAttribute("allowfullscreen", "true");
            node = iframe;
          }
        }

        DOM.body.appendChild(node);

        // Show
        STATE.ignoreBackdropUntil = Date.now() + 350;
        DOM.root.style.display = "block";
        DOM.backdrop.style.display = "flex";

        try {
          console.log("[MOTK_MEDIA_MODAL] open", {
            url: url,
            title: ttl,
            mime: mime,
            driveId: driveId,
            isDrive: isDrive,
            isVideo: isVid,
            isImage: isImg
          });
        } catch (_) { }
      };

      window.MOTK_closeMediaModal = function(reason) {
        if (!STATE.mounted) return;

        _motk_clearBody_();

        DOM.backdrop.style.display = "none";
        DOM.root.style.display = "none";

        try { console.log("[MOTK_MEDIA_MODAL] close reason=" + _motk_str_(reason)); } catch (_) { }
      };
    })();

    (function installMotkMediaTriggerCaptureOnce_() {
      if (window.__MOTK_MEDIA_TRIGGER_CAPTURE_INSTALLED__) return;
      window.__MOTK_MEDIA_TRIGGER_CAPTURE_INSTALLED__ = true;

      function getClosestTrigger_(t) {
        try {
          if (!t || !t.closest) return null;
          return t.closest('[data-motk-media-trigger="1"]');
        } catch (_) { }
        return null;
      }

      window.addEventListener("click", function (e) {
        try {
          var t = e && e.target;
          var trig = getClosestTrigger_(t);
          if (!trig) return;
          if (trig.closest && trig.closest("#motk-media-modal-backdrop")) return;

          var src =
            trig.getAttribute("data-motk-media-src") ||
            trig.getAttribute("data-proxy-media") ||
            trig.getAttribute("href") ||
            "";

          var title =
            trig.getAttribute("data-motk-media-title") ||
            trig.getAttribute("data-proxy-name") ||
            trig.getAttribute("title") ||
            "";

          var mime =
            trig.getAttribute("data-motk-media-mime") ||
            trig.getAttribute("data-proxy-mime") ||
            "";

          src = String(src || "");
          if (!src) return;

          e.preventDefault();
          e.stopImmediatePropagation();
          e.stopPropagation();

          try { console.log("[MOTK][MediaModal] trigger click", { url: src, title: title, ts: Date.now() }); } catch (_) { }

          if (typeof window.MOTK_openMediaModal === "function") {
            window.MOTK_openMediaModal(src, title, { mime: mime });
          } else {
            window.open(src, "_blank", "noopener");
          }
        } catch (_) { }
      }, true);
    })();

    function _fillPreviewSingle_(host, recordId, fieldId, url) {
      host.innerHTML = "";

      var entry = _proxyEntryFromCache_(recordId, fieldId);
      var driveId =
        (entry && entry.id) ? String(entry.id) :
        _motk_driveIdFromAny_(url);

      var name =
        (entry && (entry.name || entry.fileName || entry.filename)) ? String(entry.name || entry.fileName || entry.filename) : "";

      var mime =
        (entry && (entry.mimeType || entry.mime)) ? String(entry.mimeType || entry.mime) : "";

      var thumb =
        (entry && entry.thumb) ? String(entry.thumb) :
        (driveId ? _driveThumbUrl_(driveId) : _thumbFromProxyUrl_(url));

      var media = "";
      if (driveId) {
        media = _motk_driveOpenUrl_(driveId);
      } else if (entry && (entry.mediaUrl || entry.media || entry.directUrl)) {
        media = String(entry.mediaUrl || entry.media || entry.directUrl);
      } else {
        media = String(url || "");
      }

      var btn = document.createElement("button");
      btn.type = "button";
      btn.className = "motk-media-trigger-btn proxy-thumb";
      btn.title = "Open preview";
      btn.setAttribute("data-motk-media-trigger", "1");
      btn.setAttribute("data-motk-media-src", String(media || ""));
      btn.setAttribute("data-motk-media-title", String(name || ""));
      btn.setAttribute("data-motk-media-mime", String(mime || ""));

      var img = document.createElement("img");
      img.className = "thumb-img";
      img.loading = "lazy";
      img.src = thumb;

      btn.appendChild(img);
      host.appendChild(btn);
    }

    function R_preview_single(o) {
      var rid = _previewRecordId_(o);
      var fid = _previewFieldId_(o);
      var url = _proxyUrlFromCache_(rid, fid);

      var box = document.createElement("span");

      if (url) {
        _fillPreviewSingle_(box, rid, fid, url);
        return box;
      }

      // Pending: allow Table/Detail to refresh once PROXY_CACHE is populated.
      box.setAttribute("data-proxy-pending", "1");
      box.setAttribute("data-proxy-id", String(rid || ""));
      box.setAttribute("data-proxy-fid", String(fid || ""));
      if (String(o.type || "").trim().toLowerCase() === "versions") {
        box.appendChild(_renderVersionsFallback_(o));
      } else {
        box.appendChild(document.createTextNode("—"));
      }
      return box;
    }

    window.__MOTK_PROXY_PREVIEW_REFRESH__ = function () {
      try {
        var nodes = document.querySelectorAll('[data-proxy-pending="1"][data-proxy-id]');
        if (!nodes || !nodes.length) return;
        for (var i = 0; i < nodes.length; i++) {
          var host = nodes[i];
          if (!host || !host.getAttribute) continue;
          if (!document.body || !document.body.contains(host)) continue;
          var rid = host.getAttribute("data-proxy-id") || "";
          var fid = host.getAttribute("data-proxy-fid") || "";
          var url = _proxyUrlFromCache_(rid, fid);
          if (!url) continue;
          _fillPreviewSingle_(host, rid, fid, url);
          host.removeAttribute("data-proxy-pending");
        }
      } catch (_) { }
    };

    function R_versions(o) {
      return R_preview_single(o);
    }

    /* ========= 4. entry ========= */
    var _missingTypeWarned = {};
    function renderCellByField(o) {
      o = o || {};
      var fid = o.fid != null ? String(o.fid) : "";
      var t = String(o.type || "").trim().toLowerCase();
      if (!t) {
        if (fid && !_missingTypeWarned[fid]) {
          _missingTypeWarned[fid] = 1;
          console.warn("[FieldsAPI] Missing Fields meta for fid=" + fid + " (type undefined).", o);
        }
        t = "text";
        o.editable = false;
      }
      var fname = String(o.name || o.field_name || "").toLowerCase();

      // Preview (single thumb) parity: any *view column + any versions column.
      if (t === "versions" || t === "shotview" || /view$/.test(fname)) {
        return R_preview_single(o);
      }


      // Normalize *_link types to entity_link for rendering.
      if (t && t !== "entity_link" && /_link$/i.test(t)) { t = "entity_link"; }
      switch (t) {
        case "id": return R_id(o);
        case "text": return R_text(o);
        case "date": return R_date(o);
        case "checkbox": return R_checkbox(o);
        case "select": return R_select(o);
        case "json": return R_json(o);
        case "entity_name": return R_entity_name(o);
        case "entity_link": return R_entity_link(o);
        case "originals": return R_originals(o);
        case "file_list": return R_file_list(o);
        case "thumbnails": return R_thumbnails(o);
        case "versions": return R_versions(o);
        default: return R_text(o);
      }
    }

    /* ========= 4. entry ========= */

    /* ===== 4B.applyData shim (ADD) ===== */
    // Define a minimal applyData early.
    // Prevent crashes when listRowsPage calls applyData before Table loads.
    window.applyData = window.applyData || function (p) {
      try {
        if (!window.STATE) window.STATE = {};
        var STATE = window.STATE;

        if (!p || typeof p !== 'object') return;

        var rawIds = Array.isArray(p.ids) ? p.ids.slice() : [];
        var rawHeader = Array.isArray(p.header) ? p.header.slice() : [];
        var rawRows = Array.isArray(p.rows) ? p.rows.slice() : [];
        var rawTotal = (typeof p.total === 'number') ? p.total : (parseInt(p.total, 10) || 0);
        var rawColumns = Array.isArray(p.columns) ? p.columns.slice() : null;

        function cleanColumns(ids, header, rows, columns) {
          var n = Math.max(ids.length, header.length);
          var keep = new Array(n);
          for (var i = 0; i < n; i++) {
            var fid = (i < ids.length) ? ids[i] : null;
            keep[i] = !!fid && String(fid).trim() !== '';
          }

          var outIds = [];
          var outHeader = [];
          var outCols = columns ? [] : null;

          for (var j = 0; j < n; j++) {
            if (!keep[j]) continue;
            outIds.push((j < ids.length) ? ids[j] : null);
            outHeader.push((j < header.length && header[j] != null) ? header[j] : '');
            if (outCols) outCols.push((j < columns.length) ? columns[j] : null);
          }

          var outRows = (rows || []).map(function (r) {
            var rr = [];
            for (var k = 0; k < n; k++) {
              if (!keep[k]) continue;
              rr.push((r && Array.isArray(r) && k < r.length) ? r[k] : '');
            }
            return rr;
          });

          return { ids: outIds, header: outHeader, rows: outRows, columns: outCols };
        }

        var sanitized = cleanColumns(rawIds, rawHeader, rawRows, rawColumns);

        STATE.fieldIds = sanitized.ids;
        STATE.header = sanitized.header;
        STATE.rows = sanitized.rows;
        STATE.total = rawTotal;

        // Critical for Table: columns + fieldsMeta must be available.
        STATE.columns = Array.isArray(sanitized.columns) ? sanitized.columns : (Array.isArray(p.columns) ? p.columns : []);
        STATE.fieldsMeta = {};

        function parseOptionsAny(val) {
          if (Array.isArray(val)) return val.slice();
          if (val == null) return [];
          var s = String(val);
          return s.split(/[\n\r|,]+/).map(function (x) { return String(x == null ? "" : x).trim(); }).filter(Boolean);
        }

        if (Array.isArray(STATE.columns) && STATE.columns.length) {
          for (var c = 0; c < STATE.columns.length; c++) {
            var col = STATE.columns[c];
            if (!col || typeof col !== 'object') continue;

            var fid2 = col.fid || col.field_id || col.fieldId || col.id || sanitized.ids[c];
            if (!fid2) continue;

            var m = {};
            try { Object.assign(m, col); } catch (_) { }
            m.fid = String(fid2);
            if (m.id == null) m.id = String(fid2);
            if (m.field_id == null) m.field_id = String(fid2);

            if (m.name == null || m.name === '') {
              m.name = (sanitized.header[c] != null) ? String(sanitized.header[c]) : String(fid2);
            }
            if (m.label == null || m.label === '') m.label = String(m.name);
            if (m.type == null || String(m.type).trim() === '') m.type = 'text';

            m.editable = (col.editable === true);
            m.required = (col.required === true);

            if (m.options != null && !Array.isArray(m.options)) m.options = parseOptionsAny(m.options);
            if (m.options == null) m.options = [];

            STATE.fieldsMeta[fid2] = m;
          }
        } else {
          // Fallback meta (should be rare if server returns columns)
          for (var x = 0; x < sanitized.ids.length; x++) {
            var fid3 = sanitized.ids[x];
            if (!fid3) continue;
            var isId = String(fid3) === 'fi_0001';
            STATE.fieldsMeta[fid3] = {
              fid: String(fid3),
              name: (sanitized.header[x] != null) ? String(sanitized.header[x]) : String(fid3),
              type: isId ? 'id' : 'text',
              editable: !isId
            };
          }
        }

        if (typeof window.updatePagerUI === 'function') window.updatePagerUI();
        if (typeof window.persistViewerStateSnapshot === 'function') window.persistViewerStateSnapshot();
      } catch (e) {
        try { console.warn('[CommonRenderer] applyData shim failed', e); } catch (_) { }
      }
    };
    /* ========= 5. misc ========= */
    function getLabel(fid) { return (window.PAGE_LABELS && PAGE_LABELS[fid]) || (fid || ""); }
    function attachCellEditor() { return null; }
    function hydrateLinks() { /* NOTE: legacy comment removed */ }

    /* ========= 5B. Link Picker Modal ========= */
    function _ensureLinkPickerUI_() {
      if (document.getElementById("motkLinkPicker")) return;

      var backdrop = document.createElement("div");
      backdrop.id = "motkLinkPickerBackdrop";
      backdrop.className = "motk-modal-backdrop";
      backdrop.style.display = "none";

      var panel = document.createElement("div");
      panel.id = "motkLinkPicker";
      panel.className = "motk-center-modal motk-link-picker";
      panel.setAttribute("role", "dialog");
      panel.setAttribute("aria-modal", "true");
      panel.setAttribute("aria-hidden", "true");
      panel.style.display = "none";
      panel.innerHTML = [
        '<div class="hd">Select Links</div>',
        '<div class="bd">',
        '  <input class="q" type="search" placeholder="Search by name or id" />',
        '  <div class="msg" aria-live="polite"></div>',
        '  <div class="list" role="listbox" aria-multiselectable="true"></div>',
        '</div>',
        '<div class="ft">',
        '  <button type="button" class="btn cancel">Cancel</button>',
        '  <button type="button" class="btn apply">Apply</button>',
        '</div>'
      ].join("");

      document.body.appendChild(backdrop);
      document.body.appendChild(panel);
    }

    function _delimiterFor_(raw) {
      var s = String(raw == null ? "" : raw);
      if (s.indexOf("|") >= 0) return "|";
      if (s.indexOf(",") >= 0) return ",";
      if (s.indexOf(";") >= 0) return ";";
      return " ";
    }

    function _bucketForEntity_(entity) {
      var e = String(entity || "").toLowerCase().trim();
      if (e === "asset" || e === "assets") return "assets";
      if (e === "task" || e === "tasks") return "tasks";
      if (e === "user" || e === "users") return "users";
      if (e === "member" || e === "members" || e === "projectmembers" || e === "projectmember") return "members";
      return "shots";
    }

    function _targetEntityFromType_(type, fid, currentIds) {
      var t = String(type || "").toLowerCase().trim();
      if (t && t !== "entity_link" && /_link$/.test(t)) {
        var base = t.replace(/_link$/, "");
        if (base === "shot" || base === "asset" || base === "task" || base === "user" || base === "member") return base;
      }
      var first = (currentIds && currentIds.length) ? String(currentIds[0]) : "";
      return fidToEntity(String(fid || ""), first);
    }

    function openLinkPicker(opts) {
      opts = opts || {};
      var fid = String(opts.fid || "");
      var type = String(opts.type || "");
      var raw = String(opts.value == null ? "" : opts.value);
      var current = parseList(raw);
      var delimiter = _delimiterFor_(raw);

      return ensureLinkMaps().then(function () {
        _ensureLinkPickerUI_();

        var panel = document.getElementById("motkLinkPicker");
        var backdrop = document.getElementById("motkLinkPickerBackdrop");
        var q = panel.querySelector("input.q");
        var list = panel.querySelector(".list");
        var btnCancel = panel.querySelector("button.cancel");
        var btnApply = panel.querySelector("button.apply");

        var targetEntity = _targetEntityFromType_(type, fid, current);
        var bucket = _bucketForEntity_(targetEntity);
        var map = (window.LINK_MAPS && window.LINK_MAPS[bucket]) ? window.LINK_MAPS[bucket] : {};

        function _isValidRecordIdForEntity(entity, id) {
          id = String(id || "");
          var e = String(entity || "");

          // entity-specific prefixes (do NOT allow header labels)
          if (e === "shot")   return /^sh_[0-9]{4,}$/.test(id);
          if (e === "asset")  return /^as_[0-9]{4,}$/.test(id);
          if (e === "task")   return /^tk_[0-9]{4,}$/.test(id);
          if (e === "user")   return /^us_[0-9]{4,}$/.test(id);
          if (e === "page")   return /^pg_[0-9]{4,}$/.test(id);

          // member has legacy alias mb_ but normalized to pm_ elsewhere
          if (e === "member") return /^(pm|mb)_[0-9]{4,}$/.test(id);

          // fallback (still exclude field IDs)
          if (/^fi_[0-9]{4,}$/.test(id)) return false;
          return /^[a-z]{2}_[0-9]{4,}$/.test(id);
        }

        var ids = Object.keys(map || {}).filter(function (id) {
          return _isValidRecordIdForEntity(targetEntity, id);
        });

        var items = ids.map(function (id) {
          return { id: String(id), name: String(map[id] == null ? id : map[id]) };
        });
        items.sort(function (a, b) { return a.name.localeCompare(b.name); });

        var selected = {};
        current.forEach(function (id) { selected[String(id)] = 1; });

        function render(query) {
          query = String(query || "").trim().toLowerCase();
          list.innerHTML = "";
          var max = 500;
          var n = 0;
          for (var i = 0; i < items.length; i++) {
            var it = items[i];
            if (query) {
              if (it.id.toLowerCase().indexOf(query) === -1 && it.name.toLowerCase().indexOf(query) === -1) continue;
            }
            var row = document.createElement("label");
            row.className = "row";

            var cb = document.createElement("input");
            cb.type = "checkbox";
            cb.checked = !!selected[it.id];
            cb.addEventListener("change", function (id) {
              return function (e) {
                if (e.target.checked) selected[id] = 1;
                else delete selected[id];
              };
            }(it.id));

            var text = document.createElement("span");
            text.className = "txt";
            text.textContent = it.name + " (" + it.id + ")";

            row.appendChild(cb);
            row.appendChild(text);
            list.appendChild(row);

            n++;
            if (n >= max) break;
          }
        }

        function close() {
          document.body.classList.remove("motk-modal-open");
          panel.setAttribute("aria-hidden", "true");
          panel.style.display = "none";
          backdrop.style.display = "none";
        }

        function open() {
          document.body.classList.add("motk-modal-open");
          panel.setAttribute("aria-hidden", "false");
          panel.style.display = "block";
          backdrop.style.display = "block";
          q.value = "";
          render("");
          try { q.focus(); } catch (_) { }
        }

        return new Promise(function (resolve) {
          var msg = panel.querySelector(".msg");
          if (msg) msg.textContent = "";

          function setBusy(isBusy, message) {
            try {
              btnCancel.disabled = !!isBusy;
              btnApply.disabled = !!isBusy;
              if (msg) msg.textContent = message ? String(message) : "";
            } catch (_) { }
          }

          setBusy(false, "");

          function onCancel() {
            setBusy(false, "");
            cleanup();
            close();
            resolve({ cancelled: true, ids: current.slice(), value: raw });
          }
          function onApply() {
            var ids = Object.keys(selected);
            ids.sort();
            var val = ids.join(delimiter);
            var out = { cancelled: false, ids: ids, value: val, delimiter: delimiter, targetEntity: targetEntity };

            if (typeof opts.commit === "function") {
              setBusy(true, "Saving...");
              Promise.resolve()
                .then(function () { return opts.commit(out); })
                .then(function () {
                  cleanup();
                  close();
                  resolve(out);
                })
                .catch(function (err) {
                  var msgText = (err && err.message) ? err.message : String(err);
                  setBusy(false, "Save failed: " + msgText);
                });
              return;
            }

            cleanup();
            close();
            resolve(out);
          }
          function onBackdrop(e) {
            if (e.target === backdrop) onCancel();
          }
          function onKey(e) {
            if (e.key === "Escape") onCancel();
          }
          function cleanup() {
            setBusy(false, "");
            backdrop.removeEventListener("click", onBackdrop);
            document.removeEventListener("keydown", onKey);
            btnCancel.removeEventListener("click", onCancel);
            btnApply.removeEventListener("click", onApply);
            q.removeEventListener("input", onInput);
          }
          function onInput() { render(q.value); }

          backdrop.addEventListener("click", onBackdrop);
          document.addEventListener("keydown", onKey);
          btnCancel.addEventListener("click", onCancel);
          btnApply.addEventListener("click", onApply);
          q.addEventListener("input", onInput);

          open();
        });
      });
    }

    /* ========= 6. export ========= */
    function getFieldOptions(fid, meta) {
      try {
        if (meta && meta.options != null) return Array.isArray(meta.options) ? meta.options.slice() : String(meta.options || '').split(/[\n\r|,]+/).map(function (x) { return String(x == null ? "" : x).trim(); }).filter(Boolean);
      } catch (_) { }
      try {
        var m = (window.STATE && STATE.fieldsMeta && STATE.fieldsMeta[fid]) ? STATE.fieldsMeta[fid] : null;
        if (m && m.options != null) return Array.isArray(m.options) ? m.options.slice() : String(m.options || '').split(/[\n\r|,]+/).map(function (x) { return String(x == null ? "" : x).trim(); }).filter(Boolean);
      } catch (_) { }
      return [];
    }

    function normalizeDateValue(value) {
      try {
        if (value == null || value === '') return '';
        var s = isoDateOnly(value);
        return /^\d{4}-\d{2}-\d{2}$/.test(s) ? s : '';
      } catch (_) { }
      return '';
    }

    function __motkParseProxyFilename__(name) {
      try {
        name = String(name || "");
        if (!name) return null;
        if (name.indexOf("_ver_proxy") >= 0) return null;

        var m1 = name.match(/^([A-Za-z]{2,4}_[0-9]{4})_(\d{8}-\d{6})_(fi_\d{4})_proxy\.([A-Za-z0-9]+)$/);
        if (m1) return { kind: "versions", recordId: m1[1], ts: m1[2], fieldId: m1[3], ext: m1[4] };

        var m2 = name.match(/^([A-Za-z]{2,4}_[0-9]{4})_(\d{8}-\d{6})_proxy\.([A-Za-z0-9]+)$/);
        if (m2) return { kind: "nonversions", recordId: m2[1], ts: m2[2], fieldId: "", ext: m2[3] };

        var m3 = name.match(/^([A-Za-z]{2,4}_[0-9]{4})_proxy\.([A-Za-z0-9]+)$/);
        if (m3) return { kind: "nonversions", recordId: m3[1], ts: "", fieldId: "", ext: m3[2] };
      } catch (_) { }
      return null;
    }

    function __motkPickLatestProxy__(prev, next) {
      try {
        if (!prev) return next;
        if (!next) return prev;
        var a = prev.__motk && prev.__motk.ts ? String(prev.__motk.ts) : "";
        var b = next.__motk && next.__motk.ts ? String(next.__motk.ts) : "";
        if (!a && b) return next;
        if (a && !b) return prev;
        if (b > a) return next;
        return prev;
      } catch (_) { }
      return prev || next || null;
    }

    function __motkBuildProxyIndex__(items) {
      var byRecord = {};
      var byRecordField = {};
      try {
        if (!Array.isArray(items)) return { byRecord: byRecord, byRecordField: byRecordField };
        for (var i = 0; i < items.length; i++) {
          var f = items[i];
          if (!f) continue;
          var name = (f.name || f.fileName || f.filename) ? String(f.name || f.fileName || f.filename) : "";
          var p = __motkParseProxyFilename__(name);
          if (!p) continue;

          var fo = (f && typeof f === "object") ? Object.assign({}, f) : { url: String(f) };
          fo.__motk = p;
          try { if (!fo.url && fo.id) fo.url = "https://drive.google.com/uc?export=download&id=" + encodeURIComponent(String(fo.id)); } catch (_) { }

          if (p.kind === "versions") {
            var k1 = p.recordId + "|" + p.fieldId;
            byRecordField[k1] = __motkPickLatestProxy__(byRecordField[k1], fo);
          } else {
            var k2 = p.recordId;
            byRecord[k2] = __motkPickLatestProxy__(byRecord[k2], fo);
          }
        }
      } catch (_) { }
      return { byRecord: byRecord, byRecordField: byRecordField };
    }

    if (typeof window.__MOTK_BUILD_PROXY_INDEX__ !== "function") {
      window.__MOTK_BUILD_PROXY_INDEX__ = __motkBuildProxyIndex__;
    }

    window.FieldsAPI = { renderCellByField, getLabel, getFieldOptions, normalizeDateValue, attachCellEditor, hydrateLinks, ensureLinkMaps, openLinkPicker };

    window.CommonRenderer = window.CommonRenderer || {};
    if (typeof window.CommonRenderer.renderCellByField !== "function") {
      window.CommonRenderer.renderCellByField = function (entity, fieldId, value, meta) {
        meta = meta || {};
        var rowId = meta.__rowId || meta.rowId || meta.recordId || meta.id || "";
        var recordId = meta.recordId || meta.rowId || meta.id || rowId || "";
        var row = meta.__row || (rowId ? { fi_0001: rowId, id: rowId, ID: rowId } : (window.STATE && STATE.row ? STATE.row : null));
        return window.FieldsAPI.renderCellByField({
          fid: String(fieldId || ""),
          fieldId: String(fieldId || ""),
          type: meta.type,
          val: value,
          editable: !!meta.editable,
          entity: entity,
          rowId: rowId,
          recordId: recordId,
          id: recordId,
          row: row || {},
          field: meta || null,
          label: meta.label,
          name: meta.name
        });
      };
    }
    if (typeof window.CommonRenderer.refreshPendingPreviews !== "function") {
      window.CommonRenderer.refreshPendingPreviews = function (_root) {
        try { if (typeof window.__MOTK_PROXY_PREVIEW_REFRESH__ === "function") window.__MOTK_PROXY_PREVIEW_REFRESH__(); } catch (_) { }
      };
    }

    ensureLinkMaps().catch(function () { });
  })();




</script>
