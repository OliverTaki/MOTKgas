<script>
/* -------- state -------- */
const pageSizeOpts=[50,100,200,500];
let sheet='Shots', ids=[], header=[], totalRows=0;
let fieldType={}, idMaps={};
let curPage=1, pageSize=100, isResizing=false;

/* -------- boot -------- */
(function(){
  sheet = new URLSearchParams(location.search).get('page') || 'Shots';

  // 1) メタ
  google.script.run.withSuccessHandler(m=>{
    ids=m.ids; header=m.header; totalRows=m.rows;
    // 2) FIELD
    google.script.run.withSuccessHandler(meta=>{
      meta.forEach(o=>fieldType[o.id]=o.type);
      // 3) ID マップ
      google.script.run.withSuccessHandler(maps=>{
        idMaps=maps; initUI(); fetchPage();
      }).getIdMaps();
    }).getFieldMeta();
  }).getMeta(sheet);
})();

/* -------- UI 初期化 -------- */
function initUI(){
  // ページサイズセレクト
  const sel=document.getElementById('perPage');
  pageSizeOpts.forEach(v=>{
    const opt=document.createElement('option');
    opt.value=v; opt.textContent=`${v}/p`; if(v===pageSize)opt.selected=true;
    sel.appendChild(opt);
  });
  sel.onchange=e=>{pageSize=parseInt(e.target.value);curPage=1;fetchPage();};

  // ナビボタン
  document.getElementById('prevPg').onclick=_=>{if(curPage>1){curPage--;fetchPage();}};
  document.getElementById('nextPg').onclick=_=>{
    if(curPage<Math.ceil(totalRows/pageSize)){curPage++;fetchPage();}
  };

  document.getElementById('btnSort').onclick=_=>alert('Sort UI TODO');
  document.getElementById('btnFilter').onclick=_=>alert('Filter UI TODO');
  document.getElementById('btnReset').onclick=_=>{curPage=1;fetchPage();};
}

/* -------- データ取得 -------- */
function fetchPage(){
  const offset=(curPage-1)*pageSize;
  google.script.run.withSuccessHandler(drawTable).getPage(sheet, offset, pageSize);
}

/* -------- テーブル描画 -------- */
function drawTable(rows){
  const tbl=document.createElement('table');
  const thead=tbl.createTHead(),hrow=thead.insertRow();
  header.forEach((h,i)=>{
    const th=document.createElement('th');
    th.textContent=h; th.draggable=(i!==0); addResizer(th); hrow.appendChild(th);
  });

  const tbody=tbl.createTBody();
  rows.forEach(r=>{
    const tr=tbody.insertRow();
    r.forEach((cell,ci)=>{
      const td=tr.insertCell();
      td.textContent=(cell??'');
      // TODO: ID→NAME 置換 & Drive サムネは後続で
    });
  });

  document.getElementById('tableWrap').innerHTML=''; document.getElementById('tableWrap').appendChild(tbl);
  updateStatus();
  enableDnD(tbl);
}

/* -------- ステータス -------- */
function updateStatus(){
  document.getElementById('stat').textContent=
    `rows ${totalRows} | page ${curPage}/${Math.ceil(totalRows/pageSize)}`;
}

/* -------- DnD & resize （前回と同じ） -------- */
function enableDnD(t){let s=null; t.querySelectorAll('th').forEach(th=>{
  th.ondragstart=e=>{if(isResizing){e.preventDefault();return;}s=th.cellIndex;e.dataTransfer.setData('','');};
  th.ondragover=e=>e.preventDefault();
  th.ondrop=e=>{e.preventDefault();const d=th.cellIndex;if(s!==null&&s!==d)moveCol(t,s,d);s=null;};
});}
function moveCol(t,s,d){t.querySelectorAll('tr').forEach(r=>{
  const c=r.children;r.insertBefore(c[s],d>s?c[d].nextSibling:c[d]);
});}
function addResizer(th){
  const g=document.createElement('div');g.className='resizer';th.style.position='relative';th.appendChild(g);
  let sx,sw; g.onmousedown=e=>{
    isResizing=true;sx=e.pageX;sw=th.offsetWidth;
    document.onmousemove=ev=>{const w=sw+(ev.pageX-sx); if(w>40)th.style.width=w+'px';};
    document.onmouseup=_=>{document.onmousemove=document.onmouseup=null;isResizing=false;};
    e.stopPropagation();
  };
}
</script>
