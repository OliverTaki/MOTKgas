<script>
/* ---------- state ---------- */
const PAGE_OPTS=[50,100,200,0];   // 0 = ALL
let sheet='Shots', ids=[], header=[], total=0;
let fieldType={}, idMaps={};
let curPage=1, pageSize=100;
let isResizing=false, dragColId=null;
const DRIVE="https://drive.google.com/";

/* ---------- boot ---------- */
(function(){
  sheet=new URLSearchParams(location.search).get('page')||'Shots';
  google.script.run.withSuccessHandler(pkg=>{
    ({ids,header,total}=pkg);
    fieldType=Object.fromEntries(pkg.fieldMeta.map(o=>[o.id,o.type]));
    idMaps=pkg.idMaps;
    buildUI(); draw(pkg.rows);          // 初回 1ページ
  }).getInitData(sheet,0,pageSize);
})();

/* ---------- UI ---------- */
function buildUI(){
  const sel=document.getElementById('perPage');
  PAGE_OPTS.forEach(v=>{
    const o=document.createElement('option');
    o.value=v; o.textContent=v?`${v}/p`:'ALL'; if(v===pageSize)o.selected=true;
    sel.appendChild(o);
  });
  sel.onchange=e=>{pageSize=parseInt(e.target.value);curPage=1;fetch();};

  document.getElementById('prevPg').onclick=_=>{if(curPage>1){curPage--;fetch();}};
  document.getElementById('nextPg').onclick=_=>{
    if(pageSize===0)return;
    const max=Math.ceil(total/pageSize); if(curPage<max){curPage++;fetch();}
  };
  document.getElementById('btnSort').onclick=_=>alert('Sort UI TODO');
  document.getElementById('btnFilter').onclick=_=>alert('Filter UI TODO');
  document.getElementById('btnReset').onclick=_=>{curPage=1;fetch();};
}

/* ---------- data ---------- */
function fetch(){
  const off = pageSize===0 ? 0 : (curPage-1)*pageSize;
  const lim = pageSize===0 ? total : pageSize;
  google.script.run.withSuccessHandler(draw).getPage(sheet,off,lim);
}

/* ---------- draw table ---------- */
function draw(rows){
  const tbl=document.createElement('table');

  /* thead */
  const thead=tbl.createTHead(), hr=thead.insertRow();
  header.forEach((h,i)=>{
    const th=document.createElement('th');
    th.textContent=h; th.dataset.colId=ids[i];
    if(i) th.draggable=true;            // ID列以外ドラッグ可
    addResizer(th); hr.appendChild(th);
  });

  /* tbody */
  const tbody=tbl.createTBody();
  rows.forEach(r=>{
    const tr=tbody.insertRow();
    r.forEach((c,ci)=>{
      const td=tr.insertCell(); td.dataset.colId=ids[ci];
      if(typeof c==='string' && c.startsWith(DRIVE)){
        const id=extractId(c);
        td.innerHTML=`<img loading="lazy" class="thumb" src="https://drive.google.com/thumbnail?id=${id}&sz=w200">`;
        td.dataset.id=id;
      }else if(idMaps.shot[c]) td.innerHTML=`<a href="?page=Shots&id=${c}">${idMaps.shot[c]}</a>`;
      else td.textContent=c??'';
    });
  });

  document.getElementById('tableWrap').innerHTML=''; document.getElementById('tableWrap').appendChild(tbl);
  hideId(); enableDnD(tbl); previewClick(tbl); updateStat();
}

/* ---------- helpers ---------- */
function extractId(u){const m=u.match(/\/d\/([^/]+)/)||u.match(/id=([^&]+)/);return m?m[1]:null;}
function hideId(){document.querySelectorAll('table tr').forEach(tr=>{if(tr.children[0])tr.children[0].style.display='none';});}
function updateStat(){const max=pageSize?Math.ceil(total/pageSize):1;document.getElementById('stat').textContent=`rows ${total} | page ${curPage}/${max}`;}
function previewClick(t){t.onclick=e=>{if(e.target.classList.contains('thumb')){const id=e.target.parentElement.dataset.id;const f=document.createElement('iframe');f.className='preview';f.loading='lazy';f.src=`https://drive.google.com/file/d/${id}/preview`;e.target.replaceWith(f);}}}

/* ---------- DnD & resize ---------- */
function enableDnD(tbl){
  tbl.querySelectorAll('th').forEach(th=>{
    th.ondragstart=e=>{
      if(isResizing||!th.draggable){e.preventDefault();return;}
      dragColId=th.dataset.colId; e.dataTransfer.setData('','');
    };
    th.ondragover=e=>e.preventDefault();
    th.ondrop=e=>{
      e.preventDefault();
      const dstId=e.target.dataset.colId;
      if(dragColId&&dstId&&dragColId!==dstId) swapCols(tbl,dragColId,dstId);
      dragColId=null; hideId();
    };
  });
}
function swapCols(t,colA,colB){
  t.querySelectorAll('tr').forEach(r=>{
    const a=[...r.cells].find(c=>c.dataset.colId===colA);
    const b=[...r.cells].find(c=>c.dataset.colId===colB);
    if(a&&b) r.insertBefore(a,(a.compareDocumentPosition(b)&4)?b.nextSibling:b);
  });
}
function addResizer(th){
  const g=document.createElement('div');g.className='resizer';
  th.style.position='relative'; th.appendChild(g);
  g.onmousedown=e=>{
    isResizing=true; const colId=th.dataset.colId;
    const sx=e.pageX, sw=th.offsetWidth;
    document.onmousemove=ev=>{
      const w=Math.max(40, sw+(ev.pageX-sx));
      document.querySelectorAll(`[data-col-id="${colId}"]`).forEach(c=>c.style.width=w+'px');
    };
    document.onmouseup=_=>{document.onmousemove=document.onmouseup=null;isResizing=false;};
    e.stopPropagation();
  };
}
</script>
