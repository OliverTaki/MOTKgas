<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <?!= include('COMMON_styles'); ?>
</head>
<body>
<div id="table-view-container">
  <!-- Toolbar -->
  <div id="toolbar">
    <select id="presetSelect" aria-label="Pages"></select>
    <span id="presetStatus" class="muted"></span>

    <!-- Save dropdown（Save / Save as… / Revert） -->
    <div class="dropdown" id="saveDD">
      <button id="saveDDBtn" class="btn" disabled>Save ▾</button>
      <div class="dd-menu" id="saveDDMenu">
        <div class="dd-item" data-act="save">Save</div>
        <div class="dd-item" data-act="saveas">Save as…</div>
        <div class="dd-item" data-act="revert">Revert</div>
      </div>
    </div>

    <button id="sortBtn" class="btn">Sort</button>
    <button id="filterBtn" class="btn">Filter</button>
    <button id="columnsBtn" class="btn">Fields</button>

    <div class="spacer"></div>
    <input id="quickSearch" type="search" placeholder="Server search (Enter)" />
  </div>

  <!-- Table -->
  <div id="tableWrap"></div>

  <!-- Footer -->
  <div id="statusBar">
    <span id="statusLeft" class="muted">loading…</span>
    <div class="spacer"></div>
    <div id="pager">
      <select id="perPage" title="Rows per page">
        <option value="50">50</option>
        <option value="100" selected>100</option>
        <option value="200">200</option>
        <option value="500">500</option>
        <option value="all">ALL</option>
      </select>
      <span class="muted">per page</span>
      <button id="prevBtn" class="btn" aria-label="Previous page">‹</button>
      <select id="pageSelect" title="Page"></select>
      <button id="nextBtn" class="btn" aria-label="Next page">›</button>
    </div>
  </div>
</div>

<!-- Panels -->
<div id="colPanel" class="panel" role="dialog" aria-label="Fields menu"></div>
<div id="sortPanel" class="panel" role="dialog" aria-label="Sort menu"></div>
<div id="filterPanel" class="panel" role="dialog" aria-label="Filter menu"></div>

<!-- New Page small popover -->
<div id="npPopover" style="display:none;position:absolute;z-index:10001;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:12px;box-shadow:0 10px 28px rgba(0,0,0,.25);min-width:280px;">
  <h3 style="margin:0 0 8px 0;font:600 14px system-ui;">New Page</h3>
  <div class="row">
    <label style="min-width:72px;">Name</label>
    <input id="npName" type="text" maxlength="64" style="flex:1 1 auto;min-width:180px;padding:6px 8px;">
  </div>
  <div class="row">
    <label style="min-width:72px;">Shared</label>
    <label><input id="npShared" type="checkbox"> share with team</label>
  </div>
  <div class="row" style="justify-content:flex-end;gap:8px;">
    <button id="npCancel" class="btn">Cancel</button>
    <button id="npSave" class="btn">Save</button>
  </div>
</div>

<?!= include('COMMON_renderer'); ?>
<?!= include('Scripts'); ?>

<script>
/** =========================================
 *  viewer.html (ナンバリング整理版)
 *  - addGlobalClosers / removeGlobalClosers を単一実装に統合
 *  - openPanel の上書きラップを廃止し、単一定義に集約
 *  - applyData の上書きフックを廃止（Distinct は fetch 後に更新）
 *  - 既存 UI/動作は極力変更せずに構造のみ整理
 * =========================================*/

/* ===== Section Index =====
 *  1. グローバル初期化（scriptUrl / SPA ナビ導入フック）
 *  2. レイアウトオフセット（adjustNavOffset）
 *  3. 汎用ユーティリティ（uniq / raf / _canon 等）
 *  3A. copy helper
 *  4. グローバルクロージャ（addGlobalClosers / removeGlobalClosers）
 *  5. エンティティ/ステータスヘルパ
 *  6. ページング定数・ローカルストレージ
 *  7. ページング計算 & UI バインド
 *  8. URL 状態（page / perPage / sort）
 *  8A. URL ユーティリティ（getUrlParam）
 *  8C. linkmaps-cache（現在は no-op）
 *  9. Viewer STATE 定義
 *  9A. state guard
 * 10. Link マップ（LINK_MAPS） & 名前抽出
 * 11. Proxy index（ShotView/AssetView 用）
 * 12. GAS 呼び出しヘルパ（callFirst）
 * 13. データソース判定 & 正規化（normalizeRowsPayload）
 * 14. グループフィルタ payload
 * 15. 列順・列幅・visibleCols
 * 16. テーブルレンダリング本体（renderCurrentPage）
 * 16C. 列リサイズ & 並び替えハンドラ
 * 17. View 列 Lazy ロード（shotview / assetview）
 * 18. リンクレンダリングヘルパ
 * 19. カラムパネル（Fields）
 * 20. ソートパネル
 * 21. Distinct 値キャッシュ & refreshDistinctCache
 * 22. フィルタパネル V3
 * 23. パネル共通 openPanel / closePanel / closeAllPanels
 * 24. Dirty フラグ管理（setDirty）
 * 25. Save ドロップダウン UI（Save / Save as… / Revert）
 * 26. fetch + payload（buildServerPayload / fetchAndRenderPage / fetchPageOnlyFromCacheThenNetwork）
 * 27. ちょいユーティリティ（rid / labelForFieldId）
 * =========================*/

;(function(){
  "use strict";

  /* ===== 1. グローバル初期化（scriptUrl / SPA ナビ導入フック） ===== */

  try{
    window.scriptUrl = (function(){
      try{ return "<?= ScriptApp.getService().getUrl() ?>"; }
      catch(e){ return location.pathname; }
    })();
  }catch(e){
    try{ window.scriptUrl = location.pathname; }catch(_){}
  }

  /* ===== 2. レイアウトオフセット（adjustNavOffset） ===== */

  function adjustNavOffset(){
    try{
      var g=document.getElementById('gNav'), p=document.getElementById('pNav');
      var h=(g?g.offsetHeight:0)+(p?p.offsetHeight:0);
      document.documentElement.style.setProperty('--nav-offset', (h||0)+'px');
    }catch(e){}
  }

  /* ===== 3. 汎用ユーティリティ（uniq / raf / _canon 等） ===== */

  function uniq(a){
    var o={},r=[];
    for(var i=0;i<a.length;i++){
      var v=a[i];
      if(v!=null && v!=='' && !o[v]){o[v]=1;r.push(v);}
    }
    return r;
  }

  var rIC = window.requestIdleCallback
    ? function(cb){ return window.requestIdleCallback(cb); }
    : function(cb){ return setTimeout(cb, 0); };

  var raf = window.requestAnimationFrame
    ? function(cb){ return window.requestAnimationFrame(cb); }
    : function(cb){ return setTimeout(cb, 0); };

  function _canon(s){
    return String(s||'').toLowerCase().trim().replace(/[\s_-]/g,'');
  }

  function escapeHTML(s){
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function clamp(n,a,b){return Math.max(a,Math.min(b,n));}

  function deepCopy(o){
    try{ return JSON.parse(JSON.stringify(o)); }
    catch(e){ return o; }
  }

  function hasGoogle(){
    return !!(window.google && google.script && google.script.run);
  }

  /* ===== 3A. copy helper ===== */

  function copy(o){
    var r={};
    if(o && typeof o==='object'){
      for(var k in o){
        if(Object.prototype.hasOwnProperty.call(o,k)) r[k]=o[k];
      }
    }
    return r;
  }

  /* ===== 4. グローバルクロージャ（addGlobalClosers / removeGlobalClosers） ===== */

  function addGlobalClosers(popupEl, anchorEl, onClose){
    function onDocMouseDown(ev){
      if(!popupEl) return;
      var t = ev.target;
      var insidePopup = popupEl.contains(t);
      var insideAnchor = anchorEl && anchorEl.contains ? anchorEl.contains(t) : false;
      if(!insidePopup && !insideAnchor){
        onClose && onClose();
      }
    }
    function onKey(ev){
      if(ev.key === 'Escape'){
        onClose && onClose();
      }
    }
    popupEl.setAttribute('data-global-closer','1');
    document.addEventListener('mousedown', onDocMouseDown);
    document.addEventListener('keydown', onKey);
    popupEl._closerteardown = function(){
      document.removeEventListener('mousedown', onDocMouseDown);
      document.removeEventListener('keydown', onKey);
    };
  }

  function removeGlobalClosers(popupEl){
    try{
      if(popupEl && popupEl._closerteardown){
        popupEl._closerteardown();
        delete popupEl._closerteardown;
      }
    }catch(e){}
  }

  /* ===== 5. エンティティ/ステータスヘルパ ===== */

  function singularEntityFor(x){
    var s=_canon(x);
    if(s==='shots'||s==='shot') return 'shot';
    if(s==='assets'||s==='asset') return 'asset';
    if(s==='tasks'||s==='task') return 'task';
    if(s==='users'||s==='user') return 'user';
    if(s==='projectmembers'||s==='projectmember'||s==='members'||s==='member') return 'member';
    return s||'shot';
  }

  function pluralEntityFor(x){
    var s=singularEntityFor(x);
    if(s==='shot') return 'Shots';
    if(s==='asset') return 'Assets';
    if(s==='task') return 'Tasks';
    if(s==='user') return 'Users';
    if(s==='member') return 'ProjectMembers';
    return 'Shots';
  }

  function showStatus(msg){
    var s=document.getElementById('statusLeft');
    if(s) s.textContent=msg||'';
  }

  function _entityFromUrl(){
    try{
      var e=(new URLSearchParams(location.search).get('entity')||'').trim();
      return singularEntityFor(e);
    }catch(_){ return ''; }
  }

  function _entityFromPid(){
    try{
      return (typeof entityFromPageId==='function')
        ? entityFromPageId(STATE && STATE.pageId)
        : '';
    }catch(_){ return ''; }
  }

  function _entityForUI(){
    var e = _entityFromUrl() || _entityFromPid() || (STATE && STATE.sheetName) || '';
    return e || 'shot';
  }

  var VIEWER_STATE_STORAGE_KEY='MOTK.viewer.state';
  var VIEWER_STATE_STORAGE_KEY_LEGACY='motk:viewerStateSnapshot';
  var _viewerStateUploadHash='';

  function uploadViewerSnapshotToServer(snapshot){
    try{
      if(!window || !window.google || !google.script || !google.script.run) return;
      if(typeof google.script.run.withFailureHandler!=='function') return;
      google.script.run.withFailureHandler(function(){}).dp_storeViewerState(snapshot);
    }catch(_){}
  }

  window.persistViewerStateSnapshot = function(extra){
    try{
      var rowsLen=Array.isArray(STATE&&STATE.rows)?STATE.rows.length:0;
      if(rowsLen<=0) return;
      var snap={
        updatedAt: Date.now(),
        sheetName: (STATE&&STATE.sheetName)||'',
        pageId: (STATE&&STATE.pageId)||'',
        page: Number(STATE&&STATE.page)||1,
        perPage: (STATE&&STATE.perPage)||'',
        total: Number(STATE&&STATE.total)||0,
        rowsLength: rowsLen,
        dataSource: (STATE&&STATE.dataSource)||'',
        origin: (location&&location.href)||'',
        entityParam: (function(){ try{ return new URLSearchParams(location.search).get('entity')||''; }catch(_){ return ''; } })()
      };
      if(Array.isArray(STATE&&STATE.rows)){
        try{
          snap.sampleIds=STATE.rows.slice(0,5).map(function(r){ return r&&r[0]; });
        }catch(_){}
      }
      if(extra&&typeof extra==='object'){
        Object.keys(extra).forEach(function(k){
          snap[k]=extra[k];
        });
      }
      var serializedSnap=JSON.stringify(snap);
      localStorage.setItem(VIEWER_STATE_STORAGE_KEY, serializedSnap);
      try{ localStorage.setItem(VIEWER_STATE_STORAGE_KEY_LEGACY, serializedSnap); }catch(_){}
      try{
        if(serializedSnap && serializedSnap!==_viewerStateUploadHash){
          _viewerStateUploadHash=serializedSnap;
          uploadViewerSnapshotToServer(snap);
        }
      }catch(_){}
    }catch(_){}
  }

  function setFinalStatus(){
    var el=document.getElementById('statusLeft'); if(!el) return;
    var src=(STATE&&STATE.dataSource)?(' · '+STATE.dataSource):' · DataHub';
    var entPlural = pluralEntityFor(_entityForUI());
    var rowsLen=Array.isArray(STATE&&STATE.rows)?STATE.rows.length:0;

    var total=Number(STATE&&STATE.total);
    if(!isFinite(total)||total<0) total=0;
    if(total===0&&rowsLen>0) total=rowsLen;

    var perAll=(STATE&&STATE.perPage==='all');
    var per=perAll?total:Number(STATE&&STATE.perPage);
    if(!isFinite(per)||per<1) per=DEFAULT_PER_PAGE;

    var page=Number(STATE&&STATE.page);
    if(!isFinite(page)||page<1) page=1;

    var start=0;
    var end=0;
    if(total>0){
      if(perAll){
        start=1;
        end=total;
      }else{
        var maxPage=Math.ceil(total/per);
        if(maxPage>0&&page>maxPage) page=maxPage;
        start=((page-1)*per)+1;
        end=Math.min(total,page*per);
      }
    }

    if(end<start&&total>0) end=start;
    var hasWindow=(total>0&&start>0&&end>=start);

    var summaryText=(
      hasWindow
        ? (start+'–'+end+' of '+total+' '+entPlural)
        : ('0 of 0 '+entPlural)
    )+src;
    el.textContent=summaryText;
    persistViewerStateSnapshot({
      statusText: summaryText,
      rowsStart: hasWindow?start:0,
      rowsEnd: hasWindow?end:0
    });
  }

  /* ===== 6. ページング定数・ローカルストレージ ===== */

  var DEFAULT_COL_W=140;
  var DEFAULT_PER_PAGE=100;
  var PER_PAGE_ALLOWED=[50, DEFAULT_PER_PAGE, 200, 500];
  var PER_PAGE_ALL='all';
  var MAX_FETCH_LIMIT=5000;

  function LSC_get(key,age){
    try{
      var raw=localStorage.getItem(key);if(!raw)return null;
      var o=JSON.parse(raw);if(!o||o.t==null)return null;
      if(age!=null&&(Date.now()-o.t)>age)return null;
      return o.v;
    }catch(e){return null;}
  }

  function LSC_set(key,v){
    try{
      localStorage.setItem(key,JSON.stringify({t:Date.now(),v:v}));
    }catch(e){}
  }

  /* ===== 7. ページング計算 & UI バインド ===== */

  function getTotalRows(){
    var total = Number(STATE && STATE.total);
    if(!isFinite(total) || total < 0) total = 0;
    if(total === 0){
      var len = Array.isArray(STATE && STATE.rows) ? STATE.rows.length : 0;
      if(len > 0) total = len;
    }
    return total;
  }

  function resolvePageWindow(){
    if(STATE && STATE.perPage === PER_PAGE_ALL){
      var total = getTotalRows();
      return total > 0 ? total : MAX_FETCH_LIMIT;
    }
    var num = Number(STATE && STATE.perPage);
    if(!num || num < 1) num = DEFAULT_PER_PAGE;
    return num;
  }

  function resolveFetchLimit(){
    return (STATE && STATE.perPage === PER_PAGE_ALL)
      ? MAX_FETCH_LIMIT
      : resolvePageWindow();
  }

  function computeTotalPages(){
    if(STATE && STATE.perPage === PER_PAGE_ALL) return 1;
    var per = resolvePageWindow();
    var total = getTotalRows();
    if(total <= 0) return 1;
    return Math.max(1, Math.ceil(total / per));
  }

  function normalizePerPageValue(value){
    if(value == null) return DEFAULT_PER_PAGE;
    var str = String(value).toLowerCase();
    if(str === PER_PAGE_ALL) return PER_PAGE_ALL;
    var num = parseInt(str, 10);
    return PER_PAGE_ALLOWED.indexOf(num) >= 0 ? num : DEFAULT_PER_PAGE;
  }

  function perPageToString(value){
    return value === PER_PAGE_ALL ? PER_PAGE_ALL : String(value || DEFAULT_PER_PAGE);
  }

  function updatePagerUI(){
    var perSel=document.getElementById('perPage');
    if(perSel){
      var desired = perPageToString(STATE.perPage);
      if(perSel.value !== desired) perSel.value = desired;
    }

    var totalPages = computeTotalPages();
    if(STATE.perPage === PER_PAGE_ALL) STATE.page = 1;
    else if(STATE.page > totalPages) STATE.page = totalPages;

    var pageSel=document.getElementById('pageSelect');
    if(pageSel){
      if(pageSel.options.length !== totalPages){
        var frag=document.createDocumentFragment();
        for(var i=1;i<=totalPages;i++){
          var opt=document.createElement('option');
          opt.value=String(i);
          opt.textContent='Page '+i;
          frag.appendChild(opt);
        }
        pageSel.innerHTML='';
        pageSel.appendChild(frag);
      }
      pageSel.value=String(STATE.page);
      pageSel.disabled = totalPages <= 1;
    }

    var prevBtn=document.getElementById('prevBtn');
    if(prevBtn) prevBtn.disabled = (STATE.page <= 1);

    var nextBtn=document.getElementById('nextBtn');
    if(nextBtn) nextBtn.disabled =
      (STATE.perPage === PER_PAGE_ALL) ||
      (STATE.page >= totalPages);
  }

  function bindPagerControls(){
    var perSel=document.getElementById('perPage');
    if(perSel){
      var perClone=perSel.cloneNode(true);
      perSel.parentNode.replaceChild(perClone, perSel);
      perSel=perClone;
      perSel.value=perPageToString(STATE.perPage);
      perSel.addEventListener('change', function(){
        var normalized = normalizePerPageValue(perSel.value);
        if(normalized === STATE.perPage) return;
        STATE.perPage = normalized;
        perSel.value = perPageToString(STATE.perPage);
        STATE.page = 1;
        fetchAndRenderPage(1);
      });
    }

    var pageSel=document.getElementById('pageSelect');
    if(pageSel){
      var pageClone=pageSel.cloneNode(true);
      pageSel.parentNode.replaceChild(pageClone, pageSel);
      pageSel=pageClone;
      pageSel.addEventListener('change', function(){
        var target = parseInt(pageSel.value, 10);
        if(!isFinite(target) || target < 1) target = 1;
        fetchAndRenderPage(target);
      });
    }

    var prevBtn=document.getElementById('prevBtn');
    if(prevBtn){
      var prevClone=prevBtn.cloneNode(true);
      prevBtn.parentNode.replaceChild(prevClone, prevBtn);
      prevBtn=prevClone;
      prevBtn.addEventListener('click', function(ev){
        ev.preventDefault();
        ev.stopPropagation();
        ev.stopImmediatePropagation();
        if(prevBtn.disabled) return;
        var target = Math.max(1, STATE.page-1);
        if(target === STATE.page) return;
        fetchAndRenderPage(target);
      }, true);
    }

    var nextBtn=document.getElementById('nextBtn');
    if(nextBtn){
      var nextClone=nextBtn.cloneNode(true);
      nextBtn.parentNode.replaceChild(nextClone, nextBtn);
      nextBtn=nextClone;
      nextBtn.addEventListener('click', function(ev){
        ev.preventDefault();
        ev.stopPropagation();
        ev.stopImmediatePropagation();
        if(nextBtn.disabled) return;
        var totalPages = computeTotalPages();
        var target = Math.min(totalPages, STATE.page+1);
        if(target === STATE.page) return;
        fetchAndRenderPage(target);
      }, true);
    }
  }

  /* ===== 8. URL 状態（page / perPage / sort） ===== */

  function parseSortParam(s){
    if(!s)return[];
    return s.split(',')
      .map(function(x){return x.match(/^([^.]+)\.(asc|desc)$/i);})
      .filter(Boolean)
      .map(function(m){return({id:m[1],dir:m[2].toLowerCase(),on:true});});
  }

  function serializeSort(l){
    if(!l||!l.length)return'';
    return l.map(function(it){
      return it&&it.id?(it.id+'.'+(it.dir==='desc'?'desc':'asc')):'';
    }).filter(Boolean).join(',');
  }

  function readUrlState(){
    var usp=new URLSearchParams(location.search);
    var pid=usp.get('pid'); if(pid)STATE.pageId=pid;
    var pg=parseInt(usp.get('pg')||'1',10); if(pg>0)STATE.page=pg;
    var ppParam=usp.get('pp'); if(ppParam){
      if(String(ppParam).toLowerCase()===PER_PAGE_ALL){ STATE.perPage=PER_PAGE_ALL; }
      else {
        var pp=parseInt(ppParam,10);
        if(PER_PAGE_ALLOWED.indexOf(pp)>=0) STATE.perPage=pp;
      }
    }
    var s=usp.get('s')||'';
    STATE.sort=parseSortParam(s);
  }

  function writeUrlState(usp){
    if(!usp) usp=new URLSearchParams(location.search);
    if(STATE.pageId) usp.set('pid',STATE.pageId);
    if(STATE.page>1) usp.set('pg',String(STATE.page)); else usp.delete('pg');
    if(STATE.perPage===PER_PAGE_ALL) usp.set('pp', PER_PAGE_ALL);
    else if(STATE.perPage!==DEFAULT_PER_PAGE) usp.set('pp',String(STATE.perPage));
    else usp.delete('pp');
    var s=serializeSort(
      STATE.sort.filter(function(x){return x&&x.on!==false;})
    );
    if(s)usp.set('s',s); else usp.delete('s');
    return usp;
  }

  /* ===== 8A. URL ユーティリティ（getUrlParam） ===== */

  function getUrlParam(k){
    try{ return (new URLSearchParams(location.search).get(k)||'').trim(); }
    catch(_){ return ''; }
  }

  /* ===== 8C. linkmaps-cache（現在は no-op） ===== */

  function loadLinkMapsFromCache(){ return null; }
  function saveLinkMapsToCache(_maps){ /* no-op */ }
  function clearLinkMapsCache(){ /* no-op */ }
  function mergeLinkMaps(dst, src){ return src || dst || {}; }
  function countMaps(_maps){ return 0; }

  /* ===== 9. Viewer STATE 定義 ===== */

  window.applyData = window.applyData || function(p){
    p = p || {};
    window.STATE = window.STATE || {};
    STATE.fieldIds = Array.isArray(p.ids) ? p.ids.slice() : [];
    STATE.header   = Array.isArray(p.header) ? p.header.slice() : [];
    STATE.rows     = Array.isArray(p.rows) ? p.rows.slice() : [];
    var total = Number(p.total);
    STATE.total = (isFinite(total) && total >= 0) ? total : STATE.rows.length;
    if(typeof updatePagerUI === 'function'){
      try{ updatePagerUI(); }catch(_){}
    }
  };

  window.STATE=window.STATE||{};
  var STATE=window.STATE;
  STATE.sheetName=STATE.sheetName||'';
  STATE.pageType=STATE.pageType||'table';
  STATE.fieldIds=STATE.fieldIds||[];
  STATE.header=STATE.header||[];
  STATE.rows=STATE.rows||[];
  STATE.total=STATE.total||0;
  STATE.pageList=STATE.pageList||[];
  STATE.pageId=STATE.pageId||'pg_default';
  STATE.pageCfgRaw=STATE.pageCfgRaw||null;
  STATE.widths=STATE.widths||{};
  STATE.hiddenCols=STATE.hiddenCols||{};
  STATE.dirty=!!STATE.dirty;
  STATE.perPage=STATE.perPage||DEFAULT_PER_PAGE;
  STATE.page=STATE.page||1;
  STATE.sort=STATE.sort||[];
  STATE.filterSets=STATE.filterSets||{};
  STATE.selectedGroups=STATE.selectedGroups||{};
  STATE.groupCombine=STATE.groupCombine||'all';
  STATE.groupEnabled=(STATE.groupEnabled!==false);
  STATE.dataSource=STATE.dataSource||'';
  STATE._dataReady=!!STATE._dataReady;
  STATE._cfgReady=!!STATE._cfgReady;
  STATE._linksReady=!!STATE._linksReady;
  STATE._namesReady=!!STATE._namesReady;
  STATE._didRerenderAfterLinks=!!STATE._didRerenderAfterLinks;

  /* ===== 9A. state guard ===== */

  if (!Array.isArray(STATE.group)) STATE.group = [];

  function maybeRender(){
    if(!(STATE && STATE._dataReady && STATE._cfgReady)) return;
    if(typeof showStatus === 'function') showStatus('applying page…');
    raf(function(){
      try{ renderCurrentPage(true); }
      catch(_){}
    });
  }

  var LAST_VIEW_CACHE_TTL = 30*24*60*60*1000;

  function ensureFilterGroupDefaults(){
    if(!Array.isArray(STATE.filterGroups) || STATE.filterGroups.length === 0){
      STATE.filterGroups = [{
        id: rid(),
        name: 'Group 1',
        mode: 'any',
        rules: [{ id:'', op:'isempty', value:'', values:[] }]
      }];
    }
    var first = STATE.filterGroups[0];
    if(first && (!Array.isArray(first.rules) || first.rules.length === 0)){
      first.rules = [{ id:'', op:'isempty', value:'', values:[] }];
    }
  }

  function rememberLastView(){
    try{
      if(!STATE) return;
      LSC_set('motk:lastView',{
        sheet: STATE.sheetName || '',
        pid: STATE.pageId || '',
        perPage: STATE.perPage || ''
      });
    }catch(_){}
  }

  function applyLastViewFallback(){
    try{
      var saved = LSC_get('motk:lastView', LAST_VIEW_CACHE_TTL);
      if(!saved) return;
      var hasPid = !!getUrlParam('pid');
      var hasEntity = !!getUrlParam('entity');
      if(!STATE.pageId && saved.pid && !hasPid){
        STATE.pageId = saved.pid;
      }
      if((!STATE.sheetName || !STATE.sheetName.length) && saved.sheet && !hasEntity){
        STATE.sheetName = singularEntityFor(saved.sheet);
      }
      if(saved.perPage && !hasPid){
        STATE.perPage = normalizePerPageValue(saved.perPage);
      }
    }catch(_){}
  }

  /* ===== 10. Link マップ（LINK_MAPS） & 名前抽出 ===== */

  window.LINK_MAPS = window.LINK_MAPS || {assets:{}, shots:{}, tasks:{}, users:{}, members:{}};

  var KNOWN_LINK_FIELD_IDS={
    fi_0028:'member',
    fi_0031:'shot',
    fi_0037:'user',
    fi_0058:'user',
    fi_0061:'asset', fi_0062:'task',
    fi_0063:'shot', fi_0064:'task',
    fi_0065:'asset'
  };

  function _idxOf(a,v){
    if(!Array.isArray(a)) return -1;
    for(var i=0;i<a.length;i++){ if(a[i]===v) return i; }
    return -1;
  }

  function prefetchEntityMap(entity, pickNameFn, bucketKey){
    if(!hasGoogle())return;
    var key='map:'+entity; if(prefetchEntityMap[key])return; prefetchEntityMap[key]=true;
    google.script.run.withSuccessHandler(function(res){
      try{
        var ids = (res && Array.isArray(res.ids)) ? res.ids
                  : (Array.isArray(res) && Array.isArray(res[0]) ? res[0] : []);
        var header= (res && Array.isArray(res.header)) ? res.header
                  : (Array.isArray(res) && Array.isArray(res[1]) ? res[1] : []);
        var rows = (res && Array.isArray(res.rows)) ? res.rows
                  : (Array.isArray(res) ? res.slice(2) : []);
        var map={};
        for(var r=0;r<rows.length;r++){
          var row = rows[r]||[];
          var id = String(row[0]||'').trim(); if(!id) continue;
          var name = pickNameFn(ids, header, row) || id;
          map[id]=name;
        }
        LINK_MAPS[bucketKey]=Object.assign(LINK_MAPS[bucketKey]||{}, map);
      }catch(e){}
    }).withFailureHandler(function(){/* ignore */})
      .listRowsPage({entity:entity,offset:0,limit:50000});
  }

  function pickAssetName(ids, header, row){
    var i = header.findIndex(function(h){return String(h).toLowerCase().includes('asset name');});
    if(i<0) i=1;
    return String(row[i]||'').trim();
  }

  function pickShotCode(ids, header, row){
    var i = header.findIndex(function(h){return /^(shot ?code|code)$/i.test(String(h));});
    if(i<0) i=1;
    return String(row[i]||'').trim();
  }

  function pickTaskName(ids, header, row){
    var i = header.findIndex(function(h){return /task.*name/i.test(String(h));});
    if(i<0) i=1;
    return String(row[i]||'').trim();
  }

  function pickUserName(ids, header, row){
    var i = header.findIndex(function(h){return /^(name|user name)$/i.test(String(h));});
    if(i<0) i=1;
    return String(row[i]||'').trim();
  }

  function pickMemberName(ids, header, row){
    var i = _idxOf(ids,'fi_0035');
    if(i<0){
      i = header.findIndex(function(h){return /^role$/i.test(String(h));});
    }
    if(i<0) i=1;
    return String(row[i]||'').trim();
  }

  /* ===== 11. Proxy index（ShotView/AssetView 用） ===== */

  var PROXY_CACHE={};

  function prefetchProxyIndex(){
    if(!hasGoogle())return;
    callFirst(['sv_indexAllProxies'],{},
      function(idx){
        try{
          var latest=(idx&&idx.latestByShotId)?idx.latestByShotId:{};
          for(var k in latest){ PROXY_CACHE[String(k)]=latest[k]||null; }
          var wrap=document.getElementById('tableWrap');
          if(wrap){
            try{
              var ev=new Event('scroll'); wrap.dispatchEvent(ev);
            }catch(e){
              var ev2=document.createEvent('Event'); ev2.initEvent('scroll',true,true); wrap.dispatchEvent(ev2);
            }
            try{ wrap.dispatchEvent(new Event('proxies:ready')); }catch(_){}
          }
        }catch(e){}
      },
      function(){}
    );
  }

  /* ===== 12. GAS 呼び出しヘルパ（callFirst） ===== */

  function callFirst(names, params, onOk, onFail){
    onOk=onOk||function(){}; onFail=onFail||function(){};
    if(!hasGoogle()){onFail();return;}
    var i=0;(function next(){
      if(i>=names.length){onFail();return;}
      var fn=names[i++]; if(typeof google.script.run[fn] !== 'function'){ next(); return; }
      try{
        google.script.run
          .withSuccessHandler(onOk)
          .withFailureHandler(function(){ next(); })[fn](params||{});
      }catch(e){ next(); }
    })();
  }

  /* ===== 13. データソース判定 & 正規化（normalizeRowsPayload） ===== */

  function detectSourceByIds(ids, header){
    try{
      function hasFi(arr){
        if(!Array.isArray(arr)) return false;
        for(var i=0;i<arr.length;i++){
          var s=String(arr[i]||'');
          if(/^fi_\d{4}$/i.test(s)) return true;
        }
        return false;
      }
      if(hasFi(ids)) return 'DataHub';
      if(hasFi(header)) return 'DataHub';
    }catch(e){}
    return 'Sheet';
  }

  function normalizeRowsPayload(res){
    if(res && typeof res==='object' && !Array.isArray(res)){
      if(Array.isArray(res.columns) && res.columns.length){
        var ids   = res.columns.map(function(c){return String(c && (c.id||c.fi||c.name)||'');});
        var header= res.columns.map(function(c){return String(c && (c.label||c.title||c.name||c.id)||'');});
        var rawRows = Array.isArray(res.rows)?res.rows
                      : (Array.isArray(res.data)?res.data:[]);
        var rows = rawRows.map(function(r){
          if(Array.isArray(r)) return r;
          if(r && typeof r==='object'){
            return ids.map(function(fid){ return r[fid]; });
          }
          return [];
        });
        var total = Number(
          (res.total!=null?res.total:
           res.count!=null?res.count:
           res.meta && res.meta.total!=null?res.meta.total:
           rows.length)
        );
        if(!isFinite(total) || total<0) total = rows.length;
        return { ids:ids, header:header, rows:rows, total:total };
      }
      var ids2   = Array.isArray(res.ids)?res.ids:[];
      var head2  = Array.isArray(res.header)?res.header:[];
      var rows2  = Array.isArray(res.rows)?res.rows:[];
      var total2 = (isFinite(res.total) && res.total>=0) ? res.total : rows2.length;
      return { ids:ids2, header:head2, rows:rows2, total:total2 };
    }

    if(Array.isArray(res)){
      function toArrayRow(r){
        if(Array.isArray(r)){
          if(r.length===1 && typeof r[0]==='string' && r[0].indexOf('|')>=0) return r[0].split('|');
          return r;
        }
        if(typeof r==='string' && r.indexOf('|')>=0) return r.split('|');
        return Array.isArray(r) ? r : [];
      }
      function isFiRow(r){
        var a = toArrayRow(r);
        if(!a.length) return false;
        var hits=0;
        for(var i=0;i<a.length;i++){
          if(/^fi_\d{4}$/i.test(String(a[i]||''))) hits++;
        }
        return hits>=3 && hits>=Math.ceil(a.length*0.6);
      }

      var k=-1;
      for(var i2=0;i2<res.length;i2++){ if(isFiRow(res[i2])){ k=i2; break; } }

      if(k>=0){
        var ids   = toArrayRow(res[k]);
        var names = (k+1<res.length) ? toArrayRow(res[k+1]) : ids.slice();
        var data  = [];
        for(var r=k+2; r<res.length; r++){ data.push( toArrayRow(res[r]) ); }
        var total = data.length;
        return { ids:ids, header:names, rows:data, total:total };
      }

      var ids0   = Array.isArray(res[0])?res[0]:[];
      var head0  = Array.isArray(res[1])?res[1]:[];
      var rows0  = res.slice(2).map(toArrayRow);
      var total0 = rows0.length;
      return { ids:ids0, header:head0, rows:rows0, total:total0 };
    }

    return { ids:[], header:[], rows:[], total:0 };
  }

  /* ===== 14. グループフィルタ payload ===== */

  function buildGroupFilterPayload(){
    var groups=[];
    Object.keys(STATE.filterSets||{}).forEach(function(name){
      if(STATE.selectedGroups && STATE.selectedGroups[name]){
        var g=STATE.filterSets[name]||{};
        var rules=Array.isArray(g.rules)?g.rules.map(function(r){
          var values = Array.isArray(r.values) ? r.values.slice()
                       : (typeof r.value==='string' && r.value.indexOf('||')>=0
                          ? r.value.split('||').filter(Boolean)
                          : []);
          return { id:r.id, op:r.op, value:r.value||'', values:values };
        }):[];
        groups.push({ name:name, mode:(g.mode==='any'?'any':'all'), rules:rules });
      }
    });
    if(groups.length===0){
      var first=Object.keys(STATE.filterSets||{})[0];
      if(first){
        var g=STATE.filterSets[first];
        var rules=Array.isArray(g.rules)?g.rules.map(function(r){
          var values = Array.isArray(r.values) ? r.values.slice()
                       : (typeof r.value==='string' && r.value.indexOf('||')>=0
                          ? r.value.split('||').filter(Boolean)
                          : []);
          return { id:r.id, op:r.op, value:r.value||'', values:values };
        }):[];
        groups.push({ name:first, mode:(g.mode==='any'?'any':'all'), rules:rules });
      }
    }
    return { filterGroups: groups, groupCombine: (STATE.groupCombine==='any'?'any':'all') };
  }

  /* ===== 15. 列順・列幅・visibleCols ===== */

  function defaultWidthFor(colId, headerText){
    var h=String(headerText||'').toLowerCase();
    if(h==='shotview' || h==='assetview') return 100;
    if(/^fi_0002$/i.test(colId) || /shot(code)?/i.test(h)) return 120;
    return DEFAULT_COL_W;
  }

  function indexOf(arr,v){
    if(!Array.isArray(arr)) return -1;
    for(var i=0;i<arr.length;i++){ if(arr[i]===v) return i; }
    return -1;
  }

  function resolveOrder(){
    var ids=STATE.fieldIds.slice();
    var order=(STATE.pageCfgRaw&&Array.isArray(STATE.pageCfgRaw.order))
      ? STATE.pageCfgRaw.order.slice()
      : [];
    if(!order || !order.length) return ids;
    var inOrder={}, out=[];
    for(var i=0;i<order.length;i++){
      var id=order[i];
      if(id && indexOf(ids,id)!==-1 && !inOrder[id]){
        inOrder[id]=1; out.push(id);
      }
    }
    for(var j=0;j<ids.length;j++){
      var k=ids[j]; if(!inOrder[k]) out.push(k);
    }
    return out;
  }

  function visibleCols(){
    var resolved=resolveOrder();
    var out=[],seen={};
    for(var i=0;i<resolved.length;i++){
      var id=resolved[i];
      if(id && indexOf(STATE.fieldIds,id)!==-1 && !STATE.hiddenCols[id] && !seen[id]){
        seen[id]=1; out.push(id);
      }
    }
    return out;
  }

  function findOriginalsCols(){
    var set={};
    for(var i=0;i<STATE.fieldIds.length;i++){
      var fid=STATE.fieldIds[i]; 
      var h=_norm(STATE.header[i]);
      if(fid==='fi_0010'||fid==='fi_0020'||fid==='fi_0032' || h.indexOf('original')===0){ set[fid]=1; }
    }
    return set;
  }

  function toOriginalsUrl(v){
    var s=String(v||'').trim(); if(!s) return '';
    if(/^https?:\/\//i.test(s)) return s;
    var m=s.match(/(?:drive:|gdrive:)?([A-Za-z0-9_-]{20,})/); 
    if(m) return 'https://drive.google.com/drive/folders/'+m[1];
    return '';
  }

  /* ===== 16. テーブルレンダリング本体（renderCurrentPage） ===== */

  function renderCurrentPage(){
    var wrap=document.getElementById('tableWrap'); if(!wrap)return;
    wrap.innerHTML='';
    groupHeaderHTML._last=null;

    var cols=visibleCols();
    var colIdx=[];
    for(var i=0;i<cols.length;i++){
      colIdx[i]=indexOf(STATE.fieldIds,cols[i]);
    }
    var colW=[];
    for(var j=0;j<cols.length;j++){
      colW[j]=STATE.widths[cols[j]]||defaultWidthFor(cols[j],STATE.header[colIdx[j]]);
    }

    var table=document.createElement('table');
    var thead=document.createElement('thead');
    var tbody=document.createElement('tbody');
    table.appendChild(thead); table.appendChild(tbody); wrap.appendChild(table);

    var hr=document.createElement('tr');
    for(var i2=0;i2<cols.length;i2++){
      var colId=cols[i2];
      var th=document.createElement('th');
      th.textContent=STATE.header[colIdx[i2]]||colId;
      th.setAttribute('data-col-id',colId);
      th.className='draggable';
      th.style.width=(colW[i2])+'px';

      var h=document.createElement('span');
      h.className='resize-h';
      hr.appendChild(th);
      th.appendChild(h);

      th.setAttribute('draggable','true');
      th.addEventListener('dragstart',onDragStart);
      th.addEventListener('dragover',function(e){
        e.preventDefault(); e.dataTransfer.dropEffect='move';
      });
      th.addEventListener('drop',onDropHeader);

      h.addEventListener('mousedown', startResize(th, colId), {passive:false});
      h.addEventListener('touchstart', startResize(th, colId), {passive:false});
    }
    thead.appendChild(hr);

    var rowsSlice=STATE.rows.slice();
    var canon=_canon(STATE.sheetName);
    var vCol=findViewColId(['shotview','assetview']);
    var oriCols=findOriginalsCols();

    var prevRowForGroup=STATE._prevRowForGroup||null;
    var useGrouping = !!STATE.group && STATE.group.length>0 && !!STATE.groupEnabled;

    function buildRowsHTML(from,to){
      var html=''; var prevGrpKeys=null;

      for(var r=from;r<to;r++){
        var row=rowsSlice[r]; var rowId=String(row && row[0] || '').trim();

        if(useGrouping){
          var curKeys=[];
          for(var g=0;g<STATE.group.length;g++){
            var gid=STATE.group[g]; var gidx=indexOf(STATE.fieldIds,gid);
            curKeys.push(row[gidx]);
          }
          if(!prevGrpKeys){
            var same=false;
            if(r===from && prevRowForGroup){
              var prevKeys=[];
              for(var gg=0;gg<STATE.group.length;gg++){
                var gid2=STATE.group[gg]; var pidx=indexOf(STATE.fieldIds,gid2);
                prevKeys.push(prevRowForGroup[pidx]);
              }
              same=_sameKeyArray(curKeys,prevKeys);
            }
            if(!same){ html+=groupHeaderHTML(curKeys); }
          }else{
            for(var lv=0;lv<curKeys.length;lv++){
              if(curKeys[lv]!==prevGrpKeys[lv]){
                html+=groupHeaderHTML(curKeys.slice(0,lv+1));
                break;
              }
            }
          }
          prevGrpKeys=curKeys;
        }

        html+='<tr data-row-id="'+escapeHTML(rowId)+'">';
        for(var c=0;c<cols.length;c++){
          var id=cols[c], idx=colIdx[c];
          var raw=row[idx];
          var txt=(raw==null)?'':String(raw);
          var headTxt=STATE.header[idx]||id;

          if(id===vCol){
            html+='<td data-col-id="'+id+'" data-viewcell="1" data-rowid="'+escapeHTML(rowId)+'"></td>';
          }
          else if(oriCols[id]){
            var url=toOriginalsUrl(txt);
            if(url){
              html+='<td data-col-id="'+id+'"><a href="'+escapeHTML(url)+'" target="_blank" rel="noopener">'+escapeHTML(txt||url)+'</a></td>';
            }else if(/^https?:\/\//i.test(txt)){
              html+='<td data-col-id="'+id+'"><a href="'+escapeHTML(txt)+'" target="_blank" rel="noopener">'+escapeHTML(txt)+'</a></td>';
            }else{
              html+='<td data-col-id="'+id+'">'+escapeHTML(txt)+'</td>';
            }
          }
          else if(isIdColumn(headTxt,id)){
            html+='<td data-col-id="'+id+'">'+escapeHTML(txt)+'</td>';
          }
          else if(isLinkish(id, headTxt) || tokenExistsInAnyMap(txt)){
            var parts=splitTokens(txt);
            var rendered=parts.map(function(pid){ return renderLinkId(pid); }).join(', ');
            html+='<td data-col-id="'+id+'">'+(rendered||escapeHTML(txt))+'</td>';
          }
          else if(
            (canon==='projectmembers'||canon==='projectmember'||canon==='member'||canon==='members') &&
            (id==='fi_0035') && isRowIdLike(rowId)
          ){
            var urlPM=(window.scriptUrl||'')+'?entity=member&id='+encodeURIComponent(rowId);
            html+='<td data-col-id="'+id+'"><a href="'+urlPM+'">'+escapeHTML(txt||'(role)')+'</a></td>';
          }
          else if(shouldNameCellLinkToDetail(canon, headTxt, rowId)){
            var ent=singularEntityFor(canon);
            var url2=(window.scriptUrl||'')+'?entity='+ent+'&id='+encodeURIComponent(rowId);
            html+='<td data-col-id="'+id+'"><a href="'+url2+'">'+escapeHTML(txt)+'</a></td>';
          }
          else if(/shotcode/i.test(headTxt) && isRowIdLike(rowId)){
            var url3=(window.scriptUrl||'')+'?entity=shot&id='+encodeURIComponent(rowId);
            html+='<td data-col-id="'+id+'"><a href="'+url3+'">'+escapeHTML(txt)+'</td>';
          }
          else{
            html+='<td data-col-id="'+id+'">'+escapeHTML(txt)+'</td>';
          }
        }
        html+='</tr>';
      }
      return html;
    }

    function groupHeaderHTML(keys){
      var out=''; var lastKeys=groupHeaderHTML._last||[];
      for(var lv=0;lv<keys.length;lv++){
        var v = keys[lv];
        if(lastKeys[lv]===v) continue;
        var cls=(lv===0)?'grp1':'grp2';
        var label = (v==null || v==='') ? '(empty)' : String(v);
        out+='<tr class="'+cls+'"><td colspan="'+cols.length+'"><span class="grpLabel">'+escapeHTML(label)+'</span></td></tr>';
      }
      groupHeaderHTML._last=keys.slice();
      return out;
    }

    var CHUNK_TARGET_CELLS=1500;
    var initRows=clamp(Math.floor(CHUNK_TARGET_CELLS/Math.max(1,cols.length)),20,80);
    var FIRST_CHUNK=Math.min(rowsSlice.length,initRows);
    try{ tbody.innerHTML=buildRowsHTML(0,FIRST_CHUNK); }
    catch(e){ console.error(e); tbody.innerHTML=''; }

    if(rowsSlice.length>FIRST_CHUNK){
      var pos=FIRST_CHUNK;
      (function addChunk(){
        if(pos>=rowsSlice.length){ finalize(); return; }
        var next=Math.min(rowsSlice.length,pos+initRows*3);
        var tmp=document.createElement('tbody');
        try{ tmp.innerHTML=buildRowsHTML(pos,next);}catch(e){console.error(e);}
        while(tmp.firstChild) tbody.appendChild(tmp.firstChild);
        pos=next; rIC(addChunk);
      })();
    }else{
      finalize();
    }

    function finalize(){
      prepareViewLazy(table);
      if (typeof updatePager === 'function') updatePager();
      setFinalStatus();
    }
  }

  function _sameKeyArray(a,b){
    if(!a||!b) return false;
    if(a.length!==b.length) return false;
    for(var i=0;i<a.length;i++){
      if(a[i]!==b[i]) return false;
    }
    return true;
  }

  /* ===== 16C. 列リサイズ & 並び替えハンドラ ===== */

  (function(){
    var MIN_W = 56, MAX_W = 720;

    function applyColumnWidth(colId, px){
      px = Math.max(MIN_W, Math.min(MAX_W, Math.round(px||0)));
      STATE.widths[colId] = px;
      var table = document.querySelector('#tableWrap table');
      if(!table) return;
      var th = table.querySelector('thead th[data-col-id="'+colId+'"]');
      if(th) th.style.width = px + 'px';
      var tds = table.querySelectorAll('tbody td[data-col-id="'+colId+'"]');
      for(var i=0;i<tds.length;i++){
        tds[i].style.width = px + 'px';
        tds[i].style.maxWidth = px + 'px';
      }
      setDirty(true);
    }

    window.startResize = function(th, colId){
      return function onDown(ev){
        ev.preventDefault();
        ev.stopPropagation();
        var startX = (ev.touches && ev.touches[0] ? ev.touches[0].clientX : ev.clientX) || 0;
        var startW = (STATE.widths[colId]|0) || Math.round(th.getBoundingClientRect().width);
        var moving = true;
        var wasDraggable = th.getAttribute('draggable');
        th.setAttribute('draggable','false');
        function onMove(e){
          if(!moving) return;
          var x = (e.touches && e.touches[0] ? e.touches[0].clientX : e.clientX) || startX;
          var dx = x - startX;
          var w = Math.max(MIN_W, Math.min(MAX_W, startW + dx));
          applyColumnWidth(colId, w);
          if(typeof window.updateFooterPad === 'function') window.updateFooterPad();
        }
        function onUp(){
          moving = false;
          if(wasDraggable != null) th.setAttribute('draggable', wasDraggable);
          else th.removeAttribute('draggable');
          document.removeEventListener('mousemove', onMove, {passive:false});
          document.removeEventListener('mouseup', onUp, {passive:false});
          document.removeEventListener('touchmove', onMove, {passive:false});
          document.removeEventListener('touchend', onUp, {passive:false});
        }
        document.addEventListener('mousemove', onMove, {passive:false});
        document.addEventListener('mouseup', onUp, {passive:false});
        document.addEventListener('touchmove', onMove, {passive:false});
        document.addEventListener('touchend', onUp, {passive:false});
      };
    };

    window.onDragStart = function(ev){
      try{
        var th = ev.target.closest('th[data-col-id]');
        if(!th) return;
        var colId = th.getAttribute('data-col-id');
        ev.dataTransfer.effectAllowed = 'move';
        ev.dataTransfer.setData('text/plain', colId);
        th.classList.add('dragging');
      }catch(_){}
    };

    window.onDropHeader = function(ev){
      ev.preventDefault();
      try{
        var srcId = ev.dataTransfer.getData('text/plain') || '';
        var thTo = ev.currentTarget || (ev.target && ev.target.closest && ev.target.closest('th[data-col-id]'));
        if(!srcId || !thTo) return;
        var dstId = thTo.getAttribute('data-col-id');
        if(!dstId || srcId === dstId) return;
        var order = (STATE.pageCfgRaw && Array.isArray(STATE.pageCfgRaw.order) && STATE.pageCfgRaw.order.length)
          ? STATE.pageCfgRaw.order.slice()
          : resolveOrder().slice();
        var vis = resolveOrder().slice();
        var sIdx = vis.indexOf(srcId);
        var dIdx = vis.indexOf(dstId);
        if(sIdx < 0 || dIdx < 0) return;
        vis.splice(dIdx, 0, vis.splice(sIdx,1)[0]);
        var setVis = new Set(vis);
        var tail = order.filter(function(id){ return !setVis.has(id); });
        var newOrder = vis.concat(tail);
        if(!STATE.pageCfgRaw) STATE.pageCfgRaw = {};
        STATE.pageCfgRaw.order = newOrder;
        setDirty(true);
        showStatus('applying page…');
        requestAnimationFrame(function(){ renderCurrentPage(false); });
      }catch(_){}
      finally{
        var dragging = document.querySelector('thead th.dragging');
        if(dragging) dragging.classList.remove('dragging');
      }
    };

    document.addEventListener('dragover', function(ev){
      var th = ev.target && ev.target.closest && ev.target.closest('th[data-col-id]');
      if(!th) return;
      ev.preventDefault();
      ev.dataTransfer.dropEffect = 'move';
    }, {passive:false});

    window.updateFooterPad = function(){
      try{
        var bar  = document.getElementById('statusBar');
        var wrap = document.getElementById('tableWrap');
        if(!bar || !wrap) return;
        var h = Math.ceil(bar.getBoundingClientRect().height || 0);
        var sb = (wrap.scrollWidth > wrap.clientWidth) ? 12 : 0;
        var buffer = 72;
        var pad = Math.max(48, h + sb + buffer);
        document.documentElement.style.setProperty('--footer-pad', pad + 'px');
      }catch(e){}
    };
    window.addEventListener('resize', window.updateFooterPad, {passive:true});
    window.addEventListener('orientationchange', window.updateFooterPad);
    requestAnimationFrame(window.updateFooterPad);
    setTimeout(window.updateFooterPad, 120);
    setTimeout(window.updateFooterPad, 360);
  })();

  /* ===== 17. View 列 Lazy ロード（shotview / assetview） ===== */

  function _norm(h){
    return String(h||'').toLowerCase().replace(/[\s_-]/g,'');
  }

  function findViewColId(cands){
    var ids=visibleCols();
    for(var i=0;i<ids.length;i++){
      var id=ids[i], idx=indexOf(STATE.fieldIds,id), h=_norm(STATE.header[idx]);
      for(var j=0;j<cands.length;j++){ if(h===cands[j]) return id; }
    }
    return null;
  }

  function prepareViewLazy(tableElem){
    var vCol=findViewColId(['shotview','assetview']); if(!vCol)return;
    var tbody=tableElem.tBodies[0]; if(!tbody)return;
    var wrap=document.getElementById('tableWrap'); if(!wrap)return;

    var cells=[];
    for(var i=0;i<tbody.rows.length;i++){
      var tr=tbody.rows[i]; var td=tr.querySelector('td[data-col-id="'+vCol+'"]'); if(!td)continue;
      td.setAttribute('data-viewcell','1');
      if(!td.getAttribute('data-rowid')) td.setAttribute('data-rowid', tr.getAttribute('data-row-id')||'');
      td.removeAttribute('data-vdone');
      cells.push(td);
    }
    if(!cells.length) return;

    function renderIfInView(td){
      if(!td) return;
      if(td.getAttribute('data-vdone')==='1') return;

      var vr=wrap.getBoundingClientRect();
      var rect=td.getBoundingClientRect();
      var inView = (rect.bottom>=vr.top-200 && rect.top<=vr.bottom+300);
      if(!inView) return;

      var sid=td.getAttribute('data-rowid')||'';
      var file=PROXY_CACHE[sid]||null;
      if(!file) return;

      renderViewCell(td, file);
      td.setAttribute('data-vdone','1');
    }

    function paint(){
      for(var i=0;i<cells.length;i++) renderIfInView(cells[i]);
    }

    wrap.addEventListener('scroll', function(){ requestAnimationFrame(paint); }, {passive:true});
    wrap.addEventListener('proxies:ready', function(){ requestAnimationFrame(paint); });
    requestAnimationFrame(paint);
    setTimeout(paint, 250);
  }

  function renderViewCell(td,file){
    td.innerHTML='';
    if(!file){ return; }
    var thumb='https://drive.google.com/thumbnail?id='+encodeURIComponent(file.id)+'&sz=w320';
    var preview='https://drive.google.com/file/d/'+encodeURIComponent(file.id)+'/view';
    var img=document.createElement('img');
    img.loading='lazy';
    img.src=thumb;
    img.title=(file.name||'open');
    img.style.width='100%';
    img.style.aspectRatio='16/9';
    img.style.objectFit='cover';
    img.style.borderRadius='6px';
    img.style.cursor='pointer';
    img.referrerPolicy='no-referrer';
    img.onclick=function(){ window.open(preview,'_blank','noopener'); };
    img.onerror=function(){ td.textContent=''; };
    td.appendChild(img);
  }

  /* ===== 18. リンクレンダリングヘルパ ===== */

  function splitTokens(s){
    return String(s||'').split(/[,\s;|、／]+/).filter(Boolean);
  }

  function tokenExistsInAnyMap(s){
    var parts=splitTokens(s); if(parts.length===0) return false;
    for(var i=0;i<parts.length;i++){
      var t=parts[i];
      if(LINK_MAPS.assets[t]||LINK_MAPS.shots[t]||LINK_MAPS.tasks[t]||LINK_MAPS.users[t]||LINK_MAPS.members[t]) return true;
    }
    return false;
  }

  function isRowIdLike(id){ return /^[a-z]{2}_[0-9]+$/i.test(String(id||'')); }

  function isLinkColumn(header){ return /link/i.test(String(header||'')); }

  function isLinkish(fieldId, header){
    if(KNOWN_LINK_FIELD_IDS[fieldId]) return true;
    return isLinkColumn(header);
  }

  function idColName(){ return STATE.fieldIds[0]||''; }

  function isIdColumn(header, fid){
    var h=String(header||'');
    if(/\bID\b/i.test(h)) return true;
    if(fid && fid===idColName()) return true;
    return false;
  }

  function shouldNameCellLinkToDetail(canon, header, rowId){
    if(!rowId) return false;
    var h=_norm(header);
        if(canon==='projectmembers'||canon==='projectmember'||canon==='member'||canon==='members'){
      if(h==='role') return true;
    }
    return /name$/.test(h);
  }

  function renderLinkId(pid){
    var label=pid, ent='';
    if(LINK_MAPS.assets[pid]){ label=LINK_MAPS.assets[pid]; ent='asset'; }
    else if(LINK_MAPS.shots[pid]){ label=LINK_MAPS.shots[pid]; ent='shot'; }
    else if(LINK_MAPS.tasks[pid]){ label=LINK_MAPS.tasks[pid]; ent='task'; }
    else if(LINK_MAPS.users[pid]){ label=LINK_MAPS.users[pid]; ent='user'; }
    else if(LINK_MAPS.members[pid]){ label=LINK_MAPS.members[pid]; ent='member'; }

    if(!ent){ ent=guessEntityFromId(pid); }
    var url=(window.scriptUrl||'')+'?entity='+ent+'&id='+encodeURIComponent(pid);
    return '<a href="'+url+'" title="'+escapeHTML(pid)+'">'+escapeHTML(label)+'</a>';
  }

  function guessEntityFromId(id){
    if(/^as_/i.test(id)) return 'asset';
    if(/^sh_/i.test(id)) return 'shot';
    if(/^tk_/i.test(id)) return 'task';
    if(/^u_/i.test(id))  return 'user';
    if(/^(pm|mem)_/i.test(id)) return 'member';
    return 'item';
  }

  /* ===== 19. カラムパネル（Fields） ===== */

  document.getElementById('columnsBtn').addEventListener('click', function(){
    openPanel('colPanel', this, buildColsPanel);
  });

  function buildColsPanel(panel){
    panel.style.minWidth='240px';
    panel.style.maxWidth='480px';
    panel.innerHTML='';
    var ids=STATE.fieldIds.slice();
    for(var i=0;i<ids.length;i++){
      var colId=ids[i]; if(!colId)continue;
      var idx=indexOf(STATE.fieldIds,colId);
      var label=STATE.header[idx]||colId;
      var row=document.createElement('div'); row.className='row';
      var cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!STATE.hiddenCols[colId];
      cb.onchange=(function(colIdRef){return function(){
        STATE.hiddenCols[colIdRef]=!this.checked; setDirty(true);
        showStatus('applying page…'); requestAnimationFrame(function(){ renderCurrentPage(false); });
      };})(colId);
      var span=document.createElement('span'); span.textContent=label;
      row.appendChild(cb); row.appendChild(span); panel.appendChild(row);
    }
  }

  /* ===== 20. ソートパネル ===== */

  document.getElementById('sortBtn').addEventListener('click', function(){
    openPanel('sortPanel', this, buildSortPanel);
  });

  function buildSortPanel(panel){
    panel.style.minWidth = '320px';
    panel.style.maxWidth = '640px';
    panel.innerHTML='';

    var localSort = [];
    var src = Array.isArray(STATE.sort) ? STATE.sort : [];
    for(var i=0;i<src.length;i++){
      var it=src[i]||{};
      localSort.push({ id:(it.id||''), dir:(it.dir==='desc'?'desc':'asc'), on:(it.on!==false), group:false });
    }

    var gset = {};
    if(Array.isArray(STATE.group)){
      for(var gi=0;gi<STATE.group.length;gi++){
        gset[String(STATE.group[gi]||'')]=1;
      }
    }
    for(var k=0;k<localSort.length;k++){
      if(localSort[k].id && gset[localSort[k].id]) localSort[k].group = true;
    }

    var wrap=document.createElement('div'); panel.appendChild(wrap);

    function body(){
      wrap.innerHTML='';

      var rulesBox=document.createElement('div'); wrap.appendChild(rulesBox);
      for(var r=0;r<localSort.length;r++){
        (function(idx){
          var it=localSort[idx];
          var row=document.createElement('div'); row.className='row';

          var eg=document.createElement('div');
          eg.style.display='flex'; eg.style.alignItems='center'; eg.style.gap='10px';

          var enLab=document.createElement('label');
          var en=document.createElement('input'); en.type='checkbox'; en.checked=(it.on!==false);
          en.onchange=function(){ it.on=this.checked; };
          enLab.appendChild(en); enLab.appendChild(document.createTextNode('Enable'));

          var gpLab=document.createElement('label'); gpLab.style.marginLeft='6px';
          var gp=document.createElement('input'); gp.type='checkbox'; gp.checked=!!it.group;
          gp.onchange=function(){ it.group=this.checked; };
          gpLab.appendChild(gp); gpLab.appendChild(document.createTextNode('Group'));

          eg.appendChild(enLab); eg.appendChild(gpLab);

          var sel=document.createElement('select');
          var cols=STATE.fieldIds.slice();
          for(var c=0;c<cols.length;c++){
            var fid=cols[c]; if(!fid) continue;
            var idxx=indexOf(STATE.fieldIds,fid);
            var opt=document.createElement('option'); opt.value=fid; opt.textContent=STATE.header[idxx]||fid;
            sel.appendChild(opt);
          }
          sel.value=it.id||''; sel.onchange=function(){ it.id=this.value; };

          var dirBtn=document.createElement('button'); dirBtn.className='btn';
          function paintDir(){ dirBtn.textContent=(it.dir==='desc'?'↓':'↑'); }
          paintDir();
          dirBtn.onclick=function(){ it.dir=(it.dir==='desc'?'asc':'desc'); paintDir(); };

          var del=document.createElement('button'); del.className='btn'; del.textContent='×';
          del.onclick=function(){ localSort.splice(idx,1); body(); };

          row.appendChild(eg);
          row.appendChild(sel);
          row.appendChild(dirBtn);
          row.appendChild(del);
          rulesBox.appendChild(row);
        })(r);
      }

      var bar=document.createElement('div'); bar.className='row'; bar.style.marginTop='6px';
      var add=document.createElement('button'); add.className='btn'; add.textContent='+ add';
      add.onclick=function(){ localSort.push({id:'',dir:'asc',on:true,group:false}); body(); };

      var apply=document.createElement('button'); apply.className='btn'; apply.textContent='Apply';
      apply.onclick=function(){
        var newGroup=[], newSort=[];
        for(var i2=0;i2<localSort.length;i2++){
          var it2=localSort[i2];
          newSort.push({id:it2.id,dir:it2.dir,on:(it2.on!==false)});
          if(it2.group && it2.id) newGroup.push(it2.id);
        }
        STATE.sort=newSort;
        STATE.group=newGroup;
        fetchAndRenderPage(1);
      };

      var reset=document.createElement('button'); reset.className='btn'; reset.textContent='Reset';
      reset.onclick=function(){
        STATE.sort=[];
        STATE.group=[];
        fetchAndRenderPage(1);
        localSort=[];
        body();
      };

      bar.appendChild(add);
      var spacer=document.createElement('span'); spacer.className='spacer'; bar.appendChild(spacer);
      bar.appendChild(apply);
      bar.appendChild(reset);
      wrap.appendChild(bar);
    }
    body();
  }

  /* ===== 21. Distinct 値キャッシュ & refreshDistinctCache ===== */

  var DISTINCT_CACHE = {};

  function addDistinctSamples(fieldId, rows){
    try{
      var key = (STATE && STATE.sheetName ? STATE.sheetName : '') + '|' + fieldId;
      var set = DISTINCT_CACHE[key] || (DISTINCT_CACHE[key] = Object.create(null));
      var idx = indexOf(STATE && STATE.fieldIds, fieldId); if(idx < 0) return;
      var lim = Math.min(Array.isArray(rows) ? rows.length : 0, 1000);
      for(var r=0; r<lim; r++){
        var v = rows[r][idx];
        if(v==null || v==='') continue;
        String(v).split(/[,\s;|、／]+/).filter(Boolean).forEach(function(x){ set[x] = 1; });
      }
    }catch(_){}
  }

  function distinctValuesAll(fieldId, limit){
    var key = (STATE && STATE.sheetName ? STATE.sheetName : '') + '|' + fieldId;
    var arr = Object.keys(DISTINCT_CACHE[key] || {});
    arr.sort();
    if(limit && arr.length > limit) arr = arr.slice(0, limit);
    return arr;
  }

  function refreshDistinctCache(){
    try{
      var fids = (STATE && Array.isArray(STATE.fieldIds)) ? STATE.fieldIds : [];
      var rows = (STATE && Array.isArray(STATE.rows)) ? STATE.rows.slice(0, 1000) : [];
      for(var i=0;i<fids.length;i++){ addDistinctSamples(fids[i], rows); }
    }catch(_){}
  }

  /* ===== 22. フィルタパネル V3 ===== */

  document.getElementById('filterBtn').addEventListener('click', function(){
    openPanel('filterPanel', this, buildFilterPanelV3);
  });

  function buildFilterPanelV3(panel){
    panel.style.minWidth = '320px';
    panel.style.maxWidth = '640px';
    panel.innerHTML='';

    function defaultEmptyRule(){ return { id:'', op:'isempty', value:'', values:[] }; }
    function defaultGroup(){ return { id:rid(), name:'Group 1', mode:'any', rules:[ defaultEmptyRule() ] }; }

    var localFG = [];
    if(Array.isArray(STATE.filterGroups) && STATE.filterGroups.length){
      for(var i=0;i<STATE.filterGroups.length;i++){
        var g = deepCopy(STATE.filterGroups[i]||{});
        if(!Array.isArray(g.rules) || g.rules.length===0) g.rules = [ defaultEmptyRule() ];
        localFG.push(g);
      }
    }else{
      localFG = [ defaultGroup() ];
    }
    var localCombine = (STATE.groupCombine==='any') ? 'any' : 'all';

    var wrap=document.createElement('div'); panel.appendChild(wrap);

    function buildRuleRow(r, onRemove){
      var row=document.createElement('div'); row.className='row'; row.style.alignItems='flex-start';

      var sel=document.createElement('select');
      var cols=STATE.fieldIds.slice();
      for(var k=0;k<cols.length;k++){
        var id=cols[k]; if(!id)continue;
        var idx=indexOf(STATE.fieldIds,id);
        var opt=document.createElement('option'); opt.value=id; opt.textContent=STATE.header[idx]||id;
        sel.appendChild(opt);
      }
      sel.value=r.id||''; sel.onchange=function(){ r.id=this.value; };

      var op=document.createElement('select');
      function setOpsForType(opSel,t){
        var ops;
        if(t==='date'){
          ops=[
            {v:'is',t:'is'},
            {v:'isnot',t:'is not'},
            {v:'after',t:'is after'},
            {v:'before',t:'is before'},
            {v:'range',t:'in range'},
            {v:'isempty',t:'is empty'},
            {v:'isnotempty',t:'is not empty'}
          ];
        }else{
          ops=[
            {v:'contains',t:'contains'},
            {v:'is',t:'is'},
            {v:'isnot',t:'is not'},
            {v:'isempty',t:'is empty'},
            {v:'isnotempty',t:'is not empty'}
          ];
        }
        opSel.innerHTML='';
        for(var i=0;i<ops.length;i++){
          var o=document.createElement('option'); o.value=ops[i].v; o.textContent=ops[i].t;
          opSel.appendChild(o);
        }
      }
      function guessType(colId){
        var idxx=indexOf(STATE.fieldIds,colId); if(idxx<0) return 'text';
        var limit=Math.min(STATE.rows.length,100);
        for(var rrr=0; rrr<limit; rrr++){
          var v=STATE.rows[rrr][idxx];
          if(v==null||v==='') continue;
          if(typeof v==='number') return 'number';
          if(/^\d{4}-\d{2}-\d{2}/.test(String(v))) return 'date';
        }
        return 'text';
      }

      var valWrap=document.createElement('span');
      function rebuildValueUI(){
        var t=guessType(sel.value);
        setOpsForType(op,t);
        op.value = r.op || 'isempty';
        valWrap.innerHTML='';

        if(t==='date'){
          if(op.value==='range'){
            var a=document.createElement('input'); a.type='date';
            var b=document.createElement('input'); b.type='date';
            var parts=String(r.value||'').split('..');
            a.value=parts[0]||''; b.value=parts[1]||'';
            a.onchange=b.onchange=function(){ r.value=(a.value||'')+'..'+(b.value||''); };
            valWrap.appendChild(a);
            valWrap.appendChild(document.createTextNode(' .. '));
            valWrap.appendChild(b);
          }else if(op.value==='isempty' || op.value==='isnotempty'){
          }else{
            var d=document.createElement('input'); d.type='date'; d.value=(r.value||'');
            d.onchange=function(){ r.value=this.value; };
            valWrap.appendChild(d);
          }
        }else{
          if(op.value==='contains'){
            var inp=document.createElement('input'); inp.type='text'; inp.placeholder='text or a,b,c'; inp.value=(r.value||'');
            inp.oninput=function(){
              r.value=this.value;
              var arr=String(this.value||'').split(',');
              var cleaned=[];
              for(var q=0;q<arr.length;q++){
                var s=String(arr[q]||'').trim(); if(s) cleaned.push(s);
              }
              r.values=cleaned;
            };
            valWrap.appendChild(inp);
          }else if(op.value==='is' || op.value==='isnot'){
            var opts=distinctValuesAll(sel.value,400);
            var box=document.createElement('div');
            box.style.display='grid';
            box.style.gridTemplateColumns='repeat(3, minmax(120px,1fr))';
            box.style.gap='4px 8px';
            var cur = Array.isArray(r.values)?r.values.slice()
                      : String(r.value||'').split(',').map(function(s){return String(s||'').trim();});
            for(var p=0;p<opts.length;p++){
              var v2=opts[p];
              var lb=document.createElement('label');
              lb.style.whiteSpace='nowrap';
              lb.style.overflow='hidden';
              lb.style.textOverflow='ellipsis';
              var c=document.createElement('input'); c.type='checkbox'; c.checked=(cur.indexOf(v2)>=0);
              c.onchange=(function(vvv){
                return function(){
                  var pos=cur.indexOf(vvv);
                  if(this.checked && pos<0) cur.push(vvv);
                  if(!this.checked && pos>=0) cur.splice(pos,1);
                  r.values=cur.slice();
                  r.value=cur.join(',');
                };
              })(v2);
              lb.appendChild(c);
              lb.appendChild(document.createTextNode(' '+v2));
              box.appendChild(lb);
            }
            valWrap.appendChild(box);
          }else if(op.value==='isempty' || op.value==='isnotempty'){
          }else{
            var inp2=document.createElement('input'); inp2.type='text'; inp2.placeholder='value'; inp2.value=(r.value||'');
            inp2.onchange=function(){ r.value=this.value; };
            valWrap.appendChild(inp2);
          }
        }
      }
      rebuildValueUI();
      op.onchange=function(){ r.op=this.value; rebuildValueUI(); };

      var del=document.createElement('button'); del.className='btn'; del.textContent='×';
      del.onclick=function(){ if(typeof onRemove==='function') onRemove(); };

      row.appendChild(sel);
      row.appendChild(op);
      row.appendChild(valWrap);
      row.appendChild(del);
      return row;
    }

    function body(){
      wrap.innerHTML='';

      for(var gi=0;gi<localFG.length;gi++){
        (function(gi2){
          var g=localFG[gi2]||defaultGroup();
          localFG[gi2]=g;
          var box=document.createElement('div'); box.className='fg-item';

          var hd=document.createElement('div'); hd.className='fg-head';
          var titleInput=document.createElement('input');
          titleInput.type='text'; titleInput.placeholder='Group name';
          titleInput.value=g.name||('Group '+(gi2+1));
          titleInput.oninput=function(){ g.name=this.value; };

          var modeSel=document.createElement('select');
          var o1=document.createElement('option'); o1.value='all'; o1.textContent='ALL';
          var o2=document.createElement('option'); o2.value='any'; o2.textContent='ANY';
          modeSel.appendChild(o1); modeSel.appendChild(o2);
          modeSel.value=(g.mode==='any'?'any':'all');
          modeSel.onchange=function(){ g.mode=this.value; };

          var del=document.createElement('button'); del.className='btn'; del.textContent='×';
          del.onclick=function(){
            localFG.splice(gi2,1);
            if(localFG.length===0) localFG=[ defaultGroup() ];
            body();
          };

          hd.appendChild(titleInput); hd.appendChild(modeSel);
          var sp=document.createElement('span'); sp.className='spacer'; hd.appendChild(sp);
          hd.appendChild(del);
          box.appendChild(hd);

          var bodyEl=document.createElement('div'); bodyEl.className='fg-body'; box.appendChild(bodyEl);
          var rWrap=document.createElement('div'); bodyEl.appendChild(rWrap);

          function renderRules(){
            rWrap.innerHTML='';
            if(!Array.isArray(g.rules) || g.rules.length===0) g.rules=[ defaultEmptyRule() ];
            for(var j=0;j<g.rules.length;j++){
              (function(ri){
                var rit=g.rules[ri]||defaultEmptyRule();
                g.rules[ri]=rit;
                var rowEl=buildRuleRow(rit, function(){ g.rules.splice(ri,1); renderRules(); });
                rWrap.appendChild(rowEl);
              })(j);
            }
            var bar=document.createElement('div'); bar.className='row';
            var add=document.createElement('button'); add.className='btn'; add.textContent='+ add rule';
            add.onclick=function(){
              if(!Array.isArray(g.rules)) g.rules=[];
              g.rules.push( defaultEmptyRule() );
              renderRules();
            };
            bar.appendChild(add);
            rWrap.appendChild(bar);
          }
          renderRules();
          wrap.appendChild(box);
        })(gi);
      }

      var bottom=document.createElement('div'); bottom.className='row'; bottom.style.marginTop='8px';
      var addg=document.createElement('button'); addg.className='btn'; addg.textContent='+ add group';
      addg.onclick=function(){ localFG.push( defaultGroup() ); body(); };

      function pill(active){
        return 'padding:3px 8px;border:1px solid var(--border);border-radius:12px;background:'+
          (active?'var(--surface)':'transparent')+
          ';cursor:pointer;font-size:12px;';
      }
      var allBtn=document.createElement('button'); var anyBtn=document.createElement('button');
      function paintGC(){
        allBtn.style.cssText=pill(localCombine!=='any'); allBtn.textContent='ALL';
        anyBtn.style.cssText=pill(localCombine==='any'); anyBtn.textContent='ANY';
      }
      allBtn.onclick=function(){ localCombine='all'; paintGC(); };
      anyBtn.onclick=function(){ localCombine='any'; paintGC(); };
      paintGC();

      var apply=document.createElement('button'); apply.className='btn'; apply.textContent='Apply';
      apply.onclick=function(){
        STATE.filterGroups = deepCopy(localFG);
        STATE.groupCombine = (localCombine==='any'?'any':'all');
        fetchAndRenderPage(1);
      };
      var reset=document.createElement('button'); reset.className='btn'; reset.textContent='Reset';
      reset.onclick=function(){
        STATE.filterGroups = [];
        STATE.groupCombine = 'all';
        fetchAndRenderPage(1);
        localFG=[ defaultGroup() ];
        localCombine='all';
        body();
      };

      bottom.appendChild(addg);
      var sp2=document.createElement('span'); sp2.className='spacer'; bottom.appendChild(sp2);
      bottom.appendChild(allBtn);
      bottom.appendChild(anyBtn);
      bottom.appendChild(apply);
      bottom.appendChild(reset);
      wrap.appendChild(bottom);
    }
    body();
  }

  /* ===== 23. パネル共通 openPanel / closePanel / closeAllPanels ===== */

  (function(){
    var MARGIN = 6;
    var EDGE_PAD = 8;
    var Z_BASE = 10000;

    function closePanel(panel){
      if(!panel) return;
      try{
        if(panel._closerCleanup){ panel._closerCleanup(); panel._closerCleanup=null; }
        removeGlobalClosers(panel);
        panel.style.display = 'none';
        panel.removeAttribute('data-open');
      }catch(_){}
    }

    function closeAllPanels(except){
      var list=document.querySelectorAll('.panel');
      for(var i=0;i<list.length;i++){
        var p=list[i];
        if(p===except) continue;
        closePanel(p);
      }
    }

    function positionPanel(panel, anchorEl){
      if(!panel || !anchorEl) return;
      panel.style.visibility='hidden';
      panel.style.display='block';
      panel.style.position='absolute';
      panel.style.zIndex=String(Z_BASE);
      var a = anchorEl.getBoundingClientRect();
      var vpW = document.documentElement.clientWidth || window.innerWidth || 0;
      var vpH = document.documentElement.clientHeight || window.innerHeight || 0;
      var pw = Math.ceil(panel.getBoundingClientRect().width);
      var ph = Math.ceil(panel.getBoundingClientRect().height);
      var left = a.left;
      if(left + pw > vpW - EDGE_PAD){
        left = Math.max(EDGE_PAD, a.right - pw);
      }
      left = Math.min(Math.max(EDGE_PAD, left), Math.max(EDGE_PAD, vpW - EDGE_PAD - pw));
      var topBelow = a.bottom + MARGIN;
      var topAbove = a.top - ph - MARGIN;
      var top;
      if(topBelow + ph <= vpH - EDGE_PAD){
        top = topBelow;
      }else if(topAbove >= EDGE_PAD){
        top = topAbove;
      }else{
        top = Math.min(Math.max(EDGE_PAD, topBelow), Math.max(EDGE_PAD, vpH - EDGE_PAD - ph));
      }
      var scrollX = window.pageXOffset || document.documentElement.scrollLeft || 0;
      var scrollY = window.pageYOffset || document.documentElement.scrollTop  || 0;
      panel.style.left = Math.round(left + scrollX) + 'px';
      panel.style.top  = Math.round(top  + scrollY) + 'px';
      panel.style.visibility='visible';
    }

    window.openPanel = function(id, anchorEl, builder){
      var panel = document.getElementById(id);
      if(!panel || !anchorEl || typeof builder!=='function') return;

      closeAllPanels(panel);
      panel.innerHTML = '';
      try{ builder(panel); }catch(_){ panel.innerHTML=''; }

      if(!panel.style.minWidth) panel.style.minWidth='320px';
      if(!panel.style.maxWidth) panel.style.maxWidth='640px';

      positionPanel(panel, anchorEl);
      panel.setAttribute('data-open','1');

      if(panel._closerCleanup){ panel._closerCleanup(); panel._closerCleanup=null; }
      addGlobalClosers(panel, anchorEl, function(){ closePanel(panel); });

      function onRelayout(){ if(panel.getAttribute('data-open')==='1'){ positionPanel(panel, anchorEl); } }
      function onKeyDown(e){ if(e.key==='Escape'){ closePanel(panel); } }

      window.addEventListener('resize', onRelayout, {passive:true});
      window.addEventListener('scroll', onRelayout, {passive:true});
      document.addEventListener('keydown', onKeyDown);

      panel._closerCleanup = function(){
        try{
          window.removeEventListener('resize', onRelayout, {passive:true});
          window.removeEventListener('scroll', onRelayout, {passive:true});
          document.removeEventListener('keydown', onKeyDown);
          removeGlobalClosers(panel);
        }catch(_){}
      };
      return panel;
    };

    window.closeAllPanels = closeAllPanels;
    window.closePanelById = function(id){
      var p=document.getElementById(id);
      if(p) closePanel(p);
    };
  })();

  /* ===== 24. Dirty フラグ管理（setDirty） ===== */

  function setDirty(flag){
    STATE.dirty=!!flag;
    var btn=document.getElementById('saveCfgBtn');
    var btn2=document.getElementById('saveDDBtn');
    if(btn) btn.disabled=!STATE.dirty;
    if(btn2) btn2.disabled=!STATE.dirty;
  }

  /* ===== 25. Save ドロップダウン UI（Save / Save as… / Revert） ===== */

  (function(){
    function ready(fn){
      if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn, {once:true});
      else fn();
    }
    ready(function(){
      var ddBtn = document.getElementById('saveDDBtn');
      var ddMenu = document.getElementById('saveDDMenu');
      var popover = document.getElementById('npPopover');
      var npName = document.getElementById('npName');
      var npCancel= document.getElementById('npCancel');
      var npSave = document.getElementById('npSave');
      if(!ddBtn || !ddMenu) return;

      function closeMenu(){
        ddMenu.classList.remove('open');
        removeGlobalClosers(ddMenu);
      }
      function openMenu(){
        ddMenu.classList.add('open');
        addGlobalClosers(ddMenu, ddBtn, closeMenu);
      }
      ddBtn.addEventListener('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        if(ddMenu.classList.contains('open')) closeMenu();
        else openMenu();
      });
      ddMenu.addEventListener('click', function(e){
        var item = e.target.closest('.dd-item');
        if(!item) return;
        var act = item.getAttribute('data-act') || '';
        closeMenu();
        if(act==='save')       saveCurrentPageConfig && saveCurrentPageConfig();
        else if(act==='saveas') openNewPagePopover();
        else if(act==='revert') revertCurrentPageConfig && revertCurrentPageConfig();
      });

      function openNewPagePopover(){
        if(!popover) return;
        var r = ddBtn.getBoundingClientRect();
        popover.style.left    = (r.left + window.scrollX) + 'px';
        popover.style.top     = (r.bottom + window.scrollY + 8) + 'px';
        popover.style.display = 'block';
        if(npName) npName.value = '';
        addGlobalClosers(popover, ddBtn, closeNewPagePopover);
      }
      function closeNewPagePopover(){
        if(!popover) return;
        popover.style.display='none';
        removeGlobalClosers(popover);
      }
      if(npCancel) npCancel.addEventListener('click', closeNewPagePopover);
      if(npSave)   npSave.addEventListener('click', function(){
        var name = (npName && npName.value || '').trim();
        if(!name){ npName && npName.focus(); return; }
        if(window.saveAsPage) saveAsPage(name, undefined, closeNewPagePopover);
        else closeNewPagePopover();
      });
      window.initSaveDropdown = function(){};
    });
  })();

  function snapshotCurrentPageConfig(){
    var order = (STATE.pageCfgRaw && Array.isArray(STATE.pageCfgRaw.order) && STATE.pageCfgRaw.order.length)
      ? STATE.pageCfgRaw.order.slice()
      : resolveOrder().slice();
    return {
      order: order,
      widths: copy(STATE.widths||{}),
      hidden: copy(STATE.hiddenCols||{}),
      sort: Array.isArray(STATE.sort) ? STATE.sort.slice() : [],
      group: Array.isArray(STATE.group) ? STATE.group.slice() : [],
      filterGroups: Array.isArray(STATE.filterGroups) ? deepCopy(STATE.filterGroups) : [],
      groupCombine: (STATE.groupCombine==='any'?'any':'all')
    };
  }

  function entityLabelForSave(){
    var ent = (typeof resolveEntityStrict==='function')
      ? resolveEntityStrict()
      : (STATE && STATE.sheetName) || 'shot';
    return pluralEntityFor(ent);
  }

  function refreshPresetsAfterSave(){
    return fetchPagesForEntity(STATE.sheetName||resolveEntityStrict()||'shot')
      .then(function(){
        try{ wirePresetSelectAfterLoad && wirePresetSelectAfterLoad(); }catch(_){}
        var sel=document.getElementById('presetSelect');
        if(sel && STATE.pageId) sel.value=STATE.pageId;
      }).catch(function(){});
  }

  window.saveCurrentPageConfig = function(){
    var pid = STATE && STATE.pageId ? STATE.pageId : 'pg_default';
    var cfg = snapshotCurrentPageConfig();
    var payload = {
      pageId: pid,
      entity: entityLabelForSave(),
      pageType: STATE && STATE.pageType ? STATE.pageType : 'table',
      config: cfg
    };
    if(typeof showStatus==='function') showStatus('saving…');
    callFirst(['sv_savePageConfig','gsSavePageConfig','savePageLayout','dp_savePageConfig'],
      payload,
      function(res){
        if(!res || (res.ok===false)){
          if(typeof showStatus==='function'){
            var fail='save failed';
            if(res && res.error) fail+=': '+res.error;
            showStatus(fail);
          }
          return;
        }
        applyLoadedConfig({config:cfg});
        cachePageConfigSnapshot(pid);
        setDirty(false);
        rememberLastView();
        refreshPresetsAfterSave();
        if(typeof showStatus==='function') showStatus('saved');
      },
      function(){
        if(typeof showStatus==='function') showStatus('save failed');
      }
    );
  };

  function needsQuoteForName(s){
    var val = String(s||'').trim();
    if(!val) return false;
    if(/^0\d+$/.test(val)) return true;
    if(/^[+-]?\d+(\.\d+)?$/.test(val)) return true;
    if(val.length>=12 && /^\d+$/.test(val)) return true;
    return false;
  }

  window.saveAsPage = function(name, shared, done){
    var nmEl = document.getElementById('npName') || document.getElementById('pgName');
    var shEl = document.getElementById('npShared') || document.getElementById('pgShared');
    if(typeof name==='undefined') name = nmEl ? String(nmEl.value||'').trim() : '';
    if(typeof shared==='undefined') shared = shEl ? !!shEl.checked : false;
    done = typeof done==='function' ? done : function(){};
    if(!name){
      if(nmEl){ nmEl.focus(); }
      done();
      return;
    }
    var safeName = needsQuoteForName(name) ? ("'"+name) : name;
    var cfg = snapshotCurrentPageConfig();
    var payload = {
      pageId: 'pg_new',
      pageName: safeName,
      shared: !!shared,
      entity: entityLabelForSave(),
      pageType: STATE && STATE.pageType ? STATE.pageType : 'table',
      config: cfg
    };
    if(typeof showStatus==='function') showStatus('saving…');
    callFirst(['sv_savePageConfig','gsSavePageConfig','savePageLayout','dp_savePageConfig'],
      payload,
      function(res){
        if(!res || (res.ok===false)){
          if(typeof showStatus==='function'){
            var fail='save as failed';
            if(res && res.error) fail+=': '+res.error;
            showStatus(fail);
          }
          done();
          return;
        }
        var newId = res && (res.pageId || res.id || res.pid) || '';
        if(newId){
          STATE.pageId = newId;
          applyLoadedConfig({config:cfg});
          cachePageConfigSnapshot(newId);
          rememberLastView();
        }
        setDirty(false);
        refreshPresetsAfterSave();
        if(typeof showStatus==='function') showStatus('saved');
        done();
      },
      function(){
        if(typeof showStatus==='function') showStatus('save failed');
        done();
      }
    );
  };

  window.revertCurrentPageConfig = function(){
    if(!STATE || !STATE.pageId) return;
    if(typeof showStatus==='function') showStatus('reverting…');
    loadPageConfigFromCacheThenNetwork(STATE.pageId, function(){
      setDirty(false);
      try{ renderCurrentPage && renderCurrentPage(true); }catch(_){}
      if(typeof showStatus==='function') showStatus('reverted');
    }, {forceNetwork:true});
  };

  /* ===== 26. fetch + payload（buildServerPayload / fetchAndRenderPage / fetchPageOnlyFromCacheThenNetwork） ===== */

  function applySheetNameFromPayload(payload, meta){
    try{
      var fromMeta = meta && meta.sheet ? meta.sheet : (meta && meta.entity ? meta.entity : '');
      var fromPayload = payload && (payload.sheetName || payload.entity || payload.sheet || payload.entityPlural) || '';
      var candidate = fromMeta || fromPayload || '';
      if(candidate){
        STATE.sheetName = singularEntityFor(candidate);
      }
    }catch(_){}
  }

  function buildServerPayload(offset, limit){
    var activeSort = Array.isArray(STATE.sort)
      ? STATE.sort.filter(function(s){ return s && s.on !== false; })
      : [];
    var entStrict = (typeof resolveEntityStrict==='function')
      ? resolveEntityStrict()
      : (STATE.sheetName||'shot');
    var entSing   = singularEntityFor(entStrict);
    var entLabel  = pluralEntityFor(entStrict);

    return {
      entity        : entLabel,
      sheet         : entLabel,
      entityPlural  : entLabel,
      sheetName     : entSing,
      pageType      : String(STATE.pageType||'table'),
      offset        : Math.max(0, offset|0),
      limit         : Math.max(1, Number(limit)||100),
      sort          : activeSort,
      filterGroups  : Array.isArray(STATE.filterGroups)?STATE.filterGroups:[],
      groupCombine  : (STATE.groupCombine==='any'?'any':'all')
    };
  }

  function ensureRowsAfterFetch(){
    try{
      var totalRows=Number(STATE&&STATE.total);
      var rowCount=Array.isArray(STATE&&STATE.rows)?STATE.rows.length:0;
      if(totalRows>0 && rowCount===0 && typeof fetchAndRenderPage==='function'){
        fetchAndRenderPage(1);
      }
    }catch(_){}
  }

  function fetchPageOnlyFromCacheThenNetwork(page, cb){
    STATE.page = Math.max(1, page|0||1);
    if(STATE.perPage===PER_PAGE_ALL) STATE.page = 1;

    var pageWindow = resolvePageWindow();
    var limit  = resolveFetchLimit();
    var offset = (STATE.page-1) * pageWindow;

    var payload = buildServerPayload(offset, limit);
    var key = 'motk:rows:' + [
      _canon(STATE.sheetName),
      _canon(STATE.pageType||'table'),
      limit, offset,
      serializeSort(STATE.sort?STATE.sort.filter(function(s){return s&&s.on!==false;}):[]),
      'FG:[]','GC:all'
    ].join(':');

    var cached = LSC_get(key, 2*60*1000);
    if(cached){
      var p = normalizeRowsPayload(cached);
      applySheetNameFromPayload(payload, p && p.meta);
      STATE.dataSource = detectSourceByIds(p.ids, p.header);
        applyData(p);
        refreshDistinctCache();
        ensureRowsAfterFetch();
        if(cb) cb();
    }

    callFirst(['listRowsPage','sv_listRowsPage','gsListRowsPage','dp_listRowsPage'],
      payload,
      function(res){
        var p = normalizeRowsPayload(res);
        applySheetNameFromPayload(payload, p && p.meta);
        STATE.dataSource = detectSourceByIds(p.ids, p.header);
        applyData(p);
        refreshDistinctCache();
        LSC_set(key, p);
        if(cb) cb();
      },
      function(){ if(cb) cb(); }
    );
  }

  function fetchAndRenderPage(page){
    STATE.page = Math.max(1, page|0||1);
    if(STATE.perPage==='all') STATE.page = 1;

    var pageWindow = resolvePageWindow();
    var limit  = resolveFetchLimit ? resolveFetchLimit() : pageWindow;
    var offset = (STATE.page-1) * pageWindow;

    var usp = writeUrlState ? writeUrlState() : new URLSearchParams(location.search);
    if(typeof resolveEntityStrict==='function') usp.set('entity', resolveEntityStrict());
    history.replaceState(null,'',location.pathname+'?'+usp.toString());

    var payload = buildServerPayload(offset, limit);
    if(typeof showStatus==='function') showStatus('loading '+pluralEntityFor(payload.entity)+'…');

    callFirst(['listRowsPage','sv_listRowsPage','gsListRowsPage','dp_listRowsPage'],
      payload,
      function(res){
        var p = normalizeRowsPayload(res);

        if((p.total|0) > 0 && (!Array.isArray(p.rows) || p.rows.length===0)){
          var base0 = buildServerPayload(0, resolveFetchLimit ? resolveFetchLimit() : pageWindow);
          callFirst(['listRowsPage','sv_listRowsPage','gsListRowsPage','dp_listRowsPage'],
            base0,
            function(res0){
              var p0 = normalizeRowsPayload(res0);
              applySheetNameFromPayload(base0, p0 && p0.meta);
              STATE.dataSource = detectSourceByIds(p0.ids, p0.header);
              applyData(p0);
              refreshDistinctCache();
              STATE._prevRowForGroup=null;
              renderCurrentPage(true);
            },
            function(){ showStatus && showStatus('no data'); }
          );
          return;
        }

        STATE.dataSource = detectSourceByIds(p.ids, p.header);
        applySheetNameFromPayload(payload, p && p.meta);
        applyData(p);
        refreshDistinctCache();
        STATE._prevRowForGroup=null;
        ensureRowsAfterFetch();
        renderCurrentPage(true);
      },
      function(){ showStatus && showStatus('no data'); }
    );
  }

  /* ===== 27. ちょいユーティリティ（rid / labelForFieldId） ===== */

  function rid(){ return 'g'+Math.random().toString(36).slice(2,8); }

  function labelForFieldId(fid){
    var idx=indexOf(STATE.fieldIds,fid);
    return idx>=0?(STATE.header[idx]||fid):fid;
  }

  /* ===== start() ブートシーケンス & DOM Ready ===== */

  function resolveEntityStrict(){
    if(STATE && STATE.sheetName){
      return singularEntityFor(STATE.sheetName);
    }
    try{
      var usp=new URLSearchParams(location.search);
      var qent=(usp.get('entity')||'').trim();
      if(qent) return singularEntityFor(qent);
      var qpid=(usp.get('pid')||'').trim();
      var fromPid = qpid ? entityFromPageId(qpid) : '';
      if(fromPid) return fromPid;
    }catch(_){}
    if(STATE && STATE.pageId){
      var e2 = entityFromPageId(STATE.pageId);
      if(e2) return e2;
    }
    return 'shot';
  }

  function getPageId(x){
    return ((x&& (x.pageId||x.id||x.fi_0052||x['Page ID']))||'')+'';
  }
  function getPageEnt(x){
    return ((x&& (x.entity||x.Entity||x.fi_0055||x['Entity']))||'')+'';
  }
  function getPageType(x){
    return ((x&& (x.pageType||x['Page Type']||x.type||x.fi_0054))||'')+'';
  }

  function entityFromPageId(pid){
    try{
      var list = Array.isArray(STATE && STATE.pageList) ? STATE.pageList : [];
      for(var i=0;i<list.length;i++){
        var x = list[i];
        if(getPageId(x) === pid){
          var ent = getPageEnt(x);
          if(ent) return singularEntityFor(ent);
        }
      }
      try{
        var usp = new URLSearchParams(location.search);
        var ent2 = (usp.get('entity') || '').trim();
        if(ent2) return singularEntityFor(ent2.toLowerCase());
      }catch(_){}
      if(STATE && STATE.sheetName) return singularEntityFor(String(STATE.sheetName).toLowerCase());
      if(typeof detectEntityStrict === 'function') return detectEntityStrict();
    }catch(_){}
    return '';
  }

  function detectEntityStrict(){
    try{
      var usp = new URLSearchParams(location.search);
      var ent = (usp.get('entity') || '').trim().toLowerCase();
      if(ent) return singularEntityFor(ent);

      var pid = (STATE && STATE.pageId) || '';
      if(pid && Array.isArray(STATE && STATE.pageList)){
        for(var i=0;i<STATE.pageList.length;i++){
          var x = STATE.pageList[i];
          if(getPageId(x) === pid){
            var ent2 = (getPageEnt(x) || '').toLowerCase();
            if(ent2) return singularEntityFor(ent2);
          }
        }
      }
      if(STATE && STATE.sheetName) return singularEntityFor(String(STATE.sheetName).toLowerCase());
    }catch(_){}
    return '';
  }

  function wirePresetSelectAfterLoad(){
    var sel=document.getElementById('presetSelect'); if(!sel)return;
    var list=(Array.isArray(STATE.pageList)?STATE.pageList:[]);
    var cur=sel.value; sel.innerHTML='';
    for(var i=0;i<list.length;i++){
      var x=list[i];
      var id=getPageId(x),
          nm=(x.pageName||x.name||x.fi_0053||x['Page Name']||'(no name)');
      if(!id)continue;
      var opt=document.createElement('option');
      opt.value=id; opt.textContent=nm;
      sel.appendChild(opt);
    }
    if(!STATE.pageId || !list.some(function(x){return getPageId(x)===STATE.pageId;})){
      var def=list.find(function(x){return getPageId(x)==='pg_default';});
      STATE.pageId = def ? 'pg_default' : (list.length ? getPageId(list[0]) : '');
    }
    if(STATE.pageId) sel.value=STATE.pageId;
    if(!sel.value&&cur) sel.value=cur;

    sel.removeEventListener('change', onPresetChange);
    sel.addEventListener('change', onPresetChange);
    bindPresetAutoRefresh(sel);
  }

  function onPresetChange(ev){
    try{
      var sel = ev && ev.target;
      var pid = sel && sel.value ? String(sel.value).trim() : '';
      if(!pid || STATE.pageId === pid) return;

      STATE.pageId = pid;
      var ent = entityFromPageId(pid) || resolveEntityStrict();
      STATE.sheetName = ent;
      rememberLastView();

      var usp = (typeof writeUrlState==='function')
        ? writeUrlState()
        : new URLSearchParams(location.search);
      usp.set('pid', pid);
      usp.set('entity', ent);
      history.replaceState(null,'', location.pathname + '?' + usp.toString());

      if (typeof loadPageConfigFromCacheThenNetwork === 'function'){
        loadPageConfigFromCacheThenNetwork(pid, function(){
          if (typeof fetchAndRenderPage === 'function') fetchAndRenderPage(1);
          if (typeof setDirty === 'function') setDirty(false);
        });
      }else if (typeof fetchAndRenderPage === 'function'){
        fetchAndRenderPage(1);
      }
    }catch(_){}
  }

  function filterPagesForEntity(list, entity){
    var entSing = singularEntityFor(entity||STATE.sheetName||'shot');
    var entCanon = _canon(entSing);
    var entPluralCanon = _canon(pluralEntityFor(entSing));
    var ptCanon = _canon(STATE.pageType||'table');
    return list.filter(function(x){
      var xe = _canon(getPageEnt(x));
      var xt = _canon(getPageType(x));
      var entOk = !xe || xe===entCanon || xe===entPluralCanon;
      var typeOk = !xt || xt===ptCanon;
      return entOk && typeOk;
    });
  }

  function bindPresetAutoRefresh(sel){
    if(!sel || sel._motkRefreshBound) return;
    sel._motkRefreshBound = true;
    var kick = function(){
      if(!STATE || !STATE.sheetName) return;
      var badge=document.getElementById('presetStatus');
      if(badge) badge.textContent='syncing…';
      fetchPagesForEntity(STATE.sheetName, {forceNetwork:true}).then(function(){
        var b=document.getElementById('presetStatus');
        if(b) b.textContent='synced';
      }).catch(function(){
        var b=document.getElementById('presetStatus');
        if(b) b.textContent='sync failed';
      });
    };
    sel.addEventListener('mousedown', kick);
    sel.addEventListener('focus', kick);
  }

  function fetchPagesForEntity(entity, opts){
    opts = opts || {};
    return new Promise(function(resolve){
      STATE._pagesFetchDone = false;
      var entSing = singularEntityFor(entity||STATE.sheetName||'shot');
      var payload = {
        entity: _canon(entSing),
        pageType: 'table'
      };
      if(opts.forceNetwork) payload.nocache = true;
      callFirst(['sv_listPages','gsListPagePresets'],
        payload,
        function(list){
          var arr = Array.isArray(list) ? list
                    : (list && Array.isArray(list.items) ? list.items : []);
          var filtered = Array.isArray(arr) ? filterPagesForEntity(arr, entSing) : [];
          STATE.pageList = filtered;
          STATE._pagesFetchDone = true;
          try{ wirePresetSelectAfterLoad && wirePresetSelectAfterLoad(); }catch(_){}
          resolve();
        },
        function(){
          STATE.pageList = [];
          STATE._pagesFetchDone = true;
          try{ wirePresetSelectAfterLoad && wirePresetSelectAfterLoad(); }catch(_){}
          resolve();
        }
      );
    });
  }

  function pageConfigCacheKey(pid){
    return pid ? ('motk:cfg:'+pid) : '';
  }

  function applyLoadedConfig(cfg){
    var c = (cfg && cfg.config && typeof cfg.config === 'object') ? cfg.config : (cfg || {});
    STATE.pageCfgRaw = {
      order        : (c && Array.isArray(c.order)) ? uniq(c.order) : null,
      widths       : (c && c.widths && typeof c.widths === 'object') ? copy(c.widths) : {},
      hidden       : (c && c.hidden && typeof c.hidden === 'object') ? copy(c.hidden) : {},
      group        : (c && Array.isArray(c.group)) ? c.group.slice() : [],
      filterGroups : (c && Array.isArray(c.filterGroups)) ? deepCopy(c.filterGroups) : [],
      sort         : (c && Array.isArray(c.sort)) ? c.sort.slice() : []
    };
    STATE.widths = copy(STATE.pageCfgRaw.widths);
    STATE.hiddenCols = copy(STATE.pageCfgRaw.hidden);
    STATE.group = Array.isArray(STATE.pageCfgRaw.group) ? STATE.pageCfgRaw.group.slice() : [];
    STATE.filterGroups = Array.isArray(STATE.pageCfgRaw.filterGroups) ? deepCopy(STATE.pageCfgRaw.filterGroups) : [];
    STATE.groupCombine = (c && c.groupCombine === 'any') ? 'any' : 'all';
    STATE.sort = Array.isArray(STATE.pageCfgRaw.sort) ? STATE.pageCfgRaw.sort.slice() : [];
    ensureFilterGroupDefaults();
  }

  function cachePageConfigSnapshot(pid){
    if(!pid || !STATE || !STATE.pageCfgRaw) return;
    LSC_set(pageConfigCacheKey(pid), {
      order: STATE.pageCfgRaw.order,
      widths: STATE.pageCfgRaw.widths,
      hidden: STATE.pageCfgRaw.hidden,
      group: STATE.pageCfgRaw.group,
      filterGroups: STATE.pageCfgRaw.filterGroups,
      groupCombine: STATE.groupCombine,
      sort: Array.isArray(STATE.sort)?STATE.sort.slice():[]
    });
  }

  function loadPageConfigFromCacheThenNetwork(pid, done, opts){
    opts = opts || {};
    if(!pid){
      STATE.pageCfgRaw = null;
      STATE.widths = {};
      STATE.hiddenCols = {};
      STATE.group = [];
      STATE.filterGroups = [];
      STATE.groupCombine = 'all';
      STATE.sort = [];
      ensureFilterGroupDefaults();
      setDirty(false);
      if(typeof done === 'function') done();
      return;
    }
    var key = pageConfigCacheKey(pid);
    if(opts.forceNetwork){
      try{ localStorage.removeItem(key); }catch(_){}
    }else{
      var cached = LSC_get(key, 24*60*60*1000);
      if(cached){
        applyLoadedConfig(cached);
        setDirty(false);
      }
    }
    var payload = { pageId: pid };
    if(opts.forceNetwork) payload.nocache = true;
    callFirst(['sv_loadPageConfig','gsLoadPageConfig','getPageLayout','dp_loadPageConfig'],
      payload,
      function(cfg){
        applyLoadedConfig(cfg||{});
        setDirty(false);
        cachePageConfigSnapshot(pid);
        if(typeof rememberLastView==='function') rememberLastView();
        if(typeof done === 'function') done();
      },
      function(){
        if(typeof done === 'function') done();
      }
    );
  }

  function pickInitialPageId(){
    var ent=pluralEntityFor(STATE.sheetName).toLowerCase();
    var pt=(STATE.pageType||'table').toLowerCase();
    var canonEnt = _canon(STATE.sheetName);
    var canonPlural = _canon(pluralEntityFor(STATE.sheetName));
    var ptCanon = _canon(STATE.pageType||'table');
    var list=(Array.isArray(STATE.pageList)?STATE.pageList:[]).filter(function(x){
      var xe=_canon(getPageEnt(x));
      var xt=_canon(getPageType(x));
      var entOk = !xe || xe===canonEnt || xe===canonPlural || xe===ent;
      var typeOk = !xt || xt===ptCanon || xt===pt;
      return entOk && typeOk;
    });
    var qpid=getUrlParam('pid');
    if(qpid && list.some(function(x){ return getPageId(x)===qpid; })) return qpid;
    var def=list.find(function(x){ return getPageId(x)==='pg_default'; });
    return def ? 'pg_default' : (list.length ? getPageId(list[0]) : '');
  }

  function resolveEntityFromContext(){
    var raw = (getUrlParam('entity') || '').trim();
    if(!raw){
      var pageParam = (getUrlParam('page') || '').trim();
      var pageLc = pageParam.toLowerCase();
      if(pageLc && /^(shots|assets|tasks|users|members|projectmembers)$/.test(pageLc)){
        raw = pageParam;
      }
    }
    if(!raw){
      raw = STATE.sheetName || '';
    }
    var s = singularEntityFor(raw);
    STATE.sheetName = s;
    return s;
  }

  function onDom(){
    try{ adjustNavOffset && adjustNavOffset(); }catch(_){}
    window.addEventListener('resize', function(){
      try{ adjustNavOffset&&adjustNavOffset(); }catch(_){}
    }, {passive:true});
    try{
      var obs=new MutationObserver(function(){
        try{ adjustNavOffset&&adjustNavOffset(); }catch(_){}
      });
      if(document.body){
        obs.observe(document.body,{
          childList:true,
          subtree:true,
          attributes:true,
          attributeFilter:['style','class']
        });
      }
    }catch(_){}

    try{ window.enableSpaNav && window.enableSpaNav(); }catch(_){}
    try{ readUrlState && readUrlState(); }catch(_){}

    start();

    var qs=document.getElementById('quickSearch');
    if(qs){
      qs.addEventListener('keydown', function(e){
        if(e.key==='Enter'){
          e.preventDefault();
          var q=qs.value.trim();
          if(q){ serverSearch(q); } else { fetchAndRenderPage(1); }
        }
      });
    }
  }

  async function start(){
    STATE.pageType='table';

    resolveEntityFromContext();
    applyLastViewFallback();

    try{ bindPagerControls && bindPagerControls(); }catch(_){}
    try{ updatePagerUI && updatePagerUI(); }catch(_){}

    await fetchPagesForEntity(STATE.sheetName);

    var qpid = getUrlParam('pid');
    var lastPid = (!qpid && STATE.pageId) ? STATE.pageId : '';
    STATE.pageId = qpid || lastPid || pickInitialPageId();
    rememberLastView();

    try{
      var usp = writeUrlState ? writeUrlState() : new URLSearchParams(location.search);
      if(STATE.pageId) usp.set('pid', STATE.pageId);
      if(STATE.sheetName) usp.set('entity', STATE.sheetName);
      history.replaceState(null,'', location.pathname + '?' + usp.toString());
    }catch(_){}

    var linksP = (typeof ensureLinkMaps==='function'
      ? ensureLinkMaps()
      : Promise.resolve(window.LINK_MAPS||{}))
      .catch(function(){})
      .then(function(){ STATE._linksReady=true; });

    var cfgP = new Promise(function(res){
      if(typeof loadPageConfigFromCacheThenNetwork!=='function'){
        STATE._cfgReady=true; res(); return;
      }
      loadPageConfigFromCacheThenNetwork(STATE.pageId, function(){
        STATE._cfgReady=true; res();
      });
    });

    await Promise.all([linksP,cfgP]);

    await new Promise(function(done){
      if(typeof fetchPageOnlyFromCacheThenNetwork!=='function'){
        STATE._dataReady=true; done(); return;
      }
      fetchPageOnlyFromCacheThenNetwork(1, function(){
        STATE._dataReady=true;
        Promise.resolve().then(function(){
          if(typeof ensureNamesForCurrentPage==='function'){
            return ensureNamesForCurrentPage();
          }
        }).catch(function(){}).then(function(){
          try{ maybeRender && maybeRender(); }
          catch(_){
            try{ renderCurrentPage && renderCurrentPage(true); }catch(__){}
          }
        }).finally(done);
      });
    });

    try{ prefetchProxyIndex && prefetchProxyIndex(); }catch(_){}
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', onDom, {once:true});
  }else{
    onDom();
  }

  function handleNavigate(ev){
    var handledSignal=false;
    function markHandled(){
      if(handledSignal) return;
      handledSignal=true;
      try{ window.dispatchEvent(new CustomEvent('motk:navigate:handled')); }catch(_){}
    }
    try{
      var detail = ev && ev.detail || {};
      var pid = detail.page || '';
      var entityFromPid = pid ? singularEntityFor(pid) : '';
      if(pid){
        var usp = new URLSearchParams(location.search);
        usp.set('page', pid);
        if(entityFromPid) usp.set('entity', entityFromPid);
        history.replaceState({page:pid},'',location.pathname+'?'+usp.toString());
      }
      if(entityFromPid){
        STATE.sheetName = entityFromPid;
      }
      markHandled();
      resolveEntityFromContext();
      STATE.pageId = '';
      STATE.filterGroups = [];
      STATE.groupCombine = 'all';
      Promise.resolve().then(function(){
        return fetchPagesForEntity(STATE.sheetName);
      }).then(function(){
        STATE.pageId = pickInitialPageId();
        rememberLastView();
        try{
          var usp2 = writeUrlState ? writeUrlState() : new URLSearchParams(location.search);
          if(STATE.pageId) usp2.set('pid', STATE.pageId);
          if(STATE.sheetName) usp2.set('entity', STATE.sheetName);
          history.replaceState(null,'',location.pathname+'?'+usp2.toString());
        }catch(_){}
        var linksP = (typeof ensureLinkMaps==='function'
          ? ensureLinkMaps()
          : Promise.resolve(window.LINK_MAPS||{})).catch(function(){});
        var cfgP = new Promise(function(res){
          if(typeof loadPageConfigFromCacheThenNetwork!=='function'){
            res(); return;
          }
          loadPageConfigFromCacheThenNetwork(STATE.pageId, function(){ res(); });
        });
        return Promise.all([linksP,cfgP]);
      }).then(function(){
        fetchPageOnlyFromCacheThenNetwork(1, function(){});
      }).catch(function(){
        location.reload();
      });
    }catch(e){
      location.reload();
    }
  }

  window.addEventListener('motk:navigate', handleNavigate);
  document.addEventListener('click', function(ev){
    try{
      var target = ev.target && ev.target.closest ? ev.target.closest('#pNav a[href]') : null;
      if(!target) return;
      if(ev.metaKey || ev.ctrlKey || ev.shiftKey || target.target==='_blank') return;
      ev.preventDefault();
      var pid = target.dataset && target.dataset.page
        ? target.dataset.page
        : (function(){
            try{ var u=new URL(target.href, location.origin); return (u.searchParams.get('page')||'').trim(); }
            catch(_){ return ''; }
          })();
      if(!pid) return;
      window.dispatchEvent(new CustomEvent('motk:navigate',{detail:{page:pid}}));
    }catch(_){}
  }, true);

})();
</script>

<!-- ===== 27.saveas-modal (UI: Shared付き) ===== -->
<div id="pgSaveAsMask"></div>
<div id="pgSaveAs" role="dialog" aria-modal="true" aria-labelledby="pgSaveAsTitle">
  <div class="hd" id="pgSaveAsTitle">Save as Page View</div>
  <div class="bd">
    <div class="row"><label for="pgNewId">Page ID</label><input id="pgNewId" placeholder="pg_XXXX" /></div>
    <div class="row"><label for="pgName">Page Name</label><input id="pgName" placeholder="View name" /></div>
    <div class="row"><label for="pgType">Page Type</label>
      <select id="pgType"><option value="table">table</option><option value="overview">overview</option><option value="detail">detail</option></select>
    </div>
    <div class="row"><label for="pgEntity">Entity</label>
      <select id="pgEntity"><option value="shot">shot</option><option value="asset">asset</option><option value="task">task</option><option value="member">member</option><option value="user">user</option></select>
    </div>
    <div class="row" style="display:flex;align-items:center;gap:8px">
      <input id="pgShared" type="checkbox" /><label for="pgShared">Shared</label>
    </div>
  </div>
  <div class="ft">
    <button id="pgSaveAsCancel">Cancel</button>
    <button id="pgSaveAsOk">Save</button>
  </div>
</div>

<script>
/* ===== 28.local_cache (Config/Labels TTLキャッシュ) ===== */
(function(){
  var TTL_MS = 15000;
  function k(ns, id){ return "MOTK."+ns+"."+id; }
  function now(){ return Date.now(); }
  window.MOTKCache = {
    get: function(ns, id){
      try{
        var raw = localStorage.getItem(k(ns,id)); if(!raw) return null;
        var obj = JSON.parse(raw);
        if (!obj || !obj.t || now()-obj.t>TTL_MS) return null;
        return obj.v;
      }catch(e){ return null; }
    },
    set: function(ns, id, val){
      try{ localStorage.setItem(k(ns,id), JSON.stringify({t:now(), v:val})); }catch(e){}
    }
  };
})();

/* ===== 29.prefetch_pages ===== */
(function(){
  var TTL_MS = 15000;
  function k(ns, id){ return "MOTK."+ns+"."+id; }
  function now(){ return Date.now(); }
  function cacheGet(ns, id){
    try{
      var raw=localStorage.getItem(k(ns,id)); if(!raw) return null;
      var obj=JSON.parse(raw); if(!obj||!obj.t||now()-obj.t>TTL_MS) return null;
      return obj.v;
    }catch(e){ return null; }
  }
  function cacheSet(ns, id, val){
    try{ localStorage.setItem(k(ns,id), JSON.stringify({t:now(), v:val})); }catch(e){}
  }
  window.prefetchPagesForEntity = function(entity, pageType){
    entity = entity || 'shot';
    pageType = pageType || 'table';
    google.script.run.withSuccessHandler(function(list){
      if(!Array.isArray(list)||!list.length) return;
      var ids = list.map(function(x){ return x.id; });
      list.forEach(function(p){ cacheSet('page.meta', p.id, p); });
      google.script.run.withSuccessHandler(function(map){
        map = map || {};
        Object.keys(map).forEach(function(pid){ cacheSet('page.cfg', pid, map[pid]); });
      }).gsLoadPageConfigsBulk(ids);
    }).gsListPagePresets({ entity: entity, pageType: pageType });
  };
  window.getPageConfigCached = function(pageId, onReady){
    var cfg = cacheGet('page.cfg', pageId);
    if(cfg){ if(onReady) onReady(cfg); return; }
    google.script.run.withSuccessHandler(function(c){
      cacheSet('page.cfg', pageId, c||{});
      if(onReady) onReady(c||{});
    }).gsLoadPageConfig({ pageId: pageId });
  };
})();

/* ===== 30.link_labels (安定ラベル置換: 一括API + キャッシュ) ===== */
(function(){
  function uniq(arr){
    var s={}, o=[];
    for(var i=0;i<arr.length;i++){
      var v=String(arr[i]||''); if(!v) continue;
      if(s[v]) continue; s[v]=1; o.push(v);
    }
    return o;
  }
  function isIdLike(s){ return /^((sh|as|ta|us|mb|pg)_\w+)/i.test(s); }

  async function resolveLabels(ids){
    var out={}, miss=[];
    for (var i=0;i<ids.length;i++){
      var id=ids[i], c = window.MOTKCache && MOTKCache.get('label', id);
      if (c!=null){ out[id]=c; } else { miss.push(id); }
    }
    if (miss.length){
      await new Promise(function(done){
        google.script.run.withSuccessHandler(function(map){
          map = map || {};
          Object.keys(map).forEach(function(k){
            MOTKCache && MOTKCache.set('label', k, map[k]);
            out[k]=map[k];
          });
          done();
        }).withFailureHandler(function(){ done(); })
          .dp_resolveLabelsBulk(miss);
      });
    }
    return out;
  }

  window.applyEntityLinkLabels = async function(container){
    var root = (typeof container==='string') ? document.querySelector(container) : container;
    if(!root) return;
    var texts = Array.prototype.map.call(root.querySelectorAll('[data-cell]'), function(n){ return n.textContent.trim(); });
    var ids = uniq(texts.filter(isIdLike));
    if(!ids.length) return;

    var map = await resolveLabels(ids);
    Array.prototype.forEach.call(root.querySelectorAll('[data-cell]'), function(n){
      var t = n.textContent.trim();
      if(map[t]) n.textContent = map[t];
    });
  };
})();
</script>

</body>
</html>
