<script>
/* ---------- state ---------- */
var colIDs=[], header=[], originalRows=[], viewRows=[];
var fieldTypeMap={}, idMaps={};
var isResizing=false;
var DRIVE_PREFIX="https://drive.google.com/";

/* ---------- boot ---------- */
function boot(){
  var page = new URLSearchParams(location.search).get('page') || 'Shots';

  google.script.run.withSuccessHandler(function(d){
    colIDs=d[0];header=d[1];originalRows=d.slice(2);viewRows=originalRows.slice();
    google.script.run.withSuccessHandler(function(meta){
      meta.forEach(function(m){fieldTypeMap[m.id]=m.type;});
      google.script.run.withSuccessHandler(function(maps){
        idMaps=maps; drawTable(); bindToolbar();
      }).getIdMaps();
    }).getFieldMeta();
  }).getTable(page);
}
boot();

/* ---------- toolbar ---------- */
function bindToolbar(){
  document.getElementById("btnSort").onclick=openSortDlg;
  document.getElementById("btnFilter").onclick=openFilterDlg;
  document.getElementById("btnReset").onclick=function(){
    viewRows=originalRows.slice(); drawTable();
  };
}

/* ---------- draw table ---------- */
function drawTable(){
  var tbl=document.createElement("table");
  var thead=tbl.createTHead(),hrow=thead.insertRow();
  header.forEach(function(h,i){
    var th=document.createElement("th");
    th.textContent=h;th.draggable=(i!==0);addResizer(th);hrow.appendChild(th);
  });

  var tbody=tbl.createTBody();
  viewRows.forEach(function(r){
    var tr=tbody.insertRow();
    r.forEach(function(cell,ci){
      var td=tr.insertCell();
      if(typeof cell==="string" && cell.indexOf(DRIVE_PREFIX)===0){
        var id=extractId(cell);
        if(cell.includes("/folders/")){
          td.innerHTML='<a target="_blank" href="'+cell+'">open folder ↗</a>';
        }else{
          td.innerHTML='<img loading="lazy" class="thumb" src="https://drive.google.com/thumbnail?id='+id+'&sz=w200">';
          td.dataset.id=id;
        }
      }else{
        td.textContent=(cell??"");
      }
    });
  });

  var wrap=document.getElementById("tableWrap");
  wrap.innerHTML="";wrap.appendChild(tbl);
  hideId(); enableDnD(tbl); observeThumbs(wrap);
}

/* ---------- thumbnail click → iframe ---------- */
function observeThumbs(container){
  container.addEventListener("click",function(e){
    if(e.target.classList.contains("thumb")){
      var id=e.target.parentElement.dataset.id;
      var ifr=document.createElement("iframe");
      ifr.className="preview";ifr.loading="lazy";
      ifr.src="https://drive.google.com/file/d/"+id+"/preview";
      e.target.replaceWith(ifr);
    }
  });
}

/* ---------- helpers ---------- */
function extractId(url){
  var m=url.match(/\/d\/([^/]+)/)||url.match(/id=([^&]+)/);
  return m?m[1]:null;
}
function hideId(){
  document.querySelectorAll("table tr").forEach(function(tr){
    if(tr.children[0])tr.children[0].style.display="none";
  });
}

/* ---------- DnD ---------- */
function enableDnD(table){
  var src=null;
  table.querySelectorAll("th").forEach(function(th){
    th.addEventListener("dragstart",function(e){
      if(isResizing){e.preventDefault();return;}
      src=th.cellIndex; e.dataTransfer.setData("text/plain","");
    });
    th.addEventListener("dragover",function(e){e.preventDefault();});
    th.addEventListener("drop",function(e){
      e.preventDefault();var tgt=th.cellIndex;
      if(src!==null&&src!==tgt){moveCol(table,src,tgt);} src=null; hideId();
    });
  });
}
function moveCol(table,src,tgt){
  Array.prototype.forEach.call(table.rows,function(r){
    var c=r.children; r.insertBefore(c[src], tgt>src?c[tgt].nextSibling:c[tgt]);
  });
}

/* ---------- resize ---------- */
function addResizer(th){
  var g=document.createElement("div");g.className="resizer";
  th.style.position="relative";th.appendChild(g);
  var sx,sw;
  g.addEventListener("mousedown",function(e){
    isResizing=true;sx=e.pageX;sw=th.offsetWidth;
    document.addEventListener("mousemove",mv);
    document.addEventListener("mouseup",up);
    e.stopPropagation();
  });
  function mv(e){var w=sw+(e.pageX-sx);if(w>40)th.style.width=w+"px";}
  function up(){document.removeEventListener("mousemove",mv);
               document.removeEventListener("mouseup",up);isResizing=false;}
}

/* ---------- Sort / Filter ダイアログ（雛形） ---------- */
function openSortDlg(){alert("Sort UI todo");}
function openFilterDlg(){alert("Filter UI todo");}
</script>
